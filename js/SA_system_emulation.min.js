// (2023-02-07)
var System=function(){var System={_init:function(){try{if(!Shell_OBJ)Shell_OBJ=new ActiveXObject("Shell.Application");if(!FSO_OBJ)FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject");if(!oShell)oShell=new ActiveXObject("WScript.Shell")}catch(e){alert(e.message)}this._child_html_filename=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html";this.Gadget._init();this.Machine._init();if(!is_SA_child_animation){SA_top_window.getScreenBounds=function(){var n=-1;var o;return function(e,t,i){if(i||n!=RAF_timestamp){n=RAF_timestamp;o=webkit_electron_mode?webkit_electron_screen.getDisplayNearestPoint({x:~~e,y:~~t}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}}return o}}()}else{SA_top_window.getScreenBounds=function(e,t,i){return SA_topmost_window.getScreenBounds(e,t,i)}}if(webkit_electron_mode){if(!is_SA_child_animation){SA_top_window.getPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_window.getPosition()}return i}}();SA_top_window.getCursorPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_electron_screen.getCursorScreenPoint()}return i}}()}else{SA_top_window.getPos=function(e){return SA_topmost_window.getPos(e)};SA_top_window.getCursorPos=function(e){return SA_topmost_window.getCursorPos(e)}}}SA_top_window.resizeToAbsolute=function(){var i;return function(e,t){webkit_window.setContentSize(e,t);i=true;if(absolute_screen_mode&&!System._browser._window_move_timerID){System._browser._window_move_timerID=setInterval(function(){var t=SA_top_window.screenLeftAbsolute;var i=SA_top_window.screenTopAbsolute;var n=0;return function(){var e=SA_top_window.getPos(true);if(t!=e[0]||i!=e[1]){DEBUG_show("(window position adjusted)",3);webkit_window.setPosition(t,i);System._browser.moveWallpaper(t,i);n=999}if(++n>10){clearInterval(System._browser._window_move_timerID);System._browser._window_move_timerID=null}}}(),100)}}}();SA_top_window.moveToAbsolute=function(e,t,i){if(absolute_screen_mode&&!i){webkit_window.setPosition(~~e,~~t)}else{this.moveTo(e,t)}};SA_top_window.moveByAbsolute=function(t,i){if(absolute_screen_mode){let e=SA_top_window.getPos(true);t+=~~e[0];i+=~~e[1];webkit_window.setPosition(t,i)}else{this.moveBy(t,i)}};Object.defineProperty(SA_top_window,"screenLeftAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[0]:this.screenLeft}});Object.defineProperty(SA_top_window,"screenTopAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[1]:this.screenTop}})},Gadget:{_init:function(){this.Settings.read=this.Settings.readString;this.Settings.write=this.Settings.writeString;Object.defineProperty(this,"onSettingsClosing",{get:function(){return this._onSettingsClosing},set:function(e){this._onSettingsClosing=e;this.settings_window.onbeforeunload=function(){e({closeAction:!!this.returnValue,Action:{commit:true}});System.Gadget.settings_window.System=null;System.Gadget.settings_window.onbeforeunload=null;System.Gadget.settings_window=null}}});var e=new ActiveXObject("Microsoft.XMLDOM");e["async"]=false;e.resolveExternals=false;e.validateOnParse=false;e.load("gadget.xml");this.version=e.selectSingleNode("//version").text},path:xul_mode?XPCOM_object._SA_root:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",_path_folder:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",docked:is_SA_child_animation,visible:true,Settings:{_settings_need_update:false,_settings:{},_changed:{},readString:function(name,raw_read){var v=this._settings[name];v=v?raw_read?decodeURIComponent(v):decodeURIComponent(v).replace(/\$([^\$]+)\$/g,function($0,$1,$2){return eval($1)}):Settings_default._custom_[name]||"";return v},writeString:function(e,t){var i=this._settings[e]||"";var n=encodeURIComponent(t);this._settings[e]=n;if(WallpaperEngine_CEF_mode){var o=JSON.parse(localStorage.Settings_by_path);if(!SA_HTA_folder||!o[SA_HTA_folder]){console.error(SA_HTA_folder)}else{if(o[SA_HTA_folder][e]!=n){o[SA_HTA_folder][e]=n;localStorage.Settings_by_path=JSON.stringify(o)}}}if(i!=n)this._changed[e]=this._settings_need_update=true},_writeSettings:function(e,t){if(!e&&!this._settings_need_update)return;this._settings_need_update=false;SystemEXT._save_settings_only=t;try{this._writeSettings_CORE()}catch(i){}SystemEXT._save_settings_only=false},_writeSettings_CORE:function(){var e=[];var t=this._settings;t._screenLeft=t._screenTop="";for(var i in t){var n=System.Gadget.Settings.readString(i);if(!n)continue;if(i=="_screenLeft"){n=SA_top_window.screenLeftAbsolute}else if(i=="_screenTop"){n=SA_top_window.screenTopAbsolute}e.push('"'+i+'":"'+encodeURIComponent(n)+'"')}SystemEXT.SaveLocalSettings(e)}}},Environment:{win32_env:null,getEnvironmentVariable:function(e){return oShell.ExpandEnvironmentStrings("%"+e+"%")}},Machine:{_init:function(){this._init_memory=function(){if(webkit_mode)return;if(this._WMI_obj_memory)return;try{this._WMI_obj_memory=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV");this._WMI_obj_memory.init()}catch(e){}};Object.defineProperty(this,"availableMemory",{get:function(){if(webkit_mode)return SA_require("os").freemem()/(1024*1024);this._init_memory();var e=this._WMI_obj_memory.update();return e.length?parseInt(e[e.length-1].AvailableMBytes):0}});Object.defineProperty(this,"totalMemory",{get:function(){if(webkit_mode)return SA_require("os").totalmem()/(1024*1024);if(!this._totalMemory){try{var e=new WMI_Refresher("Win32_OperatingSystem");e.init();this._totalMemory=parseInt(e.update()[0].TotalVisibleMemorySize)/1024}catch(t){}}return this._totalMemory}});this.totalMemory=0;var e={_WMI_obj:null,_cpu_obj:null,_get_cpu_obj:null,_init:function(){if(webkit_mode){if(this._get_cpu_obj)return;this._cpu_obj=[{count:-1,cpus:SA_require("os").cpus()}];this._get_cpu_obj=function(){var e=this._cpu_obj;if(e[0].count!=PC_count_absolute){if(e.unshift({count:PC_count_absolute,cpus:SA_require("os").cpus()})==3)e.pop()}return e};return}if(this._WMI_obj)return;try{this._WMI_obj=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV");this._WMI_obj.init()}catch(e){}},item:function(e){if(webkit_mode){var t=this._get_cpu_obj();var i=[];for(var n=0;n<2;n++){var o=t[n].cpus[e].times;var a=0;for(var s in o)a+=o[s];i[n]={total:a,idle:o.idle}}var r=i[0].idle-i[1].idle;var a=i[0].total-i[1].total;return{usagePercentage:a?(1-r/a)*100:0}}return{usagePercentage:parseFloat(this._WMI_obj.update()[e].PercentProcessorTime)}}};Object.defineProperty(e,"count",{get:function(){if(webkit_mode){return this._get_cpu_obj()[0].cpus.length}return this._WMI_obj.update().length-1}});this._CPUs=e;Object.defineProperty(this,"CPUs",{get:function(){this._CPUs._init();return this._CPUs}});var t={_WMI_obj:null,_init:function(){if(this._battery)return;this._battery={level:1,charging:false};if("getBattery"in navigator){var t=this;navigator.getBattery().then(function(e){DEBUG_show("Use Battery Status API",2);t._battery=e})}}};Object.defineProperty(t,"batteryPercentRemaining",{get:function(){return this._battery.level*100}});Object.defineProperty(t,"isPowerLineConnected",{get:function(){return this._battery.level==1||this._battery.charging}});Object.defineProperty(t,"isBatteryCharging",{get:function(){return this._battery.charging}});this._PowerStatus=t;Object.defineProperty(this,"PowerStatus",{get:function(){this._PowerStatus._init();return this._PowerStatus}})}},Shell:{itemFromFileDrop:function(e,t){return{path:""}},itemFromPath:function(e){e=toLocalPath(e);var t=e.replace(/[\/\\][^\/\\]+$/,"");var i=e.replace(/^.+[\/\\]/,"");var n=Shell_OBJ.NameSpace(t);if(n)n=n.ParseName(i);return n?new this._FolderItem(n):null},execute:function(e,t){Shell_OBJ.ShellExecute(e,t)},chooseFolder:function(e,t){var i=Shell_OBJ.BrowseForFolder(0,e,t);return i?new this._FolderItem(i.Self):null},_FolderItem:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.metadata=function(e){var t=this.obj.ExtendedProperty("Dimensions");if(!t){var i=this.obj.Path.replace(/[\/\\][^\/\\]+$/,"");var n=Shell_OBJ.NameSpace(i);t=n.GetDetailsOf(this.obj,26)}return t};Object.defineProperty(this.constructor.prototype,"isFolder",{get:function(){return this.obj.IsFolder}});Object.defineProperty(this.constructor.prototype,"isFileSystem",{get:function(){return(ie9_native?!this.obj.IsFolder:true)&&this.obj.IsFileSystem}});Object.defineProperty(this.constructor.prototype,"isLink",{get:function(){return this.obj.IsLink}});Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Shell._FolderItem(this.obj.GetLink)}});Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.obj.Path}});Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.obj.Type}});Object.defineProperty(this.constructor.prototype,"SHFolder",{get:function(){return new System.Shell._Folder(this.obj.GetFolder)}})}this.obj=e},_Folder:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;Object.defineProperty(this.constructor.prototype,"Items",{get:function(){return new System.Shell._FolderItems(this.obj.Items())}})}this.obj=e},_FolderItems:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.item=function(e){return new System.Shell._FolderItem(this.obj.Item(e))};Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.obj.Count}})}this.obj=e}},Debug:{outputString:function(e){}},_browser:{init:function(){document.ondragstart=document.onselectstart=function(e){return false};document.onmousedown=function(e){System._browser.onmousedown(e)};document.onmouseup=function(e){System._browser.onmouseup(e)};document.onmousemove=function(e){System._browser.onmousemove(e)};document.onkeydown=function(e){System._browser.onkeydown(e)};if(!WallpaperEngine_CEF_mode||!is_SA_child_animation||browser_native_mode){document.addEventListener("mouseover",function(e){System._browser.onmouseover(e)},false);document.addEventListener("mouseout",function(e){System._browser.onmouseout_waiting(e)},false)}Object.defineProperty(document,"onmouseover",{set:function(e){System._browser.onmouseover_custom=e}});Object.defineProperty(document,"onmouseout",{set:function(e){System._browser.onmouseout_waiting_custom=e}});var e=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.document_body_style_pixelWidth=Object.getOwnPropertyDescriptor(e,"pixelWidth");this.document_body_style_pixelHeight=Object.getOwnPropertyDescriptor(e,"pixelHeight");var t=function(){if(System._browser.resize_timerID)clearTimeout(System._browser.resize_timerID);if(System._browser._window_move_timerID){let i=SA_top_window.getPos();System._browser.resize_timerID=setInterval(function(){var t=0;return function(){let e=SA_top_window.getPos(true);if(++t>10||i[0]!=e[0]||i[1]!=e[1]){clearInterval(System._browser.resize_timerID);System._browser.resize_timerID=setTimeout("System._browser.resize()",0)}}}(),10)}else System._browser.resize_timerID=setTimeout("System._browser.resize()",0)};Object.defineProperty(e,"_set",{get:function(){return t}});if(ie9_native){Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System._browser.document_body_style_pixelWidth.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelWidth.set.call(this,e)}});Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System._browser.document_body_style_pixelHeight.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelHeight.set.call(this,e)}})}Object.defineProperty(this,"overlay_mode",function(){var t=0;var i=null;var n=null;function o(){document.getElementById("Ldungeon_inventory").style.visibility=document.getElementById("Ldungeon_inventory").style.visibility=="hidden"?"inherit":"hidden"}return{get:function(){return t},set:function(e){if(e==t)return;switch(e){case 2:if(i==null)i=LdesktopBG_host.style.display;LdesktopBG_host.style.display="none";if(n==null)n=document.body.style.backgroundColor;document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden";if(this.camera.video_host){this.camera.video_host.style.visibility="hidden";this.camera.video_host.style.display="none"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="hidden";document.getElementById("Ldungeon_inventory").style.visibility="hidden";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden";document.body.addEventListener("dblclick",o);DEBUG_show("(Double-click to show the menu)",3)}break;default:if(i!=null)LdesktopBG_host.style.display=i;if(n!=null)document.body.style.backgroundColor=n;i=n=null;Lmenu_host.style.visibility="inherit";if(this.camera.video_host){this.camera.video_host.style.visibility="inherit";this.camera.video_host.style.display="block"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="inherit";document.getElementById("Ldungeon_inventory").style.visibility="inherit";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden";document.body.removeEventListener("dblclick",o)}}t=e}}}());var i=is_SA_child_animation&&parent.MMD_SA_options&&parent.MMD_SA_options.child_animation_as_texture;if(i){this.onkeydown({keyCode:97+SA_child_animation_id})}var n=System.Gadget.Settings.readString("SA_docked");if(n)System.Gadget.docked=!!parseInt(n);else{if(i)System.Gadget.docked=false}var n=document.createElement("div");n.id="Ldrag_dummy";var o=n.style;o.position="absolute";o.posLeft=o.posTop=0;o.zIndex=999;o.border="1px solid rgba(128,128,128,0.5)";o.visibility="hidden";document.body.appendChild(n);this.body=document.getElementById("Lbody_host")||document.body;if(w3c_mode)this.body.style.transition="opacity 0.5s";this.Opacity=1;var a=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(a){if(!self.SA_wallpaper_src){var s=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.FileExists(s)){try{var r=FSO_OBJ.OpenTextFile(s,1);self.SA_wallpaper_src=r.ReadLine();r.Close()}catch(A){}}}if(!self.SA_wallpaper_mask_src){var _=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.FileExists(_)){try{var r=FSO_OBJ.OpenTextFile(_,1);self.SA_wallpaper_mask_src=r.ReadLine();r.Close()}catch(A){}}}}if(a)a=System.Gadget.Settings.readString("WallpaperAsBG")||self.SA_wallpaper_src;var l;if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay.use_wallpaper_as_bg||self.EQP_use_wallpaper){l=a=true}var h;var d,c;this.Opacity=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.Gadget.Settings.readString("Opacity")||1);if(is_SA_child_animation&&!self.SA_wallpaper_src&&!l){a=a&&parent.WMP_wallpaper_mask&&parent.use_HTML5&&!parent.System.Gadget.Settings.readString("CSSTransform3D")&&!System.Gadget.Settings.readString("DisableWallpaperMask");if(a&&self.EQP_video_options&&EQP_video_options.use_canvas_video){a=false;this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");this.WMPMask_Draw()}this.wallpaper_mask_disabled=!a;if(a)h=parent.WMP_wallpaper_mask}else{var u;if(!is_SA_child_animation){d=System.Gadget.Settings.readString("_screenLeft");c=System.Gadget.Settings.readString("_screenTop")}d=d?parseInt(d):null;c=c?parseInt(c):null;if(a){const D=w3c_mode&&self.SA_wallpaper_src&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;this.wallpaper_mask_disabled=WallpaperEngine_CEF_mode||!!System.Gadget.Settings.readString("DisableWallpaperMask");var p,m,f;var o=LdesktopBG.style;try{o.pixelWidth=parent.screen.width;o.pixelHeight=parent.screen.height;var g=oShell.RegRead("HKCU\\Control Panel\\Colors\\Background");o.backgroundColor=/^\#/.test(g)?g:"rgb("+g.replace(/\W+/g,",")+")";p="HKCU\\Control Panel\\Desktop\\";if(WallpaperEngine_CEF_mode)m=oShell.RegRead(p+"Wallpaper")||self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;else m=self.SA_wallpaper_src==""?"":self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.RegRead(p+"Wallpaper");if(m){if(!this.wallpaper_mask_disabled){h=self.SA_wallpaper_mask_src||m.replace(/\.\w{3,4}$/,"_mask.png");if(!ValidatePath(h))h=null}f=oShell.RegRead(p+"WallpaperStyle");this.updateWallpaper(m,f)}if(D){this.updateWallpaper(D)}this.moveWallpaper(d||0,c||0);if(!is_SA_child_animation||self.SA_wallpaper_src)LdesktopBG_host.style.display="block"}catch(A){console.error(A);LdesktopBG_host.style.display="none"}if(h){if(!this.bg_mask)this.bg_mask="(blank)"}else{u=true}}else{u=true}if(u&&this.Opacity<1&&(w3c_mode||HTA_use_GPU_acceleration)){this.body.style.opacity=this.Opacity;DEBUG_show("Opacity:"+this.Opacity*100+"%",2)}}if(l&&!h)this.bg_mask="(blank)";if(a&&(h||this.bg_mask)){var y=document.createElement("canvas");y.id="C_wallpaper_mask";y._WallpaperAsBG_custom=l;y.onmousedown=function(){return false};if(!is_SA_child_animation||l){try{var v=y.width=parent.screen.width;var M=y.height=parent.screen.height;var b=y.getContext("2d");var w;if(!this.wallpaper_canvas_update){this.wallpaper_canvas_update=function(e,c){b.fillStyle=o.backgroundColor;b.fillRect(0,0,v,M);if(!e){if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper)e.img.img_obj._match_str=null})}return}var t;if(c=="0"){t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var n=parent.screen.height;var o,a,s,r,_,l,d,c;if(i>e){o=0;_=(i-e)/2;s=d=e}else{o=(e-i)/2;_=0;s=d=i}if(n>t){a=0;l=(n-t)/2;r=c=t}else{a=(t-n)/2;l=0;r=c=n}var u=C_wallpaper_mask.getContext("2d");u.drawImage(this,o,a,s,r,_,l,d,c);System._browser.BGMask_Create(!h);if(!h)return;var p=new Image;p.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,o,a,s,r,_,l,d,c);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};p.src=toFileProtocol(h)}}else{t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var n=parent.screen.height;var o,a,s,r,_;var l=C_wallpaper_mask.getContext("2d");if(c=="6"){o=Math.max(e/i,t/n);r=Math.round((i-e/o)/2);_=Math.round((n-t/o)/2);a=Math.round(e/o);s=Math.round(t/o);l.drawImage(this,0,0,e,t,r,_,a,s)}else{o=Math.min(e/i,t/n);r=Math.round((e/o-i)/2*o);_=Math.round((t/o-n)/2*o);a=Math.round(i*o);s=Math.round(n*o);l.drawImage(this,r,_,a,s,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)}System._browser.BGMask_Create(!h);if(!h)return;var d=new Image;d.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,r,_,a,s);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};d.src=toFileProtocol(h)}}if(w)w.onload=null;w=new Image;w.onload=t;w.src=toFileProtocol(e)}}this.wallpaper_canvas_update(m,f);if(!m){setTimeout("System._browser.BGMask_Create(true)",0)}}catch(A){}}var S=y.style;S.position="absolute";S.posLeft=-(d||0);S.posTop=-(c||0);S.zIndex=60;S.visibility="hidden";document.body.appendChild(y);this.mouseover_hide_list.push(y);if(is_SA_child_animation){this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");if(this.bg_mask)System._browser.BGMask_Create(!h);this.WMPMask_Draw()}}this._s_left=d;this._s_top=c},updateWallpaper:function(e,t){let i=document.getElementById("VdesktopBG");if(e&&/\.(mp4|mkv|webm)$/i.test(e)){if(!i){i=document.createElement("video");i.id="VdesktopBG";const d=i.style;d.position="absolute";d.top=d.left="0px";d.width=parent.screen.width+"px";d.height=parent.screen.height+"px";d.objectFit="cover";LdesktopBG.appendChild(i);i.autoplay=i.loop=true}i.src=toFileProtocol(e);i.style.visibility="inherit";return}if(i){i.pause();i.style.visibility="hidden"}var n=LdesktopBG.style;var o;if(e!=null){e=decodeURIComponent(e);if(this._wallpaper_last!=e){o=true;this._wallpaper_last=e;n.backgroundImage=e?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+"/"+e)+")":"";if(this.wallpaper_opacity)n.opacity=this.wallpaper_opacity;if(this.wallpaper_bg_color)LdesktopBG_host.style.backgroundColor=this.wallpaper_bg_color}}else e=this._wallpaper_last;var a="HKCU\\Control Panel\\Desktop\\";if(t==null){t=oShell.RegRead(a+"WallpaperStyle")}if(this._wallpaper_style!=t){o=true;this._wallpaper_style=t}if(t=="0"){n.backgroundSize="";n.backgroundPosition="center center";if(oShell.RegRead(a+"TileWallpaper")=="0"){n.backgroundRepeat="no-repeat"}else{n.backgroundRepeat=""}}else if(t=="2"){n.backgroundSize="100% 100%";n.backgroundPosition="";n.backgroundRepeat=""}else if(t=="6"){n.backgroundSize="contain";n.backgroundPosition="center center";n.backgroundRepeat="no-repeat"}else{n.backgroundSize="cover";n.backgroundPosition="center center";n.backgroundRepeat="no-repeat";if(browser_native_mode){n.width="100%";n.height="100%"}else{n.pixelWidth=parent.screen.width;n.pixelHeight=parent.screen.height}if(windows_mode&&e){var s=loadImageDim(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+toLocalPath("\\")+e);if(s.w){var r=parent.screen.width/parent.screen.height;var _=(parent.screen.width*2-parent.screen.availWidth)/(parent.screen.height*2-parent.screen.availHeight);var l=s.w/s.h;if(l<r){n.pixelHeight=l<_?parent.screen.height*2-parent.screen.availHeight:Math.round(parent.screen.width/l)}else if(l>r){n.pixelWidth=l>_?parent.screen.width*2-parent.screen.availWidth:Math.round(parent.screen.height*l)}}}}if(this.wallpaper_canvas_update&&o){this.wallpaper_canvas_update(e,t);DEBUG_show("(Wallpaper canvas updated)",2)}},WMPMask_Draw:function(e){if(!this.C_WMP_wallpaper_mask_resized)return;if(!e)e=parent.SL;if(!e||!e.width)return;var t=document.body.style;var i=t.pixelWidth;var n=t.pixelHeight;if(!i)return;var o=0;var a=0;var s=e.width;var r=e.height;var _=this.C_WMP_wallpaper_mask_resized;if(_.width!=s){_.width=s;_.height=r;var l=parent.C_WMP_wallpaper_mask;_.getContext("2d").drawImage(l,0,0,l.width,l.height,0,0,s,r)}var d=this.bg_mask_image_resized;if(d&&d.width!=i){d.width=i;d.height=n;var c=this.bg_mask_image;d.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,i,n)}var i,n;i=self.B_content_width?B_content_width:document.body.style.pixelWidth;n=self.B_content_height?B_content_height:document.body.style.pixelHeight;var u=parent.SA_child_animation[SA_child_animation_id];var p=u.x;var h=u.y;if(is_SA_child_animation&&parent.EQP_border_width){p-=parent.EQP_border_width;h-=parent.EQP_border_width}var m=p-o;var f=m;if(m<0)m=0;if(f<0)f=-f;else f=0;var g=h-a;var y=g;if(g<0)g=0;if(y<0)y=-y;else y=0;var v=s+o-p;if(v>i)v=i;var M=r+a-h;if(M>n)M=n;var b=this.C_WMP_wallpaper_mask_mixed_resized;if(b.width!=i||b._x!=m||b._y!=g){b.width=i;b.height=n;var w=b.getContext("2d");w.drawImage(_,m,g,v,M,f,y,v,M);if(d)w.drawImage(d,0,0);b._x=m;b._y=g}var S=document.getElementById("C_wallpaper_mask");if(!S)return;S.width=i;S.height=n;var w=S.getContext("2d");w.globalCompositeOperation="copy";w.drawImage(e,m,g,v,M,f,y,v,M);w.globalCompositeOperation="destination-in";w.drawImage(b,0,0)},BGMask_CreateCanvas:function(e,t){if(!e)return null;if(!/^\((.+)\)$/.test(e)){return null}var i=RegExp.$1.split("|");var n=i[0];var o;if(n=="circle"){var a=parseInt(i[1]);var s=parseInt(i[2]);o=document.createElement("canvas");o.width=a;o.height=s;var r=a<s?a:s;var _=o.getContext("2d");_.beginPath();_.arc(a/2,s/2,r/2,0,Math.PI*2);_.fill()}else if(n=="feather"){var a=parseInt(i[1]);var s=parseInt(i[2]);var l=parseInt(i[3]);if(!l)l=parseInt(Math.sqrt(a*a+s*s)/25);o=document.createElement("canvas");o.width=a;o.height=s;var _=o.getContext("2d");var d;if(t)d=_.createImageData(a,s);else{_.fillRect(0,0,a,s);d=_.getImageData(0,0,a,s)}var c=d.data;for(var u=3,p=c.length;u<p;u+=4){var h=(u-3)/4;var m=h%a;var f=parseInt(h/a);var g=1.2;var y=1;if(m<l)y=(m+1)/(l+1);else if(m>=a-l)y=(a-m)/(l+1);y=1-(1-y)*g;if(y<0)y=0;var v=1;if(f<l)v=(f+1)/(l+1);else if(f>=s-l)v=(s-f)/(l+1);v=1-(1-v)*g;if(v<0)v=0;var M=y<v?y:v;if(M==1)continue;if(y<1&&v<1){var b=1-y;var w=1-v;var S=b>w?w/b:b/w;var A=Math.sqrt(1+S*S);M=1-(1-M)*A;if(M<0)M=0}c[u]=t?Math.round(255*(1-M)):Math.round(255*M)}_.putImageData(d,0,0)}return o},BGMask_Create:function(e){var t=this.bg_mask;if(!t)return;if(e){this.wallpaper_canvas=C_wallpaper_mask;C_wallpaper_mask.style.display="none"}else{var i=this.wallpaper_canvas=document.createElement("canvas");if(!is_SA_child_animation){i.width=parent.screen.width;i.height=parent.screen.height;i.getContext("2d").drawImage(C_wallpaper_mask,0,0)}}if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper&&e.img)e.img.img_obj._match_str=null})}if(/^\((.+)\)$/.test(t)){this.bg_mask_image=this.BGMask_CreateCanvas(t,is_SA_child_animation);this.BGMask_onload();return}var n=this.bg_mask_image=new Image;n.onload=this.BGMask_onload;n.src=toFileProtocol(t)},BGMask_onload:function(){var e=document.getElementById("C_BG_mask");if(!e){e=document.createElement("canvas");e.id="C_BG_mask";var t=e.style;t.position="absolute";t.posTop=t.posLeft=0;t.zIndex=60+1;document.body.appendChild(e)}if(System._browser.mouseover_hide_list.indexOf(e)==-1)System._browser.mouseover_hide_list.push(e);if(is_SA_child_animation){System._browser.bg_mask_image_resized=document.createElement("canvas")}else{System._browser.BGMask_Draw()}},BGMask_Draw:function(e){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom)){this.WMPMask_Draw();return}if(!document.getElementById("C_BG_mask"))return;var t,i,n,o;t=n=self.B_content_width?B_content_width:document.body.style.pixelWidth;i=o=self.B_content_height?B_content_height:document.body.style.pixelHeight;if(n>parent.screen.width)n=parent.screen.width;if(o>parent.screen.height)o=parent.screen.height;var a,s,r,_;var l=C_wallpaper_mask.style;if(l.posLeft>0){a=0;r=l.posLeft}else{a=-l.posLeft;r=0}if(l.posTop>0){s=0;_=l.posTop}else{s=-l.posTop;_=0}if(e){var d=a+","+s+","+n+","+o+","+r+","+_+","+n+","+o;if(e._match_str==d)return;e._match_str=d;e.width=t;e.height=i;var c=e.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(this.wallpaper_canvas,a,s,n,o,r,_,n,o);return}if(!this.bg_mask_image&&this.Opacity==1){document.getElementById("C_BG_mask").style.display="none";return}C_BG_mask.width=t;C_BG_mask.height=i;var c=C_BG_mask.getContext("2d");c.globalCompositeOperation="copy";c.globalAlpha=this.bg_mask_image?1:1-this.Opacity;c.drawImage(this.wallpaper_canvas,a,s,n,o,r,_,n,o);if(this.bg_mask_image){c.globalCompositeOperation="destination-out";c.globalAlpha=this.Opacity;c.drawImage(this.bg_mask_image,0,0,n,o)}else C_BG_mask.style.display="block"},resize_timerID:null,resize_cooling_timestamp:0,resize:function(){var e=false;function i(){if(!e){e=true;setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0)}}return function(){this.resize_timerID=null;if(use_SA_browser_mode){let t=document.body.style;if(is_SA_child_animation){let e=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;e.width=t.pixelWidth+"px";e.height=t.pixelHeight+"px";i()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.System._browser.capturePage_in_process){this.resize_timerID=setTimeout("System._browser.resize()",50);return}if(webkit_electron_mode)System._browser.resize_cooling_timestamp=performance.now();SA_top_window.resizeToAbsolute(t.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),t.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}i()}}}}(),drag_mouse_x:-1,drag_mouse_y:-1,drag_timerID:null,is_dragging:false,mouseout_timerID:null,mouseover_hide_list:[],onmouseover_custom:null,onmouseover:function(e){if(webkit_electron_mode&&(SA_topmost_window.returnBoolean("IgnoreMouseEvents")||SA_topmost_window.returnBoolean("AutoItStayOnDesktop"))&&!SA_topmost_window.webkit_IgnoreMouseEvents_disabled)return;if(this.onmouseover_custom&&this.onmouseover_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="hidden"},onmouseout_waiting_custom:null,onmouseout_waiting:function(e){if(this.onmouseout_waiting_custom&&this.onmouseout_waiting_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=e.clientX;var i=e.clientY;var n=document.body.style;var o=t>0&&t<n.pixelWidth&&(i>0&&i<n.pixelHeight);if(w3c_mode)e.stopPropagation();this.mouseout_timerID=setTimeout("System._browser.onmouseout("+o+")",200)},onmouseout:function(e){this.mouseout_timerID=null;if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}if(this.is_dragging){this.is_dragging=false;e=false;this.showFocus(false);System.Gadget.Settings._writeSettings(true,true)}else if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.is_dragging=false;this.showFocus(false)}if(e)return;var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="inherit";this.BGMask_Draw()},onmousedown:function(e){if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}var t=this.mouseover_hide_list;var i=true;for(var n=0;n<t.length;n++){var o=t[n].style;if(o.visibility!="hidden"){o.visibility="hidden";i=false}}var a;if(!i&&!is_SA_child_animation&&SA_child_animation_max){for(var n=0;n<SA_child_animation_max;n++){if(SA_child_animation[n]){a=true;break}}}i=!a;if(i){var s,r;if(WallpaperEngine_mode){s=e.x;r=e.y}else{if(absolute_screen_mode){s=SA_top_window.getCursorPos().x;r=SA_top_window.getCursorPos().y}else{s=e.screenX;r=e.screenY}}if(!is_SA_child_animation||!parent.returnBoolean("ChildDragDisabled")||true)this.drag_timerID=setTimeout("System._browser.onmousedown_dragStart("+s+","+r+")",200)}else DEBUG_show("(focused)",1)},showFocus:function(e,t){if(is_SA_child_animation){if(!xul_mode||!this.is_dragging)parent.System._browser.showFocus(e)}if(!e){Ldrag_dummy.style.visibility="hidden";return}var i=document.body.style.pixelWidth;var n=document.body.style.pixelHeight;if(i&&n){var o=Ldrag_dummy.style;o.pixelWidth=i-2;o.pixelHeight=n-2;o.visibility="inherit"}if(t)DEBUG_show("(selected)",1)},arrangeChildZ:function(i){System.Gadget.Settings._settings_need_update=true;var e=[];for(var t=0;t<SA_child_animation_max;t++){if(SA_child_animation[t])e[t]={index:t,z:SA_child_animation[t].z}}e.sort(function(e,t){return e.index==i?1:t.index==i?-1:e.z-t.z}).forEach(function(e,t){SA_child_animation[e.index].z=document.getElementById("Ichild_animation"+e.index).style.zIndex=t})},_child_selected:null,_drag_disabled:false,_child_drag_disabled:false,onmousedown_dragStart:function(e,t){this.drag_timerID=null;if(WallpaperEngine_mode)return;if(is_SA_child_animation&&is_SA_child_animation_host){parent.System._browser.is_dragging=true;parent.System._browser.drag_mouse_x=e;parent.System._browser.drag_mouse_y=t;DEBUG_show("drag start",1);this.showFocus(true);return}if(!this._drag_disabled&&(!is_SA_child_animation||!parent.System._browser._child_drag_disabled)){this.is_dragging=true;this.drag_mouse_x=e;this.drag_mouse_y=t;DEBUG_show("drag start",1)}this.showFocus(true);if(is_SA_child_animation){parent.System._browser.arrangeChildZ(SA_child_animation_id)}},_BL_clicked:0,_BL_clicked_max:1,_BL_clicked_timerID:null,onmouseup_custom:null,onmouseup:function(e){if(this.onmouseup_custom&&this.onmouseup_custom(e))return;this.onmouseout(true);if(this._drag_disabled||is_SA_child_animation&&parent.System._browser._child_drag_disabled)this.showFocus(false);if(e.clientX>20||e.clientY<document.body.style.pixelHeight-20)return;if(this._BL_clicked_timerID){clearTimeout(this._BL_clicked_timerID);this._BL_clicked_timerID=null}if(++this._BL_clicked<this._BL_clicked_max){this._BL_clicked_timerID=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250);return}this._BL_clicked=0;if(!WallpaperEngine_mode&&(!self.Lquick_menu||!Lquick_menu._activated))this.confirmClose()},confirmClose:function(e){if(browser_native_mode){if(confirm("This will reload System Animator.")){SA_topmost_window.location.reload()}return}if(!e||xul_mode){System._browser.showFocus(true,true);var t=is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.is_SA_hosted){if(confirm("Close "+SystemEXT._default.gadget_name+" (XUL host)?")){SA_top_window.opener.close();return}t+=" (this animation only)"}System._browser.showFocus(false)}if(is_SA_child_animation){if(is_SA_child_animation_host){parent.System._browser.confirmClose(e)}else{parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id]=null;var i=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);i.style.pixelWidth=i.style.pixelHeight=0;i.style.visibility="hidden";i.contentWindow.location.replace("z_blank.html")}}else{if(WallpaperEngine_CEF_mode&&!W8_or_above){SA_top_window.location.reload()}else SA_top_window.close()}},onSettings:function(){if(!System.Gadget.settingsUI)return false;if(use_inline_dialog){if(document.getElementById("Idialog").style.visibility=="hidden"){document.getElementById("Idialog").contentWindow.location.replace("settings.html")}return true}System._browser.showFocus(true,true);var e=showModalDialog(System.Gadget.settingsUI,self);e=xul_mode?self.returnValue:e;System._browser.showFocus(false);this.onSettingsClosed(e);return true},onSettingsClosed:function(e){if(System.Gadget.onSettingsClosed)System.Gadget.onSettingsClosed({closeAction:!!e,Action:{commit:true}})},onkeydown:function(e){var t=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host;const i=e.altKey;const n=i||!self.MMD_SA||!MMD_SA_options.Dungeon_options||!e.preventDefault;var o=e.keyCode;if(o==67&&i){this.confirmClose();return true}else if(o==69&&n){return this.onSettings()}else if(o==79&&n){var a;if(is_SA_child_animation){var s=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id].opacity=a;s.opacity=a}else if(this.bg_mask){a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}System.Gadget.Settings.writeString("Opacity",a);this.Opacity=a;this.BGMask_Draw()}else if(w3c_mode||HTA_use_GPU_acceleration){var s=this.body.style;a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}System.Gadget.Settings.writeString("Opacity",a);s.opacity=a}else return false;this.Opacity=a;DEBUG_show("Opacity:"+a*100+"%",2);this.update_tray();return true}else if(o==83&&n){var r=System.Gadget.docked?System.Gadget.onUndock:System.Gadget.onDock;if(!r)return false;setTimeout(System._browser.ondockundock,0);return true}else if(t&&(o>=49&&o<49+SA_child_animation_max)&&n){var _=o-49;var l=is_SA_child_animation?parent:self;var d=l.document.getElementById("Ichild_animation"+_);if(!d||!d.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(_+1)+" not found)",2);return true}var c=d.contentWindow;var u=c.parent;var p=u.System._browser;if(c.System.Gadget.Settings.readString("CSSTransform3D")||u.System.Gadget.Settings.readString("CSSTransform3D")){if(p._child_selected==_){p._child_selected=null;c.DEBUG_show("(deselected)",2);u.DEBUG_show("(child"+(_+1)+" deselected)",2);return true}p._child_selected=_}c.DEBUG_show("(selected)",2);u.DEBUG_show("(child"+(_+1)+" selected)",2);p.arrangeChildZ(_);c.focus();return true}else if(t&&o==96&&n){var l=is_SA_child_animation?parent:self;var s=l.Lchild_animation_parent.style;s.visibility=s.visibility=="hidden"?"visible":"hidden";if(webkit_mode)s.display=s.visibility=="hidden"?"none":"block";l.System._browser._child_selected=null;return true}else if(t&&(o>=97&&o<97+SA_child_animation_max)&&n){var _=o-97;var l=is_SA_child_animation?parent:self;var d=l.document.getElementById("Ichild_animation"+_);if(!d||!d.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(_+1)+" not found)",2);return true}var s=d.style;s.visibility=s.visibility=="hidden"?"visible":"hidden";if(webkit_mode)s.display=s.visibility=="hidden"?"none":"block";l.System._browser._child_selected=null;var h=false;for(var m=0;m<SA_child_animation_max;m++){var d=l.document.getElementById("Ichild_animation"+m);if(d&&d.contentWindow.is_SA_child_animation&&d.style.visibility!="hidden"){h=true;break}}l.document.getElementById("Lchild_animation_parent").style.visibility=h?"visible":"hidden";return true}else if(o>=96&&o<96+10){if(self.MMD_SA&&MMD_SA_options.motion_shuffle&&MMD_SA.use_jThree&&MMD_SA.MMD_started){if(this.camera.ML_enabled){}else if(o==96){if(MMD_SA_options._motion_shuffle){if(!MMD_SA_options.motion_shuffle_list_default&&MMD_SA_options._motion_shuffle_list_default){MMD_SA_options.motion_shuffle_list_default=MMD_SA_options._motion_shuffle_list_default.slice();MMD_SA._force_motion_shuffle=true}else{MMD_SA_options.motion_shuffle=MMD_SA_options._motion_shuffle.slice(0);MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motions shuffled)",2)}}}else{var _=o-97;if(MMD_SA_options.motion_by_song_name){if(MMD_SA_options.motion_by_song_name._loading_){DEBUG_show("(music/motion loading)",2);return true}let e=Object.keys(MMD_SA_options.motion_by_song_name).find(e=>{return MMD_SA_options.motion_by_song_name[e].key==_+1});if(e){let t=MMD_SA_options.motion_by_song_name[e].song_path;if(/\.zip\#/i.test(t)){MMD_SA_options.motion_by_song_name._loading_=true;t=t.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let e=new self.XMLHttpRequestZIP;e.onload=function(){MMD_SA_options.motion_by_song_name._loading_=false;let e=this.response;e.name=t.replace(/^.+[\/\\]/,"");e.isFileSystem=true;SA_DragDropEMU(e)};e.open("GET",t,true);e.responseType="blob";e.send()}else SA_DragDropEMU(t);return true}}if(_>=MMD_SA.normal_action_length){DEBUG_show("(MMD motion not found)",2);return true}if(!MMD_SA_options._motion_shuffle)MMD_SA_options._motion_shuffle=MMD_SA_options.motion_shuffle.slice(0);MMD_SA_options.motion_shuffle=[_];MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motion changed)",2)}return true}}return false},ondockundock:function(){DEBUG_show("Dock state changed",2);var e=!System.Gadget.docked;System.Gadget.docked=e;System.Gadget.Settings.writeString("SA_docked",!!e==!!is_SA_child_animation?"":e?"1":"0");var t=!e?System.Gadget.onUndock:System.Gadget.onDock;if(!t)return;t()},onmousemove_custom:null,onmousemove:function(e){var t,i;if(WallpaperEngine_mode||browser_native_mode){t=this._WE_mouse_x=e.x;i=this._WE_mouse_y=e.y}if(this.onmousemove_custom&&this.onmousemove_custom(e))return;if(!this.is_dragging){if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.onmousemove(e)}return}if(!WallpaperEngine_mode){if(absolute_screen_mode){t=SA_top_window.getCursorPos().x;i=SA_top_window.getCursorPos().y}else{t=e.screenX;i=e.screenY}}if(is_SA_child_animation||this._child_selected!=null){var n,o,a;if(is_SA_child_animation){a=SA_child_animation_id;n=self;o=parent}else{a=this._child_selected;n=document.getElementById("Ichild_animation"+a).contentWindow;o=self}o.System.Gadget.Settings._settings_need_update=true;var s=o.SA_child_animation[a];var r=o.document.getElementById("Ichild_animation"+a).style;var _=n.document.body.style;var l=o.document.body.style;var d=s.x+t-this.drag_mouse_x;var c=s.y+i-this.drag_mouse_y;r.posLeft=s.x=d;r.posTop=s.y=c;n.document.getElementById("Ldebug").innerText=o.document.getElementById("Ldebug").innerText="(moving)";n.DEBUG_hide_sec=o.DEBUG_hide_sec=0;n.DEBUG_show("("+d+","+c+")",2)}else{System.Gadget.Settings._settings_need_update=true;this.moveBy(t-this.drag_mouse_x,i-this.drag_mouse_y,e)}this.moveWallpaper();this.drag_mouse_x=t;this.drag_mouse_y=i},moveWallpaper:function(e,t){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom))return;if(is_SA_child_animation||document.getElementById("LdesktopBG")&&LdesktopBG.style.display!="none"){if(WallpaperEngine_mode){e=0;t=0}else{if(absolute_screen_mode){if(e==null)e=SA_top_window.screenLeftAbsolute;if(t==null)t=SA_top_window.screenTopAbsolute;var i=SA_top_window.getScreenBounds(e,t);e=-(e-i.x);t=-(t-i.y)}else{if(e==null)e=SA_top_window.screenLeft;if(t==null)t=SA_top_window.screenTop;e=-(e%parent.screen.width);t=-(t%parent.screen.height)}}if(is_SA_child_animation){var n=parent.SA_child_animation[SA_child_animation_id];e-=n.x;t-=n.y}else{var o=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;o.posLeft=e;o.posTop=t}if(document.getElementById("C_wallpaper_mask")){var a=C_wallpaper_mask.style;a.posLeft=e;a.posTop=t}}},moveBy:function(e,t,i){SA_top_window.moveByAbsolute(e,t)},update_tray:function(e){try{if(!webkit_electron_mode||IPC.active_window!=self)return;if(this._tray_last_updated==RAF_timestamp){return}this._tray_last_updated=RAF_timestamp;if(!e){e={active_window_id:IPC.active_window_id,click_thru:SA_topmost_window.returnBoolean("IgnoreMouseEvents"),click_thru_partial:SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial"),always_on_top:SA_topmost_window.returnBoolean("AutoItAlwaysOnTop"),stay_on_desktop:SA_topmost_window.returnBoolean("AutoItStayOnDesktop"),use_electron_as_wallpaper:SA_topmost_window.WebKit_object.use_electron_as_wallpaper,auto_pause:SA_topmost_window.returnBoolean("AutoItAutoPause"),opacity:is_SA_child_animation?parent.SA_child_animation[SA_child_animation_id].opacity:parseFloat(System.Gadget.Settings.readString("Opacity")||1),opacity_on_hover:parseFloat(System.Gadget.Settings.readString("OpacityOnHover")||1),size:Settings.CSSTransformFullscreen?-1:Settings.CSSTransformScale,animation_path:Settings.f_path_folder,media_control:self.SL&&SL._mouse_event_main&&SL._mouse_event_main(),MMD:null};var t=[true];for(var i=0;i<SA_child_animation_max;i++)t.push(!!SA_topmost_window.SA_child_animation[i]);e.active_window=t;e.lock_child_dragging=returnBoolean("ChildDragDisabled");var n=this.tray_menu_custom;if(n){e.custom_menu_para=n.para;n.update_tray&&n.update_tray(e)}else{e.custom_menu_para={}}if(self.MMD_SA&&MMD_SA._tray_updatable){var o=MMD_SA_options.MME;var a=e.MMD={use_webgl2:!!MMD_SA.use_webgl2,use_dungeon:!!MMD_SA_options.Dungeon,use_THREEX:!!MMD_SA.THREEX.enabled,look_at_camera:!!MMD_SA_options._look_at_screen,look_at_mouse:!!MMD_SA_options._look_at_mouse,trackball_camera:!!returnBoolean("MMDTrackballCamera"),random_camera:!!returnBoolean("MMDRandomCamera"),random_camera_available:!!MMD_SA_options.use_random_camera,override_default_for_external_model:!!returnBoolean("MMDOverrideDefaultForExternalModel"),VMC_sender_enabled:!!MMD_SA.OSC.VMC.sender_enabled,VMC_VSeeFace_mode:!!MMD_SA.OSC.VMC.VSeeFace_mode,VMC_hide_3D_avatar:!!MMD_SA.hide_3D_avatar,light:{},MME:{self_overlay:{},HDR:{},serious_shader:{},SAO:{},PostProcessingEffects:{}}};a._material_list=MMD_SA._material_list||[];if(MMD_SA._model_list){a._model_list=MMD_SA._model_list;MMD_SA._model_list=null}var s=jThree("#MMD_DirLight").three(0);var r=s.color;a.light.color=[Math.min(255,parseInt(r.r*256)),Math.min(255,parseInt(r.g*256)),Math.min(255,parseInt(r.b*256))];a.light.position=s.position.clone().sub(MMD_SA_options.MMD_disabled&&{x:0,y:0,z:0}||THREE.MMD.getModels()[0].mesh.position).multiplyScalar(1/MMD_SA_options.light_position_scale).toArray();a.shadow_darkness=MMD_SA_options.shadow_darkness;Object.assign(a.MME.self_overlay,o.self_overlay);Object.assign(a.MME.HDR,o.HDR);Object.assign(a.MME.serious_shader,o.serious_shader);Object.assign(a.MME.SAO,o.SAO);var _=MMD_SA_options.MME.PostProcessingEffects;var l=a.MME.PostProcessingEffects;l.enabled=returnBoolean("Use3DPPE")||!!(MMD_SA_options.PPE_disabled_on_idle?MMD_SA_options._PPE_enabled:_.enabled);l.use_SAO=!!_.use_SAO;l.use_Diffusion=!!_.use_Diffusion;l.use_BloomPostProcess=!!_.use_BloomPostProcess;l.use_BloomPostProcess_blur_size=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessBlurSize")||.5);l.use_BloomPostProcess_threshold=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessThreshold")||.5);l.use_BloomPostProcess_intensity=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessIntensity")||.5);a.MME_saved=!!MMD_SA_options.MME_saved[MMD_SA_options.model_para_obj._filename]}if(!document.getElementById("Lchild_animation_parent"))e.apply_to_child=null;else e.apply_to_child=returnBoolean("CSSTransformToChildAnimation")}webkit_electron_remote.getGlobal("update_tray")(e)}catch(d){console.error(d)}},load_file:function(t,i,n,o){if(!n)n="blob";if(!o)o=!(self.MMD_SA&&MMD_SA.fn);if(o){if(self.MMD_SA&&MMD_SA.fn){MMD_SA.fn.load_length_extra++}else{MMD_SA_options.load_length_extra=(MMD_SA_options.load_length_extra||0)+1}}var e;if(/\.zip\#/i.test(t)||n!="blob"||typeof i=="function"){e=function(){var e=new XMLHttpRequestZIP;e.onload=async function(){if(typeof i=="function"){await i(e)}else{i.src=URL.createObjectURL(this.response)}if(o){MMD_SA.fn.setupUI()}e=undefined};e.open("GET",toFileProtocol(t),true);e.responseType=n;e.send()}}else{e=function(){if(o){var e=function(){MMD_SA.fn.setupUI();i.removeEventListener("load",e)};i.addEventListener("load",e)}i.src=toFileProtocol(t)}}if(!self.XMLHttpRequestZIP){window.addEventListener("jThree_ready",function(){e()})}else{e()}},on_animation_update:function(){var a=[[],[]];var o=0;return{add:function(e,t,i,n){a[i].push({func:e,frame_count:t+i,loop:n,index:o++})},remove:function(t,e){a[e].forEach(e=>{if(e.func==t)e.canceled=true})},run:function(e){var t=[];var i=a[e];if(!i.length)return;var n=[];for(let e=0;e<i.length;e++){const o=i[e];if(o.canceled)continue;if(--o.frame_count>=0){n.push(o)}else{o.func();if(o.loop&&--o.loop!=0)n.push(o)}}a[e]=n}}}(),get css_scale(){return window.devicePixelRatio>=2?.5:1},virtual_numpad_toggle:function(e){if(e==null)e=Lnumpad_row0.style.display=="none";Lnumpad_row0.style.display=e?"inline":"none";Lnumpad_rows.style.display=e?"block":"none";if(e&&self.ChatboxAT)ChatboxAT.chatW_minimize(0,true)},virtual_numpad:function(){var _={};return function(e,t){e.preventDefault();e.stopPropagation();var i=MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.character.combat_mode;var n=e.target.textContent;var o=_[n]=_[n]||{};var a,s;switch(n){case"S":a=16;o.pressed=!o.pressed;t=o.pressed?"keydown":"keyup";break;case"+":a=107;if(i){if(t=="keyup")return;o.pressed=!o.pressed;t=o.pressed?"keydown":"keyup"}break;case"-":a=109;break;case"*":a=106;break;case"/":a=111;break;case"⏎":a=13;break;case"J":a=32;break;case"↑":a=38;break;case"↓":a=40;break;case"←":a=37;break;case"→":a=39;break;default:a=parseInt(n)+96}if(o.timeoutID)clearTimeout(o.timeoutID);if(o.intervalID)clearTimeout(o.intervalID);o.timeoutID=o.intervalID=null;let r=new KeyboardEvent(t,{bubbles:true,cancelable:true,key:n,keyCode:a,shiftKey:_["S"]&&_["S"].pressed});document.dispatchEvent(r);if(t=="keydown"){if(/[\+S]/.test(n)&&(n!="+"||i)){e.target.style.opacity="0.75"}else{o.timeoutID=setTimeout(function(){o.intervalID=setInterval(function(){document.dispatchEvent(r)},100)},400)}}else{e.target.style.opacity=""}}}(),P2P_network:function(){var n;var o=0;var a={events:{peer:{},connection:{handshake_request:function(e,t){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) responding handshake request from Peer-"+e.index+"("+e.id+")");t.send({handshake:{request:true}})},handshake_respond:function(e,t,i){if(i.request){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/client)'s handshake request accepted from Peer-"+e.index+"("+e.id+")");t.send({handshake:{accepted:true}})}else if(i.accepted){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) accepted handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_accecpted&&e.para.events.connection.handshake_request_accecpted[t.label]){e.para.events.connection.handshake_request_accecpted[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_accecpted[t.label]}}else{console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) rejected handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_rejected&&e.para.events.connection.handshake_request_rejected[t.label]){e.para.events.connection.handshake_request_rejected[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_rejected[t.label]}}},data:function(e,t,i){}},send_message:function(e){if(!e.command)t.content_window.ChatboxAT.ChatShow([e.name+": "+e.msg]);return null}}};function s(t,i){this._connection=i;this.status="connecting";t.connections[i.label]=this;var n=this;i.on("data",function(e){if(e.handshake){t.para.events.connection.handshake_respond(t,n,e.handshake)}else{t.para.events.connection.data(t,n,e)}});i.on("close",function(e){console.log("P2P_network: DataConnection"+"("+i.peer+"/"+i.label+"/host) closed");n.close(t)})}s.prototype.send=function(e){this._connection.send(e)};s.prototype.close=function(e){if(!e.connections[this.label])return;if(e.para.events.connection.close&&e.para.events.connection.close(e,this))return;delete e.connections[this.label];var t=this;setTimeout(function(){t._connection.close();t._connection=null},1e3)};Object.defineProperty(s.prototype,"peer",{get:function(){return this._connection.peer}});Object.defineProperty(s.prototype,"label",{get:function(){return this._connection.label}});function r(){}Object.defineProperty(r.prototype,"length",{get:function(){return Object.keys(this).length}});function e(t=Object.clone(a)){this.para=t;this.id=null;var e=this._peer=new Peer;this.index=o;this.connections=new r;this.status="connecting";var i=this;e.on("open",function(e){o++;if(!n)n=i;i.id=e;i.status="connected";console.log("P2P_network: Peer-"+i.index+"("+e+") connected");i.para.events.peer.open&&i.para.events.peer.open(i)});e.on("error",function(e){console.log("P2P_network: Peer-"+i.index+" error",e);if(i.para.events.peer.error_by_connection){i.para.events.peer.error_by_connection(e);delete i.para.events.peer.error_by_connection}else i.para.events.peer.error&&i.para.events.peer.error(i,e)});e.on("connection",function(e){if(t.events.peer.connection&&t.events.peer.connection(i,e))return;console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connecting to Peer-"+i.index+"("+i.id+")");e.on("open",function(){console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connected to Peer-"+i.index+"("+i.id+")");new s(i,e)})})}e.prototype.connect=function(o,e){var a=this;return new Promise(function(i,n){var e=function(){var e={serialization:"json"};var t=a._peer.connect(o,e);t.on("open",function(){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) connecting to Peer-"+a.index+"("+a.id+")");var e=new s(a,t);a.para.events.connection.handshake_request(a,e);a.para.events.connection.handshake_request_accecpted=a.para.events.connection.handshake_request_accecpted||{};a.para.events.connection.handshake_request_rejected=a.para.events.connection.handshake_request_rejected||{};a.para.events.connection.handshake_request_accecpted[t.label]=i;a.para.events.connection.handshake_request_rejected[t.label]=n;delete a.para.events.peer.error_by_connection});t.on("error",function(e){console.log("P2P_network: Remote connection failed",e);n(e)});a.para.events.peer.error_by_connection=n};switch(a.status){case"connected":e();break;default:setTimeout(function(){n(a)},0)}})};var t={peer:e,get peer_default(){return n},status:"off",get content_window(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},process_message:function(e,t){var i=this.peer_default;if(!i)return e;var n=this.content_window.document.getElementById("Flogin").id.value;var o=this.content_window.document.getElementById("Flogin").pass.value;var a=this.content_window.MMD_SA_options;var s=(n||a&&a.model_para_obj.character&&a.model_para_obj.character.name||"Anonymous").substring(0,16);var r=i&&i.connections.length;var _;if(!/^\//.test(e)){_=i.para.events.send_message({name:s,msg:e,id:n,pass:o})}else{var l,d,c;var u=this.content_window.ChatboxAT.checkChatCommand(e);l=u.command;d=u.para1;c=u.para2;_=i.para.events.send_message({name:s,msg:e,command:l,para1:d,para2:c,id:n,pass:o})}if(!t)this.content_window.document.getElementById("Fchat").msg.value="";if(_!=null)return _;return e}};return t}(),camera:function(){var te;var d,_;var c;var ie,L;var ne,r;var B;var h;var k=true;var a=new URLSearchParams(self.location.search.substring(1));var oe="";var s=true;var t;var S=0;var A="";function l(){var s=te.video;if(!s.videoWidth||s.readyState<2){return}if(c.busy||RAF_animation_frame_unlimited&&!MMD_SA.WebXR.session&&A==te.video_frame_id&&!ne.bb_clear){return}A=te.video_frame_id;S=RAF_timestamp;var o=te.video_canvas;var r=o.getContext("2d");if(ne.bb_clear){if(s.pause&&!s.paused||--ne.bb_clear<=0||ne._bb&&ne._bb_waiting){ne.bb_clear=ne._bb=ne._bb_waiting=null;r.globalCompositeOperation="copy"}else{if(ne._bb){r.globalCompositeOperation="source-over";r.fillStyle="black";let e=Math.max(ne._bb[3],0);let t=Math.max(ne._bb[0],0);const _=Math.min(ne._bb[1]-e,o.width);const l=Math.min(ne._bb[2]-t,o.height);if(te.video_flipped){e=o.width-(e+_)}r.fillRect(e,t,_,l);ne._bb=null;ne._bb_waiting=true}return}}var _,l;if(te.is_local_media){_=s.videoWidth;l=s.videoHeight;const e=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(_*l>e[0]*e[1]){const t=Math.sqrt(_*l/(e[0]*e[1]));_=Math.round(_/t);l=Math.round(l/t)}}else{_=te.target_width;l=te.target_height}var a=MMD_SA_options.user_camera.display.webcam_as_bg?{scale:1,top:0}:MMD_SA_options.user_camera.display.video;if(!a.scale){if(o.style.pixelWidth!=window.innerWidth||o.style.pixelHeight!=window.innerHeight){o.style.width=window.innerWidth+"px";o.style.height=window.innerHeight+"px"}}else{let e=a.scale*(te.display_floating?MMD_SA_options.user_camera.display.floating_scale||MMD_SA_options.user_camera.display.floating&&1||.5:1);let i=~~(window.innerWidth*e);let n=~~(window.innerHeight*e);if(o.style.pixelWidth!=i||o.style.pixelHeight!=n){o.style.width=i+"px";o.style.height=n+"px";let e=(window.innerWidth-i)/2;let t=(window.innerHeight-n)/2;o.style.left=e*(1+(a.left!=null?a.left:-1))+"px";o.style.top=t*(1+(a.top!=null?a.top:0))+"px"}o.style.objectFit="contain"}if(o.width!=_||o.height!=l){o.width=_;o.height=l;r.globalCompositeOperation="copy";if(te.video_flipped){r.translate(_,0);r.scale(-1,1)}}if(_==s.videoWidth&&l==s.videoHeight){r.drawImage(s,0,0)}else{let e=_/l;let t=s.videoWidth/s.videoHeight;let i,n,o,a;if(e<=t){o=s.videoHeight*e;i=(s.videoWidth-o)/2;a=s.videoHeight;n=0}else{o=s.videoWidth;i=0;a=s.videoWidth/e;n=(s.videoHeight-a)/2}r.drawImage(s,i,n,o,a,0,0,_,l)}o.style.visibility=!te.visible||c.enabled||d.initialized&&d.worker_initialized&&!d.dets||te.hidden_enforced?"hidden":"inherit"}function m(){if(c.enabled){c.update_frame()}else{if(ie.enabled){ie.update_frame(true)}else if(d.enabled){d.update_frame(true)}if(ne.enabled||B.enabled){ge(true)}}const i=te.video_canvas_facemesh.style;const e=te.video_canvas.style;const t=MMD_SA_options.user_camera.display.wireframe.align_with_video?1:MMD_SA_options.user_camera.display.wireframe.scale||(is_mobile?.25:1);const n=~~(e.pixelWidth*t);const o=~~(e.pixelHeight*t);if(i.pixelWidth!=n||i.pixelHeight!=o){i.pixelWidth=n;i.pixelHeight=o;if(MMD_SA_options.user_camera.display.wireframe.align_with_video){i.posLeft=e.posLeft;i.posTop=e.posTop}else{let e=(window.innerWidth-n)/2;let t=(window.innerHeight-o)/2;i.left=e*(1+(MMD_SA_options.user_camera.display.wireframe.left!=null?MMD_SA_options.user_camera.display.wireframe.left:1))+"px";i.top=t*(1+(MMD_SA_options.user_camera.display.wireframe.top!=null?MMD_SA_options.user_camera.display.wireframe.top:-1))+"px"}}i.objectFit=e.objectFit;i.visibility=te.ML_enabled&&!MMD_SA_options.user_camera.display.wireframe.hidden&&!MMD_SA_options.user_camera.display.webcam_as_bg?"inherit":"hidden"}var D;function f(){if(te.initialized){SL.style.transform=SL_2D_front.style.transform=te.mirror_3D?"scaleX(-1)":"none";te.video_canvas.style.transform=te.display_flipped?"scaleX(-1)":"none";te.reset_video_canvas()}if(!D&&te.initialized){D=true;System._browser.on_animation_update.add(l,0,0,-1);System._browser.on_animation_update.add(m,2,1,-1)}}function g(){SL.style.transform=SL_2D_front.style.transform=te.mirror_3D?"scaleX(-1)":"none";te.video_canvas.style.transform="none";te.reset_video_canvas();if(te.visible)return;if(D&&!te.ML_enabled){D=false;System._browser.on_animation_update.remove(l,0);System._browser.on_animation_update.remove(m,1);te.video_canvas_facemesh.style.visibility="hidden"}}var n=100;function v(e){if(!te.visible)return;var t=e.detail.keyCode;if(t==107)n+=10;else if(t==109)n-=10;else return;n=Math.max(Math.min(n,180),20);var i=te.video_canvas.getContext("2d");if(n==1){i.filter="none";DEBUG_show("Brightness:100%",2)}else{i.filter="brightness("+n+"%) contrast("+(100+(n-100)*.25)+"%)";DEBUG_show("Brightness:"+n+"%",2)}e.detail.result.return_value=true}var M=0;function b(e){if(!e)e=te.local_src||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.Gadget.path+"/js/headtrackr.mp4");if(/\.(png|jpg|jpeg|bmp|webp)$/i.test(e)){if(!te._image){te._image=new Image;Object.defineProperty(te._image,"videoWidth",{get:function(){return this.width}});Object.defineProperty(te._image,"videoHeight",{get:function(){return this.height}});Object.defineProperty(te._image,"readyState",{get:function(){return this.complete?4:0}})}if(te.video&&te.video.pause)te.video.pause();te.video=te._image;te._image.src=toFileProtocol(e)}else{te.video=te._video;te.video.loop=true;if(!te.video._initialized){te.video._initialized=true;te.video.addEventListener("canplaythrough",function(e){te.media_control_enabled=true;SL_MC_simple_mode=true;SL_MC_video_obj=te.video;SL_MC_Place(1,0,-64);var t=y.speed;if(t){te.video.playbackRate=t;if(t<1)te.video.muted=true}else{te.video.playbackRate=1;te.video.muted=false}});te.video.addEventListener("timeupdate",function(e){SL_MC_Timeupdate(this)},true);te.video.addEventListener("ended",function(e){if(y.speed)y.stop()})}te.video.src=toFileProtocol(e)}te.video_id=e;te.local_src=e}var i=false;function E(){var e=ie.enabled||ne.enabled;if(i==!!e)return;i=!!e;if(e){f();se.reset();se.add_events();DEBUG_show("(Camera ML Mode:ON)",2)}else{if(te.initialized){te.video_canvas_face_detection.style.visibility="hidden";te.video_canvas_facemesh.style.visibility="hidden";g()}se.remove_events();te._info="";DEBUG_show("(Camera ML Mode:OFF)",2)}}var w,x,G;var H,U,W,J;var q,K;var ae,V;var P,I;var R;var u,F;window.addEventListener("jThree_ready",()=>{H=new THREE.Vector3;U=new THREE.Vector3;W=new THREE.Vector3;J=new THREE.Vector3;R=new THREE.Vector3;q=new THREE.Quaternion;K=new THREE.Quaternion;ae=new THREE.Matrix4;V=new THREE.Quaternion;P=new THREE.Vector2;I=new THREE.Vector2;u=new THREE.Quaternion;F=new THREE.Quaternion});var ee=["親","人","中","薬","小"];var re=["thumb","index","middle","ring","pinky"];var Q=["０","１","２","３"];var e;var o;var T;var _e=true;var le=true;var X;var p=true;var C,de,j;var N=false;var Y=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"];var ce=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28];var ue=[];Y.forEach(e=>{ue.push({part:e,score:0})});var Z,O;async function pe(){w=true;if(MMD_SA_options.model_para_obj.left_arm_z_rot==null){let r=THREE.MMD.getModels()[0];let n=r.mesh.bones_by_name;let e=n["左腕"].pmxBone.origin;let t=n["左ひじ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_z_rot=Math.PI/2+Math.atan2(t[1]-e[1],t[0]-e[0]);let i=n["左腕ＩＫ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_to_IK_xy=[e[0]-i[0],e[1]-i[1]];MMD_SA_options.model_para_obj.left_arm_length=Math.sqrt(MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]*MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]+MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]);let o=n["右腕"].pmxBone.origin;MMD_SA_options.model_para_obj.shoulder_width=Math.abs(e[0]-o[0]);MMD_SA_options.model_para_obj.arm_axis={"左":(new THREE.Vector3).fromArray(i).sub(MMD_SA.TEMP_v3.fromArray(e)).normalize()};MMD_SA_options.model_para_obj.arm_axis["右"]=MMD_SA_options.model_para_obj.arm_axis["左"].clone().setX(-MMD_SA_options.model_para_obj.arm_axis["左"].x);MMD_SA_options.model_para_obj.hip_center=(new THREE.Vector3).fromArray(n["左足"].pmxBone.origin).setX(0);MMD_SA_options.model_para_obj.spine_length=n["首"].pmxBone.origin[1]-MMD_SA_options.model_para_obj.hip_center.y;MMD_SA_options.model_para_obj.left_heel_height=n["左足首"].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_upper_length=n["左足"].pmxBone.origin[1]-n["左ひざ"].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_lower_length=n["左ひざ"].pmxBone.origin[1]-n["左足首"].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_length=MMD_SA_options.model_para_obj.left_leg_upper_length+MMD_SA_options.model_para_obj.left_leg_lower_length;let a=["左","右"];Z={};a.forEach(o=>{["腕","ひじ"].forEach((e,t)=>{let i=o+e;let n=MMD_SA.get_bone_axis_rotation(r.mesh,i);Z[i]={name:i,axis_rot:n,parent:t==0?{axis_rot:new THREE.Quaternion}:Z[o+"腕"]};Z[i].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(Z[i].parent.axis_rot,MMD_SA.TEMP_q.copy(Z[i].axis_rot).conjugate())})});O={};O[1]=(new THREE.Quaternion).multiplyQuaternions(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*1,Math.PI/2*1),"YZX"),MMD_SA._q1.copy(Z["左腕"].axis_rot).conjugate());O[-1]=(new THREE.Quaternion).multiplyQuaternions(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*-1,Math.PI/2*-1),"YZX"),MMD_SA._q1.copy(Z["右腕"].axis_rot).conjugate());MMD_SA_options.model_para_obj.finger_base={};a.forEach(s=>{let e=n[s+"手首"].pmxBone.origin;ee.forEach((e,t)=>{let o=s+e+"指";let i=t==0&&n[o+Q[0]]?0:1;if(!n[o+Q[i+0]])return;let a=MMD_SA_options.model_para_obj.finger_base[s+t]={base_index:i};for(let i=a.base_index+(t==0?0:-1),n=i;n<3;n++){let e=o+Q[a.base_index+(n-i)];let t=MMD_SA.get_bone_axis_rotation(r.mesh,e);Z[e]={name:e,axis_rot:t,parent:n==i?Z[s+"ひじ"]:Z[o+Q[a.base_index+(n-1-i)]]};Z[e].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(Z[e].parent.axis_rot,MMD_SA.TEMP_q.copy(Z[e].axis_rot).conjugate())}})});for(const s in Z){if(s.indexOf("指")!=-1){MMD_SA.TEMP_v3.setEulerFromQuaternion(Z[s].axis_rot,"ZYX");MMD_SA.TEMP_v3.z*=-1;Z[s].axis_rot.setFromEuler(MMD_SA.TEMP_v3,"ZYX")}Z[s].axis_rot_inv=Z[s].axis_rot.clone().conjugate()}console.log(Z)}var t=[];if(is_mobile){t.push("use_mobilenet=1")}if(p){t.push("use_holistic=1");e=o=false;le=X=true}if(e){t.push("use_human=1");C=true;e=true;o=false;T=false;de=true;j=true}else if(o){t.push("use_mixed_human=1");e=true;o=true;T=true;j=true}else{e=false;o=false;T=true}if(le){t.push("use_blazepose=1");X=true}if(X){t.push("use_mediapipe=1");if(e){de=true;j=false}_e=true}if(_e){t.push("use_movenet=1")}if(MMD_SA_options.user_camera.ML_models.worker_disabled&&ie.initialized&&!ie.worker_initialized){await new Promise(function(e,t){var i=setInterval(()=>{if(ie.worker_initialized){clearInterval(i);e()}},100)})}else{await ie.init()}if(MMD_SA_options.user_camera.ML_models.worker_disabled){r={postMessage:function(e,t){PoseAT.onmessage({data:e})}};let e=document.createElement("script");e.onload=function(){PoseAT.init(r,t)};e.src="js/pose_lib.js";document.head.appendChild(e)}else{r=new Worker("js/pose_worker.js"+(t.length?"?"+t.join("&"):""))}r.onmessage=fe}var he=function(){let u;window.addEventListener("jThree_ready",()=>{u=new System._browser.data_filter([{type:"one_euro",para:[30,.8,.05,.8,4]}])});return function(e,t){var i=e.bones_by_name[t];var n=this.skin[t];var o=Math.max(Math.min(n[0].t_delta/n[0].t_delta_frame,1),0);var a=MMD_SA.TEMP_q.set(0,0,0,1);var s=n[0].no_blending?MMD_SA._q2.copy(n[0].rot):MMD_SA._q2.copy(n[1].rot).slerp(n[0].rot,o);if(!i){n[0]._rot_from_pose.copy(s);return}var r=n[0].rot_parent;if(!r){r=MMD_SA.get_bone_rotation_parent(e,t,e).conjugate();r.premultiply(F)}n[0]._rot_parent=r;if(n[0].info[1]=="facemesh"&&this.skin[t+"_DUMMY_"]){let e=Math.min(Math.max(.25-n[0]._rot_ratio,0)*5,1);s.slerp(this.skin[t+"_DUMMY_"][0]._rot_from_pose,e*e*.667);n[0]._rot_mixed=s.clone()}var _=s.toAxisAngle()[1]%(Math.PI*2);if(_>Math.PI)_=Math.PI*2-_;else if(_<0&&_<-Math.PI)_+=Math.PI*2;_=Math.abs(_);o=ne.use_3D_pose?.5:.3+Math.max(_-Math.PI/2,0)/(Math.PI/2)*.2;var l=q.multiplyQuaternions(r,s);l.fromArray(u.filter(l.toArray()));var d=H.setEulerFromQuaternion(l,"YZX");var c=[d.x<0?o+(.5-o)*.5:o,o,o];l.setFromEuler(U.fromArray(d.toArray().map((e,t)=>Math.sign(e)*Math.min(Math.abs(e),Math.PI/2)*c[t])),"YZX");i.quaternion.copy(l);e.bones_by_name["頭"].quaternion.copy(l);if(y.active){y.set_boneKey(t,null,l,true);y.set_boneKey("頭",null,l)}if(o<.5){i=e.bones_by_name["上半身2"];i.quaternion.multiply(q.setFromEuler(H.setEulerFromQuaternion(s,"YZX").multiply(U.fromArray(c.map(e=>1-e*2))),"YZX"))}}}();var me=1*10;var $=function(){var g=[];var n;var o;window.addEventListener("jThree_ready",()=>{n=new System._browser.data_filter([{type:"average"}]);$.v_hip=o=new THREE.Vector3});function e(e){var r=e.keypoints[5];var _=e.keypoints[6];var l=e.keypoints[11];var d=e.keypoints[12];if(r.score<=0||_.score<=0)return;var c=e.keypoints3D[5];var u=e.keypoints3D[6];g=[{point2D:[{position:new THREE.Vector3},{position:new THREE.Vector3}],data3D:{length:0,z_diff:0}}];const p=ne.spine_length_ref;let h=1;if(l.score>0&&d.score>0){let e=MMD_SA._v3a.addVectors(c,u).multiplyScalar(.5);let t=e.length();let i=MMD_SA.TEMP_v3.set(0,1,0);i.y*=-1;let n=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZXY").x;h=Math.min(Math.max((Math.abs(n)-Math.PI/4)/(Math.PI/4),0),1);let o=P.copy(l.position).add(d.position).multiplyScalar(.5);let a=I.copy(r.position).add(_.position).multiplyScalar(.5);let s=o.distanceTo(a);a.copy(o);a.y=a.y-s/Math.abs(Math.cos(n));g[0].point2D[0].position.copy(a);g[0].point2D[1].position.copy(o);g[0].data3D.length=p*(t*2)}if(h){let e=MMD_SA._v3b.copy(c).sub(u);let t=e.length();let i=MMD_SA.TEMP_v3.set(1,0,0);let n=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZYX").y;let o=I.copy(r.position).add(_.position).multiplyScalar(.5);let a=o.clone();let s=P.copy(r.position).distanceTo(_.position);o.y=o.y+s*1.5/Math.abs(Math.cos(n));if(o.y>te.video_canvas.height){a.y=Math.max(a.y-(o.y-te.video_canvas.height),0);o.y=te.video_canvas.height}g[0].point2D[0].position.lerp(a,h);g[0].point2D[1].position.lerp(o,h);g[0].data3D.length=g[0].data3D.length*(1-h)+p*(t*3)*h}}function t(){if(!g.length)return;var d=System._browser.camera;var c=d.video_canvas.width;var u=d.video_canvas.height;var p=H;var h=[];const e=c/u;const t=SL.width/SL.height;const m=e<t?e/t:1;const f=t<e?t/e:1;g.forEach(e=>{p.set((e.point2D[0].position.x/c*2-1)*m,(-(e.point2D[0].position.y/u)*2+1)*f,.5);var t=MMD_SA._v3a.copy(p.unproject(d._camera_reset).sub(d._camera_reset.position).normalize());p.set((e.point2D[1].position.x/c*2-1)*m,(-(e.point2D[1].position.y/u)*2+1)*f,.5);var i=MMD_SA._v3b.copy(p.unproject(d._camera_reset).sub(d._camera_reset.position).normalize());var n,o;n=e.data3D.length;o=e.data3D.z_diff;let a=Math.sqrt(Math.pow(t.x-i.x*t.z/i.z,2)+Math.pow(t.y-i.y*t.z/i.z,2)+0);let s=t.x-i.x*t.z/i.z+(t.y-i.y*t.z/i.z)+0;let r=s/a;let _=1;let l=(Math.sqrt(n*n+1)-1)/(a/r);t.multiplyScalar(l);h.push({z:-t.z*1.5,id:e.id})});h.sort((e,t)=>t.z-e.z);var i=h[0].z;this.z=i;z=n.filter(i);this.z_smoothed=z;g=[]}function i(e){if(MMD_SA.WebXR.session){o.set(0,0,0);return}o.copy(e).unproject(te._camera_reset).sub(te._camera_reset.position).normalize();if(me)$.estimate();const t=te._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;let i=t;if(me&&$.z)i=$.z_smoothed||$.z;o.multiplyScalar(-i/o.z)}return{prepare:e,estimate:t,get_hip_center:i}}();var fe=function(){function k(e,t){let i=Z[t];e.premultiply(i.axis_rot).multiply(i.axis_rot_inv);e.multiplyQuaternions(i.axis_rot_offset_inv,e)}function w(e,t){if(ne.IK_disabled_check(t))return;var i=e.bones_by_name[t];var n=this.skin[t];var o=t.charAt(0);var a=MMD_SA.TEMP_v3.fromArray(e.bones_by_name[o+"足"].pmxBone.origin);var s=MMD_SA.get_bone_position(e,o+"足","全ての親").sub(a);i.position.add(s);e.bones_by_name[o+"ひざ"].quaternion.set(0,0,0,1);if(y.active){if(MMD_SA_options.user_camera.ML_models.pose.use_legIK){const r=MMD_SA.TEMP_v3.copy(i.position);r.y-=i.pmxBone.origin[1];y.set_boneKey(t,r,n[0].rot?i.quaternion:null,true);y.set_boneKey(o+"足",null,e.bones_by_name[o+"足"].quaternion,true)}else{window.addEventListener("SA_MMD_model"+e._model_index+"_process_bones_after_IK",()=>{y.set_boneKey(o+"足",null,e.bones_by_name[o+"足"].quaternion,true);y.set_boneKey(o+"ひざ",null,e.bones_by_name[o+"ひざ"].quaternion,true)},{once:true})}}i.quaternion.set(0,0,0,1)}function h(e,t){if(ne.IK_disabled_check(t))return;var i=e.bones_by_name[t];var n=this.skin[t];var o=Math.max(Math.min(n[0].t_delta/n[0].t_delta_frame,1),0);var a=t.charAt(0);e.bones_by_name[a+"腕+"].quaternion.copy(e.bones_by_name[a+"腕"].quaternion);e.bones_by_name[a+"腕"].quaternion.set(0,0,0,1);e.bones_by_name[a+"ひじ"].quaternion.set(0,0,0,1);var s=H.copy(n[1].pos).lerp(n[0].pos,o);if(!n[0]._IK_absolute){s.applyQuaternion(u)}s.x+=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]*(a=="左"?1:-1);s.y+=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1];i.position.add(s)}function E(e,t){if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only)return;var i=e.bones_by_name;var n=i[t].quaternion;n.multiplyQuaternions(u,n)}function S(o,e){var t=o.bones_by_name[e];var i=this.skin[e];var n=Math.max(Math.min(i[0].t_delta/i[0].t_delta_frame,1),0);const a=H.copy($.v_hip);if(MMD_SA.WebXR.session){a.set(0,0,0)}else{const c=te._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;a.z=MMD_SA_options.user_camera.ML_models.pose.estimate_z_depth===false?0:c+a.z;if(i[0]._v_hip_offset)a.add(i[0]._v_hip_offset)}if(MMD_SA_options.user_camera.ML_models.pose.position_offset)a.add(MMD_SA_options.user_camera.ML_models.pose.position_offset);i[0].pos.copy(a);var s=(new THREE.Vector3).copy(i[1].pos).lerp(i[0].pos,n);var r=MMD_SA.get_bone_position(o,"左足","全ての親");var _=MMD_SA.get_bone_position(o,"右足","全ての親");var l=MMD_SA.TEMP_v3.copy(r).add(_).multiplyScalar(.5).sub(MMD_SA_options.model_para_obj.hip_center).negate();if(ne.auto_grounding){let e=MMD_SA.get_bone_position(o,"左足首","全ての親");let t=MMD_SA.get_bone_position(o,"右足首","全ての親");let i=e.y<t.y?e:t;let n=MMD_SA_options.model_para_obj.left_heel_height+.2-i.y;n-=s.y;l.y=n}s.add(l);s.x*=te.x_flipped?-1:1;if(i[0].absolute)t.position.set(0,0,0);t.position.add(s);y.active&&y.set_boneKey(e,s,null,true);var d=R.distanceTo(s)-5;if(d>0){THREE.MMD.getModels()[o._model_index].resetPhysics(15+d*2)}R.copy(s)}var m=function(){let c={};window.addEventListener("jThree_ready",()=>{c["左"]=new System._browser.data_filter([{type:"average",para:[200,"quaternion"]}]);c["右"]=new System._browser.data_filter([{type:"average",para:[200,"quaternion"]}])});return function(e,t){var i=THREE.MMD.getModels()[e._model_index];var n=e.bones_by_name[t];var o=t.charAt(0);var a=n.quaternion;a.fromArray(c[o].filter(a.toArray()));const s="YXZ";const r=MMD_SA.TEMP_v3.setEulerFromQuaternion(a,s);r.fromArray(r.toArray().map(e=>{const t=Math.sign(e);e=Math.abs(e);if(e>Math.PI/4){e=(e-Math.PI/4)/(Math.PI*3/4);e=Math.PI/4+e*e*Math.PI/4}return t*e}));const _=r.y;r.y=0;a.setFromEuler(r,s);this._rot_=a.clone();this._rot_y=_;const l=MMD_SA.get_bone_position(e,o+"足",e).sub(MMD_SA.get_bone_position(e,t,e)).normalize().applyQuaternion(MMD_SA.get_bone_rotation_parent(e,o+"足",e).conjugate());const d=MMD_SA.TEMP_q.setFromAxisAngle(l,_);e.bones_by_name[o+"足"].quaternion.premultiply(d);e.bones_by_name[o+"足D"]&&e.bones_by_name[o+"足D"].quaternion.premultiply(d)}}();var T=function(){let g={};window.addEventListener("jThree_ready",()=>{g["左"]=new System._browser.data_filter([{type:"average",para:[200,"quaternion"]}]);g["右"]=new System._browser.data_filter([{type:"average",para:[200,"quaternion"]}])});return function(e,t){var i=THREE.MMD.getModels()[e._model_index];var n=e.bones_by_name[t];var o=t.charAt(0);var a,s,r,_;var l=e.bones_by_name[o+"手捩"];var d;var c=this.skin[t];var u=Math.max(Math.min(c[0].t_delta/c[0].t_delta_frame,1),0);s=q.set(0,0,0,1);if(l){if(l.quaternion.x||l.quaternion.y||l.quaternion.z){l.quaternion.conjugate();i._update_IK_and_AddTrans(false,o+"手捩")}l.quaternion.set(0,0,0,1)}var p=c[0].rot_parent;if(!p){if(MMD_SA.THREEX.enabled&&!ne.IK_disabled_check(o+"腕ＩＫ")){for(const t of[o+"腕",o+"ひじ"]){const m=e.bones_by_name[t].quaternion;const s=m.toArray();MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(t,s);m.fromArray(s)}i._update_timestamp_[o+"腕ＩＫ"]=RAF_timestamp}p=MMD_SA.get_bone_rotation_parent(e,o+"手首",e);p.conjugate()}c[0]._rot_parent=p;s.multiply(c[0].no_blending?c[0].rot:MMD_SA.TEMP_q.copy(c[1].rot).slerp(c[0].rot,u));var h=o=="左"?1:-1;s.multiplyQuaternions(p,s).multiply(O[h]);s.fromArray(g[o].filter(s.toArray(),System._browser.camera.video_timestamp));n.quaternion.copy(s);if(l){r=l.pmxBone.fixedAxis;if(r){r=MMD_SA._v3a.fromArray(r);if(MMD_SA.THREEX.enabled)r.setY(0).setZ(0).normalize();const f=n.quaternion.toAxisAngle();let e=H.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromAxisAngle(f[0].applyQuaternion(MMD_SA._q1.copy(Z[o+"腕"].axis_rot).conjugate()),f[1]),"XZY").x*-h;if(e*h<-Math.PI/1.5)e+=Math.PI*2*h;_=-e*.5;d=K.setFromAxisAngle(r,_);this.skin[o+"手捩"][0].rot.copy(d);n.quaternion.multiplyQuaternions(d.conjugate(),n.quaternion)}}if(y.active){y.set_boneKey(t,null,n.quaternion,true);if(!ne.IK_disabled_check(o+"腕ＩＫ")){y.set_boneKey(o+"腕",null,e.bones_by_name[o+"腕"].quaternion,true);y.set_boneKey(o+"ひじ",null,e.bones_by_name[o+"ひじ"].quaternion,true)}}}}();var A=0,D=0,C=0,j=0;return function(e){var o=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof o==="string"){if(o=="OK"){x=true}else{DEBUG_show(o,2);System._browser.console.log(o)}}else{te._needs_RAF=true;ne._bb=null;const a=ve[ne.use_holistic?1:0];let e;if(ne.enabled&&!a.poseNet){e=true;a.poseNet=true}if(B.enabled&&!a.handpose){e=true;a.handpose=true}if(e)DEBUG_show("Pose ML ready",2);oe=(ie.enabled?"\n":"")+te.video_canvas.width+"x"+te.video_canvas.height+"("+ne.camera_video_frame_id+")\n";let t=te.video_timestamp;let i=0;if(j){i=Math.max(Math.min(t-j,1e3),10);C+=i;if(++D>=20){A=1e3/(C/D);D=C=0}}j=t;ne._t=o._t;se.t_delta=A&&1e3/A||i||o.fps&&1e3/o.fps||o._t;if(ne.use_holistic){a.facemesh=true;if(!o.facemesh){ie.data_detected=0}}let x=[];let P=[];let I=te.x_flipped?1:-1;let n=THREE.MMD.getModels()[0];let r=n.mesh.bones_by_name;const _=MMD_SA.MMD.motionManager.para_SA;const F=_.motion_tracking&&_.motion_tracking.hand_as_foot;let O;if(ne.enabled){if(o.posenet&&o.posenet.score>.3){ne.data_detected++;if(ne.data_detected_stable){if(N){N=false;n.mesh.visible=true}O=o.posenet;let D=ne.use_3D_pose;if(le){O._keypoints=O.keypoints;O._keypoints3D=O.keypoints3D;let n=[];let o=[];ce.forEach((e,t)=>{let i=O.keypoints[e];i.part=Y[t];n.push(i);i=O.keypoints3D[e];i.part=Y[t];o.push(i)});O.keypoints=n;O.keypoints3D=o}const l=_e?.3:!de?.5:.1;O.keypoints.forEach(e=>{e.score-=l});if(D){O._keypoints3D.forEach(e=>{e.score-=l})}if(de){let i={};O.keypoints.forEach(e=>{i[e.part]=e});let n=[];for(let t=0;t<=16;t++){let e=O.keypoints[t];if(!e)n.push(ue[t]);else if(e.part!=Y[t])n.push(i[Y[t]]||ue[t]);else n.push(e)}O.keypoints=n}let e=O._keypoints||O.keypoints;let t=e.map(e=>e.position.x);let i=e.map(e=>e.position.y);const d=[Math.min(...i),Math.max(...t),Math.max(...i),Math.min(...t)];e=O.keypoints.slice(0,5);t=e.map(e=>e.position.x);i=e.map(e=>e.position.y);const c=[Math.min(...i),Math.max(...t),Math.max(...i),Math.min(...t)];const u=Math.max(c[1]-c[3],c[2]-c[0])/2;d[0]=Math.min(d[0],c[0]-u);d[1]=Math.max(d[1],c[1]+u);d[2]=Math.max(d[2],c[2]-u);d[3]=Math.min(d[3],c[3]-u);ne._bb=d;if(!ie.head_pose_enabled){ie.bb_center[0]=O.keypoints[0].position.x/te.video_canvas.width;ie.bb_center[1]=O.keypoints[0].position.y/te.video_canvas.height}if(D){let e=O._keypoints3D[0];let t=O._keypoints3D[3];let i=O._keypoints3D[6];let n=MMD_SA._v3a_.copy(e).sub(MMD_SA._v3b.copy(t).add(i).multiplyScalar(.5)).normalize();let o=MMD_SA._v3b_.copy(t).sub(MMD_SA._v3b.copy(i)).normalize();let a=MMD_SA.TEMP_v3.crossVectors(o,n).normalize();o.crossVectors(n,a);ae.set(o.x,o.y,o.z,0,n.x,n.y,n.z,0,a.x,a.y,a.z,0,0,0,0,1);V.setFromBasis(ae);let s=V.conjugate();s=s.clone().multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI/8,0,0)));if(!ie.head_pose_enabled){se.add("skin","首",{after_IK:true,rot:s,onProcessRotation:he});se.skin["首"][1]._rot_mixed&&se.skin["首"][1].rot.copy(se.skin["首"][1]._rot_mixed)}se.add("skin","首_DUMMY_",{rot:s,_rot_from_pose:s.clone(),onProcessRotation:he})}let a=O.keypoints[5];let s=O.keypoints[6];let p=new THREE.Quaternion;let h=_.motion_tracking_upper_body_only;if(h)oe+="\n(upper body only)\n";if(D&&me)$.prepare(O);let m=0;if(a.score>0&&s.score>0){let l,d;let c,u;let b;if(D){l=O.keypoints3D[5];d=O.keypoints3D[6];let n=O.keypoints3D[11];let o=O.keypoints3D[12];if(h||n.score<=0||o.score<=0){h=true}else{if(O.keypoints[11].position.y>te.video_canvas.height||O.keypoints[12].position.y>te.video_canvas.height){h=true}let e=MMD_SA._v3b.copy(n).sub(o).normalize();let t=MMD_SA.TEMP_v3.set(1,0,0);let i=U.setFromVectorSpherical(t,e);m=i.z;if(1||h)i.z=0;p.setFromEuler(i,"YZX")}let e=MMD_SA._v3a.addVectors(l,d).multiplyScalar(.5).normalize();e.applyQuaternion(MMD_SA.TEMP_q.copy(p).conjugate());let t=MMD_SA.TEMP_v3.set(0,1,0);t.y*=-1;c=(new THREE.Quaternion).setFromVectorSpherical(t,e);if(h){c.multiplyQuaternions(p,c);p.set(0,0,0,1)}let i=MMD_SA._v3b.copy(l).sub(d).normalize();i.applyQuaternion(MMD_SA.TEMP_q.multiplyQuaternions(p,c).conjugate());x_axis=MMD_SA.TEMP_v3.set(1,0,0);let a=U.setFromVectorSpherical(x_axis,i);u=(new THREE.Quaternion).setFromEuler(a,"YZX");let s=0;let r=a.y;let _=(s+r)%(Math.PI*2);if(_>Math.PI)_=Math.PI*2-_;else if(_<0&&_<-Math.PI)_+=Math.PI*2;c.multiply(q.setFromEuler(H.set(0,_/2-s,0),"YZX"));u.multiply(q.setFromEuler(H.set(0,_/2-r,0),"YZX"));se.add("skin","センター",{rot:p.clone(),priority:9});se.add("skin","上半身",{rot:c.clone()});se.add("skin","上半身2",{rot:u.clone()});b=q.copy(p).multiply(c).multiply(u).conjugate()}let w=Math.sqrt(Math.pow(a.position.x-s.position.x,2)+Math.pow(a.position.y-s.position.y,2));let S=0;if(!D){S=Math.asin((a.position.y-s.position.y)/w);S=Math.max(Math.min(S/(Math.PI/4),1),-1)*Math.PI/4*I}let e=I==1?[1,0]:[0,1];let t=[O.keypoints[9],O.keypoints[10]];let A=-1;if(!D&&t[0].score>0&&t[1].score>0&&Math.sqrt(Math.pow(t[0].position.x-t[1].position.x,2)+Math.pow(t[0].position.y-t[1].position.y,2))<(te.video_canvas.width+te.video_canvas.height)/2/25){A=t[1].score>t[0].score?0:1;if(t[A].score>.3)A=-1}w=ie.face_width*2||w;e.forEach(function(e,t){let o,a,s;let r;let _=t==0?"左":"右";let l=O.keypoints[5+e];let d=O.keypoints[7+e];let i=O.keypoints[9+e];se.add("skin",_+"肩",{absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,0,S),"YZX")});let c,u,p;if(D){c=O.keypoints3D[5+e];u=O.keypoints3D[7+e];p=O.keypoints3D[9+e]}let h=I*(e==0?-1:1);let m=!MMD_SA_options.user_camera.ML_models.pose.use_armIK&&!F;let f=false;let n,g,y;const v="YZX";if(D&&d.score>0){n=MMD_SA._v3b.copy(c).sub(u).normalize().applyQuaternion(b);g=MMD_SA.TEMP_v3.set(h,0,0);y=(new THREE.Quaternion).setFromUnitVectors(g,n)}if(i.score>0&&e!=A){P.push({pos:i.position,dir:e,d:_});if(D){let n;if(d.score>0&&(m||F)){let e=H.copy(u).sub(p).normalize().applyQuaternion(b).applyQuaternion(MMD_SA.TEMP_q.copy(y).conjugate());g=MMD_SA.TEMP_v3.set(h,0,0);n=(new THREE.Quaternion).setFromUnitVectors(g,e)}if(!m||d.score<=0){m=false;let e=MMD_SA._v3a.copy(c).sub(p);let t=d.score>0?MMD_SA.TEMP_v3.copy(c).distanceTo(u)+MMD_SA.TEMP_v3.copy(u).distanceTo(p):.5;let i=Math.min(e.length()/t,1);e.normalize().multiplyScalar(i*MMD_SA_options.model_para_obj.left_arm_length);o=e.x;a=e.y;s=r=e.z;if(y){let e;if(F){e=b.clone().conjugate().multiply(y).multiply(n).conjugate()}if(MMD_SA.THREEX.enabled){const M=y.toArray();MMD_SA.THREEX.utils.convert_T_pose_rotation_to_A_pose(_+"腕",M);y.fromArray(M)}else{k(y,_+"腕")}se.add("skin",_+"腕",{absolute:true,rot:y.slerp(MMD_SA.TEMP_q.set(0,0,0,1),.5),_rot_hand_parent:e})}}else{k(n,_+"ひじ");k(y,_+"腕");se.add("skin",_+"腕",{absolute:true,rot:y,priority:-1,onFinish:E});se.add("skin",_+"ひじ",{absolute:true,rot:n})}}else{f=true;let e=l.position.x-i.position.x;let t=l.position.y-i.position.y;o=e/w*MMD_SA_options.model_para_obj.shoulder_width*I;a=t/w*MMD_SA_options.model_para_obj.shoulder_width;if(d.score>0){let e=Math.min(Math.sqrt(Math.pow(i.position.x-d.position.x,2)+Math.pow(i.position.y-d.position.y,2))/w,1);let t=Math.min(Math.sqrt(Math.pow(l.position.x-d.position.x,2)+Math.pow(l.position.y-d.position.y,2))/w,1);r=(.25+(Math.sin(Math.acos(e))+Math.sin(Math.acos(t)))/2*.75)*MMD_SA_options.model_para_obj.left_arm_length}}}else{if(F){se.add("skin",_+"手首",{rot:new THREE.Quaternion});se.remove("skin",_+"足首")}if(d.score>0){if(D){if(!m){m=false;n=MMD_SA._v3a.copy(c).sub(u).normalize();n.multiplyScalar(MMD_SA_options.model_para_obj.left_arm_length);o=n.x*I;a=n.y;s=r=n.z}else{m=true;k(y,_+"腕");se.add("skin",_+"腕",{absolute:true,rot:y,priority:-1,onFinish:E})}}else{m=false;f=true;let e=l.position.x-d.position.x;let t=l.position.y-d.position.y;let i=Math.sqrt(e*e+t*t);let n=Math.asin(e/i);o=Math.sin(n)*MMD_SA_options.model_para_obj.left_arm_length*I;a=Math.cos(n)*MMD_SA_options.model_para_obj.left_arm_length*Math.sign(t)}}else{if(D)return;m=false;f=true;o=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*(_=="左"?1:-1)*.2;a=-Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-o*o)}}x.push({pos:{x:o,y:a,z:s,z_posenet:r},dir:e,d:_,IK_disabled:m,IK_absolute:f})})}else{h=true}if(D&&!h){if(!h){let e=te.video_canvas.width;let t=te.video_canvas.height;let i=new THREE.Vector3;let n=O.keypoints[11].position;let o=O.keypoints[12].position;const f=e/t;const g=SL.width/SL.height;const v=f<g?f/g:1;const M=g<f?g/f:1;i.set(((n.x+o.x)/2/e*2-1)*v,(-((n.y+o.y)/2/t)*2+1)*M,.5);$.get_hip_center(i)}let e=I==1?[1,0]:[0,1];let u=[];let t=[];let i=0;let n=[];e.forEach(function(h,e){let m=e==0?"左":"右";let f=O.keypoints3D[11+h];let g=O.keypoints3D[13+h];let y=O.keypoints3D[15+h];let v,M,b;if(y.score>0){v=MMD_SA._v3a.copy(f).sub(y);M=v.length();b=g.score>0?MMD_SA.TEMP_v3.copy(f).distanceTo(g)+MMD_SA.TEMP_v3.copy(g).distanceTo(y):.7;v.normalize().multiplyScalar(Math.min(M/b,1)*MMD_SA_options.model_para_obj.left_leg_length)}if(ne.leg_scale_adjustment&&y.score>0){let e=1;let t=1;let i,n,o;let a,s,r;const w=W.copy(f);const S=J.copy(y).sub(w);let _,l;if(g.score>0){const C=U.copy(g);const j=(C.x*S.x+C.y*S.y+C.z*S.z-(w.x*S.x+w.y*S.y+w.z*S.z))/S.lengthSq();_=H.set(w.x+S.x*j,w.y+S.y*j,w.z+S.z*j);l=C.sub(_);s=W.copy(f).sub(g).length();r=W.copy(f).sub(_).length();a=l.length()}else{s=b/2;r=Math.min(S.length()/2,s);a=Math.sqrt(s*s-r*r)}const A=a/b;const D=te.video_canvas.width;const k=te.video_canvas.height;const E=MMD_SA.TEMP_v3;const x=$.v_hip;const P=O.keypoints[11+h];const I=O.keypoints[15+h];const R=MMD_SA_options.model_para_obj.left_leg_length;const d=D/k;const c=SL.width/SL.height;const u=d<c?d/c:1;const p=c<d?c/d:1;E.set((P.position.x/D*2-1)*u,(-(P.position.y/k)*2+1)*p,.5);const F=MMD_SA._v3a_.copy(E.unproject(te._camera_reset).sub(te._camera_reset.position).normalize());F.multiplyScalar((x.z-f.z/b*R)/F.z);E.set((I.position.x/D*2-1)*u,(-(I.position.y/k)*2+1)*p,.5);const T=MMD_SA._v3b_.copy(E.unproject(te._camera_reset).sub(te._camera_reset.position).normalize());T.multiplyScalar((x.z-y.z/b*R)/T.z);M=v.length();e=Math.min(F.distanceTo(T),MMD_SA_options.model_para_obj.left_leg_length)/M;if(g.score>0){t=Math.sqrt((s*s-e*e*r*r)/(a*a))||0;if(t){}else{n=0;o=true;i=s/r}if(n!=null){oe+="\n"+m+":"+i+"(x"+n+")"+(o?"<>":"")+"\n";e=i;t=n}else oe+="\n"+m+":"+e+"(x"+t+")\n";if(e!=1){const z=W.copy(f).add(S.multiplyScalar(e)).sub(y);for(const B of[27,29,31]){const C=O._keypoints3D[B+h];Object.assign(C,MMD_SA.TEMP_v3.copy(C).add(z))}y=O.keypoints3D[15+h];const L=_.sub(f).multiplyScalar(e).add(f).add(l.multiplyScalar(t));g=O.keypoints3D[13+h]=Object.assign(g,L);v.multiplyScalar(e)}}else{v.multiplyScalar(e);oe+="\n"+m+"(IK):"+e+"(x"+t+")\n"}}let o,a;let t;if(g.score>0){t=MMD_SA._v3b.copy(f).sub(g).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(p).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;a=U.setFromVectorSpherical(e,t);o=(new THREE.Quaternion).setFromEuler(a,"XZY");i+=a.x}let s=!MMD_SA_options.user_camera.ML_models.pose.use_legIK;if(y.score>0){let i,n;if(g.score>0){i=H.copy(g).sub(y).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(p).conjugate());n=W.copy(i).applyQuaternion(MMD_SA.TEMP_q.copy(o).conjugate());n.z=Math.max(-n.z,0);n.x*=-1;let e=n.normalize().toSphericalCoords();let t=Math.sqrt(Math.min((Math.PI-e[2])/(Math.PI/2),1));a.y=e[1]*t;o.setFromEuler(a,"XZY")}if(!s||g.score<=0){ne.enable_IK(m+"足ＩＫ",true);u.push({pos:v.clone(),rot:[o],dir:h,d:m})}else{n=W.copy(i).applyQuaternion(MMD_SA.TEMP_q.copy(o).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;let t=(new THREE.Quaternion).setFromVectorSpherical(e,n);ne.enable_IK(m+"足ＩＫ",false);u.push({rot:[o,t],dir:h,d:m})}const r=O._keypoints3D[29+h];const _=O._keypoints3D[31+h];if(r.score>0&&_.score>0){let e=MMD_SA._v3a_.copy(r).sub(y).normalize();let t=MMD_SA._v3b_.copy(r).sub(_).normalize();let i=H.crossVectors(e,t).normalize();e.crossVectors(t,i);ae.set(i.x,i.y,i.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,0,0,0,0,1);V.setFromBasis(ae);let n=V.conjugate();n=n.clone().multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-Math.PI/8,0,0)));const l=MMD_SA.TEMP_v3.setEulerFromQuaternion(p,"YZX");const d=Math.abs(l.y)%Math.PI;let o=d>Math.PI/2?1-(d-Math.PI/2)/(Math.PI/2):1;if(MMD_SA_options.user_camera.ML_models.pose.use_legIK){const c=n.clone();if(o<1){l.x=l.z=0;c.slerp(K.setFromEuler(l,"YZX"),1-o)}u[u.length-1].rot[2]=c}se.add("skin",m+"足首",{after_IK:true,absoulte:true,parent_based:true,motion_recorder_disabled:MMD_SA_options.user_camera.ML_models.pose.use_legIK,rot:n,ratio:o})}}else if(g.score>0){}});let o=0;n.forEach(e=>{const t=e.y*(1-e.scale);if(t>0){o=Math.max(t,o)}else if(n.length>1){o=Math.max(t,o||t)}});if(o){$.v_hip.y+=o;oe+="\nleg_offset_y:"+o+"\n"}i*=.5*.5;let a=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(i,0,m),"XZY");se.add("skin","下半身",{absolute:true,rot:a.clone()});if(!h){se.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:S})}a.conjugate();u.forEach(e=>{var t=e.d;if(e.rot[0]){e.rot[0].multiplyQuaternions(a,e.rot[0]);se.add("skin",t+"足",{absolute:true,rot:e.rot[0]})}if(e.pos){e.pos.y+=MMD_SA_options.model_para_obj.left_leg_length;e.pos.y+=r[t+"足ＩＫ"].pmxBone.origin[1];const i=e.rot[2]||se.skin[t+"足ＩＫ"]&&se.skin[t+"足ＩＫ"][0].rot;se.add("skin",t+"足ＩＫ",{absolute:true,pos:e.pos,rot:i,priority:999,onFinish:w})}else{se.add("skin",t+"ひざ",{absolute:true,rot:e.rot[1]})}})}else{if(_.motion_tracking_upper_body_only){se.add("skin","全ての親",{is_dummy:true,pos:true,after_IK:true,priority:999})}else if(D&&a.score>0&&s.score>0&&te.video_canvas.width){let e=te.video_canvas.width;let t=te.video_canvas.height;let i=new THREE.Vector3;let n=e/t;let o=SL.width/SL.height;i.set(((a.position.x+s.position.x)/2/e*2-1)*(n<o?n/o:1),(-((a.position.y+s.position.y)/2/t)*2+1)*(o<n?o/n:1),.5);$.get_hip_center(i);const b=ne.spine_length_ref;se.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,_v_hip_offset:{x:0,y:-b,z:0},onProcessPosition:S})}if(!F){se.add("skin","下半身",{is_dummy:true,rot:true});["左","右"].forEach(e=>{se.add("skin",e+"足ＩＫ",{is_dummy:true,pos:true,priority:999});se.add("skin",e+"足",{is_dummy:true,rot:true});se.add("skin",e+"ひざ",{is_dummy:true,rot:true});se.add("skin",e+"足首",{is_dummy:true,after_IK:true,rot:true})})}}}}else{ne.data_detected=0}}if(ne.enabled&&!ne.data_detected_stable&&!N){N=true;if(!_.motion_tracking_upper_body_only)n.mesh.visible=false}let R;let y=[];if(B.enabled&&o.handpose&&o.handpose.length&&P.length){let i;if(X){i=I?{Left:{dir:1,list:[]},Right:{dir:0,list:[]}}:{Left:{dir:0,list:[]},Right:{dir:1,list:[]}};o.handpose.forEach(e=>{if(e.label)i[e.label].list.push(e)})}const s=X?1:2;o.handpose.forEach(t=>{t._offset={};R=t.annotations;if(s>1){for(let e in R){R[e].forEach(e=>{e[2]*=s})}}let i=MMD_SA.TEMP_v3.fromArray(R.palm[0]);P.forEach(e=>{t._offset[e.dir]=Math.sqrt(Math.pow(e.pos.x-i.x,2)+Math.pow(e.pos.y-i.y,2))})});P.forEach((u,e)=>{var p=u.dir;var t=i?i[i.Left.dir==p?"Left":"Right"].list:o.handpose;if(!t.length)t=o.handpose;let h=e==0?o.handpose.length==1&&P.length>1?t[0]._offset[p]<t[0]._offset[p==0?1:0]&&t[0]:t.sort((e,t)=>e._offset[p]-t._offset[p])[0]:t.find(e=>!e._used);if(h&&h._offset[p]<Math.max(te.video_canvas.width,te.video_canvas.height)/6){h._used=true;R=h.annotations;let e=x.find(e=>e.dir==p);let t=MMD_SA._v3a.fromArray(R.palm[0]).distanceTo(MMD_SA._v3b.fromArray(R.middle[0]))/MMD_SA._v3a.fromArray(R.index[0]).distanceTo(MMD_SA._v3b.fromArray(R.pinky[0]));t=t<1?1/t:t>2?t/2:0;if(t){for(const g of["thumb","index","middle","ring","pinky","palm"]){R[g].forEach(e=>{e[2]*=t})}}let S=u.d;h._d=S;y.push(S+"手");let i=p==1?[R.index[0],R.ring[0]]:[R.ring[0],R.index[0]];let n,o,a;let s=MMD_SA._v3a_.fromArray(R.palm[0]).sub(MMD_SA._v3b.fromArray(R.middle[0])).normalize();s.x=s.x*I;let r=MMD_SA._v3b_.fromArray(i[0]).sub(MMD_SA._v3b.fromArray(i[1])).normalize();r.z=r.z*I;r.y=r.y*I;let _=MMD_SA.TEMP_v3.crossVectors(r,s).normalize();r.crossVectors(s,_);ae.set(r.x,r.y,r.z,0,s.x,s.y,s.z,0,_.x,_.y,_.z,0,0,0,0,1);V.setFromBasis(ae);let l=new THREE.Quaternion;l.copy(V).conjugate();se.add("skin",S+"手首",{after_IK:true,rot:l,onProcessRotation:T});se.add("skin",S+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion});if(F)return;const m=MMD_SA.TEMP_v3.setEulerFromQuaternion(l,"YXZ").y;const f=1;const k=(Math.abs(m)<Math.PI/6?1:Math.abs(Math.abs(m)-Math.PI)<Math.PI/6?-1:0)*f;const E=Math.max((Math.abs(m)-Math.PI/2)*f,0)/(Math.PI/2);let d=new THREE.Quaternion;let c=MMD_SA_options.model_para_obj.finger_base;let A=q.copy(V);A.x*=-1;A.z*=-1;let D=S=="左"?1:-1;ee.forEach((h,m)=>{let f=c[(I==1?S:S=="左"?"右":"左")+m];let g=f.base_index+(m==0?0:-1);let y=R[re[m]];let v=K.copy(A);const M="XZY";if(k&&m>0){const e=Math.max(MMD_SA._v3a.fromArray(y[2]).sub(MMD_SA._v3b.fromArray(y[1])).length()*1.2,MMD_SA._v3a.fromArray(R.palm[0]).sub(MMD_SA._v3b.fromArray(y[0])).length()*(k==1?.2:.3));const b=MMD_SA._v3a.fromArray(y[1]).sub(MMD_SA._v3b.fromArray(y[0]));if(e/b.length()>1){const t=-k*Math.sqrt(e*e-(b.x*b.x+b.y*b.y))-b.z;for(let e=1;e<3;e++)y[e][2]+=t}}for(let p=g;p<3;p++){let e=S+h+"指"+Q[f.base_index+(p-g)];let t=MMD_SA._v3a.fromArray(y[p+0]);let i=MMD_SA._v3b.fromArray(y[p+1]);let n=MMD_SA.TEMP_v3.fromArray(p==g?R.palm[0]:y[p-1]);t.y=-t.y;i.y=-i.y;n.y=-n.y;let o=MMD_SA._v3a_.copy(t).sub(n);let a=MMD_SA._v3b_.copy(i).sub(t);o.normalize();a.normalize();let s,r;let _;o.applyQuaternion(v);a.applyQuaternion(v);if(p==g){let e=MMD_SA.TEMP_q.set(0,0,0,1);e.setFromVectorSpherical(MMD_SA.TEMP_v3.set(0,1,0),o).conjugate();a.applyQuaternion(e);v.multiplyQuaternions(e,v)}let l=MMD_SA._q1.set(0,0,0,1);let d=MMD_SA._q2.set(0,0,0,1);o.set(0,1,0);_=U.setFromVectorSpherical(o,a);l.setFromEuler(_,M);d.copy(l);if(Math.abs(_.z)>Math.PI/(m==0?1.1:2.5)||_.x>Math.PI/(m==0?1.1:3)){_.set(-Math.abs(o.angleTo(a)),0,0)}if(m==0&&p>g){}if(_.x>0){_.x*=m==0?0:p>g?0:.75}else{_.x=Math.max(_.x,-Math.PI/(m==0?1.25:2))}if(m==0||p==g){_.z+=(m-2)/2*Math.PI/8*D*(m>0?1:.5);_.z*=m>0?Math.min(Math.max(Math.PI/2-Math.abs(_.x),0)/(Math.PI/2.5),1):1}else{_.z=0}if(E&&m>0&&p==g){const b=MMD_SA._v3a.fromArray(y[p+1]);b.y*=-1;b.applyQuaternion(A);const w=MMD_SA._v3b.fromArray(y[p+3]);w.y*=-1;w.applyQuaternion(A);if(b.y>w.y){_.x-=Math.abs(_.z)*E;_.z*=1-E}}_.y=0;if(m==0)v.multiplyQuaternions(l.conjugate(),v);l.setFromEuler(_,M);if(m>0){v.multiplyQuaternions(l.conjugate(),v);l.conjugate()}let c=e;let u=l.toAxisAngle();r=u[0];s=u[1];r.z*=-1;r.applyEuler(H.set(MMD_SA.THREEX.enabled?Math.PI/2:0,-Math.PI/2*D,0),"YXZ");if(MMD_SA.THREEX.enabled){l.setFromAxisAngle(r,s)}else{r.applyQuaternion(Z[c].axis_rot);l.setFromAxisAngle(r,s)}se.add("skin",e,{absolute:true,rot:l.clone()})}})}})}else if(!B.enabled&&O&&ne.use_3D_pose){let e=I==1?[1,0]:[0,1];e.forEach(function(e,t){let i=t==0?"左":"右";let n=O._keypoints3D[15+e];let o=O._keypoints3D[17+e];let a=O._keypoints3D[19+e];if(n.score<=0||o.score<=0||a.score<=0)return;let s=e==1?[a,o]:[o,a];let r=MMD_SA._v3a_.copy(n).sub(MMD_SA._v3b.copy(o).add(a).multiplyScalar(.5)).normalize();r.x=r.x*I;let _=MMD_SA._v3b_.copy(s[0]).sub(s[1]).normalize();_.z=_.z*I;_.y=_.y*I;let l=MMD_SA.TEMP_v3.crossVectors(_,r).normalize();_.crossVectors(r,l);ae.set(_.x,_.y,_.z,0,r.x,r.y,r.z,0,l.x,l.y,l.z,0,0,0,0,1);V.setFromBasis(ae);let d=new THREE.Quaternion;d.copy(V).conjugate();se.add("skin",i+"手首",{after_IK:true,rot:d,onProcessRotation:T});se.add("skin",i+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})})}x.forEach(function(e){var t=e.d;if(F){if(e.IK_disabled)return;ne.enable_IK(t+"足ＩＫ",true);if(se.skin[t+"手首"]&&se.skin[t+"腕"]&&se.skin[t+"手首"][0].timestamp==se.skin[t+"腕"][0].timestamp){let e;if(e){}else{const o=se.skin[t+"手首"][0].rot.multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI,0,0)));const a=o.toAxisAngle();const s=a[0].applyEuler(MMD_SA.TEMP_v3.set(-Math.PI/2,0,0));o.setFromAxisAngle(s,a[1]);se.add("skin",t+"足首",{after_IK:true,rot:o,parent_based:true,onFinish:m})}}else{const r=se.skin[t+"足首"];if(r){r[0].rot_parent=r[0]._rot_parent}}se.remove("skin",t+"手首");se.remove("skin",t+"腕");se.remove("skin",t+"ひじ");se.remove("skin",t+"手捩");se.remove("skin",t+"腕ＩＫ");const n=(new THREE.Vector3).copy(e.pos);if(F.transform_position)F.transform_position(n);se.add("skin",t+"足ＩＫ",{speed_limit:10,priority:999,pos:n});return}ne.enable_IK(t+"腕ＩＫ",!e.IK_disabled);if(!e.IK_disabled){if(e.pos.z==null)e.pos.z=e.pos.z_posenet||(ne.use_3D_pose?0:MMD_SA_options.model_para_obj.left_arm_length*.2);se.add("skin",t+"腕ＩＫ",{speed_limit:10,priority:999,pos:(new THREE.Vector3).copy(e.pos),_IK_absolute:e.IK_absolute,onProcessPosition:h})}var i=se.skin[t+"手首"];if(i){i[0].rot_parent=i[0]._rot_parent}});oe+=System._browser.motion_control.debug_msg;oe+=(oe?"/":"\n")+"P-FPS:"+Math.round(A)+"/"+Math.round(o.fps||0);System._browser.motion_control.process({posenet_data:o});if(te.motion_recorder.speed){const p=te.motion_recorder.stats;oe+="\n🔴 "+te.motion_recorder.time+"(-"+p[0]+"/"+p[1]+"-"+p[3]+"/"+p[2]+"-"+p[4]+")"}if(oe&&!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden&&(ne.use_holistic?!o.facemesh:!ie.enabled)){DEBUG_show((ne.use_holistic&&"(no facemesh data)\n"||"")+oe+"\n"+"FPS:"+EV_sync_update.fps_last)}if(o.facemesh){ie.worker_onmessage({data:o.facemesh})}if(O&&ie.worker_initialized){let e={posenet:O,w:te.video_canvas.width,h:te.video_canvas.height,flip_canvas:te.display_flipped};if(o.handpose&&o.handpose.length)e.handpose=o.handpose;if(o.facemesh)e.facemesh=o.facemesh.faces;if(ne.use_holistic||!ie.enabled){e.draw_canvas=true;if(self.FacemeshAT){e.canvas=te.video_canvas_facemesh}else if(!te.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){e.canvas=te.video_canvas_facemesh.transferControlToOffscreen();te.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}}L.postMessage(e,e.canvas?[e.canvas]:undefined)}G=0}ge()}}();function ge(e){async function t(){var e=ne.enabled&&ne.worker_initialized&&S&&!ne.busy&&D&&ne.camera_video_timestamp!=S;if(!e)return;G=RAF_timestamp;ne.camera_video_timestamp=S;ne.camera_video_frame_id=A;if(ne.use_holistic&&ie.blink_detection){MMD_SA_options.auto_blink=false}let t,i,n;t=te.video_canvas;i=t.width;n=t.height;let o=self.PoseAT?t:k?await createImageBitmap(t):t.getContext("2d").getImageData(0,0,i,n).data.buffer;let a={rgba:o,w:i,h:n,options:{use_holistic:ne.use_holistic,use_posenet:true,use_handpose:B.enabled,skip_hand_countdown_max:ne.skip_hand_countdown_max,timestamp:te.video_timestamp}};r.postMessage(a,[a.rgba]);a.rgba=o=undefined;a=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}}var ye=function(){var a,s;window.addEventListener("jThree_ready",e=>{a=new THREE.Vector3;s=new THREE.Quaternion});function r(i,n){var e,t;var o=i.bones_by_name;var a=o[n];var s=this.skin[n];if(ne.enabled&&!ne.data_detected_stable)return;if(s[0].info[1]=="facemesh"){if(!ie.data_detected)return}s[0].t_delta+=RAF_timestamp_delta;let r=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);if(s[0].rot){if(s[0].after_IK){t=!a._update_IK_and_AddTrans||a._update_IK_and_AddTrans.length;if(t){e=THREE.MMD.getModels()[i._model_index];if(a.quaternion.x||a.quaternion.y||a.quaternion.z){a.quaternion.conjugate();e._update_IK_and_AddTrans(false,n);a.quaternion.conjugate()}}}if(s[0].onProcessRotation){s[0].onProcessRotation.call(this,i,n)}else{let t=q.set(0,0,0,1);if(s[0].absolute){a.quaternion.set(0,0,0,1)}if(s[0].parent_based){let e=s[0].rot_parent;if(!e){e=MMD_SA.get_bone_rotation_parent(i,n,i).conjugate()}s[0]._rot_parent=e;t.copy(e)}t.multiply(s[0].no_blending?s[0].rot:MMD_SA.TEMP_q.copy(s[1].rot).slerp(s[0].rot,r));if(s[0].ratio<1)t.slerp(K.set(0,0,0,1),1-s[0].ratio);const _=MMD_SA_options.model_para_obj_all[i._model_index].skin_default[n];if(_&&_.rot_scale){if(typeof _.rot_scale=="number")_.rot_scale={x:_.rot_scale,y:_.rot_scale,z:_.rot_scale};t.setFromEuler(MMD_SA.TEMP_v3.setEulerFromQuaternion(t,"YXZ").multiply(_.rot_scale),"YXZ")}y.active&&!s[0].motion_recorder_disabled&&n.indexOf("ＩＫ")==-1&&y.set_boneKey(n,null,t,true);a.quaternion.multiply(t)}}if(s[0].pos){if(s[0].onProcessPosition){s[0].onProcessPosition.call(this,i,n)}else{if(s[0].absolute)a.position.set(0,0,0);const l=MMD_SA.TEMP_v3.copy(s[1].pos).lerp(s[0].pos,r);y.active&&!s[0].motion_recorder_disabled&&n.indexOf("ＩＫ")==-1&&y.set_boneKey(n,l,null,true);a.position.add(l)}if(s[0].speed_limit){if(!s[1].pos_last){s[1].pos_last=new THREE.Vector3}else{let e=MMD_SA.TEMP_v3.subVectors(a.position,s[1].pos_last);let t=e.length()/(Math.max(RAF_timestamp_delta,RAF_timestamp-s[1].timestamp)/1e3);if(t>s[0].speed_limit)a.position.copy(s[1].pos_last).add(e.multiplyScalar(s[0].speed_limit/t))}s[1].pos_last.copy(a.position);s[0].pos_last=s[1].pos_last}}s[0].onFinish&&s[0].onFinish.call(this,i,n);t&&e._update_IK_and_AddTrans(false,n)}function t(e){var t=e.detail.model;var n=t.mesh;var o=n.bones_by_name;var a=MMD_SA.motion[t.skin._motion_index].para_SA;u.copy(o["センター"].quaternion).multiply(o["上半身"].quaternion).multiply(o["上半身2"].quaternion).conjugate();ne.upper_body_rotation_limiter(u,F);var s=this.skin;var i=Object.keys(s).filter(e=>!s[e][0].after_IK).sort((e,t)=>{let i=s[e][0].priority||0;let n=s[t][0].priority||0;return i-n});i.forEach(e=>{let t=o[e];if(!t&&!/_DUMMY_/.test(e))return;var i=s[e][0].info[1];if((!i||/pose/.test(i))&&!a.motion_tracking_enabled)return;r.call(this,n,e)})}function i(e){var t=e.detail.model;var n=t.mesh;var o=MMD_SA.motion[t.skin._motion_index].para_SA;var a=this.skin;var i=Object.keys(a).filter(e=>a[e][0].after_IK).sort((e,t)=>{let i=a[e][0].priority||0;let n=a[t][0].priority||0;return i-n});i.forEach(e=>{let t=n.bones_by_name[e];if(!t&&!/_DUMMY_/.test(e))return;var i=a[e][0].info[1];if((!i||/pose/.test(i))&&!o.motion_tracking_enabled)return;r.call(this,n,e)})}function n(e){if(ne.enabled&&!ne.data_detected_stable)return;var _=e.detail.model;var l=_.mesh;var d=_.morph.targets;_.pmx.morphs.forEach(function(e){if(e.panel!=3)return;var t=e.name;if(!_.pmx.morphs_weight_by_name[t])return;var i=_.morph.target_index_by_name[t];if(i==null)return;var n=d[i];var o=n.keys[0];if(o.morph_type==1){l.morphTargetInfluences[i]=0}else{let e={name:t,weight:0,morph_type:o.morph_type,morph_index:o.morph_index};_.morph.onupdate(e,e,0,i)}});var c=MMD_SA_options.model_para_obj.facemesh_morph;var u=this.morph;var p={};var o=0;Object.keys(u).forEach(function(e){let t=u[e];if(t.disabled)return;t[0].t_delta+=RAF_timestamp_delta;let i=Math.max(Math.min(t[0].t_delta/t[0].t_delta_frame,1),0);let n=t[0].weight*i+t[1].weight*(1-i);p[e]=n;if(n)o++});Object.keys(p).forEach(function(t){let e=u[t];let i=p[t];if(i<0){y.active&&y.set_morphKey(t,0,true);switch(t){case"にやり":t="ω";break;case"上":t="下";break}i=-i}if(y.active){let e=t;if(t=="まばたきL")e="ウィンク";else if(t=="まばたきR")e="ウィンク右";y.set_morphKey(e,i,true)}let n=c[t];let o=n&&n.name||t;let a=_.morph.target_index_by_name[o];if(a==null)return;i*=n&&n.weight||1;let s=d[a];let r=s.keys[0];if(r.morph_type==1){l.morphTargetInfluences[a]=i}else{let e={name:o,weight:i,morph_type:r.morph_type,morph_index:r.morph_index};_.morph.onupdate(e,e,0,a)}})}function e(e,t,i){i.info=e.split("|");var n=i.info[0];var o=this[n][t];if(i.is_dummy){if(o&&o[0].is_dummy)return;i.no_blending=true;if(i.pos)i.pos=a;if(i.rot)i.rot=s}i.timestamp=RAF_timestamp;i.t_delta=0;i.t_delta_frame=this.t_delta*(t.indexOf("指")!=-1||t.indexOf("手首")!=-1?ne.skip_hand_countdown_max+1:1);i.t_delta_frame=Math.max(Math.min(i.t_delta_frame,200),16.6667);if(o){if(RAF_timestamp==o[0].timestamp){o[0]=Object.assign(o[0],i)}else{if(!i.no_blending&&!te.video.paused){let e=ne.use_3D_pose||i.info[1]=="facemesh"?.5+Math.max(Math.min((Math.max(i.t_delta_frame,RAF_timestamp-o[0].timestamp)-50)/150,1),0)*.5:1;if(i.pos&&o[0].pos){i.pos.lerp(o[0].pos,1-e)}if(i.rot&&o[0].rot){i.rot.slerp(o[0].rot,1-e)}if(i.weight!=null&&o[0].weight!=null){i.weight=i.weight*e+o[0].weight*(1-e)}}this[n][t]=[i,o[0]]}}else{this[n][t]=[i,i]}if(y.speed&&te.is_local_video&&y.speed<1)i.no_blending=true}function o(e,t){delete this[e][t]}function _(){this.skin={};this.morph={}}function l(){window.addEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones",this.process_bones);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}function d(){window.removeEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones",this.process_bones);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}var c=function(e){this.model_num=e;this.skin={};this.morph={};this.process_bones=t.bind(this);this.process_bones_after_IK=i.bind(this);this.process_morphs=n.bind(this)};c.prototype.add=e;c.prototype.remove=o;c.prototype.reset=_;c.prototype.add_events=l;c.prototype.remove_events=d;return c}();var se=new ye(0);var y=function(){function _(e,t,i,n){this.name=e;this.pos=t&&t.toArray()||[0,0,0];this.rot=i&&i.toArray()||[0,0,0,1];this.time=n;d[e].index=l.boneKeys.length}function s(e,t,i){this.name=e;this.weight=t;this.time=i;r[e].index=l.morphKeys.length}var l;var d,r;var c=0;var n=0;var u=0;var p=0;var o;var a=0;var h=0;const m=2;return{get active(){if(!h||te.video.paused)return false;if(o!=A){let e=1;if(o){e=this.get_frame(A)-this.get_frame(o);if(e<0||e>30)e=1;if(e>1){const t=e-1;n+=t;for(const i in d){d[i].frame_length+=t}for(const i in r){r[i].frame_length+=t}}}c+=e;o=A;a=RAF_timestamp}if(a==RAF_timestamp){return true}return false},get_frame:function(e){var t=e.split(":");return parseInt(t[0])*30+(parseInt(t[1])-1)},get frame_count(){return c},get stats(){return[n,l.boneKeys.length,l.morphKeys.length,u,p]},get time(){return Math.floor(c/30)+":"+(c%30+1)},get speed(){return h},set speed(e){h=e;if(e)this.start(e);else this.stop()},get vmd(){return h?null:l},set vmd(e){l=null},set_boneKey:function(e,t,i,n){let o=d[e];if(o==null){o=d[e]={frame_length:1};if(c>0)l.boneKeys.push(new _(e,null,null,0))}if(n&&se.skin[e]&&o.timestamp==se.skin[e][0].timestamp){o.frame_length++;u++;return}if(!t&&i&&o.is_rot_identity&&i.w==1){u++;return}o.is_rot_identity=i&&i.w==1;if(o.frame_count==c){const a=l.boneKeys[o.index];if(t)a.pos=t.toArray();if(i)a.rot=i.toArray()}else{if(o.index!=null&&e.indexOf("手")==-1&&e.indexOf("指")==-1){const a=l.boneKeys[o.index];const s=Math.round(c-a.time*30);if(s>o.frame_length){const r=new _(e,null,null,(c-1)/30);r.pos=a.pos;r.rot=a.rot;l.boneKeys.push(r);u--}}o.timestamp=se.skin[e]&&se.skin[e][0].timestamp||0;l.boneKeys.push(new _(e,t,i,c/30))}o.frame_length=1;o.frame_count=c},set_morphKey:function(e,t,i){let n=r[e];if(n==null){n=r[e]={frame_length:1};if(c>0)l.morphKeys.push(new s(e,0,0))}if(i&&se.morph[e]&&n.timestamp==se.morph[e][0].timestamp){n.frame_length++;p++;return}t=Math.round(t*20)/20;if(t==n.weight){p++;return}n.weight=t;if(n.frame_count==c){const o=l.morphKeys[n.index];o.weight=t}else{if(n.index!=null){const o=l.morphKeys[n.index];const a=Math.round(c-o.time*30);if(a<m){n.frame_length++;return}if(a>n.frame_length){l.morphKeys.push(new s(e,o.weight,(c-m)/30));p--}}n.timestamp=se.morph[e]&&se.morph[e][0].timestamp||0;l.morphKeys.push(new s(e,t,c/30))}n.frame_length=1;n.frame_count=c},start:function(e){h=e;o="";a=0;if(te.is_local_video){te.video.playbackRate=e;if(e<1)te.video.muted=true;te.video.loop=false;te.video.pause();MMD_SA.SpeechBubble.message(0,"Use the seek bar to go to the desired frame, press the play button and begin recording~!",5*1e3);C_media_control.style.visibility="inherit"}c=-1;n=0;u=0;p=0;d={};r={};l={boneKeys:[],morphKeys:[]}},stop:function(){h=0;if(te.is_local_video){te.video.playbackRate=1;te.video.muted=false;te.video.loop=true;te.video.pause();MMD_SA.SpeechBubble.message(0,"Motion recording has stopped. Double-click and you can export the motion to a file in VMD format~!",5*1e3)}else if(te.is_local_photo){l.boneKeys=l.boneKeys.filter(e=>e.time==0);l.morphKeys=l.morphKeys.filter(e=>e.time==0);l.boneKeys=l.boneKeys.concat(l.boneKeys.map(e=>{const t={name:e.name,pos:e.pos.slice(),rot:e.rot.slice(),time:60};return t}));l.morphKeys=l.morphKeys.concat(l.morphKeys.map(e=>{const t={name:e.name,weight:e.weight,time:60};return t}))}}}}();var ve=[{},{}];var Me=a.get("camera_hidden");var be;te={initialized:false,get ML_enabled(){return i},get ML_busy(){return ie.busy||ne.busy},get ML_fps(){return 1e3/(ne.enabled&&ne._t||ie.enabled&&ie._t||1e3)},get ML_warmed_up(){var e=ve[ne.use_holistic?1:0];var t=!ie.enabled||e.facemesh;var i=!ne.enabled||e.poseNet;var n=!B.enabled||e.handpose;return t&&i&&n},get target_devicePixelRatio(){return M||window.devicePixelRatio},set target_devicePixelRatio(e){M=e==window.devicePixelRatio?0:e},get double_flip_mode(){return s&&!te.mirror_3D},set double_flip_mode(e){s=e},get video_flipped(){return!i?t:!!t^!!te.double_flip_mode},set video_flipped(e){t=e;this.reset_video_canvas()},get display_flipped(){return te.mirror_3D?false:t!=te.video_flipped},get mirror_3D(){return!i||!MMD_SA_options.user_camera.mirror_3D?false:MMD_SA_options.user_camera.mirror_3D==1?te.visible:true},get x_flipped(){return te.double_flip_mode||te.mirror_3D},get hidden_enforced(){return Me||MMD_SA_options.user_camera.display.video.hidden||System._browser.overlay_mode>0||this.stream&&MMD_SA_options.user_camera.display.video.hidden_on_webcam},get display_floating(){return MMD_SA_options.user_camera.display.floating||be},set display_floating(e){be=e;if(this.video_host)this.video_host.style.zIndex=this.display_floating?2:0},get video_timestamp(){return te.video.currentTime==null?performance.now()/2:te.video.currentTime*1e3},get video_frame_id(){const e=this.video_timestamp/1e3;const t=Math.floor(e);return t+":"+Math.floor((e-t)*30+1)},get is_local_media(){return this.local_src&&!this.stream},get is_local_video(){return this.is_local_media&&this.video.currentTime!=null},get is_local_photo(){return this.is_local_media&&this.video.currentTime==null},motion_recorder:y,camera_permission_granted:false,camera_list:null,deviceId:null,start:async function(n){var e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;MMD_SA.reset_camera();this._camera_reset=MMD_SA._trackball_camera.object.clone();if(this.initialized){if(this.visible){this.hide();DEBUG_show("User camera:HIDDEN",2);return}}var o={video:this.set_constraints()};try{if(n){this.init_stream(n)}else{if(is_mobile){o.video.facingMode="user"}if(MMD_SA_options.Dungeon){MMD_SA_options.Dungeon.run_event([[{message:{content:"(finding camera...)"}},{goto_branch:0}]])}let t;if(!this.camera_permission_granted||is_mobile&&!this.stream){try{t=await navigator.mediaDevices.getUserMedia(o);this.camera_permission_granted=true;this.camera_list=null}catch(i){if(is_mobile||!MMD_SA_options.Dungeon)throw"(ERROR: Camera unavailable, using fallback video instead)";this.camera_list=[]}}if(!is_mobile){let e=this.camera_list;if(!e){e=await navigator.mediaDevices.enumerateDevices();e=e.filter(e=>e.kind=="videoinput");if(MMD_SA_options.user_camera.preference)e.sort((e,t)=>MMD_SA_options.user_camera.preference.label.test(e.label)&&-1||MMD_SA_options.user_camera.preference.label.test(e.label)&&1||0);this.camera_list=e}let i;if(MMD_SA_options.Dungeon){await new Promise(t=>{MMD_SA_options.Dungeon.run_event([[{message:{content:(e.length?"Choose a camera."+e.map((e,t)=>"\n"+(t+1)+". "+e.label).join(""):"No camera is available on this device. Drop a local media file as input instead.")+"\n"+(e.length+1)+". Local media file\n"+(e.length+2)+". Cancel",bubble_index:3,branch_list:e.map((e,t)=>{return{key:t+1,branch_index:t+1}}).concat([{key:Math.min(e.length+1,8),branch_index:Math.min(e.length+1,8)},{key:Math.min(e.length+2,9),branch_index:Math.min(e.length+2,9)}])}}]].concat(e.map(e=>[{func:()=>{o.video.deviceId=e.deviceId;t()},ended:true}]).slice(0,7).concat([[{func:()=>{if(te.local_src){n=te.local_src;t();return true}else{DEBUG_show("(No local media file found)",3);MMD_SA_options.Dungeon.run_event(null,0,0)}}}],[{func:()=>{i=true;t()},ended:true}]])))})}if(i){DEBUG_show("(Canceled)",2);return}if(!n&&o.video.deviceId!=this.deviceId){t=await navigator.mediaDevices.getUserMedia(o)}}else{if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2)}if(n){te.init_stream(n)}else if(t){te.init_stream(t);this.deviceId=o.video.deviceId}if(e&&e.dom_overlay)e.dom_overlay.use_dummy_webgl=true;DEBUG_show("(User camera:ON)",2)}if(!this.visible){this.show();DEBUG_show("User camera:VISIBLE",2)}}catch(i){if(MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode)MMD_SA_options.Dungeon.run_event({ended:true});te.init_stream();console.error(i);DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}},init_stream:function(e){if(!this.initialized){this.video=this._video=document.createElement("video");this.video.autoplay=true;let e;this.video_host=document.createElement("div");e=this.video_host.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=this.display_floating?2:0;e.visibility=System._browser.overlay_mode?"hidden":"inherit";e.display=System._browser.overlay_mode?"none":"block";SL_Host.appendChild(this.video_host);this.video_canvas=document.createElement("canvas");e=this.video_canvas.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas);this.video_canvas_bodyPix=document.createElement("canvas");e=this.video_canvas_bodyPix.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_bodyPix);this.video_canvas_face_detection=document.createElement("canvas");e=this.video_canvas_face_detection.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_face_detection);this.video_canvas_facemesh=document.createElement("canvas");e=this.video_canvas_facemesh.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_facemesh);window.addEventListener("resize",function(){te.video_track&&te.video_track.applyConstraints(te.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)})["catch"](function(e){DEBUG_show("ERROR:camera size failed to update")})})}this.initialized=true;this.show();if(this.stream){this.stream.getTracks().forEach(e=>{e.stop()});this.video.srcObject=this.stream=this.video_track=this.deviceId=null;console.log("(Previous stream stopped)")}if(!e||typeof e=="string"){b(e)}else{this.stream=e;this.video_id=e.id;this.video_track=e.getVideoTracks()[0];this.video.srcObject=e;console.log("(New stream started)");setTimeout(function(){let e=te.video_track.getCapabilities();System._browser.console.log(Object.entries(e).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"));let t=te.video_track.getSettings();System._browser.console.log(Object.entries(t).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"))},2e3)}if(ie.enabled)ie.reset_calibration()},get use_armIK(){return ne.enabled||B.enabled},bodyPix:function(){var n;var i=false;c={get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;const t=MMD_SA.THREEX.SL;if(i){MMD_SA._renderer.devicePixelRatio=1;MMD_SA._renderer.__resize(EV_width,EV_height);t.style.visibility="hidden"}else{MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);t.style.visibility="inherit";te.video_canvas_bodyPix.style.visibility="hidden"}},busy:0,mask:null,allPoses:null,use_bodySegmentation:true,load:async function(e){this.enabled=true;if(n)return;if(!this.mask){this.mask=document.createElement("canvas");d.load_face_cover()}if(this.use_bodySegmentation){const t=bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation;const i={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};n=await bodySegmentation.createSegmenter(t,i)}else{n=await bodyPix.load(e||(1||is_mobile)?{architecture:"MobileNetV1",outputStride:16,multiplier:.5,quantBytes:2}:{architecture:"ResNet50",outputStride:32,quantBytes:2})}console.log("bodyPix loaded")},segmentPerson:async function(e,t){await this.load();if(this.use_bodySegmentation){return await n.segmentPeople(e)}else{return await n.segmentPerson(e,t||{flipHorizontal:false,internalResolution:"medium",segmentationThreshold:.7})}},toMask:async function(e,t,i){const n=await this.segmentPerson(e,t);i=i||{foregroundColor:{r:0,g:0,b:0,a:255},backgroundColor:{r:0,g:0,b:0,a:0}};if(this.use_bodySegmentation){return await bodySegmentation.toBinaryMask(n,i.foregroundColor,i.backgroundColor)}else{this.allPoses=n.allPoses;return bodyPix.toMask(n,i.foregroundColor,i.backgroundColor)}},update_frame:async function(e=te.video_canvas,t,i,n){const o=MMD_SA.THREEX.SL;if(h.check_status()){te.video_canvas.style.visibility="inherit";te.video_canvas_bodyPix.style.visibility="hidden";o.style.visibility="inherit";return}if(this.busy)return;this.busy=RAF_timestamp;const a=await this.toMask(e,t,i);this.busy=0;if(!this.enabled)return;if(this.mask.width!=a.width||this.mask.height!=a.height){this.mask.width=a.width;this.mask.height=a.height}this.mask.getContext("2d").putImageData(a,0,0);const s=o.width;const r=o.height;if(te.video_canvas_bodyPix.width!=s||te.video_canvas_bodyPix.height!=r){te.video_canvas_bodyPix.width=s;te.video_canvas_bodyPix.height=r}const _=s/r/(e.width/e.height);const l=Math.round(s*Math.min(1/_,1));const d=Math.round(r*Math.min(_,1));const c=(s-l)/2;const u=(r-d)/2;const p=te.video_canvas_bodyPix.getContext("2d");p.globalCompositeOperation="copy";p.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)";p.drawImage(this.mask,0,0,a.width,a.height,c,u,l,d);p.globalCompositeOperation="source-out";p.filter="none";p.save();if(te.mirror_3D){p.translate(s,0);p.scale(-1,1)}p.drawImage(o,0,0);p.restore();p.globalCompositeOperation="destination-over";p.drawImage(e,0,0,e.width,e.height,c,u,l,d);te.video_canvas_bodyPix.style.visibility="inherit";o.style.visibility="hidden";this.update_frame_for_face_detection();h.check_status()},update_frame_for_face_detection:function(){let e=d.face_cover;if(!d.enabled||!e.complete)return;te.video_canvas_face_detection.style.visibility="hidden";let t=e.width;let s=e.height;let r=[];this.allPoses.forEach(function(e){let t=e.keypoints;let i=t.find(e=>e.part=="nose");if(!i)return;let n=t.find(e=>e.part=="leftEye");let o=t.find(e=>e.part=="rightEye");let a;if(n&&o){let e=n.position.x-o.position.x;let t=n.position.y-o.position.y;a=Math.sqrt(e*e+t*t)*4}else{a=s}r.push([i.position.y,i.position.x,Math.max(a,s/2),100])});this.allPoses=undefined;d.update_frame_local(te.video_canvas_bodyPix,r)}};return c}(),face_detection:function(){var t=false;function i(){d.initialized=true;if(!self.OffscreenCanvas)d.load_face_cover();_=new Worker("js/pico.worker.js");_.onmessage=function(e){var t=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof t==="string"){DEBUG_show(t,2);d.worker_initialized=true}else{te._needs_RAF=true;if(t._t)DEBUG_show(t._t);d.dets=t.dets;d.busy=0;te.video_canvas_face_detection.style.left=te.video_canvas.style.left;te.video_canvas_face_detection.style.top=te.video_canvas.style.top;if(!self.OffscreenCanvas){System._browser.on_animation_update.add(function(){d.update_frame_local(null,d.dets)},0,0)}}d.update_frame()}}d={initialized:false,worker_initialized:false,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){this.dets=null;if(!this.initialized)i()}else{if(te.initialized)te.video_canvas_face_detection.style.visibility="hidden"}},load_face_cover:function(){if(!this.face_cover){this.face_cover=new Image;this.face_cover.src="images/laughing_man_134x120.png"}},dets:null,camera_video_timestamp:0,update_frame:function(e){function t(){var e=d.enabled&&d.worker_initialized&&S&&!d.busy&&D&&d.camera_video_timestamp!=S;if(!e)return;d.busy=RAF_timestamp;d.camera_video_timestamp=S;d.camera_video_frame_id=A;te.video_canvas_face_detection.style.visibility="inherit";let t,i,n;t=te.video_canvas;i=t.width;n=t.height;let o=t.getContext("2d").getImageData(0,0,i,n).data.buffer;let a=te.video_canvas_face_detection.style;if(a.width!=t.style.width||a.height!=t.style.height){a.width=t.style.width;a.height=t.style.height}let s={rgba:o,w:i,h:n};if(!te.video_canvas_face_detection._offscreen&&self.OffscreenCanvas){s.canvas=te.video_canvas_face_detection.transferControlToOffscreen();te.video_canvas_face_detection._offscreen=true;console.log("(Face detection: use offscreen canvas)")}_.postMessage(s,s.canvas?[s.canvas,s.rgba]:[s.rgba]);s.rgba=o=undefined;s=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}},update_frame_local:function(e,i){let t=te.video_canvas.width;let n=te.video_canvas.height;let o;if(!e){e=te.video_canvas_face_detection;if(e.width!=t||e.height!=n){e.width=t;e.height=n}o=e.getContext("2d");o.clearRect(0,0,t,n)}else{o=e.getContext("2d")}o.globalCompositeOperation="source-over";let a=this.face_cover;let s=a.width;let r=a.height;let _,l,d,c;if(i.length){let t=1;i.forEach(function(e){_=e[2]*t;l=_*s/r;d=e[1]*t-l/2;c=e[0]*t-_/2;o.drawImage(a,0,0,s,r,d,c,l,_)})}else{_=Math.min(t,n);l=_*s/r;d=(t-l)/2;c=(n-_)/2;o.drawImage(a,0,0,s,r,d,c,l,_)}}};return d}(),facemesh:function(){var i=false;var q=0;var K=0;var V=true;var Q=0;var X=[];var N;var Y;var Z=false;var n=-1;var t;function o(e){if(!e&&t&&t==te.video_id)return;t=te.video_id;q=0;K=0;V=true;Q=0;X=[];N={};Y={L:[],R:[]};var n={L:[159,145],R:[386,374]};["L","R"].forEach(function(t){for(var i=0;i<1;i++){let e=Y[t][i]={};e.index=i;e._eye_open_average=0;e.eye_open_average=0;e.eye_open_lower=999;e.eye_open_data=[];e.height_ref_pts=n[t]}N[t]={_height_average:0,height_average:0,height_data:[],height_ref_pts:t=="R"?[334,330]:[105,101]}})}var a;var $=[];var J,ee,M;J=!is_mobile;M=!is_chrome||is_mobile;var e;function s(){if(ie.initialized)return;ie.initialized=true;for(var e=0;e<4;e++)$[e]=new THREE.Vector3;var n=[];if(System._browser.use_WASM_SIMD){n.push("simd=1")}if(p){J=true}if(M){J=true;n.push("use_mediapipe_facemesh=1")}if(J){J=true;ie.blink_detection=true;n.push("use_face_landmarks=1")}if(ee){n.push("use_human_facemesh=1")}var t;if(MMD_SA_options.user_camera.ML_models.worker_disabled){t=new Promise((e,t)=>{L={postMessage:function(e,t){FacemeshAT.onmessage({data:e})}};let i=document.createElement("script");i.onload=async function(){await FacemeshAT.init(L,n);e()};i.src="js/facemesh_lib.js";document.head.appendChild(i)})}else{L=new Worker("js/facemesh_worker.js"+(n.length?"?"+n.join("&"):""))}L.onmessage=_;return t}function r(e,t,i){const n=new Path2D;n.moveTo(t[0][0]/2,t[0][1]/2);for(let e=1;e<3;e++){const o=t[e];n.lineTo(o[0]/2,o[1]/2)}if(i){n.closePath()}e.stroke(n)}var _=function(){var G=0,H=0,U=0,W=0;return function(e){var L=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof L==="string"){if(L=="OK"){ie.worker_initialized=true}else{DEBUG_show(L,2);System._browser.console.log(L)}}else if(L.posenet){fe({data:L})}else{te._needs_RAF=true;const t=ve[ne.use_holistic?1:0];if(!t.facemesh){t.facemesh=true;DEBUG_show("Facemesh ML ready",2)}let z="";if(L.faces.length){ie.data_detected++}else{ie.data_detected=0}if(L.faces.length&&L.faces[0].bb_center){w=L.faces[0].bb_center}else if(!ne.enabled){w=[.5,.5]}if(L.faces.length&&ie.data_detected_stable){let d=L.faces[0];let c=te.x_flipped?1:-1;const B={facemesh_data:d};let u,p,e;if(d.rotation){const O=d.rotation.matrix;ae.set(O[0],O[1],O[2],0,O[3],O[4],O[5],0,O[6],O[7],O[8],0,0,0,0,1)}else{let e=MMD_SA._v3a_.fromArray(d.mesh[152]).sub(MMD_SA._v3b.fromArray(d.mesh[10])).normalize();let t=MMD_SA._v3b_.fromArray(d.mesh[454]).sub(MMD_SA._v3b.fromArray(d.mesh[234])).normalize();let i=MMD_SA.TEMP_v3.crossVectors(t,e).normalize();t.crossVectors(e,i);ae.set(t.x,t.y,t.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,0,0,0,0,1)}let t=MMD_SA.TEMP_v3.setEulerFromRotationMatrix(ae,"YZX");u=-t.x;p=-t.y;e=-t.z;let i=d.scaledMesh[454][0]-d.scaledMesh[234][0];let n=d.scaledMesh[454][1]-d.scaledMesh[234][1];let o;if(L.recalculate_z_rotation_from_scaledMesh){i/=Math.cos(p);n/=Math.cos(u);o=Math.sqrt(i*i+n*n)}else{i/=Math.cos(e);o=Math.abs(i/Math.cos(p))}ie.face_width=o;let a;if(L.recalculate_z_rotation_from_scaledMesh){a=Math.asin(n/o)}else{a=e}let s=new THREE.Quaternion;s.setFromEuler(MMD_SA._v3a.set(u,p*c,a*c),"YZX");let r=te.video_timestamp;let _=0;if(W){_=Math.max(Math.min(r-W,1e3),10);U+=_;if(++H>=20){G=1e3/(U/H);H=U=0}}W=r;ie._t=L._t;se.t_delta=G&&1e3/G||_||L.fps&&1e3/L.fps||L._t;if(ie.head_pose_enabled){if(System._browser.motion_control.enabled)B.head_rot=MMD_SA._v3a.clone();se.add("skin|facemesh","首",{after_IK:true,rot:s,_rot_ratio:ie.face_width/Math.min(te.video_canvas.width,te.video_canvas.height),onProcessRotation:he})}if(!q)q=Date.now();if(V){K=~~(Math.min((Date.now()-q)/5e3,X.length/30,Z?Y.L[0].eye_open_data.length/30:1,1)*100);V=K<100}let h=d.faceInViewConfidence>(ee?.75:.9)&&(te.video==te._image||!te.video.paused&&Math.abs(p)<Math.PI/4&&Math.abs(u)<Math.PI/6);let l=MMD_SA._v3a.fromArray(d.mesh[13]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[14]));let m=MMD_SA._v3a.fromArray(d.mesh[61]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[291]));let f=Q;if(!f){if(h&&l<2)X.push(m);if(!X.length){f=0}else{let e=parseInt(X.length*.3);f=X.sort((e,t)=>e-t).slice(e,X.length-e).reduce((e,t)=>e+t)/(X.length-e*2);if(!V){Q=f}}}let g=0;let y=0;let v=0;let M=0;["L","R"].forEach(function(e){let t=N[e];t.height=MMD_SA._v3a.fromArray(d.mesh[t.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[t.height_ref_pts[1]]));t._height_average=t.height_average;if(!t._height_average){if(h)t.height_data.push(t.height);if(!t.height_data.length){t._height_average=t.height}else{let e=parseInt(X.length*.3);t._height_average=t.height_data.sort((e,t)=>e-t).slice(e,t.height_data.length-e).reduce((e,t)=>e+t)/(t.height_data.length-e*2);if(!V){t.height_average=t._height_average}}}v+=t.height/t._height_average});v/=2;v=(v-1)/.25*(v>1?2:1);if(f){if(m>f*1.05){y=Math.sqrt(Math.min((m-f*1.05)/(f*.25),1))}else if(m<f*.98){y=-Math.sqrt(Math.min((f*.98-m)/(f*.2),1))}if(l>2){g=Math.pow(Math.min((l-2)/(f*1/3),1),.5);if(y>.25)M=(y-.25)/.75*.3}}let b=0;let w=0;let S=0;let A=0;let D=0;if(Array.isArray(d.emotion)){d.emotion.forEach(e=>{switch(e.emotion){case"happy":b+=e.score;break;case"sad":w+=e.score;break;case"angry":case"disgust":S+=e.score;break;case"fear":A+=e.score;break;case"surprise":D+=e.score;break}})}let k=b-(w+S+A+D*.5);if(k<0){M*=Math.max(1+k*2,0)}else{M=Math.min(k*.2+M*(1+k*.5),.4)}se.add("morph|facemesh","にこり",{weight:Math.min(M+b*.75,.75)});se.add("morph|facemesh","困る",{weight:Math.min((w+A)/2*.75+(v<0?Math.max(-v*1-Math.max(y,0)*.5,0):0),.75)});se.add("morph|facemesh","怒り",{weight:Math.min(S*.75,.75)});v+=D*.2;se.add("morph|facemesh","笑い",{weight:M});se.add("morph|facemesh","びっくり",{weight:D*.75});se.add("morph|facemesh","にやり",{weight:y});let E=MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(u,p,e),"YZX").conjugate();let x=[];[13,14,61,291].forEach(function(e,t){x[e]=$[t].fromArray(d.mesh[e]).applyQuaternion(E).setZ(0)});let P=MMD_SA._v3a.copy(x[61]).add(x[291]).multiplyScalar(.5);let I=x[61].distanceTo(x[291])*.5;let R=Math.atan2(x[13].y-P.y,I);let F=Math.atan2(x[14].y-P.y,I);let T=Math.max(-(R+F)*180/Math.PI+20*g,0);if(T)T=Math.min(T/20,.75);T=Math.min(T+w*.25,1);T*=.5;g=g*(1-T);se.add("morph|facemesh","あ",{weight:g});se.add("morph|facemesh","お",{weight:T});let C={L:[0],R:[0]};let j={L:[],R:[]};if(!ie.eye_tracking){}else if(J){let i=[0,0];let n=[0,0];d.eyes.forEach(function(e,t){if(e){i[t]=Math.max(Math.min((e[3]*2+u/(Math.PI/2))*(1-Math.abs(u)/Math.PI),1),-1);n[t]=Math.max(Math.min((e[2]*2-p/(Math.PI/2))*(1-Math.abs(p)/Math.PI),1),-1)}});["L","R"].forEach(function(t){let i=0;C[t][i]=0;let n=Y[t][i];let o=MMD_SA._v3a.fromArray(d.mesh[n.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[n.height_ref_pts[1]]));let a=n.eye_open_average;if(!a){if(h){n.eye_open_data.push(o);let e=parseInt(n.eye_open_data.length*.3);a=n.eye_open_data.sort((e,t)=>e-t).slice(e,n.eye_open_data.length-e).reduce((e,t)=>e+t)/(n.eye_open_data.length-e*2);if(!V){n.eye_open_average=a}}else{a=n._eye_open_average}}if(h){if(n.eye_open_lower>o)n.eye_open_lower=o}n._eye_open_average=a;if(a){if(o>a){C[t][i]=Math.min(o/a,1.25)}else{let e=Math.min(n.eye_open_lower,a/2);C[t][i]=Math.max((o-e)/(a-e),0)}}});let e=(C.L[0]+C.R[0])/2;if(e>1)v+=(e-1)*2;else v-=(1-e)*.5;v=Math.min(v,1);let t=C.L[0]+C.R[0];if(t)t=C.L[0]/t;else t=.5;let o=i[0]*t+i[1]*(1-t);let a=n[0]*t+n[1]*(1-t);let s={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-(o-.3)*15/180*Math.PI,a*c*20/180*Math.PI,0),"YZX")};se.add("skin|facemesh","両目",s);let r=!ie.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["まばたきL"]!=null;let _=r?Math.min(Math.max(Math.abs(C.L[0]-C.R[0])-(.25+(1-Math.min(Math.max((Math.PI/6-Math.abs(p))/(Math.PI/12),0),1))*1),0)/.25,1):0;let l=r?Math.min(C.L[0],C.R[0]):(C.L[0]+C.R[0])/2;C.L[0]=C.L[0]*_+l*(1-_);C.R[0]=C.R[0]*_+l*(1-_);if(r){se.add("morph|facemesh","まばたき"+(c==1?"L":"R"),{weight:Math.max(Math.min(1-C.L[0]*.8-M,1),0)});se.add("morph|facemesh","まばたき"+(c==1?"R":"L"),{weight:Math.max(Math.min(1-C.R[0]*.8-M,1),0)});se.add("morph|facemesh","まばたき",{weight:0})}else{se.add("morph|facemesh","まばたきL",{weight:0});se.add("morph|facemesh","まばたきR",{weight:0});se.add("morph|facemesh","まばたき",{weight:Math.max(Math.min(1-C.L[0]*.8-M,1),0)})}}else{let e=d.eyes[0];let t=0;let i=0;if(e){t=Math.max(Math.min((e[3]*2+u/(Math.PI/2))*(1-Math.abs(u)/Math.PI),1),-1);i=Math.max(Math.min((e[2]*2-p/(Math.PI/2))*(1-Math.abs(p)/Math.PI),1),-1)}let n=v*.25;if(n<0)n=Math.min(n+M,0);let o=Math.max(Math.min(.1-t*(t<0?2:1)*.2-n,.5),0);se.add("morph|facemesh","まばたき",{weight:o});let a=1.25+Math.pow((C.L[0]+C.R[0])/2,2)*1.75;t=Math.sign(t)*Math.pow(Math.abs(t),a);i=Math.sign(i)*Math.pow(Math.abs(i),a);let s={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-t*15/180*Math.PI,i*c*20/180*Math.PI,0),"YZX")};se.add("skin|facemesh","両目",s)}if(ie.eye_tracking)se.add("morph|facemesh","上",{weight:Math.max(Math.min(v,1),-1)});z=z||d.eyes.length&&[(!ne.enabled?te.video_canvas.width+"x"+te.video_canvas.height+"("+ie.camera_video_frame_id+")\n":"")+(V?"Calibrating("+K+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(d.faceInViewConfidence*100)+"%",d.emotion?JSON.stringify(d.emotion):"Neutral"].join("\n");if(oe)z+=oe;System._browser.motion_control.process(B)}else{z="(no facemesh data)\n"+oe}if(!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden)DEBUG_show(z&&z+(!ne.enabled||!ne.use_holistic?"\nF-FPS:"+Math.round(G)+"/"+Math.round(L.fps||0):"")+"\n"+"FPS:"+EV_sync_update.fps_last||"");ie.busy=0}ie.update_frame()}}();var b=document.createElement("canvas");var l=true;var w=[];var d=0;var c=0;ie={initialized:false,worker_initialized:false,get data_detected(){return d},set data_detected(e){if(e){if(!d){c=RAF_timestamp}}else{c=0}d=e},get data_detected_stable(){return i&&c&&RAF_timestamp-c>250},get head_pose_enabled(){return this.data_detected_stable||!ne.enabled},get blink_detection(){return Z},set blink_detection(e){Z=e;if(i){if(Z){o()}else{MMD_SA_options.auto_blink=a}}},get eye_tracking(){return l},set eye_tracking(e){l=e;if(i){if(l){this.blink_detection=J}else{this.blink_detection=false;se.remove("skin","両目");se.remove("morph","まばたきL");se.remove("morph","まばたきR");se.remove("morph","まばたき");se.remove("morph","上");se.remove("morph","下")}}},get use_faceLandmarksDetection(){return J},set use_faceLandmarksDetection(e){if(!this.initialized)J=e},get use_mediapipe(){return M||ne.enabled&&ne.use_holistic},set use_mediapipe(e){return M=e},get calibrated(){return!V&&K>=100},export_calibration:function(){const e={facemesh_calibration_type:ne.use_holistic?"holistic":"facemesh",lips_width_average:Q,eyebrow_data:{L:{height_average:N.L.height_average},R:{height_average:N.R.height_average}},eye_data:{L:{eye_open_average:Y.L[0].eye_open_average},R:{eye_open_average:Y.R[0].eye_open_average}}};System._browser.save_file("facemesh_calibration.json",JSON.stringify(e),"application/json")},import_calibration:function(e){this.reset_calibration();Q=e.lips_width_average;for(const t of["L","R"]){Object.assign(N[t],e.eyebrow_data[t]);Object.assign(Y[t][0],e.eye_data[t])}K=100;V=false},face_width:0,get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;this.data_detected=0;w[0]=w[1]=.5;if(i){if(!this.initialized)s();a=MMD_SA_options.auto_blink;const t=ne.use_holistic?1:0;o(n!=t);n=t}else{MMD_SA_options.auto_blink=a}E()},get bb_center(){return w},set bb_center(e){w=e},reset_calibration:o,frames:se,init:s,worker_onmessage:_,camera_video_timestamp:0,update_frame:function(e){async function t(){var e=ie.enabled&&ie.worker_initialized&&S&&!ie.busy&&!(ne.enabled&&ne.use_holistic)&&D&&ie.camera_video_timestamp!=S;if(!e)return;ie.busy=RAF_timestamp;ie.camera_video_timestamp=S;ie.camera_video_frame_id=A;if(Z){MMD_SA_options.auto_blink=false}let o;let a,s;let r,_;let l,d;let t;o=te.video_canvas;let i=o.width,n=o.height;l=d=0;a=r=i;s=_=n;let c=1;let u=MMD_SA_options.user_camera.pixel_limit.facemesh;if(u){if(a*s>u[0]*u[1]){c=Math.sqrt(a*s/(u[0]*u[1]));a=r=Math.round(a/c);s=_=Math.round(s/c);o=b;t=true}}let p,h,m;if(MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio){p=MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio;m=Math.round(Math.min(a,s)*p);r=m;_=m;let e=1;const v=5*(M?2:1);if(ie.data_detected<v&&p<1&&!ne.enabled){e=p+(1-p)*(1-Math.min(ie.data_detected/v,1));m=Math.round(Math.min(a,s)*e);h=p/e;p=e;o=b;t=true}l=Math.max(Math.min(a*w[0]-m/2,a-m),0)*(h||1);d=Math.max(Math.min(s*w[1]-m/2,s-m),0)*(h||1)}let f=o.getContext("2d");if(t){f.globalCompositeOperation="copy";let e=l,t=d,i=r,n=_;if(h){i=n=m;if(o.width!=r||o.height!=_){o.width=r;o.height=_;console.log("Facemesh canvas("+a+"x"+s+"=>"+r+"x"+_+"):"+[e,t,m,m].join(",")+"=>"+[l,d,r,_].join(","))}}else{if(o.width!=r||o.height!=_){o.width=r;o.height=_;console.log("Facemesh canvas("+a+"x"+s+")")}}f.drawImage(te.video_canvas,Math.round(e*c),Math.round(t*c),Math.round(i*c),Math.round(n*c),0,0,r,_)}let g=k&&M?await createImageBitmap(o,t?0:l,t?0:d,r,_):f.getImageData(t?0:l,t?0:d,r,_).data.buffer;let y={rgba:g,w:a*(h||1),h:s*(h||1),options:{use_facemesh:true,draw_canvas:true,flip_canvas:te.display_flipped,bb:{x:Math.round(l),y:Math.round(d),w:r,h:_,ratio:p||0,scale:h||1}}};if(self.FacemeshAT){y.canvas=te.video_canvas_facemesh}else if(!te.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){y.canvas=te.video_canvas_facemesh.transferControlToOffscreen();te.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}L.postMessage(y,y.canvas?[y.canvas,y.rgba]:[y.rgba]);y.rgba=g=undefined;y=undefined}if(e||self.FacemeshAT){setTimeout(()=>{t()},0)}else{t()}}};return ie}(),poseNet:function(){var t=false;var i=true;var o=true;var a={};var n=null;var s=0;var r=0;var _=0;var l=null;var d=null;var c=0;ne={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;N=false;this.data_detected=0;_=0;THREE.MMD.getModels()[0].mesh.visible=true;R.set(0,0,0);if(t){if(!this.initialized)pe();MMD_SA_options.user_camera.ML_models.pose.events.enabled&&MMD_SA_options.user_camera.ML_models.pose.events.enabled()}else{THREE.MMD.getModels()[0].resetPhysics();MMD_SA_options.user_camera.ML_models.pose.events.disabled&&MMD_SA_options.user_camera.ML_models.pose.events.disabled()}E();if(ne.use_holistic){setTimeout(()=>{if(t)ie.enabled=B.enabled=true;else B.enabled=false;DEBUG_show("(Holistic Mode:"+(t?"ON":"OFF")+")",2)},0)}},get data_detected(){return s},set data_detected(e){if(1){if(e){if(!s){r=RAF_timestamp}if(this.data_detected_stable){_=0}}else{r=0;if(!_){_=RAF_timestamp}if(RAF_timestamp-_>250){se.reset()}}}s=e},get data_detected_stable(){return t&&(!_||RAF_timestamp-_<250||r&&RAF_timestamp-r>500)},get use_3D_pose(){return t&&i&&le},set use_3D_pose(e){i=e},get use_holistic(){return n==null?p:n},set use_holistic(e){n=e},get _use_holistic_(){return p},set _use_holistic_(e){p=e},get skip_hand_countdown_max(){return this.use_holistic||C?0:1},set IK_disabled(e){o=e},get auto_grounding(){return l!=null?l:MMD_SA_options.user_camera.ML_models.pose.auto_grounding||MMD_SA.WebXR.session},set auto_grounding(e){l=e},get ground_plane_visible(){return d!=null?d:!t||!!MMD_SA_options.user_camera.ML_models.pose.auto_grounding},set ground_plane_visible(e){d=e},get spine_length_ref(){if(c)return c;const e=MMD_SA_options.model_para_obj.left_leg_length/MMD_SA_options.model_para_obj.spine_length;return ne.leg_scale_adjustment?Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length*(e/1.83))*(21-ne.leg_scale_adjustment)/20:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)},set spine_length_ref(e){c=e},leg_scale_adjustment:0,IK_disabled_check:function(){var i=new RegExp("("+toRegExp(["腕ＩＫ","足ＩＫ","つま先ＩＫ"],"|")+")$");var n=new RegExp("("+toRegExp(["腕ＩＫ"],"|")+")$");return function(e){var t=o&&this.use_3D_pose&&this.data_detected&&MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled&&(!e||n.test(e)||!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only&&i.test(e));if(t&&e){if(a[e])t=false}return t}}(),enable_IK:function(e,t){a[e]=t},frames:se,camera_video_timestamp:0,get busy(){return G},get initialized(){return w},get worker_initialized(){return x},upper_body_rotation_limiter:function(t,i,n=Math.PI/3){i.set(0,0,0,1);var o=t.toAxisAngle();var a=o[1];if(Math.abs(a)>n){let e;if(Math.abs(a)<n*2){e=Math.sign(a)*n}else{e=Math.sign(a)*n*(1-(a-n*2)/(Math.PI-n*2))}t.setFromAxisAngle(o[0],e);i.setFromAxisAngle(o[0],e-a)}}};return ne}(),handpose:function(){var t=false;B={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){if(!this.initialized)pe()}},frames:se,get busy(){return G},get initialized(){return w},get worker_initialized(){return x}};return B}(),snapshot:function(){var t=false;var i=false;var n;var o;function a(){const e=MMD_SA.THREEX.SL;var t=Math.ceil(3-(Date.now()-n)/1e3);if(t<=0){if(!te.visible){r(e);return}DEBUG_show("Capturing...");if(!te.stream){if(!c.enabled){s();return}i=true}else{te.target_devicePixelRatio=1;te.video_track.applyConstraints(te.set_constraints()).then(function(){System._browser.console.log("(Ready to capture)");System._browser.on_animation_update.add(function(){MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);if(!c.enabled){System._browser.on_animation_update.add(function(){s()},0,1);return}i=true},0,0)})["catch"](function(e){DEBUG_show("ERROR:camera size failed to update");_()})}System._browser.on_animation_update.remove(a,0)}else if(o!=t){o=t;DEBUG_show(o)}}function s(){const e=MMD_SA.THREEX.SL;let t=te.video_canvas_bodyPix;t.width=e.width;t.height=e.height;let i=t.getContext("2d");i.globalCompositeOperation="source-over";i.drawImage(te.video_canvas,0,0);if(d.enabled)i.drawImage(te.video_canvas_face_detection,0,0);i.save();i.translate(t.width,0);i.scale(-1,1);i.drawImage(e,0,0);i.restore();r(t)}function r(e){t=true;i=false;System._browser.on_animation_update.remove(a,0);e.toBlob(function(e){if(webkit_electron_mode){System._browser.save_file("snapshot_"+Date.now()+".png",e)}else{const t=URL.createObjectURL(e);window.open(t)}_()})}function _(){Ldebug.style.posLeft=Ldebug.style.posTop=0;Ldebug.style.transform=Ldebug.style.transformOrigin="";DEBUG_show();i=false;te.target_devicePixelRatio=0;t=false}h={init:function(){if(t){return true}const e=MMD_SA.THREEX.SL;if(MMD_SA.WebXR.session){let e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(!e.dom_overlay||!e.dom_overlay.use_dummy_webgl){DEBUG_show("(No snapshot in AR WebGL)",3);return true}}if(!te.visible){r(e)}else{t=true;n=Date.now();Ldebug.style.posLeft=Ldebug.style.posTop=50;Ldebug.style.transformOrigin="0 0";Ldebug.style.transform="scale(5,5)";o=3;DEBUG_show();DEBUG_show(o);System._browser.on_animation_update.add(a,0,0,-1)}},check_status:function(){if(!t)return;if(i){r(te.video_canvas_bodyPix)}return true}};return h}(),reset_video_canvas:function(){if(this.video_canvas){this.video_canvas.width=this.video_canvas.height=S=0;A=""}},show:function(){if(!this.initialized||this.visible)return;this.visible=true;if(te.target_devicePixelRatio!=window.devicePixelRatio){te.target_devicePixelRatio=0;te.video_track.applyConstraints(te.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)})["catch"](function(e){DEBUG_show("ERROR:camera size failed to update")})}f();if(this.hidden_enforced)this.hide()},hide:function(){if(!this.initialized||!this.visible)return;this.visible=false;this.video_canvas.style.visibility="hidden";d.enabled=false;c.enabled=false;g()},set_constraints:function(e){var t={};var i=window.devicePixelRatio/this.target_devicePixelRatio;var n=Math.round(window.innerWidth*i);var o=Math.round(window.innerHeight*i);var a=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(!M){if(MMD_SA_options.user_camera.pixel_limit.fixed){n=a[0];o=a[1]}else if(n*o>a[0]*a[1]){const s=Math.sqrt(n*o/(a[0]*a[1]));n=Math.round(n/s);o=Math.round(o/s)}}te.target_width=n;te.target_height=o;if(!is_mobile||!screen.orientation||/landscape/.test(screen.orientation.type)){t.width=n;t.height=o}else{t.width=o;t.height=n}if(e)t=Object.assign(t,e);console.log("Camera constraints",t);return t}};return te}(),data_filter:function(){class o{constructor(e=200,t=o.#reducer_scalar){this.data_list=[];this.time_average=e;if(typeof t=="string"){switch(t){case"vector3":this.reducer=o.#reducer_vector3;break;case"quaternion":this.reducer=o.#reducer_quaternion;break}}else{this.reducer=t}o.#init()}static#initialized;static#init(){if(o.#initialized)return;o.#initialized=true;o.#v1=new THREE.Vector3;o.#v2=new THREE.Vector3;o.#q1=new THREE.Quaternion;o.#q2=new THREE.Quaternion}static#reducer_scalar(e,t,i,n){return(typeof e=="number"?e:e.value/n.length)+t.value/n.length}static#v1;static#v2;static#reducer_vector3=function(e,t,i,n){return o.#v1.fromArray(Array.isArray(e)?e:e.value).lerp(o.#v2.fromArray(t.value),1/(i+1)).toArray()};static#q1;static#q2;static#reducer_quaternion=function(e,t,i,n){return o.#q1.fromArray(Array.isArray(e)?e:e.value).slerp(o.#q2.fromArray(t.value),1/(i+1)).toArray()};filter(e,i=System._browser.camera.initialized&&System._browser.camera.ML_enabled?System._browser.camera.video_timestamp:RAF_timestamp){if(!this.data_list.length||i!=this.data_list[this.data_list.length-1].timestamp)this.data_list.push({timestamp:i,value:e});if(this.data_list.length>1){this.data_list=this.data_list.filter((e,t)=>t==this.data_list.length-1||Math.abs(i-e.timestamp)<this.time_average)}return this.data_list.length==1?this.data_list[0].value:this.data_list.reduce(this.reducer)}}class e{constructor(e){this.filters=e;e.forEach(e=>{switch(e.type){case"average":e.filter=new o(...e.para||[]);break;case"one_euro":e.filter=new OneEuroFilter(...e.para||[]);break}})}filter(t,i=System._browser.camera.initialized&&System._browser.camera.ML_enabled?System._browser.camera.video_timestamp:RAF_timestamp){this.filters.forEach(e=>{if(!e.condition||e.condition())t=e.filter.filter(t,i)});return t}}return e}(),motion_control:function(){var l,p,u,d,c,h;var m;var f;var g=function(){var r={};var a={};return{pressed:r,map:a,temp:{},set_options:function(e){if(!S)return;if(!e.timeout_list){const t=["W","A","S","D"];for(const i of["L","R"]){for(const n in e[i]){const o=e[i][n];if(o.press)t.push(...o.press)}}e.timeout_list=t.map(e=>h[e])}if(!e.clear_list)e.clear_list={};for(const i of["L","R"]){if(!e.clear_list[i]){const t=i=="L"?["W","A","S","D"]:[];for(const n in e[i]){const o=e[i][n];if(o.press)t.push(...o.press)}e.clear_list[i]=t.map(e=>[h[e]])}}this.temp={};Object.assign(a,e);console.log(a)},action:function(e,t,i){var n=a[t][i]||{};return{press:n.press&&(!n.press_check||n.press_check(e))&&n.press||[],release:n.release||[],click:n.click&&(!n.click_check||n.click_check(e))&&n.click||[]}},activate:async function(e,t,i,n=[]){const o=this.action(e,t,i);if(o.click.length)await g.click(...o.click.map(e=>[h[e]]));if(o.press.length){const a=o.press.map(e=>h[e]);n=[...n.filter(e=>a.indexOf(e[0])==-1),...o.release.map(e=>[h[e]])];if(n.length)await g.releaseKey(...n);await g.pressKey(...a.map(e=>[e]))}},clear_list:function(e){return a.clear_list[e]},pressKey:async function(...e){let t=Array.isArray(e[0])&&e||[e];var i=[];for(const n of t){const o=n.filter(e=>!r[e]);if(o.length){for(const s of o)r[s]=-1;await c.pressKey(...o);const a=o.filter(e=>r[e]==-2);if(a.length){await c.releaseKey(...a);for(const s of a)r[s]=0;console.log("key released enforced",a.length)}}for(const s of n){if(r[s])r[s]=RAF_timestamp}}},releaseKey:async function(...e){const t=!e.length?Object.keys(r).map(e=>[parseInt(e)]):Array.isArray(e[0])&&e||[e];const i=[];for(const n of t){const o=n.filter(e=>r[e]>0);if(o.length){i.push(c.releaseKey(...o).then(()=>{for(const e of o)r[e]=0}))}const a=n.filter(e=>r[e]<0);a.forEach(e=>{r[e]=-2})}if(i.length){await Promise.all(i)}},releaseIdleKey:async function(...e){const t=!e.length?Object.keys(r).map(e=>[parseInt(e)]):Array.isArray(e[0])&&e||[e];const i=t.map(e=>e.filter(e=>r[e]&&(a.timeout_list.indexOf(e)==-1||RAF_timestamp-(r[e]>0?r[e]:RAF_timestamp)>500))).filter(e=>e.length);if(i.length){await g.releaseKey(...i)}},click:async function(...e){const t=Array.isArray(e[0])&&e||[e];await this.pressKey(...t);await this.releaseKey(...t)}}}();var y={custom:{},list:[],estimate:function(e,t,i=9){const n=e.estimate(t.keypoints,i);if(n.gestures.length){n.gestures.forEach(e=>{e._d=t._d;e.hand_facing=this.list[0].hand_facing[t._d];e.hand_rot_YXZ=this.list[0].hand_rot_YXZ[t._d];e.thumb_out=this.list[0].thumb_out[t._d];e.poseData=n.poseData});this.list[0].gestures=this.list[0].gestures.concat(n.gestures);for(let e=this.list.length-1;e>=0;e--){if(this.list[e].timestamp>RAF_timestamp-3e3){if(e<this.list.length-1)this.list=this.list.slice(0,e+1);break}}}return n},search:function(i,o={}){function a(e){return e.gestures.find(t=>i.split("|").some(e=>t.name==e&&(!o.hand||o.hand._d==t._d)&&(!o.hand_facing||o.hand_facing===t.hand_facing)&&(o.thumb_out==null||o.thumb_out===t.thumb_out)&&(!o.condition||t._condition_passed||o.condition(t)&&(t._condition_passed=true))))}var e=o.time_limit||0;var t;for(let i=0,n=this.list.length;i<n;i++){const s=this.list[i];if(s.timestamp<RAF_timestamp-e)break;const r=a(s);if(!r)continue;if(o.duration&&i<n-1){let e=s.timestamp-this.list[i+1].timestamp;let t;for(t=i+1;t<n;t++){const _=this.list[t];if(a(_)){e=t==n-1?9999:s.timestamp-this.list[t+1].timestamp;if(e>=o.duration)break}else break}if(e<o.duration){i=t;continue}}t=r;break}return t}};var v,M,b,w;var e,t,i,n;var o=false;var S,A;var a=true;async function s(){if(S)return;S=true;v=new THREE.Vector3;M=new THREE.Vector3;b=new THREE.Vector3;w=new THREE.Vector3;A=true;await System._browser.load_script("js/fingerpose.js");const t=new fp.GestureDescription("index_up");t.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);t.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){t.addCurl(e,fp.FingerCurl.FullCurl,1);t.addCurl(e,fp.FingerCurl.HalfCurl,.9)}y.custom.index_up=t;const i=new fp.GestureDescription("index_thumb");i.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);i.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);i.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){i.addCurl(e,fp.FingerCurl.FullCurl,1);i.addCurl(e,fp.FingerCurl.HalfCurl,.9)}y.custom.index_thumb=i;const n=new fp.GestureDescription("index_middle");n.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);n.addCurl(fp.Finger.Middle,fp.FingerCurl.NoCurl,1);n.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);n.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpLeft,1);n.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpRight,1);for(let e of[fp.Finger.Ring,fp.Finger.Pinky]){n.addCurl(e,fp.FingerCurl.FullCurl,1);n.addCurl(e,fp.FingerCurl.HalfCurl,.9)}y.custom.index_middle=n;const o=new fp.GestureDescription("index_pinky");o.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);o.addCurl(fp.Finger.Pinky,fp.FingerCurl.NoCurl,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring]){o.addCurl(e,fp.FingerCurl.FullCurl,1);o.addCurl(e,fp.FingerCurl.HalfCurl,.9)}y.custom.index_pinky=o;for(const a of["thumb","thumb_index","thumb_palm"]){const s=new fp.GestureDescription(a);for(const r of[fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){const _=a=="thumb_palm"||(r==fp.Finger.Index?a=="thumb_index":false);if(_){s.addCurl(r,fp.FingerCurl.NoCurl,1);if(a=="thumb_palm")s.addCurl(r,fp.FingerCurl.HalfCurl,.7)}else{s.addCurl(r,fp.FingerCurl.FullCurl,1);s.addCurl(r,fp.FingerCurl.HalfCurl,.9)}}y.custom[a]=s}const e=new fp.GestureDescription("palm_open");for(const r of[fp.Finger.Thumb,fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){e.addCurl(r,fp.FingerCurl.NoCurl,1)}e.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpLeft,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpRight,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalLeft,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalRight,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpLeft,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpRight,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalLeft,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalRight,1);y.custom.palm_open=e;m=new fp.GestureEstimator([y.custom.index_up]);({getActiveWindow:l,Point:p,centerOf:u,mouse:d,keyboard:c,Key:h}=require("node_modules.asar/nut.js/node_modules/@nut-tree/nut-js"));d.config.autoDelayMs=0;c.config.autoDelayMs=0;DEBUG_show("Motion control initialized",3);A=false}function D(e,t){var i=t.annotations.thumb;var n=[t.annotations.index[0][1],t.annotations.middle[0][1],t.annotations.ring[0][1],t.annotations.pinky[0][1]];var o=i[1][1]>Math.max(...n);var a,s;if(o){s=e.hand_rot_YXZ[1];if(s<=20)a="Horizontal Left";else if(s>20&&s<=50)a="Diagonal Down Left";else if(s>130&&s<=160)a="Diagonal Down Right";else if(s>160)a="Horizontal Right";else a="Vertical Down";if(!e.thumb_out&&/Horizontal/.test(a)){a="";s=0}}else{if(!e.thumb_out){a="";s=0}else{const r=-(i[3][1]-i[1][1]);const _=i[3][0]-i[1][0];s=Math.atan2(r,_)*180/Math.PI-90;if(s<-180)s+=360;s=-s;if(s>20&&s<=60)a="Diagonal Up Right";else if(s>60&&s<=120)a="Horizontal Right";else if(s<-20&&s>=-60)a="Diagonal Up Left";else if(s<-60&&s>=-120)a="Horizontal Left";else a="Vertical Up"}}return[a+"\n"+(i[1][1]>Math.max(...n))+"\n"+e.hand_rot_YXZ.join("\n"),s]}var k=function(){var i,n,o,e,a;return function(){if(e!=RAF_timestamp){e=RAF_timestamp;i=null;a=[];l().then(async e=>{[n,o]=await Promise.all([e.title,e.region]);i=e;const t={w:i,title:n,region:o};a.forEach(e=>{e(t)})})}return new Promise((e,t)=>{if(i){e({w:i,title:n,region:o})}else{a.push(e)}})}}();var r=["０","１","２","３"];var E=[];const x={get enabled(){return o},set enabled(e){if(o==!!e)return;o=!!e;if(o){s()}else{this.setMousePosition(null)}DEBUG_show("Motion control:"+(o?"ON":"OFF"),3)},get ready(){return o&&!A},get handedness(){return f},get off_hand(){return f=="左"?"右":"左"},get window_active(){return window_active},get debug_msg(){return o&&E.length?E.join("\n")+"\n":""},get Key(){return h},get key_pressed(){return g.pressed},process:async function(e){if(!this.ready)return;if(!y.list.length||y.list[0].timestamp!=RAF_timestamp){y.list.unshift({timestamp:RAF_timestamp,gestures:[]})}if(e.posenet_data){E=["Motion control"+(a?"(PAUSED)":"")+":"];const t=e.posenet_data.handpose;if(t&&t.length){const _={};const l={};const d={};t.forEach(e=>{if(!e._used)return;const t=System._browser.camera.poseNet.frames.skin[e._d+"手首"];if(!t)return;const i=MMD_SA.TEMP_v3.setEulerFromQuaternion(t[0].rot,"YXZ");l[e._d]=i.toArray().map(e=>e*180/Math.PI);_[e._d]=Math.abs(i.y)<Math.PI/4?"front":Math.abs(Math.abs(i.y)-Math.PI)<Math.PI/4?"back":"-";const n=e.annotations;const o=v.fromArray(n.index[0]);const a=M.fromArray(n.middle[0]).sub(o);const s=MMD_SA._v3a.fromArray(n.thumb[3]);const r=(s.x*a.x+s.y*a.y+s.z*a.z-(o.x*a.x+o.y*a.y+o.z*a.z))/a.lengthSq();d[e._d]=-r>1.5});y.list[0].hand_rot_YXZ=l;y.list[0].hand_facing=_;y.list[0].thumb_out=d;t.forEach(e=>{if(!e._used)return;if(a){y.estimate(m,e);const t=y.search("index_up",{duration:1e3,hand_facing:"front",thumb_out:false});if(t){a=false;f=t._d;DEBUG_show("Motion control:READY",2)}}else if(e._d==f){y.estimate(m,e);const t=y.search("index_up",{duration:1e3,hand_facing:"back",thumb_out:false});if(t){a=true;DEBUG_show("Motion control:PAUSED",2)}}})}}else if(e.facemesh_data){}if(a)return;this.virtual_mouse.process(e);this.game01.process(e)},setMousePosition:function(){var t;return async function(e){if(e===null){t=null;return}if(!o)return;if(e){t=e}else if(!e){return}await d.setPosition(t)}}(),game01:function(){var t,e;var i={id:"PSO2NGS",L:{thumb:{release:["Space","X"]},thumb_index:{press:["X"],release:["Space"]},thumb_palm:{press:["Space"],release:["X"]}},R:function(){function e(e){const t=g.temp.index_middle||0;const i=e.thumb_out?1:0;g.temp.index_middle=i;return t!=i}return{index_thumb:{press:["Tab"],press_check:function(){if(!g.temp.index_thumb)g.temp.index_thumb={};g.temp.index_thumb.clicked=true;return true}},index_up:{press:["Q"],press_check:function(){var e=g.temp.index_thumb&&g.temp.index_thumb.clicked;if(e)g.temp.index_thumb.clicked=false;return e}},index_middle1:{press:["Period"],click:["Semicolon"],click_check:e},index_middle2:{press:["Slash"],click:["Semicolon"],click_check:e},index_middle3:{press:["Quote"],click:["Semicolon"],click_check:e},thumb_palm:{press:["Backslash"]}}}()};var d;var n,o;function c(){if(e)return;d=new fp.GestureEstimator([y.custom.index_up,y.custom.index_thumb,y.custom.index_middle,y.custom.index_pinky,y.custom.palm_open,y.custom.thumb,y.custom.thumb_index,y.custom.thumb_palm]);g.set_options(i);e=true}return{get enabled(){return t},set enabled(e){t=e;if(t){g.set_options(i)}else{}},process:async function(i){if(!this.enabled){await g.releaseKey();return}c();const a=await k();const e=await a.title;if(i.facemesh_data&&i.head_rot){let e=i.head_rot.x*180/Math.PI;let t=i.head_rot.y*180/Math.PI;let n=Math.round(Math.sign(e)*Math.pow(Math.min(Math.max((Math.abs(e)-8)/15,0),1),2)*40);let o=Math.round(Math.sign(t)*Math.pow(Math.min(Math.max((Math.abs(t)-10)/20,0),1),2)*40);E.push(e,t,o,n);Promise.resolve(a.region).then(async e=>{const t=await u(e);const i=e.width-1280<64?[1280,720]:[1920,1080];t.y+=Math.round((e.height-i[1]-(e.width-i[0]))/2);t.x+=o;t.y+=n;t.y+=1;t.x+=1;await x.setMousePosition(t)})}let t;if(i.posenet_data){t=i.posenet_data.handpose;let e="";if(!t||!t.length){t=null;if(y.search("palm_open",{time_limit:500,hand_facing:"front",condition:()=>{}})){e+="/CANCEL";await g.releaseKey()}else{await g.releaseIdleKey()}}E.push((t?"":"(no hand data)")+e+"/key active:"+Object.keys(g.pressed).filter(e=>g.pressed[e]).join(","))}if(!t)return;for(const o of t){if(!o._used)continue;const s=o._d==f?"R":"L";E.push(s+":");y.estimate(d,o);let i;i=y.search("palm_open",{hand:o,hand_facing:"front",condition:function(e){const t=this.hand;const i=v.fromArray(t.annotations.index[0]).sub(M.fromArray(t.annotations.index[3]));const n=b.fromArray(t.annotations.pinky[0]).sub(w.fromArray(t.annotations.pinky[3]));return i.angleTo(n)*180/Math.PI>30}});if(i){E.push("CANCEL");await g.releaseKey(...g.clear_list(s));continue}if(o._d==f){i=y.search("index_thumb",{hand:o,hand_facing:"back",thumb_out:true});if(i){await g.activate(i,s,i.name,g.clear_list(s));E.push("index_thumb");continue}i=y.search("index_up",{hand:o,hand_facing:"front",thumb_out:true});if(i){await g.activate(i,s,i.name,g.clear_list(s));E.push("index_up");continue}i=y.search("index_middle",{hand:o});if(i){let e=i.name;switch(i.poseData[1][2]){case"Vertical Up":e+=2;break;case"Diagonal Up Left":e+=f=="右"?1:3;break;case"Diagonal Up Right":e+=f=="右"?3:1;break}await g.activate(i,s,e,g.clear_list(s));E.push(e);continue}i=y.search("thumb_palm",{hand:o,condition:function(e){if(!/(Horizontal|Diagonal Up)/.test(e.poseData[2][2]))return false;const t=this.hand;const i=v.fromArray(t.annotations.index[0]).sub(M.fromArray(t.annotations.index[3]));const n=b.fromArray(t.annotations.pinky[0]).sub(w.fromArray(t.annotations.pinky[3]));return i.angleTo(n)*180/Math.PI<20}});if(i){await g.activate(i,s,i.name,g.clear_list(s));E.push("thumb_palm");continue}i=y.search("thumb",{hand:o});if(i){E.push("CANCEL");await g.releaseKey(...g.clear_list(s));continue}i=y.search("index_pinky",{hand:o});if(i){E.push("index_pinky");continue}}else{i=y.search("thumb_palm|thumb_index|thumb",{hand:o,condition:function(e){if(e.name!="thumb_palm")return true;const t=this.hand;const i=v.fromArray(t.annotations.index[0]).sub(M.fromArray(t.annotations.index[3]));const n=b.fromArray(t.annotations.pinky[0]).sub(w.fromArray(t.annotations.pinky[3]));return i.angleTo(n)*180/Math.PI<20}});if(i){const r=D(i,o);const _=r[0];let e=[];let t=[];switch(_){case"Vertical Up":e.push("W");t.push("A","S","D");break;case"Diagonal Up Right":e.push("W","A");t.push("S","D");break;case"Horizontal Right":e.push("A");t.push("W","S","D");break;case"Diagonal Up Left":e.push("W","D");t.push("A","S");break;case"Horizontal Left":e.push("D");t.push("W","A","S");break;case"Diagonal Down Right":e.push("S","A");t.push("W","D");break;case"Diagonal Down Left":e.push("S","D");t.push("W","A");break;case"Vertical Down":e.push("S");t.push("W","A","D");break;default:t.push("W","A","S","D")}var n=g.action(i,s,i.name);if(n.press.length)e.push(...n.press);if(n.release.length)t.push(...n.release);if(e.length)await g.pressKey(...e.map(e=>[h[e]]));if(t.length)await g.releaseKey(...t.map(e=>[h[e]]));E.push([i.name,_].join("/")+"/"+RAF_timestamp);continue}}if(!i)await g.releaseIdleKey(...g.clear_list(s))}for(const l of[[0,t.findIndex(e=>e._used&&e._d==f)],[1,t.findIndex(e=>e._used&&e._d!=f)]]){if(l[1]!=-1)continue;const s=l[0]==0?"R":"L";if(y.search("palm_open",{time_limit:500,hand:{_d:l[0]==0?f:x.off_hand},hand_facing:"front",condition:()=>{}})){await g.releaseKey(...g.clear_list(s))}else{await g.releaseIdleKey(...g.clear_list(s))}}}}}(),virtual_mouse:function(){var e;var t;function u(){if(e)return;t=new fp.GestureEstimator([fp.Gestures.VictoryGesture,fp.Gestures.ThumbsUpGesture,y.custom.index_up]);e=true}return{enabled:false,process:async function(e){if(!this.enabled)return;if(!e.posenet_data)return;u();const t=e.posenet_data.handpose;if(!t||!t.length)return;const i=t[0]._d==f?0:1;const n=f=="右"?0:1;if(!t[i]||!t[i]._used)return;const o=screen.width/2;const a=screen.height/2;const s=System._browser.camera.video_canvas;const r=s.width/s.height/(o/a);const _=.5;const l=t[i].annotations.index[0];const d={x:-(-s.width/2+l[0])/(s.width/2*_),y:(-s.height/2+l[1])/(s.height/2*_)};d.x=Math.round(o+THREE.Math.clamp(d.x*r,-1,1)*o);d.y=Math.round(a+THREE.Math.clamp(d.y/r,-1,1)*a);const c=new p(d.x,d.y);await x.setMousePosition(c)}}}()};return x}(),load_script:function(){var o={};var a=function(e,t){this.url=e;this.name=e.replace(/^.+[\/\\]/,"");this.loaded=false;this.resolve_list=[];this.reject_list=[];if(t){const i=this;import(e).then(e=>{i.module=e;i.check_loaded()})}else{const n=document.createElement("script");n.onload=this.check_loaded.bind(this);n.src=e;document.head.appendChild(n)}};a.prototype.check_loaded=function(){this.loaded=true;console.log(this.name+" loaded");this.resolve_list.forEach(e=>{e(this.module)})};a.prototype.make_promise=function(e,t){this.resolve_list.push(e);if(t)this.reject_list.push(t)};return function(e,t){var i=e.replace(/^.+[\/\\]/,"");var n=o[i]=o[i];if(n){if(n.loaded)return Promise.resolve(n.module)}else{n=o[i]=new a(e,t)}return new Promise((e,t)=>{n.make_promise(e,t)})}}(),save_file:function(){var a;return function(e,t,i){const n=!i?t:new Blob([t],{type:i});const o=URL.createObjectURL(n);if(!a){a=document.createElement("a");a.style.display="none";document.body.appendChild(a)}else{URL.revokeObjectURL(a.href)}a.href=o;a.download=e||"";a.click()}}(),skip_background_rendering:true,skip_rendering:false,rendering_check:function(){if(this.skip_rendering&&!this.hidden)return false;if(!returnBoolean("DisableBackgroundThrottling"))return true;const e=this.skip_background_rendering&&this.hidden;let t=document.getElementById("canvas_DisableBackgroundThrottling");if(e){if(!t){t=document.createElement("canvas");t.id="canvas_DisableBackgroundThrottling";t.width=t.height=1;t.style.position="absolute";t.style.posLeft=t.style.posTop="0px";t.style.zIndex=9999;document.getElementById("Lbody_host").appendChild(t)}t.getContext("2d").clearRect(0,0,t.width,t.height)}if(t)t.style.visibility=e?"inherit":"hidden";return!e},console:{content_list:[],log:function(){for(var e=0;e<arguments.length;e++){this.content_list.push(arguments[e])}},reset:function(){this.content_list=[]},get output_text(){return this.content_list.join("\n")||"(EMPTY)"}},DEBUG_show:function(){const t=self.DEBUG_show;self.DEBUG_show=function(...e){if(System._browser.overlay_mode>0){if(!e.length)t()}else{t(...e)}};return t}()},_hash_sha256:{_hash_cache:{},hash:function(e){if(webkit_electron_mode){var t=webkit_electron_remote.getGlobal("HASH_SHA256");if(t)return t.hash(e)}var i=this._hash_cache[e];if(i)return i;var n=require("crypto").createHash("sha256");n.update(e);i=this._hash_cache[e]=n.digest("hex");return i}},_media_objs_paused_:[],_gadget_resume:function(e){if(e&&!SA_topmost_window.EV_sync_update.RAF_auto_paused)return false;if(!SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=false;SA_topmost_window.EV_sync_update.RAF_auto_paused=false;SA_topmost_window.System._media_objs_paused_.forEach(function(e){if(e.SL_MC_Play)e.SL_MC_Play();else if(e.paused)e.play()});SA_topmost_window.System._media_objs_paused_=[];System._browser.update_tray();return true},_gadget_pause:function(e){if(SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=true;SA_topmost_window.EV_sync_update.RAF_auto_paused=e;var s=SA_topmost_window.System._media_objs_paused_;var t=[top];for(var i=0;i<SA_child_animation_max;i++){if(SA_topmost_window.SA_child_animation[i])t.push(SA_topmost_window.document.getElementById("Ichild_animation"+i).contentWindow)}var r=0;var _=0;var l=0;t.forEach(function(e){for(var t in e.seq_items){var i=e.seq_items[t];if(!i._gadget_pause_disabled&&!i.paused&&i.count){r++;i.pause();s.push(i)}}var n=[];var o;o=document.getElementById("VdesktopBG");if(o)n.push(o);o=e.CANVAS_Video_Overlay&&e.CANVAS_Video_Overlay._video;if(o)n.push(o);n.forEach(function(e){if(e&&!e.paused&&!e.ended){_++;e.pause();s.push(e)}});if(e.SL&&e.SL._mouse_event_main&&e.SL._mouse_event_main()){var a;if(e.SL_MC_simple_mode)a=e.SL_MC_video_obj.paused;else if(e.MMD_SA)a=e.SL_MC_video_obj.vo.audio_obj.paused;else if(e.use_WMP&&e.WMP.in_use)a=e.WMP.player.playState!=3;else a=e.SL_MC_video_obj&&e.SL_MC_video_obj.paused;if(!a){l++;e.SL_MC_Play();s.push(e)}}});console.log("Gadget PAUSED (Seq/Video/MC):"+[r,_,l].join("/"));System._browser.update_tray();return true},_returnRelativePath:function(e){if(!WallpaperEngine_CEF_mode)return e;if(System.Gadget.path&&e.indexOf(System.Gadget.path)==0)e=e.substr(System.Gadget.path.length);e=/\:/.test(e)?toFileProtocol(e):e.replace(/\\/g,"/").replace(/^\//,"");return e}};System._init();return System}();
