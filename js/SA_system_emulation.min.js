// (2022-04-26)
function _asyncToGenerator(t){return function(){var _=t.apply(this,arguments);return new Promise(function(l,u){function g(P,M){try{var I=_[P](M),S=I.value}catch(E){return void u(E)}return I.done?void l(S):Promise.resolve(S).then(function(E){g("next",E)},function(E){g("throw",E)})}return g("next")})}}var System=function(){var System={_init:function(){try{Shell_OBJ||(Shell_OBJ=new ActiveXObject("Shell.Application")),FSO_OBJ||(FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject")),oShell||(oShell=new ActiveXObject("WScript.Shell"))}catch(t){alert(t.message)}this._child_html_filename=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html",this.Gadget._init(),this.Machine._init(),SA_top_window.getScreenBounds=is_SA_child_animation?function(t,_,l){return SA_topmost_window.getScreenBounds(t,_,l)}:function(){var _,t=-1;return function(l,u,g){return(g||t!=RAF_timestamp)&&(t=RAF_timestamp,_=webkit_electron_mode?webkit_electron_screen.getDisplayNearestPoint({x:~~l,y:~~u}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}),_}}(),webkit_electron_mode&&(is_SA_child_animation?(SA_top_window.getPos=function(t){return SA_topmost_window.getPos(t)},SA_top_window.getCursorPos=function(t){return SA_topmost_window.getCursorPos(t)}):(SA_top_window.getPos=function(){var _,t=-1;return function(l){return(l||t!=RAF_timestamp)&&(t=RAF_timestamp,_=webkit_window.getPosition()),_}}(),SA_top_window.getCursorPos=function(){var _,t=-1;return function(l){return(l||t!=RAF_timestamp)&&(t=RAF_timestamp,_=webkit_electron_screen.getCursorScreenPoint()),_}}())),SA_top_window.resizeToAbsolute=function(){var t;return function(_,l){webkit_window.setContentSize(_,l),t=!0,absolute_screen_mode&&!System._browser._window_move_timerID&&(System._browser._window_move_timerID=setInterval(function(){var u=SA_top_window.screenLeftAbsolute,g=SA_top_window.screenTopAbsolute,P=0;return function(){var M=SA_top_window.getPos(!0);(u!=M[0]||g!=M[1])&&(DEBUG_show("(window position adjusted)",3),webkit_window.setPosition(u,g),System._browser.moveWallpaper(u,g),P=999),10<++P&&(clearInterval(System._browser._window_move_timerID),System._browser._window_move_timerID=null)}}(),100))}}(),SA_top_window.moveToAbsolute=function(t,_,l){absolute_screen_mode&&!l?webkit_window.setPosition(~~t,~~_):this.moveTo(t,_)},SA_top_window.moveByAbsolute=function(t,_){if(absolute_screen_mode){let l=SA_top_window.getPos(!0);t+=~~l[0],_+=~~l[1],webkit_window.setPosition(t,_)}else this.moveBy(t,_)},Object.defineProperty(SA_top_window,"screenLeftAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[0]:this.screenLeft}}),Object.defineProperty(SA_top_window,"screenTopAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[1]:this.screenTop}})},Gadget:{_init:function(){this.Settings.read=this.Settings.readString,this.Settings.write=this.Settings.writeString,Object.defineProperty(this,"onSettingsClosing",{get:function(){return this._onSettingsClosing},set:function(_){this._onSettingsClosing=_,this.settings_window.onbeforeunload=function(){_({closeAction:!!this.returnValue,Action:{commit:!0}}),System.Gadget.settings_window.System=null,System.Gadget.settings_window.onbeforeunload=null,System.Gadget.settings_window=null}}});var t=new ActiveXObject("Microsoft.XMLDOM");t.async=!1,t.resolveExternals=!1,t.validateOnParse=!1,t.load("gadget.xml"),this.version=t.selectSingleNode("//version").text},path:xul_mode?XPCOM_object._SA_root:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",_path_folder:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",docked:is_SA_child_animation,visible:!0,Settings:{_settings_need_update:!1,_settings:{},_changed:{},_readString_func_readVariable:function($0,$1){return eval($1)},readString:function(t,_){var l=this._settings[t];return l=l?_?decodeURIComponent(l):decodeURIComponent(l).replace(/\$([^\$]+)\$/g,this._readString_func_readVariable):Settings_default._custom_[t]||"",l},writeString:function(t,_){var l=this._settings[t]||"",u=encodeURIComponent(_);if(this._settings[t]=u,WallpaperEngine_CEF_mode){var g=JSON.parse(localStorage.Settings_by_path);SA_HTA_folder&&g[SA_HTA_folder]?g[SA_HTA_folder][t]!=u&&(g[SA_HTA_folder][t]=u,localStorage.Settings_by_path=JSON.stringify(g)):console.error(SA_HTA_folder)}l!=u&&(this._changed[t]=this._settings_need_update=!0)},_writeSettings:function(t,_){if(t||this._settings_need_update){this._settings_need_update=!1,SystemEXT._save_settings_only=_;try{this._writeSettings_CORE()}catch(l){}SystemEXT._save_settings_only=!1}},_writeSettings_CORE:function(){var t=[],_=this._settings;for(var l in _._screenLeft=_._screenTop="",_){var u=System.Gadget.Settings.readString(l);u&&("_screenLeft"==l?u=SA_top_window.screenLeftAbsolute:"_screenTop"==l&&(u=SA_top_window.screenTopAbsolute),t.push("\""+l+"\":\""+encodeURIComponent(u)+"\""))}SystemEXT.SaveLocalSettings(t)}}},Environment:{win32_env:null,getEnvironmentVariable:function(t){return oShell.ExpandEnvironmentStrings("%"+t+"%")}},Machine:{_init:function(){this._init_memory=function(){if(!webkit_mode&&!this._WMI_obj_memory)try{this._WMI_obj_memory=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV"),this._WMI_obj_memory.init()}catch(l){}},Object.defineProperty(this,"availableMemory",{get:function(){if(webkit_mode)return SA_require("os").freemem()/1048576;this._init_memory();var l=this._WMI_obj_memory.update();return l.length?parseInt(l[l.length-1].AvailableMBytes):0}}),Object.defineProperty(this,"totalMemory",{get:function(){if(webkit_mode)return SA_require("os").totalmem()/1048576;if(!this._totalMemory)try{var l=new WMI_Refresher("Win32_OperatingSystem");l.init(),this._totalMemory=parseInt(l.update()[0].TotalVisibleMemorySize)/1024}catch(u){}return this._totalMemory}}),this.totalMemory=0;var t={_WMI_obj:null,_cpu_obj:null,_get_cpu_obj:null,_init:function(){if(webkit_mode)return this._get_cpu_obj?void 0:(this._cpu_obj=[{count:-1,cpus:SA_require("os").cpus()}],void(this._get_cpu_obj=function(){var l=this._cpu_obj;return l[0].count!=PC_count_absolute&&3==l.unshift({count:PC_count_absolute,cpus:SA_require("os").cpus()})&&l.pop(),l}));if(!this._WMI_obj)try{this._WMI_obj=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV"),this._WMI_obj.init()}catch(l){}},item:function(l){if(webkit_mode){for(var u=this._get_cpu_obj(),g=[],P=0;2>P;P++){var M=u[P].cpus[l].times,I=0;for(var S in M)I+=M[S];g[P]={total:I,idle:M.idle}}var E=g[0].idle-g[1].idle,I=g[0].total-g[1].total;return{usagePercentage:I?100*(1-E/I):0}}return{usagePercentage:parseFloat(this._WMI_obj.update()[l].PercentProcessorTime)}}};Object.defineProperty(t,"count",{get:function(){return webkit_mode?this._get_cpu_obj()[0].cpus.length:this._WMI_obj.update().length-1}}),this._CPUs=t,Object.defineProperty(this,"CPUs",{get:function(){return this._CPUs._init(),this._CPUs}});var _={_WMI_obj:null,_init:function(){if(!this._battery&&(this._battery={level:1,charging:!1},"getBattery"in navigator)){var l=this;navigator.getBattery().then(function(u){DEBUG_show("Use Battery Status API",2),l._battery=u})}}};Object.defineProperty(_,"batteryPercentRemaining",{get:function(){return 100*this._battery.level}}),Object.defineProperty(_,"isPowerLineConnected",{get:function(){return 1==this._battery.level||this._battery.charging}}),Object.defineProperty(_,"isBatteryCharging",{get:function(){return this._battery.charging}}),this._PowerStatus=_,Object.defineProperty(this,"PowerStatus",{get:function(){return this._PowerStatus._init(),this._PowerStatus}})}},Shell:{itemFromFileDrop:function(){return{path:""}},itemFromPath:function(t){t=toLocalPath(t);var _=t.replace(/[\/\\][^\/\\]+$/,""),l=t.replace(/^.+[\/\\]/,""),u=Shell_OBJ.NameSpace(_);return u&&(u=u.ParseName(l)),u?new this._FolderItem(u):null},execute:function(t,_){Shell_OBJ.ShellExecute(t,_)},chooseFolder:function(t,_){var l=Shell_OBJ.BrowseForFolder(0,t,_);return l?new this._FolderItem(l.Self):null},_FolderItem:function(t){this._constructor_initialized||(this.constructor.prototype._constructor_initialized=!0,this.constructor.prototype.metadata=function(){var l=this.obj.ExtendedProperty("Dimensions");if(!l){var u=this.obj.Path.replace(/[\/\\][^\/\\]+$/,""),g=Shell_OBJ.NameSpace(u);l=g.GetDetailsOf(this.obj,26)}return l},Object.defineProperty(this.constructor.prototype,"isFolder",{get:function(){return this.obj.IsFolder}}),Object.defineProperty(this.constructor.prototype,"isFileSystem",{get:function(){return(!ie9_native||!this.obj.IsFolder)&&this.obj.IsFileSystem}}),Object.defineProperty(this.constructor.prototype,"isLink",{get:function(){return this.obj.IsLink}}),Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Shell._FolderItem(this.obj.GetLink)}}),Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.obj.Path}}),Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.obj.Type}}),Object.defineProperty(this.constructor.prototype,"SHFolder",{get:function(){return new System.Shell._Folder(this.obj.GetFolder)}})),this.obj=t},_Folder:function(t){this._constructor_initialized||(this.constructor.prototype._constructor_initialized=!0,Object.defineProperty(this.constructor.prototype,"Items",{get:function(){return new System.Shell._FolderItems(this.obj.Items())}})),this.obj=t},_FolderItems:function(t){this._constructor_initialized||(this.constructor.prototype._constructor_initialized=!0,this.constructor.prototype.item=function(_){return new System.Shell._FolderItem(this.obj.Item(_))},Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.obj.Count}})),this.obj=t}},Debug:{outputString:function(){}},_browser:{init:function(){document.ondragstart=document.onselectstart=function(){return!1},document.onmousedown=function(X){System._browser.onmousedown(X)},document.onmouseup=function(X){System._browser.onmouseup(X)},document.onmousemove=function(X){System._browser.onmousemove(X)},document.onkeydown=function(X){System._browser.onkeydown(X)},WallpaperEngine_CEF_mode&&is_SA_child_animation&&!browser_native_mode||(document.addEventListener("mouseover",function(X){System._browser.onmouseover(X)},!1),document.addEventListener("mouseout",function(X){System._browser.onmouseout_waiting(X)},!1)),Object.defineProperty(document,"onmouseover",{set:function(X){System._browser.onmouseover_custom=X}}),Object.defineProperty(document,"onmouseout",{set:function(X){System._browser.onmouseout_waiting_custom=X}});var t=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.document_body_style_pixelWidth=Object.getOwnPropertyDescriptor(t,"pixelWidth"),this.document_body_style_pixelHeight=Object.getOwnPropertyDescriptor(t,"pixelHeight");var _=function(){if(System._browser.resize_timerID&&clearTimeout(System._browser.resize_timerID),System._browser._window_move_timerID){let X=SA_top_window.getPos();System._browser.resize_timerID=setInterval(function(){var Y=0;return function(){let Z=SA_top_window.getPos(!0);(10<++Y||X[0]!=Z[0]||X[1]!=Z[1])&&(clearInterval(System._browser.resize_timerID),System._browser.resize_timerID=setTimeout("System._browser.resize()",0))}}(),10)}else System._browser.resize_timerID=setTimeout("System._browser.resize()",0)};Object.defineProperty(t,"_set",{get:function(){return _}}),ie9_native&&(Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System._browser.document_body_style_pixelWidth.get.call(this)},set:function(X){this._set(),System._browser.document_body_style_pixelWidth.set.call(this,X)}}),Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System._browser.document_body_style_pixelHeight.get.call(this)},set:function(X){this._set(),System._browser.document_body_style_pixelHeight.set.call(this,X)}})),Object.defineProperty(this,"overlay_mode",function(){var X=0,Z="";return 0,{get:function(){return X},set:function(N){if(N!=X){switch(N){case 2:bg_state_default=LdesktopBG_host.style.display,LdesktopBG_host.style.display="none",Z=document.body.style.backgroundColor,document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden",this.camera.video_host&&(this.camera.video_host.style.visibility="hidden",this.camera.video_host.style.display="none"),document.getElementById("Ldungeon_UI")&&(document.getElementById("Ldungeon_UI").style.visibility="hidden",document.getElementById("Ldungeon_inventory").style.visibility="hidden",document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden");break;default:2==X&&(LdesktopBG.style.backgroundColor=bg_state_default,document.body.style.backgroundColor=Z),Lmenu_host.style.visibility="inherit",this.camera.video_host&&(this.camera.video_host.style.visibility="inherit",this.camera.video_host.style.display="block"),document.getElementById("Ldungeon_UI")&&(document.getElementById("Ldungeon_UI").style.visibility="inherit",document.getElementById("Ldungeon_inventory").style.visibility="inherit",document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden");}document.getElementById("Ldungeon_UI")&&(Ldungeon_inventory.style.posLeft=Ldungeon_inventory_backpack.style.posLeft=(B_content_width-64*MMD_SA_options.Dungeon.inventory.max_base)*(N?1:0.5)),X=N}}}}());var l=is_SA_child_animation&&parent.MMD_SA_options&&parent.MMD_SA_options.child_animation_as_texture;l&&this.onkeydown({keyCode:97+SA_child_animation_id});var u=System.Gadget.Settings.readString("SA_docked");u?System.Gadget.docked=!!parseInt(u):l&&(System.Gadget.docked=!1);var u=document.createElement("div");u.id="Ldrag_dummy";var g=u.style;g.position="absolute",g.posLeft=g.posTop=0,g.zIndex=999,g.border="1px solid rgba(128,128,128,0.5)",g.visibility="hidden",document.body.appendChild(u),this.body=document.getElementById("Lbody_host")||document.body,w3c_mode&&(this.body.style.transition="opacity 0.5s"),this.Opacity=1;var P=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(P){if(!self.SA_wallpaper_src){var M=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.FileExists(M))try{var I=FSO_OBJ.OpenTextFile(M,1);self.SA_wallpaper_src=I.ReadLine(),I.Close()}catch(X){}}if(!self.SA_wallpaper_mask_src){var S=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.FileExists(S))try{var I=FSO_OBJ.OpenTextFile(S,1);self.SA_wallpaper_mask_src=I.ReadLine(),I.Close()}catch(X){}}}P&&(P=System.Gadget.Settings.readString("WallpaperAsBG")||self.SA_wallpaper_src);var E;(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay.use_wallpaper_as_bg||self.EQP_use_wallpaper)&&(E=P=!0);var D,A,C;if(this.Opacity=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.Gadget.Settings.readString("Opacity")||1),is_SA_child_animation&&!self.SA_wallpaper_src&&!E)P=P&&parent.WMP_wallpaper_mask&&parent.use_HTML5&&!parent.System.Gadget.Settings.readString("CSSTransform3D")&&!System.Gadget.Settings.readString("DisableWallpaperMask"),P&&self.EQP_video_options&&EQP_video_options.use_canvas_video&&(P=!1,this.C_WMP_wallpaper_mask_resized=document.createElement("canvas"),this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas"),this.WMPMask_Draw()),this.wallpaper_mask_disabled=!P,P&&(D=parent.WMP_wallpaper_mask);else{var j;if(is_SA_child_animation||(A=System.Gadget.Settings.readString("_screenLeft"),C=System.Gadget.Settings.readString("_screenTop")),A=A?parseInt(A):null,C=C?parseInt(C):null,P){if(w3c_mode&&self.SA_wallpaper_src&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)){var T=document.createElement("video");T.id="VdesktopBG";var B=T.style;B.position="absolute",B.posTop=B.posLeft=0,B.width=parent.screen.width+"px",B.height=parent.screen.height+"px",B.objectFit="cover",LdesktopBG.appendChild(T),T.autoplay=T.loop=!0,T.src=toFileProtocol(SA_wallpaper_src)}this.wallpaper_mask_disabled=WallpaperEngine_CEF_mode||!!System.Gadget.Settings.readString("DisableWallpaperMask");var F,R,W,g=LdesktopBG.style;try{g.pixelWidth=parent.screen.width,g.pixelHeight=parent.screen.height;var G=oShell.RegRead("HKCU\\Control Panel\\Colors\\Background");g.backgroundColor=/^\#/.test(G)?G:"rgb("+G.replace(/\W+/g,",")+")",F="HKCU\\Control Panel\\Desktop\\",R=WallpaperEngine_CEF_mode?oShell.RegRead(F+"Wallpaper")||self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src:self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.RegRead(F+"Wallpaper"),R&&(!this.wallpaper_mask_disabled&&(D=self.SA_wallpaper_mask_src||R.replace(/\.\w{3,4}$/,"_mask.png"),!ValidatePath(D)&&(D=null)),W=oShell.RegRead(F+"WallpaperStyle"),this.updateWallpaper(R,W)),this.moveWallpaper(A||0,C||0),(!is_SA_child_animation||self.SA_wallpaper_src)&&(LdesktopBG_host.style.display="block")}catch(X){console.error(X),LdesktopBG_host.style.display="none"}D?!this.bg_mask&&(this.bg_mask="(blank)"):j=!0}else j=!0;j&&1>this.Opacity&&(w3c_mode||HTA_use_GPU_acceleration)&&(this.body.style.opacity=this.Opacity,DEBUG_show("Opacity:"+100*this.Opacity+"%",2))}if(E&&!D&&(this.bg_mask="(blank)"),P&&(D||this.bg_mask)){var O=document.createElement("canvas");if(O.id="C_wallpaper_mask",O._WallpaperAsBG_custom=E,O.onmousedown=function(){return!1},!is_SA_child_animation||E)try{var K,V=O.width=parent.screen.width,Q=O.height=parent.screen.height,H=O.getContext("2d");this.wallpaper_canvas_update||(this.wallpaper_canvas_update=function(X,Y){if(H.fillStyle=g.backgroundColor,H.fillRect(0,0,V,Q),!X)return self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall&&(CANVAS_Video_Overlay._canvas_wall._match_str=null),void(self.EQP_use_wallpaper&&EQP_ps.forEach(function(N){N.is_wallpaper&&(N.img.img_obj._match_str=null)}));var Z;Z="0"==Y?function(){var te,oe,ae,ie,ne,se,re,_e,N=this.width,$=this.height,J=parent.screen.width,ee=parent.screen.height;J>N?(te=0,ne=(J-N)/2,ae=re=N):(te=(N-J)/2,ne=0,ae=re=J),ee>$?(oe=0,se=(ee-$)/2,ie=_e=$):(oe=($-ee)/2,se=0,ie=_e=ee);var de=C_wallpaper_mask.getContext("2d");if(de.drawImage(this,te,oe,ae,ie,ne,se,re,_e),System._browser.BGMask_Create(!D),!!D){var le=new Image;le.onload=function(){var ce=C_wallpaper_mask.getContext("2d");ce.globalCompositeOperation="destination-in",ce.drawImage(this,te,oe,ae,ie,ne,se,re,_e),C_wallpaper_mask.style.visibility="inherit",DEBUG_show("Use wallpaper mask",2)},le.src=toFileProtocol(D)}}:function(){var te,oe,ae,ie,ne,N=this.width,$=this.height,J=parent.screen.width,ee=parent.screen.height,se=C_wallpaper_mask.getContext("2d");if("6"==Y?(te=Math.max(N/J,$/ee),ie=Math.round((J-N/te)/2),ne=Math.round((ee-$/te)/2),oe=Math.round(N/te),ae=Math.round($/te),se.drawImage(this,0,0,N,$,ie,ne,oe,ae)):(te=Math.min(N/J,$/ee),ie=Math.round((N/te-J)/2*te),ne=Math.round(($/te-ee)/2*te),oe=Math.round(J*te),ae=Math.round(ee*te),se.drawImage(this,ie,ne,oe,ae,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)),System._browser.BGMask_Create(!D),!!D){var re=new Image;re.onload=function(){var _e=C_wallpaper_mask.getContext("2d");_e.globalCompositeOperation="destination-in",_e.drawImage(this,ie,ne,oe,ae),C_wallpaper_mask.style.visibility="inherit",DEBUG_show("Use wallpaper mask",2)},re.src=toFileProtocol(D)}},K&&(K.onload=null),K=new Image,K.onload=Z,K.src=toFileProtocol(X)}),this.wallpaper_canvas_update(R,W),R||setTimeout("System._browser.BGMask_Create(true)",0)}catch(X){}var U=O.style;U.position="absolute",U.posLeft=-(A||0),U.posTop=-(C||0),U.zIndex=60,U.visibility="hidden",document.body.appendChild(O),this.mouseover_hide_list.push(O),is_SA_child_animation&&(this.C_WMP_wallpaper_mask_resized=document.createElement("canvas"),this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas"),this.bg_mask&&System._browser.BGMask_Create(!D),this.WMPMask_Draw())}this._s_left=A,this._s_top=C},updateWallpaper:function(t,_){var u,l=LdesktopBG.style;null==t?t=this._wallpaper_last:(t=decodeURIComponent(t),this._wallpaper_last!=t&&(u=!0,this._wallpaper_last=t,l.backgroundImage=t?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(t)?t:System.Gadget.path+"/"+t)+")":"",this.wallpaper_opacity&&(l.opacity=this.wallpaper_opacity),this.wallpaper_bg_color&&(LdesktopBG_host.style.backgroundColor=this.wallpaper_bg_color)));var g="HKCU\\Control Panel\\Desktop\\";if(null==_&&(_=oShell.RegRead(g+"WallpaperStyle")),this._wallpaper_style!=_&&(u=!0,this._wallpaper_style=_),"0"==_)l.backgroundSize="",l.backgroundPosition="center center",l.backgroundRepeat="0"==oShell.RegRead(g+"TileWallpaper")?"no-repeat":"";else if("2"==_)l.backgroundSize="100% 100%",l.backgroundPosition="",l.backgroundRepeat="";else if("6"==_)l.backgroundSize="contain",l.backgroundPosition="center center",l.backgroundRepeat="no-repeat";else if(l.backgroundSize="cover",l.backgroundPosition="center center",l.backgroundRepeat="no-repeat",browser_native_mode?(l.width="100%",l.height="100%"):(l.pixelWidth=parent.screen.width,l.pixelHeight=parent.screen.height),windows_mode&&t){var P=loadImageDim(/^(\/|[\w\-]+\:)/.test(t)?t:System.Gadget.path+toLocalPath("\\")+t);if(P.w){var M=parent.screen.width/parent.screen.height,I=(2*parent.screen.width-parent.screen.availWidth)/(2*parent.screen.height-parent.screen.availHeight),S=P.w/P.h;S<M?l.pixelHeight=S<I?2*parent.screen.height-parent.screen.availHeight:Math.round(parent.screen.width/S):S>M&&(l.pixelWidth=S>I?2*parent.screen.width-parent.screen.availWidth:Math.round(parent.screen.height*S))}}this.wallpaper_canvas_update&&u&&(this.wallpaper_canvas_update(t,_),DEBUG_show("(Wallpaper canvas updated)",2))},WMPMask_Draw:function(t){if(this.C_WMP_wallpaper_mask_resized&&(t||(t=parent.SL),t&&t.width)){var _=document.body.style,l=_.pixelWidth,u=_.pixelHeight;if(l){var g=0,P=0,M=t.width,I=t.height,S=this.C_WMP_wallpaper_mask_resized;if(S.width!=M){S.width=M,S.height=I;var E=parent.C_WMP_wallpaper_mask;S.getContext("2d").drawImage(E,0,0,E.width,E.height,0,0,M,I)}var D=this.bg_mask_image_resized;if(D&&D.width!=l){D.width=l,D.height=u;var A=this.bg_mask_image;D.getContext("2d").drawImage(A,0,0,A.width,A.height,0,0,l,u)}var l,u;l=self.B_content_width?B_content_width:document.body.style.pixelWidth,u=self.B_content_height?B_content_height:document.body.style.pixelHeight;var C=parent.SA_child_animation[SA_child_animation_id],j=C.x,T=C.y;is_SA_child_animation&&parent.EQP_border_width&&(j-=parent.EQP_border_width,T-=parent.EQP_border_width);var B=j-g,F=B;0>B&&(B=0),F=0>F?-F:0;var R=T-P,W=R;0>R&&(R=0),W=0>W?-W:0;var G=M+g-j;G>l&&(G=l);var O=I+P-T;O>u&&(O=u);var V=this.C_WMP_wallpaper_mask_mixed_resized;if(V.width!=l||V._x!=B||V._y!=R){V.width=l,V.height=u;var Q=V.getContext("2d");Q.drawImage(S,B,R,G,O,F,W,G,O),D&&Q.drawImage(D,0,0),V._x=B,V._y=R}var H=document.getElementById("C_wallpaper_mask");if(H){H.width=l,H.height=u;var Q=H.getContext("2d");Q.globalCompositeOperation="copy",Q.drawImage(t,B,R,G,O,F,W,G,O),Q.globalCompositeOperation="destination-in",Q.drawImage(V,0,0)}}}},BGMask_CreateCanvas:function(t,_){if(!t)return null;if(!/^\((.+)\)$/.test(t))return null;var g,l=RegExp.$1.split("|"),u=l[0];if("circle"==u){var P=parseInt(l[1]),M=parseInt(l[2]);g=document.createElement("canvas"),g.width=P,g.height=M;var I=P<M?P:M,S=g.getContext("2d");S.beginPath(),S.arc(P/2,M/2,I/2,0,2*Math.PI),S.fill()}else if("feather"==u){var P=parseInt(l[1]),M=parseInt(l[2]),E=parseInt(l[3]);E||(E=parseInt(Math.sqrt(P*P+M*M)/25)),g=document.createElement("canvas"),g.width=P,g.height=M;var D,S=g.getContext("2d");_?D=S.createImageData(P,M):(S.fillRect(0,0,P,M),D=S.getImageData(0,0,P,M));for(var A=D.data,C=3,j=A.length;C<j;C+=4){var T=(C-3)/4,B=T%P,F=parseInt(T/P),R=1.2,W=1;B<E?W=(B+1)/(E+1):B>=P-E&&(W=(P-B)/(E+1)),W=1-(1-W)*R,0>W&&(W=0);var G=1;F<E?G=(F+1)/(E+1):F>=M-E&&(G=(M-F)/(E+1)),G=1-(1-G)*R,0>G&&(G=0);var O=W<G?W:G;if(1!=O){if(1>W&&1>G){var V=1-W,Q=1-G,H=V>Q?Q/V:V/Q,K=Math.sqrt(1+H*H);O=1-(1-O)*K,0>O&&(O=0)}A[C]=_?Math.round(255*(1-O)):Math.round(255*O)}}S.putImageData(D,0,0)}return g},BGMask_Create:function(t){var _=this.bg_mask;if(_){if(t)this.wallpaper_canvas=C_wallpaper_mask,C_wallpaper_mask.style.display="none";else{var l=this.wallpaper_canvas=document.createElement("canvas");is_SA_child_animation||(l.width=parent.screen.width,l.height=parent.screen.height,l.getContext("2d").drawImage(C_wallpaper_mask,0,0))}if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall&&(CANVAS_Video_Overlay._canvas_wall._match_str=null),self.EQP_use_wallpaper&&EQP_ps.forEach(function(g){g.is_wallpaper&&g.img&&(g.img.img_obj._match_str=null)}),/^\((.+)\)$/.test(_))return this.bg_mask_image=this.BGMask_CreateCanvas(_,is_SA_child_animation),void this.BGMask_onload();var u=this.bg_mask_image=new Image;u.onload=this.BGMask_onload,u.src=toFileProtocol(_)}},BGMask_onload:function(){var t=document.getElementById("C_BG_mask");if(!t){t=document.createElement("canvas"),t.id="C_BG_mask";var _=t.style;_.position="absolute",_.posTop=_.posLeft=0,_.zIndex=61,document.body.appendChild(t)}-1==System._browser.mouseover_hide_list.indexOf(t)&&System._browser.mouseover_hide_list.push(t),is_SA_child_animation?System._browser.bg_mask_image_resized=document.createElement("canvas"):System._browser.BGMask_Draw()},BGMask_Draw:function(t){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom))return void this.WMPMask_Draw();if(document.getElementById("C_BG_mask")){var _,l,u,g;_=u=self.B_content_width?B_content_width:document.body.style.pixelWidth,l=g=self.B_content_height?B_content_height:document.body.style.pixelHeight,u>parent.screen.width&&(u=parent.screen.width),g>parent.screen.height&&(g=parent.screen.height);var P,M,I,S,E=C_wallpaper_mask.style;if(0<E.posLeft?(P=0,I=E.posLeft):(P=-E.posLeft,I=0),0<E.posTop?(M=0,S=E.posTop):(M=-E.posTop,S=0),t){var D=P+","+M+","+u+","+g+","+I+","+S+","+u+","+g;if(t._match_str==D)return;t._match_str=D,t.width=_,t.height=l;var A=t.getContext("2d");return A.globalCompositeOperation="copy",void A.drawImage(this.wallpaper_canvas,P,M,u,g,I,S,u,g)}if(!this.bg_mask_image&&1==this.Opacity)return void(document.getElementById("C_BG_mask").style.display="none");C_BG_mask.width=_,C_BG_mask.height=l;var A=C_BG_mask.getContext("2d");A.globalCompositeOperation="copy",A.globalAlpha=this.bg_mask_image?1:1-this.Opacity,A.drawImage(this.wallpaper_canvas,P,M,u,g,I,S,u,g),this.bg_mask_image?(A.globalCompositeOperation="destination-out",A.globalAlpha=this.Opacity,A.drawImage(this.bg_mask_image,0,0,u,g)):C_BG_mask.style.display="block"}},resize_timerID:null,resize_cooling_timestamp:0,resize:function(){function t(){_||(_=!0,setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0))}var _=!1;return function(){if(this.resize_timerID=null,use_SA_browser_mode){let l=document.body.style;if(is_SA_child_animation){let u=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;u.width=l.pixelWidth+"px",u.height=l.pixelHeight+"px",t()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.System._browser.capturePage_in_process)return void(this.resize_timerID=setTimeout("System._browser.resize()",50));webkit_electron_mode&&(System._browser.resize_cooling_timestamp=performance.now()),SA_top_window.resizeToAbsolute(l.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),l.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}t()}}}}(),drag_mouse_x:-1,drag_mouse_y:-1,drag_timerID:null,is_dragging:!1,mouseout_timerID:null,mouseover_hide_list:[],onmouseover_custom:null,onmouseover:function(t){if(!(webkit_electron_mode&&(SA_topmost_window.returnBoolean("IgnoreMouseEvents")||SA_topmost_window.returnBoolean("AutoItStayOnDesktop"))&&!SA_topmost_window.webkit_IgnoreMouseEvents_disabled)&&!(this.onmouseover_custom&&this.onmouseover_custom(t))){this.mouseout_timerID&&(clearTimeout(this.mouseout_timerID),this.mouseout_timerID=null);for(var _=this.mouseover_hide_list,l=0;l<_.length;l++)_[l].style.visibility="hidden"}},onmouseout_waiting_custom:null,onmouseout_waiting:function(t){if(!(this.onmouseout_waiting_custom&&this.onmouseout_waiting_custom(t))){this.mouseout_timerID&&(clearTimeout(this.mouseout_timerID),this.mouseout_timerID=null);var _=t.clientX,l=t.clientY,u=document.body.style,g=0<_&&_<u.pixelWidth&&0<l&&l<u.pixelHeight;w3c_mode&&t.stopPropagation(),this.mouseout_timerID=setTimeout("System._browser.onmouseout("+g+")",200)}},onmouseout:function(t){if(this.mouseout_timerID=null,this.drag_timerID&&(clearTimeout(this.drag_timerID),this.drag_timerID=null),this.is_dragging?(this.is_dragging=!1,t=!1,this.showFocus(!1),System.Gadget.Settings._writeSettings(!0,!0)):is_SA_child_animation&&parent.System._browser.is_dragging&&(parent.System._browser.is_dragging=!1,this.showFocus(!1)),!t){for(var _=this.mouseover_hide_list,l=0;l<_.length;l++)_[l].style.visibility="inherit";this.BGMask_Draw()}},onmousedown:function(t){this.drag_timerID&&(clearTimeout(this.drag_timerID),this.drag_timerID=null);for(var g,_=this.mouseover_hide_list,l=!0,u=0;u<_.length;u++)g=_[u].style,"hidden"!=g.visibility&&(g.visibility="hidden",l=!1);var P;if(!l&&!is_SA_child_animation&&SA_child_animation_max)for(var u=0;u<SA_child_animation_max;u++)if(SA_child_animation[u]){P=!0;break}if(l=!P,l){var M,I;WallpaperEngine_mode?(M=t.x,I=t.y):absolute_screen_mode?(M=SA_top_window.getCursorPos().x,I=SA_top_window.getCursorPos().y):(M=t.screenX,I=t.screenY),is_SA_child_animation&&parent.returnBoolean("ChildDragDisabled")&&!1||(this.drag_timerID=setTimeout("System._browser.onmousedown_dragStart("+M+","+I+")",200))}else DEBUG_show("(focused)",1)},showFocus:function(t,_){if(!is_SA_child_animation||xul_mode&&this.is_dragging||parent.System._browser.showFocus(t),!t)return void(Ldrag_dummy.style.visibility="hidden");var l=document.body.style.pixelWidth,u=document.body.style.pixelHeight;if(l&&u){var g=Ldrag_dummy.style;g.pixelWidth=l-2,g.pixelHeight=u-2,g.visibility="inherit"}_&&DEBUG_show("(selected)",1)},arrangeChildZ:function(t){System.Gadget.Settings._settings_need_update=!0;for(var _=[],l=0;l<SA_child_animation_max;l++)SA_child_animation[l]&&(_[l]={index:l,z:SA_child_animation[l].z});_.sort(function(u,g){return u.index==t?1:g.index==t?-1:u.z-g.z}).forEach(function(u,g){SA_child_animation[u.index].z=document.getElementById("Ichild_animation"+u.index).style.zIndex=g})},_child_selected:null,_drag_disabled:!1,_child_drag_disabled:!1,onmousedown_dragStart:function(t,_){return this.drag_timerID=null,WallpaperEngine_mode?void 0:is_SA_child_animation&&is_SA_child_animation_host?(parent.System._browser.is_dragging=!0,parent.System._browser.drag_mouse_x=t,parent.System._browser.drag_mouse_y=_,DEBUG_show("drag start",1),void this.showFocus(!0)):void(!this._drag_disabled&&(!is_SA_child_animation||!parent.System._browser._child_drag_disabled)&&(this.is_dragging=!0,this.drag_mouse_x=t,this.drag_mouse_y=_,DEBUG_show("drag start",1)),this.showFocus(!0),is_SA_child_animation&&parent.System._browser.arrangeChildZ(SA_child_animation_id))},_BL_clicked:0,_BL_clicked_max:1,_BL_clicked_timerID:null,onmouseup_custom:null,onmouseup:function(t){if(!(this.onmouseup_custom&&this.onmouseup_custom(t)))return(this.onmouseout(!0),(this._drag_disabled||is_SA_child_animation&&parent.System._browser._child_drag_disabled)&&this.showFocus(!1),!(20<t.clientX||t.clientY<document.body.style.pixelHeight-20))?(this._BL_clicked_timerID&&(clearTimeout(this._BL_clicked_timerID),this._BL_clicked_timerID=null),++this._BL_clicked<this._BL_clicked_max?void(this._BL_clicked_timerID=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250)):void(this._BL_clicked=0,!WallpaperEngine_mode&&(!self.Lquick_menu||!Lquick_menu._activated)&&this.confirmClose())):void 0},confirmClose:function(t){if(browser_native_mode)return void(confirm("This will reload System Animator.")&&SA_topmost_window.location.reload());if(!t||xul_mode){System._browser.showFocus(!0,!0);is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.is_SA_hosted){if(confirm("Close "+SystemEXT._default.gadget_name+" (XUL host)?"))return void SA_top_window.opener.close()}System._browser.showFocus(!1)}if(!is_SA_child_animation)WallpaperEngine_CEF_mode&&!W8_or_above?SA_top_window.location.reload():SA_top_window.close();else if(is_SA_child_animation_host)parent.System._browser.confirmClose(t);else{parent.System.Gadget.Settings._settings_need_update=!0,parent.SA_child_animation[SA_child_animation_id]=null;var l=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);l.style.pixelWidth=l.style.pixelHeight=0,l.style.visibility="hidden",l.contentWindow.location.replace("z_blank.html")}},onSettings:function(){if(!System.Gadget.settingsUI)return!1;if(use_inline_dialog)return"hidden"==document.getElementById("Idialog").style.visibility&&document.getElementById("Idialog").contentWindow.location.replace("settings.html"),!0;System._browser.showFocus(!0,!0);var t=showModalDialog(System.Gadget.settingsUI,self);return t=xul_mode?self.returnValue:t,System._browser.showFocus(!1),this.onSettingsClosed(t),!0},onSettingsClosed:function(t){System.Gadget.onSettingsClosed&&System.Gadget.onSettingsClosed({closeAction:!!t,Action:{commit:!0}})},onkeydown:function(t){var _=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host,l=t.keyCode;if(67==l)return this.confirmClose(),!0;if(69==l)return this.onSettings();if(79==l){var u;if(is_SA_child_animation){var g=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;u=this.Opacity,"_opacity_"in t?u=t._opacity_:(u-=0.25,0.25>u&&(u=1)),parent.System.Gadget.Settings._settings_need_update=!0,parent.SA_child_animation[SA_child_animation_id].opacity=u,g.opacity=u}else if(this.bg_mask)u=this.Opacity,"_opacity_"in t?u=t._opacity_:(u-=0.25,0.25>u&&(u=1)),System.Gadget.Settings.writeString("Opacity",u),this.Opacity=u,this.BGMask_Draw();else if(w3c_mode||HTA_use_GPU_acceleration){var g=this.body.style;u=this.Opacity,"_opacity_"in t?u=t._opacity_:(u-=0.25,0.25>u&&(u=1)),System.Gadget.Settings.writeString("Opacity",u),g.opacity=u}else return!1;return this.Opacity=u,DEBUG_show("Opacity:"+100*u+"%",2),this.update_tray(),!0}if(83==l){var P=System.Gadget.docked?System.Gadget.onUndock:System.Gadget.onDock;return!!P&&(setTimeout(System._browser.ondockundock,0),!0)}if(_&&49<=l&&l<49+SA_child_animation_max){var M=l-49,I=is_SA_child_animation?parent:self,S=I.document.getElementById("Ichild_animation"+M);if(!S||!S.contentWindow.is_SA_child_animation)return DEBUG_show("(child animation "+(M+1)+" not found)",2),!0;var E=S.contentWindow,D=E.parent,A=D.System._browser;if(E.System.Gadget.Settings.readString("CSSTransform3D")||D.System.Gadget.Settings.readString("CSSTransform3D")){if(A._child_selected==M)return A._child_selected=null,E.DEBUG_show("(deselected)",2),D.DEBUG_show("(child"+(M+1)+" deselected)",2),!0;A._child_selected=M}return E.DEBUG_show("(selected)",2),D.DEBUG_show("(child"+(M+1)+" selected)",2),A.arrangeChildZ(M),E.focus(),!0}if(_&&96==l){var I=is_SA_child_animation?parent:self,g=I.Lchild_animation_parent.style;return g.visibility="hidden"==g.visibility?"visible":"hidden",webkit_mode&&(g.display="hidden"==g.visibility?"none":"block"),I.System._browser._child_selected=null,!0}if(_&&97<=l&&l<97+SA_child_animation_max){var M=l-97,I=is_SA_child_animation?parent:self,S=I.document.getElementById("Ichild_animation"+M);if(!S||!S.contentWindow.is_SA_child_animation)return DEBUG_show("(child animation "+(M+1)+" not found)",2),!0;var g=S.style;g.visibility="hidden"==g.visibility?"visible":"hidden",webkit_mode&&(g.display="hidden"==g.visibility?"none":"block"),I.System._browser._child_selected=null;for(var S,C=!1,j=0;j<SA_child_animation_max;j++)if(S=I.document.getElementById("Ichild_animation"+j),S&&S.contentWindow.is_SA_child_animation&&"hidden"!=S.style.visibility){C=!0;break}return I.document.getElementById("Lchild_animation_parent").style.visibility=C?"visible":"hidden",!0}if(96<=l&&106>l&&self.MMD_SA&&MMD_SA_options.motion_shuffle&&MMD_SA.use_jThree&&MMD_SA.MMD_started){if(this.camera.ML_enabled);else if(96==l)MMD_SA_options._motion_shuffle&&(!MMD_SA_options.motion_shuffle_list_default&&MMD_SA_options._motion_shuffle_list_default?(MMD_SA_options.motion_shuffle_list_default=MMD_SA_options._motion_shuffle_list_default.slice(),MMD_SA._force_motion_shuffle=!0):(MMD_SA_options.motion_shuffle=MMD_SA_options._motion_shuffle.slice(0),MMD_SA_options.motion_shuffle_list_default=null,MMD_SA._force_motion_shuffle=!0,DEBUG_show("(MMD motions shuffled)",2)));else{var M=l-97;if(MMD_SA_options.motion_by_song_name){if(MMD_SA_options.motion_by_song_name._loading_)return DEBUG_show("(music/motion loading)",2),!0;let T=Object.keys(MMD_SA_options.motion_by_song_name).find(B=>{return MMD_SA_options.motion_by_song_name[B].key==M+1});if(T){let B=MMD_SA_options.motion_by_song_name[T].song_path;if(/\.zip\#/i.test(B)){MMD_SA_options.motion_by_song_name._loading_=!0,B=B.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let F=new self.XMLHttpRequestZIP;F.onload=function(){MMD_SA_options.motion_by_song_name._loading_=!1;let R=this.response;R.name=B.replace(/^.+[\/\\]/,""),R.isFileSystem=!0,SA_DragDropEMU(R)},F.open("GET",B,!0),F.responseType="blob",F.send()}else SA_DragDropEMU(B);return!0}}if(M>=MMD_SA.normal_action_length)return DEBUG_show("(MMD motion not found)",2),!0;MMD_SA_options._motion_shuffle||(MMD_SA_options._motion_shuffle=MMD_SA_options.motion_shuffle.slice(0)),MMD_SA_options.motion_shuffle=[M],MMD_SA_options.motion_shuffle_list_default=null,MMD_SA._force_motion_shuffle=!0,DEBUG_show("(MMD motion changed)",2)}return!0}return!1},ondockundock:function(){DEBUG_show("Dock state changed",2);var t=!System.Gadget.docked;System.Gadget.docked=t,System.Gadget.Settings.writeString("SA_docked",!!t==!!is_SA_child_animation?"":t?"1":"0");var _=t?System.Gadget.onDock:System.Gadget.onUndock;_&&_()},onmousemove_custom:null,onmousemove:function(t){var _,l;if((WallpaperEngine_mode||browser_native_mode)&&(_=this._WE_mouse_x=t.x,l=this._WE_mouse_y=t.y),!(this.onmousemove_custom&&this.onmousemove_custom(t))){if(!this.is_dragging)return void(is_SA_child_animation&&parent.System._browser.is_dragging&&parent.System._browser.onmousemove(t));if(WallpaperEngine_mode||(absolute_screen_mode?(_=SA_top_window.getCursorPos().x,l=SA_top_window.getCursorPos().y):(_=t.screenX,l=t.screenY)),is_SA_child_animation||null!=this._child_selected){var u,g,P;is_SA_child_animation?(P=SA_child_animation_id,u=self,g=parent):(P=this._child_selected,u=document.getElementById("Ichild_animation"+P).contentWindow,g=self),g.System.Gadget.Settings._settings_need_update=!0;var M=g.SA_child_animation[P],I=g.document.getElementById("Ichild_animation"+P).style,S=u.document.body.style,E=g.document.body.style,D=M.x+_-this.drag_mouse_x,A=M.y+l-this.drag_mouse_y;I.posLeft=M.x=D,I.posTop=M.y=A,u.document.getElementById("Ldebug").innerText=g.document.getElementById("Ldebug").innerText="(moving)",u.DEBUG_hide_sec=g.DEBUG_hide_sec=0,u.DEBUG_show("("+D+","+A+")",2)}else System.Gadget.Settings._settings_need_update=!0,this.moveBy(_-this.drag_mouse_x,l-this.drag_mouse_y,t);this.moveWallpaper(),this.drag_mouse_x=_,this.drag_mouse_y=l}},moveWallpaper:function(t,_){if((!is_SA_child_animation||document.getElementById("C_wallpaper_mask")&&C_wallpaper_mask._WallpaperAsBG_custom)&&(is_SA_child_animation||document.getElementById("LdesktopBG")&&"none"!=LdesktopBG.style.display)){if(WallpaperEngine_mode)t=0,_=0;else if(absolute_screen_mode){null==t&&(t=SA_top_window.screenLeftAbsolute),null==_&&(_=SA_top_window.screenTopAbsolute);var l=SA_top_window.getScreenBounds(t,_);t=-(t-l.x),_=-(_-l.y)}else null==t&&(t=SA_top_window.screenLeft),null==_&&(_=SA_top_window.screenTop),t=-(t%parent.screen.width),_=-(_%parent.screen.height);if(is_SA_child_animation){var u=parent.SA_child_animation[SA_child_animation_id];t-=u.x,_-=u.y}else{var g=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;g.posLeft=t,g.posTop=_}if(document.getElementById("C_wallpaper_mask")){var P=C_wallpaper_mask.style;P.posLeft=t,P.posTop=_}}},moveBy:function(t,_){SA_top_window.moveByAbsolute(t,_)},update_tray:function(t){try{if(!webkit_electron_mode||IPC.active_window!=self)return;if(this._tray_last_updated==RAF_timestamp)return;if(this._tray_last_updated=RAF_timestamp,!t){t={active_window_id:IPC.active_window_id,click_thru:SA_topmost_window.returnBoolean("IgnoreMouseEvents"),click_thru_partial:SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial"),always_on_top:SA_topmost_window.returnBoolean("AutoItAlwaysOnTop"),stay_on_desktop:SA_topmost_window.returnBoolean("AutoItStayOnDesktop"),auto_pause:SA_topmost_window.returnBoolean("AutoItAutoPause"),opacity:is_SA_child_animation?parent.SA_child_animation[SA_child_animation_id].opacity:parseFloat(System.Gadget.Settings.readString("Opacity")||1),opacity_on_hover:parseFloat(System.Gadget.Settings.readString("OpacityOnHover")||1),size:Settings.CSSTransformFullscreen?-1:Settings.CSSTransformScale,animation_path:Settings.f_path_folder,media_control:self.SL&&SL._mouse_event_main&&SL._mouse_event_main(),MMD:null,Facebook:{enabled:!!self.use_Facebook_API}};for(var _=[!0],l=0;l<SA_child_animation_max;l++)_.push(!!SA_topmost_window.SA_child_animation[l]);t.active_window=_,t.lock_child_dragging=returnBoolean("ChildDragDisabled");var u=this.tray_menu_custom;if(u?(t.custom_menu_para=u.para,u.update_tray&&u.update_tray(t)):t.custom_menu_para={},self.MMD_SA&&MMD_SA._tray_updatable){var g=MMD_SA_options.MME,P=t.MMD={use_webgl2:!!MMD_SA.use_webgl2,look_at_camera:!!MMD_SA_options._look_at_screen,look_at_mouse:!!MMD_SA_options._look_at_mouse,trackball_camera:!!returnBoolean("MMDTrackballCamera"),random_camera:!!returnBoolean("MMDRandomCamera"),random_camera_available:!!MMD_SA_options.use_random_camera,override_default_for_external_model:!!returnBoolean("MMDOverrideDefaultForExternalModel"),light:{},MME:{self_overlay:{},HDR:{},serious_shader:{},SAO:{},PostProcessingEffects:{}}};P._material_list=MMD_SA._material_list||[],MMD_SA._model_list&&(P._model_list=MMD_SA._model_list,MMD_SA._model_list=null);var M=jThree("#MMD_DirLight").three(0),I=M.color;P.light.color=[Math.min(255,parseInt(256*I.r)),Math.min(255,parseInt(256*I.g)),Math.min(255,parseInt(256*I.b))],P.light.position=M.position.clone().sub(MMD_SA_options.MMD_disabled&&{x:0,y:0,z:0}||THREE.MMD.getModels()[0].mesh.position).multiplyScalar(1/MMD_SA_options.light_position_scale).toArray(),P.shadow_darkness=MMD_SA_options.shadow_darkness,Object.assign(P.MME.self_overlay,g.self_overlay),Object.assign(P.MME.HDR,g.HDR),Object.assign(P.MME.serious_shader,g.serious_shader),Object.assign(P.MME.SAO,g.SAO);var S=MMD_SA_options.MME.PostProcessingEffects,E=P.MME.PostProcessingEffects;E.enabled=returnBoolean("Use3DPPE")||(MMD_SA_options.PPE_disabled_on_idle?!!MMD_SA_options._PPE_enabled:!!S.enabled),E.use_SAO=!!S.use_SAO,E.use_Diffusion=!!S.use_Diffusion,E.use_BloomPostProcess=!!S.use_BloomPostProcess,E.use_BloomPostProcess_blur_size=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessBlurSize")||0.5),E.use_BloomPostProcess_threshold=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessThreshold")||0.5),E.use_BloomPostProcess_intensity=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessIntensity")||0.5),P.MME_saved=!!MMD_SA_options.MME_saved[MMD_SA_options.model_para_obj._filename]}t.apply_to_child=document.getElementById("Lchild_animation_parent")?returnBoolean("CSSTransformToChildAnimation"):null}webkit_electron_remote.getGlobal("update_tray")(t)}catch(D){console.error(D)}},load_file:function(t,_,l){l||(l="blob");var u=!(self.MMD_SA&&MMD_SA.fn);u&&(MMD_SA_options.load_length_extra=(MMD_SA_options.load_length_extra||0)+1);var g;g=/\.zip\#/i.test(t)||"blob"!=l||"function"==typeof _?function(){var P=new XMLHttpRequestZIP;P.onload=function(){u&&MMD_SA.fn.setupUI(),"function"==typeof _?_(P):_.src=URL.createObjectURL(this.response),P=void 0},P.open("GET",toFileProtocol(t),!0),P.responseType=l,P.send()}:function(){if(u){var P=function(){MMD_SA.fn.setupUI(),_.removeEventListener("load",P)};_.addEventListener("load",P)}_.src=toFileProtocol(t)},self.XMLHttpRequestZIP?g():window.addEventListener("jThree_ready",function(){g()})},on_animation_update:function(){var t=[[],[]],_=0;return{add:function(l,u,g,P){t[g].push({func:l,frame_count:u+g,loop:P,index:_++})},remove:function(l,u){t[u].forEach(g=>{g.func==l&&(g.canceled=!0)})},run:function(l){var g=t[l];if(g.length){var P=[];g.forEach(function(M){M.canceled||(0<=--M.frame_count?P.push(M):(M.func(),M.loop&&0!=--M.loop&&P.push(M)))}),t[l]=P}}}}(),get css_scale(){return 2<=window.devicePixelRatio?0.5:1},virtual_numpad_toggle:function(t){null==t&&(t="none"==Lnumpad_row0.style.display),Lnumpad_row0.style.display=t?"inline":"none",Lnumpad_rows.style.display=t?"block":"none",t&&self.ChatboxAT&&ChatboxAT.chatW_minimize(0,!0)},virtual_numpad:function(){var t={};return function(_,l){_.preventDefault(),_.stopPropagation();var M,u=MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.character.combat_mode,g=_.target.textContent,P=t[g]=t[g]||{};switch(g){case"S":M=16,P.pressed=!P.pressed,l=P.pressed?"keydown":"keyup";break;case"+":if(M=107,u){if("keyup"==l)return;P.pressed=!P.pressed,l=P.pressed?"keydown":"keyup"}break;case"-":M=109;break;case"*":M=106;break;case"/":M=111;break;case"\u23CE":M=13;break;case"J":M=32;break;case"\u2191":M=38;break;case"\u2193":M=40;break;case"\u2190":M=37;break;case"\u2192":M=39;break;default:M=parseInt(g)+96;}P.timeoutID&&clearTimeout(P.timeoutID),P.intervalID&&clearTimeout(P.intervalID),P.timeoutID=P.intervalID=null;let S=new KeyboardEvent(l,{bubbles:!0,cancelable:!0,key:g,keyCode:M,shiftKey:t.S&&t.S.pressed});document.dispatchEvent(S),"keydown"==l?/[\+S]/.test(g)&&("+"!=g||u)?_.target.style.opacity="0.75":P.timeoutID=setTimeout(function(){P.intervalID=setInterval(function(){document.dispatchEvent(S)},100)},400):_.target.style.opacity=""}}(),P2P_network:function(){function t(I,S){this._connection=S,this.status="connecting",I.connections[S.label]=this;var E=this;S.on("data",function(D){D.handshake?I.para.events.connection.handshake_respond(I,E,D.handshake):I.para.events.connection.data(I,E,D)}),S.on("close",function(){console.log("P2P_network: DataConnection("+S.peer+"/"+S.label+"/host) closed"),E.close(I)})}function _(){}function l(I=Object.clone(P)){this.para=I,this.id=null;var S=this._peer=new Peer;this.index=g,this.connections=new _,this.status="connecting";var E=this;S.on("open",function(D){g++,u||(u=E),E.id=D,E.status="connected",console.log("P2P_network: Peer-"+E.index+"("+D+") connected"),E.para.events.peer.open&&E.para.events.peer.open(E)}),S.on("error",function(D){console.log("P2P_network: Peer-"+E.index+" error",D),E.para.events.peer.error_by_connection?(E.para.events.peer.error_by_connection(D),delete E.para.events.peer.error_by_connection):E.para.events.peer.error&&E.para.events.peer.error(E,D)}),S.on("connection",function(D){I.events.peer.connection&&I.events.peer.connection(E,D)||(console.log("P2P_network: Remote Peer("+D.peer+"/"+D.label+"/client) connecting to Peer-"+E.index+"("+E.id+")"),D.on("open",function(){console.log("P2P_network: Remote Peer("+D.peer+"/"+D.label+"/client) connected to Peer-"+E.index+"("+E.id+")"),new t(E,D)}))})}var u,g=0,P={events:{peer:{},connection:{handshake_request:function(I,S){console.log("P2P_network: Remote Peer("+S.peer+"/"+S.label+"/host) responding handshake request from Peer-"+I.index+"("+I.id+")"),S.send({handshake:{request:!0}})},handshake_respond:function(I,S,E){E.request?(S.status="connected",console.log("P2P_network: Remote Peer("+S.peer+"/"+S.label+"/client)'s handshake request accepted from Peer-"+I.index+"("+I.id+")"),S.send({handshake:{accepted:!0}})):E.accepted?(S.status="connected",console.log("P2P_network: Remote Peer("+S.peer+"/"+S.label+"/host) accepted handshake request from Peer-"+I.index+"("+I.id+")"),I.para.events.connection.handshake_request_accecpted&&I.para.events.connection.handshake_request_accecpted[S.label]&&(I.para.events.connection.handshake_request_accecpted[S.label]({peer:I,connection:S,handshake:E}),delete I.para.events.connection.handshake_request_accecpted[S.label])):(console.log("P2P_network: Remote Peer("+S.peer+"/"+S.label+"/host) rejected handshake request from Peer-"+I.index+"("+I.id+")"),I.para.events.connection.handshake_request_rejected&&I.para.events.connection.handshake_request_rejected[S.label]&&(I.para.events.connection.handshake_request_rejected[S.label]({peer:I,connection:S,handshake:E}),delete I.para.events.connection.handshake_request_rejected[S.label]))},data:function(){}},send_message:function(I){return I.command||M.content_window.ChatboxAT.ChatShow([I.name+": "+I.msg]),null}}};t.prototype.send=function(I){this._connection.send(I)},t.prototype.close=function(I){if(I.connections[this.label]&&!(I.para.events.connection.close&&I.para.events.connection.close(I,this))){delete I.connections[this.label];var S=this;setTimeout(function(){S._connection.close(),S._connection=null},1e3)}},Object.defineProperty(t.prototype,"peer",{get:function(){return this._connection.peer}}),Object.defineProperty(t.prototype,"label",{get:function(){return this._connection.label}}),Object.defineProperty(_.prototype,"length",{get:function(){return Object.keys(this).length}}),l.prototype.connect=function(I){var E=this;return new Promise(function(D,A){var C=function(){var T=E._peer.connect(I,{serialization:"json"});T.on("open",function(){console.log("P2P_network: Remote Peer("+T.peer+"/"+T.label+"/host) connecting to Peer-"+E.index+"("+E.id+")");var B=new t(E,T);E.para.events.connection.handshake_request(E,B),E.para.events.connection.handshake_request_accecpted=E.para.events.connection.handshake_request_accecpted||{},E.para.events.connection.handshake_request_rejected=E.para.events.connection.handshake_request_rejected||{},E.para.events.connection.handshake_request_accecpted[T.label]=D,E.para.events.connection.handshake_request_rejected[T.label]=A,delete E.para.events.peer.error_by_connection}),T.on("error",function(B){console.log("P2P_network: Remote connection failed",B),A(B)}),E.para.events.peer.error_by_connection=A};switch(E.status){case"connected":C();break;default:setTimeout(function(){A(E)},0);}})};var M={peer:l,get peer_default(){return u},status:"off",get content_window(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},process_message:function(I,S){var E=this.peer_default;if(!E)return I;var B,D=this.content_window.document.getElementById("Flogin").id.value,A=this.content_window.document.getElementById("Flogin").pass.value,C=this.content_window.MMD_SA_options,j=(D||C&&C.model_para_obj.character&&C.model_para_obj.character.name||"Anonymous").substring(0,16),T=E&&E.connections.length;if(!/^\//.test(I))B=E.para.events.send_message({name:j,msg:I,id:D,pass:A});else{var F,R,W,G=this.content_window.ChatboxAT.checkChatCommand(I);F=G.command,R=G.para1,W=G.para2,B=E.para.events.send_message({name:j,msg:I,command:F,para1:R,para2:W,id:D,pass:A})}return S||(this.content_window.document.getElementById("Fchat").msg.value=""),null==B?I:B}};return M}(),camera:function(){(()=>{var Ge=_asyncToGenerator(function*(){if(oe=!0,null==MMD_SA_options.model_para_obj.left_arm_z_rot){let Ve=THREE.MMD.getModels()[0],Qe=Ve.mesh.bones_by_name,He=Qe.左腕.pmxBone.origin,Ke=Qe.左ひじ.pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_z_rot=Math.PI/2+Math.atan2(Ke[1]-He[1],Ke[0]-He[0]);let Ue=Qe.左腕ＩＫ.pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_to_IK_xy=[He[0]-Ue[0],He[1]-Ue[1]],MMD_SA_options.model_para_obj.left_arm_length=Math.sqrt(MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]*MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]+MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]);let Xe=Qe.右腕.pmxBone.origin;MMD_SA_options.model_para_obj.shoulder_width=Math.abs(He[0]-Xe[0]),MMD_SA_options.model_para_obj.arm_axis={左:new THREE.Vector3().fromArray(Ue).sub(MMD_SA.TEMP_v3.fromArray(He)).normalize()},MMD_SA_options.model_para_obj.arm_axis.右=MMD_SA_options.model_para_obj.arm_axis.左.clone().setX(-MMD_SA_options.model_para_obj.arm_axis.左.x),MMD_SA_options.model_para_obj.hip_center=new THREE.Vector3().fromArray(Qe.左足.pmxBone.origin).setX(0),MMD_SA_options.model_para_obj.spine_length=Qe.首.pmxBone.origin[1]-MMD_SA_options.model_para_obj.hip_center.y,MMD_SA_options.model_para_obj.left_heel_height=Qe.左足首.pmxBone.origin[1],MMD_SA_options.model_para_obj.left_leg_length=MMD_SA._v3a.fromArray(Qe.左足.pmxBone.origin).distanceTo(MMD_SA._v3b.fromArray(Qe.左足ＩＫ.pmxBone.origin));let Ye=["\u5DE6","\u53F3"];Ae={1:{},"-1":{}},Ye.forEach(function(Ze){["\u8155","\u3072\u3058"].forEach(function(Ne){let tt,ot,Je="\u5DE6"==Ze?1:-1,et=Ze+Ne,at=Qe[et].pmxBone.end;tt="number"==typeof at?MMD_SA._v3a.fromArray(Ve.mesh.bones[at].pmxBone.origin).sub(se.fromArray(Qe[et].pmxBone.origin)).normalize():MMD_SA._v3a.fromArray(at).normalize(),ot=MMD_SA._v3b.set(0,0,-1).applyQuaternion(re.setFromUnitVectors(ne.set(Math.sign(tt.x),0,0),tt)),tt.z*=-1,ot.z*=-1,tt.x*=Je,ot.x*=Je,tt.y*=Je,ot.y*=Je;let it=MMD_SA.TEMP_v3.crossVectors(tt,ot).normalize();ot=MMD_SA._v3b.crossVectors(it,tt);let nt=MMD_SA.TEMP_m4.set(tt.x,tt.y,tt.z,0,it.x,it.y,it.z,0,ot.x,ot.y,ot.z,0,0,0,0,1);Ae[Je][Ne]=new THREE.Quaternion().setFromBasis(nt)})}),Ce={1:new THREE.Quaternion().setFromEuler(MMD_SA._v3a.set(0,1*(-Math.PI/2),1*(-MMD_SA_options.model_para_obj.left_arm_z_rot+Math.PI),"YZX")),"-1":new THREE.Quaternion().setFromEuler(MMD_SA._v3a.set(0,-1*(-Math.PI/2),-1*(-MMD_SA_options.model_para_obj.left_arm_z_rot+Math.PI),"YZX"))},je={1:{},"-1":{}},MMD_SA_options.model_para_obj.finger_base={},Ye.forEach(function(Ze){Qe[Ze+"\u624B\u9996"].pmxBone.origin;ue.forEach(function($e,Je){let et=Ze+$e+"\u6307",tt=0==Je&&Qe[et+ge[0]]?0:1;if(Qe[et+ge[tt+0]]){let ot=MMD_SA_options.model_para_obj.finger_base[Ze+Je]={base_index:tt};for(let at=ot.base_index+(0==Je?0:-1),it=at;3>it;it++){let rt,dt,nt="\u5DE6"==Ze?1:-1,st=et+ge[ot.base_index+(it-at)],lt=Qe[st].pmxBone.end;rt="number"==typeof lt?MMD_SA._v3a.fromArray(Ve.mesh.bones[lt].pmxBone.origin).sub(se.fromArray(Qe[st].pmxBone.origin)).normalize():MMD_SA._v3a.fromArray(lt).normalize(),dt=MMD_SA._v3b.set(0,0,-1).applyQuaternion(re.setFromUnitVectors(ne.set(Math.sign(rt.x),0,0),rt)),rt.z*=-nt,dt.z*=-nt,rt.x*=-1,dt.x*=-1;let ct=MMD_SA.TEMP_v3.crossVectors(rt,dt).normalize();dt=MMD_SA._v3b.crossVectors(ct,rt);let pt=MMD_SA.TEMP_m4.set(rt.x,rt.y,rt.z,0,ct.x,ct.y,ct.z,0,dt.x,dt.y,dt.z,0,0,0,0,1);je[nt][st]=new THREE.Quaternion().setFromBasis(pt)}}})})}var Oe=[];if(is_mobile&&Oe.push("use_mobilenet=1"),ke&&(Oe.push("use_holistic=1"),ye=be=!1,we=xe=!0),ye?(Oe.push("use_human=1"),Pe=!0,ye=!0,be=!1,fe=!1,Me=!0,Ie=!0):be?(Oe.push("use_mixed_human=1"),ye=!0,be=!0,fe=!0,Ie=!0):(ye=!1,be=!1,fe=!0),we&&(Oe.push("use_blazepose=1"),xe=!0),xe&&(Oe.push("use_mediapipe=1"),ye&&(Me=!0,Ie=!1),ve=!0),ve&&Oe.push("use_movenet=1"),MMD_SA_options.user_camera.ML_models.worker_disabled&&R.initialized&&!R.worker_initialized?yield new Promise(function(Ve){var He=setInterval(()=>{R.worker_initialized&&(clearInterval(He),Ve())},100)}):yield R.init(),MMD_SA_options.user_camera.ML_models.worker_disabled){O={postMessage:function(Qe){PoseAT.onmessage({data:Qe})}};let Ve=document.createElement("script");Ve.onload=function(){PoseAT.init(O,Oe)},Ve.src="js/pose_lib.js",document.head.appendChild(Ve)}else O=new Worker("js/pose_worker.js"+(Oe.length?"?"+Oe.join("&"):""));O.onmessage=Le});return function(){return Ge.apply(this,arguments)}})();function t(){if(Z+=RAF_timestamp_delta,!(F.busy||RAF_animation_frame_unlimited&&!MMD_SA.WebXR.session&&Z<Y)){Z-=Y;var Ge=j.video;if(Ge.videoWidth&&!(2>Ge.readyState)){N=RAF_timestamp;var Qe,He,Oe=j.video_canvas,Ve=Oe.getContext("2d");if(j.local_src&&!j.stream){Qe=Ge.videoWidth,He=Ge.videoHeight;let Ue=MMD_SA_options.user_camera.pixel_limit._default_;if(Ue&&Qe*He>Ue[0]*Ue[1]){let Xe=Qe/He>Ue[0]/Ue[1]?Qe/Ue[0]:He/Ue[1];Qe=Math.round(Qe/Xe),He=Math.round(He/Xe)}}else Qe=j.target_width,He=j.target_height;var Ke=MMD_SA_options.user_camera.display.webcam_as_bg?{scale:1,top:0}:MMD_SA_options.user_camera.display.video;if(!Ke.scale)(Oe.style.pixelWidth!=window.innerWidth||Oe.style.pixelHeight!=window.innerHeight)&&(Oe.style.width=window.innerWidth+"px",Oe.style.height=window.innerHeight+"px");else{let Ue=Ke.scale*(j.display_floating?MMD_SA_options.user_camera.display.floating_scale||MMD_SA_options.user_camera.display.floating&&1||0.5:1),Xe=~~(window.innerWidth*Ue),Ye=~~(window.innerHeight*Ue);if(Oe.style.pixelWidth!=Xe||Oe.style.pixelHeight!=Ye){Oe.style.width=Xe+"px",Oe.style.height=Ye+"px";let Ze=(window.innerWidth-Xe)/2,Ne=(window.innerHeight-Ye)/2;Oe.style.left=Ze*(1+(null==Ke.left?-1:Ke.left))+"px",Oe.style.top=Ne*(1+(null==Ke.top?0:Ke.top))+"px"}Oe.style.objectFit=j.local_src&&!j.stream?"contain":"cover"}if((Oe.width!=Qe||Oe.height!=He)&&(Oe.width=Qe,Oe.height=He,Ve.globalCompositeOperation="copy",j.video_flipped&&(Ve.translate(Qe,0),Ve.scale(-1,1))),Qe==Ge.videoWidth&&He==Ge.videoHeight)Ve.drawImage(Ge,0,0);else{let Ye,Ze,Ne,$e,Ue=Qe/He,Xe=Ge.videoWidth/Ge.videoHeight;Ue<=Xe?(Ne=Ge.videoHeight*Ue,Ye=(Ge.videoWidth-Ne)/2,$e=Ge.videoHeight,Ze=0):(Ne=Ge.videoWidth,Ye=0,$e=Ge.videoWidth/Ue,Ze=(Ge.videoHeight-$e)/2),Ve.drawImage(Ge,Ye,Ze,Ne,$e,0,0,Qe,He)}Oe.style.visibility=!j.visible||F.enabled||T.initialized&&T.worker_initialized&&!T.dets||j.hidden_enforced?"hidden":"inherit"}}}function _(){F.enabled?F.update_frame():(R.enabled?R.update_frame(!0):T.enabled&&T.update_frame(!0),(G.enabled||V.enabled)&&C(!0));const Ge=j.video_canvas_facemesh.style,Oe=j.video_canvas.style,Ve=MMD_SA_options.user_camera.display.wireframe.align_with_video?1:MMD_SA_options.user_camera.display.wireframe.scale||(is_mobile?0.25:1),Qe=~~(Oe.pixelWidth*Ve),He=~~(Oe.pixelHeight*Ve);if(Ge.pixelWidth!=Qe||Ge.pixelHeight!=He)if(Ge.pixelWidth=Qe,Ge.pixelHeight=He,MMD_SA_options.user_camera.display.wireframe.align_with_video)Ge.posLeft=Oe.posLeft,Ge.posTop=Oe.posTop;else{let Ke=(window.innerWidth-Qe)/2,Ue=(window.innerHeight-He)/2;Ge.left=Ke*(1+(null==MMD_SA_options.user_camera.display.wireframe.left?1:MMD_SA_options.user_camera.display.wireframe.left))+"px",Ge.top=Ue*(1+(null==MMD_SA_options.user_camera.display.wireframe.top?-1:MMD_SA_options.user_camera.display.wireframe.top))+"px"}Ge.objectFit=Oe.objectFit,Ge.visibility=!j.ML_enabled||MMD_SA_options.user_camera.display.wireframe.hidden||MMD_SA_options.user_camera.display.webcam_as_bg?"hidden":"inherit"}function l(){j.initialized&&(SL.style.transform=SL_2D_front.style.transform=j.mirror_3D?"scaleX(-1)":"none",j.video_canvas.style.transform=j.display_flipped?"scaleX(-1)":"none",j.reset_video_canvas()),!$&&j.initialized&&($=!0,Z=Y,System._browser.on_animation_update.add(t,0,0,-1),System._browser.on_animation_update.add(_,2,1,-1))}function u(){SL.style.transform=SL_2D_front.style.transform=j.mirror_3D?"scaleX(-1)":"none",j.video_canvas.style.transform="none",j.reset_video_canvas(),j.visible||$&&!j.ML_enabled&&($=!1,Z=Y,System._browser.on_animation_update.remove(t,0),System._browser.on_animation_update.remove(_,1),j.video_canvas_facemesh.style.visibility="hidden")}function P(Ge){Ge||(Ge=j.local_src||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.Gadget.path+"/js/headtrackr.mp4")),/\.(png|jpg|jpeg|bmp)$/i.test(Ge)?(!j._image&&(j._image=new Image,Object.defineProperty(j._image,"videoWidth",{get:function(){return this.width}}),Object.defineProperty(j._image,"videoHeight",{get:function(){return this.height}}),Object.defineProperty(j._image,"readyState",{get:function(){return this.complete?4:0}})),j.video&&j.video.pause&&j.video.pause(),j.video=j._image,j._image.src=toFileProtocol(Ge)):(j.video=j._video,j.video.loop=!0,!j.video._initialized&&(j.video._initialized=!0,j.video.addEventListener("canplaythrough",function(){j.media_control_enabled=!0,SL_MC_simple_mode=!0,SL_MC_video_obj=j.video,SL_MC_Place(1,0,-64)}),j.video.addEventListener("timeupdate",function(){SL_MC_Timeupdate(this)},!0)),j.video.src=toFileProtocol(Ge)),j.local_src=Ge}function M(){var Ge=R.enabled||G.enabled;te==!!Ge||(te=!!Ge,Ge?(l(),Re.reset(),Re.add_events(),DEBUG_show("(Camera ML Mode:ON)",2)):(j.initialized&&(j.video_canvas_face_detection.style.visibility="hidden",j.video_canvas_facemesh.style.visibility="hidden",u()),Re.remove_events(),DEBUG_show("(Camera ML Mode:OFF)",2)))}function S(Ge,Oe){var Ve=Ge.bones_by_name[Oe],Qe=this.skin[Oe],He=Math.max(Math.min(Qe[0].t_delta/Qe[0].t_delta_frame,1),0),Ke=MMD_SA.TEMP_q.set(0,0,0,1),Ue=Qe[0].no_blending?MMD_SA._q2.copy(Qe[0].rot):MMD_SA._q2.copy(Qe[1].rot).slerp(Qe[0].rot,He);if(!Ve)return void Qe[0]._rot_from_pose.copy(Ue);var Xe=Qe[0].rot_parent;if(Xe||(Xe=MMD_SA.get_bone_rotation_parent(Ge,Oe,Ge).conjugate()),Qe[0]._rot_parent=Xe,"facemesh"==Qe[0].info[1]&&this.skin[Oe+"_DUMMY_"]){let Je=Math.min(5*Math.max(0.25-Qe[0]._rot_ratio,0),1);Ue.slerp(this.skin[Oe+"_DUMMY_"][0]._rot_from_pose,0.667*(Je*Je)),Qe[0]._rot_mixed=Ue.clone()}var Ye=Ue.toAxisAngle()[1]%(2*Math.PI);Ye>Math.PI?Ye=2*Math.PI-Ye:0>Ye&&Ye<-Math.PI&&(Ye+=2*Math.PI),Ye=Math.abs(Ye),He=G.use_3D_pose?0.5:0.3+0.2*(Math.max(Ye-Math.PI/2,0)/(Math.PI/2));var Ze=re.multiplyQuaternions(Xe,Ue),Ne=ne.setEulerFromQuaternion(Ze,"YZX"),$e=[0>Ne.x?He+0.5*(0.5-He):He,He,He];Ze.setFromEuler(se.fromArray(Ne.toArray().map((Je,et)=>Math.sign(Je)*Math.min(Math.abs(Je),Math.PI/2)*$e[et])),"YZX"),Ve.quaternion.copy(Ze),Ge.bones_by_name.頭.quaternion.copy(Ze),0.5>He&&(Ve=Ge.bones_by_name.上半身2,Ve.quaternion.multiply(re.setFromEuler(ne.setEulerFromQuaternion(Ue,"YZX").multiply(se.fromArray($e.map(Je=>1-2*Je))),"YZX")))}function E(Ge,Oe){if(!j.poseNet.IK_disabled_check(Oe)){var Ve=Oe.charAt(0);Ge.bones_by_name[Ve+"\u3072\u3056"].quaternion.set(0,0,0,1)}}function D(Ge,Oe){if(!G.IK_disabled_check(Oe)){var Ve=Ge.bones_by_name[Oe],Qe=this.skin[Oe],He=Math.max(Math.min(Qe[0].t_delta/Qe[0].t_delta_frame,1),0),Ke=Oe.charAt(0);Ge.bones_by_name[Ke+"\u8155+"].quaternion.copy(Ge.bones_by_name[Ke+"\u8155"].quaternion),Ge.bones_by_name[Ke+"\u8155"].quaternion.set(0,0,0,1),Ge.bones_by_name[Ke+"\u3072\u3058"].quaternion.set(0,0,0,1);var Ue=ne.copy(Qe[1].pos).lerp(Qe[0].pos,He);Qe[0]._IK_absolute||Ue.applyQuaternion(MMD_SA.get_bone_rotation_parent(Ge,Oe,Ge).conjugate()),Ue.x+=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]*("\u5DE6"==Ke?1:-1),Ue.y+=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1],Ve.position.add(Ue)}}function A(Ge,Oe){var Ve=Ge.bones_by_name[Oe],Qe=this.skin[Oe],He=Math.max(Math.min(Qe[0].t_delta/Qe[0].t_delta_frame,1),0);let Ke=new THREE.Vector3().copy(Qe[0]._v3_screen).unproject(j._camera_reset).sub(j._camera_reset.position).normalize();Te&&Be.estimate();let Ue=j._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z,Xe=Ue;Te&&Be.z&&(Xe=Be.z_smoothed||Be.z),Ke.multiplyScalar(Xe/Ke.z).negate(),Ke.z=!1===MMD_SA_options.user_camera.ML_models.pose.estimate_z_depth?0:Ue+Ke.z,Qe[0]._v_hip_offset&&Ke.add(Qe[0]._v_hip_offset),MMD_SA_options.user_camera.ML_models.pose.position_offset&&Ke.add(MMD_SA_options.user_camera.ML_models.pose.position_offset),Qe[0].pos.copy(Ke);var Ye=new THREE.Vector3().copy(Qe[1].pos).lerp(Qe[0].pos,He),Ze=MMD_SA.get_bone_position(Ge,"\u5DE6\u8DB3","\u5168\u3066\u306E\u89AA"),Ne=MMD_SA.get_bone_position(Ge,"\u53F3\u8DB3","\u5168\u3066\u306E\u89AA"),$e=MMD_SA.TEMP_v3.copy(Ze).add(Ne).multiplyScalar(0.5).sub(MMD_SA_options.model_para_obj.hip_center).negate();if(G.auto_grounding){let et=MMD_SA.get_bone_position(Ge,"\u5DE6\u8DB3\u9996","\u5168\u3066\u306E\u89AA"),tt=MMD_SA.get_bone_position(Ge,"\u53F3\u8DB3\u9996","\u5168\u3066\u306E\u89AA"),ot=et.y<tt.y?et:tt,at=MMD_SA_options.model_para_obj.left_heel_height+0.2-ot.y;at-=Ye.y,$e.y=at}Ye.add($e),Ye.x*=j.x_flipped?-1:1,Qe[0].absolute&&Ve.position.set(0,0,0),Ve.position.add(Ye);var Je=me.distanceTo(Ye)-5;0<Je&&THREE.MMD.getModels()[Ge._model_index].resetPhysics(15+2*Je),me.copy(Ye)}function C(Ge){function Oe(){var Ve=G.enabled&&G.worker_initialized&&N&&!G.busy&&$&&G.camera_video_timestamp!=N;if(Ve){ie=RAF_timestamp,G.camera_video_timestamp=N,G.use_holistic&&(MMD_SA_options.auto_blink=!1);let Qe,He,Ke;Qe=j.video_canvas,He=Qe.width,Ke=Qe.height;let Ue=Qe.getContext("2d").getImageData(0,0,He,Ke).data.buffer,Xe={rgba:Ue,w:He,h:Ke,options:{use_holistic:G.use_holistic,use_posenet:!0,use_handpose:V.enabled,skip_hand_countdown_max:G.skip_hand_countdown_max}};O.postMessage(Xe,[Xe.rgba]),Xe.rgba=Ue=void 0,Xe=void 0}}Ge||self.PoseAT?setTimeout(()=>{Oe()},0):Oe()}var j,T,B,F,R,W,G,O,V,Q,X,$,oe,ae,ie,ne,se,re,_e,de,le,ce,pe,me,H=new URLSearchParams(self.location.search.substring(1)),K="",U=!0,Y=1e3/30,Z=Y,N=0,J=100,ee=0,te=!1;window.addEventListener("jThree_ready",function(){ne=new THREE.Vector3,se=new THREE.Vector3,me=new THREE.Vector3,re=new THREE.Quaternion,_e=new THREE.Quaternion,de=new THREE.Matrix4,le=new THREE.Quaternion,ce=new THREE.Vector2,pe=new THREE.Vector2});var ye,be,fe,xe,Pe,Me,Ie,ue=["\u89AA","\u4EBA","\u4E2D","\u85AC","\u5C0F"],he=["thumb","index","middle","ring","pinky"],ge=["\uFF10","\uFF11","\uFF12","\uFF13"],ve=!0,we=!0,ke=!0,Se=!1,Ee=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"],ze=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28],De=[];Ee.forEach(Ge=>{De.push({part:Ge,score:0})});var Ae,Ce,je,qe,Te=10,Be=function(){var Ve=[],Qe=[];return{prepare:function(He){var Ke=He.keypoints[5],Ue=He.keypoints[6],Xe=He.keypoints[11],Ye=He.keypoints[12];if(!(0>=Ke.score||0>=Ue.score)){var Ze=He.keypoints3D[5],Ne=He.keypoints3D[6];if(0>=Xe.score||0>=Ye.score){let $e=MMD_SA._v3b.copy(Ze).sub(Ne),Je=$e.length(),et=MMD_SA.TEMP_v3.set(1,0,0),tt=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(et,$e.normalize()),"ZYX").y,ot=pe.copy(Ke.position).add(Ue.position).multiplyScalar(0.5),at=ot.clone(),it=ce.copy(Ke.position).distanceTo(Ue.position);ot.y+=1.5*it/Math.abs(Math.cos(tt)),ot.y>j.video_canvas.height&&(at.y=Math.max(at.y-(ot.y-j.video_canvas.height),0),ot.y=j.video_canvas.height),Ve=[{point2D:[{position:at},{position:ot.clone()}],data3D:{length:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)*(3*Je),z_diff:0}}]}else{let $e=MMD_SA._v3a.addVectors(Ze,Ne).multiplyScalar(0.5),Je=$e.length(),et=MMD_SA.TEMP_v3.set(0,1,0);et.y*=-1;let tt=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(et,$e.normalize()),"ZXY").x,ot=ce.copy(Xe.position).add(Ye.position).multiplyScalar(0.5),at=pe.copy(Ke.position).add(Ue.position).multiplyScalar(0.5),it=ot.distanceTo(at);at.copy(ot),at.y-=it/Math.abs(Math.cos(tt)),Ve=[{point2D:[{position:at.clone()},{position:ot.clone()}],data3D:{length:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)*(2*Je),z_diff:0}}]}}},estimate:function(){if(Ve.length){var He=System._browser.camera,Ke=He.video_canvas.width,Ue=He.video_canvas.height,Xe=ne,Ye=[];Ve.forEach(Ne=>{Xe.set(2*(Ne.point2D[0].position.x/Ke)-1,2*-(Ne.point2D[0].position.y/Ue)+1,0.5);var $e=MMD_SA._v3a.copy(Xe.unproject(He._camera_reset).sub(He._camera_reset.position).normalize());Xe.set(2*(Ne.point2D[1].position.x/Ke)-1,2*-(Ne.point2D[1].position.y/Ue)+1,0.5);var et,tt,Je=MMD_SA._v3b.copy(Xe.unproject(He._camera_reset).sub(He._camera_reset.position).normalize());et=Ne.data3D.length,tt=Ne.data3D.z_diff;let ot=Math.sqrt(Math.pow($e.x-Je.x*$e.z/Je.z,2)+Math.pow($e.y-Je.y*$e.z/Je.z,2)+0),at=$e.x-Je.x*$e.z/Je.z+($e.y-Je.y*$e.z/Je.z)+0,st=(Math.sqrt(et*et+1)-1)/(ot/(at/ot));$e.multiplyScalar(st),Ye.push({z:1.5*-$e.z,id:Ne.id})}),Ye.sort((Ne,$e)=>$e.z-Ne.z);var Ze=Ye[0].z;this.z=Ze,Qe=Qe.filter(Ne=>200>RAF_timestamp-Ne.timestamp),Qe.push({timestamp:RAF_timestamp,z:Ze}),z=Qe.reduce((Ne,$e)=>Ne+$e.z,0)/Qe.length,this.z_smoothed=z,Ve=[]}}}}(),Le=function(){function Ge(Ne,$e){var at,it,nt,rt,Je=THREE.MMD.getModels()[Ne._model_index],et=Ne.bones_by_name[$e],tt=$e.charAt(0),st=Ne.bones_by_name[tt+"\u624B\u6369"],dt=this.skin[$e],lt=Math.max(Math.min(dt[0].t_delta/dt[0].t_delta_frame,1),0);at=re.set(0,0,0,1),st&&((st.quaternion.x||st.quaternion.y||st.quaternion.z)&&(st.quaternion.conjugate(),Je._update_IK_and_AddTrans(!1,tt+"\u624B\u6369")),st.quaternion.set(0,0,0,1));var ct=dt[0].rot_parent;if(ct||(ct=MMD_SA.get_bone_rotation_parent(Ne,$e,Ne),ct.conjugate()),dt[0]._rot_parent=ct,at.multiply(dt[0].no_blending?dt[0].rot:MMD_SA.TEMP_q.copy(dt[1].rot).slerp(dt[0].rot,lt)),et.quaternion.copy(ct).multiply(at).multiply(Ce["\u5DE6"==tt?1:-1]),st){it=st.pmxBone.fixedAxis,it=it&&MMD_SA._v3a.fromArray(it)||MMD_SA_options.model_para_obj.arm_axis[tt];let pt=ne.setEulerFromQuaternion(et.quaternion,"YZX").y;nt=0.5*-pt,rt=_e.setFromAxisAngle(it,nt),this.skin[tt+"\u624B\u6369"][0].rot.copy(rt),et.quaternion.multiplyQuaternions(rt.conjugate(),et.quaternion)}}function Oe(Ne,$e){if("y"==Ze)Ne.multiplyQuaternions(Ne,MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,0,MMD_SA_options.model_para_obj.left_arm_z_rot*(0==$e?1:-1))));else{Ne.multiplyQuaternions(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,0,-(Math.PI/2-MMD_SA_options.model_para_obj.left_arm_z_rot)*(0==$e?1:-1))),Ne);let Je=Ne.toAxisAngle();Ne.setFromAxisAngle(Je[0].applyQuaternion(Ae[0==$e?1:-1].腕),Je[1])}}function Ve(Ne,$e){var Je=Ne.toAxisAngle();"y"==Ze?Ne.setFromAxisAngle(Je[0].applyEuler(MMD_SA.TEMP_v3.set(0,0,-MMD_SA_options.model_para_obj.left_arm_z_rot*(0==$e?1:-1))),Je[1]):Ne.setFromAxisAngle(Je[0].applyQuaternion(Ae[0==$e?1:-1].ひじ),Je[1])}var Qe;window.addEventListener("jThree_ready",()=>{Qe=new THREE.Quaternion});var He=function(){var Ne=0;return function($e,Je){if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only){var et=$e.bones_by_name,tt=et[Je].quaternion;Ne!=RAF_timestamp&&(Ne=RAF_timestamp,Qe.copy(et.センター.quaternion).multiply(et.上半身.quaternion).multiply(et.上半身2.quaternion).conjugate()),tt.multiplyQuaternions(Qe,tt)}}}(),Ke=0,Ue=0,Xe=0,Ye=0,Ze="x";return function(Ne){var $e="string"==typeof Ne.data&&"{"===Ne.data.charAt(0)?JSON.parse(Ne.data):Ne.data;if("string"==typeof $e)"OK"==$e?ae=!0:(DEBUG_show($e,2),System._browser.console.log($e));else{j._needs_RAF=!0,K="";let Je=performance.now(),et=0;Ye&&(et=Je-Ye,Xe+=et,20<=++Ue&&(Ke=1e3/(Xe/Ue),Ue=Xe=0)),Ye=Je,G._t=$e._t,Re.t_delta=Ke&&1e3/Ke||et||$e.fps&&1e3/$e.fps||$e._t;let st,tt=[],ot=[],at=j.x_flipped?1:-1,it=THREE.MMD.getModels()[0],nt=it.mesh.bones_by_name;if(G.enabled)if(!($e.posenet&&0.3<$e.posenet.score))G.data_detected=0;else if(G.data_detected++,G.data_detected_stable){Se&&(Se=!1,it.mesh.visible=!0),st=$e.posenet;let lt=G.use_3D_pose;if(we){let gt=[],yt=[];ze.forEach((bt,ft)=>{let vt=st.keypoints[bt];vt.part=Ee[ft],gt.push(vt),vt=st.keypoints3D[bt],vt.part=Ee[ft],yt.push(vt)}),st.keypoints=gt,st._keypoints3D=st.keypoints3D,st.keypoints3D=yt}const ct=ve?0.3:Me?0.1:0.5;if(st.keypoints.forEach(gt=>{gt.score-=ct}),lt&&st._keypoints3D.forEach(gt=>{gt.score-=ct}),Me){let gt={};st.keypoints.forEach(bt=>{gt[bt.part]=bt});let yt=[];for(let ft,bt=0;16>=bt;bt++)ft=st.keypoints[bt],ft?ft.part==Ee[bt]?yt.push(ft):yt.push(gt[Ee[bt]]||De[bt]):yt.push(De[bt]);st.keypoints=yt}if(R.head_pose_enabled||(R.bb_center[0]=st.keypoints[0].position.x/j.video_canvas.width,R.bb_center[1]=st.keypoints[0].position.y/j.video_canvas.height),lt){let gt=st._keypoints3D[0],yt=st._keypoints3D[3],bt=st._keypoints3D[6],ft=MMD_SA._v3a_.copy(gt).sub(MMD_SA._v3b.copy(yt).add(bt).multiplyScalar(0.5)).normalize(),vt=MMD_SA._v3b_.copy(yt).sub(MMD_SA._v3b.copy(bt)).normalize(),wt=MMD_SA.TEMP_v3.crossVectors(vt,ft).normalize();vt.crossVectors(ft,wt),de.set(vt.x,vt.y,vt.z,0,ft.x,ft.y,ft.z,0,wt.x,wt.y,wt.z,0,0,0,0,1),le.setFromBasis(de);let xt=le.conjugate();xt=xt.clone().multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI/8,0,0))),R.head_pose_enabled||(Re.add("skin","\u9996",{after_IK:!0,rot:xt,onProcessRotation:S}),Re.skin.首[1]._rot_mixed&&Re.skin.首[1].rot.copy(Re.skin.首[1]._rot_mixed)),Re.add("skin","\u9996_DUMMY_",{rot:xt,_rot_from_pose:xt.clone(),onProcessRotation:S})}let pt=st.keypoints[5],mt=st.keypoints[6],ut=new THREE.Quaternion,ht=MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only;if(ht&&(K+="\n(upper body only)\n"),lt&&Te&&Be.prepare(st),0<pt.score&&0<mt.score){let gt,yt,bt,ft,vt;if(lt){gt=st.keypoints3D[5],yt=st.keypoints3D[6];let It=st.keypoints3D[11],St=st.keypoints3D[12];if(ht||0>=It.score||0>=St.score)ht=!0;else{(st.keypoints[11].position.y>j.video_canvas.height||st.keypoints[12].position.y>j.video_canvas.height)&&(ht=!0);let Bt=MMD_SA._v3b.copy(It).sub(St).normalize(),Lt=MMD_SA.TEMP_v3.set(1,0,0),Ft=se.setFromVectorSpherical(Lt,Bt);ht&&(Ft.z=0),ut.setFromEuler(Ft,"YZX")}let Et=MMD_SA._v3a.addVectors(gt,yt).multiplyScalar(0.5).normalize();Et.applyQuaternion(MMD_SA.TEMP_q.copy(ut).conjugate());let zt=MMD_SA.TEMP_v3.set(0,1,0);zt.y*=-1,bt=new THREE.Quaternion().setFromVectorSpherical(zt,Et),ht&&(bt.multiplyQuaternions(ut,bt),ut.set(0,0,0,1));let Dt=MMD_SA._v3b.copy(gt).sub(yt).normalize();Dt.applyQuaternion(MMD_SA.TEMP_q.multiplyQuaternions(ut,bt).conjugate()),x_axis=MMD_SA.TEMP_v3.set(1,0,0);let At=se.setFromVectorSpherical(x_axis,Dt);ft=new THREE.Quaternion().setFromEuler(At,"YZX");let Ct=0,jt=At.y,Tt=(Ct+jt)%(2*Math.PI);Tt>Math.PI?Tt=2*Math.PI-Tt:0>Tt&&Tt<-Math.PI&&(Tt+=2*Math.PI),bt.multiply(re.setFromEuler(ne.set(0,Tt/2-Ct,0),"YZX")),ft.multiply(re.setFromEuler(ne.set(0,Tt/2-jt,0),"YZX")),Re.add("skin","\u30BB\u30F3\u30BF\u30FC",{rot:ut.clone(),priority:9}),Re.add("skin","\u4E0A\u534A\u8EAB",{rot:bt.clone()}),Re.add("skin","\u4E0A\u534A\u8EAB2",{rot:ft.clone()}),vt=re.copy(ut).multiply(bt).multiply(ft).conjugate()}let wt=Math.sqrt(Math.pow(pt.position.x-mt.position.x,2)+Math.pow(pt.position.y-mt.position.y,2)),xt=0;lt||(xt=Math.asin((pt.position.y-mt.position.y)/wt),xt=Math.max(Math.min(xt/(Math.PI/4),1),-1)*Math.PI/4*at);let kt=1==at?[1,0]:[0,1],Pt=[st.keypoints[9],st.keypoints[10]],Mt=-1;!lt&&0<Pt[0].score&&0<Pt[1].score&&Math.sqrt(Math.pow(Pt[0].position.x-Pt[1].position.x,2)+Math.pow(Pt[0].position.y-Pt[1].position.y,2))<(j.video_canvas.width+j.video_canvas.height)/2/25&&(Mt=Pt[1].score>Pt[0].score?0:1,0.3<Pt[Mt].score&&(Mt=-1)),wt=2*R.face_width||wt,kt.forEach(function(It,St){let Et,zt,Dt,At,Ct=0==St?"\u5DE6":"\u53F3",jt=st.keypoints[5+It],Tt=st.keypoints[7+It],Bt=st.keypoints[9+It];Re.add("skin",Ct+"\u80A9",{absolute:!0,rot:new THREE.Quaternion().setFromEuler(MMD_SA.TEMP_v3.set(0,0,xt),"YZX")});let Lt,Ft,Rt;lt&&(Lt=st.keypoints3D[5+It],Ft=st.keypoints3D[7+It],Rt=st.keypoints3D[9+It]);let Ot,Vt,Qt,Wt=at*(0==It?-1:1),qt=!MMD_SA_options.user_camera.ML_models.pose.use_armIK,Gt=!1;"YZX";if(lt&&0<Tt.score&&(Ot=MMD_SA._v3b.copy(Lt).sub(Ft).normalize().applyQuaternion(vt),Vt=MMD_SA.TEMP_v3.set(Wt,0,0),Qt=new THREE.Quaternion().setFromUnitVectors(Vt,Ot)),0<Bt.score&&It!=Mt){if(ot.push({pos:Bt.position,dir:It,d:Ct}),!lt){Gt=!0;let Kt=jt.position.x-Bt.position.x,Ut=jt.position.y-Bt.position.y;if(Et=Kt/wt*MMD_SA_options.model_para_obj.shoulder_width*at,zt=Ut/wt*MMD_SA_options.model_para_obj.shoulder_width,0<Tt.score){let Xt=Math.min(Math.sqrt(Math.pow(Bt.position.x-Tt.position.x,2)+Math.pow(Bt.position.y-Tt.position.y,2))/wt,1),Yt=Math.min(Math.sqrt(Math.pow(jt.position.x-Tt.position.x,2)+Math.pow(jt.position.y-Tt.position.y,2))/wt,1);At=(0.25+0.75*((Math.sin(Math.acos(Xt))+Math.sin(Math.acos(Yt)))/2))*MMD_SA_options.model_para_obj.left_arm_length}}else if(!qt||0>=Tt.score){qt=!1;let Kt=MMD_SA._v3a.copy(Lt).sub(Rt),Ut=0<Tt.score?MMD_SA.TEMP_v3.copy(Lt).distanceTo(Ft)+MMD_SA.TEMP_v3.copy(Ft).distanceTo(Rt):0.5,Xt=Math.min(Kt.length()/Ut,1);Kt.normalize().multiplyScalar(Xt*MMD_SA_options.model_para_obj.left_arm_length),Et=Kt.x,zt=Kt.y,Dt=At=Kt.z,Qt&&(Oe(Qt,It),Re.add("skin",Ct+"\u8155",{absolute:!0,rot:Qt.slerp(MMD_SA.TEMP_q.set(0,0,0,1),0.5)}))}else{let Kt=ne.copy(Ft).sub(Rt).normalize().applyQuaternion(vt),Ut=MMD_SA._v3a.copy(Kt).applyQuaternion(MMD_SA.TEMP_q.copy(Qt).conjugate());Vt=MMD_SA.TEMP_v3.set(Wt,0,0);let Yt=new THREE.Quaternion().setFromUnitVectors(Vt,Ut);Ve(Yt,It),Oe(Qt,It),Re.add("skin",Ct+"\u8155",{absolute:!0,rot:Qt,priority:-1,onFinish:He}),Re.add("skin",Ct+"\u3072\u3058",{absolute:!0,rot:Yt,_rot_adjust_from_lower_arm:0})}}else if(!(0<Tt.score)){if(lt)return;qt=!1,Gt=!0,Et=0.2*(MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*("\u5DE6"==Ct?1:-1)),zt=-Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-Et*Et)}else if(lt)qt?(qt=!0,Oe(Qt,It),Re.add("skin",Ct+"\u8155",{absolute:!0,rot:Qt,priority:-1,onFinish:He})):(qt=!1,Ot=MMD_SA._v3a.copy(Lt).sub(Ft).normalize(),Ot.multiplyScalar(MMD_SA_options.model_para_obj.left_arm_length),Et=Ot.x*at,zt=Ot.y,Dt=At=Ot.z);else{qt=!1,Gt=!0;let Kt=jt.position.x-Tt.position.x,Ut=jt.position.y-Tt.position.y,Xt=Math.sqrt(Kt*Kt+Ut*Ut),Yt=Math.asin(Kt/Xt);Et=Math.sin(Yt)*MMD_SA_options.model_para_obj.left_arm_length*at,zt=Math.cos(Yt)*MMD_SA_options.model_para_obj.left_arm_length*Math.sign(Ut)}tt.push({pos:{x:Et,y:zt,z:Dt,z_posenet:At},dir:It,d:Ct,IK_disabled:qt,IK_absolute:Gt})})}else ht=!0;if(lt&&!ht){let gt=1==at?[1,0]:[0,1],yt=[],ft=0;gt.forEach(function(wt,xt){let St,Et,zt,kt=0==xt?"\u5DE6":"\u53F3",Pt=st.keypoints3D[11+wt],Mt=st.keypoints3D[13+wt],It=st.keypoints3D[15+wt];if(0<Mt.score){zt=MMD_SA._v3b.copy(Pt).sub(Mt).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(ut).conjugate());let At=MMD_SA.TEMP_v3.set(0,1,0);At.y*=-1,Et=se.setFromVectorSpherical(At,zt),St=new THREE.Quaternion().setFromEuler(Et,"XZY"),ft+=Et.x}let Dt=!MMD_SA_options.user_camera.ML_models.pose.use_legIK;if(0<It.score){let At=MMD_SA._v3a.copy(Pt).sub(It),Ct=0<Mt.score?MMD_SA.TEMP_v3.copy(Pt).distanceTo(Mt)+MMD_SA.TEMP_v3.copy(Mt).distanceTo(It):0.7,jt=Ct+At.y,Tt=[It.y,jt];if(!Dt||0>=Mt.score){let Bt=Math.min(At.length()/Ct,1);At.normalize().multiplyScalar(Bt*MMD_SA_options.model_para_obj.left_leg_length),G.enable_IK(kt+"\u8DB3\uFF29\uFF2B",!0),yt.push({pos:At.clone(),rot:[St],dir:wt,d:kt,foot:Tt})}else{let Bt=ne.copy(Mt).sub(It).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(ut).conjugate()),Lt=MMD_SA._v3a.copy(Bt).applyQuaternion(MMD_SA.TEMP_q.copy(St).conjugate());Lt.z=Math.max(-Lt.z,0),Lt.x*=-1;let Ft=Lt.normalize().toSphericalCoords(),Rt=Math.sqrt(Math.min((Math.PI-Ft[2])/(Math.PI/2),1));Et.y=Ft[1]*Rt,St.setFromEuler(Et,"XZY"),Lt=MMD_SA._v3a.copy(Bt).applyQuaternion(MMD_SA.TEMP_q.copy(St).conjugate());let Wt=MMD_SA.TEMP_v3.set(0,1,0);Wt.y*=-1;let qt=new THREE.Quaternion().setFromVectorSpherical(Wt,Lt);G.enable_IK(kt+"\u8DB3\uFF29\uFF2B",!1),yt.push({rot:[St,qt],dir:wt,d:kt,foot:Tt})}if(Dt){let Bt=st._keypoints3D[29+wt],Lt=st._keypoints3D[31+wt];if(0<Bt.score&&0<Lt.score){let Ft=MMD_SA._v3a_.copy(Bt).sub(It).normalize(),Rt=MMD_SA._v3b_.copy(Bt).sub(Lt).normalize(),Wt=ne.crossVectors(Ft,Rt).normalize();Ft.crossVectors(Rt,Wt),de.set(Wt.x,Wt.y,Wt.z,0,Ft.x,Ft.y,Ft.z,0,Rt.x,Rt.y,Rt.z,0,0,0,0,1),le.setFromBasis(de);let qt=le.conjugate();qt=qt.clone().multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-Math.PI/8,0,0)));let Gt=Math.abs(MMD_SA.TEMP_v3.setEulerFromQuaternion(ut,"YZX").y)%Math.PI,Ot=Gt>Math.PI/2?1-(Gt-Math.PI/2)/(Math.PI/2):1;Re.add("skin",kt+"\u8DB3\u9996",{after_IK:!0,absoulte:!0,parent_based:!0,rot:qt,ratio:Ot})}}else;}else if(0<Mt.score);}),ft*=0.5*0.5;let vt=new THREE.Quaternion().setFromEuler(MMD_SA.TEMP_v3.set(ft,0,0));if(Re.add("skin","\u4E0B\u534A\u8EAB",{absolute:!0,rot:vt.clone()}),!ht){let wt=j.video_canvas.width,xt=j.video_canvas.height,kt=new THREE.Vector3,Pt=st.keypoints[11].position,Mt=st.keypoints[12].position,It=wt/xt,St=SL.width/SL.height;kt.set((2*((Pt.x+Mt.x)/2/wt)-1)*(It<St?It/St:1),(2*-((Pt.y+Mt.y)/2/xt)+1)*(St<It?St/It:1),0.5),Re.add("skin","\u5168\u3066\u306E\u89AA",{pos:new THREE.Vector3,after_IK:!0,priority:999,_v3_screen:kt,onProcessPosition:A})}vt.conjugate(),yt.forEach(wt=>{var xt=wt.d;wt.pos?(wt.pos.y+=MMD_SA_options.model_para_obj.left_leg_length,wt.rot[0]&&Re.add("skin",xt+"\u8DB3",{absolute:!0,rot:wt.rot[0]}),Re.add("skin",xt+"\u8DB3\uFF29\uFF2B",{absolute:!0,pos:wt.pos,priority:999,onFinish:E})):(ft&&wt.rot[0].multiplyQuaternions(vt,wt.rot[0]),Re.add("skin",xt+"\u8DB3",{absolute:!0,rot:wt.rot[0]}),Re.add("skin",xt+"\u3072\u3056",{absolute:!0,rot:wt.rot[1]}))})}else{if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only)Re.add("skin","\u5168\u3066\u306E\u89AA",{is_dummy:!0,pos:!0,after_IK:!0,priority:999});else if(lt&&0<pt.score&&0<mt.score){let gt=j.video_canvas.width,yt=j.video_canvas.height,bt=new THREE.Vector3,ft=gt/yt,vt=SL.width/SL.height;bt.set((2*((pt.position.x+mt.position.x)/2/gt)-1)*(ft<vt?ft/vt:1),(2*-((pt.position.y+mt.position.y)/2/yt)+1)*(vt<ft?vt/ft:1),0.5),Re.add("skin","\u5168\u3066\u306E\u89AA",{pos:new THREE.Vector3,after_IK:!0,priority:999,_v3_screen:bt,_v_hip_offset:{x:0,y:-Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length),z:0},onProcessPosition:A})}Re.add("skin","\u4E0B\u534A\u8EAB",{is_dummy:!0,rot:!0}),["\u5DE6","\u53F3"].forEach(gt=>{Re.add("skin",gt+"\u8DB3\uFF29\uFF2B",{is_dummy:!0,pos:!0,priority:999}),Re.add("skin",gt+"\u8DB3",{is_dummy:!0,rot:!0}),Re.add("skin",gt+"\u3072\u3056",{is_dummy:!0,rot:!0}),Re.add("skin",gt+"\u8DB3\u9996",{is_dummy:!0,after_IK:!0,rot:!0})})}}!G.enabled||G.data_detected_stable||Se||(Se=!0,!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only&&(it.mesh.visible=!1));let rt,dt=[];if(V.enabled&&$e.handpose&&$e.handpose.length&&ot.length){let lt;xe&&(lt=at?{Left:{dir:1,list:[]},Right:{dir:0,list:[]}}:{Left:{dir:0,list:[]},Right:{dir:1,list:[]}},$e.handpose.forEach(pt=>{pt.label&&lt[pt.label].list.push(pt)}));xe?1:2;$e.handpose.forEach(pt=>{pt._offset={},rt=pt.annotations;let mt=MMD_SA.TEMP_v3.fromArray(rt.palm[0]);ot.forEach(ut=>{pt._offset[ut.dir]=Math.sqrt(Math.pow(ut.pos.x-mt.x,2)+Math.pow(ut.pos.y-mt.y,2))})}),ot.forEach((pt,mt)=>{var ut=pt.dir,ht=lt?lt[lt.Left.dir==ut?"Left":"Right"].list:$e.handpose;ht.length||(ht=$e.handpose);let gt=0==mt?1==$e.handpose.length&&1<ot.length?ht[0]._offset[ut]<ht[0]._offset[0==ut?1:0]&&ht[0]:ht.sort((yt,bt)=>yt._offset[ut]-bt._offset[ut])[0]:ht.find(yt=>!yt._used);if(gt&&gt._offset[ut]<Math.max(j.video_canvas.width,j.video_canvas.height)/6){gt._used=!0,rt=gt.annotations;let yt=tt.find(At=>At.dir==ut),bt=pt.d;dt.push(bt+"\u624B");let ft=1==ut?[rt.index[0],rt.ring[0]]:[rt.ring[0],rt.index[0]],kt=MMD_SA._v3a_.fromArray(rt.palm[0]).sub(MMD_SA._v3b.fromArray(rt.middle[0])).normalize();kt.x*=at;let Pt=MMD_SA._v3b_.fromArray(ft[0]).sub(MMD_SA._v3b.fromArray(ft[1])).normalize();Pt.z*=at,Pt.y*=at;let Mt=MMD_SA.TEMP_v3.crossVectors(Pt,kt).normalize();Pt.crossVectors(kt,Mt),de.set(Pt.x,Pt.y,Pt.z,0,kt.x,kt.y,kt.z,0,Mt.x,Mt.y,Mt.z,0,0,0,0,1),le.setFromBasis(de);let It=new THREE.Quaternion;It.copy(le).conjugate(),Re.add("skin",bt+"\u624B\u9996",{after_IK:!0,rot:It,onProcessRotation:Ge}),Re.add("skin",bt+"\u624B\u6369",{after_IK:!0,absolute:!0,priority:1,no_blending:!0,rot:new THREE.Quaternion});let St=new THREE.Quaternion,Et=MMD_SA_options.model_para_obj.finger_base,zt=re.copy(le);zt.y*=-1,zt.w*=-1;let Dt="\u5DE6"==bt?1:-1;ue.forEach((At,Ct)=>{let jt=Et[(1==at?bt:"\u5DE6"==bt?"\u53F3":"\u5DE6")+Ct],Tt=jt.base_index+(0==Ct?0:-1),Bt=rt[he[Ct]],Lt=_e.copy(zt);const Ft="XZY";for(let Rt=Tt;3>Rt;Rt++){let Wt=bt+At+"\u6307"+ge[jt.base_index+(Rt-Tt)],qt=MMD_SA._v3a.fromArray(Bt[Rt+0]),Gt=MMD_SA._v3b.fromArray(Bt[Rt+1]),Ot=MMD_SA.TEMP_v3.fromArray(Rt==Tt?rt.palm[0]:Bt[Rt-1]);qt.y=-qt.y,Gt.y=-Gt.y,Ot.y=-Ot.y;let Vt=MMD_SA._v3a_.copy(qt).sub(Ot),Qt=MMD_SA._v3b_.copy(Gt).sub(qt);Vt.normalize(),Qt.normalize();let Ht,Kt,Ut;if(Vt.applyQuaternion(Lt),Qt.applyQuaternion(Lt),Rt==Tt){let $t=MMD_SA.TEMP_q.set(0,0,0,1);$t.setFromVectorSpherical(MMD_SA.TEMP_v3.set(0,1,0),Vt).conjugate(),Qt.applyQuaternion($t),Lt.multiplyQuaternions($t,Lt)}let Xt=MMD_SA._q1.set(0,0,0,1),Yt=MMD_SA._q2.set(0,0,0,1);Vt.set(0,1,0),Ut=se.setFromVectorSpherical(Vt,Qt),Xt.setFromEuler(Ut,Ft),Yt.copy(Xt),Lt.multiplyQuaternions(Xt.conjugate(),Lt),(Math.abs(Ut.z)>Math.PI/(0==Ct?1.5:2.5)||Ut.x>Math.PI/(0==Ct?2:3))&&Ut.set(-Math.abs(Vt.angleTo(Qt)),0,0),0==Ct&&Rt>Tt&&(Ut.x=0),0<Ut.x?Ut.x*=0==Ct||Rt>Tt?0:0.75:Ut.x=Math.max(Ut.x,-Math.PI/(0==Ct?1.5:2)),0==Ct||Rt==Tt?(Ut.z*=0.9,Ut.z+=(Ct-2)/2*Math.PI/8*(1==Dt?1:-1)*(0<Ct?1:0.5)):Ut.z=0,Ut.y=0,Xt.setFromEuler(Ut,Ft);let Nt=Xt.toAxisAngle();Kt=Nt[0],Ht=Nt[1],Kt.applyEuler(ne.set(0,-Math.PI/2,0)).applyQuaternion(MMD_SA.TEMP_q.copy(je[Dt][Wt]).conjugate()),Xt.setFromAxisAngle(Kt,Ht),Re.add("skin",Wt,{absolute:!0,rot:Xt.clone()})}})}})}else if(!V.enabled&&st&&G.use_3D_pose){let lt=1==at?[1,0]:[0,1];lt.forEach(function(ct,pt){let mt=0==pt?"\u5DE6":"\u53F3",ut=st._keypoints3D[15+ct],ht=st._keypoints3D[17+ct],gt=st._keypoints3D[19+ct];if(!(0>=ut.score||0>=ht.score||0>=gt.score)){let yt=1==ct?[gt,ht]:[ht,gt],bt=MMD_SA._v3a_.copy(ut).sub(MMD_SA._v3b.copy(ht).add(gt).multiplyScalar(0.5)).normalize();bt.x*=at;let ft=MMD_SA._v3b_.copy(yt[0]).sub(yt[1]).normalize();ft.z*=at,ft.y*=at;let vt=MMD_SA.TEMP_v3.crossVectors(ft,bt).normalize();ft.crossVectors(bt,vt),de.set(ft.x,ft.y,ft.z,0,bt.x,bt.y,bt.z,0,vt.x,vt.y,vt.z,0,0,0,0,1),le.setFromBasis(de);let wt=new THREE.Quaternion;wt.copy(le).conjugate(),Re.add("skin",mt+"\u624B\u9996",{after_IK:!0,rot:wt,onProcessRotation:Ge}),Re.add("skin",mt+"\u624B\u6369",{after_IK:!0,absolute:!0,priority:1,no_blending:!0,rot:new THREE.Quaternion})}})}if(tt.forEach(function(lt){var ct=lt.d;G.enable_IK(ct+"\u8155\uFF29\uFF2B",!lt.IK_disabled),lt.IK_disabled||(null==lt.pos.z&&(lt.pos.z=lt.pos.z_posenet||(G.use_3D_pose?0:0.2*MMD_SA_options.model_para_obj.left_arm_length)),Re.add("skin",ct+"\u8155\uFF29\uFF2B",{speed_limit:10,priority:999,pos:new THREE.Vector3().copy(lt.pos),_IK_absolute:lt.IK_absolute,onProcessPosition:D}));var pt=Re.skin[ct+"\u624B\u9996"];pt&&(pt[0].rot_parent=pt[0]._rot_parent)}),K+=(K?"/":"\n")+"P-FPS:"+Math.round(Ke)+"/"+Math.round($e.fps||0),G.use_holistic||R.enabled||!K||System._browser.overlay_mode||MMD_SA_options.user_camera.ML_models.debug_hidden||DEBUG_show(K+"\nFPS:"+EV_sync_update.fps_last),$e.facemesh?R.worker_onmessage({data:$e.facemesh}):G.use_holistic&&(R.data_detected=0),st&&R.worker_initialized){let lt={posenet:st,w:j.video_canvas.width,h:j.video_canvas.height,flip_canvas:j.display_flipped};$e.handpose&&$e.handpose.length&&(lt.handpose=$e.handpose),$e.facemesh&&(lt.facemesh=$e.facemesh.faces),(G.use_holistic||!R.enabled)&&(lt.draw_canvas=!0,self.FacemeshAT?lt.canvas=j.video_canvas_facemesh:!j.video_canvas_facemesh._offscreen&&self.OffscreenCanvas&&(lt.canvas=j.video_canvas_facemesh.transferControlToOffscreen(),j.video_canvas_facemesh._offscreen=!0,console.log("(Facemesh: use offscreen canvas)"))),W.postMessage(lt,lt.canvas?[lt.canvas]:void 0)}ie=0}C()}}(),Fe=function(){function Ge(Je,et){var tt,ot,at=Je.bones_by_name[et],it=this.skin[et];if((!G.enabled||G.data_detected_stable)&&("facemesh"!=it[0].info[1]||R.data_detected)){it[0].t_delta+=RAF_timestamp_delta;let nt=Math.max(Math.min(it[0].t_delta/it[0].t_delta_frame,1),0);if(it[0].rot)if(it[0].after_IK&&(ot=!at._update_IK_and_AddTrans||at._update_IK_and_AddTrans.length,ot&&(tt=THREE.MMD.getModels()[Je._model_index],(at.quaternion.x||at.quaternion.y||at.quaternion.z)&&(at.quaternion.conjugate(),tt._update_IK_and_AddTrans(!1,et),at.quaternion.conjugate()))),it[0].onProcessRotation)it[0].onProcessRotation.call(this,Je,et);else{let st=re.set(0,0,0,1);if(it[0].absolute&&at.quaternion.set(0,0,0,1),it[0].parent_based){let dt=it[0].rot_parent;dt||(dt=MMD_SA.get_bone_rotation_parent(Je,et,Je).conjugate()),it[0]._rot_parent=dt,st.copy(dt)}st.multiply(it[0].no_blending?it[0].rot:MMD_SA.TEMP_q.copy(it[1].rot).slerp(it[0].rot,nt)),1>it[0].ratio&&st.slerp(_e.set(0,0,0,1),1-it[0].ratio);const rt=MMD_SA_options.model_para_obj_all[Je._model_index].skin_default[et];rt&&rt.rot_scale&&("number"==typeof rt.rot_scale&&(rt.rot_scale={x:rt.rot_scale,y:rt.rot_scale,z:rt.rot_scale}),st.setFromEuler(MMD_SA.TEMP_v3.setEulerFromQuaternion(st,"YXZ").multiply(rt.rot_scale),"YXZ")),at.quaternion.multiply(st)}if(it[0].pos&&(it[0].onProcessPosition?it[0].onProcessPosition.call(this,Je,et):(it[0].absolute&&at.position.set(0,0,0),at.position.add(MMD_SA.TEMP_v3.copy(it[1].pos).lerp(it[0].pos,nt))),it[0].speed_limit)){if(!it[1].pos_last)it[1].pos_last=new THREE.Vector3;else{let st=MMD_SA.TEMP_v3.subVectors(at.position,it[1].pos_last),rt=st.length()/(Math.max(RAF_timestamp_delta,RAF_timestamp-it[1].timestamp)/1e3);rt>it[0].speed_limit&&at.position.copy(it[1].pos_last).add(st.multiplyScalar(it[0].speed_limit/rt))}it[1].pos_last.copy(at.position),it[0].pos_last=it[1].pos_last}it[0].onFinish&&it[0].onFinish.call(this,Je,et),ot&&tt._update_IK_and_AddTrans(!1,et)}}function Oe(Je){var et=Je.detail.model,tt=et.mesh,ot=MMD_SA.motion[et.skin._motion_index].para_SA,at=this.skin,it=Object.keys(at).filter(nt=>!at[nt][0].after_IK).sort((nt,st)=>{let rt=at[nt][0].priority||0,dt=at[st][0].priority||0;return rt-dt});it.forEach(nt=>{let st=tt.bones_by_name[nt];if(st||/_DUMMY_/.test(nt)){var rt=at[nt][0].info[1];(rt&&!/pose/.test(rt)||ot.motion_tracking_enabled)&&Ge.call(this,tt,nt)}})}function Ve(Je){var et=Je.detail.model,tt=et.mesh,ot=MMD_SA.motion[et.skin._motion_index].para_SA,at=this.skin,it=Object.keys(at).filter(nt=>at[nt][0].after_IK).sort((nt,st)=>{let rt=at[nt][0].priority||0,dt=at[st][0].priority||0;return rt-dt});it.forEach(nt=>{let st=tt.bones_by_name[nt];if(st||/_DUMMY_/.test(nt)){var rt=at[nt][0].info[1];(rt&&!/pose/.test(rt)||ot.motion_tracking_enabled)&&Ge.call(this,tt,nt)}})}function Qe(Je){if(!G.enabled||G.data_detected_stable){var et=Je.detail.model,tt=et.mesh,ot=et.morph.targets;et.pmx.morphs.forEach(function(rt){if(3==rt.panel){var dt=rt.name;if(et.pmx.morphs_weight_by_name[dt]){var lt=et.morph.target_index_by_name[dt];if(null!=lt){var ct=ot[lt],pt=ct.keys[0];if(1==pt.morph_type)tt.morphTargetInfluences[lt]=0;else{let mt={name:dt,weight:0,morph_type:pt.morph_type,morph_index:pt.morph_index};et.morph.onupdate(mt,mt,0,lt)}}}}});var at=MMD_SA_options.model_para_obj.facemesh_morph,it=this.morph,nt={},st=0;Object.keys(it).forEach(function(rt){let dt=it[rt];if(!dt.disabled){dt[0].t_delta+=RAF_timestamp_delta;let lt=Math.max(Math.min(dt[0].t_delta/dt[0].t_delta_frame,1),0),ct=dt[0].weight*lt+dt[1].weight*(1-lt);nt[rt]=ct,ct&&st++}}),Object.keys(nt).forEach(function(rt){let dt=it[rt],lt=nt[rt];0>lt&&("\u306B\u3084\u308A"===rt?rt="\u03C9":"\u4E0A"===rt?rt="\u4E0B":void 0,lt=-lt);let ct=at[rt],pt=ct&&ct.name||rt,mt=et.morph.target_index_by_name[pt];if(null!=mt){lt*=ct&&ct.weight||1;let ut=ot[mt],ht=ut.keys[0];if(1==ht.morph_type)tt.morphTargetInfluences[mt]=lt;else{let gt={name:pt,weight:lt,morph_type:ht.morph_type,morph_index:ht.morph_index};et.morph.onupdate(gt,gt,0,mt)}}})}}var Ze,Ne;window.addEventListener("jThree_ready",()=>{Ze=new THREE.Vector3,Ne=new THREE.Quaternion});var $e=function(Je){this.model_num=Je,this.skin={},this.morph={},this.process_bones=Oe.bind(this),this.process_bones_after_IK=Ve.bind(this),this.process_morphs=Qe.bind(this)};return $e.prototype.add=function(Je,et,tt){tt.info=Je.split("|");var ot=tt.info[0],at=this[ot][et];if(tt.is_dummy){if(at&&at[0].is_dummy)return;tt.no_blending=!0,tt.pos&&(tt.pos=Ze),tt.rot&&(tt.rot=Ne)}if(tt.timestamp=RAF_timestamp,tt.t_delta=0,tt.t_delta_frame=this.t_delta*(-1!=et.indexOf("\u6307")||-1!=et.indexOf("\u624B\u9996")?G.skip_hand_countdown_max+1:1),tt.t_delta_frame=Math.max(Math.min(tt.t_delta_frame,200),1e3/60),!at)this[ot][et]=[tt,tt];else if(RAF_timestamp==at[0].timestamp)at[0]=Object.assign(at[0],tt);else{if(!tt.no_blending){let it=G.use_3D_pose||"facemesh"==tt.info[1]?0.5+0.5*Math.max(Math.min((Math.max(tt.t_delta_frame,RAF_timestamp-at[0].timestamp)-50)/150,1),0):1;tt.pos&&tt.pos.lerp(at[0].pos,1-it),tt.rot&&tt.rot.slerp(at[0].rot,1-it),null!=tt.weight&&(tt.weight=tt.weight*it+at[0].weight*(1-it))}this[ot][et]=[tt,at[0]]}},$e.prototype.remove=function(Je,et){delete this[Je][et]},$e.prototype.reset=function(){this.skin={},this.morph={}},$e.prototype.add_events=function(){window.addEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs),window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones",this.process_bones),window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)},$e.prototype.remove_events=function(){window.removeEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs),window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones",this.process_bones),window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)},$e}(),Re=new Fe(0),We=H.get("camera_hidden");return j={initialized:!1,get ML_enabled(){return te},get ML_busy(){return R.busy||G.busy},get ML_fps(){return 1e3/(Math.max(R.enabled&&R.use_mediapipe&&(!G.enabled||!G.use_holistic)&&R._t||0,G.enabled&&G._t||0)||1e3)},get target_devicePixelRatio(){return ee||window.devicePixelRatio},set target_devicePixelRatio(Ge){ee=Ge==window.devicePixelRatio?0:Ge},get double_flip_mode(){return U&&!j.mirror_3D},set double_flip_mode(Ge){U=Ge},get video_flipped(){return te?!!X^!!j.double_flip_mode:X},set video_flipped(Ge){X=Ge,this.reset_video_canvas()},get display_flipped(){return!j.mirror_3D&&X!=j.video_flipped},get mirror_3D(){return te&&MMD_SA_options.user_camera.mirror_3D&&(1!=MMD_SA_options.user_camera.mirror_3D||j.visible)},get x_flipped(){return j.double_flip_mode||j.mirror_3D},get hidden_enforced(){return We||MMD_SA_options.user_camera.display.video.hidden||0<System._browser.overlay_mode||this.stream&&MMD_SA_options.user_camera.display.video.hidden_on_webcam},get display_floating(){return MMD_SA_options.user_camera.display.floating||qe},set display_floating(Ge){qe=Ge,this.video_host&&(this.video_host.style.zIndex=this.display_floating?2:0)},camera_permission_granted:!1,camera_list:null,deviceId:null,start:(()=>{var Ge=_asyncToGenerator(function*(Oe){var Ve=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(MMD_SA.reset_camera(),this._camera_reset=MMD_SA._trackball_camera.object.clone(),this.initialized&&this.visible)return this.hide(),void DEBUG_show("User camera:HIDDEN",2);var Qe={video:this.set_constraints()};try{if(Oe)this.init_stream(Oe);else{is_mobile&&(Qe.video.facingMode="user"),MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.run_event([[{message:{content:"(finding camera...)"}},{goto_branch:0}]]);let He;if(!this.camera_permission_granted||is_mobile&&!this.stream)try{He=yield navigator.mediaDevices.getUserMedia(Qe),this.camera_permission_granted=!0,this.camera_list=null}catch(Ke){if(is_mobile||!MMD_SA_options.Dungeon)throw"(ERROR: Camera unavailable, using fallback video instead)";this.camera_list=[]}if(!is_mobile){let Ke=this.camera_list;Ke||(Ke=yield navigator.mediaDevices.enumerateDevices(),Ke=Ke.filter(function(Ue){return"videoinput"==Ue.kind}),MMD_SA_options.user_camera.preference&&Ke.sort(function(Ue){return MMD_SA_options.user_camera.preference.label.test(Ue.label)&&-1||MMD_SA_options.user_camera.preference.label.test(Ue.label)&&1||0}),this.camera_list=Ke),MMD_SA_options.Dungeon&&(yield new Promise(function(Ue){MMD_SA_options.Dungeon.run_event([[{message:{content:(Ke.length?"Choose a camera."+Ke.map(function(Xe,Ye){return"\n"+(Ye+1)+". "+Xe.label}).join(""):"No camera is available on this device. Drop a local media file as input instead.")+"\n"+(Ke.length+1)+". Local media file",bubble_index:3,branch_list:Ke.map(function(Xe,Ye){return{key:Ye+1,branch_index:Ye+1}}).concat([{key:Ke.length+1,branch_index:Ke.length+1}])}}]].concat(Ke.map(function(Xe){return[{func:function(){Qe.video.deviceId=Xe.deviceId,Ue()},ended:!0}]}).concat([[{func:function(){j.local_src?(Oe=j.local_src,Ue(),MMD_SA_options.Dungeon.run_event()):(DEBUG_show("(No local media file found)",3),MMD_SA_options.Dungeon.run_event(null,0,0))}}]])))})),Oe||Qe.video.deviceId==this.deviceId||(He=yield navigator.mediaDevices.getUserMedia(Qe))}else MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.run_event(null,0,2);Oe?j.init_stream(Oe):He&&(j.init_stream(He),this.deviceId=Qe.video.deviceId),Ve&&Ve.dom_overlay&&(Ve.dom_overlay.use_dummy_webgl=!0),DEBUG_show("(User camera:ON)",2)}this.visible||(this.show(),DEBUG_show("User camera:VISIBLE",2))}catch(He){MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode&&MMD_SA_options.Dungeon.run_event({ended:!0}),j.init_stream(),console.error(He),DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}});return function start(){return Ge.apply(this,arguments)}})(),init_stream:function(Ge){if(!this.initialized){this.video=this._video=document.createElement("video"),this.video.autoplay=!0;let Oe;this.video_host=document.createElement("div"),Oe=this.video_host.style,Oe.position="absolute",Oe.left="0px",Oe.top="0px",Oe.zIndex=this.display_floating?2:0,Oe.visibility=System._browser.overlay_mode?"hidden":"inherit",Oe.display=System._browser.overlay_mode?"none":"block",SL_Host.appendChild(this.video_host),this.video_canvas=document.createElement("canvas"),Oe=this.video_canvas.style,Oe.position="absolute",Oe.left="0px",Oe.top="0px",Oe.zIndex=0,Oe.visibility="hidden",this.video_host.appendChild(this.video_canvas),this.video_canvas_bodyPix=document.createElement("canvas"),Oe=this.video_canvas_bodyPix.style,Oe.position="absolute",Oe.left="0px",Oe.top="0px",Oe.zIndex=0,Oe.visibility="hidden",this.video_host.appendChild(this.video_canvas_bodyPix),this.video_canvas_face_detection=document.createElement("canvas"),Oe=this.video_canvas_face_detection.style,Oe.position="absolute",Oe.left="0px",Oe.top="0px",Oe.zIndex=0,Oe.visibility="hidden",this.video_host.appendChild(this.video_canvas_face_detection),this.video_canvas_facemesh=document.createElement("canvas"),Oe=this.video_canvas_facemesh.style,Oe.position="absolute",Oe.left="0px",Oe.top="0px",Oe.zIndex=0,Oe.visibility="hidden",this.video_host.appendChild(this.video_canvas_facemesh)}return this.initialized=!0,this.show(),this.stream&&(this.stream.getTracks().forEach(Oe=>{Oe.stop()}),this.video.srcObject=this.stream=this.video_track=this.deviceId=null,console.log("(Previous stream stopped)")),R.enabled&&R.reset_calibration(),Ge&&"string"!=typeof Ge?void(this.stream=Ge,this.video_track=Ge.getVideoTracks()[0],this.video.srcObject=Ge,console.log("(New stream started)"),setTimeout(function(){let Oe=j.video_track.getCapabilities();System._browser.console.log(Object.entries(Oe).map(Qe=>Qe[0]+":"+JSON.stringify(Qe[1])).join("\n"));let Ve=j.video_track.getSettings();System._browser.console.log(Object.entries(Ve).map(Qe=>Qe[0]+":"+JSON.stringify(Qe[1])).join("\n"))},2e3),window.addEventListener("resize",function(){j.video_track&&j.video_track.applyConstraints(j.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(){DEBUG_show("ERROR:camera size failed to update")})})):void P(Ge)},get use_armIK(){return G.enabled||V.enabled},bodyPix:function(){var Ge,Oe=!1;return F={get enabled(){return Oe},set enabled(Ve){Oe==!!Ve||(Oe=!!Ve,Oe?(MMD_SA._renderer.devicePixelRatio=1,MMD_SA._renderer.__resize(EV_width,EV_height),SL.style.visibility="hidden"):(MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio,MMD_SA._renderer.__resize(EV_width,EV_height),SL.style.visibility="visible",j.video_canvas_bodyPix.style.visibility="hidden"))},busy:0,mask:null,allPoses:null,load:(()=>{var Ve=_asyncToGenerator(function*(Qe){this.enabled=!0,Ge||(!this.mask&&(this.mask=document.createElement("canvas"),T.load_face_cover()),Ge=yield bodyPix.load(Qe||1?{architecture:"MobileNetV1",outputStride:16,multiplier:0.5,quantBytes:2}:{architecture:"ResNet50",outputStride:32,quantBytes:2}),console.log("bodyPix loaded"))});return function load(){return Ve.apply(this,arguments)}})(),segmentPerson:(()=>{var Ve=_asyncToGenerator(function*(Qe,He){return yield this.load(),yield Ge.segmentPerson(Qe,He||{flipHorizontal:!1,internalResolution:"medium",segmentationThreshold:0.7})});return function segmentPerson(){return Ve.apply(this,arguments)}})(),toMask:(()=>{var Ve=_asyncToGenerator(function*(Qe,He,Ke){const Ue=yield this.segmentPerson(Qe,He);return this.allPoses=Ue.allPoses,Ke=Ke||{foregroundColor:{r:0,g:0,b:0,a:255},backgroundColor:{r:0,g:0,b:0,a:0}},bodyPix.toMask(Ue,Ke.foregroundColor,Ke.backgroundColor)});return function toMask(){return Ve.apply(this,arguments)}})(),update_frame:(()=>{var Ve=_asyncToGenerator(function*(Qe=j.video_canvas,He,Ke){if(Q.check_status())return j.video_canvas.style.visibility="inherit",j.video_canvas_bodyPix.style.visibility="hidden",void(SL.style.visibility="visible");if(!this.busy){this.busy=RAF_timestamp;const Xe=yield this.toMask(Qe,He,Ke);if(this.busy=0,!!this.enabled){(this.mask.width!=Xe.width||this.mask.height!=Xe.height)&&(this.mask.width=Xe.width,this.mask.height=Xe.height),this.mask.getContext("2d").putImageData(Xe,0,0),(j.video_canvas_bodyPix.width!=Qe.width||j.video_canvas_bodyPix.height!=Qe.height)&&(j.video_canvas_bodyPix.width=Qe.width,j.video_canvas_bodyPix.height=Qe.height,j.video_canvas_bodyPix.style.pixelWidth=window.innerWidth,j.video_canvas_bodyPix.style.pixelHeight=window.innerHeight);let Ye=j.video_canvas_bodyPix.getContext("2d");Ye.globalCompositeOperation="copy",Ye.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)",Ye.drawImage(this.mask,0,0,Qe.width,Qe.height),Ye.globalCompositeOperation="source-out",Ye.filter="none",Ye.save(),Ye.translate(Qe.width,0),Ye.scale(-1,1),Ye.drawImage(SL,0,0,Qe.width,Qe.height),Ye.restore(),Ye.globalCompositeOperation="destination-over",Ye.drawImage(Qe,0,0),j.video_canvas_bodyPix.style.visibility="inherit",SL.style.visibility="hidden",this.update_frame_for_face_detection(),Q.check_status()}}});return function update_frame(){return Ve.apply(this,arguments)}})(),update_frame_for_face_detection:function(){let Ve=T.face_cover;if(T.enabled&&Ve.complete){j.video_canvas_face_detection.style.visibility="hidden";let Qe=Ve.width,He=Ve.height,Ke=[];this.allPoses.forEach(function(Ue){let Xe=Ue.keypoints,Ye=Xe.find(Je=>"nose"==Je.part);if(Ye){let $e,Ze=Xe.find(Je=>"leftEye"==Je.part),Ne=Xe.find(Je=>"rightEye"==Je.part);if(Ze&&Ne){let Je=Ze.position.x-Ne.position.x,et=Ze.position.y-Ne.position.y;$e=4*Math.sqrt(Je*Je+et*et)}else $e=He;Ke.push([Ye.position.y,Ye.position.x,Math.max($e,He/2),100])}}),this.allPoses=void 0,T.update_frame_local(j.video_canvas_bodyPix,Ke)}}},F}(),face_detection:function(){function Ge(){T.initialized=!0,self.OffscreenCanvas||T.load_face_cover(),B=new Worker("js/pico.worker.js"),B.onmessage=function(Ve){var Qe="string"==typeof Ve.data&&"{"===Ve.data.charAt(0)?JSON.parse(Ve.data):Ve.data;"string"==typeof Qe?(DEBUG_show(Qe,2),T.worker_initialized=!0):(j._needs_RAF=!0,Qe._t&&DEBUG_show(Qe._t),T.dets=Qe.dets,T.busy=0,j.video_canvas_face_detection.style.left=j.video_canvas.style.left,j.video_canvas_face_detection.style.top=j.video_canvas.style.top,!self.OffscreenCanvas&&System._browser.on_animation_update.add(function(){T.update_frame_local(null,T.dets)},0,0)),T.update_frame()}}var Oe=!1;return T={initialized:!1,worker_initialized:!1,get enabled(){return Oe},set enabled(Ve){Oe==!!Ve||(Oe=!!Ve,Oe?(this.dets=null,!this.initialized&&Ge()):j.initialized&&(j.video_canvas_face_detection.style.visibility="hidden"))},load_face_cover:function(){this.face_cover||(this.face_cover=new Image,this.face_cover.src="images/laughing_man_134x120.png")},dets:null,camera_video_timestamp:0,update_frame:function(Ve){function Qe(){var He=T.enabled&&T.worker_initialized&&N&&!T.busy&&$&&T.camera_video_timestamp!=N;if(He){T.busy=RAF_timestamp,T.camera_video_timestamp=N,j.video_canvas_face_detection.style.visibility="inherit";let Ke,Ue,Xe;Ke=j.video_canvas,Ue=Ke.width,Xe=Ke.height;let Ye=Ke.getContext("2d").getImageData(0,0,Ue,Xe).data.buffer,Ze=j.video_canvas_face_detection.style;(Ze.width!=Ke.style.width||Ze.height!=Ke.style.height)&&(Ze.width=Ke.style.width,Ze.height=Ke.style.height);let Ne={rgba:Ye,w:Ue,h:Xe};!j.video_canvas_face_detection._offscreen&&self.OffscreenCanvas&&(Ne.canvas=j.video_canvas_face_detection.transferControlToOffscreen(),j.video_canvas_face_detection._offscreen=!0,console.log("(Face detection: use offscreen canvas)")),B.postMessage(Ne,Ne.canvas?[Ne.canvas,Ne.rgba]:[Ne.rgba]),Ne.rgba=Ye=void 0,Ne=void 0}}Ve||self.PoseAT?setTimeout(()=>{Qe()},0):Qe()},update_frame_local:function(Ve,Qe){let Ue,He=j.video_canvas.width,Ke=j.video_canvas.height;Ve?Ue=Ve.getContext("2d"):(Ve=j.video_canvas_face_detection,(Ve.width!=He||Ve.height!=Ke)&&(Ve.width=He,Ve.height=Ke),Ue=Ve.getContext("2d"),Ue.clearRect(0,0,He,Ke)),Ue.globalCompositeOperation="source-over";let Ne,$e,Je,et,Xe=this.face_cover,Ye=Xe.width,Ze=Xe.height;if(Qe.length){let tt=1;Qe.forEach(function(ot){Ne=ot[2]*tt,$e=Ne*Ye/Ze,Je=ot[1]*tt-$e/2,et=ot[0]*tt-Ne/2,Ue.drawImage(Xe,0,0,Ye,Ze,Je,et,$e,Ne)})}else Ne=Math.min(He,Ke),$e=Ne*Ye/Ze,Je=(He-$e)/2,et=(Ke-Ne)/2,Ue.drawImage(Xe,0,0,Ye,Ze,Je,et,$e,Ne)}},T}(),facemesh:function(){function Ge(){He=0,Ke=!0,Ue=0,Xe=[],Ye={},Ze={L:[],R:[]};var lt={L:[159,145],R:[386,374]};["L","R"].forEach(function(ct){for(var pt=0;4>pt;pt++){let mt=Ze[ct][pt]={};mt.index=pt,mt._eye_open_average=0,mt.eye_open_average=0,mt.eye_open_lower=999,mt.eye_open_data=[],mt.height_ref_pts=lt[ct]}Ye[ct]={_height_average:0,height_average:0,height_data:[],height_ref_pts:"R"==ct?[334,330]:[105,101]}})}function Oe(){if(!R.initialized){R.initialized=!0;for(var lt=0;4>lt;lt++)Je[lt]=new THREE.Vector3;var ct=[];System._browser.use_WASM_SIMD&&ct.push("simd=1"),ke&&(et=!0),ot&&(et=!0,ct.push("use_mediapipe_facemesh=1")),et&&(et=!0,R.blink_detection=!0,ct.push("use_face_landmarks=1")),tt&&ct.push("use_human_facemesh=1");var pt;return MMD_SA_options.user_camera.ML_models.worker_disabled?pt=new Promise(mt=>{W={postMessage:function(gt){FacemeshAT.onmessage({data:gt})}};let ht=document.createElement("script");ht.onload=_asyncToGenerator(function*(){yield FacemeshAT.init(W,ct),mt()}),ht.src="js/facemesh_lib.js",document.head.appendChild(ht)}):W=new Worker("js/facemesh_worker.js"+(ct.length?"?"+ct.join("&"):"")),W.onmessage=it,pt}}var Ye,Ze,$e,et,tt,ot,Qe=!1,He=0,Ke=!0,Ue=0,Xe=[],Ne=!1,Je=[];et=!is_mobile,ot=!is_chrome||is_mobile;var it=function(){var lt=0,ct=0,pt=0,mt=0;return function(ut){var ht="string"==typeof ut.data&&"{"===ut.data.charAt(0)?JSON.parse(ut.data):ut.data;if("string"==typeof ht)"OK"==ht?R.worker_initialized=!0:(DEBUG_show(ht,2),System._browser.console.log(ht));else if(ht.posenet)Le({data:ht});else{j._needs_RAF=!0;let gt="";if(ht.faces.length?R.data_detected++:R.data_detected=0,ht.faces.length&&ht.faces[0].bb_center?st=ht.faces[0].bb_center:!G.enabled&&(st=[0.5,0.5]),ht.faces.length&&R.data_detected_stable){let ft,vt,wt,yt=ht.faces[0],bt=j.x_flipped?1:-1;if(yt.rotation){const eo=yt.rotation.matrix;de.set(eo[0],eo[1],eo[2],0,eo[3],eo[4],eo[5],0,eo[6],eo[7],eo[8],0,0,0,0,1)}else{let eo=MMD_SA._v3a_.fromArray(yt.mesh[152]).sub(MMD_SA._v3b.fromArray(yt.mesh[10])).normalize(),to=MMD_SA._v3b_.fromArray(yt.mesh[454]).sub(MMD_SA._v3b.fromArray(yt.mesh[234])).normalize(),oo=MMD_SA.TEMP_v3.crossVectors(to,eo).normalize();to.crossVectors(eo,oo),de.set(to.x,to.y,to.z,0,eo.x,eo.y,eo.z,0,oo.x,oo.y,oo.z,0,0,0,0,1)}let xt=MMD_SA.TEMP_v3.setEulerFromRotationMatrix(de,"YZX");ft=-xt.x,vt=-xt.y,wt=-xt.z;let Mt,kt=yt.scaledMesh[454][0]-yt.scaledMesh[234][0],Pt=yt.scaledMesh[454][1]-yt.scaledMesh[234][1];ht.recalculate_z_rotation_from_scaledMesh?(kt/=Math.cos(vt),Pt/=Math.cos(ft),Mt=Math.sqrt(kt*kt+Pt*Pt)):(kt/=Math.cos(wt),Mt=Math.abs(kt/Math.cos(vt))),R.face_width=Mt;let It=ht.recalculate_z_rotation_from_scaledMesh?Math.asin(Pt/Mt):wt;let St=new THREE.Quaternion;St.setFromEuler(MMD_SA._v3a.set(ft,vt*bt,It*bt),"YZX");let Et=performance.now(),zt=0;mt&&(zt=Et-mt,pt+=zt,20<=++ct&&(lt=1e3/(pt/ct),ct=pt=0)),mt=Et,R._t=ht._t,Re.t_delta=lt&&1e3/lt||zt||ht.fps&&1e3/ht.fps||ht._t,R.head_pose_enabled&&Re.add("skin|facemesh","\u9996",{after_IK:!0,rot:St,_rot_ratio:R.face_width/Math.min(j.video_canvas.width,j.video_canvas.height),onProcessRotation:S}),He||(He=Date.now());let Dt=0;Ke&&(Dt=~~(100*Math.min((Date.now()-He)/5e3,Xe.length/30,Ne?Ze.L[0].eye_open_data.length/30:1,1)),Ke=100>Dt);let At=yt.faceInViewConfidence>(tt?0.75:0.9)&&(j.video==j._image||!j.video.paused&&Math.abs(vt)<Math.PI/4),Ct=MMD_SA._v3a.fromArray(yt.mesh[13]).distanceTo(MMD_SA._v3b.fromArray(yt.mesh[14])),jt=MMD_SA._v3a.fromArray(yt.mesh[61]).distanceTo(MMD_SA._v3b.fromArray(yt.mesh[291])),Tt=Ue;if(!Tt)if(At&&2>Ct&&Xe.push(jt),!Xe.length)Tt=0;else{let eo=parseInt(0.3*Xe.length);Tt=Xe.sort((to,oo)=>to-oo).slice(eo,Xe.length-eo).reduce((to,oo)=>to+oo)/(Xe.length-2*eo),Ke||(Ue=Tt)}let Bt=0,Lt=0,Ft=0,Rt=0;["L","R"].forEach(function(eo){let to=Ye[eo];if(to.height=MMD_SA._v3a.fromArray(yt.mesh[to.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(yt.mesh[to.height_ref_pts[1]])),to._height_average=to.height_average,!to._height_average)if(At&&to.height_data.push(to.height),!to.height_data.length)to._height_average=to.height;else{let oo=parseInt(0.3*Xe.length);to._height_average=to.height_data.sort((ao,io)=>ao-io).slice(oo,to.height_data.length-oo).reduce((ao,io)=>ao+io)/(to.height_data.length-2*oo),Ke||(to.height_average=to._height_average)}Ft+=to.height/to._height_average}),Ft/=2,Ft=(Ft-1)/0.25*(1<Ft?2:1),Tt&&(jt>1.05*Tt?Lt=Math.sqrt(Math.min((jt-1.05*Tt)/(0.25*Tt),1)):jt<0.98*Tt&&(Lt=-Math.sqrt(Math.min((0.98*Tt-jt)/(0.2*Tt),1))),2<Ct&&(Bt=Math.pow(Math.min((Ct-2)/(1*Tt/3),1),0.5),0.25<Lt&&(Rt=0.3*((Lt-0.25)/0.75))));let Wt=0,qt=0,Gt=0,Ot=0,Vt=0;Array.isArray(yt.emotion)&&yt.emotion.forEach(eo=>{switch(eo.emotion){case"happy":Wt+=eo.score;break;case"sad":qt+=eo.score;break;case"angry":case"disgust":Gt+=eo.score;break;case"fear":Ot+=eo.score;break;case"surprise":Vt+=eo.score;}});let Qt=Wt-(qt+Gt+Ot+0.5*Vt);0>Qt?Rt*=Math.max(1+2*Qt,0):Rt=Math.min(0.2*Qt+Rt*(1+0.5*Qt),0.4),Re.add("morph|facemesh","\u306B\u3053\u308A",{weight:Math.min(Rt+0.75*Wt,0.75)}),Re.add("morph|facemesh","\u56F0\u308B",{weight:0.75*((qt+Ot)/2)}),Re.add("morph|facemesh","\u6012\u308A",{weight:0.75*Gt}),Ft+=0.2*Vt,Re.add("morph|facemesh","\u7B11\u3044",{weight:Rt}),Re.add("morph|facemesh","\u3073\u3063\u304F\u308A",{weight:0.75*Vt}),Re.add("morph|facemesh","\u306B\u3084\u308A",{weight:Lt});let Ht=MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(ft,vt,wt),"YZX").conjugate(),Kt=[];[13,14,61,291].forEach(function(eo,to){Kt[eo]=Je[to].fromArray(yt.mesh[eo]).applyQuaternion(Ht).setZ(0)});let Ut=MMD_SA._v3a.copy(Kt[61]).add(Kt[291]).multiplyScalar(0.5),Xt=0.5*Kt[61].distanceTo(Kt[291]),Yt=Math.atan2(Kt[13].y-Ut.y,Xt),Zt=Math.atan2(Kt[14].y-Ut.y,Xt),Nt=Math.max(180*-(Yt+Zt)/Math.PI+20*Bt,0);Nt&&(Nt=Math.min(Nt/20,0.75)),Nt=Math.min(Nt+0.25*qt,1),Nt*=0.5,Bt*=1-Nt,Re.add("morph|facemesh","\u3042",{weight:Bt}),Re.add("morph|facemesh","\u304A",{weight:Nt});let $t={L:[0],R:[0]};if(et){let eo=[0,0],to=[0,0];yt.eyes.forEach(function(co,po){co&&(eo[po]=Math.max(Math.min((2*co[3]+ft/(Math.PI/2))*(1-Math.abs(ft)/Math.PI),1),-1),to[po]=Math.max(Math.min((2*co[2]-vt/(Math.PI/2))*(1-Math.abs(vt)/Math.PI),1),-1))}),["L","R"].forEach(function(co){let po=0;$t[co][po]=0;let mo=Ze[co][po],uo=MMD_SA._v3a.fromArray(yt.mesh[mo.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(yt.mesh[mo.height_ref_pts[1]])),ho=mo.eye_open_average;if(!ho)if(At){mo.eye_open_data.push(uo);let go=parseInt(0.3*mo.eye_open_data.length);ho=mo.eye_open_data.sort((yo,bo)=>yo-bo).slice(go,mo.eye_open_data.length-go).reduce((yo,bo)=>yo+bo)/(mo.eye_open_data.length-2*go),Ke||(mo.eye_open_average=ho)}else ho=mo._eye_open_average;if(At&&mo.eye_open_lower>uo&&(mo.eye_open_lower=uo),mo._eye_open_average=ho,ho)if(uo>ho)$t[co][po]=Math.min(uo/ho,1.25);else{let go=Math.min(mo.eye_open_lower,ho/2);$t[co][po]=Math.max((uo-go)/(ho-go),0)}});let oo=($t.L[0]+$t.R[0])/2;1<oo?Ft+=2*(oo-1):Ft-=0.5*(1-oo),Ft=Math.min(Ft,1);let ao=$t.L[0]+$t.R[0];ao=ao?$t.L[0]/ao:0.5;let io=eo[0]*ao+eo[1]*(1-ao),no=to[0]*ao+to[1]*(1-ao),so={absolute:!0,rot:new THREE.Quaternion().setFromEuler(MMD_SA._v3a.set(15*-(io-0.3)/180*Math.PI,20*(no*bt)/180*Math.PI,0),"YZX")};Re.add("skin|facemesh","\u4E21\u76EE",so);let ro=null!=THREE.MMD.getModels()[0].pmx.morphs_index_by_name.まばたきL,_o=ro?Math.min(Math.max(Math.abs($t.L[0]-$t.R[0])-(0.25+1*(1-Math.min(Math.max((Math.PI/6-Math.abs(vt))/(Math.PI/12),0),1))),0)/0.25,1):0,lo=Math.min($t.L[0],$t.R[0]);$t.L[0]=$t.L[0]*_o+lo*(1-_o),$t.R[0]=$t.R[0]*_o+lo*(1-_o),ro?(Re.add("morph|facemesh","\u307E\u3070\u305F\u304D"+(1==bt?"L":"R"),{weight:Math.max(Math.min(1-0.8*$t.L[0]-Rt,1),0)}),Re.add("morph|facemesh","\u307E\u3070\u305F\u304D"+(1==bt?"R":"L"),{weight:Math.max(Math.min(1-0.8*$t.R[0]-Rt,1),0)}),Re.add("morph|facemesh","\u307E\u3070\u305F\u304D",{weight:0})):Re.add("morph|facemesh","\u307E\u3070\u305F\u304D",{weight:Math.max(Math.min(1-0.8*$t.L[0]-Rt,1),0)})}else{let eo=yt.eyes[0],to=0,oo=0;eo&&(to=Math.max(Math.min((2*eo[3]+ft/(Math.PI/2))*(1-Math.abs(ft)/Math.PI),1),-1),oo=Math.max(Math.min((2*eo[2]-vt/(Math.PI/2))*(1-Math.abs(vt)/Math.PI),1),-1));let ao=0.25*Ft;0>ao&&(ao=Math.min(ao+Rt,0));let io=Math.max(Math.min(0.1-0.2*(to*(0>to?2:1))-ao,0.5),0);Re.add("morph|facemesh","\u307E\u3070\u305F\u304D",{weight:io});let no=1.25+1.75*Math.pow(($t.L[0]+$t.R[0])/2,2);to=Math.sign(to)*Math.pow(Math.abs(to),no),oo=Math.sign(oo)*Math.pow(Math.abs(oo),no);let so={absolute:!0,rot:new THREE.Quaternion().setFromEuler(MMD_SA._v3a.set(15*-to/180*Math.PI,20*(oo*bt)/180*Math.PI,0),"YZX")};Re.add("skin|facemesh","\u4E21\u76EE",so)}Re.add("morph|facemesh","\u4E0A",{weight:Math.max(Math.min(Ft,1),-1)}),gt=gt||yt.eyes.length&&[(Ke?"Calibrating("+Dt+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(100*yt.faceInViewConfidence)+"%",yt.emotion?JSON.stringify(yt.emotion):"Neutral"].join("\n"),K&&(gt+=K)}else gt="(no facemesh data)\n"+K;System._browser.overlay_mode||MMD_SA_options.user_camera.ML_models.debug_hidden||DEBUG_show((gt&&gt+"\nFPS:"+EV_sync_update.fps_last+"\n"||"")+"F-FPS:"+Math.round(lt)+"/"+Math.round(ht.fps||0)),R.busy=0}R.update_frame()}}(),nt=document.createElement("canvas"),st=[],rt=0,dt=0;return R={initialized:!1,worker_initialized:!1,get data_detected(){return rt},set data_detected(lt){lt?!rt&&(dt=RAF_timestamp):dt=0,rt=lt},get data_detected_stable(){return Qe&&dt&&250<RAF_timestamp-dt},get head_pose_enabled(){return this.data_detected_stable||!G.enabled},get blink_detection(){return Ne},set blink_detection(lt){Ne=lt,Qe&&(Ne?Ge():MMD_SA_options.auto_blink=$e)},get use_faceLandmarksDetection(){return et},set use_faceLandmarksDetection(lt){this.initialized||(et=lt)},get use_mediapipe(){return ot},set use_mediapipe(lt){return ot=lt},face_width:0,get enabled(){return Qe},set enabled(lt){Qe==!!lt||(Qe=!!lt,this.data_detected=0,st[0]=st[1]=0.5,Qe?(!this.initialized&&Oe(),$e=MMD_SA_options.auto_blink,Ge()):MMD_SA_options.auto_blink=$e,M())},get bb_center(){return st},set bb_center(lt){st=lt},reset_calibration:Ge,frames:Re,init:Oe,worker_onmessage:it,camera_video_timestamp:0,update_frame:function(lt){function ct(){var pt=R.enabled&&R.worker_initialized&&N&&!R.busy&&!(G.enabled&&G.use_holistic)&&$&&R.camera_video_timestamp!=N;if(pt){R.busy=RAF_timestamp,R.camera_video_timestamp=N,Ne&&(MMD_SA_options.auto_blink=!1);let mt,ut,ht,gt,yt,bt,ft,vt;mt=j.video_canvas;let wt=mt.width,xt=mt.height;bt=ft=0,ut=gt=wt,ht=yt=xt;let kt=1,Pt=MMD_SA_options.user_camera.pixel_limit.facemesh;Pt&&ut*ht>Pt[0]*Pt[1]&&(kt=ut/ht>Pt[0]/Pt[1]?ut/Pt[0]:ht/Pt[1],ut=gt=Math.round(ut/kt),ht=yt=Math.round(ht/kt),mt=nt,vt=!0);let Mt,It,St;if(MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio){Mt=MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio,St=Math.round(Math.min(ut,ht)*Mt),gt=St,yt=St;let At=1;const Ct=5*(ot?2:1);R.data_detected<Ct&&1>Mt&&!G.enabled&&(At=Mt+(1-Mt)*(1-Math.min(R.data_detected/Ct,1)),St=Math.round(Math.min(ut,ht)*At),It=Mt/At,Mt=At,mt=nt,vt=!0),bt=Math.max(Math.min(ut*st[0]-St/2,ut-St),0)*(It||1),ft=Math.max(Math.min(ht*st[1]-St/2,ht-St),0)*(It||1)}let Et=mt.getContext("2d");if(vt){Et.globalCompositeOperation="copy";let At=bt,Ct=ft,jt=gt,Tt=yt;It?(jt=Tt=St,(mt.width!=gt||mt.height!=yt)&&(mt.width=gt,mt.height=yt,console.log("Facemesh canvas("+ut+"x"+ht+"=>"+gt+"x"+yt+"):"+[At,Ct,St,St].join(",")+"=>"+[bt,ft,gt,yt].join(",")))):(mt.width!=gt||mt.height!=yt)&&(mt.width=gt,mt.height=yt,console.log("Facemesh canvas("+ut+"x"+ht+")")),Et.drawImage(j.video_canvas,Math.round(At*kt),Math.round(Ct*kt),Math.round(jt*kt),Math.round(Tt*kt),0,0,gt,yt)}let zt=vt?Et.getImageData(0,0,gt,yt).data.buffer:Et.getImageData(bt,ft,gt,yt).data.buffer,Dt={rgba:zt,w:ut*(It||1),h:ht*(It||1),options:{use_facemesh:!0,draw_canvas:!0,flip_canvas:j.display_flipped,bb:{x:Math.round(bt),y:Math.round(ft),w:gt,h:yt,ratio:Mt||0,scale:It||1}}};self.FacemeshAT?Dt.canvas=j.video_canvas_facemesh:!j.video_canvas_facemesh._offscreen&&self.OffscreenCanvas&&(Dt.canvas=j.video_canvas_facemesh.transferControlToOffscreen(),j.video_canvas_facemesh._offscreen=!0,console.log("(Facemesh: use offscreen canvas)")),W.postMessage(Dt,Dt.canvas?[Dt.canvas,Dt.rgba]:[Dt.rgba]),Dt.rgba=zt=void 0,Dt=void 0}}lt||self.FacemeshAT?setTimeout(()=>{ct()},0):ct()}},R}(),poseNet:function(){var Ge=!1,Oe=!0,Ve=!0,Qe={},He=null,Ke=0,Ue=0,Xe=0,Ye=null,Ze=null;return G={get enabled(){return Ge},set enabled(Ne){Ge==!!Ne||(Ge=!!Ne,Se=!1,this.data_detected=0,Xe=0,THREE.MMD.getModels()[0].mesh.visible=!0,me.set(0,0,0),Ge?(!this.initialized&&I(),MMD_SA_options.user_camera.ML_models.pose.events.enabled&&MMD_SA_options.user_camera.ML_models.pose.events.enabled()):(THREE.MMD.getModels()[0].resetPhysics(),MMD_SA_options.user_camera.ML_models.pose.events.disabled&&MMD_SA_options.user_camera.ML_models.pose.events.disabled()),M(),G.use_holistic&&setTimeout(()=>{Ge?R.enabled=V.enabled=!0:V.enabled=!1,DEBUG_show("(Holistic Mode:"+(Ge?"ON":"OFF")+")",2)},0))},get data_detected(){return Ke},set data_detected(Ne){Ne?(!Ke&&(Ue=RAF_timestamp),this.data_detected_stable&&(Xe=0)):(Ue=0,!Xe&&(Xe=RAF_timestamp),250<RAF_timestamp-Xe&&Re.reset()),Ke=Ne},get data_detected_stable(){return Ge&&(!Xe||250>RAF_timestamp-Xe||Ue&&500<RAF_timestamp-Ue)},get use_3D_pose(){return Ge&&Oe&&we},set use_3D_pose(Ne){Oe=Ne},get use_holistic(){return null==He?ke:He},set use_holistic(Ne){He=Ne},get _use_holistic_(){return ke},set _use_holistic_(Ne){ke=Ne},get skip_hand_countdown_max(){return this.use_holistic||Pe?0:1},set IK_disabled(Ne){Ve=Ne},get auto_grounding(){return null==Ye?MMD_SA_options.user_camera.ML_models.pose.auto_grounding:Ye},set auto_grounding(Ne){Ye=Ne},get ground_plane_visible(){return null==Ze?!Ge||!!MMD_SA_options.user_camera.ML_models.pose.auto_grounding:Ze},set ground_plane_visible(Ne){Ze=Ne},IK_disabled_check:function(){var Ne=new RegExp("("+toRegExp(["\u8155\uFF29\uFF2B","\u8DB3\uFF29\uFF2B","\u3064\u307E\u5148\uFF29\uFF2B"],"|")+")$"),$e=new RegExp("("+toRegExp(["\u8155\uFF29\uFF2B"],"|")+")$");return function(Je){var et=Ve&&this.use_3D_pose&&this.data_detected&&MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled&&(!Je||$e.test(Je)||!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only&&Ne.test(Je));return et&&Je&&Qe[Je]&&(et=!1),et}}(),enable_IK:function(Ne,$e){Qe[Ne]=$e},frames:Re,camera_video_timestamp:0,get busy(){return ie},get initialized(){return oe},get worker_initialized(){return ae}},G}(),handpose:function(){var Ge=!1;return V={get enabled(){return Ge},set enabled(Oe){Ge==!!Oe||(Ge=!!Oe,Ge&&!this.initialized&&I())},frames:Re,get busy(){return ie},get initialized(){return oe},get worker_initialized(){return ae}},V}(),snapshot:function(){function Ge(){var Ye=Math.ceil(3-(Date.now()-Ue)/1e3);if(0>=Ye){if(!j.visible)return void Ve(SL);if(DEBUG_show("Capturing..."),!j.stream){if(!F.enabled)return void Oe();Ke=!0}else j.target_devicePixelRatio=1,j.video_track.applyConstraints(j.set_constraints()).then(function(){System._browser.console.log("(Ready to capture)"),System._browser.on_animation_update.add(function(){return MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio,MMD_SA._renderer.__resize(EV_width,EV_height),F.enabled?void(Ke=!0):void System._browser.on_animation_update.add(function(){Oe()},0,1)},0,0)}).catch(function(){DEBUG_show("ERROR:camera size failed to update"),Qe()});System._browser.on_animation_update.remove(Ge,0)}else Xe!=Ye&&(Xe=Ye,DEBUG_show(Xe))}function Oe(){let Ye=j.video_canvas_bodyPix;Ye.width=SL.width,Ye.height=SL.height;let Ze=Ye.getContext("2d");Ze.globalCompositeOperation="source-over",Ze.drawImage(j.video_canvas,0,0),T.enabled&&Ze.drawImage(j.video_canvas_face_detection,0,0),Ze.save(),Ze.translate(Ye.width,0),Ze.scale(-1,1),Ze.drawImage(SL,0,0),Ze.restore(),Ve(Ye)}function Ve(Ye){He=!0,Ke=!1,System._browser.on_animation_update.remove(Ge,0),Ye.toBlob(function(Ze){var Ne=URL.createObjectURL(Ze);window.open(Ne),Qe()})}function Qe(){Ldebug.style.posLeft=Ldebug.style.posTop=0,Ldebug.style.transform=Ldebug.style.transformOrigin="",DEBUG_show(),Ke=!1,j.target_devicePixelRatio=0,He=!1}var Ue,Xe,He=!1,Ke=!1;return Q={init:function(){if(He)return!0;if(MMD_SA.WebXR.session){let Ye=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(!Ye.dom_overlay||!Ye.dom_overlay.use_dummy_webgl)return DEBUG_show("(No snapshot in AR WebGL)",3),!0}j.visible?(He=!0,Ue=Date.now(),Ldebug.style.posLeft=Ldebug.style.posTop=50,Ldebug.style.transformOrigin="0 0",Ldebug.style.transform="scale(5,5)",Xe=3,DEBUG_show(),DEBUG_show(Xe),System._browser.on_animation_update.add(Ge,0,0,-1)):Ve(SL)},check_status:function(){if(He)return Ke&&Ve(j.video_canvas_bodyPix),!0}},Q}(),reset_video_canvas:function(){this.video_canvas&&(this.video_canvas.width=this.video_canvas.height=N=0)},show:function(){!this.initialized||this.visible||(this.visible=!0,j.target_devicePixelRatio!=window.devicePixelRatio&&(j.target_devicePixelRatio=0,j.video_track.applyConstraints(j.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(){DEBUG_show("ERROR:camera size failed to update")})),l(),this.hidden_enforced&&this.hide())},hide:function(){this.initialized&&this.visible&&(this.visible=!1,this.video_canvas.style.visibility="hidden",T.enabled=!1,F.enabled=!1,u())},set_constraints:function(Ge){var Oe={},Ve=window.devicePixelRatio/this.target_devicePixelRatio,Qe=Math.round(window.innerWidth*Ve),He=Math.round(window.innerHeight*Ve),Ke=MMD_SA_options.user_camera.pixel_limit._default_;if(!ee&&Ke)if(MMD_SA_options.user_camera.pixel_limit.fixed)Qe=Ke[0],He=Ke[1];else if(Qe*He>Ke[0]*Ke[1]){let Ue=window.innerWidth/window.innerHeight>Ke[0]/Ke[1]?window.innerWidth/Ke[0]:window.innerHeight/Ke[1];Qe=Math.round(window.innerWidth/Ue),He=Math.round(window.innerHeight/Ue)}return j.target_width=Qe,j.target_height=He,is_mobile&&screen.orientation&&!/landscape/.test(screen.orientation.type)?(Oe.width=He,Oe.height=Qe):(Oe.width=Qe,Oe.height=He),Ge&&(Oe=Object.assign(Oe,Ge)),console.log("Camera constraints",Oe),Oe}},j}(),console:{content_list:[],log:function(){for(var t=0;t<arguments.length;t++)this.content_list.push(arguments[t])},reset:function(){this.content_list=[]},get output_text(){return this.content_list.join("\n")||"(EMPTY)"}}},_hash_sha256:{_hash_cache:{},hash:function(t){if(webkit_electron_mode){var _=webkit_electron_remote.getGlobal("HASH_SHA256");if(_)return _.hash(t)}var l=this._hash_cache[t];if(l)return l;var u=require("crypto").createHash("sha256");return u.update(t),l=this._hash_cache[t]=u.digest("hex"),l}},_media_objs_paused_:[],_gadget_resume:function(t){return t&&!SA_topmost_window.EV_sync_update.RAF_auto_paused?!1:!!SA_topmost_window.EV_sync_update.RAF_paused&&(SA_topmost_window.EV_sync_update.RAF_paused=!1,SA_topmost_window.EV_sync_update.RAF_auto_paused=!1,SA_topmost_window.System._media_objs_paused_.forEach(function(_){_.SL_MC_Play?_.SL_MC_Play():_.paused&&_.play()}),SA_topmost_window.System._media_objs_paused_=[],System._browser.update_tray(),!0)},_gadget_pause:function(t){if(SA_topmost_window.EV_sync_update.RAF_paused)return!1;SA_topmost_window.EV_sync_update.RAF_paused=!0,SA_topmost_window.EV_sync_update.RAF_auto_paused=t;for(var _=SA_topmost_window.System._media_objs_paused_,l=[top],u=0;u<SA_child_animation_max;u++)SA_topmost_window.SA_child_animation[u]&&l.push(SA_topmost_window.document.getElementById("Ichild_animation"+u).contentWindow);var g=0,P=0,M=0;return l.forEach(function(I){for(var S in I.seq_items){var E=I.seq_items[S];E._gadget_pause_disabled||E.paused||!E.count||(g++,E.pause(),_.push(E))}var A,D=[];if(A=document.getElementById("VdesktopBG"),A&&D.push(A),A=I.CANVAS_Video_Overlay&&I.CANVAS_Video_Overlay._video,A&&D.push(A),D.forEach(function(j){!j||j.paused||j.ended||(P++,j.pause(),_.push(j))}),I.SL&&I.SL._mouse_event_main&&I.SL._mouse_event_main()){var C;C=I.SL_MC_simple_mode?I.SL_MC_video_obj.paused:I.MMD_SA?I.SL_MC_video_obj.vo.audio_obj.paused:I.use_WMP&&I.WMP.in_use?3!=I.WMP.player.playState:I.SL_MC_video_obj&&I.SL_MC_video_obj.paused,C||(M++,I.SL_MC_Play(),_.push(I))}}),console.log("Gadget PAUSED (Seq/Video/MC):"+[g,P,M].join("/")),System._browser.update_tray(),!0},_returnRelativePath:function(t){return WallpaperEngine_CEF_mode?(System.Gadget.path&&0==t.indexOf(System.Gadget.path)&&(t=t.substr(System.Gadget.path.length)),t=/\:/.test(t)?toFileProtocol(t):t.replace(/\\/g,"/").replace(/^\//,""),t):t}};return System._init(),System}();
