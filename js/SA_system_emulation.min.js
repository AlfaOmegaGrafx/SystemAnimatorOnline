// (2022-04-26)
var System=function(){var System={_init:function(){try{if(!Shell_OBJ)Shell_OBJ=new ActiveXObject("Shell.Application");if(!FSO_OBJ)FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject");if(!oShell)oShell=new ActiveXObject("WScript.Shell")}catch(e){alert(e.message)}this._child_html_filename=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html";this.Gadget._init();this.Machine._init();if(!is_SA_child_animation){SA_top_window.getScreenBounds=function(){var o=-1;var a;return function(e,t,i){if(i||o!=RAF_timestamp){o=RAF_timestamp;a=webkit_electron_mode?webkit_electron_screen.getDisplayNearestPoint({x:~~e,y:~~t}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}}return a}}()}else{SA_top_window.getScreenBounds=function(e,t,i){return SA_topmost_window.getScreenBounds(e,t,i)}}if(webkit_electron_mode){if(!is_SA_child_animation){SA_top_window.getPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_window.getPosition()}return i}}();SA_top_window.getCursorPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_electron_screen.getCursorScreenPoint()}return i}}()}else{SA_top_window.getPos=function(e){return SA_topmost_window.getPos(e)};SA_top_window.getCursorPos=function(e){return SA_topmost_window.getCursorPos(e)}}}SA_top_window.resizeToAbsolute=function(){var i;return function(e,t){webkit_window.setContentSize(e,t);i=true;if(absolute_screen_mode&&!System._browser._window_move_timerID){System._browser._window_move_timerID=setInterval(function(){var t=SA_top_window.screenLeftAbsolute;var i=SA_top_window.screenTopAbsolute;var o=0;return function(){var e=SA_top_window.getPos(true);if(t!=e[0]||i!=e[1]){DEBUG_show("(window position adjusted)",3);webkit_window.setPosition(t,i);System._browser.moveWallpaper(t,i);o=999}if(++o>10){clearInterval(System._browser._window_move_timerID);System._browser._window_move_timerID=null}}}(),100)}}}();SA_top_window.moveToAbsolute=function(e,t,i){if(absolute_screen_mode&&!i){webkit_window.setPosition(~~e,~~t)}else{this.moveTo(e,t)}};SA_top_window.moveByAbsolute=function(t,i){if(absolute_screen_mode){let e=SA_top_window.getPos(true);t+=~~e[0];i+=~~e[1];webkit_window.setPosition(t,i)}else{this.moveBy(t,i)}};Object.defineProperty(SA_top_window,"screenLeftAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[0]:this.screenLeft}});Object.defineProperty(SA_top_window,"screenTopAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[1]:this.screenTop}})},Gadget:{_init:function(){this.Settings.read=this.Settings.readString;this.Settings.write=this.Settings.writeString;Object.defineProperty(this,"onSettingsClosing",{get:function(){return this._onSettingsClosing},set:function(e){this._onSettingsClosing=e;this.settings_window.onbeforeunload=function(){e({closeAction:!!this.returnValue,Action:{commit:true}});System.Gadget.settings_window.System=null;System.Gadget.settings_window.onbeforeunload=null;System.Gadget.settings_window=null}}});var e=new ActiveXObject("Microsoft.XMLDOM");e.async=false;e.resolveExternals=false;e.validateOnParse=false;e.load("gadget.xml");this.version=e.selectSingleNode("//version").text},path:xul_mode?XPCOM_object._SA_root:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",_path_folder:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",docked:is_SA_child_animation,visible:true,Settings:{_settings_need_update:false,_settings:{},_changed:{},_readString_func_readVariable:function($0,$1,$2){return eval($1)},readString:function(e,t){var i=this._settings[e];i=i?t?decodeURIComponent(i):decodeURIComponent(i).replace(/\$([^\$]+)\$/g,this._readString_func_readVariable):Settings_default._custom_[e]||"";return i},writeString:function(e,t){var i=this._settings[e]||"";var o=encodeURIComponent(t);this._settings[e]=o;if(WallpaperEngine_CEF_mode){var a=JSON.parse(localStorage.Settings_by_path);if(!SA_HTA_folder||!a[SA_HTA_folder]){console.error(SA_HTA_folder)}else{if(a[SA_HTA_folder][e]!=o){a[SA_HTA_folder][e]=o;localStorage.Settings_by_path=JSON.stringify(a)}}}if(i!=o)this._changed[e]=this._settings_need_update=true},_writeSettings:function(e,t){if(!e&&!this._settings_need_update)return;this._settings_need_update=false;SystemEXT._save_settings_only=t;try{this._writeSettings_CORE()}catch(e){}SystemEXT._save_settings_only=false},_writeSettings_CORE:function(){var e=[];var t=this._settings;t._screenLeft=t._screenTop="";for(var i in t){var o=System.Gadget.Settings.readString(i);if(!o)continue;if(i=="_screenLeft"){o=SA_top_window.screenLeftAbsolute}else if(i=="_screenTop"){o=SA_top_window.screenTopAbsolute}e.push('"'+i+'":"'+encodeURIComponent(o)+'"')}SystemEXT.SaveLocalSettings(e)}}},Environment:{win32_env:null,getEnvironmentVariable:function(e){return oShell.ExpandEnvironmentStrings("%"+e+"%")}},Machine:{_init:function(){this._init_memory=function(){if(webkit_mode)return;if(this._WMI_obj_memory)return;try{this._WMI_obj_memory=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV");this._WMI_obj_memory.init()}catch(e){}};Object.defineProperty(this,"availableMemory",{get:function(){if(webkit_mode)return SA_require("os").freemem()/(1024*1024);this._init_memory();var e=this._WMI_obj_memory.update();return e.length?parseInt(e[e.length-1].AvailableMBytes):0}});Object.defineProperty(this,"totalMemory",{get:function(){if(webkit_mode)return SA_require("os").totalmem()/(1024*1024);if(!this._totalMemory){try{var e=new WMI_Refresher("Win32_OperatingSystem");e.init();this._totalMemory=parseInt(e.update()[0].TotalVisibleMemorySize)/1024}catch(e){}}return this._totalMemory}});this.totalMemory=0;var e={_WMI_obj:null,_cpu_obj:null,_get_cpu_obj:null,_init:function(){if(webkit_mode){if(this._get_cpu_obj)return;this._cpu_obj=[{count:-1,cpus:SA_require("os").cpus()}];this._get_cpu_obj=function(){var e=this._cpu_obj;if(e[0].count!=PC_count_absolute){if(e.unshift({count:PC_count_absolute,cpus:SA_require("os").cpus()})==3)e.pop()}return e};return}if(this._WMI_obj)return;try{this._WMI_obj=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV");this._WMI_obj.init()}catch(e){}},item:function(e){if(webkit_mode){var t=this._get_cpu_obj();var i=[];for(var o=0;o<2;o++){var a=t[o].cpus[e].times;var n=0;for(var s in a)n+=a[s];i[o]={total:n,idle:a.idle}}var r=i[0].idle-i[1].idle;var n=i[0].total-i[1].total;return{usagePercentage:n?(1-r/n)*100:0}}return{usagePercentage:parseFloat(this._WMI_obj.update()[e].PercentProcessorTime)}}};Object.defineProperty(e,"count",{get:function(){if(webkit_mode){return this._get_cpu_obj()[0].cpus.length}return this._WMI_obj.update().length-1}});this._CPUs=e;Object.defineProperty(this,"CPUs",{get:function(){this._CPUs._init();return this._CPUs}});var t={_WMI_obj:null,_init:function(){if(this._battery)return;this._battery={level:1,charging:false};if("getBattery"in navigator){var t=this;navigator.getBattery().then(function(e){DEBUG_show("Use Battery Status API",2);t._battery=e})}}};Object.defineProperty(t,"batteryPercentRemaining",{get:function(){return this._battery.level*100}});Object.defineProperty(t,"isPowerLineConnected",{get:function(){return this._battery.level==1||this._battery.charging}});Object.defineProperty(t,"isBatteryCharging",{get:function(){return this._battery.charging}});this._PowerStatus=t;Object.defineProperty(this,"PowerStatus",{get:function(){this._PowerStatus._init();return this._PowerStatus}})}},Shell:{itemFromFileDrop:function(e,t){return{path:""}},itemFromPath:function(e){e=toLocalPath(e);var t=e.replace(/[\/\\][^\/\\]+$/,"");var i=e.replace(/^.+[\/\\]/,"");var o=Shell_OBJ.NameSpace(t);if(o)o=o.ParseName(i);return o?new this._FolderItem(o):null},execute:function(e,t){Shell_OBJ.ShellExecute(e,t)},chooseFolder:function(e,t){var i=Shell_OBJ.BrowseForFolder(0,e,t);return i?new this._FolderItem(i.Self):null},_FolderItem:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.metadata=function(e){var t=this.obj.ExtendedProperty("Dimensions");if(!t){var i=this.obj.Path.replace(/[\/\\][^\/\\]+$/,"");var o=Shell_OBJ.NameSpace(i);t=o.GetDetailsOf(this.obj,26)}return t};Object.defineProperty(this.constructor.prototype,"isFolder",{get:function(){return this.obj.IsFolder}});Object.defineProperty(this.constructor.prototype,"isFileSystem",{get:function(){return(ie9_native?!this.obj.IsFolder:true)&&this.obj.IsFileSystem}});Object.defineProperty(this.constructor.prototype,"isLink",{get:function(){return this.obj.IsLink}});Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Shell._FolderItem(this.obj.GetLink)}});Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.obj.Path}});Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.obj.Type}});Object.defineProperty(this.constructor.prototype,"SHFolder",{get:function(){return new System.Shell._Folder(this.obj.GetFolder)}})}this.obj=e},_Folder:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;Object.defineProperty(this.constructor.prototype,"Items",{get:function(){return new System.Shell._FolderItems(this.obj.Items())}})}this.obj=e},_FolderItems:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.item=function(e){return new System.Shell._FolderItem(this.obj.Item(e))};Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.obj.Count}})}this.obj=e}},Debug:{outputString:function(e){}},_browser:{init:function(){document.ondragstart=document.onselectstart=function(e){return false};document.onmousedown=function(e){System._browser.onmousedown(e)};document.onmouseup=function(e){System._browser.onmouseup(e)};document.onmousemove=function(e){System._browser.onmousemove(e)};document.onkeydown=function(e){System._browser.onkeydown(e)};if(!WallpaperEngine_CEF_mode||!is_SA_child_animation||browser_native_mode){document.addEventListener("mouseover",function(e){System._browser.onmouseover(e)},false);document.addEventListener("mouseout",function(e){System._browser.onmouseout_waiting(e)},false)}Object.defineProperty(document,"onmouseover",{set:function(e){System._browser.onmouseover_custom=e}});Object.defineProperty(document,"onmouseout",{set:function(e){System._browser.onmouseout_waiting_custom=e}});var l=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.document_body_style_pixelWidth=Object.getOwnPropertyDescriptor(l,"pixelWidth");this.document_body_style_pixelHeight=Object.getOwnPropertyDescriptor(l,"pixelHeight");var d=function(){if(System._browser.resize_timerID)clearTimeout(System._browser.resize_timerID);if(System._browser._window_move_timerID){let i=SA_top_window.getPos();System._browser.resize_timerID=setInterval(function(){var t=0;return function(){let e=SA_top_window.getPos(true);if(++t>10||i[0]!=e[0]||i[1]!=e[1]){clearInterval(System._browser.resize_timerID);System._browser.resize_timerID=setTimeout("System._browser.resize()",0)}}}(),10)}else System._browser.resize_timerID=setTimeout("System._browser.resize()",0)};Object.defineProperty(l,"_set",{get:function(){return d}});if(ie9_native){Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System._browser.document_body_style_pixelWidth.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelWidth.set.call(this,e)}});Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System._browser.document_body_style_pixelHeight.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelHeight.set.call(this,e)}})}Object.defineProperty(this,"overlay_mode",function(){var t=0;var e="";var i="";if(0){setTimeout(()=>{System._browser.overlay_mode=2},500)}return{get:function(){return t},set:function(e){if(e==t)return;switch(e){case 2:bg_state_default=LdesktopBG_host.style.display;LdesktopBG_host.style.display="none";i=document.body.style.backgroundColor;document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden";if(this.camera.video_host){this.camera.video_host.style.visibility="hidden";this.camera.video_host.style.display="none"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="hidden";document.getElementById("Ldungeon_inventory").style.visibility="hidden";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}break;default:if(t==2){LdesktopBG.style.backgroundColor=bg_state_default;document.body.style.backgroundColor=i}Lmenu_host.style.visibility="inherit";if(this.camera.video_host){this.camera.video_host.style.visibility="inherit";this.camera.video_host.style.display="block"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="inherit";document.getElementById("Ldungeon_inventory").style.visibility="inherit";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}}if(document.getElementById("Ldungeon_UI"))Ldungeon_inventory.style.posLeft=Ldungeon_inventory_backpack.style.posLeft=(B_content_width-MMD_SA_options.Dungeon.inventory.max_base*64)*(e?1:.5);t=e}}}());var c=is_SA_child_animation&&parent.MMD_SA_options&&parent.MMD_SA_options.child_animation_as_texture;if(c){this.onkeydown({keyCode:97+SA_child_animation_id})}var e=System.Gadget.Settings.readString("SA_docked");if(e)System.Gadget.docked=!!parseInt(e);else{if(c)System.Gadget.docked=false}var e=document.createElement("div");e.id="Ldrag_dummy";var i=e.style;i.position="absolute";i.posLeft=i.posTop=0;i.zIndex=999;i.border="1px solid rgba(128,128,128,0.5)";i.visibility="hidden";document.body.appendChild(e);this.body=document.getElementById("Lbody_host")||document.body;if(w3c_mode)this.body.style.transition="opacity 0.5s";this.Opacity=1;var t=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(t){if(!self.SA_wallpaper_src){var p=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.FileExists(p)){try{var u=FSO_OBJ.OpenTextFile(p,1);self.SA_wallpaper_src=u.ReadLine();u.Close()}catch(e){}}}if(!self.SA_wallpaper_mask_src){var m=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.FileExists(m)){try{var u=FSO_OBJ.OpenTextFile(m,1);self.SA_wallpaper_mask_src=u.ReadLine();u.Close()}catch(e){}}}}if(t)t=System.Gadget.Settings.readString("WallpaperAsBG")||self.SA_wallpaper_src;var f;if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay.use_wallpaper_as_bg||self.EQP_use_wallpaper){f=t=true}var h;var o,a;this.Opacity=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.Gadget.Settings.readString("Opacity")||1);if(is_SA_child_animation&&!self.SA_wallpaper_src&&!f){t=t&&parent.WMP_wallpaper_mask&&parent.use_HTML5&&!parent.System.Gadget.Settings.readString("CSSTransform3D")&&!System.Gadget.Settings.readString("DisableWallpaperMask");if(t&&self.EQP_video_options&&EQP_video_options.use_canvas_video){t=false;this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");this.WMPMask_Draw()}this.wallpaper_mask_disabled=!t;if(t)h=parent.WMP_wallpaper_mask}else{var v;if(!is_SA_child_animation){o=System.Gadget.Settings.readString("_screenLeft");a=System.Gadget.Settings.readString("_screenTop")}o=o?parseInt(o):null;a=a?parseInt(a):null;if(t){if(w3c_mode&&self.SA_wallpaper_src&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)){var n=document.createElement("video");n.id="VdesktopBG";var s=n.style;s.position="absolute";s.posTop=s.posLeft=0;s.width=parent.screen.width+"px";s.height=parent.screen.height+"px";s.objectFit="cover";LdesktopBG.appendChild(n);n.autoplay=n.loop=true;n.src=toFileProtocol(SA_wallpaper_src)}this.wallpaper_mask_disabled=WallpaperEngine_CEF_mode||!!System.Gadget.Settings.readString("DisableWallpaperMask");var y,r,g;var i=LdesktopBG.style;try{i.pixelWidth=parent.screen.width;i.pixelHeight=parent.screen.height;var M=oShell.RegRead("HKCU\\Control Panel\\Colors\\Background");i.backgroundColor=/^\#/.test(M)?M:"rgb("+M.replace(/\W+/g,",")+")";y="HKCU\\Control Panel\\Desktop\\";if(WallpaperEngine_CEF_mode)r=oShell.RegRead(y+"Wallpaper")||self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;else r=self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.RegRead(y+"Wallpaper");if(r){if(!this.wallpaper_mask_disabled){h=self.SA_wallpaper_mask_src||r.replace(/\.\w{3,4}$/,"_mask.png");if(!ValidatePath(h))h=null}g=oShell.RegRead(y+"WallpaperStyle");this.updateWallpaper(r,g)}this.moveWallpaper(o||0,a||0);if(!is_SA_child_animation||self.SA_wallpaper_src)LdesktopBG_host.style.display="block"}catch(e){console.error(e);LdesktopBG_host.style.display="none"}if(h){if(!this.bg_mask)this.bg_mask="(blank)"}else{v=true}}else{v=true}if(v&&this.Opacity<1&&(w3c_mode||HTA_use_GPU_acceleration)){this.body.style.opacity=this.Opacity;DEBUG_show("Opacity:"+this.Opacity*100+"%",2)}}if(f&&!h)this.bg_mask="(blank)";if(t&&(h||this.bg_mask)){var _=document.createElement("canvas");_.id="C_wallpaper_mask";_._WallpaperAsBG_custom=f;_.onmousedown=function(){return false};if(!is_SA_child_animation||f){try{var b=_.width=parent.screen.width;var w=_.height=parent.screen.height;var S=_.getContext("2d");var A;if(!this.wallpaper_canvas_update){this.wallpaper_canvas_update=function(e,c){S.fillStyle=i.backgroundColor;S.fillRect(0,0,b,w);if(!e){if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper)e.img.img_obj._match_str=null})}return}var t;if(c=="0"){t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var o=parent.screen.height;var a,n,s,r,_,l,d,c;if(i>e){a=0;_=(i-e)/2;s=d=e}else{a=(e-i)/2;_=0;s=d=i}if(o>t){n=0;l=(o-t)/2;r=c=t}else{n=(t-o)/2;l=0;r=c=o}var p=C_wallpaper_mask.getContext("2d");p.drawImage(this,a,n,s,r,_,l,d,c);System._browser.BGMask_Create(!h);if(!h)return;var u=new Image;u.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,a,n,s,r,_,l,d,c);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};u.src=toFileProtocol(h)}}else{t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var o=parent.screen.height;var a,n,s,r,_;var l=C_wallpaper_mask.getContext("2d");if(c=="6"){a=Math.max(e/i,t/o);r=Math.round((i-e/a)/2);_=Math.round((o-t/a)/2);n=Math.round(e/a);s=Math.round(t/a);l.drawImage(this,0,0,e,t,r,_,n,s)}else{a=Math.min(e/i,t/o);r=Math.round((e/a-i)/2*a);_=Math.round((t/a-o)/2*a);n=Math.round(i*a);s=Math.round(o*a);l.drawImage(this,r,_,n,s,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)}System._browser.BGMask_Create(!h);if(!h)return;var d=new Image;d.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,r,_,n,s);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};d.src=toFileProtocol(h)}}if(A)A.onload=null;A=new Image;A.onload=t;A.src=toFileProtocol(e)}}this.wallpaper_canvas_update(r,g);if(!r){setTimeout("System._browser.BGMask_Create(true)",0)}}catch(e){}}var D=_.style;D.position="absolute";D.posLeft=-(o||0);D.posTop=-(a||0);D.zIndex=60;D.visibility="hidden";document.body.appendChild(_);this.mouseover_hide_list.push(_);if(is_SA_child_animation){this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");if(this.bg_mask)System._browser.BGMask_Create(!h);this.WMPMask_Draw()}}this._s_left=o;this._s_top=a},updateWallpaper:function(e,t){var i=LdesktopBG.style;var o;if(e!=null){e=decodeURIComponent(e);if(this._wallpaper_last!=e){o=true;this._wallpaper_last=e;i.backgroundImage=e?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+"/"+e)+")":"";if(this.wallpaper_opacity)i.opacity=this.wallpaper_opacity;if(this.wallpaper_bg_color)LdesktopBG_host.style.backgroundColor=this.wallpaper_bg_color}}else e=this._wallpaper_last;var a="HKCU\\Control Panel\\Desktop\\";if(t==null){t=oShell.RegRead(a+"WallpaperStyle")}if(this._wallpaper_style!=t){o=true;this._wallpaper_style=t}if(t=="0"){i.backgroundSize="";i.backgroundPosition="center center";if(oShell.RegRead(a+"TileWallpaper")=="0"){i.backgroundRepeat="no-repeat"}else{i.backgroundRepeat=""}}else if(t=="2"){i.backgroundSize="100% 100%";i.backgroundPosition="";i.backgroundRepeat=""}else if(t=="6"){i.backgroundSize="contain";i.backgroundPosition="center center";i.backgroundRepeat="no-repeat"}else{i.backgroundSize="cover";i.backgroundPosition="center center";i.backgroundRepeat="no-repeat";if(browser_native_mode){i.width="100%";i.height="100%"}else{i.pixelWidth=parent.screen.width;i.pixelHeight=parent.screen.height}if(windows_mode&&e){var n=loadImageDim(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+toLocalPath("\\")+e);if(n.w){var s=parent.screen.width/parent.screen.height;var r=(parent.screen.width*2-parent.screen.availWidth)/(parent.screen.height*2-parent.screen.availHeight);var _=n.w/n.h;if(_<s){i.pixelHeight=_<r?parent.screen.height*2-parent.screen.availHeight:Math.round(parent.screen.width/_)}else if(_>s){i.pixelWidth=_>r?parent.screen.width*2-parent.screen.availWidth:Math.round(parent.screen.height*_)}}}}if(this.wallpaper_canvas_update&&o){this.wallpaper_canvas_update(e,t);DEBUG_show("(Wallpaper canvas updated)",2)}},WMPMask_Draw:function(e){if(!this.C_WMP_wallpaper_mask_resized)return;if(!e)e=parent.SL;if(!e||!e.width)return;var d=document.body.style;var t=d.pixelWidth;var i=d.pixelHeight;if(!t)return;var c=0;var p=0;var u=e.width;var h=e.height;var m=this.C_WMP_wallpaper_mask_resized;if(m.width!=u){m.width=u;m.height=h;var f=parent.C_WMP_wallpaper_mask;m.getContext("2d").drawImage(f,0,0,f.width,f.height,0,0,u,h)}var o=this.bg_mask_image_resized;if(o&&o.width!=t){o.width=t;o.height=i;var v=this.bg_mask_image;o.getContext("2d").drawImage(v,0,0,v.width,v.height,0,0,t,i)}var t,i;t=self.B_content_width?B_content_width:document.body.style.pixelWidth;i=self.B_content_height?B_content_height:document.body.style.pixelHeight;var y=parent.SA_child_animation[SA_child_animation_id];var g=y.x;var M=y.y;if(is_SA_child_animation&&parent.EQP_border_width){g-=parent.EQP_border_width;M-=parent.EQP_border_width}var a=g-c;var n=a;if(a<0)a=0;if(n<0)n=-n;else n=0;var s=M-p;var r=s;if(s<0)s=0;if(r<0)r=-r;else r=0;var _=u+c-g;if(_>t)_=t;var b=h+p-M;if(b>i)b=i;var l=this.C_WMP_wallpaper_mask_mixed_resized;if(l.width!=t||l._x!=a||l._y!=s){l.width=t;l.height=i;var w=l.getContext("2d");w.drawImage(m,a,s,_,b,n,r,_,b);if(o)w.drawImage(o,0,0);l._x=a;l._y=s}var S=document.getElementById("C_wallpaper_mask");if(!S)return;S.width=t;S.height=i;var w=S.getContext("2d");w.globalCompositeOperation="copy";w.drawImage(e,a,s,_,b,n,r,_,b);w.globalCompositeOperation="destination-in";w.drawImage(l,0,0)},BGMask_CreateCanvas:function(d,c){if(!d)return null;if(!/^\((.+)\)$/.test(d)){return null}var e=RegExp.$1.split("|");var p=e[0];var t;if(p=="circle"){var i=parseInt(e[1]);var o=parseInt(e[2]);t=document.createElement("canvas");t.width=i;t.height=o;var u=i<o?i:o;var a=t.getContext("2d");a.beginPath();a.arc(i/2,o/2,u/2,0,Math.PI*2);a.fill()}else if(p=="feather"){var i=parseInt(e[1]);var o=parseInt(e[2]);var n=parseInt(e[3]);if(!n)n=parseInt(Math.sqrt(i*i+o*o)/25);t=document.createElement("canvas");t.width=i;t.height=o;var a=t.getContext("2d");var s;if(c)s=a.createImageData(i,o);else{a.fillRect(0,0,i,o);s=a.getImageData(0,0,i,o)}var h=s.data;for(var m=3,f=h.length;m<f;m+=4){var v=(m-3)/4;var y=v%i;var g=parseInt(v/i);var M=1.2;var r=1;if(y<n)r=(y+1)/(n+1);else if(y>=i-n)r=(i-y)/(n+1);r=1-(1-r)*M;if(r<0)r=0;var _=1;if(g<n)_=(g+1)/(n+1);else if(g>=o-n)_=(o-g)/(n+1);_=1-(1-_)*M;if(_<0)_=0;var l=r<_?r:_;if(l==1)continue;if(r<1&&_<1){var b=1-r;var w=1-_;var S=b>w?w/b:b/w;var A=Math.sqrt(1+S*S);l=1-(1-l)*A;if(l<0)l=0}h[m]=c?Math.round(255*(1-l)):Math.round(255*l)}a.putImageData(s,0,0)}return t},BGMask_Create:function(e){var t=this.bg_mask;if(!t)return;if(e){this.wallpaper_canvas=C_wallpaper_mask;C_wallpaper_mask.style.display="none"}else{var i=this.wallpaper_canvas=document.createElement("canvas");if(!is_SA_child_animation){i.width=parent.screen.width;i.height=parent.screen.height;i.getContext("2d").drawImage(C_wallpaper_mask,0,0)}}if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper&&e.img)e.img.img_obj._match_str=null})}if(/^\((.+)\)$/.test(t)){this.bg_mask_image=this.BGMask_CreateCanvas(t,is_SA_child_animation);this.BGMask_onload();return}var o=this.bg_mask_image=new Image;o.onload=this.BGMask_onload;o.src=toFileProtocol(t)},BGMask_onload:function(){var e=document.getElementById("C_BG_mask");if(!e){e=document.createElement("canvas");e.id="C_BG_mask";var t=e.style;t.position="absolute";t.posTop=t.posLeft=0;t.zIndex=60+1;document.body.appendChild(e)}if(System._browser.mouseover_hide_list.indexOf(e)==-1)System._browser.mouseover_hide_list.push(e);if(is_SA_child_animation){System._browser.bg_mask_image_resized=document.createElement("canvas")}else{System._browser.BGMask_Draw()}},BGMask_Draw:function(e){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom)){this.WMPMask_Draw();return}if(!document.getElementById("C_BG_mask"))return;var t,d,i,o;t=i=self.B_content_width?B_content_width:document.body.style.pixelWidth;d=o=self.B_content_height?B_content_height:document.body.style.pixelHeight;if(i>parent.screen.width)i=parent.screen.width;if(o>parent.screen.height)o=parent.screen.height;var a,n,s,r;var _=C_wallpaper_mask.style;if(_.posLeft>0){a=0;s=_.posLeft}else{a=-_.posLeft;s=0}if(_.posTop>0){n=0;r=_.posTop}else{n=-_.posTop;r=0}if(e){var c=a+","+n+","+i+","+o+","+s+","+r+","+i+","+o;if(e._match_str==c)return;e._match_str=c;e.width=t;e.height=d;var l=e.getContext("2d");l.globalCompositeOperation="copy";l.drawImage(this.wallpaper_canvas,a,n,i,o,s,r,i,o);return}if(!this.bg_mask_image&&this.Opacity==1){document.getElementById("C_BG_mask").style.display="none";return}C_BG_mask.width=t;C_BG_mask.height=d;var l=C_BG_mask.getContext("2d");l.globalCompositeOperation="copy";l.globalAlpha=this.bg_mask_image?1:1-this.Opacity;l.drawImage(this.wallpaper_canvas,a,n,i,o,s,r,i,o);if(this.bg_mask_image){l.globalCompositeOperation="destination-out";l.globalAlpha=this.Opacity;l.drawImage(this.bg_mask_image,0,0,i,o)}else C_BG_mask.style.display="block"},resize_timerID:null,resize_cooling_timestamp:0,resize:function(){var e=false;function i(){if(!e){e=true;setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0)}}return function(){this.resize_timerID=null;if(use_SA_browser_mode){let t=document.body.style;if(is_SA_child_animation){let e=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;e.width=t.pixelWidth+"px";e.height=t.pixelHeight+"px";i()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.System._browser.capturePage_in_process){this.resize_timerID=setTimeout("System._browser.resize()",50);return}if(webkit_electron_mode)System._browser.resize_cooling_timestamp=performance.now();SA_top_window.resizeToAbsolute(t.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),t.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}i()}}}}(),drag_mouse_x:-1,drag_mouse_y:-1,drag_timerID:null,is_dragging:false,mouseout_timerID:null,mouseover_hide_list:[],onmouseover_custom:null,onmouseover:function(e){if(webkit_electron_mode&&(SA_topmost_window.returnBoolean("IgnoreMouseEvents")||SA_topmost_window.returnBoolean("AutoItStayOnDesktop"))&&!SA_topmost_window.webkit_IgnoreMouseEvents_disabled)return;if(this.onmouseover_custom&&this.onmouseover_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="hidden"},onmouseout_waiting_custom:null,onmouseout_waiting:function(e){if(this.onmouseout_waiting_custom&&this.onmouseout_waiting_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=e.clientX;var i=e.clientY;var o=document.body.style;var a=t>0&&t<o.pixelWidth&&(i>0&&i<o.pixelHeight);if(w3c_mode)e.stopPropagation();this.mouseout_timerID=setTimeout("System._browser.onmouseout("+a+")",200)},onmouseout:function(e){this.mouseout_timerID=null;if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}if(this.is_dragging){this.is_dragging=false;e=false;this.showFocus(false);System.Gadget.Settings._writeSettings(true,true)}else if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.is_dragging=false;this.showFocus(false)}if(e)return;var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="inherit";this.BGMask_Draw()},onmousedown:function(e){if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}var t=this.mouseover_hide_list;var i=true;for(var o=0;o<t.length;o++){var a=t[o].style;if(a.visibility!="hidden"){a.visibility="hidden";i=false}}var n;if(!i&&!is_SA_child_animation&&SA_child_animation_max){for(var o=0;o<SA_child_animation_max;o++){if(SA_child_animation[o]){n=true;break}}}i=!n;if(i){var s,r;if(WallpaperEngine_mode){s=e.x;r=e.y}else{if(absolute_screen_mode){s=SA_top_window.getCursorPos().x;r=SA_top_window.getCursorPos().y}else{s=e.screenX;r=e.screenY}}if(!is_SA_child_animation||!parent.returnBoolean("ChildDragDisabled")||true)this.drag_timerID=setTimeout("System._browser.onmousedown_dragStart("+s+","+r+")",200)}else DEBUG_show("(focused)",1)},showFocus:function(e,t){if(is_SA_child_animation){if(!xul_mode||!this.is_dragging)parent.System._browser.showFocus(e)}if(!e){Ldrag_dummy.style.visibility="hidden";return}var i=document.body.style.pixelWidth;var o=document.body.style.pixelHeight;if(i&&o){var a=Ldrag_dummy.style;a.pixelWidth=i-2;a.pixelHeight=o-2;a.visibility="inherit"}if(t)DEBUG_show("(selected)",1)},arrangeChildZ:function(i){System.Gadget.Settings._settings_need_update=true;var e=[];for(var t=0;t<SA_child_animation_max;t++){if(SA_child_animation[t])e[t]={index:t,z:SA_child_animation[t].z}}e.sort(function(e,t){return e.index==i?1:t.index==i?-1:e.z-t.z}).forEach(function(e,t){SA_child_animation[e.index].z=document.getElementById("Ichild_animation"+e.index).style.zIndex=t})},_child_selected:null,_drag_disabled:false,_child_drag_disabled:false,onmousedown_dragStart:function(e,t){this.drag_timerID=null;if(WallpaperEngine_mode)return;if(is_SA_child_animation&&is_SA_child_animation_host){parent.System._browser.is_dragging=true;parent.System._browser.drag_mouse_x=e;parent.System._browser.drag_mouse_y=t;DEBUG_show("drag start",1);this.showFocus(true);return}if(!this._drag_disabled&&(!is_SA_child_animation||!parent.System._browser._child_drag_disabled)){this.is_dragging=true;this.drag_mouse_x=e;this.drag_mouse_y=t;DEBUG_show("drag start",1)}this.showFocus(true);if(is_SA_child_animation){parent.System._browser.arrangeChildZ(SA_child_animation_id)}},_BL_clicked:0,_BL_clicked_max:1,_BL_clicked_timerID:null,onmouseup_custom:null,onmouseup:function(e){if(this.onmouseup_custom&&this.onmouseup_custom(e))return;this.onmouseout(true);if(this._drag_disabled||is_SA_child_animation&&parent.System._browser._child_drag_disabled)this.showFocus(false);if(e.clientX>20||e.clientY<document.body.style.pixelHeight-20)return;if(this._BL_clicked_timerID){clearTimeout(this._BL_clicked_timerID);this._BL_clicked_timerID=null}if(++this._BL_clicked<this._BL_clicked_max){this._BL_clicked_timerID=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250);return}this._BL_clicked=0;if(!WallpaperEngine_mode&&(!self.Lquick_menu||!Lquick_menu._activated))this.confirmClose()},confirmClose:function(e){if(browser_native_mode){if(confirm("This will reload System Animator.")){SA_topmost_window.location.reload()}return}if(!e||xul_mode){System._browser.showFocus(true,true);var t=is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.is_SA_hosted){if(confirm("Close "+SystemEXT._default.gadget_name+" (XUL host)?")){SA_top_window.opener.close();return}t+=" (this animation only)"}System._browser.showFocus(false)}if(is_SA_child_animation){if(is_SA_child_animation_host){parent.System._browser.confirmClose(e)}else{parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id]=null;var i=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);i.style.pixelWidth=i.style.pixelHeight=0;i.style.visibility="hidden";i.contentWindow.location.replace("z_blank.html")}}else{if(WallpaperEngine_CEF_mode&&!W8_or_above){SA_top_window.location.reload()}else SA_top_window.close()}},onSettings:function(){if(!System.Gadget.settingsUI)return false;if(use_inline_dialog){if(document.getElementById("Idialog").style.visibility=="hidden"){document.getElementById("Idialog").contentWindow.location.replace("settings.html")}return true}System._browser.showFocus(true,true);var e=showModalDialog(System.Gadget.settingsUI,self);e=xul_mode?self.returnValue:e;System._browser.showFocus(false);this.onSettingsClosed(e);return true},onSettingsClosed:function(e){if(System.Gadget.onSettingsClosed)System.Gadget.onSettingsClosed({closeAction:!!e,Action:{commit:true}})},onkeydown:function(e){var d=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host;var t=e.keyCode;if(t==67){this.confirmClose();return true}else if(t==69){return this.onSettings()}else if(t==79){var i;if(is_SA_child_animation){var o=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;i=this.Opacity;if("_opacity_"in e){i=e._opacity_}else{i-=.25;if(i<.25)i=1}parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id].opacity=i;o.opacity=i}else if(this.bg_mask){i=this.Opacity;if("_opacity_"in e){i=e._opacity_}else{i-=.25;if(i<.25)i=1}System.Gadget.Settings.writeString("Opacity",i);this.Opacity=i;this.BGMask_Draw()}else if(w3c_mode||HTA_use_GPU_acceleration){var o=this.body.style;i=this.Opacity;if("_opacity_"in e){i=e._opacity_}else{i-=.25;if(i<.25)i=1}System.Gadget.Settings.writeString("Opacity",i);o.opacity=i}else return false;this.Opacity=i;DEBUG_show("Opacity:"+i*100+"%",2);this.update_tray();return true}else if(t==83){var c=System.Gadget.docked?System.Gadget.onUndock:System.Gadget.onDock;if(!c)return false;setTimeout(System._browser.ondockundock,0);return true}else if(d&&(t>=49&&t<49+SA_child_animation_max)){var a=t-49;var n=is_SA_child_animation?parent:self;var s=n.document.getElementById("Ichild_animation"+a);if(!s||!s.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(a+1)+" not found)",2);return true}var r=s.contentWindow;var _=r.parent;var l=_.System._browser;if(r.System.Gadget.Settings.readString("CSSTransform3D")||_.System.Gadget.Settings.readString("CSSTransform3D")){if(l._child_selected==a){l._child_selected=null;r.DEBUG_show("(deselected)",2);_.DEBUG_show("(child"+(a+1)+" deselected)",2);return true}l._child_selected=a}r.DEBUG_show("(selected)",2);_.DEBUG_show("(child"+(a+1)+" selected)",2);l.arrangeChildZ(a);r.focus();return true}else if(d&&t==96){var n=is_SA_child_animation?parent:self;var o=n.Lchild_animation_parent.style;o.visibility=o.visibility=="hidden"?"visible":"hidden";if(webkit_mode)o.display=o.visibility=="hidden"?"none":"block";n.System._browser._child_selected=null;return true}else if(d&&(t>=97&&t<97+SA_child_animation_max)){var a=t-97;var n=is_SA_child_animation?parent:self;var s=n.document.getElementById("Ichild_animation"+a);if(!s||!s.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(a+1)+" not found)",2);return true}var o=s.style;o.visibility=o.visibility=="hidden"?"visible":"hidden";if(webkit_mode)o.display=o.visibility=="hidden"?"none":"block";n.System._browser._child_selected=null;var p=false;for(var u=0;u<SA_child_animation_max;u++){var s=n.document.getElementById("Ichild_animation"+u);if(s&&s.contentWindow.is_SA_child_animation&&s.style.visibility!="hidden"){p=true;break}}n.document.getElementById("Lchild_animation_parent").style.visibility=p?"visible":"hidden";return true}else if(t>=96&&t<96+10){if(self.MMD_SA&&MMD_SA_options.motion_shuffle&&MMD_SA.use_jThree&&MMD_SA.MMD_started){if(this.camera.ML_enabled){}else if(t==96){if(MMD_SA_options._motion_shuffle){if(!MMD_SA_options.motion_shuffle_list_default&&MMD_SA_options._motion_shuffle_list_default){MMD_SA_options.motion_shuffle_list_default=MMD_SA_options._motion_shuffle_list_default.slice();MMD_SA._force_motion_shuffle=true}else{MMD_SA_options.motion_shuffle=MMD_SA_options._motion_shuffle.slice(0);MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motions shuffled)",2)}}}else{var a=t-97;if(MMD_SA_options.motion_by_song_name){if(MMD_SA_options.motion_by_song_name._loading_){DEBUG_show("(music/motion loading)",2);return true}let e=Object.keys(MMD_SA_options.motion_by_song_name).find(e=>{return MMD_SA_options.motion_by_song_name[e].key==a+1});if(e){let t=MMD_SA_options.motion_by_song_name[e].song_path;if(/\.zip\#/i.test(t)){MMD_SA_options.motion_by_song_name._loading_=true;t=t.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let e=new self.XMLHttpRequestZIP;e.onload=function(){MMD_SA_options.motion_by_song_name._loading_=false;let e=this.response;e.name=t.replace(/^.+[\/\\]/,"");e.isFileSystem=true;SA_DragDropEMU(e)};e.open("GET",t,true);e.responseType="blob";e.send()}else SA_DragDropEMU(t);return true}}if(a>=MMD_SA.normal_action_length){DEBUG_show("(MMD motion not found)",2);return true}if(!MMD_SA_options._motion_shuffle)MMD_SA_options._motion_shuffle=MMD_SA_options.motion_shuffle.slice(0);MMD_SA_options.motion_shuffle=[a];MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motion changed)",2)}return true}}return false},ondockundock:function(){DEBUG_show("Dock state changed",2);var e=!System.Gadget.docked;System.Gadget.docked=e;System.Gadget.Settings.writeString("SA_docked",!!e==!!is_SA_child_animation?"":e?"1":"0");var t=!e?System.Gadget.onUndock:System.Gadget.onDock;if(!t)return;t()},onmousemove_custom:null,onmousemove:function(e){var t,i;if(WallpaperEngine_mode||browser_native_mode){t=this._WE_mouse_x=e.x;i=this._WE_mouse_y=e.y}if(this.onmousemove_custom&&this.onmousemove_custom(e))return;if(!this.is_dragging){if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.onmousemove(e)}return}if(!WallpaperEngine_mode){if(absolute_screen_mode){t=SA_top_window.getCursorPos().x;i=SA_top_window.getCursorPos().y}else{t=e.screenX;i=e.screenY}}if(is_SA_child_animation||this._child_selected!=null){var o,a,n;if(is_SA_child_animation){n=SA_child_animation_id;o=self;a=parent}else{n=this._child_selected;o=document.getElementById("Ichild_animation"+n).contentWindow;a=self}a.System.Gadget.Settings._settings_need_update=true;var s=a.SA_child_animation[n];var r=a.document.getElementById("Ichild_animation"+n).style;var d=o.document.body.style;var c=a.document.body.style;var _=s.x+t-this.drag_mouse_x;var l=s.y+i-this.drag_mouse_y;r.posLeft=s.x=_;r.posTop=s.y=l;o.document.getElementById("Ldebug").innerText=a.document.getElementById("Ldebug").innerText="(moving)";o.DEBUG_hide_sec=a.DEBUG_hide_sec=0;o.DEBUG_show("("+_+","+l+")",2)}else{System.Gadget.Settings._settings_need_update=true;this.moveBy(t-this.drag_mouse_x,i-this.drag_mouse_y,e)}this.moveWallpaper();this.drag_mouse_x=t;this.drag_mouse_y=i},moveWallpaper:function(e,t){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom))return;if(is_SA_child_animation||document.getElementById("LdesktopBG")&&LdesktopBG.style.display!="none"){if(WallpaperEngine_mode){e=0;t=0}else{if(absolute_screen_mode){if(e==null)e=SA_top_window.screenLeftAbsolute;if(t==null)t=SA_top_window.screenTopAbsolute;var i=SA_top_window.getScreenBounds(e,t);e=-(e-i.x);t=-(t-i.y)}else{if(e==null)e=SA_top_window.screenLeft;if(t==null)t=SA_top_window.screenTop;e=-(e%parent.screen.width);t=-(t%parent.screen.height)}}if(is_SA_child_animation){var o=parent.SA_child_animation[SA_child_animation_id];e-=o.x;t-=o.y}else{var a=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;a.posLeft=e;a.posTop=t}if(document.getElementById("C_wallpaper_mask")){var n=C_wallpaper_mask.style;n.posLeft=e;n.posTop=t}}},moveBy:function(e,t,i){SA_top_window.moveByAbsolute(e,t)},update_tray:function(e){try{if(!webkit_electron_mode||IPC.active_window!=self)return;if(this._tray_last_updated==RAF_timestamp){return}this._tray_last_updated=RAF_timestamp;if(!e){e={active_window_id:IPC.active_window_id,click_thru:SA_topmost_window.returnBoolean("IgnoreMouseEvents"),click_thru_partial:SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial"),always_on_top:SA_topmost_window.returnBoolean("AutoItAlwaysOnTop"),stay_on_desktop:SA_topmost_window.returnBoolean("AutoItStayOnDesktop"),auto_pause:SA_topmost_window.returnBoolean("AutoItAutoPause"),opacity:is_SA_child_animation?parent.SA_child_animation[SA_child_animation_id].opacity:parseFloat(System.Gadget.Settings.readString("Opacity")||1),opacity_on_hover:parseFloat(System.Gadget.Settings.readString("OpacityOnHover")||1),size:Settings.CSSTransformFullscreen?-1:Settings.CSSTransformScale,animation_path:Settings.f_path_folder,media_control:self.SL&&SL._mouse_event_main&&SL._mouse_event_main(),MMD:null,Facebook:{enabled:!!self.use_Facebook_API}};var t=[true];for(var i=0;i<SA_child_animation_max;i++)t.push(!!SA_topmost_window.SA_child_animation[i]);e.active_window=t;e.lock_child_dragging=returnBoolean("ChildDragDisabled");var o=this.tray_menu_custom;if(o){e.custom_menu_para=o.para;o.update_tray&&o.update_tray(e)}else{e.custom_menu_para={}}if(self.MMD_SA&&MMD_SA._tray_updatable){var a=MMD_SA_options.MME;var n=e.MMD={use_webgl2:!!MMD_SA.use_webgl2,look_at_camera:!!MMD_SA_options._look_at_screen,look_at_mouse:!!MMD_SA_options._look_at_mouse,trackball_camera:!!returnBoolean("MMDTrackballCamera"),random_camera:!!returnBoolean("MMDRandomCamera"),random_camera_available:!!MMD_SA_options.use_random_camera,override_default_for_external_model:!!returnBoolean("MMDOverrideDefaultForExternalModel"),light:{},MME:{self_overlay:{},HDR:{},serious_shader:{},SAO:{},PostProcessingEffects:{}}};n._material_list=MMD_SA._material_list||[];if(MMD_SA._model_list){n._model_list=MMD_SA._model_list;MMD_SA._model_list=null}var s=jThree("#MMD_DirLight").three(0);var r=s.color;n.light.color=[Math.min(255,parseInt(r.r*256)),Math.min(255,parseInt(r.g*256)),Math.min(255,parseInt(r.b*256))];n.light.position=s.position.clone().sub(MMD_SA_options.MMD_disabled&&{x:0,y:0,z:0}||THREE.MMD.getModels()[0].mesh.position).multiplyScalar(1/MMD_SA_options.light_position_scale).toArray();n.shadow_darkness=MMD_SA_options.shadow_darkness;Object.assign(n.MME.self_overlay,a.self_overlay);Object.assign(n.MME.HDR,a.HDR);Object.assign(n.MME.serious_shader,a.serious_shader);Object.assign(n.MME.SAO,a.SAO);var _=MMD_SA_options.MME.PostProcessingEffects;var l=n.MME.PostProcessingEffects;l.enabled=returnBoolean("Use3DPPE")||!!(MMD_SA_options.PPE_disabled_on_idle?MMD_SA_options._PPE_enabled:_.enabled);l.use_SAO=!!_.use_SAO;l.use_Diffusion=!!_.use_Diffusion;l.use_BloomPostProcess=!!_.use_BloomPostProcess;l.use_BloomPostProcess_blur_size=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessBlurSize")||.5);l.use_BloomPostProcess_threshold=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessThreshold")||.5);l.use_BloomPostProcess_intensity=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessIntensity")||.5);n.MME_saved=!!MMD_SA_options.MME_saved[MMD_SA_options.model_para_obj._filename]}if(!document.getElementById("Lchild_animation_parent"))e.apply_to_child=null;else e.apply_to_child=returnBoolean("CSSTransformToChildAnimation")}webkit_electron_remote.getGlobal("update_tray")(e)}catch(e){console.error(e)}},load_file:function(t,i,o){if(!o)o="blob";var a=!(self.MMD_SA&&MMD_SA.fn);if(a)MMD_SA_options.load_length_extra=(MMD_SA_options.load_length_extra||0)+1;var e;if(/\.zip\#/i.test(t)||o!="blob"||typeof i=="function"){e=function(){var e=new XMLHttpRequestZIP;e.onload=function(){if(a){MMD_SA.fn.setupUI()}if(typeof i=="function"){i(e)}else{i.src=URL.createObjectURL(this.response)}e=undefined};e.open("GET",toFileProtocol(t),true);e.responseType=o;e.send()}}else{e=function(){if(a){var e=function(){MMD_SA.fn.setupUI();i.removeEventListener("load",e)};i.addEventListener("load",e)}i.src=toFileProtocol(t)}}if(!self.XMLHttpRequestZIP){window.addEventListener("jThree_ready",function(){e()})}else{e()}},on_animation_update:function(){var a=[[],[]];var n=0;return{add:function(e,t,i,o){a[i].push({func:e,frame_count:t+i,loop:o,index:n++})},remove:function(t,e){a[e].forEach(e=>{if(e.func==t)e.canceled=true})},run:function(e){var t=[];var i=a[e];if(!i.length)return;var o=[];i.forEach(function(e){if(e.canceled)return;if(--e.frame_count>=0){o.push(e)}else{e.func();if(e.loop&&--e.loop!=0)o.push(e)}});a[e]=o}}}(),get css_scale(){return window.devicePixelRatio>=2?.5:1},virtual_numpad_toggle:function(e){if(e==null)e=Lnumpad_row0.style.display=="none";Lnumpad_row0.style.display=e?"inline":"none";Lnumpad_rows.style.display=e?"block":"none";if(e&&self.ChatboxAT)ChatboxAT.chatW_minimize(0,true)},virtual_numpad:function(){var _={};return function(e,t){e.preventDefault();e.stopPropagation();var i=MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.character.combat_mode;var o=e.target.textContent;var a=_[o]=_[o]||{};var n,s;switch(o){case"S":n=16;a.pressed=!a.pressed;t=a.pressed?"keydown":"keyup";break;case"+":n=107;if(i){if(t=="keyup")return;a.pressed=!a.pressed;t=a.pressed?"keydown":"keyup"}break;case"-":n=109;break;case"*":n=106;break;case"/":n=111;break;case"⏎":n=13;break;case"J":n=32;break;case"↑":n=38;break;case"↓":n=40;break;case"←":n=37;break;case"→":n=39;break;default:n=parseInt(o)+96}if(a.timeoutID)clearTimeout(a.timeoutID);if(a.intervalID)clearTimeout(a.intervalID);a.timeoutID=a.intervalID=null;let r=new KeyboardEvent(t,{bubbles:true,cancelable:true,key:o,keyCode:n,shiftKey:_["S"]&&_["S"].pressed});document.dispatchEvent(r);if(t=="keydown"){if(/[\+S]/.test(o)&&(o!="+"||i)){e.target.style.opacity="0.75"}else{a.timeoutID=setTimeout(function(){a.intervalID=setInterval(function(){document.dispatchEvent(r)},100)},400)}}else{e.target.style.opacity=""}}}(),P2P_network:function(){var o;var a=0;var n={events:{peer:{},connection:{handshake_request:function(e,t){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) responding handshake request from Peer-"+e.index+"("+e.id+")");t.send({handshake:{request:true}})},handshake_respond:function(e,t,i){if(i.request){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/client)'s handshake request accepted from Peer-"+e.index+"("+e.id+")");t.send({handshake:{accepted:true}})}else if(i.accepted){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) accepted handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_accecpted&&e.para.events.connection.handshake_request_accecpted[t.label]){e.para.events.connection.handshake_request_accecpted[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_accecpted[t.label]}}else{console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) rejected handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_rejected&&e.para.events.connection.handshake_request_rejected[t.label]){e.para.events.connection.handshake_request_rejected[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_rejected[t.label]}}},data:function(e,t,i){}},send_message:function(e){if(!e.command)t.content_window.ChatboxAT.ChatShow([e.name+": "+e.msg]);return null}}};function s(t,i){this._connection=i;this.status="connecting";t.connections[i.label]=this;var o=this;i.on("data",function(e){if(e.handshake){t.para.events.connection.handshake_respond(t,o,e.handshake)}else{t.para.events.connection.data(t,o,e)}});i.on("close",function(e){console.log("P2P_network: DataConnection"+"("+i.peer+"/"+i.label+"/host) closed");o.close(t)})}s.prototype.send=function(e){this._connection.send(e)};s.prototype.close=function(e){if(!e.connections[this.label])return;if(e.para.events.connection.close&&e.para.events.connection.close(e,this))return;delete e.connections[this.label];var t=this;setTimeout(function(){t._connection.close();t._connection=null},1e3)};Object.defineProperty(s.prototype,"peer",{get:function(){return this._connection.peer}});Object.defineProperty(s.prototype,"label",{get:function(){return this._connection.label}});function r(){}Object.defineProperty(r.prototype,"length",{get:function(){return Object.keys(this).length}});function e(t=Object.clone(n)){this.para=t;this.id=null;var e=this._peer=new Peer;this.index=a;this.connections=new r;this.status="connecting";var i=this;e.on("open",function(e){a++;if(!o)o=i;i.id=e;i.status="connected";console.log("P2P_network: Peer-"+i.index+"("+e+") connected");i.para.events.peer.open&&i.para.events.peer.open(i)});e.on("error",function(e){console.log("P2P_network: Peer-"+i.index+" error",e);if(i.para.events.peer.error_by_connection){i.para.events.peer.error_by_connection(e);delete i.para.events.peer.error_by_connection}else i.para.events.peer.error&&i.para.events.peer.error(i,e)});e.on("connection",function(e){if(t.events.peer.connection&&t.events.peer.connection(i,e))return;console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connecting to Peer-"+i.index+"("+i.id+")");e.on("open",function(){console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connected to Peer-"+i.index+"("+i.id+")");new s(i,e)})})}e.prototype.connect=function(a,e){var n=this;return new Promise(function(i,o){var e=function(){var e={serialization:"json"};var t=n._peer.connect(a,e);t.on("open",function(){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) connecting to Peer-"+n.index+"("+n.id+")");var e=new s(n,t);n.para.events.connection.handshake_request(n,e);n.para.events.connection.handshake_request_accecpted=n.para.events.connection.handshake_request_accecpted||{};n.para.events.connection.handshake_request_rejected=n.para.events.connection.handshake_request_rejected||{};n.para.events.connection.handshake_request_accecpted[t.label]=i;n.para.events.connection.handshake_request_rejected[t.label]=o;delete n.para.events.peer.error_by_connection});t.on("error",function(e){console.log("P2P_network: Remote connection failed",e);o(e)});n.para.events.peer.error_by_connection=o};switch(n.status){case"connected":e();break;default:setTimeout(function(){o(n)},0)}})};var t={peer:e,get peer_default(){return o},status:"off",get content_window(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},process_message:function(e,d){var t=this.peer_default;if(!t)return e;var i=this.content_window.document.getElementById("Flogin").id.value;var o=this.content_window.document.getElementById("Flogin").pass.value;var a=this.content_window.MMD_SA_options;var n=(i||a&&a.model_para_obj.character&&a.model_para_obj.character.name||"Anonymous").substring(0,16);var c=t&&t.connections.length;var s;if(!/^\//.test(e)){s=t.para.events.send_message({name:n,msg:e,id:i,pass:o})}else{var r,_,p;var l=this.content_window.ChatboxAT.checkChatCommand(e);r=l.command;_=l.para1;p=l.para2;s=t.para.events.send_message({name:n,msg:e,command:r,para1:_,para2:p,id:i,pass:o})}if(!d)this.content_window.document.getElementById("Fchat").msg.value="";if(s!=null)return s;return e}};return t}(),camera:function(){var ee;var d,r;var c;var te,A;var B,s;var p;var l;var e=new URLSearchParams(self.location.search.substring(1));var ae="";var t=true;var i;var o=1e3/30;var u=o;var S=0;function a(){u+=RAF_timestamp_delta;if(c.busy||RAF_animation_frame_unlimited&&!MMD_SA.WebXR.session&&u<o){return}u-=o;var s=ee.video;if(!s.videoWidth||s.readyState<2){return}S=RAF_timestamp;var a=ee.video_canvas;var r=a.getContext("2d");var _,l;if(ee.local_src&&!ee.stream){_=s.videoWidth;l=s.videoHeight;let t=MMD_SA_options.user_camera.pixel_limit._default_;if(t&&_*l>t[0]*t[1]){let e=_/l>t[0]/t[1]?_/t[0]:l/t[1];_=Math.round(_/e);l=Math.round(l/e)}}else{_=ee.target_width;l=ee.target_height}var n=MMD_SA_options.user_camera.display.webcam_as_bg?{scale:1,top:0}:MMD_SA_options.user_camera.display.video;if(!n.scale){if(a.style.pixelWidth!=window.innerWidth||a.style.pixelHeight!=window.innerHeight){a.style.width=window.innerWidth+"px";a.style.height=window.innerHeight+"px"}}else{let e=n.scale*(ee.display_floating?MMD_SA_options.user_camera.display.floating_scale||MMD_SA_options.user_camera.display.floating&&1||.5:1);let i=~~(window.innerWidth*e);let o=~~(window.innerHeight*e);if(a.style.pixelWidth!=i||a.style.pixelHeight!=o){a.style.width=i+"px";a.style.height=o+"px";let e=(window.innerWidth-i)/2;let t=(window.innerHeight-o)/2;a.style.left=e*(1+(n.left!=null?n.left:-1))+"px";a.style.top=t*(1+(n.top!=null?n.top:0))+"px"}a.style.objectFit=ee.local_src&&!ee.stream?"contain":"cover"}if(a.width!=_||a.height!=l){a.width=_;a.height=l;r.globalCompositeOperation="copy";if(ee.video_flipped){r.translate(_,0);r.scale(-1,1)}}if(_==s.videoWidth&&l==s.videoHeight){r.drawImage(s,0,0)}else{let e=_/l;let t=s.videoWidth/s.videoHeight;let i,o,a,n;if(e<=t){a=s.videoHeight*e;i=(s.videoWidth-a)/2;n=s.videoHeight;o=0}else{a=s.videoWidth;i=0;n=s.videoWidth/e;o=(s.videoHeight-n)/2}r.drawImage(s,i,o,a,n,0,0,_,l)}a.style.visibility=!ee.visible||c.enabled||d.initialized&&d.worker_initialized&&!d.dets||ee.hidden_enforced?"hidden":"inherit"}function n(){if(c.enabled){c.update_frame()}else{if(te.enabled){te.update_frame(true)}else if(d.enabled){d.update_frame(true)}if(B.enabled||p.enabled){fe(true)}}const i=ee.video_canvas_facemesh.style;const e=ee.video_canvas.style;const t=MMD_SA_options.user_camera.display.wireframe.align_with_video?1:MMD_SA_options.user_camera.display.wireframe.scale||(is_mobile?.25:1);const o=~~(e.pixelWidth*t);const a=~~(e.pixelHeight*t);if(i.pixelWidth!=o||i.pixelHeight!=a){i.pixelWidth=o;i.pixelHeight=a;if(MMD_SA_options.user_camera.display.wireframe.align_with_video){i.posLeft=e.posLeft;i.posTop=e.posTop}else{let e=(window.innerWidth-o)/2;let t=(window.innerHeight-a)/2;i.left=e*(1+(MMD_SA_options.user_camera.display.wireframe.left!=null?MMD_SA_options.user_camera.display.wireframe.left:1))+"px";i.top=t*(1+(MMD_SA_options.user_camera.display.wireframe.top!=null?MMD_SA_options.user_camera.display.wireframe.top:-1))+"px"}}i.objectFit=e.objectFit;i.visibility=ee.ML_enabled&&!MMD_SA_options.user_camera.display.wireframe.hidden&&!MMD_SA_options.user_camera.display.webcam_as_bg?"inherit":"hidden"}var D;function _(){if(ee.initialized){SL.style.transform=SL_2D_front.style.transform=ee.mirror_3D?"scaleX(-1)":"none";ee.video_canvas.style.transform=ee.display_flipped?"scaleX(-1)":"none";ee.reset_video_canvas()}if(!D&&ee.initialized){D=true;u=o;System._browser.on_animation_update.add(a,0,0,-1);System._browser.on_animation_update.add(n,2,1,-1)}}function h(){SL.style.transform=SL_2D_front.style.transform=ee.mirror_3D?"scaleX(-1)":"none";ee.video_canvas.style.transform="none";ee.reset_video_canvas();if(ee.visible)return;if(D&&!ee.ML_enabled){D=false;u=o;System._browser.on_animation_update.remove(a,0);System._browser.on_animation_update.remove(n,1);ee.video_canvas_facemesh.style.visibility="hidden"}}var m=100;function f(e){if(!ee.visible)return;var t=e.detail.keyCode;if(t==107)m+=10;else if(t==109)m-=10;else return;m=Math.max(Math.min(m,180),20);var i=ee.video_canvas.getContext("2d");if(m==1){i.filter="none";DEBUG_show("Brightness:100%",2)}else{i.filter="brightness("+m+"%) contrast("+(100+(m-100)*.25)+"%)";DEBUG_show("Brightness:"+m+"%",2)}e.detail.result.return_value=true}var g=0;function M(e){if(!e)e=ee.local_src||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.Gadget.path+"/js/headtrackr.mp4");if(/\.(png|jpg|jpeg|bmp)$/i.test(e)){if(!ee._image){ee._image=new Image;Object.defineProperty(ee._image,"videoWidth",{get:function(){return this.width}});Object.defineProperty(ee._image,"videoHeight",{get:function(){return this.height}});Object.defineProperty(ee._image,"readyState",{get:function(){return this.complete?4:0}})}if(ee.video&&ee.video.pause)ee.video.pause();ee.video=ee._image;ee._image.src=toFileProtocol(e)}else{ee.video=ee._video;ee.video.loop=true;if(!ee.video._initialized){ee.video._initialized=true;ee.video.addEventListener("canplaythrough",function(e){ee.media_control_enabled=true;SL_MC_simple_mode=true;SL_MC_video_obj=ee.video;SL_MC_Place(1,0,-64)});ee.video.addEventListener("timeupdate",function(e){SL_MC_Timeupdate(this)},true)}ee.video.src=toFileProtocol(e)}ee.local_src=e}var b=false;function k(){var e=te.enabled||B.enabled;if(b==!!e)return;b=!!e;if(e){_();oe.reset();oe.add_events();DEBUG_show("(Camera ML Mode:ON)",2)}else{if(ee.initialized){ee.video_canvas_face_detection.style.visibility="hidden";ee.video_canvas_facemesh.style.visibility="hidden";h()}oe.remove_events();DEBUG_show("(Camera ML Mode:OFF)",2)}}var w,E,C;var j,R;var v,L;var ie,y;var x,P;var I;window.addEventListener("jThree_ready",function(){j=new THREE.Vector3;R=new THREE.Vector3;I=new THREE.Vector3;v=new THREE.Quaternion;L=new THREE.Quaternion;ie=new THREE.Matrix4;y=new THREE.Quaternion;x=new THREE.Vector2;P=new THREE.Vector2});var F=["親","人","中","薬","小"];var O=["thumb","index","middle","ring","pinky"];var G=["０","１","２","３"];var T;var W;var H;var U=true;var q=true;var V;var ne=true;var Q,K,X;var Y=false;var N=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"];var Z=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28];var $=[];N.forEach(e=>{$.push({part:e,score:0})});var J,se,re;async function _e(){w=true;if(MMD_SA_options.model_para_obj.left_arm_z_rot==null){let p=THREE.MMD.getModels()[0];let u=p.mesh.bones_by_name;let e=u["左腕"].pmxBone.origin;let t=u["左ひじ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_z_rot=Math.PI/2+Math.atan2(t[1]-e[1],t[0]-e[0]);let i=u["左腕ＩＫ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_to_IK_xy=[e[0]-i[0],e[1]-i[1]];MMD_SA_options.model_para_obj.left_arm_length=Math.sqrt(MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]*MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]+MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]);let o=u["右腕"].pmxBone.origin;MMD_SA_options.model_para_obj.shoulder_width=Math.abs(e[0]-o[0]);MMD_SA_options.model_para_obj.arm_axis={"左":(new THREE.Vector3).fromArray(i).sub(MMD_SA.TEMP_v3.fromArray(e)).normalize()};MMD_SA_options.model_para_obj.arm_axis["右"]=MMD_SA_options.model_para_obj.arm_axis["左"].clone().setX(-MMD_SA_options.model_para_obj.arm_axis["左"].x);MMD_SA_options.model_para_obj.hip_center=(new THREE.Vector3).fromArray(u["左足"].pmxBone.origin).setX(0);MMD_SA_options.model_para_obj.spine_length=u["首"].pmxBone.origin[1]-MMD_SA_options.model_para_obj.hip_center.y;MMD_SA_options.model_para_obj.left_heel_height=u["左足首"].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_length=MMD_SA._v3a.fromArray(u["左足"].pmxBone.origin).distanceTo(MMD_SA._v3b.fromArray(u["左足ＩＫ"].pmxBone.origin));let a=["左","右"];J={1:{},"-1":{}};a.forEach(l=>{["腕","ひじ"].forEach((e,t)=>{let i=l=="左"?1:-1;let o=l+e;let a,n;let s=u[o].pmxBone.end;a=typeof s=="number"?MMD_SA._v3a.fromArray(p.mesh.bones[s].pmxBone.origin).sub(R.fromArray(u[o].pmxBone.origin)).normalize():MMD_SA._v3a.fromArray(s).normalize();n=MMD_SA._v3b.set(0,0,-1).applyQuaternion(v.setFromUnitVectors(j.set(Math.sign(a.x),0,0),a));a.z*=-1;n.z*=-1;a.x*=i;n.x*=i;a.y*=i;n.y*=i;let r=MMD_SA.TEMP_v3.crossVectors(a,n).normalize();n=MMD_SA._v3b.crossVectors(r,a);let _=MMD_SA.TEMP_m4.set(a.x,a.y,a.z,0,r.x,r.y,r.z,0,n.x,n.y,n.z,0,0,0,0,1);J[i][e]=(new THREE.Quaternion).setFromBasis(_)})});se={1:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(0,-Math.PI/2*1,(-MMD_SA_options.model_para_obj.left_arm_z_rot+Math.PI)*1,"YZX")),"-1":(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(0,-Math.PI/2*-1,(-MMD_SA_options.model_para_obj.left_arm_z_rot+Math.PI)*-1,"YZX"))};re={1:{},"-1":{}};MMD_SA_options.model_para_obj.finger_base={};a.forEach(c=>{let e=u[c+"手首"].pmxBone.origin;F.forEach((e,t)=>{let l=c+e+"指";let i=t==0&&u[l+G[0]]?0:1;if(!u[l+G[i+0]])return;let d=MMD_SA_options.model_para_obj.finger_base[c+t]={base_index:i};for(let r=d.base_index+(t==0?0:-1),_=r;_<3;_++){let e=c=="左"?1:-1;let t=l+G[d.base_index+(_-r)];let i,o;let a=u[t].pmxBone.end;i=typeof a=="number"?MMD_SA._v3a.fromArray(p.mesh.bones[a].pmxBone.origin).sub(R.fromArray(u[t].pmxBone.origin)).normalize():MMD_SA._v3a.fromArray(a).normalize();o=MMD_SA._v3b.set(0,0,-1).applyQuaternion(v.setFromUnitVectors(j.set(Math.sign(i.x),0,0),i));i.z*=-e;o.z*=-e;i.x*=-1;o.x*=-1;let n=MMD_SA.TEMP_v3.crossVectors(i,o).normalize();o=MMD_SA._v3b.crossVectors(n,i);let s=MMD_SA.TEMP_m4.set(i.x,i.y,i.z,0,n.x,n.y,n.z,0,o.x,o.y,o.z,0,0,0,0,1);re[e][t]=(new THREE.Quaternion).setFromBasis(s)}})})}var t=[];if(is_mobile){t.push("use_mobilenet=1")}if(ne){t.push("use_holistic=1");T=W=false;q=V=true}if(T){t.push("use_human=1");Q=true;T=true;W=false;H=false;K=true;X=true}else if(W){t.push("use_mixed_human=1");T=true;W=true;H=true;X=true}else{T=false;W=false;H=true}if(q){t.push("use_blazepose=1");V=true}if(V){t.push("use_mediapipe=1");if(T){K=true;X=false}U=true}if(U){t.push("use_movenet=1")}if(MMD_SA_options.user_camera.ML_models.worker_disabled&&te.initialized&&!te.worker_initialized){await new Promise(function(e,t){var i=setInterval(()=>{if(te.worker_initialized){clearInterval(i);e()}},100)})}else{await te.init()}if(MMD_SA_options.user_camera.ML_models.worker_disabled){s={postMessage:function(e,t){PoseAT.onmessage({data:e})}};let e=document.createElement("script");e.onload=function(){PoseAT.init(s,t)};e.src="js/pose_lib.js";document.head.appendChild(e)}else{s=new Worker("js/pose_worker.js"+(t.length?"?"+t.join("&"):""))}s.onmessage=me}function le(e,t){var i=e.bones_by_name[t];var o=this.skin[t];var a=Math.max(Math.min(o[0].t_delta/o[0].t_delta_frame,1),0);var d=MMD_SA.TEMP_q.set(0,0,0,1);var n=o[0].no_blending?MMD_SA._q2.copy(o[0].rot):MMD_SA._q2.copy(o[1].rot).slerp(o[0].rot,a);if(!i){o[0]._rot_from_pose.copy(n);return}var s=o[0].rot_parent;if(!s){s=MMD_SA.get_bone_rotation_parent(e,t,e).conjugate()}o[0]._rot_parent=s;if(o[0].info[1]=="facemesh"&&this.skin[t+"_DUMMY_"]){let e=Math.min(Math.max(.25-o[0]._rot_ratio,0)*5,1);n.slerp(this.skin[t+"_DUMMY_"][0]._rot_from_pose,e*e*.667);o[0]._rot_mixed=n.clone()}var r=n.toAxisAngle()[1]%(Math.PI*2);if(r>Math.PI)r=Math.PI*2-r;else if(r<0&&r<-Math.PI)r+=Math.PI*2;r=Math.abs(r);a=B.use_3D_pose?.5:.3+Math.max(r-Math.PI/2,0)/(Math.PI/2)*.2;var _=v.multiplyQuaternions(s,n);var l=j.setEulerFromQuaternion(_,"YZX");var c=[l.x<0?a+(.5-a)*.5:a,a,a];_.setFromEuler(R.fromArray(l.toArray().map((e,t)=>Math.sign(e)*Math.min(Math.abs(e),Math.PI/2)*c[t])),"YZX");i.quaternion.copy(_);e.bones_by_name["頭"].quaternion.copy(_);if(a<.5){i=e.bones_by_name["上半身2"];i.quaternion.multiply(v.setFromEuler(j.setEulerFromQuaternion(n,"YZX").multiply(R.fromArray(c.map(e=>1-e*2))),"YZX"))}}function de(e,t){if(ee.poseNet.IK_disabled_check(t))return;var i=t.charAt(0);e.bones_by_name[i+"ひざ"].quaternion.set(0,0,0,1)}function ce(e,t){if(B.IK_disabled_check(t))return;var i=e.bones_by_name[t];var o=this.skin[t];var a=Math.max(Math.min(o[0].t_delta/o[0].t_delta_frame,1),0);var n=t.charAt(0);e.bones_by_name[n+"腕+"].quaternion.copy(e.bones_by_name[n+"腕"].quaternion);e.bones_by_name[n+"腕"].quaternion.set(0,0,0,1);e.bones_by_name[n+"ひじ"].quaternion.set(0,0,0,1);var s=j.copy(o[1].pos).lerp(o[0].pos,a);if(!o[0]._IK_absolute)s.applyQuaternion(MMD_SA.get_bone_rotation_parent(e,t,e).conjugate());s.x+=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[0]*(n=="左"?1:-1);s.y+=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1];i.position.add(s)}function pe(a,e){var t=a.bones_by_name[e];var i=this.skin[e];var d=Math.max(Math.min(i[0].t_delta/i[0].t_delta_frame,1),0);let o=(new THREE.Vector3).copy(i[0]._v3_screen).unproject(ee._camera_reset).sub(ee._camera_reset.position).normalize();if(ue)he.estimate();let n=ee._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;let s=n;if(ue&&he.z)s=he.z_smoothed||he.z;o.multiplyScalar(s/o.z).negate();o.z=MMD_SA_options.user_camera.ML_models.pose.estimate_z_depth===false?0:n+o.z;if(i[0]._v_hip_offset)o.add(i[0]._v_hip_offset);if(MMD_SA_options.user_camera.ML_models.pose.position_offset)o.add(MMD_SA_options.user_camera.ML_models.pose.position_offset);i[0].pos.copy(o);var r=(new THREE.Vector3).copy(i[1].pos).lerp(i[0].pos,d);var c=MMD_SA.get_bone_position(a,"左足","全ての親");var p=MMD_SA.get_bone_position(a,"右足","全ての親");var _=MMD_SA.TEMP_v3.copy(c).add(p).multiplyScalar(.5).sub(MMD_SA_options.model_para_obj.hip_center).negate();if(B.auto_grounding){let e=MMD_SA.get_bone_position(a,"左足首","全ての親");let t=MMD_SA.get_bone_position(a,"右足首","全ての親");let i=e.y<t.y?e:t;let o=MMD_SA_options.model_para_obj.left_heel_height+.2-i.y;o-=r.y;_.y=o}r.add(_);r.x*=ee.x_flipped?-1:1;if(i[0].absolute)t.position.set(0,0,0);t.position.add(r);var l=I.distanceTo(r)-5;if(l>0){THREE.MMD.getModels()[a._model_index].resetPhysics(15+l*2)}I.copy(r)}var ue=1*10;var he=function(){var m=[];var t=[];function e(e){var r=e.keypoints[5];var _=e.keypoints[6];var l=e.keypoints[11];var d=e.keypoints[12];if(r.score<=0||_.score<=0)return;var c=e.keypoints3D[5];var p=e.keypoints3D[6];if(l.score<=0||d.score<=0){let e=MMD_SA._v3b.copy(c).sub(p);let t=e.length();let i=MMD_SA.TEMP_v3.set(1,0,0);let o=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZYX").y;let a=P.copy(r.position).add(_.position).multiplyScalar(.5);let n=a.clone();let s=x.copy(r.position).distanceTo(_.position);a.y=a.y+s*1.5/Math.abs(Math.cos(o));if(a.y>ee.video_canvas.height){n.y=Math.max(n.y-(a.y-ee.video_canvas.height),0);a.y=ee.video_canvas.height}m=[{point2D:[{position:n},{position:a.clone()}],data3D:{length:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)*(t*3),z_diff:0}}]}else{let e=MMD_SA._v3a.addVectors(c,p).multiplyScalar(.5);let t=e.length();let i=MMD_SA.TEMP_v3.set(0,1,0);i.y*=-1;let o=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZXY").x;let a=x.copy(l.position).add(d.position).multiplyScalar(.5);let n=P.copy(r.position).add(_.position).multiplyScalar(.5);let s=a.distanceTo(n);n.copy(a);n.y=n.y-s/Math.abs(Math.cos(o));m=[{point2D:[{position:n.clone()},{position:a.clone()}],data3D:{length:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)*(t*2),z_diff:0}}]}}function i(){if(!m.length)return;var d=System._browser.camera;var c=d.video_canvas.width;var p=d.video_canvas.height;var u=j;var h=[];m.forEach(e=>{u.set(e.point2D[0].position.x/c*2-1,-(e.point2D[0].position.y/p)*2+1,.5);var t=MMD_SA._v3a.copy(u.unproject(d._camera_reset).sub(d._camera_reset.position).normalize());u.set(e.point2D[1].position.x/c*2-1,-(e.point2D[1].position.y/p)*2+1,.5);var i=MMD_SA._v3b.copy(u.unproject(d._camera_reset).sub(d._camera_reset.position).normalize());var o,a;o=e.data3D.length;a=e.data3D.z_diff;let n=Math.sqrt(Math.pow(t.x-i.x*t.z/i.z,2)+Math.pow(t.y-i.y*t.z/i.z,2)+0);let s=t.x-i.x*t.z/i.z+(t.y-i.y*t.z/i.z)+0;let r=s/n;let _=1;let l=(Math.sqrt(o*o+1)-1)/(n/r);t.multiplyScalar(l);h.push({z:-t.z*1.5,id:e.id})});h.sort((e,t)=>t.z-e.z);var e=h[0].z;this.z=e;t=t.filter(e=>RAF_timestamp-e.timestamp<200);t.push({timestamp:RAF_timestamp,z:e});z=t.reduce((e,t)=>e+t.z,0)/t.length;this.z_smoothed=z;m=[]}return{prepare:e,estimate:i}}();var me=function(){function f(e,t){var d=THREE.MMD.getModels()[e._model_index];var i=e.bones_by_name[t];var o=t.charAt(0);var c,a,n,p;var s=e.bones_by_name[o+"手捩"];var r;var _=this.skin[t];var u=Math.max(Math.min(_[0].t_delta/_[0].t_delta_frame,1),0);a=v.set(0,0,0,1);if(s){if(s.quaternion.x||s.quaternion.y||s.quaternion.z){s.quaternion.conjugate();d._update_IK_and_AddTrans(false,o+"手捩")}s.quaternion.set(0,0,0,1)}var l=_[0].rot_parent;if(!l){l=MMD_SA.get_bone_rotation_parent(e,t,e);l.conjugate()}_[0]._rot_parent=l;a.multiply(_[0].no_blending?_[0].rot:MMD_SA.TEMP_q.copy(_[1].rot).slerp(_[0].rot,u));i.quaternion.copy(l).multiply(a).multiply(se[o=="左"?1:-1]);if(s){n=s.pmxBone.fixedAxis;n=n&&MMD_SA._v3a.fromArray(n)||MMD_SA_options.model_para_obj.arm_axis[o];let e=j.setEulerFromQuaternion(i.quaternion,"YZX").y;p=-e*.5;r=L.setFromAxisAngle(n,p);this.skin[o+"手捩"][0].rot.copy(r);i.quaternion.multiplyQuaternions(r.conjugate(),i.quaternion)}}function P(t,i){if(z=="y"){t.multiplyQuaternions(t,MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,0,MMD_SA_options.model_para_obj.left_arm_z_rot*(i==0?1:-1))))}else{t.multiplyQuaternions(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,0,-(Math.PI/2-MMD_SA_options.model_para_obj.left_arm_z_rot)*(i==0?1:-1))),t);let e=t.toAxisAngle();t.setFromAxisAngle(e[0].applyQuaternion(J[i==0?1:-1]["腕"]),e[1])}}function I(e,t){var i=e.toAxisAngle();if(z=="y"){e.setFromAxisAngle(i[0].applyEuler(MMD_SA.TEMP_v3.set(0,0,-MMD_SA_options.model_para_obj.left_arm_z_rot*(t==0?1:-1))),i[1])}else{e.setFromAxisAngle(i[0].applyQuaternion(J[t==0?1:-1]["ひじ"]),i[1])}}var n;window.addEventListener("jThree_ready",()=>{n=new THREE.Quaternion});var T=function(){var a=0;return function(e,t){if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only)return;var i=e.bones_by_name;var o=i[t].quaternion;if(a!=RAF_timestamp){a=RAF_timestamp;n.copy(i["センター"].quaternion).multiply(i["上半身"].quaternion).multiply(i["上半身2"].quaternion).conjugate()}o.multiplyQuaternions(n,o)}}();var s=0,_=0,l=0,d=0;var z="x";return function(e){var a=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof a==="string"){if(a=="OK"){E=true}else{DEBUG_show(a,2);System._browser.console.log(a)}}else{ee._needs_RAF=true;ae="";let e=performance.now();let t=0;if(d){t=e-d;l+=t;if(++_>=20){s=1e3/(l/_);_=l=0}}d=e;B._t=a._t;oe.t_delta=s&&1e3/s||t||a.fps&&1e3/a.fps||a._t;let D=[];let k=[];let E=ee.x_flipped?1:-1;let i=THREE.MMD.getModels()[0];let o=i.mesh.bones_by_name;let x;if(B.enabled){if(a.posenet&&a.posenet.score>.3){B.data_detected++;if(B.data_detected_stable){if(Y){Y=false;i.mesh.visible=true}x=a.posenet;let A=B.use_3D_pose;if(q){let o=[];let a=[];Z.forEach((e,t)=>{let i=x.keypoints[e];i.part=N[t];o.push(i);i=x.keypoints3D[e];i.part=N[t];a.push(i)});x.keypoints=o;x._keypoints3D=x.keypoints3D;x.keypoints3D=a}const r=U?.3:!K?.5:.1;x.keypoints.forEach(e=>{e.score-=r});if(A){x._keypoints3D.forEach(e=>{e.score-=r})}if(K){let i={};x.keypoints.forEach(e=>{i[e.part]=e});let o=[];for(let t=0;t<=16;t++){let e=x.keypoints[t];if(!e)o.push($[t]);else if(e.part!=N[t])o.push(i[N[t]]||$[t]);else o.push(e)}x.keypoints=o}if(!te.head_pose_enabled){te.bb_center[0]=x.keypoints[0].position.x/ee.video_canvas.width;te.bb_center[1]=x.keypoints[0].position.y/ee.video_canvas.height}if(A){let e=x._keypoints3D[0];let t=x._keypoints3D[3];let i=x._keypoints3D[6];let o=MMD_SA._v3a_.copy(e).sub(MMD_SA._v3b.copy(t).add(i).multiplyScalar(.5)).normalize();let a=MMD_SA._v3b_.copy(t).sub(MMD_SA._v3b.copy(i)).normalize();let n=MMD_SA.TEMP_v3.crossVectors(a,o).normalize();a.crossVectors(o,n);ie.set(a.x,a.y,a.z,0,o.x,o.y,o.z,0,n.x,n.y,n.z,0,0,0,0,1);y.setFromBasis(ie);let s=y.conjugate();s=s.clone().multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI/8,0,0)));if(!te.head_pose_enabled){oe.add("skin","首",{after_IK:true,rot:s,onProcessRotation:le});oe.skin["首"][1]._rot_mixed&&oe.skin["首"][1].rot.copy(oe.skin["首"][1]._rot_mixed)}oe.add("skin","首_DUMMY_",{rot:s,_rot_from_pose:s.clone(),onProcessRotation:le})}let n=x.keypoints[5];let s=x.keypoints[6];let h=new THREE.Quaternion;let m=MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only;if(m)ae+="\n(upper body only)\n";if(A&&ue)he.prepare(x);if(n.score>0&&s.score>0){let l,d;let c,p;let M;if(A){l=x.keypoints3D[5];d=x.keypoints3D[6];let o=x.keypoints3D[11];let a=x.keypoints3D[12];if(m||o.score<=0||a.score<=0){m=true}else{if(x.keypoints[11].position.y>ee.video_canvas.height||x.keypoints[12].position.y>ee.video_canvas.height){m=true}let e=MMD_SA._v3b.copy(o).sub(a).normalize();let t=MMD_SA.TEMP_v3.set(1,0,0);let i=R.setFromVectorSpherical(t,e);if(m)i.z=0;h.setFromEuler(i,"YZX")}let e=MMD_SA._v3a.addVectors(l,d).multiplyScalar(.5).normalize();e.applyQuaternion(MMD_SA.TEMP_q.copy(h).conjugate());let t=MMD_SA.TEMP_v3.set(0,1,0);t.y*=-1;c=(new THREE.Quaternion).setFromVectorSpherical(t,e);if(m){c.multiplyQuaternions(h,c);h.set(0,0,0,1)}let i=MMD_SA._v3b.copy(l).sub(d).normalize();i.applyQuaternion(MMD_SA.TEMP_q.multiplyQuaternions(h,c).conjugate());x_axis=MMD_SA.TEMP_v3.set(1,0,0);let n=R.setFromVectorSpherical(x_axis,i);p=(new THREE.Quaternion).setFromEuler(n,"YZX");let s=0;let r=n.y;let _=(s+r)%(Math.PI*2);if(_>Math.PI)_=Math.PI*2-_;else if(_<0&&_<-Math.PI)_+=Math.PI*2;c.multiply(v.setFromEuler(j.set(0,_/2-s,0),"YZX"));p.multiply(v.setFromEuler(j.set(0,_/2-r,0),"YZX"));oe.add("skin","センター",{rot:h.clone(),priority:9});oe.add("skin","上半身",{rot:c.clone()});oe.add("skin","上半身2",{rot:p.clone()});M=v.copy(h).multiply(c).multiply(p).conjugate()}let b=Math.sqrt(Math.pow(n.position.x-s.position.x,2)+Math.pow(n.position.y-s.position.y,2));let w=0;if(!A){w=Math.asin((n.position.y-s.position.y)/b);w=Math.max(Math.min(w/(Math.PI/4),1),-1)*Math.PI/4*E}let e=E==1?[1,0]:[0,1];let t=[x.keypoints[9],x.keypoints[10]];let S=-1;if(!A&&t[0].score>0&&t[1].score>0&&Math.sqrt(Math.pow(t[0].position.x-t[1].position.x,2)+Math.pow(t[0].position.y-t[1].position.y,2))<(ee.video_canvas.width+ee.video_canvas.height)/2/25){S=t[1].score>t[0].score?0:1;if(t[S].score>.3)S=-1}b=te.face_width*2||b;e.forEach(function(a,t){let n,s,o;let p;let r=t==0?"左":"右";let _=x.keypoints[5+a];let l=x.keypoints[7+a];let i=x.keypoints[9+a];oe.add("skin",r+"肩",{absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,0,w),"YZX")});let u,h,m;if(A){u=x.keypoints3D[5+a];h=x.keypoints3D[7+a];m=x.keypoints3D[9+a]}let f=E*(a==0?-1:1);let d=!MMD_SA_options.user_camera.ML_models.pose.use_armIK;let v=false;let e,y,c;const g=z=="y"?"XZY":"YZX";if(A&&l.score>0){e=MMD_SA._v3b.copy(u).sub(h).normalize().applyQuaternion(M);y=z=="y"?MMD_SA.TEMP_v3.set(0,-1,0):MMD_SA.TEMP_v3.set(f,0,0);c=(new THREE.Quaternion).setFromUnitVectors(y,e)}if(i.score>0&&a!=S){k.push({pos:i.position,dir:a,d:r});if(A){if(!d||l.score<=0){d=false;let e=MMD_SA._v3a.copy(u).sub(m);let t=l.score>0?MMD_SA.TEMP_v3.copy(u).distanceTo(h)+MMD_SA.TEMP_v3.copy(h).distanceTo(m):.5;let i=Math.min(e.length()/t,1);e.normalize().multiplyScalar(i*MMD_SA_options.model_para_obj.left_arm_length);n=e.x;s=e.y;o=p=e.z;if(c){P(c,a);oe.add("skin",r+"腕",{absolute:true,rot:c.slerp(MMD_SA.TEMP_q.set(0,0,0,1),.5)})}}else{let e=j.copy(h).sub(m).normalize().applyQuaternion(M);let t=MMD_SA._v3a.copy(e).applyQuaternion(MMD_SA.TEMP_q.copy(c).conjugate());let i=0;y=z=="y"?MMD_SA.TEMP_v3.set(0,-1,0):MMD_SA.TEMP_v3.set(f,0,0);let o=(new THREE.Quaternion).setFromUnitVectors(y,t);I(o,a);P(c,a);oe.add("skin",r+"腕",{absolute:true,rot:c,priority:-1,onFinish:T});oe.add("skin",r+"ひじ",{absolute:true,rot:o,_rot_adjust_from_lower_arm:i})}}else{v=true;let e=_.position.x-i.position.x;let t=_.position.y-i.position.y;n=e/b*MMD_SA_options.model_para_obj.shoulder_width*E;s=t/b*MMD_SA_options.model_para_obj.shoulder_width;if(l.score>0){let e=Math.min(Math.sqrt(Math.pow(i.position.x-l.position.x,2)+Math.pow(i.position.y-l.position.y,2))/b,1);let t=Math.min(Math.sqrt(Math.pow(_.position.x-l.position.x,2)+Math.pow(_.position.y-l.position.y,2))/b,1);p=(.25+(Math.sin(Math.acos(e))+Math.sin(Math.acos(t)))/2*.75)*MMD_SA_options.model_para_obj.left_arm_length}}}else{if(l.score>0){if(A){if(!d){d=false;e=MMD_SA._v3a.copy(u).sub(h).normalize();e.multiplyScalar(MMD_SA_options.model_para_obj.left_arm_length);n=e.x*E;s=e.y;o=p=e.z}else{d=true;P(c,a);oe.add("skin",r+"腕",{absolute:true,rot:c,priority:-1,onFinish:T})}}else{d=false;v=true;let e=_.position.x-l.position.x;let t=_.position.y-l.position.y;let i=Math.sqrt(e*e+t*t);let o=Math.asin(e/i);n=Math.sin(o)*MMD_SA_options.model_para_obj.left_arm_length*E;s=Math.cos(o)*MMD_SA_options.model_para_obj.left_arm_length*Math.sign(t)}}else{if(A)return;d=false;v=true;n=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*(r=="左"?1:-1)*.2;s=-Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-n*n)}}D.push({pos:{x:n,y:s,z:o,z_posenet:p},dir:a,d:r,IK_disabled:d,IK_absolute:v})})}else{m=true}if(A&&!m){let e=E==1?[1,0]:[0,1];let u=[];let t=[];let i=0;e.forEach(function(_,e){let l=e==0?"左":"右";let o=x.keypoints3D[11+_];let r=x.keypoints3D[13+_];let d=x.keypoints3D[15+_];let c,p;let t;if(r.score>0){t=MMD_SA._v3b.copy(o).sub(r).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(h).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;p=R.setFromVectorSpherical(e,t);c=(new THREE.Quaternion).setFromEuler(p,"XZY");i+=p.x}let a=!MMD_SA_options.user_camera.ML_models.pose.use_legIK;if(d.score>0){let t=MMD_SA._v3a.copy(o).sub(d);let i=r.score>0?MMD_SA.TEMP_v3.copy(o).distanceTo(r)+MMD_SA.TEMP_v3.copy(r).distanceTo(d):.7;let e=i+t.y;let s=[d.y,e];if(!a||r.score<=0){let e=Math.min(t.length()/i,1);t.normalize().multiplyScalar(e*MMD_SA_options.model_para_obj.left_leg_length);B.enable_IK(l+"足ＩＫ",true);u.push({pos:t.clone(),rot:[c],dir:_,d:l,foot:s})}else{let e=j.copy(r).sub(d).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(h).conjugate());let t=MMD_SA._v3a.copy(e).applyQuaternion(MMD_SA.TEMP_q.copy(c).conjugate());t.z=Math.max(-t.z,0);t.x*=-1;let i=t.normalize().toSphericalCoords();let o=Math.sqrt(Math.min((Math.PI-i[2])/(Math.PI/2),1));p.y=i[1]*o;c.setFromEuler(p,"XZY");t=MMD_SA._v3a.copy(e).applyQuaternion(MMD_SA.TEMP_q.copy(c).conjugate());let a=MMD_SA.TEMP_v3.set(0,1,0);a.y*=-1;let n=(new THREE.Quaternion).setFromVectorSpherical(a,t);B.enable_IK(l+"足ＩＫ",false);u.push({rot:[c,n],dir:_,d:l,foot:s})}if(a){let s=x._keypoints3D[29+_];let r=x._keypoints3D[31+_];if(s.score>0&&r.score>0){let e=MMD_SA._v3a_.copy(s).sub(d).normalize();let t=MMD_SA._v3b_.copy(s).sub(r).normalize();let i=j.crossVectors(e,t).normalize();e.crossVectors(t,i);ie.set(i.x,i.y,i.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,0,0,0,0,1);y.setFromBasis(ie);let o=y.conjugate();o=o.clone().multiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-Math.PI/8,0,0)));let a=Math.abs(MMD_SA.TEMP_v3.setEulerFromQuaternion(h,"YZX").y)%Math.PI;let n=a>Math.PI/2?1-(a-Math.PI/2)/(Math.PI/2):1;oe.add("skin",l+"足首",{after_IK:true,absoulte:true,parent_based:true,rot:o,ratio:n})}}else{}}else if(r.score>0){}});i*=.5*.5;let o=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(i,0,0));oe.add("skin","下半身",{absolute:true,rot:o.clone()});if(!m){let e=ee.video_canvas.width;let t=ee.video_canvas.height;let i=new THREE.Vector3;let o=x.keypoints[11].position;let a=x.keypoints[12].position;let n=e/t;let s=SL.width/SL.height;i.set(((o.x+a.x)/2/e*2-1)*(n<s?n/s:1),(-((o.y+a.y)/2/t)*2+1)*(s<n?s/n:1),.5);oe.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,_v3_screen:i,onProcessPosition:pe})}o.conjugate();u.forEach(e=>{var t=e.d;if(e.pos){e.pos.y+=MMD_SA_options.model_para_obj.left_leg_length;if(e.rot[0]){oe.add("skin",t+"足",{absolute:true,rot:e.rot[0]})}oe.add("skin",t+"足ＩＫ",{absolute:true,pos:e.pos,priority:999,onFinish:de})}else{if(i)e.rot[0].multiplyQuaternions(o,e.rot[0]);oe.add("skin",t+"足",{absolute:true,rot:e.rot[0]});oe.add("skin",t+"ひざ",{absolute:true,rot:e.rot[1]})}})}else{if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only){oe.add("skin","全ての親",{is_dummy:true,pos:true,after_IK:true,priority:999})}else if(A&&n.score>0&&s.score>0){let e=ee.video_canvas.width;let t=ee.video_canvas.height;let i=new THREE.Vector3;let o=e/t;let a=SL.width/SL.height;i.set(((n.position.x+s.position.x)/2/e*2-1)*(o<a?o/a:1),(-((n.position.y+s.position.y)/2/t)*2+1)*(a<o?a/o:1),.5);oe.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,_v3_screen:i,_v_hip_offset:{x:0,y:-Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length),z:0},onProcessPosition:pe})}oe.add("skin","下半身",{is_dummy:true,rot:true});["左","右"].forEach(e=>{oe.add("skin",e+"足ＩＫ",{is_dummy:true,pos:true,priority:999});oe.add("skin",e+"足",{is_dummy:true,rot:true});oe.add("skin",e+"ひざ",{is_dummy:true,rot:true});oe.add("skin",e+"足首",{is_dummy:true,after_IK:true,rot:true})})}}}else{B.data_detected=0}}if(B.enabled&&!B.data_detected_stable&&!Y){Y=true;if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only)i.mesh.visible=false}let S;let m=[];if(p.enabled&&a.handpose&&a.handpose.length&&k.length){let i;if(V){i=E?{Left:{dir:1,list:[]},Right:{dir:0,list:[]}}:{Left:{dir:0,list:[]},Right:{dir:1,list:[]}};a.handpose.forEach(e=>{if(e.label)i[e.label].list.push(e)})}const n=V?1:2;a.handpose.forEach(t=>{t._offset={};S=t.annotations;let i=MMD_SA.TEMP_v3.fromArray(S.palm[0]);k.forEach(e=>{t._offset[e.dir]=Math.sqrt(Math.pow(e.pos.x-i.x,2)+Math.pow(e.pos.y-i.y,2))})});k.forEach((p,e)=>{var u=p.dir;var t=i?i[i.Left.dir==u?"Left":"Right"].list:a.handpose;if(!t.length)t=a.handpose;let h=e==0?a.handpose.length==1&&k.length>1?t[0]._offset[u]<t[0]._offset[u==0?1:0]&&t[0]:t.sort((e,t)=>e._offset[u]-t._offset[u])[0]:t.find(e=>!e._used);if(h&&h._offset[u]<Math.max(ee.video_canvas.width,ee.video_canvas.height)/6){h._used=true;S=h.annotations;let e=D.find(e=>e.dir==u);let b=p.d;m.push(b+"手");let t=u==1?[S.index[0],S.ring[0]]:[S.ring[0],S.index[0]];let _,l,d;let i=MMD_SA._v3a_.fromArray(S.palm[0]).sub(MMD_SA._v3b.fromArray(S.middle[0])).normalize();i.x=i.x*E;let o=MMD_SA._v3b_.fromArray(t[0]).sub(MMD_SA._v3b.fromArray(t[1])).normalize();o.z=o.z*E;o.y=o.y*E;let a=MMD_SA.TEMP_v3.crossVectors(o,i).normalize();o.crossVectors(i,a);ie.set(o.x,o.y,o.z,0,i.x,i.y,i.z,0,a.x,a.y,a.z,0,0,0,0,1);y.setFromBasis(ie);let n=new THREE.Quaternion;n.copy(y).conjugate();oe.add("skin",b+"手首",{after_IK:true,rot:n,onProcessRotation:f});oe.add("skin",b+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion});let c=new THREE.Quaternion;let s=MMD_SA_options.model_para_obj.finger_base;let r=v.copy(y);r.y*=-1;r.w*=-1;let w=b=="左"?1:-1;F.forEach((h,m)=>{let f=s[(E==1?b:b=="左"?"右":"左")+m];let v=f.base_index+(m==0?0:-1);let y=S[O[m]];let g=L.copy(r);const M="XZY";for(let u=v;u<3;u++){let e=b+h+"指"+G[f.base_index+(u-v)];let t=MMD_SA._v3a.fromArray(y[u+0]);let i=MMD_SA._v3b.fromArray(y[u+1]);let o=MMD_SA.TEMP_v3.fromArray(u==v?S.palm[0]:y[u-1]);t.y=-t.y;i.y=-i.y;o.y=-o.y;let a=MMD_SA._v3a_.copy(t).sub(o);let n=MMD_SA._v3b_.copy(i).sub(t);a.normalize();n.normalize();let s,r;let _;a.applyQuaternion(g);n.applyQuaternion(g);if(u==v){let e=MMD_SA.TEMP_q.set(0,0,0,1);e.setFromVectorSpherical(MMD_SA.TEMP_v3.set(0,1,0),a).conjugate();n.applyQuaternion(e);g.multiplyQuaternions(e,g)}let l=MMD_SA._q1.set(0,0,0,1);let d=MMD_SA._q2.set(0,0,0,1);a.set(0,1,0);_=R.setFromVectorSpherical(a,n);l.setFromEuler(_,M);d.copy(l);g.multiplyQuaternions(l.conjugate(),g);if(Math.abs(_.z)>Math.PI/(m==0?1.5:2.5)||_.x>Math.PI/(m==0?2:3)){_.set(-Math.abs(a.angleTo(n)),0,0)}if(m==0&&u>v){_.x=0}if(_.x>0){_.x*=m==0||u>v?0:.75}else{_.x=Math.max(_.x,-Math.PI/(m==0?1.5:2))}if(m==0||u==v){_.z*=.9;_.z+=(m-2)/2*Math.PI/8*(w==1?1:-1)*(m>0?1:.5)}else{_.z=0}_.y=0;l.setFromEuler(_,M);let c=e;let p=l.toAxisAngle();r=p[0];s=p[1];r.applyEuler(j.set(0,-Math.PI/2,0)).applyQuaternion(MMD_SA.TEMP_q.copy(re[w][c]).conjugate());l.setFromAxisAngle(r,s);oe.add("skin",e,{absolute:true,rot:l.clone()})}})}})}else if(!p.enabled&&x&&B.use_3D_pose){let e=E==1?[1,0]:[0,1];e.forEach(function(e,d){let t=d==0?"左":"右";let i=x._keypoints3D[15+e];let o=x._keypoints3D[17+e];let a=x._keypoints3D[19+e];if(i.score<=0||o.score<=0||a.score<=0)return;let n=e==1?[a,o]:[o,a];let s=MMD_SA._v3a_.copy(i).sub(MMD_SA._v3b.copy(o).add(a).multiplyScalar(.5)).normalize();s.x=s.x*E;let r=MMD_SA._v3b_.copy(n[0]).sub(n[1]).normalize();r.z=r.z*E;r.y=r.y*E;let _=MMD_SA.TEMP_v3.crossVectors(r,s).normalize();r.crossVectors(s,_);ie.set(r.x,r.y,r.z,0,s.x,s.y,s.z,0,_.x,_.y,_.z,0,0,0,0,1);y.setFromBasis(ie);let l=new THREE.Quaternion;l.copy(y).conjugate();oe.add("skin",t+"手首",{after_IK:true,rot:l,onProcessRotation:f});oe.add("skin",t+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})})}D.forEach(function(e){var t=e.d;B.enable_IK(t+"腕ＩＫ",!e.IK_disabled);if(!e.IK_disabled){if(e.pos.z==null)e.pos.z=e.pos.z_posenet||(B.use_3D_pose?0:MMD_SA_options.model_para_obj.left_arm_length*.2);oe.add("skin",t+"腕ＩＫ",{speed_limit:10,priority:999,pos:(new THREE.Vector3).copy(e.pos),_IK_absolute:e.IK_absolute,onProcessPosition:ce})}var i=oe.skin[t+"手首"];if(i){i[0].rot_parent=i[0]._rot_parent}});ae+=(ae?"/":"\n")+"P-FPS:"+Math.round(s)+"/"+Math.round(a.fps||0);if(!B.use_holistic&&!te.enabled&&ae&&!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden){DEBUG_show(ae+"\n"+"FPS:"+EV_sync_update.fps_last)}if(a.facemesh){te.worker_onmessage({data:a.facemesh})}else if(B.use_holistic){te.data_detected=0}if(x&&te.worker_initialized){let e={posenet:x,w:ee.video_canvas.width,h:ee.video_canvas.height,flip_canvas:ee.display_flipped};if(a.handpose&&a.handpose.length)e.handpose=a.handpose;if(a.facemesh)e.facemesh=a.facemesh.faces;if(B.use_holistic||!te.enabled){e.draw_canvas=true;if(self.FacemeshAT){e.canvas=ee.video_canvas_facemesh}else if(!ee.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){e.canvas=ee.video_canvas_facemesh.transferControlToOffscreen();ee.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}}A.postMessage(e,e.canvas?[e.canvas]:undefined)}C=0}fe()}}();function fe(e){function t(){var e=B.enabled&&B.worker_initialized&&S&&!B.busy&&D&&B.camera_video_timestamp!=S;if(!e)return;C=RAF_timestamp;B.camera_video_timestamp=S;if(B.use_holistic){MMD_SA_options.auto_blink=false}let t,i,o;t=ee.video_canvas;i=t.width;o=t.height;let a=t.getContext("2d").getImageData(0,0,i,o).data.buffer;let n={rgba:a,w:i,h:o,options:{use_holistic:B.use_holistic,use_posenet:true,use_handpose:p.enabled,skip_hand_countdown_max:B.skip_hand_countdown_max}};s.postMessage(n,[n.rgba]);n.rgba=a=undefined;n=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}}var ve=function(){var n,s;window.addEventListener("jThree_ready",e=>{n=new THREE.Vector3;s=new THREE.Quaternion});function r(i,o){var e,t;var a=i.bones_by_name[o];var n=this.skin[o];if(B.enabled&&!B.data_detected_stable)return;if(n[0].info[1]=="facemesh"){if(!te.data_detected)return}n[0].t_delta+=RAF_timestamp_delta;let s=Math.max(Math.min(n[0].t_delta/n[0].t_delta_frame,1),0);if(n[0].rot){if(n[0].after_IK){t=!a._update_IK_and_AddTrans||a._update_IK_and_AddTrans.length;if(t){e=THREE.MMD.getModels()[i._model_index];if(a.quaternion.x||a.quaternion.y||a.quaternion.z){a.quaternion.conjugate();e._update_IK_and_AddTrans(false,o);a.quaternion.conjugate()}}}if(n[0].onProcessRotation){n[0].onProcessRotation.call(this,i,o)}else{let t=v.set(0,0,0,1);if(n[0].absolute){a.quaternion.set(0,0,0,1)}if(n[0].parent_based){let e=n[0].rot_parent;if(!e){e=MMD_SA.get_bone_rotation_parent(i,o,i).conjugate()}n[0]._rot_parent=e;t.copy(e)}t.multiply(n[0].no_blending?n[0].rot:MMD_SA.TEMP_q.copy(n[1].rot).slerp(n[0].rot,s));if(n[0].ratio<1)t.slerp(L.set(0,0,0,1),1-n[0].ratio);const r=MMD_SA_options.model_para_obj_all[i._model_index].skin_default[o];if(r&&r.rot_scale){if(typeof r.rot_scale=="number")r.rot_scale={x:r.rot_scale,y:r.rot_scale,z:r.rot_scale};t.setFromEuler(MMD_SA.TEMP_v3.setEulerFromQuaternion(t,"YXZ").multiply(r.rot_scale),"YXZ")}a.quaternion.multiply(t)}}if(n[0].pos){if(n[0].onProcessPosition){n[0].onProcessPosition.call(this,i,o)}else{if(n[0].absolute)a.position.set(0,0,0);a.position.add(MMD_SA.TEMP_v3.copy(n[1].pos).lerp(n[0].pos,s))}if(n[0].speed_limit){if(!n[1].pos_last){n[1].pos_last=new THREE.Vector3}else{let e=MMD_SA.TEMP_v3.subVectors(a.position,n[1].pos_last);let t=e.length()/(Math.max(RAF_timestamp_delta,RAF_timestamp-n[1].timestamp)/1e3);if(t>n[0].speed_limit)a.position.copy(n[1].pos_last).add(e.multiplyScalar(n[0].speed_limit/t))}n[1].pos_last.copy(a.position);n[0].pos_last=n[1].pos_last}}n[0].onFinish&&n[0].onFinish.call(this,i,o);t&&e._update_IK_and_AddTrans(false,o)}function t(e){var t=e.detail.model;var o=t.mesh;var a=MMD_SA.motion[t.skin._motion_index].para_SA;var n=this.skin;var i=Object.keys(n).filter(e=>!n[e][0].after_IK).sort((e,t)=>{let i=n[e][0].priority||0;let o=n[t][0].priority||0;return i-o});i.forEach(e=>{let t=o.bones_by_name[e];if(!t&&!/_DUMMY_/.test(e))return;var i=n[e][0].info[1];if((!i||/pose/.test(i))&&!a.motion_tracking_enabled)return;r.call(this,o,e)})}function i(e){var t=e.detail.model;var o=t.mesh;var a=MMD_SA.motion[t.skin._motion_index].para_SA;var n=this.skin;var i=Object.keys(n).filter(e=>n[e][0].after_IK).sort((e,t)=>{let i=n[e][0].priority||0;let o=n[t][0].priority||0;return i-o});i.forEach(e=>{let t=o.bones_by_name[e];if(!t&&!/_DUMMY_/.test(e))return;var i=n[e][0].info[1];if((!i||/pose/.test(i))&&!a.motion_tracking_enabled)return;r.call(this,o,e)})}function o(e){if(B.enabled&&!B.data_detected_stable)return;var _=e.detail.model;var l=_.mesh;var d=_.morph.targets;_.pmx.morphs.forEach(function(e){if(e.panel!=3)return;var t=e.name;if(!_.pmx.morphs_weight_by_name[t])return;var i=_.morph.target_index_by_name[t];if(i==null)return;var o=d[i];var a=o.keys[0];if(a.morph_type==1){l.morphTargetInfluences[i]=0}else{let e={name:t,weight:0,morph_type:a.morph_type,morph_index:a.morph_index};_.morph.onupdate(e,e,0,i)}});var c=MMD_SA_options.model_para_obj.facemesh_morph;var p=this.morph;var u={};var a=0;Object.keys(p).forEach(function(e){let t=p[e];if(t.disabled)return;t[0].t_delta+=RAF_timestamp_delta;let i=Math.max(Math.min(t[0].t_delta/t[0].t_delta_frame,1),0);let o=t[0].weight*i+t[1].weight*(1-i);u[e]=o;if(o)a++});Object.keys(u).forEach(function(e){let t=p[e];let i=u[e];if(i<0){switch(e){case"にやり":e="ω";break;case"上":e="下";break}i=-i}let o=c[e];let a=o&&o.name||e;let n=_.morph.target_index_by_name[a];if(n==null)return;i*=o&&o.weight||1;let s=d[n];let r=s.keys[0];if(r.morph_type==1){l.morphTargetInfluences[n]=i}else{let e={name:a,weight:i,morph_type:r.morph_type,morph_index:r.morph_index};_.morph.onupdate(e,e,0,n)}})}function e(e,t,i){i.info=e.split("|");var o=i.info[0];var a=this[o][t];if(i.is_dummy){if(a&&a[0].is_dummy)return;i.no_blending=true;if(i.pos)i.pos=n;if(i.rot)i.rot=s}i.timestamp=RAF_timestamp;i.t_delta=0;i.t_delta_frame=this.t_delta*(t.indexOf("指")!=-1||t.indexOf("手首")!=-1?B.skip_hand_countdown_max+1:1);i.t_delta_frame=Math.max(Math.min(i.t_delta_frame,200),1e3/60);if(a){if(RAF_timestamp==a[0].timestamp){a[0]=Object.assign(a[0],i)}else{if(!i.no_blending){let e=B.use_3D_pose||i.info[1]=="facemesh"?.5+Math.max(Math.min((Math.max(i.t_delta_frame,RAF_timestamp-a[0].timestamp)-50)/150,1),0)*.5:1;if(i.pos){i.pos.lerp(a[0].pos,1-e)}if(i.rot){i.rot.slerp(a[0].rot,1-e)}if(i.weight!=null){i.weight=i.weight*e+a[0].weight*(1-e)}}this[o][t]=[i,a[0]]}}else{this[o][t]=[i,i]}}function a(e,t){delete this[e][t]}function _(){this.skin={};this.morph={}}function d(){window.addEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones",this.process_bones);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}function c(){window.removeEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones",this.process_bones);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}var l=function(e){this.model_num=e;this.skin={};this.morph={};this.process_bones=t.bind(this);this.process_bones_after_IK=i.bind(this);this.process_morphs=o.bind(this)};l.prototype.add=e;l.prototype.remove=a;l.prototype.reset=_;l.prototype.add_events=d;l.prototype.remove_events=c;return l}();var oe=new ve(0);var ye=e.get("camera_hidden");var ge;ee={initialized:false,get ML_enabled(){return b},get ML_busy(){return te.busy||B.busy},get ML_fps(){return 1e3/(Math.max(te.enabled&&te.use_mediapipe&&(!B.enabled||!B.use_holistic)&&te._t||0,B.enabled&&B._t||0)||1e3)},get target_devicePixelRatio(){return g||window.devicePixelRatio},set target_devicePixelRatio(e){g=e==window.devicePixelRatio?0:e},get double_flip_mode(){return t&&!ee.mirror_3D},set double_flip_mode(e){t=e},get video_flipped(){return!b?i:!!i^!!ee.double_flip_mode},set video_flipped(e){i=e;this.reset_video_canvas()},get display_flipped(){return ee.mirror_3D?false:i!=ee.video_flipped},get mirror_3D(){return!b||!MMD_SA_options.user_camera.mirror_3D?false:MMD_SA_options.user_camera.mirror_3D==1?ee.visible:true},get x_flipped(){return ee.double_flip_mode||ee.mirror_3D},get hidden_enforced(){return ye||MMD_SA_options.user_camera.display.video.hidden||System._browser.overlay_mode>0||this.stream&&MMD_SA_options.user_camera.display.video.hidden_on_webcam},get display_floating(){return MMD_SA_options.user_camera.display.floating||ge},set display_floating(e){ge=e;if(this.video_host)this.video_host.style.zIndex=this.display_floating?2:0},camera_permission_granted:false,camera_list:null,deviceId:null,start:async function(i){var e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;MMD_SA.reset_camera();this._camera_reset=MMD_SA._trackball_camera.object.clone();if(this.initialized){if(this.visible){this.hide();DEBUG_show("User camera:HIDDEN",2);return}}var o={video:this.set_constraints()};try{if(i){this.init_stream(i)}else{if(is_mobile){o.video.facingMode="user"}if(MMD_SA_options.Dungeon){MMD_SA_options.Dungeon.run_event([[{message:{content:"(finding camera...)"}},{goto_branch:0}]])}let t;if(!this.camera_permission_granted||is_mobile&&!this.stream){try{t=await navigator.mediaDevices.getUserMedia(o);this.camera_permission_granted=true;this.camera_list=null}catch(e){if(is_mobile||!MMD_SA_options.Dungeon)throw"(ERROR: Camera unavailable, using fallback video instead)";this.camera_list=[]}}if(!is_mobile){let e=this.camera_list;if(!e){e=await navigator.mediaDevices.enumerateDevices();e=e.filter(e=>e.kind=="videoinput");if(MMD_SA_options.user_camera.preference)e.sort((e,t)=>MMD_SA_options.user_camera.preference.label.test(e.label)&&-1||MMD_SA_options.user_camera.preference.label.test(e.label)&&1||0);this.camera_list=e}if(MMD_SA_options.Dungeon){await new Promise(t=>{MMD_SA_options.Dungeon.run_event([[{message:{content:(e.length?"Choose a camera."+e.map((e,t)=>"\n"+(t+1)+". "+e.label).join(""):"No camera is available on this device. Drop a local media file as input instead.")+"\n"+(e.length+1)+". Local media file",bubble_index:3,branch_list:e.map((e,t)=>{return{key:t+1,branch_index:t+1}}).concat([{key:e.length+1,branch_index:e.length+1}])}}]].concat(e.map(e=>[{func:()=>{o.video.deviceId=e.deviceId;t()},ended:true}]).concat([[{func:()=>{if(ee.local_src){i=ee.local_src;t();MMD_SA_options.Dungeon.run_event()}else{DEBUG_show("(No local media file found)",3);MMD_SA_options.Dungeon.run_event(null,0,0)}}}]])))})}if(!i&&o.video.deviceId!=this.deviceId)t=await navigator.mediaDevices.getUserMedia(o)}else{if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2)}if(i){ee.init_stream(i)}else if(t){ee.init_stream(t);this.deviceId=o.video.deviceId}if(e&&e.dom_overlay)e.dom_overlay.use_dummy_webgl=true;DEBUG_show("(User camera:ON)",2)}if(!this.visible){this.show();DEBUG_show("User camera:VISIBLE",2)}}catch(e){if(MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode)MMD_SA_options.Dungeon.run_event({ended:true});ee.init_stream();console.error(e);DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}},init_stream:function(e){if(!this.initialized){this.video=this._video=document.createElement("video");this.video.autoplay=true;let e;this.video_host=document.createElement("div");e=this.video_host.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=this.display_floating?2:0;e.visibility=System._browser.overlay_mode?"hidden":"inherit";e.display=System._browser.overlay_mode?"none":"block";SL_Host.appendChild(this.video_host);this.video_canvas=document.createElement("canvas");e=this.video_canvas.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas);this.video_canvas_bodyPix=document.createElement("canvas");e=this.video_canvas_bodyPix.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_bodyPix);this.video_canvas_face_detection=document.createElement("canvas");e=this.video_canvas_face_detection.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_face_detection);this.video_canvas_facemesh=document.createElement("canvas");e=this.video_canvas_facemesh.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_facemesh)}this.initialized=true;this.show();if(this.stream){this.stream.getTracks().forEach(e=>{e.stop()});this.video.srcObject=this.stream=this.video_track=this.deviceId=null;console.log("(Previous stream stopped)")}if(te.enabled)te.reset_calibration();if(!e||typeof e=="string"){M(e);return}this.stream=e;this.video_track=e.getVideoTracks()[0];this.video.srcObject=e;console.log("(New stream started)");setTimeout(function(){let e=ee.video_track.getCapabilities();System._browser.console.log(Object.entries(e).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"));let t=ee.video_track.getSettings();System._browser.console.log(Object.entries(t).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"))},2e3);window.addEventListener("resize",function(){ee.video_track&&ee.video_track.applyConstraints(ee.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update")})})},get use_armIK(){return B.enabled||p.enabled},bodyPix:function(){var i;var t=false;c={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){MMD_SA._renderer.devicePixelRatio=1;MMD_SA._renderer.__resize(EV_width,EV_height);SL.style.visibility="hidden"}else{MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);SL.style.visibility="visible";ee.video_canvas_bodyPix.style.visibility="hidden"}},busy:0,mask:null,allPoses:null,load:async function(e){this.enabled=true;if(i)return;if(!this.mask){this.mask=document.createElement("canvas");d.load_face_cover()}i=await bodyPix.load(e||(1||is_mobile)?{architecture:"MobileNetV1",outputStride:16,multiplier:.5,quantBytes:2}:{architecture:"ResNet50",outputStride:32,quantBytes:2});console.log("bodyPix loaded")},segmentPerson:async function(e,t){await this.load();return await i.segmentPerson(e,t||{flipHorizontal:false,internalResolution:"medium",segmentationThreshold:.7})},toMask:async function(e,t,i){const o=await this.segmentPerson(e,t);this.allPoses=o.allPoses;i=i||{foregroundColor:{r:0,g:0,b:0,a:255},backgroundColor:{r:0,g:0,b:0,a:0}};return bodyPix.toMask(o,i.foregroundColor,i.backgroundColor)},update_frame:async function(e=ee.video_canvas,t,i,o){if(l.check_status()){ee.video_canvas.style.visibility="inherit";ee.video_canvas_bodyPix.style.visibility="hidden";SL.style.visibility="visible";return}if(this.busy)return;this.busy=RAF_timestamp;const a=await this.toMask(e,t,i);this.busy=0;if(!this.enabled)return;if(this.mask.width!=a.width||this.mask.height!=a.height){this.mask.width=a.width;this.mask.height=a.height}this.mask.getContext("2d").putImageData(a,0,0);if(ee.video_canvas_bodyPix.width!=e.width||ee.video_canvas_bodyPix.height!=e.height){ee.video_canvas_bodyPix.width=e.width;ee.video_canvas_bodyPix.height=e.height;ee.video_canvas_bodyPix.style.pixelWidth=window.innerWidth;ee.video_canvas_bodyPix.style.pixelHeight=window.innerHeight}let n=ee.video_canvas_bodyPix.getContext("2d");n.globalCompositeOperation="copy";n.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)";n.drawImage(this.mask,0,0,e.width,e.height);n.globalCompositeOperation="source-out";n.filter="none";n.save();n.translate(e.width,0);n.scale(-1,1);n.drawImage(SL,0,0,e.width,e.height);n.restore();n.globalCompositeOperation="destination-over";n.drawImage(e,0,0);ee.video_canvas_bodyPix.style.visibility="inherit";SL.style.visibility="hidden";this.update_frame_for_face_detection();l.check_status()},update_frame_for_face_detection:function(){let e=d.face_cover;if(!d.enabled||!e.complete)return;ee.video_canvas_face_detection.style.visibility="hidden";let t=e.width;let s=e.height;let r=[];this.allPoses.forEach(function(e){let t=e.keypoints;let i=t.find(e=>e.part=="nose");if(!i)return;let o=t.find(e=>e.part=="leftEye");let a=t.find(e=>e.part=="rightEye");let n;if(o&&a){let e=o.position.x-a.position.x;let t=o.position.y-a.position.y;n=Math.sqrt(e*e+t*t)*4}else{n=s}r.push([i.position.y,i.position.x,Math.max(n,s/2),100])});this.allPoses=undefined;d.update_frame_local(ee.video_canvas_bodyPix,r)}};return c}(),face_detection:function(){var t=false;function i(){d.initialized=true;if(!self.OffscreenCanvas)d.load_face_cover();r=new Worker("js/pico.worker.js");r.onmessage=function(e){var t=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof t==="string"){DEBUG_show(t,2);d.worker_initialized=true}else{ee._needs_RAF=true;if(t._t)DEBUG_show(t._t);d.dets=t.dets;d.busy=0;ee.video_canvas_face_detection.style.left=ee.video_canvas.style.left;ee.video_canvas_face_detection.style.top=ee.video_canvas.style.top;if(!self.OffscreenCanvas){System._browser.on_animation_update.add(function(){d.update_frame_local(null,d.dets)},0,0)}}d.update_frame()}}d={initialized:false,worker_initialized:false,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){this.dets=null;if(!this.initialized)i()}else{if(ee.initialized)ee.video_canvas_face_detection.style.visibility="hidden"}},load_face_cover:function(){if(!this.face_cover){this.face_cover=new Image;this.face_cover.src="images/laughing_man_134x120.png"}},dets:null,camera_video_timestamp:0,update_frame:function(e){function t(){var e=d.enabled&&d.worker_initialized&&S&&!d.busy&&D&&d.camera_video_timestamp!=S;if(!e)return;d.busy=RAF_timestamp;d.camera_video_timestamp=S;ee.video_canvas_face_detection.style.visibility="inherit";let t,i,o;t=ee.video_canvas;i=t.width;o=t.height;let a=t.getContext("2d").getImageData(0,0,i,o).data.buffer;let n=ee.video_canvas_face_detection.style;if(n.width!=t.style.width||n.height!=t.style.height){n.width=t.style.width;n.height=t.style.height}let s={rgba:a,w:i,h:o};if(!ee.video_canvas_face_detection._offscreen&&self.OffscreenCanvas){s.canvas=ee.video_canvas_face_detection.transferControlToOffscreen();ee.video_canvas_face_detection._offscreen=true;console.log("(Face detection: use offscreen canvas)")}r.postMessage(s,s.canvas?[s.canvas,s.rgba]:[s.rgba]);s.rgba=a=undefined;s=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}},update_frame_local:function(e,d){let t=ee.video_canvas.width;let i=ee.video_canvas.height;let o;if(!e){e=ee.video_canvas_face_detection;if(e.width!=t||e.height!=i){e.width=t;e.height=i}o=e.getContext("2d");o.clearRect(0,0,t,i)}else{o=e.getContext("2d")}o.globalCompositeOperation="source-over";let a=this.face_cover;let n=a.width;let s=a.height;let r,_,l,c;if(d.length){let t=1;d.forEach(function(e){r=e[2]*t;_=r*n/s;l=e[1]*t-_/2;c=e[0]*t-r/2;o.drawImage(a,0,0,n,s,l,c,_,r)})}else{r=Math.min(t,i);_=r*n/s;l=(t-_)/2;c=(i-r)/2;o.drawImage(a,0,0,n,s,l,c,_,r)}}};return d}(),facemesh:function(){var t=false;var q=0;var V=true;var N=0;var Q=[];var Z;var K;var X=false;function o(){q=0;V=true;N=0;Q=[];Z={};K={L:[],R:[]};var o={L:[159,145],R:[386,374]};["L","R"].forEach(function(t){for(var i=0;i<4;i++){let e=K[t][i]={};e.index=i;e._eye_open_average=0;e.eye_open_average=0;e.eye_open_lower=999;e.eye_open_data=[];e.height_ref_pts=o[t]}Z[t]={_height_average:0,height_average:0,height_data:[],height_ref_pts:t=="R"?[334,330]:[105,101]}})}var a;var $=[];var Y,J,M;Y=!is_mobile;M=!is_chrome||is_mobile;var e;function n(){if(te.initialized)return;te.initialized=true;for(var e=0;e<4;e++)$[e]=new THREE.Vector3;var o=[];if(System._browser.use_WASM_SIMD){o.push("simd=1")}if(ne){Y=true}if(M){Y=true;o.push("use_mediapipe_facemesh=1")}if(Y){Y=true;te.blink_detection=true;o.push("use_face_landmarks=1")}if(J){o.push("use_human_facemesh=1")}var t;if(MMD_SA_options.user_camera.ML_models.worker_disabled){t=new Promise((e,t)=>{A={postMessage:function(e,t){FacemeshAT.onmessage({data:e})}};let i=document.createElement("script");i.onload=async function(){await FacemeshAT.init(A,o);e()};i.src="js/facemesh_lib.js";document.head.appendChild(i)})}else{A=new Worker("js/facemesh_worker.js"+(o.length?"?"+o.join("&"):""))}A.onmessage=r;return t}function s(e,t,i){const o=new Path2D;o.moveTo(t[0][0]/2,t[0][1]/2);for(let e=1;e<3;e++){const a=t[e];o.lineTo(a[0]/2,a[1]/2)}if(i){o.closePath()}e.stroke(o)}var r=function(){var G=0,W=0,H=0,U=0;return function(e){var F=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof F==="string"){if(F=="OK"){te.worker_initialized=true}else{DEBUG_show(F,2);System._browser.console.log(F)}}else if(F.posenet){me({data:F})}else{ee._needs_RAF=true;let L="";if(F.faces.length){te.data_detected++}else{te.data_detected=0}if(F.faces.length&&F.faces[0].bb_center){b=F.faces[0].bb_center}else if(!B.enabled){b=[.5,.5]}if(F.faces.length&&te.data_detected_stable){let d=F.faces[0];let c=ee.x_flipped?1:-1;let p,u,o;if(d.rotation){const O=d.rotation.matrix;ie.set(O[0],O[1],O[2],0,O[3],O[4],O[5],0,O[6],O[7],O[8],0,0,0,0,1)}else{let e=MMD_SA._v3a_.fromArray(d.mesh[152]).sub(MMD_SA._v3b.fromArray(d.mesh[10])).normalize();let t=MMD_SA._v3b_.fromArray(d.mesh[454]).sub(MMD_SA._v3b.fromArray(d.mesh[234])).normalize();let i=MMD_SA.TEMP_v3.crossVectors(t,e).normalize();t.crossVectors(e,i);ie.set(t.x,t.y,t.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,0,0,0,0,1)}let a=MMD_SA.TEMP_v3.setEulerFromRotationMatrix(ie,"YZX");p=-a.x;u=-a.y;o=-a.z;let n=d.scaledMesh[454][0]-d.scaledMesh[234][0];let s=d.scaledMesh[454][1]-d.scaledMesh[234][1];let r;if(F.recalculate_z_rotation_from_scaledMesh){n/=Math.cos(u);s/=Math.cos(p);r=Math.sqrt(n*n+s*s)}else{n/=Math.cos(o);r=Math.abs(n/Math.cos(u))}te.face_width=r;let _;if(F.recalculate_z_rotation_from_scaledMesh){_=Math.asin(s/r)}else{_=o}let l=new THREE.Quaternion;l.setFromEuler(MMD_SA._v3a.set(p,u*c,_*c),"YZX");let v=performance.now();let y=0;if(U){y=v-U;H+=y;if(++W>=20){G=1e3/(H/W);W=H=0}}U=v;te._t=F._t;oe.t_delta=G&&1e3/G||y||F.fps&&1e3/F.fps||F._t;if(te.head_pose_enabled){oe.add("skin|facemesh","首",{after_IK:true,rot:l,_rot_ratio:te.face_width/Math.min(ee.video_canvas.width,ee.video_canvas.height),onProcessRotation:le})}if(!q)q=Date.now();let g=0;if(V){g=~~(Math.min((Date.now()-q)/5e3,Q.length/30,X?K.L[0].eye_open_data.length/30:1,1)*100);V=g<100}let M=d.faceInViewConfidence>(J?.75:.9)&&(ee.video==ee._image||!ee.video.paused&&Math.abs(u)<Math.PI/4);let b=MMD_SA._v3a.fromArray(d.mesh[13]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[14]));let w=MMD_SA._v3a.fromArray(d.mesh[61]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[291]));let t=N;if(!t){if(M&&b<2)Q.push(w);if(!Q.length){t=0}else{let e=parseInt(Q.length*.3);t=Q.sort((e,t)=>e-t).slice(e,Q.length-e).reduce((e,t)=>e+t)/(Q.length-e*2);if(!V){N=t}}}let S=0;let A=0;let h=0;let m=0;["L","R"].forEach(function(e){let t=Z[e];t.height=MMD_SA._v3a.fromArray(d.mesh[t.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[t.height_ref_pts[1]]));t._height_average=t.height_average;if(!t._height_average){if(M)t.height_data.push(t.height);if(!t.height_data.length){t._height_average=t.height}else{let e=parseInt(Q.length*.3);t._height_average=t.height_data.sort((e,t)=>e-t).slice(e,t.height_data.length-e).reduce((e,t)=>e+t)/(t.height_data.length-e*2);if(!V){t.height_average=t._height_average}}}h+=t.height/t._height_average});h/=2;h=(h-1)/.25*(h>1?2:1);if(t){if(w>t*1.05){A=Math.sqrt(Math.min((w-t*1.05)/(t*.25),1))}else if(w<t*.98){A=-Math.sqrt(Math.min((t*.98-w)/(t*.2),1))}if(b>2){S=Math.pow(Math.min((b-2)/(t*1/3),1),.5);if(A>.25)m=(A-.25)/.75*.3}}let D=0;let k=0;let E=0;let x=0;let P=0;if(Array.isArray(d.emotion)){d.emotion.forEach(e=>{switch(e.emotion){case"happy":D+=e.score;break;case"sad":k+=e.score;break;case"angry":case"disgust":E+=e.score;break;case"fear":x+=e.score;break;case"surprise":P+=e.score;break}})}let I=D-(k+E+x+P*.5);if(I<0){m*=Math.max(1+I*2,0)}else{m=Math.min(I*.2+m*(1+I*.5),.4)}oe.add("morph|facemesh","にこり",{weight:Math.min(m+D*.75,.75)});oe.add("morph|facemesh","困る",{weight:(k+x)/2*.75});oe.add("morph|facemesh","怒り",{weight:E*.75});h+=P*.2;oe.add("morph|facemesh","笑い",{weight:m});oe.add("morph|facemesh","びっくり",{weight:P*.75});oe.add("morph|facemesh","にやり",{weight:A});let T=MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(p,u,o),"YZX").conjugate();let i=[];[13,14,61,291].forEach(function(e,t){i[e]=$[t].fromArray(d.mesh[e]).applyQuaternion(T).setZ(0)});let z=MMD_SA._v3a.copy(i[61]).add(i[291]).multiplyScalar(.5);let B=i[61].distanceTo(i[291])*.5;let j=Math.atan2(i[13].y-z.y,B);let C=Math.atan2(i[14].y-z.y,B);let e=Math.max(-(j+C)*180/Math.PI+20*S,0);if(e)e=Math.min(e/20,.75);e=Math.min(e+k*.25,1);e*=.5;S=S*(1-e);oe.add("morph|facemesh","あ",{weight:S});oe.add("morph|facemesh","お",{weight:e});let f={L:[0],R:[0]};let R={L:[],R:[]};if(Y){let i=[0,0];let o=[0,0];d.eyes.forEach(function(e,t){if(e){i[t]=Math.max(Math.min((e[3]*2+p/(Math.PI/2))*(1-Math.abs(p)/Math.PI),1),-1);o[t]=Math.max(Math.min((e[2]*2-u/(Math.PI/2))*(1-Math.abs(u)/Math.PI),1),-1)}});["L","R"].forEach(function(t){let i=0;f[t][i]=0;let o=K[t][i];let a=MMD_SA._v3a.fromArray(d.mesh[o.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(d.mesh[o.height_ref_pts[1]]));let n=o.eye_open_average;if(!n){if(M){o.eye_open_data.push(a);let e=parseInt(o.eye_open_data.length*.3);n=o.eye_open_data.sort((e,t)=>e-t).slice(e,o.eye_open_data.length-e).reduce((e,t)=>e+t)/(o.eye_open_data.length-e*2);if(!V){o.eye_open_average=n}}else{n=o._eye_open_average}}if(M){if(o.eye_open_lower>a)o.eye_open_lower=a}o._eye_open_average=n;if(n){if(a>n){f[t][i]=Math.min(a/n,1.25)}else{let e=Math.min(o.eye_open_lower,n/2);f[t][i]=Math.max((a-e)/(n-e),0)}}});let e=(f.L[0]+f.R[0])/2;if(e>1)h+=(e-1)*2;else h-=(1-e)*.5;h=Math.min(h,1);let t=f.L[0]+f.R[0];if(t)t=f.L[0]/t;else t=.5;let a=i[0]*t+i[1]*(1-t);let n=o[0]*t+o[1]*(1-t);let s={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-(a-.3)*15/180*Math.PI,n*c*20/180*Math.PI,0),"YZX")};oe.add("skin|facemesh","両目",s);let r=THREE.MMD.getModels()[0].pmx.morphs_index_by_name["まばたきL"]!=null;let _=r?Math.min(Math.max(Math.abs(f.L[0]-f.R[0])-(.25+(1-Math.min(Math.max((Math.PI/6-Math.abs(u))/(Math.PI/12),0),1))*1),0)/.25,1):0;let l=Math.min(f.L[0],f.R[0]);f.L[0]=f.L[0]*_+l*(1-_);f.R[0]=f.R[0]*_+l*(1-_);if(r){oe.add("morph|facemesh","まばたき"+(c==1?"L":"R"),{weight:Math.max(Math.min(1-f.L[0]*.8-m,1),0)});oe.add("morph|facemesh","まばたき"+(c==1?"R":"L"),{weight:Math.max(Math.min(1-f.R[0]*.8-m,1),0)});oe.add("morph|facemesh","まばたき",{weight:0})}else{oe.add("morph|facemesh","まばたき",{weight:Math.max(Math.min(1-f.L[0]*.8-m,1),0)})}}else{let e=d.eyes[0];let t=0;let i=0;if(e){t=Math.max(Math.min((e[3]*2+p/(Math.PI/2))*(1-Math.abs(p)/Math.PI),1),-1);i=Math.max(Math.min((e[2]*2-u/(Math.PI/2))*(1-Math.abs(u)/Math.PI),1),-1)}let o=h*.25;if(o<0)o=Math.min(o+m,0);let a=Math.max(Math.min(.1-t*(t<0?2:1)*.2-o,.5),0);oe.add("morph|facemesh","まばたき",{weight:a});let n=1.25+Math.pow((f.L[0]+f.R[0])/2,2)*1.75;t=Math.sign(t)*Math.pow(Math.abs(t),n);i=Math.sign(i)*Math.pow(Math.abs(i),n);let s={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-t*15/180*Math.PI,i*c*20/180*Math.PI,0),"YZX")};oe.add("skin|facemesh","両目",s)}oe.add("morph|facemesh","上",{weight:Math.max(Math.min(h,1),-1)});L=L||d.eyes.length&&[(V?"Calibrating("+g+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(d.faceInViewConfidence*100)+"%",d.emotion?JSON.stringify(d.emotion):"Neutral"].join("\n");if(ae)L+=ae}else{L="(no facemesh data)\n"+ae}if(!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden)DEBUG_show((L&&L+"\n"+"FPS:"+EV_sync_update.fps_last+"\n"||"")+"F-FPS:"+Math.round(G)+"/"+Math.round(F.fps||0));te.busy=0}te.update_frame()}}();var w=document.createElement("canvas");var b=[];var _=0;var i=0;te={initialized:false,worker_initialized:false,get data_detected(){return _},set data_detected(e){if(e){if(!_){i=RAF_timestamp}}else{i=0}_=e},get data_detected_stable(){return t&&i&&RAF_timestamp-i>250},get head_pose_enabled(){return this.data_detected_stable||!B.enabled},get blink_detection(){return X},set blink_detection(e){X=e;if(t){if(X){o()}else{MMD_SA_options.auto_blink=a}}},get use_faceLandmarksDetection(){return Y},set use_faceLandmarksDetection(e){if(!this.initialized)Y=e},get use_mediapipe(){return M},set use_mediapipe(e){return M=e},face_width:0,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;this.data_detected=0;b[0]=b[1]=.5;if(t){if(!this.initialized)n();a=MMD_SA_options.auto_blink;o()}else{MMD_SA_options.auto_blink=a}k()},get bb_center(){return b},set bb_center(e){b=e},reset_calibration:o,frames:oe,init:n,worker_onmessage:r,camera_video_timestamp:0,update_frame:function(e){function t(){var o=te.enabled&&te.worker_initialized&&S&&!te.busy&&!(B.enabled&&B.use_holistic)&&D&&te.camera_video_timestamp!=S;if(!o)return;te.busy=RAF_timestamp;te.camera_video_timestamp=S;if(X){MMD_SA_options.auto_blink=false}let a;let n,s;let r,_;let c,p;let u;a=ee.video_canvas;let h=a.width,m=a.height;c=p=0;n=r=h;s=_=m;let l=1;let e=MMD_SA_options.user_camera.pixel_limit.facemesh;if(e){if(n*s>e[0]*e[1]){l=n/s>e[0]/e[1]?n/e[0]:s/e[1];n=r=Math.round(n/l);s=_=Math.round(s/l);a=w;u=true}}let t,f,d;if(MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio){t=MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio;d=Math.round(Math.min(n,s)*t);r=d;_=d;let e=1;const g=5*(M?2:1);if(te.data_detected<g&&t<1&&!B.enabled){e=t+(1-t)*(1-Math.min(te.data_detected/g,1));d=Math.round(Math.min(n,s)*e);f=t/e;t=e;a=w;u=true}c=Math.max(Math.min(n*b[0]-d/2,n-d),0)*(f||1);p=Math.max(Math.min(s*b[1]-d/2,s-d),0)*(f||1)}let v=a.getContext("2d");if(u){v.globalCompositeOperation="copy";let e=c,t=p,i=r,o=_;if(f){i=o=d;if(a.width!=r||a.height!=_){a.width=r;a.height=_;console.log("Facemesh canvas("+n+"x"+s+"=>"+r+"x"+_+"):"+[e,t,d,d].join(",")+"=>"+[c,p,r,_].join(","))}}else{if(a.width!=r||a.height!=_){a.width=r;a.height=_;console.log("Facemesh canvas("+n+"x"+s+")")}}v.drawImage(ee.video_canvas,Math.round(e*l),Math.round(t*l),Math.round(i*l),Math.round(o*l),0,0,r,_)}let y=u?v.getImageData(0,0,r,_).data.buffer:v.getImageData(c,p,r,_).data.buffer;let i={rgba:y,w:n*(f||1),h:s*(f||1),options:{use_facemesh:true,draw_canvas:true,flip_canvas:ee.display_flipped,bb:{x:Math.round(c),y:Math.round(p),w:r,h:_,ratio:t||0,scale:f||1}}};if(self.FacemeshAT){i.canvas=ee.video_canvas_facemesh}else if(!ee.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){i.canvas=ee.video_canvas_facemesh.transferControlToOffscreen();ee.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}A.postMessage(i,i.canvas?[i.canvas,i.rgba]:[i.rgba]);i.rgba=y=undefined;i=undefined}if(e||self.FacemeshAT){setTimeout(()=>{t()},0)}else{t()}}};return te}(),poseNet:function(){var t=false;var i=true;var a=true;var n={};var o=null;var s=0;var r=0;var _=0;var l=null;var d=null;B={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;Y=false;this.data_detected=0;_=0;THREE.MMD.getModels()[0].mesh.visible=true;I.set(0,0,0);if(t){if(!this.initialized)_e();MMD_SA_options.user_camera.ML_models.pose.events.enabled&&MMD_SA_options.user_camera.ML_models.pose.events.enabled()}else{THREE.MMD.getModels()[0].resetPhysics();MMD_SA_options.user_camera.ML_models.pose.events.disabled&&MMD_SA_options.user_camera.ML_models.pose.events.disabled()}k();if(B.use_holistic){setTimeout(()=>{if(t)te.enabled=p.enabled=true;else p.enabled=false;DEBUG_show("(Holistic Mode:"+(t?"ON":"OFF")+")",2)},0)}},get data_detected(){return s},set data_detected(e){if(1){if(e){if(!s){r=RAF_timestamp}if(this.data_detected_stable){_=0}}else{r=0;if(!_){_=RAF_timestamp}if(RAF_timestamp-_>250){oe.reset()}}}s=e},get data_detected_stable(){return t&&(!_||RAF_timestamp-_<250||r&&RAF_timestamp-r>500)},get use_3D_pose(){return t&&i&&q},set use_3D_pose(e){i=e},get use_holistic(){return o==null?ne:o},set use_holistic(e){o=e},get _use_holistic_(){return ne},set _use_holistic_(e){ne=e},get skip_hand_countdown_max(){return this.use_holistic||Q?0:1},set IK_disabled(e){a=e},get auto_grounding(){return l!=null?l:MMD_SA_options.user_camera.ML_models.pose.auto_grounding},set auto_grounding(e){l=e},get ground_plane_visible(){return d!=null?d:!t||!!MMD_SA_options.user_camera.ML_models.pose.auto_grounding},set ground_plane_visible(e){d=e},IK_disabled_check:function(){var i=new RegExp("("+toRegExp(["腕ＩＫ","足ＩＫ","つま先ＩＫ"],"|")+")$");var o=new RegExp("("+toRegExp(["腕ＩＫ"],"|")+")$");return function(e){var t=a&&this.use_3D_pose&&this.data_detected&&MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled&&(!e||o.test(e)||!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only&&i.test(e));if(t&&e){if(n[e])t=false}return t}}(),enable_IK:function(e,t){n[e]=t},frames:oe,camera_video_timestamp:0,get busy(){return C},get initialized(){return w},get worker_initialized(){return E}};return B}(),handpose:function(){var t=false;p={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){if(!this.initialized)_e()}},frames:oe,get busy(){return C},get initialized(){return w},get worker_initialized(){return E}};return p}(),snapshot:function(){var t=false;var i=false;var o;var a;function n(){var e=Math.ceil(3-(Date.now()-o)/1e3);if(e<=0){if(!ee.visible){r(SL);return}DEBUG_show("Capturing...");if(!ee.stream){if(!c.enabled){s();return}i=true}else{ee.target_devicePixelRatio=1;ee.video_track.applyConstraints(ee.set_constraints()).then(function(){System._browser.console.log("(Ready to capture)");System._browser.on_animation_update.add(function(){MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);if(!c.enabled){System._browser.on_animation_update.add(function(){s()},0,1);return}i=true},0,0)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update");_()})}System._browser.on_animation_update.remove(n,0)}else if(a!=e){a=e;DEBUG_show(a)}}function s(){let e=ee.video_canvas_bodyPix;e.width=SL.width;e.height=SL.height;let t=e.getContext("2d");t.globalCompositeOperation="source-over";t.drawImage(ee.video_canvas,0,0);if(d.enabled)t.drawImage(ee.video_canvas_face_detection,0,0);t.save();t.translate(e.width,0);t.scale(-1,1);t.drawImage(SL,0,0);t.restore();r(e)}function r(e){t=true;i=false;System._browser.on_animation_update.remove(n,0);e.toBlob(function(e){var t=URL.createObjectURL(e);window.open(t);_()})}function _(){Ldebug.style.posLeft=Ldebug.style.posTop=0;Ldebug.style.transform=Ldebug.style.transformOrigin="";DEBUG_show();i=false;ee.target_devicePixelRatio=0;t=false}l={init:function(){if(t){return true}if(MMD_SA.WebXR.session){let e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(!e.dom_overlay||!e.dom_overlay.use_dummy_webgl){DEBUG_show("(No snapshot in AR WebGL)",3);return true}}if(!ee.visible){r(SL)}else{t=true;o=Date.now();Ldebug.style.posLeft=Ldebug.style.posTop=50;Ldebug.style.transformOrigin="0 0";Ldebug.style.transform="scale(5,5)";a=3;DEBUG_show();DEBUG_show(a);System._browser.on_animation_update.add(n,0,0,-1)}},check_status:function(){if(!t)return;if(i){r(ee.video_canvas_bodyPix)}return true}};return l}(),reset_video_canvas:function(){if(this.video_canvas)this.video_canvas.width=this.video_canvas.height=S=0},show:function(){if(!this.initialized||this.visible)return;this.visible=true;if(ee.target_devicePixelRatio!=window.devicePixelRatio){ee.target_devicePixelRatio=0;ee.video_track.applyConstraints(ee.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update")})}_();if(this.hidden_enforced)this.hide()},hide:function(){if(!this.initialized||!this.visible)return;this.visible=false;this.video_canvas.style.visibility="hidden";d.enabled=false;c.enabled=false;h()},set_constraints:function(e){var t={};var i=window.devicePixelRatio/this.target_devicePixelRatio;var o=Math.round(window.innerWidth*i);var a=Math.round(window.innerHeight*i);var n=MMD_SA_options.user_camera.pixel_limit._default_;if(!g&&n){if(MMD_SA_options.user_camera.pixel_limit.fixed){o=n[0];a=n[1]}else if(o*a>n[0]*n[1]){let e=window.innerWidth/window.innerHeight>n[0]/n[1]?window.innerWidth/n[0]:window.innerHeight/n[1];o=Math.round(window.innerWidth/e);a=Math.round(window.innerHeight/e)}}ee.target_width=o;ee.target_height=a;if(!is_mobile||!screen.orientation||/landscape/.test(screen.orientation.type)){t.width=o;t.height=a}else{t.width=a;t.height=o}if(e)t=Object.assign(t,e);console.log("Camera constraints",t);return t}};return ee}(),console:{content_list:[],log:function(){for(var e=0;e<arguments.length;e++){this.content_list.push(arguments[e])}},reset:function(){this.content_list=[]},get output_text(){return this.content_list.join("\n")||"(EMPTY)"}}},_hash_sha256:{_hash_cache:{},hash:function(e){if(webkit_electron_mode){var t=webkit_electron_remote.getGlobal("HASH_SHA256");if(t)return t.hash(e)}var i=this._hash_cache[e];if(i)return i;var o=require("crypto").createHash("sha256");o.update(e);i=this._hash_cache[e]=o.digest("hex");return i}},_media_objs_paused_:[],_gadget_resume:function(e){if(e&&!SA_topmost_window.EV_sync_update.RAF_auto_paused)return false;if(!SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=false;SA_topmost_window.EV_sync_update.RAF_auto_paused=false;SA_topmost_window.System._media_objs_paused_.forEach(function(e){if(e.SL_MC_Play)e.SL_MC_Play();else if(e.paused)e.play()});SA_topmost_window.System._media_objs_paused_=[];System._browser.update_tray();return true},_gadget_pause:function(e){if(SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=true;SA_topmost_window.EV_sync_update.RAF_auto_paused=e;var s=SA_topmost_window.System._media_objs_paused_;var t=[top];for(var i=0;i<SA_child_animation_max;i++){if(SA_topmost_window.SA_child_animation[i])t.push(SA_topmost_window.document.getElementById("Ichild_animation"+i).contentWindow)}var r=0;var _=0;var l=0;t.forEach(function(e){for(var t in e.seq_items){var i=e.seq_items[t];if(!i._gadget_pause_disabled&&!i.paused&&i.count){r++;i.pause();s.push(i)}}var o=[];var a;a=document.getElementById("VdesktopBG");if(a)o.push(a);a=e.CANVAS_Video_Overlay&&e.CANVAS_Video_Overlay._video;if(a)o.push(a);o.forEach(function(e){if(e&&!e.paused&&!e.ended){_++;e.pause();s.push(e)}});if(e.SL&&e.SL._mouse_event_main&&e.SL._mouse_event_main()){var n;if(e.SL_MC_simple_mode)n=e.SL_MC_video_obj.paused;else if(e.MMD_SA)n=e.SL_MC_video_obj.vo.audio_obj.paused;else if(e.use_WMP&&e.WMP.in_use)n=e.WMP.player.playState!=3;else n=e.SL_MC_video_obj&&e.SL_MC_video_obj.paused;if(!n){l++;e.SL_MC_Play();s.push(e)}}});console.log("Gadget PAUSED (Seq/Video/MC):"+[r,_,l].join("/"));System._browser.update_tray();return true},_returnRelativePath:function(e){if(!WallpaperEngine_CEF_mode)return e;if(System.Gadget.path&&e.indexOf(System.Gadget.path)==0)e=e.substr(System.Gadget.path.length);e=/\:/.test(e)?toFileProtocol(e):e.replace(/\\/g,"/").replace(/^\//,"");return e}};System._init();return System}();
