// (2024-01-19)
var System=function(){var System={_init:function(){try{if(!Shell_OBJ)Shell_OBJ=new ActiveXObject("Shell.Application");if(!FSO_OBJ)FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject");if(!oShell)oShell=new ActiveXObject("WScript.Shell")}catch(e){alert(e.message)}this._child_html_filename=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html";this.Gadget._init();this.Machine._init();if(!is_SA_child_animation){SA_top_window.getScreenBounds=function(){var o=-1;var n;return function(e,t,i){if(i||o!=RAF_timestamp){o=RAF_timestamp;n=webkit_electron_mode?webkit_electron_screen.getDisplayNearestPoint({x:~~e,y:~~t}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}}return n}}()}else{SA_top_window.getScreenBounds=function(e,t,i){return SA_topmost_window.getScreenBounds(e,t,i)}}if(webkit_electron_mode){if(!is_SA_child_animation){SA_top_window.getPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_window.getPosition()}return i}}();SA_top_window.getCursorPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_electron_screen.getCursorScreenPoint()}return i}}()}else{SA_top_window.getPos=function(e){return SA_topmost_window.getPos(e)};SA_top_window.getCursorPos=function(e){return SA_topmost_window.getCursorPos(e)}}}SA_top_window.resizeToAbsolute=function(){var i;return function(e,t){webkit_window.setContentSize(e,t);i=true;if(absolute_screen_mode&&!System._browser._window_move_timerID){System._browser._window_move_timerID=setInterval(function(){var t=SA_top_window.screenLeftAbsolute;var i=SA_top_window.screenTopAbsolute;var o=0;return function(){var e=SA_top_window.getPos(true);if(t!=e[0]||i!=e[1]){DEBUG_show("(window position adjusted)",3);webkit_window.setPosition(t,i);System._browser.moveWallpaper(t,i);o=999}if(++o>10){clearInterval(System._browser._window_move_timerID);System._browser._window_move_timerID=null}}}(),100)}}}();(()=>{function o(){function e(){const e=document.body.style;webkit_window.setContentSize(e.pixelWidth,e.pixelHeight)}if(webkit_electron_mode&&window.devicePixelRatio!=1){window.removeEventListener("resize",e);window.addEventListener("resize",e,{once:true})}}SA_top_window.moveToAbsolute=function(e,t,i){o();if(absolute_screen_mode&&!i){webkit_window.setPosition(~~e,~~t)}else{this.moveTo(e,t)}};SA_top_window.moveByAbsolute=function(t,i){o();if(absolute_screen_mode){let e=SA_top_window.getPos(true);t+=~~e[0];i+=~~e[1];webkit_window.setPosition(t,i)}else{this.moveBy(t,i)}}})();Object.defineProperty(SA_top_window,"screenLeftAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[0]:this.screenLeft}});Object.defineProperty(SA_top_window,"screenTopAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[1]:this.screenTop}})},Gadget:{_init:function(){this.Settings.read=this.Settings.readString;this.Settings.write=this.Settings.writeString;Object.defineProperty(this,"onSettingsClosing",{get:function(){return this._onSettingsClosing},set:function(e){this._onSettingsClosing=e;this.settings_window.onbeforeunload=function(){e({closeAction:!!this.returnValue,Action:{commit:true}});System.Gadget.settings_window.System=null;System.Gadget.settings_window.onbeforeunload=null;System.Gadget.settings_window=null}}});var e=new ActiveXObject("Microsoft.XMLDOM");e["async"]=false;e.resolveExternals=false;e.validateOnParse=false;e.load("gadget.xml");this.version=e.selectSingleNode("//version").text},path:xul_mode?XPCOM_object._SA_root:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",_path_folder:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",docked:is_SA_child_animation,visible:true,Settings:{_settings_need_update:false,_settings:{},_changed:{},readString:function(name,raw_read){var v=this._settings[name];v=v?raw_read?decodeURIComponent(v):decodeURIComponent(v).replace(/\$([^\$]+)\$/g,function($0,$1,$2){return eval($1)}):Settings_default._custom_[name]||"";return v},writeString:function(e,t){var i=this._settings[e]||"";var o=encodeURIComponent(t);this._settings[e]=o;if(WallpaperEngine_CEF_mode){var n=JSON.parse(localStorage.Settings_by_path);if(!SA_HTA_folder||!n[SA_HTA_folder]){console.error(SA_HTA_folder)}else{if(n[SA_HTA_folder][e]!=o){n[SA_HTA_folder][e]=o;localStorage.Settings_by_path=JSON.stringify(n)}}}if(i!=o)this._changed[e]=this._settings_need_update=true},_writeSettings:function(e,t){if(!e&&!this._settings_need_update)return;this._settings_need_update=false;SystemEXT._save_settings_only=t;try{this._writeSettings_CORE()}catch(i){}SystemEXT._save_settings_only=false},_writeSettings_CORE:function(){var e=[];var t=this._settings;t._screenLeft=t._screenTop="";for(var i in t){var o=System.Gadget.Settings.readString(i);if(!o)continue;if(i=="_screenLeft"){o=SA_top_window.screenLeftAbsolute}else if(i=="_screenTop"){o=SA_top_window.screenTopAbsolute}e.push('"'+i+'":"'+encodeURIComponent(o)+'"')}SystemEXT.SaveLocalSettings(e)}}},Environment:{win32_env:null,getEnvironmentVariable:function(e){return oShell.ExpandEnvironmentStrings("%"+e+"%")}},Machine:{_init:function(){this._init_memory=function(){if(webkit_mode)return;if(this._WMI_obj_memory)return;try{this._WMI_obj_memory=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV");this._WMI_obj_memory.init()}catch(e){}};Object.defineProperty(this,"availableMemory",{get:function(){if(webkit_mode)return SA_require("os").freemem()/(1024*1024);this._init_memory();var e=this._WMI_obj_memory.update();return e.length?parseInt(e[e.length-1].AvailableMBytes):0}});Object.defineProperty(this,"totalMemory",{get:function(){if(webkit_mode)return SA_require("os").totalmem()/(1024*1024);if(!this._totalMemory){try{var e=new WMI_Refresher("Win32_OperatingSystem");e.init();this._totalMemory=parseInt(e.update()[0].TotalVisibleMemorySize)/1024}catch(t){}}return this._totalMemory}});this.totalMemory=0;var e={_WMI_obj:null,_cpu_obj:null,_get_cpu_obj:null,_init:function(){if(webkit_mode){if(this._get_cpu_obj)return;this._cpu_obj=[{count:-1,cpus:SA_require("os").cpus()}];this._get_cpu_obj=function(){var e=this._cpu_obj;if(e[0].count!=PC_count_absolute){if(e.unshift({count:PC_count_absolute,cpus:SA_require("os").cpus()})==3)e.pop()}return e};return}if(this._WMI_obj)return;try{this._WMI_obj=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV");this._WMI_obj.init()}catch(e){}},item:function(e){if(webkit_mode){var t=this._get_cpu_obj();var i=[];for(var o=0;o<2;o++){var n=t[o].cpus[e].times;var a=0;for(var s in n)a+=n[s];i[o]={total:a,idle:n.idle}}var r=i[0].idle-i[1].idle;var a=i[0].total-i[1].total;return{usagePercentage:a?(1-r/a)*100:0}}return{usagePercentage:parseFloat(this._WMI_obj.update()[e].PercentProcessorTime)}}};Object.defineProperty(e,"count",{get:function(){if(webkit_mode){return this._get_cpu_obj()[0].cpus.length}return this._WMI_obj.update().length-1}});this._CPUs=e;Object.defineProperty(this,"CPUs",{get:function(){this._CPUs._init();return this._CPUs}});var t={_WMI_obj:null,_init:function(){if(this._battery)return;this._battery={level:1,charging:false};if("getBattery"in navigator){var t=this;navigator.getBattery().then(function(e){DEBUG_show("Use Battery Status API",2);t._battery=e})}}};Object.defineProperty(t,"batteryPercentRemaining",{get:function(){return this._battery.level*100}});Object.defineProperty(t,"isPowerLineConnected",{get:function(){return this._battery.level==1||this._battery.charging}});Object.defineProperty(t,"isBatteryCharging",{get:function(){return this._battery.charging}});this._PowerStatus=t;Object.defineProperty(this,"PowerStatus",{get:function(){this._PowerStatus._init();return this._PowerStatus}})}},Shell:{itemFromFileDrop:function(e,t){return{path:""}},itemFromPath:function(e){e=toLocalPath(e);var t=e.replace(/[\/\\][^\/\\]+$/,"");var i=e.replace(/^.+[\/\\]/,"");var o=Shell_OBJ.NameSpace(t);if(o)o=o.ParseName(i);return o?new this._FolderItem(o):null},execute:function(e,t){Shell_OBJ.ShellExecute(e,t)},chooseFolder:function(e,t){var i=Shell_OBJ.BrowseForFolder(0,e,t);return i?new this._FolderItem(i.Self):null},_FolderItem:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.metadata=function(e){var t=this.obj.ExtendedProperty("Dimensions");if(!t){var i=this.obj.Path.replace(/[\/\\][^\/\\]+$/,"");var o=Shell_OBJ.NameSpace(i);t=o.GetDetailsOf(this.obj,26)}return t};Object.defineProperty(this.constructor.prototype,"isFolder",{get:function(){return this.obj.IsFolder}});Object.defineProperty(this.constructor.prototype,"isFileSystem",{get:function(){return(ie9_native?!this.obj.IsFolder:true)&&this.obj.IsFileSystem}});Object.defineProperty(this.constructor.prototype,"isLink",{get:function(){return this.obj.IsLink}});Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Shell._FolderItem(this.obj.GetLink)}});Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.obj.Path}});Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.obj.Type}});Object.defineProperty(this.constructor.prototype,"SHFolder",{get:function(){return new System.Shell._Folder(this.obj.GetFolder)}})}this.obj=e},_Folder:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;Object.defineProperty(this.constructor.prototype,"Items",{get:function(){return new System.Shell._FolderItems(this.obj.Items())}})}this.obj=e},_FolderItems:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.item=function(e){return new System.Shell._FolderItem(this.obj.Item(e))};Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.obj.Count}})}this.obj=e}},Debug:{outputString:function(e){}},_browser:{init:function(){document.ondragstart=document.onselectstart=function(e){return false};document.onmousedown=function(e){System._browser.onmousedown(e)};document.onmouseup=function(e){System._browser.onmouseup(e)};document.onmousemove=function(e){System._browser.onmousemove(e)};document.onkeydown=function(e){System._browser.onkeydown(e)};if(!WallpaperEngine_CEF_mode||!is_SA_child_animation||browser_native_mode){document.addEventListener("mouseover",function(e){System._browser.onmouseover(e)},false);document.addEventListener("mouseout",function(e){System._browser.onmouseout_waiting(e)},false)}Object.defineProperty(document,"onmouseover",{set:function(e){System._browser.onmouseover_custom=e}});Object.defineProperty(document,"onmouseout",{set:function(e){System._browser.onmouseout_waiting_custom=e}});var e=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.document_body_style_pixelWidth=Object.getOwnPropertyDescriptor(e,"pixelWidth");this.document_body_style_pixelHeight=Object.getOwnPropertyDescriptor(e,"pixelHeight");var t=function(){if(System._browser.resize_timerID)clearTimeout(System._browser.resize_timerID);if(System._browser._window_move_timerID){let i=SA_top_window.getPos();System._browser.resize_timerID=setInterval(function(){var t=0;return function(){let e=SA_top_window.getPos(true);if(++t>10||i[0]!=e[0]||i[1]!=e[1]){clearInterval(System._browser.resize_timerID);System._browser.resize_timerID=setTimeout("System._browser.resize()",0)}}}(),10)}else System._browser.resize_timerID=setTimeout("System._browser.resize()",0)};Object.defineProperty(e,"_set",{get:function(){return t}});if(ie9_native){Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System._browser.document_body_style_pixelWidth.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelWidth.set.call(this,e)}});Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System._browser.document_body_style_pixelHeight.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelHeight.set.call(this,e)}})}Object.defineProperty(this,"overlay_mode",function(){var t=0;var i=null;var o=null;return{get:function(){return t},set:function(e){if(e==t)return;switch(e){case 2:if(i==null)i=LdesktopBG_host.style.display;LdesktopBG_host.style.display="none";if(o==null)o=document.body.style.backgroundColor;document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden";if(this.camera.video_host){this.camera.video_host.style.visibility="hidden";this.camera.video_host.style.display="none"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="hidden";document.getElementById("Ldungeon_inventory").style.visibility="hidden";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden";DEBUG_show("(Press Esc to toggle "+(this.overlay_mode_TEMP?"UI":"bottom menu")+" display)",5)}break;default:if(i!=null)LdesktopBG_host.style.display=i;if(o!=null)document.body.style.backgroundColor=o;i=o=null;Lmenu_host.style.visibility="inherit";if(this.camera.video_host){this.camera.video_host.style.visibility="inherit";this.camera.video_host.style.display="block"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="inherit";document.getElementById("Ldungeon_inventory").style.visibility="inherit";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}}t=e}}}());var i=is_SA_child_animation&&parent.MMD_SA_options&&parent.MMD_SA_options.child_animation_as_texture;if(i){this.onkeydown({keyCode:97+SA_child_animation_id})}var o=System.Gadget.Settings.readString("SA_docked");if(o)System.Gadget.docked=!!parseInt(o);else{if(i)System.Gadget.docked=false}var o=document.createElement("div");o.id="Ldrag_dummy";var n=o.style;n.position="absolute";n.posLeft=n.posTop=0;n.zIndex=999;n.border="1px solid rgba(128,128,128,0.5)";n.visibility="hidden";document.body.appendChild(o);this.body=document.getElementById("Lbody_host")||document.body;if(w3c_mode)this.body.style.transition="opacity 0.5s";this.Opacity=1;var a=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(a){if(!self.SA_wallpaper_src){var s=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.FileExists(s)){try{var r=FSO_OBJ.OpenTextFile(s,1);self.SA_wallpaper_src=r.ReadLine();r.Close()}catch(A){}}}if(!self.SA_wallpaper_mask_src){var _=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.FileExists(_)){try{var r=FSO_OBJ.OpenTextFile(_,1);self.SA_wallpaper_mask_src=r.ReadLine();r.Close()}catch(A){}}}}if(a)a=System.Gadget.Settings.readString("WallpaperAsBG")||self.SA_wallpaper_src;var l;if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay.use_wallpaper_as_bg||self.EQP_use_wallpaper){l=a=true}var p;var d,c;this.Opacity=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.Gadget.Settings.readString("Opacity")||1);if(is_SA_child_animation&&!self.SA_wallpaper_src&&!l){a=a&&parent.WMP_wallpaper_mask&&parent.use_HTML5&&!parent.System.Gadget.Settings.readString("CSSTransform3D")&&!System.Gadget.Settings.readString("DisableWallpaperMask");if(a&&self.EQP_video_options&&EQP_video_options.use_canvas_video){a=false;this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");this.WMPMask_Draw()}this.wallpaper_mask_disabled=!a;if(a)p=parent.WMP_wallpaper_mask}else{var m;if(!is_SA_child_animation){d=System.Gadget.Settings.readString("_screenLeft");c=System.Gadget.Settings.readString("_screenTop")}d=d?parseInt(d):null;c=c?parseInt(c):null;if(a){const D=w3c_mode&&self.SA_wallpaper_src&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;this.wallpaper_mask_disabled=WallpaperEngine_CEF_mode||!!System.Gadget.Settings.readString("DisableWallpaperMask");var u,h,f;var n=LdesktopBG.style;try{n.pixelWidth=parent.screen.width;n.pixelHeight=parent.screen.height;var M=oShell.RegRead("HKCU\\Control Panel\\Colors\\Background");n.backgroundColor=/^\#/.test(M)?M:"rgb("+M.replace(/\W+/g,",")+")";u="HKCU\\Control Panel\\Desktop\\";if(WallpaperEngine_CEF_mode)h=oShell.RegRead(u+"Wallpaper")||self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;else h=self.SA_wallpaper_src==""?"":self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.RegRead(u+"Wallpaper");if(h){if(!this.wallpaper_mask_disabled){p=self.SA_wallpaper_mask_src||h.replace(/\.\w{3,4}$/,"_mask.png");if(!ValidatePath(p))p=null}f=oShell.RegRead(u+"WallpaperStyle");this.updateWallpaper(h,f)}if(D){this.updateWallpaper(D)}this.moveWallpaper(d||0,c||0);if(!is_SA_child_animation||self.SA_wallpaper_src)LdesktopBG_host.style.display="block"}catch(A){console.error(A);LdesktopBG_host.style.display="none"}if(p){if(!this.bg_mask)this.bg_mask="(blank)"}else{m=true}}else{m=true}if(m&&this.Opacity<1&&(w3c_mode||HTA_use_GPU_acceleration)){this.body.style.opacity=this.Opacity;DEBUG_show("Opacity:"+this.Opacity*100+"%",2)}}if(l&&!p)this.bg_mask="(blank)";if(a&&(p||this.bg_mask)){var g=document.createElement("canvas");g.id="C_wallpaper_mask";g._WallpaperAsBG_custom=l;g.onmousedown=function(){return false};if(!is_SA_child_animation||l){try{var y=g.width=parent.screen.width;var b=g.height=parent.screen.height;var v=g.getContext("2d");var w;if(!this.wallpaper_canvas_update){this.wallpaper_canvas_update=function(e,c){v.fillStyle=n.backgroundColor;v.fillRect(0,0,y,b);if(!e){if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper)e.img.img_obj._match_str=null})}return}var t;if(c=="0"){t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var o=parent.screen.height;var n,a,s,r,_,l,d,c;if(i>e){n=0;_=(i-e)/2;s=d=e}else{n=(e-i)/2;_=0;s=d=i}if(o>t){a=0;l=(o-t)/2;r=c=t}else{a=(t-o)/2;l=0;r=c=o}var m=C_wallpaper_mask.getContext("2d");m.drawImage(this,n,a,s,r,_,l,d,c);System._browser.BGMask_Create(!p);if(!p)return;var u=new Image;u.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,n,a,s,r,_,l,d,c);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};u.src=toFileProtocol(p)}}else{t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var o=parent.screen.height;var n,a,s,r,_;var l=C_wallpaper_mask.getContext("2d");if(c=="6"){n=Math.max(e/i,t/o);r=Math.round((i-e/n)/2);_=Math.round((o-t/n)/2);a=Math.round(e/n);s=Math.round(t/n);l.drawImage(this,0,0,e,t,r,_,a,s)}else{n=Math.min(e/i,t/o);r=Math.round((e/n-i)/2*n);_=Math.round((t/n-o)/2*n);a=Math.round(i*n);s=Math.round(o*n);l.drawImage(this,r,_,a,s,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)}System._browser.BGMask_Create(!p);if(!p)return;var d=new Image;d.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,r,_,a,s);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};d.src=toFileProtocol(p)}}if(w)w.onload=null;w=new Image;w.onload=t;w.src=toFileProtocol(e)}}this.wallpaper_canvas_update(h,f);if(!h){setTimeout("System._browser.BGMask_Create(true)",0)}}catch(A){}}var S=g.style;S.position="absolute";S.posLeft=-(d||0);S.posTop=-(c||0);S.zIndex=60;S.visibility="hidden";document.body.appendChild(g);this.mouseover_hide_list.push(g);if(is_SA_child_animation){this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");if(this.bg_mask)System._browser.BGMask_Create(!p);this.WMPMask_Draw()}}this._s_left=d;this._s_top=c},updateWallpaper:function(e,t){let i=document.getElementById("VdesktopBG");if(e&&/\.(mp4|mkv|webm)$/i.test(e)){if(!i){i=document.createElement("video");i.id="VdesktopBG";const d=i.style;d.position="absolute";d.top=d.left="0px";d.width=parent.screen.width+"px";d.height=parent.screen.height+"px";d.objectFit="cover";LdesktopBG.appendChild(i);i.autoplay=i.loop=true}i.src=toFileProtocol(e);i.style.visibility="inherit";return}if(i){i.pause();i.style.visibility="hidden"}var o=LdesktopBG.style;var n;if(e!=null){e=decodeURIComponent(e);if(this._wallpaper_last!=e){n=true;this._wallpaper_last=e;o.backgroundImage=e?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+"/"+e).replace(/\s/g,encodeURIComponent(" "))+")":"";if(this.wallpaper_opacity)o.opacity=this.wallpaper_opacity;if(this.wallpaper_bg_color)LdesktopBG_host.style.backgroundColor=this.wallpaper_bg_color}}else e=this._wallpaper_last;var a="HKCU\\Control Panel\\Desktop\\";if(t==null){t=oShell.RegRead(a+"WallpaperStyle")}if(this._wallpaper_style!=t){n=true;this._wallpaper_style=t}if(t=="0"){o.backgroundSize="";o.backgroundPosition="center center";if(oShell.RegRead(a+"TileWallpaper")=="0"){o.backgroundRepeat="no-repeat"}else{o.backgroundRepeat=""}}else if(t=="2"){o.backgroundSize="100% 100%";o.backgroundPosition="";o.backgroundRepeat=""}else if(t=="6"){o.backgroundSize="contain";o.backgroundPosition="center center";o.backgroundRepeat="no-repeat"}else{o.backgroundSize="cover";o.backgroundPosition="center center";o.backgroundRepeat="no-repeat";if(browser_native_mode){o.width="100%";o.height="100%"}else{o.pixelWidth=parent.screen.width;o.pixelHeight=parent.screen.height}if(windows_mode&&e){var s=loadImageDim(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+toLocalPath("\\")+e);if(s.w){var r=parent.screen.width/parent.screen.height;var _=(parent.screen.width*2-parent.screen.availWidth)/(parent.screen.height*2-parent.screen.availHeight);var l=s.w/s.h;if(l<r){o.pixelHeight=l<_?parent.screen.height*2-parent.screen.availHeight:Math.round(parent.screen.width/l)}else if(l>r){o.pixelWidth=l>_?parent.screen.width*2-parent.screen.availWidth:Math.round(parent.screen.height*l)}}}}if(this.wallpaper_canvas_update&&n){this.wallpaper_canvas_update(e,t);DEBUG_show("(Wallpaper canvas updated)",2)}},WMPMask_Draw:function(e){if(!this.C_WMP_wallpaper_mask_resized)return;if(!e)e=parent.SL;if(!e||!e.width)return;var t=document.body.style;var i=t.pixelWidth;var o=t.pixelHeight;if(!i)return;var n=0;var a=0;var s=e.width;var r=e.height;var _=this.C_WMP_wallpaper_mask_resized;if(_.width!=s){_.width=s;_.height=r;var l=parent.C_WMP_wallpaper_mask;_.getContext("2d").drawImage(l,0,0,l.width,l.height,0,0,s,r)}var d=this.bg_mask_image_resized;if(d&&d.width!=i){d.width=i;d.height=o;var c=this.bg_mask_image;d.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,i,o)}var i,o;i=self.B_content_width?B_content_width:document.body.style.pixelWidth;o=self.B_content_height?B_content_height:document.body.style.pixelHeight;var m=parent.SA_child_animation[SA_child_animation_id];var u=m.x;var p=m.y;if(is_SA_child_animation&&parent.EQP_border_width){u-=parent.EQP_border_width;p-=parent.EQP_border_width}var h=u-n;var f=h;if(h<0)h=0;if(f<0)f=-f;else f=0;var M=p-a;var g=M;if(M<0)M=0;if(g<0)g=-g;else g=0;var y=s+n-u;if(y>i)y=i;var b=r+a-p;if(b>o)b=o;var v=this.C_WMP_wallpaper_mask_mixed_resized;if(v.width!=i||v._x!=h||v._y!=M){v.width=i;v.height=o;var w=v.getContext("2d");w.drawImage(_,h,M,y,b,f,g,y,b);if(d)w.drawImage(d,0,0);v._x=h;v._y=M}var S=document.getElementById("C_wallpaper_mask");if(!S)return;S.width=i;S.height=o;var w=S.getContext("2d");w.globalCompositeOperation="copy";w.drawImage(e,h,M,y,b,f,g,y,b);w.globalCompositeOperation="destination-in";w.drawImage(v,0,0)},BGMask_CreateCanvas:function(e,t){if(!e)return null;if(!/^\((.+)\)$/.test(e)){return null}var i=RegExp.$1.split("|");var o=i[0];var n;if(o=="circle"){var a=parseInt(i[1]);var s=parseInt(i[2]);n=document.createElement("canvas");n.width=a;n.height=s;var r=a<s?a:s;var _=n.getContext("2d");_.beginPath();_.arc(a/2,s/2,r/2,0,Math.PI*2);_.fill()}else if(o=="feather"){var a=parseInt(i[1]);var s=parseInt(i[2]);var l=parseInt(i[3]);if(!l)l=parseInt(Math.sqrt(a*a+s*s)/25);n=document.createElement("canvas");n.width=a;n.height=s;var _=n.getContext("2d");var d;if(t)d=_.createImageData(a,s);else{_.fillRect(0,0,a,s);d=_.getImageData(0,0,a,s)}var c=d.data;for(var m=3,u=c.length;m<u;m+=4){var p=(m-3)/4;var h=p%a;var f=parseInt(p/a);var M=1.2;var g=1;if(h<l)g=(h+1)/(l+1);else if(h>=a-l)g=(a-h)/(l+1);g=1-(1-g)*M;if(g<0)g=0;var y=1;if(f<l)y=(f+1)/(l+1);else if(f>=s-l)y=(s-f)/(l+1);y=1-(1-y)*M;if(y<0)y=0;var b=g<y?g:y;if(b==1)continue;if(g<1&&y<1){var v=1-g;var w=1-y;var S=v>w?w/v:v/w;var A=Math.sqrt(1+S*S);b=1-(1-b)*A;if(b<0)b=0}c[m]=t?Math.round(255*(1-b)):Math.round(255*b)}_.putImageData(d,0,0)}return n},BGMask_Create:function(e){var t=this.bg_mask;if(!t)return;if(e){this.wallpaper_canvas=C_wallpaper_mask;C_wallpaper_mask.style.display="none"}else{var i=this.wallpaper_canvas=document.createElement("canvas");if(!is_SA_child_animation){i.width=parent.screen.width;i.height=parent.screen.height;i.getContext("2d").drawImage(C_wallpaper_mask,0,0)}}if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper&&e.img)e.img.img_obj._match_str=null})}if(/^\((.+)\)$/.test(t)){this.bg_mask_image=this.BGMask_CreateCanvas(t,is_SA_child_animation);this.BGMask_onload();return}var o=this.bg_mask_image=new Image;o.onload=this.BGMask_onload;o.src=toFileProtocol(t)},BGMask_onload:function(){var e=document.getElementById("C_BG_mask");if(!e){e=document.createElement("canvas");e.id="C_BG_mask";var t=e.style;t.position="absolute";t.posTop=t.posLeft=0;t.zIndex=60+1;document.body.appendChild(e)}if(System._browser.mouseover_hide_list.indexOf(e)==-1)System._browser.mouseover_hide_list.push(e);if(is_SA_child_animation){System._browser.bg_mask_image_resized=document.createElement("canvas")}else{System._browser.BGMask_Draw()}},BGMask_Draw:function(e){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom)){this.WMPMask_Draw();return}if(!document.getElementById("C_BG_mask"))return;var t,i,o,n;t=o=self.B_content_width?B_content_width:document.body.style.pixelWidth;i=n=self.B_content_height?B_content_height:document.body.style.pixelHeight;if(o>parent.screen.width)o=parent.screen.width;if(n>parent.screen.height)n=parent.screen.height;var a,s,r,_;var l=C_wallpaper_mask.style;if(l.posLeft>0){a=0;r=l.posLeft}else{a=-l.posLeft;r=0}if(l.posTop>0){s=0;_=l.posTop}else{s=-l.posTop;_=0}if(e){var d=a+","+s+","+o+","+n+","+r+","+_+","+o+","+n;if(e._match_str==d)return;e._match_str=d;e.width=t;e.height=i;var c=e.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(this.wallpaper_canvas,a,s,o,n,r,_,o,n);return}if(!this.bg_mask_image&&this.Opacity==1){document.getElementById("C_BG_mask").style.display="none";return}C_BG_mask.width=t;C_BG_mask.height=i;var c=C_BG_mask.getContext("2d");c.globalCompositeOperation="copy";c.globalAlpha=this.bg_mask_image?1:1-this.Opacity;c.drawImage(this.wallpaper_canvas,a,s,o,n,r,_,o,n);if(this.bg_mask_image){c.globalCompositeOperation="destination-out";c.globalAlpha=this.Opacity;c.drawImage(this.bg_mask_image,0,0,o,n)}else C_BG_mask.style.display="block"},resize_timerID:null,resize_cooling_timestamp:0,resize:function(){var e=false;function i(){if(!e){e=true;setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0)}}return function(){this.resize_timerID=null;if(use_SA_browser_mode){let t=document.body.style;if(is_SA_child_animation){let e=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;e.width=t.pixelWidth+"px";e.height=t.pixelHeight+"px";i()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.System._browser.capturePage_in_process){this.resize_timerID=setTimeout("System._browser.resize()",50);return}if(webkit_electron_mode)System._browser.resize_cooling_timestamp=performance.now();SA_top_window.resizeToAbsolute(t.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),t.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}i()}}}}(),drag_mouse_x:-1,drag_mouse_y:-1,drag_timerID:null,is_dragging:false,mouseout_timerID:null,mouseover_hide_list:[],onmouseover_custom:null,onmouseover:function(e){if(webkit_electron_mode&&(SA_topmost_window.returnBoolean("IgnoreMouseEvents")||SA_topmost_window.returnBoolean("AutoItStayOnDesktop"))&&!SA_topmost_window.webkit_IgnoreMouseEvents_disabled)return;if(this.onmouseover_custom&&this.onmouseover_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="hidden"},onmouseout_waiting_custom:null,onmouseout_waiting:function(e){if(this.onmouseout_waiting_custom&&this.onmouseout_waiting_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=e.clientX;var i=e.clientY;var o=document.body.style;var n=t>0&&t<o.pixelWidth&&(i>0&&i<o.pixelHeight);if(w3c_mode)e.stopPropagation();this.mouseout_timerID=setTimeout("System._browser.onmouseout("+n+")",200)},onmouseout:function(e){this.mouseout_timerID=null;if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}if(this.is_dragging){this.is_dragging=false;e=false;this.showFocus(false);System.Gadget.Settings._writeSettings(true,true)}else if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.is_dragging=false;this.showFocus(false)}if(e)return;var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="inherit";this.BGMask_Draw()},onmousedown:function(e){if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}var t=this.mouseover_hide_list;var i=true;for(var o=0;o<t.length;o++){var n=t[o].style;if(n.visibility!="hidden"){n.visibility="hidden";i=false}}var a;if(!i&&!is_SA_child_animation&&SA_child_animation_max){for(var o=0;o<SA_child_animation_max;o++){if(SA_child_animation[o]){a=true;break}}}i=!a;if(i){var s,r;if(WallpaperEngine_mode){s=e.x;r=e.y}else{if(absolute_screen_mode){s=SA_top_window.getCursorPos().x;r=SA_top_window.getCursorPos().y}else{s=e.screenX;r=e.screenY}}if(!is_SA_child_animation||!parent.returnBoolean("ChildDragDisabled")||true)this.drag_timerID=setTimeout("System._browser.onmousedown_dragStart("+s+","+r+")",200)}else DEBUG_show("(focused)",1)},showFocus:function(e,t){if(is_SA_child_animation){if(!xul_mode||!this.is_dragging)parent.System._browser.showFocus(e)}if(!e){Ldrag_dummy.style.visibility="hidden";return}var i=document.body.style.pixelWidth;var o=document.body.style.pixelHeight;if(i&&o){var n=Ldrag_dummy.style;n.pixelWidth=i-2;n.pixelHeight=o-2;n.visibility="inherit"}if(t)DEBUG_show("(selected)",1)},arrangeChildZ:function(i){System.Gadget.Settings._settings_need_update=true;var e=[];for(var t=0;t<SA_child_animation_max;t++){if(SA_child_animation[t])e[t]={index:t,z:SA_child_animation[t].z}}e.sort(function(e,t){return e.index==i?1:t.index==i?-1:e.z-t.z}).forEach(function(e,t){SA_child_animation[e.index].z=document.getElementById("Ichild_animation"+e.index).style.zIndex=t})},_child_selected:null,_drag_disabled:false,_child_drag_disabled:false,onmousedown_dragStart:function(e,t){this.drag_timerID=null;if(WallpaperEngine_mode)return;if(is_SA_child_animation&&is_SA_child_animation_host){parent.System._browser.is_dragging=true;parent.System._browser.drag_mouse_x=e;parent.System._browser.drag_mouse_y=t;DEBUG_show("drag start",1);this.showFocus(true);return}if(!this._drag_disabled&&(!is_SA_child_animation||!parent.System._browser._child_drag_disabled)){this.is_dragging=true;this.drag_mouse_x=e;this.drag_mouse_y=t;DEBUG_show("drag start",1)}this.showFocus(true);if(is_SA_child_animation){parent.System._browser.arrangeChildZ(SA_child_animation_id)}},_BL_clicked:0,_BL_clicked_max:1,_BL_clicked_timerID:null,onmouseup_custom:null,onmouseup:function(e){if(this.onmouseup_custom&&this.onmouseup_custom(e))return;this.onmouseout(true);if(this._drag_disabled||is_SA_child_animation&&parent.System._browser._child_drag_disabled)this.showFocus(false);if(e.clientX>20||e.clientY<document.body.style.pixelHeight-20)return;if(this._BL_clicked_timerID){clearTimeout(this._BL_clicked_timerID);this._BL_clicked_timerID=null}if(++this._BL_clicked<this._BL_clicked_max){this._BL_clicked_timerID=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250);return}this._BL_clicked=0;if(!WallpaperEngine_mode&&(!self.Lquick_menu||!Lquick_menu._activated))this.confirmClose()},confirmClose:function(e){if(browser_native_mode){if(confirm("This will reload System Animator.")){SA_topmost_window.location.reload()}return}if(!e||xul_mode){System._browser.showFocus(true,true);var t=is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.is_SA_hosted){if(confirm("Close "+SystemEXT._default.gadget_name+" (XUL host)?")){SA_top_window.opener.close();return}t+=" (this animation only)"}System._browser.showFocus(false)}if(is_SA_child_animation){if(is_SA_child_animation_host){parent.System._browser.confirmClose(e)}else{parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id]=null;var i=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);i.style.pixelWidth=i.style.pixelHeight=0;i.style.visibility="hidden";i.contentWindow.location.replace("z_blank.html")}}else{if(WallpaperEngine_CEF_mode&&!W8_or_above){SA_top_window.location.reload()}else SA_top_window.close()}},onSettings:function(e){if(!e&&/XR Animator$/.test(Settings.f_path)&&MMD_SA.MMD_started){const n=MMD_SA_options.Dungeon.dialogue_branch_mode?.find?.(e=>e.is_closing_event);if(MMD_SA_options.Dungeon.dialogue_branch_mode&&!n)return false;new Promise(i=>{if(n){const o=Array.isArray(n.key)?n.key[0]:n.key;let e,t;if(typeof o=="number"){t=o+96}else if(o=="Esc"){e="Escape"}else{e="Key"+o}document.dispatchEvent(new KeyboardEvent("keydown",{code:e,keyCode:t}));System._browser.on_animation_update.add(i,0,0)}else{i()}}).then(()=>{new Promise(e=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.settings.confirm"),branch_list:[{key:1,func:()=>{e()},ended:true},{key:2}]}}]])}).then(()=>{this.onSettings(true)})});return false}if(!System.Gadget.settingsUI)return false;if(use_inline_dialog){if(document.getElementById("Idialog").style.visibility=="hidden"){document.getElementById("Idialog").contentWindow.location.replace("settings.html")}return true}System._browser.showFocus(true,true);var t=showModalDialog(System.Gadget.settingsUI,self);t=xul_mode?self.returnValue:t;System._browser.showFocus(false);this.onSettingsClosed(t);return true},onSettingsClosed:function(e){if(System.Gadget.onSettingsClosed)System.Gadget.onSettingsClosed({closeAction:!!e,Action:{commit:true}})},onkeydown:function(e){var t=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host;const i=e.altKey;const o=i||!self.MMD_SA||!MMD_SA_options.Dungeon_options||!e.preventDefault;var n=e.keyCode;if(n==67&&i){this.confirmClose();return true}else if(n==69&&o){return this.onSettings()}else if(n==79&&o){var a;if(is_SA_child_animation){var s=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id].opacity=a;s.opacity=a}else if(this.bg_mask){a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}System.Gadget.Settings.writeString("Opacity",a);this.Opacity=a;this.BGMask_Draw()}else if(w3c_mode||HTA_use_GPU_acceleration){var s=this.body.style;a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}System.Gadget.Settings.writeString("Opacity",a);s.opacity=a}else return false;this.Opacity=a;DEBUG_show("Opacity:"+a*100+"%",2);this.update_tray();return true}else if(n==83&&o){var r=System.Gadget.docked?System.Gadget.onUndock:System.Gadget.onDock;if(!r)return false;setTimeout(System._browser.ondockundock,0);return true}else if(t&&(n>=49&&n<49+SA_child_animation_max)&&o){var _=n-49;var l=is_SA_child_animation?parent:self;var d=l.document.getElementById("Ichild_animation"+_);if(!d||!d.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(_+1)+" not found)",2);return true}var c=d.contentWindow;var m=c.parent;var u=m.System._browser;if(c.System.Gadget.Settings.readString("CSSTransform3D")||m.System.Gadget.Settings.readString("CSSTransform3D")){if(u._child_selected==_){u._child_selected=null;c.DEBUG_show("(deselected)",2);m.DEBUG_show("(child"+(_+1)+" deselected)",2);return true}u._child_selected=_}c.DEBUG_show("(selected)",2);m.DEBUG_show("(child"+(_+1)+" selected)",2);u.arrangeChildZ(_);c.focus();return true}else if(t&&n==96&&o){var l=is_SA_child_animation?parent:self;var s=l.Lchild_animation_parent.style;s.visibility=s.visibility=="hidden"?"visible":"hidden";if(webkit_mode)s.display=s.visibility=="hidden"?"none":"block";l.System._browser._child_selected=null;return true}else if(t&&(n>=97&&n<97+SA_child_animation_max)&&o){var _=n-97;var l=is_SA_child_animation?parent:self;var d=l.document.getElementById("Ichild_animation"+_);if(!d||!d.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(_+1)+" not found)",2);return true}var s=d.style;s.visibility=s.visibility=="hidden"?"visible":"hidden";if(webkit_mode)s.display=s.visibility=="hidden"?"none":"block";l.System._browser._child_selected=null;var p=false;for(var h=0;h<SA_child_animation_max;h++){var d=l.document.getElementById("Ichild_animation"+h);if(d&&d.contentWindow.is_SA_child_animation&&d.style.visibility!="hidden"){p=true;break}}l.document.getElementById("Lchild_animation_parent").style.visibility=p?"visible":"hidden";return true}else if(n>=96&&n<96+10){if(self.MMD_SA&&MMD_SA_options.motion_shuffle&&MMD_SA.use_jThree&&MMD_SA.MMD_started){if(this.camera.ML_enabled){}else if(n==96){if(MMD_SA_options._motion_shuffle){if(!MMD_SA_options.motion_shuffle_list_default&&MMD_SA_options._motion_shuffle_list_default){MMD_SA_options.motion_shuffle_list_default=MMD_SA_options._motion_shuffle_list_default.slice();MMD_SA._force_motion_shuffle=true}else{MMD_SA_options.motion_shuffle=MMD_SA_options._motion_shuffle.slice(0);MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motions shuffled)",2)}}}else{var _=n-97;if(MMD_SA_options.motion_by_song_name){if(MMD_SA_options.motion_by_song_name._loading_){DEBUG_show("(music/motion loading)",2);return true}let e=Object.keys(MMD_SA_options.motion_by_song_name).find(e=>{return MMD_SA_options.motion_by_song_name[e].key==_+1});if(e){let t=MMD_SA_options.motion_by_song_name[e].song_path;if(/\.zip\#/i.test(t)){MMD_SA_options.motion_by_song_name._loading_=true;t=t.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let e=new self.XMLHttpRequestZIP;e.onload=function(){MMD_SA_options.motion_by_song_name._loading_=false;let e=this.response;e.name=t.replace(/^.+[\/\\]/,"");e.isFileSystem=true;SA_DragDropEMU(e)};e.open("GET",t,true);e.responseType="blob";e.send()}else SA_DragDropEMU(t);return true}}if(_>=MMD_SA.normal_action_length){DEBUG_show("(MMD motion not found)",2);return true}if(!MMD_SA_options._motion_shuffle)MMD_SA_options._motion_shuffle=MMD_SA_options.motion_shuffle.slice(0);MMD_SA_options.motion_shuffle=[_];MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motion changed)",2)}return true}}return false},ondockundock:function(){DEBUG_show("Dock state changed",2);var e=!System.Gadget.docked;System.Gadget.docked=e;System.Gadget.Settings.writeString("SA_docked",!!e==!!is_SA_child_animation?"":e?"1":"0");var t=!e?System.Gadget.onUndock:System.Gadget.onDock;if(!t)return;t()},onmousemove_custom:null,onmousemove:function(e){var t,i;t=this._WE_mouse_x=e.x;i=this._WE_mouse_y=e.y;if(this.onmousemove_custom&&this.onmousemove_custom(e))return;if(!this.is_dragging){if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.onmousemove(e)}return}if(!WallpaperEngine_mode){if(absolute_screen_mode){t=SA_top_window.getCursorPos().x;i=SA_top_window.getCursorPos().y}else{t=e.screenX;i=e.screenY}}if(is_SA_child_animation||this._child_selected!=null){var o,n,a;if(is_SA_child_animation){a=SA_child_animation_id;o=self;n=parent}else{a=this._child_selected;o=document.getElementById("Ichild_animation"+a).contentWindow;n=self}n.System.Gadget.Settings._settings_need_update=true;var s=n.SA_child_animation[a];var r=n.document.getElementById("Ichild_animation"+a).style;var _=o.document.body.style;var l=n.document.body.style;var d=s.x+t-this.drag_mouse_x;var c=s.y+i-this.drag_mouse_y;r.posLeft=s.x=d;r.posTop=s.y=c;o.document.getElementById("Ldebug").innerText=n.document.getElementById("Ldebug").innerText="(moving)";o.DEBUG_hide_sec=n.DEBUG_hide_sec=0;o.DEBUG_show("("+d+","+c+")",2)}else{System.Gadget.Settings._settings_need_update=true;this.moveBy(t-this.drag_mouse_x,i-this.drag_mouse_y,e)}this.moveWallpaper();this.drag_mouse_x=t;this.drag_mouse_y=i},moveWallpaper:function(e,t){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom))return;if(is_SA_child_animation||document.getElementById("LdesktopBG")&&LdesktopBG.style.display!="none"){if(WallpaperEngine_mode){e=0;t=0}else{if(absolute_screen_mode){if(e==null)e=SA_top_window.screenLeftAbsolute;if(t==null)t=SA_top_window.screenTopAbsolute;var i=SA_top_window.getScreenBounds(e,t);e=-(e-i.x);t=-(t-i.y)}else{if(e==null)e=SA_top_window.screenLeft;if(t==null)t=SA_top_window.screenTop;e=-(e%parent.screen.width);t=-(t%parent.screen.height)}}if(is_SA_child_animation){var o=parent.SA_child_animation[SA_child_animation_id];e-=o.x;t-=o.y}else{var n=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;n.posLeft=e;n.posTop=t}if(document.getElementById("C_wallpaper_mask")){var a=C_wallpaper_mask.style;a.posLeft=e;a.posTop=t}}},moveBy:function(e,t,i){SA_top_window.moveByAbsolute(e,t)},update_tray:function(e){try{if(!webkit_electron_mode||IPC.active_window!=self)return;if(this._tray_last_updated==RAF_timestamp){return}this._tray_last_updated=RAF_timestamp;if(!e){e={active_window_id:IPC.active_window_id,click_thru:SA_topmost_window.returnBoolean("IgnoreMouseEvents"),click_thru_partial:SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial"),always_on_top:SA_topmost_window.returnBoolean("AutoItAlwaysOnTop"),stay_on_desktop:SA_topmost_window.returnBoolean("AutoItStayOnDesktop"),use_electron_as_wallpaper:SA_topmost_window.WebKit_object.use_electron_as_wallpaper,auto_pause:SA_topmost_window.returnBoolean("AutoItAutoPause"),opacity:is_SA_child_animation?parent.SA_child_animation[SA_child_animation_id].opacity:parseFloat(System.Gadget.Settings.readString("Opacity")||1),opacity_on_hover:parseFloat(System.Gadget.Settings.readString("OpacityOnHover")||1),size:Settings.CSSTransformFullscreen?-1:Settings.CSSTransformScale,animation_path:Settings.f_path_folder,media_control:self.SL&&SL._mouse_event_main&&SL._mouse_event_main(),MMD:null};var t=[true];for(var i=0;i<SA_child_animation_max;i++)t.push(!!SA_topmost_window.SA_child_animation[i]);e.active_window=t;e.lock_child_dragging=returnBoolean("ChildDragDisabled");var o=this.tray_menu_custom;if(o){e.custom_menu_para=o.para;o.update_tray&&o.update_tray(e)}else{e.custom_menu_para={}}if(self.MMD_SA&&MMD_SA._tray_updatable){var n=MMD_SA_options.MME;var a=e.MMD={use_webgl2:!!MMD_SA.use_webgl2,use_dungeon:!!MMD_SA_options.Dungeon,use_THREEX:!!MMD_SA.THREEX.enabled,look_at_camera:!!MMD_SA_options._look_at_screen,look_at_mouse:!!MMD_SA_options._look_at_mouse,trackball_camera:!!returnBoolean("MMDTrackballCamera"),random_camera:!!returnBoolean("MMDRandomCamera"),random_camera_available:!!MMD_SA_options.use_random_camera,override_default_for_external_model:!!returnBoolean("MMDOverrideDefaultForExternalModel"),VMC_sender_enabled:!!MMD_SA.OSC.VMC.sender_enabled,VMC_send_camera_data:!!MMD_SA.OSC.VMC.send_camera_data,VMC_app_mode:MMD_SA.OSC.app_mode||"",VMC_hide_3D_avatar:!!MMD_SA.hide_3D_avatar,light:{},MME:{self_overlay:{},HDR:{},serious_shader:{},SAO:{},PostProcessingEffects:{}}};a._material_list=MMD_SA._material_list||[];if(MMD_SA._model_list){a._model_list=MMD_SA._model_list;MMD_SA._model_list=null}var s=jThree("#MMD_DirLight").three(0);var r=s.color;a.light.color=[Math.min(255,parseInt(r.r*256)),Math.min(255,parseInt(r.g*256)),Math.min(255,parseInt(r.b*256))];a.light.position=s.position.clone().sub(MMD_SA_options.MMD_disabled&&{x:0,y:0,z:0}||THREE.MMD.getModels()[0].mesh.position).multiplyScalar(1/MMD_SA_options.light_position_scale).toArray();a.shadow_darkness=MMD_SA_options.shadow_darkness;Object.assign(a.MME.self_overlay,n.self_overlay);Object.assign(a.MME.HDR,n.HDR);Object.assign(a.MME.serious_shader,n.serious_shader);Object.assign(a.MME.SAO,n.SAO);var _=MMD_SA_options.MME.PostProcessingEffects;var l=a.MME.PostProcessingEffects;l.enabled=returnBoolean("Use3DPPE")||!!(MMD_SA_options.PPE_disabled_on_idle?MMD_SA_options._PPE_enabled:_.enabled);l.use_SAO=!!_.use_SAO;l.use_Diffusion=!!_.use_Diffusion;l.use_BloomPostProcess=!!_.use_BloomPostProcess;l.use_BloomPostProcess_blur_size=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessBlurSize")||.5);l.use_BloomPostProcess_threshold=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessThreshold")||.5);l.use_BloomPostProcess_intensity=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessIntensity")||.5);a.MME_saved=!!MMD_SA_options.MME_saved[MMD_SA_options.model_para_obj._filename]}if(!document.getElementById("Lchild_animation_parent"))e.apply_to_child=null;else e.apply_to_child=returnBoolean("CSSTransformToChildAnimation")}webkit_electron_remote.getGlobal("update_tray")(e)}catch(d){console.error(d)}},load_file:function(t,i,o,n){if(!o)o="blob";if(!n)n=!(self.MMD_SA&&MMD_SA.fn);if(n){if(self.MMD_SA&&MMD_SA.fn){MMD_SA.fn.load_length_extra++}else{MMD_SA_options.load_length_extra=(MMD_SA_options.load_length_extra||0)+1}}var e;if(/\.zip\#/i.test(t)||o!="blob"||typeof i=="function"){e=function(){var e=new XMLHttpRequestZIP;e.onload=async function(){if(typeof i=="function"){await i(e)}else{i.src=URL.createObjectURL(this.response)}if(n){MMD_SA.fn.setupUI()}e=undefined};e.open("GET",toFileProtocol(t),true);e.responseType=o;e.send()}}else{e=function(){if(n){var e=function(){MMD_SA.fn.setupUI();i.removeEventListener("load",e)};i.addEventListener("load",e)}i.src=toFileProtocol(t)}}if(!self.XMLHttpRequestZIP){window.addEventListener("jThree_ready",function(){e()})}else{e()}},on_animation_update:function(){var a=[[],[]];var n=0;return{add:function(e,t,i,o){a[i].push({func:e,frame_count:t+i,loop:o,index:n++})},remove:function(t,e){a[e].forEach(e=>{if(e.func==t)e.canceled=true})},run:function(e){var t=[];var i=a[e];if(!i.length)return;var o=[];for(let e=0;e<i.length;e++){const n=i[e];if(n.canceled)continue;if(--n.frame_count>=0){o.push(n)}else{n.func();if(n.loop&&--n.loop!=0)o.push(n)}}a[e]=o}}}(),get css_scale(){return window.devicePixelRatio>=2?.5:1},virtual_numpad_toggle:function(e){if(e==null)e=Lnumpad_row0.style.display=="none";Lnumpad_row0.style.display=e?"inline":"none";Lnumpad_rows.style.display=e?"block":"none";if(e&&self.ChatboxAT)ChatboxAT.chatW_minimize(0,true)},virtual_numpad:function(){var c={};var m={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,X:9};return function(e,t){e.preventDefault();e.stopPropagation();var i=MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.character.combat_mode;var o=e.target.textContent;var n=c[o]=c[o]||{};var a,s,r;switch(o){case"S":a=16;n.pressed=!n.pressed;const l=document.getElementsByClassName("Lnumpad_button");if(n.pressed&&MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode){for(let e=0;e<l.length;e++){const d=l[e];if(/([1-9])/.test(d.textContent))d.textContent=Object.entries(m).find(e=>e[1]==RegExp.$1)[0]}}else{for(let e=0;e<l.length;e++){const d=l[e];if(/([A-HX])/.test(d.textContent))d.textContent=Object.entries(m).find(e=>e[0]==RegExp.$1)[1]}}t=n.pressed?"keydown":"keyup";break;case"+":a=107;if(i){if(t=="keyup")return;n.pressed=!n.pressed;t=n.pressed?"keydown":"keyup"}break;case"-":a=109;break;case"*":a=106;break;case"/":a=111;break;case"⏎":a=13;break;case"J":a=32;break;case"↑":a=38;r="ArrowUp";break;case"↓":a=40;r="ArrowDown";break;case"←":a=37;r="ArrowLeft";break;case"→":a=39;r="ArrowRight";break;default:if(/([0-9])/.test(o))a=parseInt(o)+96;else r="Key"+o}if(n.timeoutID)clearTimeout(n.timeoutID);if(n.intervalID)clearTimeout(n.intervalID);n.timeoutID=n.intervalID=null;let _=new KeyboardEvent(t,{bubbles:true,cancelable:true,key:o,keyCode:a,code:r,shiftKey:c["S"]&&c["S"].pressed});document.dispatchEvent(_);if(t=="keydown"){if(/[\+S]/.test(o)&&(o!="+"||i)){e.target.style.opacity="0.75"}else{n.timeoutID=setTimeout(function(){n.intervalID=setInterval(function(){document.dispatchEvent(_)},100)},400)}}else{e.target.style.opacity=""}}}(),P2P_network:function(){var o;var n=0;var a={events:{peer:{},connection:{handshake_request:function(e,t){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) responding handshake request from Peer-"+e.index+"("+e.id+")");t.send({handshake:{request:true}})},handshake_respond:function(e,t,i){if(i.request){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/client)'s handshake request accepted from Peer-"+e.index+"("+e.id+")");t.send({handshake:{accepted:true}})}else if(i.accepted){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) accepted handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_accecpted&&e.para.events.connection.handshake_request_accecpted[t.label]){e.para.events.connection.handshake_request_accecpted[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_accecpted[t.label]}}else{console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) rejected handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_rejected&&e.para.events.connection.handshake_request_rejected[t.label]){e.para.events.connection.handshake_request_rejected[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_rejected[t.label]}}},data:function(e,t,i){}},send_message:function(e){if(!e.command)t.content_window.ChatboxAT.ChatShow([e.name+": "+e.msg]);return null}}};function s(t,i){this._connection=i;this.status="connecting";t.connections[i.label]=this;var o=this;i.on("data",function(e){if(e.handshake){t.para.events.connection.handshake_respond(t,o,e.handshake)}else{t.para.events.connection.data(t,o,e)}});i.on("close",function(e){console.log("P2P_network: DataConnection"+"("+i.peer+"/"+i.label+"/host) closed");o.close(t)})}s.prototype.send=function(e){this._connection.send(e)};s.prototype.close=function(e){if(!e.connections[this.label])return;if(e.para.events.connection.close&&e.para.events.connection.close(e,this))return;delete e.connections[this.label];var t=this;setTimeout(function(){t._connection.close();t._connection=null},1e3)};Object.defineProperty(s.prototype,"peer",{get:function(){return this._connection.peer}});Object.defineProperty(s.prototype,"label",{get:function(){return this._connection.label}});function r(){}Object.defineProperty(r.prototype,"length",{get:function(){return Object.keys(this).length}});function e(t=Object.clone(a)){this.para=t;this.id=null;var e=this._peer=new Peer;this.index=n;this.connections=new r;this.status="connecting";var i=this;e.on("open",function(e){n++;if(!o)o=i;i.id=e;i.status="connected";console.log("P2P_network: Peer-"+i.index+"("+e+") connected");i.para.events.peer.open&&i.para.events.peer.open(i)});e.on("error",function(e){console.log("P2P_network: Peer-"+i.index+" error",e);if(i.para.events.peer.error_by_connection){i.para.events.peer.error_by_connection(e);delete i.para.events.peer.error_by_connection}else i.para.events.peer.error&&i.para.events.peer.error(i,e)});e.on("connection",function(e){if(t.events.peer.connection&&t.events.peer.connection(i,e))return;console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connecting to Peer-"+i.index+"("+i.id+")");e.on("open",function(){console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connected to Peer-"+i.index+"("+i.id+")");new s(i,e)})})}e.prototype.connect=function(n,e){var a=this;return new Promise(function(i,o){var e=function(){var e={serialization:"json"};var t=a._peer.connect(n,e);t.on("open",function(){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) connecting to Peer-"+a.index+"("+a.id+")");var e=new s(a,t);a.para.events.connection.handshake_request(a,e);a.para.events.connection.handshake_request_accecpted=a.para.events.connection.handshake_request_accecpted||{};a.para.events.connection.handshake_request_rejected=a.para.events.connection.handshake_request_rejected||{};a.para.events.connection.handshake_request_accecpted[t.label]=i;a.para.events.connection.handshake_request_rejected[t.label]=o;delete a.para.events.peer.error_by_connection});t.on("error",function(e){console.log("P2P_network: Remote connection failed",e);o(e)});a.para.events.peer.error_by_connection=o};switch(a.status){case"connected":e();break;default:setTimeout(function(){o(a)},0)}})};var t={peer:e,get peer_default(){return o},status:"off",get content_window(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},process_message:function(e,t){var i=this.peer_default;if(!i)return e;var o=this.content_window.document.getElementById("Flogin").id.value;var n=this.content_window.document.getElementById("Flogin").pass.value;var a=this.content_window.MMD_SA_options;var s=(o||a&&a.model_para_obj.character&&a.model_para_obj.character.name||"Anonymous").substring(0,16);var r=i&&i.connections.length;var _;if(!/^\//.test(e)){_=i.para.events.send_message({name:s,msg:e,id:o,pass:n})}else{var l,d,c;var m=this.content_window.ChatboxAT.checkChatCommand(e);l=m.command;d=m.para1;c=m.para2;_=i.para.events.send_message({name:s,msg:e,command:l,para1:d,para2:c,id:o,pass:n})}if(!t)this.content_window.document.getElementById("Fchat").msg.value="";if(_!=null)return _;return e}};return t}(),camera:function(){var Pe;var d,r;var c;var Ie,Re;var Te;var je;var I=true;var t=new URLSearchParams(self.location.search.substring(1));var Le="";var Fe="";var i=true;var _;var E=0;var x="";function n(){var s=Pe.video;if(!s.videoWidth||s.readyState<2){return}if(c.busy||RAF_animation_frame_unlimited&&!MMD_SA.WebXR.session&&x==Pe.video_frame_id&&!Te.bb_clear){return}x=Pe.video_frame_id;E=RAF_timestamp;var n=Pe.video_canvas;var r=n.getContext("2d");if(Te.bb_clear){if(s.pause&&!s.paused||--Te.bb_clear<=0||Te._bb&&Te._bb_waiting){Te.bb_clear=Te._bb=Te._bb_waiting=null;r.globalCompositeOperation="copy"}else{if(Te._bb){r.globalCompositeOperation="source-over";r.fillStyle="black";let e=Te._bb[3];let t=Te._bb[0];let i=Te._bb[1]-e;let o=Te._bb[2]-t;e=Math.max(e-i*.25,0);t=Math.max(t-o*.25,0);i=Math.min(i*1.5,n.width);o=Math.min(o*1.5,n.height);if(Pe.video_flipped){e=n.width-(e+i)}r.fillRect(e,t,i,o);Te._bb=null;Te._bb_waiting=true}return}}var _,l;if(MMD_SA_options.user_camera.pixel_limit.disabled){_=s.videoWidth;l=s.videoHeight}else if(Pe.is_local_media){_=s.videoWidth;l=s.videoHeight;const e=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(_*l>e[0]*e[1]){const t=Math.sqrt(_*l/(e[0]*e[1]));_=Math.round(_/t);l=Math.round(l/t)}}else{_=Pe.target_width;l=Pe.target_height}var a=MMD_SA_options.user_camera.display.webcam_as_bg?{scale:1,top:0}:MMD_SA_options.user_camera.display.video;if(!a.scale){if(n.style.pixelWidth!=window.innerWidth||n.style.pixelHeight!=window.innerHeight){n.style.width=window.innerWidth+"px";n.style.height=window.innerHeight+"px"}}else{let e=a.scale*(Pe.display_floating?MMD_SA_options.user_camera.display.floating_scale||MMD_SA_options.user_camera.display.floating&&1||.5:1);let i=~~(window.innerWidth*e);let o=~~(window.innerHeight*e);if(n.style.pixelWidth!=i||n.style.pixelHeight!=o){n.style.width=i+"px";n.style.height=o+"px";let e=(window.innerWidth-i)/2;let t=(window.innerHeight-o)/2;n.style.left=e*(1+(a.left!=null?a.left:-1))+"px";n.style.top=t*(1+(a.top!=null?a.top:0))+"px"}n.style.objectFit="contain"}if(n.width!=_||n.height!=l){n.width=_;n.height=l;r.globalCompositeOperation="copy";if(Pe.video_flipped){r.translate(_,0);r.scale(-1,1)}}if(_==s.videoWidth&&l==s.videoHeight){r.drawImage(s,0,0)}else{let e=_/l;let t=s.videoWidth/s.videoHeight;let i,o,n,a;if(e<=t){n=s.videoHeight*e;i=(s.videoWidth-n)/2;a=s.videoHeight;o=0}else{n=s.videoWidth;i=0;a=s.videoWidth/e;o=(s.videoHeight-a)/2}r.drawImage(s,i,o,n,a,0,0,_,l)}n.style.visibility=!Pe.visible||c.enabled||d.initialized&&d.worker_initialized&&!d.dets||Pe.hidden_enforced?"hidden":"inherit"}function a(){if(c.enabled){c.update_frame()}else{if(Ie.enabled){Ie.update_frame(true)}else if(d.enabled){d.update_frame(true)}if(Te.enabled||je.enabled){W(true)}}const i=Pe.video_canvas_facemesh.style;const e=Pe.video_canvas.style;const t=MMD_SA_options.user_camera.display.wireframe.align_with_video?1:MMD_SA_options.user_camera.display.wireframe.scale||(is_mobile?.25:1);const o=~~(e.pixelWidth*t);const n=~~(e.pixelHeight*t);if(i.pixelWidth!=o||i.pixelHeight!=n){i.pixelWidth=o;i.pixelHeight=n;if(MMD_SA_options.user_camera.display.wireframe.align_with_video){i.posLeft=e.posLeft;i.posTop=e.posTop}else{let e=(window.innerWidth-o)/2;let t=(window.innerHeight-n)/2;i.left=e*(1+(MMD_SA_options.user_camera.display.wireframe.left!=null?MMD_SA_options.user_camera.display.wireframe.left:1))+"px";i.top=t*(1+(MMD_SA_options.user_camera.display.wireframe.top!=null?MMD_SA_options.user_camera.display.wireframe.top:-1))+"px"}}i.objectFit=e.objectFit;i.visibility=Pe.ML_enabled&&!MMD_SA_options.user_camera.display.wireframe.hidden&&!MMD_SA_options.user_camera.display.webcam_as_bg?"inherit":"hidden"}var P;function s(){if(Pe.initialized){SL.style.transform=SL_2D_front.style.transform=Pe.mirror_3D?"scaleX(-1)":"none";Pe.video_canvas.style.transform=Pe.display_flipped?"scaleX(-1)":"none";Pe.reset_video_canvas()}if(!P&&Pe.initialized){P=true;System._browser.on_animation_update.add(n,0,0,-1);System._browser.on_animation_update.add(a,2,1,-1)}}function l(){SL.style.transform=SL_2D_front.style.transform=Pe.mirror_3D?"scaleX(-1)":"none";Pe.video_canvas.style.transform="none";Pe.reset_video_canvas();if(Pe.visible)return;if(P&&!Pe.ML_enabled){P=false;System._browser.on_animation_update.remove(n,0);System._browser.on_animation_update.remove(a,1);Pe.video_canvas_facemesh.style.visibility="hidden"}}var o=100;function m(e){if(!Pe.visible)return;var t=e.detail.keyCode;if(t==107)o+=10;else if(t==109)o-=10;else return;o=Math.max(Math.min(o,180),20);var i=Pe.video_canvas.getContext("2d");if(o==1){i.filter="none";DEBUG_show("Brightness:100%",2)}else{i.filter="brightness("+o+"%) contrast("+(100+(o-100)*.25)+"%)";DEBUG_show("Brightness:"+o+"%",2)}e.detail.result.return_value=true}var u=0;function p(e){if(!e)e=Pe.local_src||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.Gadget.path+"/js/headtrackr.mp4");if(/\.(png|jpg|jpeg|bmp|webp)$/i.test(e)){if(!Pe._image){Pe._image=new Image;Object.defineProperty(Pe._image,"videoWidth",{get:function(){return this.width}});Object.defineProperty(Pe._image,"videoHeight",{get:function(){return this.height}});Object.defineProperty(Pe._image,"readyState",{get:function(){return this.complete?4:0}})}if(Pe.video&&Pe.video.pause)Pe.video.pause();Pe.video=Pe._image;Pe._image.src=toFileProtocol(e)}else{Pe.video=Pe._video;Pe.video.loop=true;if(!Pe.video._initialized){Pe.video._initialized=true;Pe.video.addEventListener("canplaythrough",function(e){Pe.media_control_enabled=true;SL_MC_simple_mode=true;SL_MC_video_obj=Pe.video;SL_MC_Place(1,0,-64);var t=Ze.speed;if(t){Pe.video.playbackRate=t;if(t<1)Pe.video.muted=true}else{Pe.video.playbackRate=1}});Pe.video.addEventListener("timeupdate",function(e){SL_MC_Timeupdate(this)},true);Pe.video.addEventListener("ended",function(e){if(Ze.speed)Ze.stop()})}Pe.video.src=toFileProtocol(e)}Pe.video_id=e;Pe.local_src=e}window.addEventListener("MMDStarted",()=>{function e(e){if(!System._browser.camera.poseNet.enabled)return;const t=MMD_SA.MMD.motionManager.para_SA;if(!t.motion_tracking_upper_body_only||!t.motion_tracking?.arm_as_leg)return;window.addEventListener("SA_camera_poseNet_update",()=>{t.motion_tracking.arm_as_leg.enabled=!t.motion_tracking.arm_as_leg.enabled;Ye.reset_to_default_motion_once=true;DEBUG_show("Arm-as-leg control:"+(t.motion_tracking.arm_as_leg.enabled?"ON":"OFF"),3)},{once:true})}const t={id:"arm_to_leg_control_mode",accelerator:["Alt+Q"],process:e};if(System._browser.hotkeys._hotkey_config){System._browser.hotkeys._hotkey_config.push(t)}else{System._browser.hotkeys.add(t)}});var h=false;function R(){var e=Ie.enabled||Te.enabled;if(h==!!e)return;h=!!e;if(e){s();Ye.reset();Ye.add_events();DEBUG_show("(Camera ML Mode:ON)",2)}else{if(Pe.initialized){Pe.video_canvas_face_detection.style.visibility="hidden";Pe.video_canvas_facemesh.style.visibility="hidden";l()}Ye.remove_events();Pe._info="";DEBUG_show("(Camera ML Mode:OFF)",2)}}var A,D,$e;var ze,Ce,Be,Je;var He,Oe,S,M,g,y;var qe,Ue;var k,T;var j;var et;var tt={};var Ke=["親","人","中","薬","小"];var it=["thumb","index","middle","ring","pinky"];var Ge=["０","１","２","３"];window.addEventListener("jThree_ready",()=>{ze=new THREE.Vector3;Ce=new THREE.Vector3;Be=new THREE.Vector3;Je=new THREE.Vector3;j=new THREE.Vector3;He=new THREE.Quaternion;Oe=new THREE.Quaternion;S=new THREE.Quaternion;M=new THREE.Quaternion;g=new THREE.Quaternion;y=new THREE.Quaternion;qe=new THREE.Matrix4;Ue=new THREE.Quaternion;k=new THREE.Vector2;T=new THREE.Vector2;et=new THREE.Quaternion;["左","右"].forEach(e=>{tt[e]=new System._browser.data_filter([{type:"one_euro",id:"shoulder_rot",para:[30,1,5,1,1]}])})});var e;var L;var F;var ot=true;var nt=true;var at;var C=true;var B,st,H;var Xe=false;var rt=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"];var _t=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28];var lt=[];rt.forEach(e=>{lt.push({part:e,score:0})});var We,Qe;var O;function q(){if(O)return;O=true;const r=THREE.MMD.getModels()[0];const o=r.mesh.bones_by_name;const e=o["左腕"].pmxBone.origin;const t=o["左ひじ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_z_rot=Math.PI/2+Math.atan2(t[1]-e[1],t[0]-e[0]);const i=o["左腕ＩＫ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_to_IK_xy=[e[0]-i[0],e[1]-i[1],e[2]-i[2]];MMD_SA_options.model_para_obj.left_arm_length=MMD_SA.TEMP_v3.fromArray(MMD_SA_options.model_para_obj.left_arm_to_IK_xy).length();MMD_SA_options.model_para_obj.arm_IK_offset={"左":(new THREE.Vector3).fromArray(o["左腕"].pmxBone.origin).sub(Ce.fromArray(o["左腕ＩＫ"].parent.pmxBone.origin)),"右":(new THREE.Vector3).fromArray(o["右腕"].pmxBone.origin).sub(Ce.fromArray(o["右腕ＩＫ"].parent.pmxBone.origin))};let n=o["右腕"].pmxBone.origin;MMD_SA_options.model_para_obj.shoulder_width=Math.abs(e[0]-n[0]);MMD_SA_options.model_para_obj.arm_axis={"左":(new THREE.Vector3).fromArray(i).sub(MMD_SA.TEMP_v3.fromArray(e)).normalize()};MMD_SA_options.model_para_obj.arm_axis["右"]=MMD_SA_options.model_para_obj.arm_axis["左"].clone().setX(-MMD_SA_options.model_para_obj.arm_axis["左"].x);const a=o["左足"].pmxBone.origin;const s=o["左足首"].pmxBone.origin;MMD_SA_options.model_para_obj.hip_center=(new THREE.Vector3).fromArray(a).setX(0);MMD_SA_options.model_para_obj.spine_length=o["首"].pmxBone.origin[1]-MMD_SA_options.model_para_obj.hip_center.y;MMD_SA_options.model_para_obj.left_heel_height=s[1];MMD_SA_options.model_para_obj.leg_IK_offset={"左":(new THREE.Vector3).fromArray(o["左足"].pmxBone.origin).sub(Ce.fromArray(o["左足ＩＫ"].parent?.pmxBone?.origin||[0,0,0]).setY(0)),"右":(new THREE.Vector3).fromArray(o["右足"].pmxBone.origin).sub(Ce.fromArray(o["右足ＩＫ"].parent?.pmxBone?.origin||[0,0,0]).setY(0))};MMD_SA_options.model_para_obj.left_leg_upper_length=a[1]-o["左ひざ"].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_lower_length=o["左ひざ"].pmxBone.origin[1]-s[1];MMD_SA_options.model_para_obj.left_leg_length=MMD_SA_options.model_para_obj.left_leg_upper_length+MMD_SA_options.model_para_obj.left_leg_lower_length;MMD_SA_options.model_para_obj.left_leg_IK=[a[0]-s[0],a[1]-s[1],a[2]-s[2]];let _=["左","右"];We={};_.forEach(n=>{["腕","ひじ"].forEach((e,t)=>{let i=n+e;let o=MMD_SA.get_bone_axis_rotation(r.mesh,i);We[i]={name:i,axis_rot:o,parent:t==0?{axis_rot:new THREE.Quaternion}:We[n+"腕"]};We[i].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(We[i].parent.axis_rot,MMD_SA.TEMP_q.copy(We[i].axis_rot).conjugate())})});const l={};l[1]=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*1,Math.PI/2*1),"YZX");l[-1]=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*-1,Math.PI/2*-1),"YZX");Qe={};Qe[1]=(new THREE.Quaternion).multiplyQuaternions(l[1],MMD_SA._q1.copy(We["左腕"].axis_rot).conjugate());Qe[-1]=(new THREE.Quaternion).multiplyQuaternions(l[-1],MMD_SA._q1.copy(We["右腕"].axis_rot).conjugate());MMD_SA_options.model_para_obj.rot_hand_adjust_base=l;MMD_SA_options.model_para_obj.rot_hand_adjust=Qe;MMD_SA_options.model_para_obj.finger_base={};_.forEach(s=>{Ke.forEach((e,t)=>{let n=s+e+"指";let i=t==0&&o[n+Ge[0]]?0:1;if(!o[n+Ge[i+0]])return;let a=MMD_SA_options.model_para_obj.finger_base[s+t]={base_index:i};for(let i=a.base_index+(t==0?0:-1),o=i;o<3;o++){let e=n+Ge[a.base_index+(o-i)];let t=MMD_SA.get_bone_axis_rotation(r.mesh,e,true);We[e]={name:e,axis_rot:t,parent:o==i?We[s+"ひじ"]:We[n+Ge[a.base_index+(o-1-i)]]};We[e].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(We[e].parent.axis_rot,MMD_SA.TEMP_q.copy(We[e].axis_rot).conjugate())}})});for(const d in We){if(d.indexOf("指")!=-1){MMD_SA.TEMP_v3.setEulerFromQuaternion(We[d].axis_rot,"ZYX");MMD_SA.TEMP_v3.z*=-1;We[d].axis_rot.setFromEuler(MMD_SA.TEMP_v3,"ZYX")}We[d].axis_rot_inv=We[d].axis_rot.clone().conjugate()}for(const d in We){if(d.indexOf("指")!=-1){We[d]._axis_rot_offset_inv_z=MMD_SA.TEMP_v3.setEulerFromQuaternion(MMD_SA.TEMP_q.copy(We[d].axis_rot_offset_inv).premultiply(We[d].parent.axis_rot_inv).multiply(We[d].parent.axis_rot),"ZYX").z}}MMD_SA_options.model_para_obj.rot_arm_adjust=We;console.log(We)}const b={};let v;let w;let U;class K{constructor(e,t){this.id=e;this.worker=t}initialized=false}async function G(){if(A)return;A=true;q();var t=[];if(is_mobile){t.push("use_mobilenet=1")}if(C){t.push("use_holistic=1");e=L=false;nt=at=true}if(e){t.push("use_human=1");B=true;e=true;L=false;F=false;st=true;H=true}else if(L){t.push("use_mixed_human=1");e=true;L=true;F=true;H=true}else{e=false;L=false;F=true}if(nt){t.push("use_blazepose=1");at=true}if(at){t.push("use_mediapipe=1");if(e){st=true;H=false}ot=true}if(ot){t.push("use_movenet=1")}if(MMD_SA_options.user_camera.ML_models.worker_disabled&&Ie.initialized&&!Ie.worker_initialized){await new Promise(function(e,t){var i=setInterval(()=>{if(Ie.worker_initialized){clearInterval(i);e()}},100)})}else{await Ie.init()}if(MMD_SA_options.user_camera.ML_models.worker_disabled){v={postMessage:function(e,t){PoseAT.onmessage({data:e})}};let e=document.createElement("script");e.onload=function(){PoseAT.init(v,t)};e.src="js/pose_lib.js";document.head.appendChild(e)}else{U="js/pose_worker.js"+(t.length?"?"+t.join("&"):"");w=Te.use_holistic?"legacy_holistic":"tasks_vision";console.log("Web worker ID:"+w);v=new Worker(U);b[w]=new K(w,v)}v.onmessage=xe}var dt=function(){let y,b;window.addEventListener("jThree_ready",()=>{y=new System._browser.data_filter([{type:"one_euro",id:"head_rot",para:[30,1,2,1,4]}]);b=new System._browser.data_filter([{type:"one_euro",id:"head_chest_rot",para:[30,.25,.5,1,3]}])});return function(e,t){const i=e.bones_by_name[t];const o=this.skin[t];let n=Math.max(Math.min(o[0].t_delta/o[0].t_delta_frame,1),0);const a=MMD_SA.TEMP_q.set(0,0,0,1);var s=o[0].no_blending?MMD_SA._q2.copy(o[0].rot):MMD_SA._q2.copy(o[1].rot).slerp(o[0].rot,n);if(!i){o[0]._rot_from_pose.copy(s);return}const r=MMD_SA.MMD.motionManager.para_SA;const _=Te.enabled||r.motion_tracking_upper_body_only;var l=o[0].rot_parent;if(!l){const p=_&&r.motion_tracking?.head_rotation_weight||0;if(p==1){l=new THREE.Quaternion}else{l=MMD_SA.get_bone_rotation_parent(e,t,e).conjugate();if(_)l.premultiply(Oe.copy(this._rot_body_offset).multiply(this._rot_body_camera));if(p)l.slerp(a,p)}}o[0]._rot_parent=l;if(o[0].info[1]=="facemesh"&&this.skin[t+"_DUMMY_"]){let e=Math.min(Math.max(.25-o[0]._rot_ratio,0)*5,1);s.slerp(this.skin[t+"_DUMMY_"][0]._rot_from_pose,e*e*.667);o[0]._rot_mixed=s.clone()}var d=s.toAxisAngle()[1]%(Math.PI*2);if(d>Math.PI)d=Math.PI*2-d;else if(d<0&&d<-Math.PI)d+=Math.PI*2;d=Math.abs(d);n=Te.use_3D_pose?.5:.3+Math.max(d-Math.PI/2,0)/(Math.PI/2)*.2;var c=He.multiplyQuaternions(l,s);c.fromArray(y.filter(c.toArray()));var m=ze.setEulerFromQuaternion(c,"YZX");var u=[m.x<0?n+(.5-n)*.5:n,n,n];c.setFromEuler(Ce.fromArray(m.toArray().map((e,t)=>Math.sign(e)*Math.min(Math.abs(e),Math.PI/2)*u[t])),"YZX");if(_){const h=r.motion_tracking;const f=1-(h?.motion_default_weight?.head||0)*this.camera_weight;if(f){const M=Oe.copy(i.quaternion).premultiply(S.copy(this._body_motion_rot[0]["首"]).conjugate());i.quaternion.slerp(M,f);M.copy(e.bones_by_name["頭"].quaternion).premultiply(S.copy(this._body_motion_rot[0]["頭"]).conjugate());e.bones_by_name["頭"].quaternion.slerp(M,f)}}i.quaternion.multiply(c);e.bones_by_name["頭"].quaternion.premultiply(c);o[0]._rot_neck=i.quaternion.clone();o[0]._rot_head=e.bones_by_name["頭"].quaternion.clone();if(Ze.active){Ze.set_boneKey(t,null,i.quaternion,true);Ze.set_boneKey("頭",null,e.bones_by_name["頭"].quaternion,false)}if(n<.5){const i=e.bones_by_name["上半身2"];const g=He.setFromEuler(ze.fromArray(b.filter(ze.setEulerFromQuaternion(s,"YZX").multiply(Ce.fromArray(u.map(e=>1-e*2))).toArray())),"YZX");if(!Te.enabled){Ye.add("skin","上半身2",{no_blending:true,rot:g.clone()})}else{i.quaternion.multiply(g)}}}}();var ct=1*10;var Ve=function(){var M=[];var o;var A,D;window.addEventListener("jThree_ready",()=>{o=new System._browser.data_filter([{type:"one_euro",id:"camera_depth",para:[30,1,1/5,1,1]}]);Ve.v_hip=A=new THREE.Vector3;D=new System._browser.data_filter([{type:"one_euro",id:"v_hip",para:[30,1,1/2,1,3]}])});function e(e){var r=e.keypoints[5];var _=e.keypoints[6];var l=e.keypoints[11];var d=e.keypoints[12];if(r.score<=0||_.score<=0)return;let c,m;if(e.keypoints3D_raw){c=e.keypoints3D_raw[11];m=e.keypoints3D_raw[12]}else{c=e.keypoints3D[5];m=e.keypoints3D[6]}M=[{point2D:[{position:new THREE.Vector3},{position:new THREE.Vector3}],data3D:{length:0,z_diff:0}}];const u=Te.spine_length_ref;let p=1;if(l.score>0&&d.score>0){let e=MMD_SA._v3a.addVectors(c,m).multiplyScalar(.5);let t=e.length();let i=MMD_SA.TEMP_v3.set(0,1,0);i.y*=-1;let o=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZXY").x;p=Math.abs(o)/(Math.PI/2);p=p<=1?Math.max(p-.5,0)/.5:Math.max(2-p,0);let n=k.copy(l.position).add(d.position).multiplyScalar(.5);let a=T.copy(r.position).add(_.position).multiplyScalar(.5);let s=n.distanceTo(a);a.copy(n);a.y=a.y-s/Math.abs(Math.cos(o));M[0].point2D[0].position.copy(a);M[0].point2D[1].position.copy(n);M[0].data3D.length=u*(t*2)}if(p){let e=MMD_SA._v3b.copy(c).sub(m);let t=e.length();let i=MMD_SA.TEMP_v3.set(1,0,0);let o=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZYX").y;let n=T.copy(r.position).add(_.position).multiplyScalar(.5);let a=n.clone();let s=k.copy(r.position).distanceTo(_.position);n.y=n.y+s*1.5/Math.abs(Math.cos(o));if(n.y>Pe.video_canvas.height){a.y=Math.max(a.y-(n.y-Pe.video_canvas.height),0);n.y=Pe.video_canvas.height}if(M[0].data3D.length!=0){let e=Math.abs(o)/(Math.PI/2);e=e<=1?Math.max(e-.5,0)/.5:Math.max(2-e,0);p*=1-e}M[0].point2D[0].position.lerp(a,p);M[0].point2D[1].position.lerp(n,p);M[0].data3D.length=M[0].data3D.length*(1-p)+u*(t*3)*p}}function t(){if(!M.length)return;var d=System._browser.camera;var c=d.video_canvas.width;var m=d.video_canvas.height;var u=ze;var p=[];const e=c/m;const t=SL.width/SL.height;const h=e<t?e/t:1;const f=t<e?t/e:1;M.forEach(e=>{u.set((e.point2D[0].position.x/c*2-1)*h,(-(e.point2D[0].position.y/m)*2+1)*f,.5);var t=MMD_SA._v3a.copy(u.unproject(d._camera_reset).sub(d._camera_reset.position).normalize());u.set((e.point2D[1].position.x/c*2-1)*h,(-(e.point2D[1].position.y/m)*2+1)*f,.5);var i=MMD_SA._v3b.copy(u.unproject(d._camera_reset).sub(d._camera_reset.position).normalize());var o,n;o=e.data3D.length;n=e.data3D.z_diff;let a=Math.sqrt(Math.pow(t.x-i.x*t.z/i.z,2)+Math.pow(t.y-i.y*t.z/i.z,2)+0);let s=t.x-i.x*t.z/i.z+(t.y-i.y*t.z/i.z)+0;let r=s/a;let _=1;let l=(Math.sqrt(o*o+1)-1)/(a/r);t.multiplyScalar(l);p.push({z:-t.z*1.5,id:e.id})});p.sort((e,t)=>t.z-e.z);var i=p[0].z;this.z=i;z=o.filter(i);this.z_smoothed=z;M=[]}function i(e){if(MMD_SA.WebXR.session){A.set(0,0,0);return}const t=Pe.video_canvas.width;const i=Pe.video_canvas.height;const o=e.keypoints[11];const n=e.keypoints[12];const a=e.keypoints[5];const s=e.keypoints[6];const r=a.score>0&&s.score>0?k.copy(a.position).add(s.position).multiplyScalar(.5):null;const _=t/i;const l=SL.width/SL.height;const d=_<l?_/l:1;const c=l<_?l/_:1;let m;let u=0;if(o.score>0&&n.score>0){m=T.copy(o.position).add(n.position).multiplyScalar(.5);const b=m.x;const v=m.y;u=1;if(r){if(v<0||v>i){u=1-Math.min((v<0?-v:v-i)/Math.abs(r.y-v),1)}if(b<0||b>t){u=Math.min(u,1-Math.min((b<0?-b:b-t)/Math.abs(r.x-b),1))}u=Math.max(u-.5,0)/.5}A.set(((o.position.x+n.position.x)/2/t*2-1)*d,(-((o.position.y+n.position.y)/2/i)*2+1)*c,.5).unproject(Pe._camera_reset).sub(Pe._camera_reset.position).normalize()}let p;if(u<1){p=Be.set(((a.position.x+s.position.x)/2/t*2-1)*d,(-((a.position.y+s.position.y)/2/i)*2+1)*c,.5).unproject(Pe._camera_reset).sub(Pe._camera_reset.position).normalize()}if(ct)Ve.estimate();const h=Pe._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;let f=h;if(ct&&Ve.z)f=Ve.z_smoothed||Ve.z;if(u>0)A.multiplyScalar(-f/A.z);if(p){const w=Te.spine_length_ref;const S=MMD_SA.TEMP_v3.set(0,-w,0);A.lerp(p.multiplyScalar(-f/p.z).add(S),1-u)}const M=D.filters[0].filter;const g=Math.max(Math.abs(A.z)-10,0)/10;const y=.2+g*.8;M.minCutOff=Math.min(y,10);M.beta=Math.min(y,1);A.fromArray(D.filter(A.toArray()))}return{prepare:e,estimate:t,get_hip_center:i}}();var X=(()=>{function P(e,t,i,o,n){function a(e){return e*e}const s=Math.sqrt;var r=1+a(o);var _=-t*2+o*(n-i)*2;var l=a(t)+a(n-i)-a(e);var d=a(_)-4*r*l;if(d>=0){var c=[(-_+s(a(_)-4*r*l))/(2*r),(-_-s(a(_)-4*r*l))/(2*r)];if(d==0){return[c[0]]}return c}return[]}var I,R,T;var j;window.addEventListener("jThree_ready",()=>{I=new THREE.Vector3;R=new THREE.Vector3;T=new THREE.Vector3;j=new THREE.Quaternion});return function(e,t,i){const o=e._elbow_y;const n=MMD_SA.get_bone_position(t,i+"ひじ",t);if(n.y>o)return;const a=MMD_SA.get_bone_position(t,i+"手首",t);const s=MMD_SA.get_bone_position(t,i+"腕",t);const r=s;const _=T.copy(a).sub(r);const l=n;const d=(l.x*_.x+l.y*_.y+l.z*_.z-(r.x*_.x+r.y*_.y+r.z*_.z))/_.lengthSq();const c=MMD_SA._v3b.set(r.x+_.x*d,r.y+_.y*d,r.z+_.z*d);const m=_.normalize();const u=R.copy(n).sub(c).normalize().negate();const p=I.crossVectors(m,u).normalize();const h=(new THREE.Plane).setFromNormalAndCoplanarPoint(m,n);const f=(new THREE.Plane).setFromNormalAndCoplanarPoint(MMD_SA.TEMP_v3.set(0,1,0),MMD_SA._v3a.set(0,o,0));const M=h.intersectPlane(f);if(!M)return;qe.set(m.x,m.y,m.z,0,u.x,u.y,u.z,0,p.x,p.y,p.z,0,0,0,0,1);Ue.setFromBasis(qe);const g=MMD_SA.TEMP_v3.copy(n).sub(c).length();let y=f.intersectLine(new THREE.Line3(n,c),T);if(!y)return;y=-y.sub(n).length();M[1].applyQuaternion(Ue);const b=M[1].y/M[1].z;n.sub(s);n.applyQuaternion(Ue);const v=P(g,n.z,n.y,b,y);if(!v.length)return;const w=v.map(e=>{e-=n.z;return Math.asin(e/g)});const S=i=="左"?1:-1;const A=MMD_SA.get_bone_rotation(t,"上半身2",null,t);const D=j.copy(A).conjugate();const k=R.copy(a).sub(s).normalize().applyQuaternion(D);const E=e.use_smallest_angle?w.sort((e,t)=>Math.abs(e)-Math.abs(t))[0]:w[S==-1?w.length-1:0];const x=MMD_SA.TEMP_q.setFromAxisAngle(k,E);t.bones_by_name[i+"腕"].quaternion.premultiply(x)}})();const Ne=[0,0,0];var xe=function(){function se(e,t){let i=We[t];e.premultiply(i.axis_rot).multiply(i.axis_rot_inv);e.multiplyQuaternions(i.axis_rot_offset_inv,e)}function re(e,t){if(Te.IK_disabled_check(t))return;var i=e.bones_by_name[t];var o=this.skin[t];var n=t.charAt(0);var a=MMD_SA.TEMP_v3.fromArray(e.bones_by_name[n+"足"].pmxBone.origin);var s=MMD_SA.get_bone_position(e,n+"足","全ての親").sub(a);i.position.add(s);e.bones_by_name[n+"ひざ"].quaternion.set(0,0,0,1);if(Ze.active){if(MMD_SA_options.user_camera.ML_models.pose.use_legIK){const r=MMD_SA.TEMP_v3.copy(i.position);r.sub(ze.fromArray(e.bones_by_name[t].pmxBone.origin).sub(Ce.fromArray(e.bones_by_name[t].parent?.pmxBone?.origin||[0,0,0])));Ze.set_boneKey(t,r,o[0].rot?i.quaternion:null,true)}window.addEventListener("SA_MMD_model"+e._model_index+"_process_bones_after_IK",()=>{Ze.set_boneKey(n+"足",null,e.bones_by_name[n+"足"].quaternion,false);Ze.set_boneKey(n+"ひざ",null,e.bones_by_name[n+"ひざ"].quaternion,false)},{once:true})}i.quaternion.set(0,0,0,1)}function _e(e,t){const i=t.charAt(0);const o=e.bones_by_name;const n=o[t].quaternion;if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only){n.multiplyQuaternions(et,n)}le.call(this,e,t)}function le(e,t){const i=t.charAt(0);const o=e.bones_by_name;const n=o[t].quaternion;const a=this.skin[i+"肩"];if(a){let e=Math.max(Math.min(a[0].t_delta/a[0].t_delta_frame,1),0);n.premultiply(MMD_SA.TEMP_q.copy(a[1].rot).slerp(a[0].rot,e).conjugate())}}var de=(()=>{var e;window.addEventListener("jThree_ready",()=>{});return function(n,e){var t=n.bones_by_name[e];var i=this.skin[e];var o=Math.max(Math.min(i[0].t_delta/i[0].t_delta_frame,1),0);const a=ze.copy(Ve.v_hip);if(MMD_SA.WebXR.session){a.set(0,0,0)}else{const c=Pe._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;a.z=MMD_SA_options.user_camera.ML_models.pose.estimate_z_depth===false?0:c+a.z}if(MMD_SA_options.user_camera.ML_models.pose.position_offset)a.add(MMD_SA_options.user_camera.ML_models.pose.position_offset);i[0].pos.copy(a);var s=(new THREE.Vector3).copy(i[1].pos).lerp(i[0].pos,o);var r=MMD_SA.get_bone_position(n,"左足","全ての親");var _=MMD_SA.get_bone_position(n,"右足","全ての親");var l=MMD_SA.TEMP_v3.copy(r).add(_).multiplyScalar(.5).sub(MMD_SA_options.model_para_obj.hip_center).negate();if(Te.auto_grounding){let e=MMD_SA.get_bone_position(n,"左足首","全ての親");let t=MMD_SA.get_bone_position(n,"右足首","全ての親");let i=e.y<t.y?e:t;let o=MMD_SA_options.model_para_obj.left_heel_height+.2-i.y;o-=s.y;l.y=o}s.add(l);s.x*=Pe.x_flipped?-1:1;if(i[0].absolute)t.position.set(0,0,0);t.position.add(s);Ze.active&&Ze.set_boneKey(e,s,null,true);var d=j.distanceTo(s)-5;if(d>0){THREE.MMD.getModels()[n._model_index].resetPhysics(15+d*2)}j.copy(s)}})();function q(y,b,i,e){function t(e,t,i){if(typeof e=="number")return e;if(/^(\w+)([\+\-])([\d\.])$/.test(e)){const o=(RegExp.$2=="+"?1:-1)*parseFloat(RegExp.$3);const n=MMD_SA.TEMP_v3.copy(b);const a=RegExp.$1;if(a=="default"){n.copy(Ye._skin[y].pos).sub(y.indexOf("腕")!=-1?MMD_SA_options.model_para_obj.arm_IK_offset[v]:MMD_SA_options.model_para_obj.leg_IK_offset[v]).applyQuaternion(Ye._skin[y].rot_parent_inv)}else if(a=="elbow"){if(t=="y"){const s=r?.motion_tracking?.arm_tracking?.elbow_lock?.[v=="左"?"left":"right"]?._elbow_y;if(s!=null&&s!=0){n.y=s-MMD_SA.get_bone_position(S,v+"腕",S).y}}}return(n[t]+o)/i}return 0}const v=y.charAt(0);const o=y.indexOf("足")==-1?MMD_SA_options.model_para_obj.left_arm_length:MMD_SA_options.model_para_obj.left_leg_length;const w=v=="左"?"left":"right";const n=THREE.MMD.getModels()[0];const S=n.mesh;const r=MMD_SA.motion[n.skin._motion_index].para_SA;let a;if(i){for(const c of["x","y","z"]){const m=i[c];if(!m)continue;const _=m.unit_length||o;if(m.scale!=null)b[c]*=typeof m.scale?.[w]=="number"&&m.scale[w]||m.scale;if(m.add)b[c]+=t(m.add?.[w]||m.add,c,_)*_;if(m.min!=null)b[c]=Math.max(b[c],t(m.min?.[w]||m.min,c,_)*_);if(m.max!=null)b[c]=Math.min(b[c],t(m.max?.[w]||m.max,c,_)*_)}if(i.rotation)b.applyEuler(MMD_SA.TEMP_v3.copy(i.rotation).multiplyScalar(Math.PI/180));if(i.camera_weight&&y.indexOf("腕")==-1)b.applyQuaternion(MMD_SA.TEMP_q.set(0,0,0,1).slerp(Ye._rot_camera,i.camera_weight));const d=i.position_to_rotation;if(d){const u=S.bones_by_name;const p=Be.set(Math.atan2(b.z,b.y),0,-Math.atan2(b.x,b.z));const h={upper:{q:He},lower:{q:Oe}};for(const E of["upper","lower"]){const x=v+(E=="upper"?"足":"ひざ");const P=u[x];h[E].name=x;h[E].q.copy(P.quaternion);P.quaternion.set(0,0,0,1);if(!d[E])continue;const I=Je.set(0,0,0);for(const c of["x","y","z"]){const m=d[E][c];if(!m)continue;let e=0;const R=m.rot_formula?.[w]||m.rot_formula;if(R?.length==1){e=p[R]*180/Math.PI}if(m.add)e+=m.add?.[w]||m.add;if(m.scale!=null)e*=typeof m.scale?.[w]=="number"&&m.scale[w]||m.scale;if(m.curve){const T=m.curve?.[w]||m.curve;const j=(e-T.ini)/(T.end-T.ini);if(j>0&&j<1)e=Math.pow(j,T.pow_factor)*(T.end-T.ini)+T.ini}if(m.min!=null)e=Math.max(e,m.min?.[w]||m.min);if(m.max!=null)e=Math.min(e,m.max?.[w]||m.max);I[c]=e/180*Math.PI}P.quaternion.setFromEuler(I,"XZY");if(E=="upper")a=P.quaternion.clone()}const f=MMD_SA.get_bone_position(S,v+"足","全ての親");const M=MMD_SA.get_bone_position(S,v+"足首","全ての親");const g=Pe.x_flipped?-1:1;const A=Be.fromArray(u[v+"足"].pmxBone.origin);const D=A.sub(f).negate();const k=f.sub(M);k.x*=g;k.y*=-1;k.z*=-1;k.add(MMD_SA_options.model_para_obj.leg_IK_offset[v]);k.add(D);k.y-=MMD_SA_options.model_para_obj.left_leg_IK[1]+(u["センター"].position.y-u["センター"].pmxBone.origin[1]);b.copy(k);for(const E in h)u[h[E].name].quaternion.copy(h[E].q)}}else{if(e)e(b)}i?.magnet?.forEach(t=>{const e=t.hand_affected[w];if(!e)return;if(!Ye.skin[y]?.[0]._hand_visible)return;const i=MMD_SA.THREEX.get_model(0);let o=MMD_SA._v3a.set(0,0,0);let n;let a=MMD_SA._q1.set(0,0,0,1);let s;if(t.type=="object3D"){const m=MMD_SA.THREEX._XR_Animator_scene_?.object3D_list.find(e=>e.id==t.id);if(!m)return;s=MMD_SA.THREEX._object3d_list_.find(e=>e.uuid==m._object3d_uuid);o.copy(t.reference_point).multiply(s._mesh.scale);a=MMD_SA._q1.copy(S.quaternion).conjugate().multiply(t.use_default_rotation&&s.user_data._rot_default_||s._mesh.quaternion);o.applyQuaternion(a);n=MMD_SA._v3b.copy(s._mesh.position).sub(S.position).applyQuaternion(MMD_SA.TEMP_q.copy(S.quaternion).conjugate());o.add(n)}else if(t.type=="bone"){const u=MMD_SA.THREEX.VRM.bone_map_VRM_to_MMD[t.name];o=i.get_bone_position_by_MMD_name(u,true);if(t.offset){a=i.get_bone_rotation_by_MMD_name(u,true);o.add(MMD_SA._v3a.copy(t.offset).applyQuaternion(a))}}else{o.copy(t.position)}const r=i.get_bone_position_by_MMD_name(y.substring(0,2),true);o.sub(r);let _=1;if(MMD_SA.THREEX.enabled){_=MMD_SA_options.model_para_obj.left_arm_length/i.para.left_arm_length;o.multiplyScalar(_)}let l=MMD_SA._v3a_.set(0,0,0);if(e.offset){if(e.offset=="parent_bone"){pb=MMD_SA.THREEX._object3d_list_.find(e=>e.parent_bone?.name==v+"手首"&&!e.parent_bone.disabled)?.parent_bone;if(pb)l.set(pb.position.x,pb.position.y,-pb.position.z)}else{l.copy(e.offset);if(!i.is_T_pose)l.applyQuaternion(MMD_SA_options.model_para_obj.rot_arm_adjust[v+"腕"].axis_rot)}l.applyQuaternion(i.get_bone_rotation_by_MMD_name(v+"手首",true))}b.add(l);let d=0;let c;if(t.magnet_type=="line"){const p=MMD_SA.THREEX.l1;p.start.copy(o);if(t.line_end){p.end.copy(t.line_end).multiply(s._mesh.scale).applyQuaternion(a);p.end.add(n)}else{p.end.copy(n||MMD_SA.TEMP_v3.set(0,0,0))}p.end.sub(r).multiplyScalar(_);if(t.line_offset){const h=MMD_SA.TEMP_v3.copy(t.line_offset).multiply(s._mesh.scale).applyQuaternion(a).multiplyScalar(_);p.start.add(h);p.end.add(h)}p.closestPointToPoint(b,true,o);let e=b.distanceTo(o);if(e<t.effective_distance){c=t.peak_distance||0;d=1-Math.abs(e-c)/(t.effective_distance-c);if(t.power)d=Math.pow(d,1-t.power)}}else if(t.magnet_type=="plane"){const f=MMD_SA.THREEX.p1.setFromNormalAndCoplanarPoint(MMD_SA.TEMP_v3.copy(t.plane_normal).applyQuaternion(a),o);const p=MMD_SA.THREEX.l1;p.start.copy(b);p.end.copy(MMD_SA.TEMP_v3.copy(f.normal).multiplyScalar(999).add(b));let e=f.intersectsLine(p);if(e&&!t.plane_crossable){d=1}else{if(!e)p.end.sub(b).negate().add(b);const g=f.distanceToPoint(b);if(g<t.effective_distance){c=t.peak_distance||0;d=1-Math.abs(g-c)/(t.effective_distance-c);if(t.power)d=Math.pow(d,1-t.power)}}const M=MMD_SA.THREEX.v1;f.intersectLine(p,M);o.copy(M)}else{const g=b.distanceTo(o);if(g<t.radius){c=t.peak_radius||0;if(t.peak_barrier&&g<c){d=1}else{d=1-Math.abs(g-c)/(t.radius-c);if(t.power)d=Math.pow(d,1-t.power)}}}if(d){if(c)o.add(b.clone().sub(o).normalize().multiplyScalar(c));b.lerp(o,d)}t._frame_count_=EV_sync_update.count_frame;t._weight_=d;b.sub(l)});const s=b.length();let _=s*(typeof i?.length?.scale=="number"?i?.length?.scale:i?.length?.scale?.[w]||1);for(const L of["max","min"]){const F="length_"+L;let e,t=o;if(i?.[F]||i?.length){if(typeof i[F]=="number"){e=i[F]}else{e=i.length[L];if(e==null)continue;if(typeof e!="number"){e=e[w];if(e==null)continue}if(i.length.unit_length)t=i.length.unit_length}}else{continue}if(L=="max"){if(_>t*e)_=t*e}else{if(_<t*e)_=t*e}}if(_!=s)b.normalize().multiplyScalar(_);const l=[b];if(a)l.push(a);return l}var U=(()=>{var S;window.addEventListener("jThree_ready",()=>{S=new System._browser.data_filter([{type:"one_euro",id:"armIK",para:[30,1,1/5,1,3]}])});return function(i,e){if(Te.IK_disabled_check(e))return;var t=i.bones_by_name[e];var o=this.skin[e];var n=Math.max(Math.min(o[0].t_delta/o[0].t_delta_frame,1),0);var a=e.charAt(0);var s=ze.copy(o[1].pos).lerp(o[0].pos,n);const r=MMD_SA.MMD.motionManager.para_SA;const _=a=="左"?"left":"right";const l=r?.motion_tracking?.arm_tracking?.transformation;if(l){const h=l.position;q(a+"腕ＩＫ",s,h);let t=l.root_rotation?.[_];if(t){const f=a+"腕";const M=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(t.x,t.y,t.z).multiplyScalar(Math.PI/180),t.order);let e=We[f];M.premultiply(e.axis_rot).multiply(e.axis_rot_inv);i.bones_by_name[f].quaternion.premultiply(M)}}if(o[0].data_filter||o[1].data_filter){s.fromArray(S.filter(s.toArray()))}const d=MMD_SA.get_bone_rotation_parent(i,e,i);if(!o[0]._IK_absolute){s.applyQuaternion(this.offset_upper_body_camera_rotation(He.copy(d).conjugate(),r?.motion_tracking?.arm_tracking?.transformation?.position?.camera_weight||1))}const c=Te._arm_IK_adjust?.[a];if(c){const g=MMD_SA_options.model_para_obj.left_arm_length;const y=["x","y","z"];if(c.min){if(typeof c.min=="number"){}else{for(const p of y){if(c.min[p]){if(s[p]<c.min[p]*g)s[p]=c.min[p]*g}}}}if(c.scale){if(typeof c.scale=="number"){}else{for(const p of y){if(c.scale[p]){s.multiplyScalar(c.scale[p])}}}}}var m=Ce.fromArray(i.bones_by_name[a+"腕"].pmxBone.origin).sub(Be.fromArray(t.parent.pmxBone.origin));var u=MMD_SA.get_bone_position(i,a+"腕",t.parent.name).sub(m);s.add(u);const p=this.arm_IK_constraint[a];if(p.enabled){arm0=MMD_SA.get_bone_position(i,a+"腕",i);const b=Ce.copy(s).applyQuaternion(d).add(p.arm_pos);const v=Be.copy(p.target).sub(b);if(!p.target_radius||v.length()>p.target_radius){const w=b.sub(p.target).add(v.normalize().multiplyScalar(p.target_radius));s.sub(w.applyQuaternion(d.conjugate()))}}s.add(MMD_SA_options.model_para_obj.arm_IK_offset[a]);t.position.copy(s)}})();var K=function(){let D={};let k={};window.addEventListener("jThree_ready",()=>{D["左"]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,4]}]);D["右"]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,4]}]);k["左"]=[];k["右"]=[];for(let e=0;e<5;e++){k["左"][e]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,1]}]);k["右"][e]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,1]}])}});return function(n,e){var t=THREE.MMD.getModels()[n._model_index];var i=n.bones_by_name[e];var a=e.charAt(0);var o=i.quaternion;const s=this.skin[e];const r=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);o.copy(s[1].rot).slerp(s[0].rot,r);o.fromArray(D[a].filter(o.toArray()));const _="YXZ";const l=MMD_SA.TEMP_v3.setEulerFromQuaternion(o,_);const d=MMD_SA.MMD.motionManager.para_SA.motion_tracking.arm_as_leg.transformation?.rotation||{};let c=Math.sign(l.y)*Math.min(Math.abs(l.y*(d.y?.scale||1)),Math.PI/2);const m=d.y?.foot_ratio||.25;l.y=c*m;l.z=Math.sign(l.z)*Math.min(Math.abs(l.z*(d.z?.scale||.5)),Math.PI/3);l.x*=d.x?.scale||.5;let u=[];let p=0;let h;if(s[0]._finger_x){if(s[1]._finger_x){h=s[0]._finger_x.map((e,t)=>e*r+s[1]._finger_x[t]*(1-r))}else{h=s[0]._finger_x}}if(h){for(let e=0;e<5;e++)u[e]=k[a][e].filter(h[e]);u[0]=(u[0]+u[1])/2;u.forEach(e=>{p+=e});p/=5;l.x-=p}l.x=Math.sign(l.x)*Math.min(Math.abs(l.x),Math.PI/2);o.setFromEuler(l,_);this._rot_=o.clone();this._rot_y=c;const f=this.get_blend_default_motion("skin",a+"足ＩＫ",true);if(f)c*=1-f;const M=MMD_SA.get_bone_position(n,a+"足",n);const g=MMD_SA.get_bone_rotation_parent(n,a+"足",n).conjugate();const y=MMD_SA.get_bone_position(n,e,n).sub(M).negate().normalize().applyQuaternion(g);const b=MMD_SA.TEMP_q.setFromAxisAngle(y,c*(1-m));if(0&&n.bones_by_name[a+"足D"]){n.bones_by_name[a+"足"].quaternion.premultiply(b);n.bones_by_name[a+"足D"].quaternion.premultiply(b)}else{t._update_IK_and_AddTrans(false,a+"足","下半身",true);if(this.skin[a+"足"]&&this.skin[a+"足"][0]._rot_){n.bones_by_name[a+"足"].quaternion.copy(this.skin[a+"足"][0]._rot_)}else{const v=MMD_SA.get_bone_position(n,a+"ひざ",n).sub(M).negate().normalize().applyQuaternion(g);const w=He.setFromUnitVectors(ze.set(0,1,0),y);n.bones_by_name[a+"足"].quaternion.copy(w).multiply(Oe.setFromEuler(ze.set(-v.angleTo(y),0,0)))}n.bones_by_name[a+"足"].quaternion.premultiply(b);t._update_IK_and_AddTrans(false,a+"足","下半身")}if(p&&n.bones_by_name[a+"足先EX"]){const e=a+"足人指";const S=!MMD_SA.MMD.motionManager.para_SA.motion_tracking.arm_as_leg.toes_disabled&&(n.bones_by_name[e]||n.bones_by_name[e+Ge[1]]);if(!S){let t=0;for(let e=1;e<4;e++){t+=u[e]}t/=4;const A=(u[1]-t)/2;n.bones_by_name[a+"足先EX"].quaternion.setFromEuler(ze.set(-p*.5,0,A),"XZY")}else{n.bones_by_name[a+"足先EX"].quaternion.setFromEuler(ze.set(-p*.5,0,0))}t._update_IK_and_AddTrans(false,a+"足先EX")}if(h){Ke.forEach((e,t)=>{const i=a+"足"+e+"指";const o=n.bones_by_name[i]||n.bones_by_name[i+Ge[1]];if(o)o.quaternion.multiply(He.setFromEuler(ze.set(-u[t]*.5,0,0)))})}}}();var ce=function(){let w={};window.addEventListener("jThree_ready",()=>{for(const e of["左","右"]){w[e]=new System._browser.data_filter([{type:"one_euro",id:"hand_rot_filter",para:[30,1,1,1,4]}])}});return function(e,t){var i=THREE.MMD.getModels()[e._model_index];var o=MMD_SA.THREEX.get_model(e._model_index).is_T_pose;var n=e.bones_by_name[t];var a=t.charAt(0);var s,r,_,l;var d=e.bones_by_name[a+"手捩"];var c;var m=this.skin[t];var u=Math.max(Math.min(m[0].t_delta/m[0].t_delta_frame,1),0);const p=MMD_SA.motion[i.skin._motion_index].para_SA;r=He.set(0,0,0,1);if(d){if(d.quaternion.x||d.quaternion.y||d.quaternion.z){d.quaternion.conjugate();i._update_IK_and_AddTrans(false,a+"手捩")}d.quaternion.set(0,0,0,1)}const h=a=="左"?1:-1;var f=m[0].rot_parent;if(!f){f=MMD_SA.get_bone_rotation(e,"上半身2",null,e);f.premultiply(Oe.copy(this._rot_body_offset).multiply(this._rot_camera).conjugate());f.multiply(MMD_SA.get_bone_rotation_parent(e,a+"手首","上半身2")).conjugate()}m[0]._rot_parent=f;const M=m[0].no_blending?S.copy(m[0].rot):S.copy(m[1].rot).slerp(m[0].rot,u);if(m[0]._rot_pose&&m[0]._rot_pose_ratio){let t=m[0]._rot_pose_ratio;if(m[0]._rot_pose_ratio_by_angle_difference){let e=MMD_SA.TEMP_q.copy(M).conjugate().multiply(m[0]._rot_pose).toAxisAngle()[1]%(Math.PI*2);if(e>Math.PI){e-=Math.PI*2}else if(e<-Math.PI){e+=Math.PI*2}const g=Math.pow(1-Math.abs(e)/Math.PI,1-m[0]._rot_pose_ratio_by_angle_difference);t*=g}if(m[0]._rot_pose_constrained){const y=ze.setEulerFromQuaternion(M,"YXZ");const b=Ce.setEulerFromQuaternion(m[0]._rot_pose,"YXZ");let e=Math.abs(y.y-b.y);if(e>Math.PI)e=Math.PI*2-e;if(e>Math.PI*2/3&&Math.abs(y.x)<Math.PI/3&&Math.abs(y.z)<Math.PI/3){M.setFromEuler(MMD_SA.TEMP_v3.copy(y).setY(0),"YXZ").slerp(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(b).setY(0),"YXZ"),t);let e=m[0]._rot_pose_constrained==1?b.y+(y.y>b.y?Math.PI*2:0)-y.y:-(y.y+(y.y<b.y?Math.PI*2:0)-b.y);M.premultiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,y.y+e*t,0),"YXZ"));_rot_hand=M}else{M.slerp(m[0]._rot_pose,t)}}else{M.slerp(m[0]._rot_pose,t)}}r.multiply(M);r.multiplyQuaternions(f,r).multiply(Qe[h]);r.fromArray(w[a].filter(r.toArray()));n.quaternion.copy(r);if(d){_=d.pmxBone.fixedAxis;if(_){_=MMD_SA._v3a.fromArray(_);if(o)_.setY(0).setZ(0).normalize();const v=n.quaternion.toAxisAngle();let e=ze.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromAxisAngle(v[0].applyQuaternion(MMD_SA._q1.copy(We[a+"腕"].axis_rot).conjugate()),v[1]),"XZY").x*-h;if(e*h<-Math.PI/1.5)e+=Math.PI*2*h;l=-e*.5;c=Oe.setFromAxisAngle(_,l);this.skin[a+"手捩"][0].rot.copy(c);n.quaternion.multiplyQuaternions(c.conjugate(),n.quaternion)}}if(Ze.active){Ze.set_boneKey(t,null,n.quaternion,true);if(!Te.IK_disabled_check(a+"腕ＩＫ")){Ze.set_boneKey(a+"腕",null,e.bones_by_name[a+"腕"].quaternion,false);Ze.set_boneKey(a+"ひじ",null,e.bones_by_name[a+"ひじ"].quaternion,false)}}}}();function me(m,u){function e(){if(MMD_SA.THREEX.shoulder_adjust=="None")return;const e=THREE.MMD.getModels()[m._model_index];const t=MMD_SA.THREEX.get_model(m._model_index).is_T_pose;const i=u.charAt(0);const o=MMD_SA.motion[e.skin._motion_index].para_SA;let n=Ye.skin[i+"腕"]&&(o.motion_tracking_upper_body_only?(1-(o.motion_tracking?.motion_default_weight?.shoulder||0))*(1-Ye.get_blend_default_motion("skin",i+"腕")):1);if(!n)return;const a=m.bones_by_name[i+"腕"].quaternion;const s=!t?MMD_SA.TEMP_q.fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(i+"腕",a.toArray())):MMD_SA.TEMP_q.copy(a);let r=MMD_SA.TEMP_v3.setEulerFromQuaternion(s,"YZX").z;const _=i=="左"?1:-1;r=r*_+Math.PI/2;if(r>Math.PI/4){const l=r<Math.PI/2?(r-Math.PI/4)/(Math.PI/4):Math.min(1+(r-Math.PI/2)/(Math.PI/2)*4,1+4);const d=(Math.min(l,1)*(!MMD_SA.THREEX.shoulder_adjust?12.5*.5:MMD_SA.THREEX.shoulder_adjust=="Full"?12.5:0)+Math.max(l-1,0)*12.5)*Math.PI/180*n*-_;const c=MMD_SA.TEMP_q.set(0,0,Math.sin(d/2),Math.cos(d/2));a.premultiply(c);m.bones_by_name[i+"肩"].quaternion.multiply(c.conjugate());if(Ze.active){Ze.set_boneKey(i+"肩",null,m.bones_by_name[i+"肩"].quaternion,false);Ze.set_boneKey(i+"腕",null,a,false)}}}window.addEventListener("SA_MMD_model"+m._model_index+"_process_bones_after_IK",e,{once:true})}var ue=0,pe=0,he=0,fe=0;var Me=0,ge=0,ye=0,be=0;let ve,we;let Se;let Ae={};let De={};let ke={};let Ee;let xe={};window.addEventListener("jThree_ready",()=>{ve=new System._browser.data_filter([{type:"one_euro",id:"torso_rot",para:[30,.5,1,1,3]}]);we=new System._browser.data_filter([{type:"one_euro",id:"chest_rot",para:[30,.5,1,1,3]}]);Se=new System._browser.data_filter([{type:"one_euro",id:"shoulder_rot_z_filter",para:[30,1,1,1,1]}]);Ee=new System._browser.data_filter([{type:"one_euro",id:"hand_depth_weight",para:[30,.5,.1,1,1]}]);for(const e of["左","右"]){Ae[e]=new System._browser.data_filter([{type:"one_euro",id:"arm_IK"+e,para:[30,.5,1/2,1,3]}]);De[e]=new System._browser.data_filter([{type:"one_euro",id:"arm_IK"+e,para:[30,.5,1/2,1,4]}]);ke[e]=new System._browser.data_filter([{type:"one_euro",id:"hand_depth"+e,para:[30,.5,.1,1,1]}]);xe[e]=new System._browser.data_filter([{type:"one_euro",id:"rot_pose_ratio"+e,para:[30,.5,.1,1,1]}])}});return function(e){var Y=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof Y==="string"){if(Y=="OK"){Te.worker_initialized=true}else{DEBUG_show(Y,2);System._browser.console.log(Y)}}else if(Te.enabled){window.dispatchEvent(new CustomEvent("SA_camera_poseNet_update"));Pe._needs_RAF=true;Te._bb=null;const te=MMD_SA.THREEX.get_model(0).model_para;const o=mt[Te.use_holistic?1:0];let e;if(Te.enabled&&!o.poseNet){e=true;o.poseNet=true}if(je.enabled&&!o.handpose){e=true;o.handpose=true}if(e)DEBUG_show("Pose ML ready",2);Le=(Ie.enabled?"\n":"")+Pe.video_canvas.width+"x"+Pe.video_canvas.height+"("+Te.camera_video_frame_id+")\n";let t=Pe.video_timestamp;let i=0;if(fe){i=Math.max(Math.min(t-fe,1e3),10);he+=i;if(++pe>=20){ue=1e3/(he/pe);pe=he=0}}fe=t;Te._t=Y._t;Ye.t_delta=((Ye.t_delta||i)+i)/2;if(Y.handpose){i=0;if(be){i=Math.max(Math.min(t-be,1e3),10);ye+=i;if(++ge>=20){Me=1e3/(ye/ge);ge=ye=0}}be=t;Te._t_hands=Y._t_hands;Ye.t_delta_hands=((Ye.t_delta_hands||i)+i)/2}if(Te.use_holistic){o.facemesh=true;if(!Y.facemesh){Ie.data_detected=0}}let G=[];let X=[];let W=Pe.x_flipped?1:-1;let Q;const s=THREE.MMD.getModels()[0];const n=s.mesh.bones_by_name;const ie=MMD_SA.THREEX.get_model(0).is_T_pose;const Z=MMD_SA.MMD.motionManager.para_SA;const m=Z.motion_tracking&&Z.motion_tracking.arm_as_leg;const $={"左":m&&m.enabled&&(!m.linked_side||m.linked_side=="left"),"右":m&&m.enabled&&(!m.linked_side||m.linked_side=="right")};let S;let V,a;let N;if(Te.enabled){if(Y.posenet&&Y.posenet.score>.3){Te.data_detected++;Te.initial_data_detected=true;if(Te.data_detected_stable){if(Xe){Xe=false;s.mesh.visible=true}S=Z.motion_tracking?.camera?.tilt_adjustment||Pe.tilt_adjustment;if(S.enabled){a=S.angle*S.pose_weight*Math.PI/180;V=(new THREE.Quaternion).set(Math.sin(a/2),0,0,Math.cos(a/2))}N=Y.posenet;let O=Te.use_3D_pose;if(nt){N._keypoints=N.keypoints;N._keypoints3D=N.keypoints3D;let o=[];let n=[];_t.forEach((e,t)=>{let i=N.keypoints[e];i.part=rt[t];o.push(i);i=N.keypoints3D[e];i.part=rt[t];n.push(i)});N.keypoints=o;N.keypoints3D=n}const d=ot?.3:!st?.5:.1;N.keypoints.forEach(e=>{e.score-=d});if(O){N._keypoints3D.forEach(e=>{e.score-=d})}if(st){let i={};N.keypoints.forEach(e=>{i[e.part]=e});let o=[];for(let t=0;t<=16;t++){let e=N.keypoints[t];if(!e)o.push(lt[t]);else if(e.part!=rt[t])o.push(i[rt[t]]||lt[t]);else o.push(e)}N.keypoints=o}let e=N._keypoints||N.keypoints;let t=e.map(e=>e.position.x);let i=e.map(e=>e.position.y);const g=[Math.min(...i),Math.max(...t),Math.max(...i),Math.min(...t)];e=N.keypoints.slice(0,5);t=e.map(e=>e.position.x);i=e.map(e=>e.position.y);const y=[Math.min(...i),Math.max(...t),Math.max(...i),Math.min(...t)];const b=Math.max(y[1]-y[3],y[2]-y[0])/2;g[0]=Math.min(g[0],y[0]-b);g[1]=Math.max(g[1],y[1]+b);g[2]=Math.max(g[2],y[2]-b);g[3]=Math.min(g[3],y[3]-b);Te._bb=g;if(!Ie.head_pose_enabled){Ie.bb_center[0]=N.keypoints[0].position.x/Pe.video_canvas.width;Ie.bb_center[1]=N.keypoints[0].position.y/Pe.video_canvas.height}if(O){let e=N._keypoints[0].position;let t=N._keypoints[3].position;let i=N._keypoints[6].position;const w=ze.copy(i);const D=Ce.copy(t);D.sub(w);const k=MMD_SA._v3a_.copy(e);const E=(k.x*D.x+k.y*D.y+k.z*D.z-(w.x*D.x+w.y*D.y+w.z*D.z))/D.lengthSq();const z=MMD_SA._v3b.set(w.x+D.x*E,w.y+D.y*E,w.z+D.z*E);let o=k.sub(z).normalize();let n=MMD_SA._v3b_.copy(t).sub(MMD_SA._v3b.copy(i));n.normalize();let a=MMD_SA.TEMP_v3.crossVectors(n,o).normalize();n.crossVectors(o,a);qe.set(n.x,n.y,n.z,0,o.x,o.y,o.z,0,a.x,a.y,a.z,0,0,0,0,1);Ue.setFromBasis(qe);let s=Ue.conjugate();s=s.clone().multiply(MMD_SA.TEMP_q.set(Math.sin(Math.PI/3.5/2),0,0,Math.cos(Math.PI/3.5/2)));Ie._neck.shoulder_center=Ce.copy(N._keypoints[11].position).add(MMD_SA.TEMP_v3.copy(N._keypoints[12].position)).multiplyScalar(.5).toArray();if(V)s.premultiply(V);if(!Ie.head_pose_enabled){Ye.add("skin","首",{after_IK:true,rot:s,onProcessRotation:dt});Ye.skin["首"][1]._rot_mixed&&Ye.skin["首"][1].rot.copy(Ye.skin["首"][1]._rot_mixed)}Ye.add("skin","首_DUMMY_",{rot:s,_rot_from_pose:s.clone(),onProcessRotation:dt})}let o=N.keypoints[5];let n=N.keypoints[6];let q=new THREE.Quaternion;Q=Z.motion_tracking_upper_body_only;Le+="\n"+(Q?(Z.motion_tracking?.arm_as_leg?.enabled?"🦶":"🙋")+"upper body":"💃full body");const v=MMD_SA_options.Dungeon_options?.item_base.hand_camera;if(v&&v._hand_camera_side){Le+="/"+(v.selfie_mode?"🤳selfie":"📷handcam")+(v._hand_camera_side=="左"?"-L":"-R")}Le+="\n";if(O&&ct)Ve.prepare(N);let M=0,U=0;if(je.enabled&&Y.handpose)je.hand_visible_timestamp={};Ne[0]=Ne[1]=0;let K;if(o.score>0&&n.score>0){let u,p;let h,f;if(O){u=N.keypoints3D[5];p=N.keypoints3D[6];let i=N.keypoints3D[11];let o=N.keypoints3D[12];let n;if(Q||i.score<=0||o.score<=0){Q=true}else{if(N.keypoints[11].position.y>Pe.video_canvas.height||N.keypoints[12].position.y>Pe.video_canvas.height){Q=true}let e=MMD_SA._v3b.copy(i).sub(o).normalize();let t=MMD_SA.TEMP_v3.set(1,0,0);n=Be.setFromVectorSpherical(t,e);M=n.z;if(1||Q)n.z=0;q.setFromEuler(n,"YZX")}let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;let t=MMD_SA._v3a.addVectors(u,p).multiplyScalar(.5);if(t.z<0){t.normalize();if(Te.body_bend_reduction_power==1){t.z=0}else{spine_yz=MMD_SA._v3b.set(0,t.y,t.z).normalize();t.z*=Math.pow(-spine_yz.z,Math.pow(1.6,(Te.body_bend_reduction_power||0)/.25))/-spine_yz.z}}t.normalize();Ie.calculate_neck_data({is_pose:true,timestamp:Te.camera_video_frame_id,shoulder_center:Ie._neck.shoulder_center,spine_rot_absolute:Ce.setFromVectorSpherical(e,t).toArray()});t.applyQuaternion(MMD_SA.TEMP_q.copy(q).conjugate());const T=Ce.setFromVectorSpherical(e,t);if(Z.motion_tracking_upper_body_only){T.fromArray(ve.filter(T.toArray()));h=(new THREE.Quaternion).setFromEuler(T,"XZY")}else{if(Q){if(n){T.add(n)}q.set(0,0,0,1);T.fromArray(ve.filter(T.toArray()));h=(new THREE.Quaternion).setFromEuler(T,"YXZ")}else{h=(new THREE.Quaternion).setFromEuler(T,"XZY")}}U=T.x;let a=MMD_SA._v3b.copy(u).sub(p).normalize();a.applyQuaternion(MMD_SA.TEMP_q.multiplyQuaternions(q,h).conjugate());x_axis=MMD_SA.TEMP_v3.set(1,0,0);let s=Ce.setFromVectorSpherical(x_axis,a);let r=Te.shoulder_tracking?.5:0;let _=Se.filter(s.z*(MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?3:5))*r;let l=Math.min(Math.PI/12/Math.abs(_),1);_*=l;if(Q){s.fromArray(we.filter(s.toArray()))}Ne[0]=_;Ne[1]=_;s.z*=1-r;f=(new THREE.Quaternion).setFromEuler(s,"YZX");let d=0;let c=s.y;let m=(d+c)%(Math.PI*2);if(m>Math.PI)m=Math.PI*2-m;else if(m<0&&m<-Math.PI)m+=Math.PI*2;h.multiply(He.set(0,Math.sin((m/2-d)/2),0,Math.cos((m/2-d)/2)));f.multiply(He.set(0,Math.sin((m/2-c)/2),0,Math.cos((m/2-c)/2)));Ye.add("skin","センター",{rot:q.clone(),priority:9});if(Ze.active){if(!Ye.skin["センター"][0].pos&&Ye.skin["センター"][1].pos)Ye.skin["センター"][0].pos=Ye.skin["センター"][1].pos}const C=h.clone();if(V){const B=He.copy(V);const oe=Z.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(oe.upper_rotation_offset){const ne=-(oe.upper_rotation_offset-m)*2/3*Math.PI/180;const ae=V.toAxisAngle();B.setFromAxisAngle(ae[0].applyQuaternion(MMD_SA.TEMP_q.set(0,Math.sin(ne/2),0,Math.cos(ne/2))),ae[1])}He.premultiply(MMD_SA.TEMP_q.copy(q).conjugate()).multiply(q);C.premultiply(B)}Ye.add("skin","上半身",{rot:C});Ye.add("skin","上半身2",{rot:f.clone()});K=He.copy(q).multiply(h).multiply(f);K.conjugate()}const x=MMD_SA.TEMP_v3.set(1,1,1/3);Te.shoulder_width=ze.copy(o.position).multiply(x).distanceTo(Ce.copy(n.position).multiply(x));let H=Math.sqrt(Math.pow(o.position.x-n.position.x,2)+Math.pow(o.position.y-n.position.y,2));let e=0;if(!O){e=Math.asin((o.position.y-n.position.y)/H);e=Math.max(Math.min(e/(Math.PI/4),1),-1)*Math.PI/4*W}let t=W==1?[1,0]:[0,1];H=Ie.face_width*2||H;Te._upper_body_only_mode=Q;const J=[0,0];const ee=[];t.forEach(function(i,e){let n,a,s;let r;let _=e==0?"左":"右";let l=N.keypoints[5+i];let d=N.keypoints[7+i];let c=N.keypoints[9+i];let m=(Z.motion_tracking?.arm_tracking?.use_IK!=null?!Z.motion_tracking.arm_tracking.use_IK:MMD_SA_options.user_camera.ML_models.pose.use_armIK==null?!Q&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=_:!MMD_SA_options.user_camera.ML_models.pose.use_armIK)&&!$[_];let u=false;let p=c.score>0&&c.position.x>=0&&c.position.x<=Pe.video_canvas.width&&c.position.y>=0&&c.position.y<=Pe.video_canvas.height;if(Z.motion_tracking_upper_body_only&&!p){m=false}ee[e]=new THREE.Quaternion;if(ie)ee[e].fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(_+"肩",ee[e].toArray()));let h,f,M;if(O){h=N.keypoints3D[5+i];f=N.keypoints3D[7+i];M=N.keypoints3D[9+i];let e=(te.camera?.poseNet?.arm_horizontal_offset_percent||0)/100+(Te.arm_horizontal_offset_percent||0)/100;if(e){const S=e>0?1/(1+e):1-e;const A=MMD_SA.TEMP_v3.copy(N.keypoints3D[5]).add(N.keypoints3D[6]).multiplyScalar(.5);const D=Be.copy(h).sub(A);const k=Je.copy(D).multiplyScalar(S).add(A);h={x:k.x,y:k.y,z:k.z};D.copy(k).sub(h).multiplyScalar(.5);k.copy(f).add(D);f={x:k.x,y:k.y,z:k.z}}}let t=W*(i==0?-1:1);if(O&&c.score>0&&je.enabled&&je.stabilize_hand_percent&&Te.shoulder_width){const E=Pe.video_canvas.width;const x=Pe.video_canvas.height;const P=je._hand_last[_];let o;if(Y.handpose&&Y.handpose.length){const R=Y.handpose.find(e=>e.label==(_=="左"?"Left":"Right"));if(R){o=P.hand=R.annotations.palm[0];P.timestamp=RAF_timestamp;P.w=E;P.h=x}}if(!o){o=P.hand}const I=1e3*(je.stabilize_hand_percent/100)*(Q||!m?1:.5);let n=RAF_timestamp-P.timestamp;if(o&&P.w==E&&P.h==x&&n<I){const e=N.keypoints3D[5];const t=N.keypoints3D[6];const C=Te.shoulder_width*1.5/ze.copy(e).distanceTo(t);const T=MMD_SA.TEMP_v3.fromArray(o).sub(c.position).multiplyScalar(1/C);let i=1;const S=Math.max(E,x)/Te.shoulder_width;const B=1-Math.min(Math.max(S-5,0)/5,1);n/=.5+(1-.5)*B;i*=1-Math.min(n/I,1);M.x+=T.x*i;M.y+=T.y*i}else{P.timestamp=0}}let o,g,y;const z="YZX";if(O&&d.score>0){o=MMD_SA._v3b.copy(h).sub(f).normalize().applyQuaternion(K);g=MMD_SA.TEMP_v3.set(t,0,0);y=(new THREE.Quaternion).setFromUnitVectors(g,o);J[e]=Ce.setFromVectorSpherical(g,o).z}let b=Ae[_].filters[0].filter;if(c.score>0){let e;if(Q&&je.enabled&&je.use_hands_worker&&!Y.handpose){if(je.hand_visible_timestamp[_]+200>RAF_timestamp)p=e=true}let n,t;if(je.enabled&&Y.handpose){n=Y.handpose.find(e=>e.label==(_=="左"?"Left":"Right"));if(n){p=true}}if(n){je.hand_visible_timestamp[_]=RAF_timestamp;if(!Q)je.hand_visible_session[_]=RAF_timestamp}if(je.enabled&&Q){let t;let i;let o=je.hand_visible_session[_]||0;if(n||e){if(o<1e3){je.hand_visible_session[_]=1e3;if(!je.stabilize_arm_time){t=true}else{i=true}}else if(o<1200){je.hand_visible_session[_]+=Te._t_hands;if(je.hand_visible_session[_]>1e3+je.stabilize_arm_time){t=true}else{i=true}}else{je.hand_visible_session[_]=RAF_timestamp}}else{je.hand_visible_timestamp[_]=0;let e=!p;if(p&&o<1e3+je.stabilize_arm_time){if(o>=1e3)o=je.hand_visible_session[_]=201;e=true;i=true}if(e){t=p;if(!o){je.hand_visible_session[_]=0;i=true}else if(o>200){je.hand_visible_session[_]=200}else{je.hand_visible_session[_]-=Te._t_hands;if(je.hand_visible_session[_]<0)je.hand_visible_session[_]=0}}}if(t){b.beta=1/10;b=null}if((Z.motion_tracking?.hand_tracking?.stabilize_arm_disabled?0:je.stabilize_arm)>(Z.motion_tracking_upper_body_only?0:1)){if(i){p=false;n=null;c.score=0;if(Ye.skin[_+"手首"]?.[0].rot.w!=1){const j=new THREE.Quaternion;Ye.add("skin",_+"ひじ",{absolute:true,no_blending:true,rot:j});Ye.add("skin",_+"手首",{after_IK:true,absolute:true,no_blending:true,rot:j});Ye.add("skin",_+"手捩",{after_IK:true,absolute:true,no_blending:true,rot:j})}}}}X.push({pos:c.position,dir:i,d:_,visible:p,handpose:n,palm_offset:t})}else{je.hand_visible_session[_]=0}let v=0;const w=Z.motion_tracking?.arm_tracking?.data_filter?.[_=="左"?"left":"right"];if(w){v=1;if(w.weight_by_magnet){const L=Z.motion_tracking.arm_tracking?.transformation?.position?.magnet?.find(e=>e.magnet_id==w.weight_by_magnet.id);v=L&&L._frame_count_>=EV_sync_update.count_frame-1-(je.use_hands_worker?6:0)?L._weight_:0}}if(b){b.beta=.5*(1-v)+(w?.beta||.5)*v}if(c.score>0){if(O){let o;if(d.score>0){let e=ze.copy(f).sub(M).normalize().applyQuaternion(K).applyQuaternion(MMD_SA.TEMP_q.copy(y).conjugate());g=MMD_SA.TEMP_v3.set(t,0,0);o=(new THREE.Quaternion).setFromUnitVectors(g,e)}if(!m||d.score<=0){m=false;let e=MMD_SA._v3a.copy(h).sub(M);if(V)e.applyQuaternion(V);let t=d.score>0?MMD_SA.TEMP_v3.copy(h).distanceTo(f)+MMD_SA.TEMP_v3.copy(f).distanceTo(M):.5;let i=Math.min(e.length()/t,1);e.normalize().multiplyScalar(i*MMD_SA_options.model_para_obj.left_arm_length);n=e.x;a=e.y;s=r=e.z;if(y){let e;if($[_]){e=K.clone().conjugate().multiply(y).multiply(o).conjugate()}se(y,_+"腕");if(Q)y.fromArray(De[_].filter(y.toArray()));Ye.add("skin",_+"腕",{absolute:true,rot:y,_rot_hand_parent:e,onFinish:le});if(o){se(o,_+"ひじ");Ye.add("skin",_+"ひじ",{absolute:true,rot:o})}}}else{se(o,_+"ひじ");se(y,_+"腕");Ye.add("skin",_+"腕",{absolute:true,rot:y,priority:-1,onFinish:_e});Ye.add("skin",_+"ひじ",{absolute:true,rot:o})}}else{u=true;let e=l.position.x-c.position.x;let t=l.position.y-c.position.y;n=e/H*MMD_SA_options.model_para_obj.shoulder_width*W;a=t/H*MMD_SA_options.model_para_obj.shoulder_width;if(d.score>0){let e=Math.min(Math.sqrt(Math.pow(c.position.x-d.position.x,2)+Math.pow(c.position.y-d.position.y,2))/H,1);let t=Math.min(Math.sqrt(Math.pow(l.position.x-d.position.x,2)+Math.pow(l.position.y-d.position.y,2))/H,1);r=(.25+(Math.sin(Math.acos(e))+Math.sin(Math.acos(t)))/2*.75)*MMD_SA_options.model_para_obj.left_arm_length}}}else{if($[_]){Ye.add("skin",_+"手首",{rot:new THREE.Quaternion});Ye.remove("skin",_+"足首")}if(d.score>0){if(O){if(!m){m=false;o=MMD_SA._v3a.copy(h).sub(f).normalize();o.multiplyScalar(MMD_SA_options.model_para_obj.left_arm_length);n=o.x*W;a=o.y;s=r=o.z}else{m=true;se(y,_+"腕");Ye.add("skin",_+"腕",{absolute:true,rot:y,priority:-1,onFinish:_e})}}else{m=false;u=true;let e=l.position.x-d.position.x;let t=l.position.y-d.position.y;let i=Math.sqrt(e*e+t*t);let o=Math.asin(e/i);n=Math.sin(o)*MMD_SA_options.model_para_obj.left_arm_length*W;a=Math.cos(o)*MMD_SA_options.model_para_obj.left_arm_length*Math.sign(t)}}else{if(O){if(!Z.motion_tracking_upper_body_only)return;s=r=0}else{u=true}if(n==null){m=false;n=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*(_=="左"?1:-1)*.2;a=-Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-n*n)}}}if(!m&&(Z.motion_tracking?.arm_tracking?.use_IK||Q)&&!w?.disabled){let e=Ae[_].filters[0].filter;e.minCutOff=.5*(1-v)+(w?.minCutOff||.5)*v;const F=Ae[_].filter([n,a,s]);n=F[0];a=F[1];s=F[2]}G.push({pos:{x:n,y:a,z:s,z_posenet:r},dir:i,d:_,IK_disabled:m,IK_absolute:u})});J[0]=J[0]==null?0:Math.max(J[0]+Math.PI/2,0);J[1]=J[1]==null?0:Math.max(Math.PI/2-J[1],0);const P=J[0]>J[1]?1:0;const I=Math.min(Math.abs(J[0]-J[1])/(Math.PI/2),1);J[P==0?1:0]=1;J[P]=1-I*I*.5;t.forEach(function(e,i){let o=i==0?"左":"右";if(ee[i]){Ne[i]*=J[i];let e=Ne[2]*(i==0?1:-1);let t=Ne[i]+e;const n=Math.PI/6;if(Math.abs(t)>n){e=Math.sign(e)*(n-Math.abs(Ne[i]));t=Ne[i]+e}t=tt[o].filter(t);ee[i].multiply(MMD_SA.TEMP_q.set(0,0,Math.sin(t/2),Math.cos(t/2)));Ye.add("skin",o+"肩",{priority:-2,absolute:!(Z.motion_tracking_upper_body_only&&Z.motion_tracking?.motion_default_weight?.shoulder),rot:ee[i],_rot_z:Ne[i],_rot_shrug:e,_rot_total:t,onFinish:me})}})}else{Q=true}if(O&&!Q){const H=M;if(V){q.premultiply(MMD_SA.TEMP_q.copy(V).conjugate());M=H-MMD_SA.TEMP_v3.setEulerFromQuaternion(q,"YZX").z}Ve.get_hip_center(N);let e=W==1?[1,0]:[0,1];let B=[];let t=[];let o=0;let i=[];e.forEach(function(m,e){let u=e==0?"左":"右";let p=N.keypoints3D[11+m];let h=N.keypoints3D[13+m];let f=N.keypoints3D[15+m];let M,g,y;if(f.score>0){M=MMD_SA._v3a.copy(p).sub(f);g=M.length();y=h.score>0?MMD_SA.TEMP_v3.copy(p).distanceTo(h)+MMD_SA.TEMP_v3.copy(h).distanceTo(f):.7;M.normalize().multiplyScalar(Math.min(g/y,1)*MMD_SA_options.model_para_obj.left_leg_length)}if(Te.leg_scale_adjustment&&f.score>0){let e=1;let t=1;let i,o,n;let a,s,r;const _=Be.copy(p);const l=Je.copy(f).sub(_);let d,c;if(h.score>0){const e=Ce.copy(h);const t=(e.x*l.x+e.y*l.y+e.z*l.z-(_.x*l.x+_.y*l.y+_.z*l.z))/l.lengthSq();d=ze.set(_.x+l.x*t,_.y+l.y*t,_.z+l.z*t);c=e.sub(d);s=Be.copy(p).sub(h).length();r=Be.copy(p).sub(d).length();a=c.length()}else{s=y/2;r=Math.min(l.length()/2,s);a=Math.sqrt(s*s-r*r)}const C=a/y;const b=Pe.video_canvas.width;const v=Pe.video_canvas.height;const w=MMD_SA.TEMP_v3;const S=Ve.v_hip;const A=N.keypoints[11+m];const D=N.keypoints[15+m];const k=MMD_SA_options.model_para_obj.left_leg_length;const E=b/v;const x=SL.width/SL.height;const P=E<x?E/x:1;const I=x<E?x/E:1;w.set((A.position.x/b*2-1)*P,(-(A.position.y/v)*2+1)*I,.5);const R=MMD_SA._v3a_.copy(w.unproject(Pe._camera_reset).sub(Pe._camera_reset.position).normalize());R.multiplyScalar((S.z-p.z/y*k)/R.z);w.set((D.position.x/b*2-1)*P,(-(D.position.y/v)*2+1)*I,.5);const T=MMD_SA._v3b_.copy(w.unproject(Pe._camera_reset).sub(Pe._camera_reset.position).normalize());T.multiplyScalar((S.z-f.z/y*k)/T.z);g=M.length();e=Math.min(R.distanceTo(T),k)/g;if(h.score>0){t=Math.sqrt((s*s-e*e*r*r)/(a*a))||0;if(t){}else{o=0;n=true;i=s/r}if(o!=null){Le+="\n"+u+":"+i+"(x"+o+")"+(n?"<>":"")+"\n";e=i;t=o}else Le+="\n"+u+":"+e+"(x"+t+")\n";if(e!=1){const j=Be.copy(p).add(l.multiplyScalar(e)).sub(f);for(const F of[27,29,31]){const e=N._keypoints3D[F+m];Object.assign(e,MMD_SA.TEMP_v3.copy(e).add(j))}f=N.keypoints3D[15+m];const L=d.sub(p).multiplyScalar(e).add(p).add(c.multiplyScalar(t));h=N.keypoints3D[13+m]=Object.assign(h,L);M.multiplyScalar(e)}}else{M.multiplyScalar(e);Le+="\n"+u+"(IK):"+e+"(x"+t+")\n"}}let n,a;let i;if(h.score>0){i=MMD_SA._v3b.copy(p).sub(h).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(q).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;a=Ce.setFromVectorSpherical(e,i);n=(new THREE.Quaternion).setFromEuler(a,"XZY");const t=ze.setFromVectorSpherical(e,MMD_SA._v3b.copy(p).sub(h).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(q).multiply(MMD_SA._q2.set(0,0,Math.sin(H/2),Math.cos(H/2))).multiply(MMD_SA._q1.set(Math.sin(U/2),0,0,Math.cos(U/2))).conjugate()));o+=t.x}let t=!MMD_SA_options.user_camera.ML_models.pose.use_legIK;if(f.score>0){let i,o;if(h.score>0){i=ze.copy(h).sub(f).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(q).conjugate());o=Be.copy(i).applyQuaternion(MMD_SA.TEMP_q.copy(n).conjugate());o.z=Math.max(-o.z,0);o.x*=-1;let e=o.normalize().toSphericalCoords();let t=Math.sqrt(Math.min((Math.PI-e[2])/(Math.PI/2),1));a.y=e[1]*t;n.setFromEuler(a,"XZY")}if(!t||h.score<=0){Te.enable_IK(u+"足ＩＫ",true);B.push({pos:M.clone(),rot:[n],dir:m,d:u})}else{o=Be.copy(i).applyQuaternion(MMD_SA.TEMP_q.copy(n).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;let t=(new THREE.Quaternion).setFromVectorSpherical(e,o);Te.enable_IK(u+"足ＩＫ",false);B.push({rot:[n,t],dir:m,d:u})}const s=N._keypoints3D[29+m];const r=N._keypoints3D[31+m];if(s.score>0&&r.score>0){let e=MMD_SA._v3a_.copy(s).sub(f).normalize();let t=MMD_SA._v3b_.copy(s).sub(r).normalize();let i=ze.crossVectors(e,t).normalize();e.crossVectors(t,i);qe.set(i.x,i.y,i.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,0,0,0,0,1);Ue.setFromBasis(qe);let o=Ue.conjugate();const _=-Math.PI/(MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?10:8);o=o.clone().multiply(MMD_SA.TEMP_q.set(Math.sin(_/2),0,0,Math.cos(_/2)));if(V)o.premultiply(V);const l=He.copy(q);if(V)l.premultiply(V);const d=MMD_SA.TEMP_v3.setEulerFromQuaternion(l,"YZX");const c=Math.abs(d.y)%Math.PI;let n=c>Math.PI/2?1-(c-Math.PI/2)/(Math.PI/2):1;if(MMD_SA_options.user_camera.ML_models.pose.use_legIK){const z=o.clone();if(n<1){d.x=d.z=0;z.slerp(Oe.setFromEuler(d,"YZX"),1-n)}B[B.length-1].rot[2]=z}Ye.add("skin",u+"足首",{after_IK:true,absolute:true,parent_based:true,motion_recorder_disabled:MMD_SA_options.user_camera.ML_models.pose.use_legIK,rot:o,ratio:n,ratio_euler:MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?{x:1,y:1,z:.5,order:"YXZ"}:null})}}else{if(h.score>0){if(!t){M=MMD_SA._v3a.copy(p).sub(h).normalize().multiplyScalar(MMD_SA_options.model_para_obj.left_leg_length);if(V)M.applyQuaternion(V);Te.enable_IK(u+"足ＩＫ",true);B.push({pos:M.clone(),rot:[n],dir:m,d:u})}else{Te.enable_IK(u+"足ＩＫ",false);B.push({rot:[n],dir:m,d:u})}}if(Ye.skin[u+"足首"]?.[0].rot.w!=1)Ye.add("skin",u+"足首",{after_IK:true,absolute:true,no_blending:true,rot:new THREE.Quaternion})}});let n=0;i.forEach(e=>{const t=e.y*(1-e.scale);if(t>0){n=Math.max(t,n)}else if(i.length>1){n=Math.max(t,n||t)}});if(n){Ve.v_hip.y+=n;Le+="\nleg_offset_y:"+n+"\n"}o*=.5*.5;o+=U;let a=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(o,0,M),"YZX");Ye.add("skin","下半身",{absolute:true,rot:a.clone()});if(!Q){Ye.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:de})}a.conjugate();B.forEach(e=>{var t=e.d;if(e.rot[0]){e.rot[0].multiplyQuaternions(a,e.rot[0]);Ye.add("skin",t+"足",{absolute:true,rot:e.rot[0]})}if(e.pos){e.pos.add(MMD_SA_options.model_para_obj.leg_IK_offset[t]);const i=e.rot[2]||Ye.skin[t+"足ＩＫ"]&&Ye.skin[t+"足ＩＫ"][0].rot;Ye.add("skin",t+"足ＩＫ",{absolute:true,pos:e.pos,rot:i,priority:999,onFinish:re})}else{if(e.rot[1]){Ye.add("skin",t+"ひざ",{absolute:true,rot:e.rot[1]})}else if(Ye.skin[t+"ひざ"]?.[0].rot.w!=1){Ye.add("skin",t+"ひざ",{absolute:true,no_blending:true,rot:new THREE.Quaternion})}}})}else{if(Z.motion_tracking_upper_body_only){Ye.add("skin","全ての親",{is_dummy:true,pos:true,after_IK:true,priority:999})}else if(O&&o.score>0&&n.score>0&&Pe.video_canvas.width){Ve.get_hip_center(N);Ye.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:de})}if(!$["左"]||!$["右"])Ye.add("skin","下半身",{is_dummy:true,rot:true});for(const j of["左","右"]){if(!$[j]){Ye.add("skin",j+"足ＩＫ",{is_dummy:true,pos:true,priority:999});Ye.add("skin",j+"足",{is_dummy:true,rot:true});Ye.add("skin",j+"ひざ",{is_dummy:true,rot:true});Ye.add("skin",j+"足首",{is_dummy:true,after_IK:true,rot:true})}}}}}else{Te.data_detected=0}}if(Te.enabled&&!Te.data_detected_stable&&!Xe){Xe=true;if(!Z.motion_tracking_upper_body_only&&Te.initial_data_detected)s.mesh.visible=false}let R;let A=[];const r=!je.enabled&&N&&Te.use_3D_pose;const _=W==1?[1,0]:[0,1];const c={};const l=je.enabled&&Te.shoulder_width?Math.min(Math.max(Math.max(Pe.video_canvas.width,Pe.video_canvas.height)/Te.shoulder_width-5,0)/5,1)*.5:0;const p={"左":l,"右":l};if(r||!Z.motion_tracking_upper_body_only&&l){_.forEach(function(e,t){let i=t==0?"左":"右";if(!X.find(e=>e.d==i)?.visible)return;let o=N._keypoints3D[15+e];let n=N._keypoints3D[17+e];let a=N._keypoints3D[19+e];if(o.score<=0||n.score<=0||a.score<=0)return;let s=e==1?[a,n]:[n,a];let r=MMD_SA._v3a_.copy(o).sub(MMD_SA._v3b.copy(n).add(a).multiplyScalar(.5)).normalize();r.x=r.x*W;let _=MMD_SA._v3b_.copy(s[0]).sub(s[1]).normalize();_.z=_.z*W;_.y=_.y*W;let l=MMD_SA.TEMP_v3.crossVectors(_,r).normalize();_.crossVectors(r,l);qe.set(_.x,_.y,_.z,0,r.x,r.y,r.z,0,l.x,l.y,l.z,0,0,0,0,1);Ue.setFromBasis(qe);let d=new THREE.Quaternion;d.copy(Ue).conjugate();if(V)d.premultiply(V);c[i]=d})}if(je.enabled&&Y.handpose&&Y.handpose.length&&X.length){const O=at?1:2;Y.handpose.forEach(e=>{e._offset={};R=e.annotations;if(O>1){for(let e in R){R[e].forEach(e=>{e[2]*=O})}}});X.forEach((m,e)=>{var u=m.dir;let p=m.handpose;if(p&&m.visible){m.visible=true;p._used=true;let k=m.d;p._d=k;R=p.annotations;let e=G.find(e=>e.dir==u);const h=Je.set(1,1,p.z_adjust_ratio||1);let t=Z.motion_tracking?.hand_tracking?.depth_adjustment_disabled?0:MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent/100;if(t&&Q&&e.pos.z>0&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=k){const g=(MMD_SA._v3a.fromArray(R.palm[0]).multiply(h).distanceTo(MMD_SA._v3b.fromArray(R.middle[0]).multiply(h))+MMD_SA._v3a.fromArray(R.index[0]).multiply(h).distanceTo(MMD_SA._v3b.fromArray(R.pinky[0]).multiply(h)))/2/Te.shoulder_width;const y=MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent/100;const b=Math.max(Pe.video_canvas.width,Pe.video_canvas.height)/Te.shoulder_width;Ee.filter(Math.max(3-Math.max(b-5,0),0)/3);palm_far_scale=(1.8+(1-Math.min(Math.max(b-4,0),1))*.4)*((1-MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent/100)*2);ke[k].filter(Math.min(Math.max(g-y,0)/Math.max(y*palm_far_scale-y,.1),1))}if(p.worldLandmarks){R=p.worldLandmarks.annotations;h.set(1,1,1)}A.push(k+"手");let i=u==1?[R.index[0],R.ring[0]]:[R.ring[0],R.index[0]];let o,n,a;let s=MMD_SA._v3a_.fromArray(R.palm[0]).multiply(h).sub(MMD_SA._v3b.fromArray(R.middle[0]).multiply(h)).normalize();s.x=s.x*W;let r=MMD_SA._v3b_.fromArray(i[0]).multiply(h).sub(MMD_SA._v3b.fromArray(i[1]).multiply(h)).normalize();r.z=r.z*W;r.y=r.y*W;let _=MMD_SA.TEMP_v3.crossVectors(r,s).normalize();r.crossVectors(s,_);qe.set(r.x,r.y,r.z,0,s.x,s.y,s.z,0,_.x,_.y,_.z,0,0,0,0,1);Ue.setFromBasis(qe);let l=new THREE.Quaternion;l.copy(Ue).conjugate();if(S.enabled){const v=S.angle*Math.PI/180;const w=MMD_SA._q2.set(Math.sin(v/2),0,0,Math.cos(v/2));l.premultiply(w)}Ye.add("skin",k+"手首",{after_IK:true,rot:l,onProcessRotation:ce});Ye.add("skin",k+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion});const f=MMD_SA.TEMP_v3.setEulerFromQuaternion(l,"YXZ").y;const M=1;const P=(Math.abs(f)<Math.PI/6?1:Math.abs(Math.abs(f)-Math.PI)<Math.PI/6?-1:0)*M;const I=Math.max((Math.abs(f)-Math.PI/2)*M,0)/(Math.PI/2);let d=new THREE.Quaternion;let c=MMD_SA_options.model_para_obj.finger_base;let E=He.copy(Ue);E.x*=-1;E.z*=-1;let x=k=="左"?1:-1;Ke.forEach((p,h)=>{let f=c[(W==1?k:k=="左"?"右":"左")+h];let M=f.base_index+(h==0?0:-1);let g=R[it[h]];let y=Oe.copy(E);const b="XZY";if(P&&h>0){const e=Math.max(MMD_SA._v3a.fromArray(g[2]).sub(MMD_SA._v3b.fromArray(g[1])).length()*1.2,MMD_SA._v3a.fromArray(R.palm[0]).sub(MMD_SA._v3b.fromArray(g[0])).length()*(P==1?.2:.3));const S=MMD_SA._v3a.fromArray(g[1]).sub(MMD_SA._v3b.fromArray(g[0]));if(e/S.length()>1){const t=-P*Math.sqrt(e*e-(S.x*S.x+S.y*S.y))-S.z;for(let e=1;e<3;e++)g[e][2]+=t}}const v=k+p+"指"+Ge[f.base_index];const w=h==0?1:0;for(let u=M;u<3;u++){let e=k+p+"指"+Ge[f.base_index+(u-M)];let t=MMD_SA._v3a.fromArray(g[u+0]);let i=MMD_SA._v3b.fromArray(g[u+1]);let o=MMD_SA.TEMP_v3.fromArray(u==M?R.palm[0]:g[u-1]);t.y=-t.y;i.y=-i.y;o.y=-o.y;let n=MMD_SA._v3a_.copy(t).sub(o);let a=MMD_SA._v3b_.copy(i).sub(t);n.normalize();a.normalize();let s,r;let _;n.applyQuaternion(y);a.applyQuaternion(y);if(u==M){let e=MMD_SA.TEMP_q.set(0,0,0,1);e.setFromVectorSpherical(MMD_SA.TEMP_v3.set(0,1,0),n).conjugate();a.applyQuaternion(e);y.multiplyQuaternions(e,y)}let l=MMD_SA._q1.set(0,0,0,1);let d=MMD_SA._q2.set(0,0,0,1);n.set(0,1,0);_=Ce.setFromVectorSpherical(n,a);l.setFromEuler(_,b);d.copy(l);if(Math.abs(_.z)>Math.PI/(h==0?1.1:2.5)||_.x>Math.PI/(h==0?1.1:3)){_.set(-Math.abs(n.angleTo(a)),0,0)}if(h==0&&u>M+1){_.x=0}else if(_.x>0){_.x*=h==0?0:u>M?0:.75}else{_.x=Math.max(_.x,-Math.PI/(h==0?1.25:2))}if(h==0||u==M){_.z+=(h-2)/2*Math.PI/8*x*(h>0?1:.5);_.z*=h>0?Math.min(Math.max(Math.PI/2-Math.abs(_.x),0)/(Math.PI/2.5),1):1}else{_.z=0}if(I&&h>0&&u==M){const S=MMD_SA._v3a.fromArray(g[u+1]);S.y*=-1;S.applyQuaternion(E);const D=MMD_SA._v3b.fromArray(g[u+3]);D.y*=-1;D.applyQuaternion(E);if(S.y>D.y){_.x-=Math.abs(_.z)*I;_.z*=1-I}}_.y=0;if(h==0&&u==w)_.multiplyScalar(1.5);if(h==0)y.multiplyQuaternions(l.conjugate(),y);l.setFromEuler(_,b);if(h>0){y.multiplyQuaternions(l.conjugate(),y);l.conjugate()}let c=e;let m=l.toAxisAngle();r=m[0];s=m[1];r.z*=-1;const A=!MMD_SA.THREEX.enabled&&h==0?Math.min((Math.PI/8-We[v]._axis_rot_offset_inv_z*x)/(Math.PI/8),1.5):1;if(!MMD_SA.THREEX.enabled&&h==0)r.applyEuler(MMD_SA.TEMP_v3.set(0,Math.PI/4*x*A,0));r.applyEuler(ze.set(MMD_SA.THREEX.enabled?Math.PI/2:0,-Math.PI/2*x,0),"YXZ");if(MMD_SA.THREEX.enabled){l.setFromAxisAngle(r,s)}else{r.applyQuaternion(We[c].axis_rot);l.setFromAxisAngle(r,s)}if(u==w)l.premultiply(MMD_SA.TEMP_q.set(0,0,0,1).slerp(We[v].axis_rot_offset_inv,h==0?.5*A:1));if($[k]){if(u==M){const e=Ye.skin[k+"手首"][0];if(!e._finger_x)e._finger_x=[];e._finger_x[h]=_.x}}else{Ye.add("skin",e,{absolute:true,rot:l.clone()})}}})}else{const e=m.d;if(Z.motion_tracking_upper_body_only&&(!Z.motion_tracking?.hand_tracking?.stabilize_arm_disabled&&je.stabilize_arm)&&Ye.get_blend_default_motion("skin",e+($[e]?"足首":"手首"))!=0){m.visible=false}}})}else if(r){_.forEach(function(e,t){let i=t==0?"左":"右";if(c[i]){Ye.add("skin",i+"手首",{after_IK:true,rot:c[i],onProcessRotation:ce});Ye.add("skin",i+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}})}const h={};const f={};_.forEach(function(e,t){let s=t==0?"左":"右";const o=Z.motion_tracking?.hand_tracking?.rotation_reference?.[s=="左"?"left":"right"];if(o){let a=o.weight||1;if(o.type=="object3D"){const i=MMD_SA.THREEX._XR_Animator_scene_.object3D_list.find(e=>e.id==o.name);if(!i)return;const n=MMD_SA.THREEX._object3d_list_.find(e=>e.uuid==i._object3d_uuid);if(n._rot_aligned_&&n.parent_bone.name==s+"手首"){if(n._rot_aligned_weight_!=null)a=n._rot_aligned_weight_}f[s]=o.weight_by_angle_difference;h[s]=o.constrained_direction}if(o.weight_by_magnet){const r=Z.motion_tracking.arm_tracking?.transformation?.position?.magnet?.find(e=>e.magnet_id==o.weight_by_magnet.id);a=r&&r._frame_count_>=EV_sync_update.count_frame-1-(je.use_hands_worker?6:0)?r._weight_*(o.weight_by_magnet.max||a):0}if(!X.find(e=>e.d==s)?.handpose?._used){a=1}a=xe[s].filter(a);p[s]=a;if(a){if(!Ye.skin[s+"手首"]){const _=new THREE.Quaternion;Ye.add("skin",s+"手首",{after_IK:true,rot:_,onProcessRotation:ce});Ye.add("skin",s+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}else if(Ye.skin[s+"手首"][0].timestamp<RAF_timestamp-100){Ye.skin[s+"手首"][0]._rot_parent=null}}a=o.fingers_weight||Math.min(a*(o.fingers_weight_scale||1),1);if(a){if(o.fingers_from_opposite_hand||o.fingers){const i=["０","１","２","３"];const l={thumb:"親",index:"人",middle:"中",ring:"薬",pinky:"小"};if(o.fingers_from_opposite_hand){const d=s=="左"?"右":"左";Object.values(l).forEach(n=>{i.forEach(e=>{const t=s+n+"指"+e;const i=d+n+"指"+e;let o=Ye.skin[i]?.[0].rot;if(o){o=MMD_SA.TEMP_q.copy(o);o.y*=-1;o.z*=-1;if(!Ye.skin[t]){Ye.add("skin",t,{absolute:true,rot:o.clone()})}else{Ye.skin[t][0].rot.slerp(o,a)}}})})}else if(o.fingers){for(const c in o.fingers){let[e,t]=c.split("|");e=l[e];t=i[parseInt(t)+(e=="親"?-1:0)];e=s+e+"指"+t;const m=Ye.skin[e];if(m&&m[0].timestamp==RAF_timestamp){const u=o.fingers[c];let e=MMD_SA.TEMP_q;if(u.w==null){e=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(u).multiplyScalar(Math.PI/180));u.x=e.x;u.y=e.y;u.z=e.z;u.w=e.w}else{e.copy(u)}m[0].rot.slerp(e,a)}}}}}}});for(const j of["左","右"]){const M=Ye.skin[j+"手首"];if(M){M[0]._rot_pose=c[j];M[0]._rot_pose_ratio=p[j];M[0]._rot_pose_constrained=h[j];M[0]._rot_pose_ratio_by_angle_difference=f[j];if(!M[0]._finger_x)M[0]._finger_x=M[1]._finger_x}}const u=[];G.forEach(function(n){var a=n.d;let s=Z.motion_tracking?.hand_tracking?.depth_adjustment_disabled?0:MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent/100;if(s&&je.enabled&&Q&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=a){let i=ke[a].filter();let e=(RAF_timestamp-ke[a].timestamp)/1e3;let o=1-Math.min(Math.max(e-.2,0)/(1-.2),1);if(o){let e=Ee.filter();s*=o*e;let t=i*MMD_SA_options.model_para_obj.left_arm_length*s+n.pos.z*(1-s);const r=Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-n.pos.x*n.pos.x-n.pos.y*n.pos.y);t=Math.min(t,r);n.pos.z=t}}if($[a]){if(n.IK_disabled)return;Te.enable_IK(a+"足ＩＫ",true);if(Ye.skin[a+"手首"]&&Ye.skin[a+"腕"]&&Ye.skin[a+"手首"][0].timestamp==Ye.skin[a+"腕"][0].timestamp){let e;if(e){}else{const o=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI/2,0,0));const _=Ye.skin[a+"手首"][0].rot.premultiply(o).multiply(o.conjugate());Ye.add("skin",a+"足首",{after_IK:true,rot:_,_finger_x:Ye.skin[a+"手首"][0]._finger_x,absolute:true,onFinish:K})}}else{const l=Ye.skin[a+"足首"];if(l){l[0].rot_parent=l[0]._rot_parent}}Ye.remove("skin",a+"手首");Ye.remove("skin",a+"腕");Ye.remove("skin",a+"ひじ");Ye.remove("skin",a+"手捩");Ye.remove("skin",a+"腕ＩＫ");if(je.enabled){Ke.forEach((t,e)=>{let i=e==0?0:1;for(let e=i;e<i+3;e++)Ye.remove("skin",a+t+"指"+Ge[e])})}const t=(new THREE.Vector3).copy(n.pos);const e=m.transformation?.position;const i=q(a+"足ＩＫ",t,e,e=>{const t=MMD_SA_options.model_para_obj.left_leg_length;e.y+=t*1/3;e.z+=t*.25;e.multiplyScalar(1.5)});u.push({d:a,pos:t,rot:i[1]})}else{Te.enable_IK(a+"腕ＩＫ",!n.IK_disabled);if(!n.IK_disabled){if(n.pos.z==null)n.pos.z=n.pos.z_posenet||(Te.use_3D_pose?0:MMD_SA_options.model_para_obj.left_arm_length*.2);const d=X.find(e=>e.d==a)?.visible;const c=(new THREE.Vector3).copy(n.pos);Ye.add("skin",a+"腕ＩＫ",{priority:999,pos:c,_IK_absolute:n.IK_absolute,_hand_visible:d,onProcessPosition:U})}const e=Ye.skin[a+"手首"];if(e){e[0].rot_parent=e[0]._rot_parent}}});if(u.length&&m.transformation?.position?.process)m.transformation.position.process(u);u.forEach(e=>{const t=e.d;const i=e.pos;i.y+=MMD_SA_options.model_para_obj.left_leg_IK[1]+(n["センター"].position.y-n["センター"].pmxBone.origin[1]);if(e.rot){Ye.add("skin",t+"足",{absolute:true,rot:e.rot,onFinish:function(e,t){this.skin[t][0]._rot_=e.bones_by_name[t].quaternion.clone()}})}else{Ye.remove("skin",t+"足")}Ye.remove("skin",t+"ひざ");Ye.add("skin",t+"足ＩＫ",{absolute:true,priority:999,pos:i})});if(Xe){if(Z.motion_tracking_upper_body_only){for(const j of["左","右"]){Te.enable_IK(j+"腕ＩＫ",Z.has_arm_IK)}}}else if(Z.motion_tracking_upper_body_only){for(const j of["左","右"]){const L=!X.find(e=>e.d==j)?.visible;if($[j]){Ye.set_blend_default_motion("skin",j+"足ＩＫ",L);Ye.set_blend_default_motion("skin",j+"足",L);Ye.set_blend_default_motion("skin",j+"ひざ",L);Ye.set_blend_default_motion("skin",j+"足首",L)}else{if(Z.has_leg_IK){Ye.set_blend_default_motion("skin",j+"足ＩＫ",true);Ye.remove("skin",j+"足首")}else{Ye.set_blend_default_motion("skin",j+"足",true);Ye.set_blend_default_motion("skin",j+"ひざ",true);Ye.set_blend_default_motion("skin",j+"足首",true)}Te.enable_IK(j+"足ＩＫ",Z.has_leg_IK);Te.enable_IK(j+"つま先ＩＫ",Z.has_leg_IK);Ye.set_blend_default_motion("skin",j+"肩",L);Ye.set_blend_default_motion("skin",j+"腕",L);Ye.set_blend_default_motion("skin",j+"ひじ",L);Ye.set_blend_default_motion("skin",j+"手捩",L);Ye.set_blend_default_motion("skin",j+"手首",L);Ye.set_blend_default_motion("skin",j+"腕ＩＫ",L);if(je.enabled){Ke.forEach((t,e)=>{let i=e==0?0:1;for(let e=i;e<i+3;e++)Ye.set_blend_default_motion("skin",j+t+"指"+Ge[e],L)})}}}}Le+=System._browser.motion_control.debug_msg;Le+=(Le?"":"\n")+"P-FPS:"+Math.round(ue)+"/"+Math.round(Y.fps||0)+(je.use_hands_worker?"\nH-FPS:"+Math.round(Me):"");System._browser.motion_control.process({posenet_data:Y});if(Pe.motion_recorder.speed){const F=Pe.motion_recorder.stats;Le+="\n🔴 "+Pe.motion_recorder.time+"(-"+F[0]+"/"+F[1]+"-"+F[3]+"/"+F[2]+"-"+F[4]+")"}if(Le&&!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden&&(Te.use_holistic?!Y.facemesh:!Ie.enabled)){System._browser.on_animation_update.add(()=>{DEBUG_show((Te.use_holistic&&"(no facemesh data)\n"||"")+(Fe?"\n"+Fe+"\n":"")+Le+"\n"+"FPS:"+EV_sync_update.fps_last)},0,0)}if(Y.facemesh){Ie.worker_onmessage({data:Y.facemesh})}if(N&&Ie.worker_initialized){let e={posenet:N,w:Pe.video_canvas.width,h:Pe.video_canvas.height,flip_canvas:Pe.display_flipped};if(Y.handpose&&Y.handpose.length)e.handpose=Y.handpose;if(Y.facemesh)e.facemesh=Y.facemesh.faces;if(Te.use_holistic||!Ie.enabled){e.draw_canvas=true;if(self.FacemeshAT){e.canvas=Pe.video_canvas_facemesh}else if(!Pe.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){e.canvas=Pe.video_canvas_facemesh.transferControlToOffscreen();Pe.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}}Re.postMessage(e,e.canvas?[e.canvas]:undefined)}$e=0}W()}}();function W(e){async function t(){var e=Te.enabled&&Te.worker_initialized&&E&&!Te.busy&&P&&Te.camera_video_timestamp!=E;if(!e)return;$e=RAF_timestamp;Te.camera_video_timestamp=E;Te.camera_video_frame_id=x;if(Te.use_holistic&&Ie.blink_detection){MMD_SA_options.auto_blink=Ie.auto_blink||false}let t,i,o;t=Pe.video_canvas;i=t.width;o=t.height;let n=self.PoseAT?t:I?await createImageBitmap(t):t.getContext("2d").getImageData(0,0,i,o).data.buffer;Te._timestamp=Pe.video_timestamp;let a={rgba:n,w:i,h:o,options:{video_flipped:Pe.video_flipped,use_canvas_hands:!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only&&!Te.use_holistic,use_holistic:Te.use_holistic,use_posenet:true,use_handpose:je.enabled,use_hands_worker:je.use_hands_worker,skip_hand_countdown_max:Te.skip_hand_countdown_max,model_quality:MMD_SA_options.user_camera.ML_models.pose.model_quality||"",z_depth_scale:MMD_SA_options.user_camera.ML_models.pose.z_depth_scale,timestamp:Te._timestamp}};Object.assign(a.options,MMD_SA.MMD.motionManager.para_SA.motion_tracking?.hand_tracking?.mocap_options);let s=[a.rgba];if(!Te.canvas_hands){const r=Te.canvas_hands=document.createElement("canvas");r.width=r.height=768;a.canvas_hands=r.transferControlToOffscreen();s.push(a.canvas_hands)}if(je.use_hands_worker&&!je.canvas_hands_worker){const r=je.canvas_hands_worker=document.createElement("canvas");r.width=r.height=768;a.canvas_hands_worker=r.transferControlToOffscreen();s.push(a.canvas_hands_worker)}v.postMessage(a,s);s.length=0;s=undefined;a.rgba=n=undefined;a=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}}var Q=function(){const s=()=>{};var r,_;var Y={};var Z={},$={},J={};var ee={};var te,ie;window.addEventListener("jThree_ready",e=>{r=new THREE.Vector3;_=new THREE.Quaternion;for(const t of["センター","上半身","上半身2","首","頭"]){Y[t]=new THREE.Quaternion}for(const i of["左","右"]){ee[i]={target:new THREE.Vector3,arm_pos:new THREE.Vector3};Z[i]={target:new THREE.Vector3,effector:new THREE.Quaternion,links:[]};$[i]={effector:new THREE.Quaternion,links:[]};J[i]={effector:new THREE.Quaternion,parent:new THREE.Quaternion,links:[]};for(let e=0;e<2;e++){Z[i].links[e]=new THREE.Quaternion;$[i].links[e]=new THREE.Quaternion;J[i].links[e]=new THREE.Quaternion}}te=new System._browser.data_filter([{type:"one_euro",id:"hip_rot",para:[30,1,.2,.2,4]}]);ie=new System._browser.data_filter([{type:"one_euro",id:"hip_mov",para:[30,1,.2,.2,3]}])});const l=250;const d=500;const c=0;function e(e,t,i){if(!this[e][t])return 0;const o=this[e][t][0];let n;if(o._blend_default_motion>0){n=Math.min((RAF_timestamp-o._blend_default_motion)/d,1)}else if(o._blend_default_motion<0){n=1-Math.min((RAF_timestamp+o._blend_default_motion)/l,1)}else{n=0}if(n==0){this[e][t].forEach(e=>{e._blend_default_motion=0})}else if(i){const e=2;n=n<.5?Math.pow(n*2,e)*.5:.5+Math.pow((n-.5)*2,1/e)*.5}return n}function t(e,t,i,o){if(!this[e][t]){if(!i)return;const n=t.indexOf("ＩＫ")!=-1;const a={_blend_default_motion:i?1:0};if(n)a.pos=new THREE.Vector3;else a.rot=new THREE.Quaternion;this.add("skin",t,a)}else{const s=this[e][t][1];const r=this[e][t][1]._blend_default_motion;if(i){if(this.reset_to_default_motion_once){s._idle_blend_default_motion=0;s._blend_default_motion=1}else if(!s._blend_default_motion){if(!s._idle_blend_default_motion)s._idle_blend_default_motion=RAF_timestamp;if(RAF_timestamp-s._idle_blend_default_motion>=(typeof o=="number"?o:c)){s._idle_blend_default_motion=0;s._blend_default_motion=RAF_timestamp-RAF_timestamp_delta}}else if(s._blend_default_motion<0){s._blend_default_motion=RAF_timestamp-this.get_blend_default_motion(e,t)*d}}else{s._idle_blend_default_motion=0;if(s._blend_default_motion>0){s._blend_default_motion=-(RAF_timestamp-(1-this.get_blend_default_motion(e,t))*l)}}this[e][t][0]._blend_default_motion=s._blend_default_motion;this[e][t][0]._idle_blend_default_motion=s._idle_blend_default_motion}if(!this["_"+e][t])this["_"+e][t]={pos:new THREE.Vector3,rot:new THREE.Quaternion}}const i=new RegExp("("+toRegExp(["腕"],"|")+")$");function oe(i,o){const e=THREE.MMD.getModels()[i._model_index];const n=MMD_SA.motion[e.skin._motion_index].para_SA;let t;const a=i.bones_by_name;const s=a[o];const r=this.skin[o];if(Te.enabled&&!Te.data_detected_stable)return;if(r[0].info[1]=="facemesh"){}let _,l;r[0].t_delta+=RAF_timestamp_delta;let d=Math.max(Math.min(r[0].t_delta/r[0].t_delta_frame,1),0);if(r[0].rot){if(r[0].after_IK){t=!s._update_IK_and_AddTrans||s._update_IK_and_AddTrans.length;if(t){if(s.quaternion.x||s.quaternion.y||s.quaternion.z){s.quaternion.conjugate();e._update_IK_and_AddTrans(false,o);s.quaternion.conjugate()}}}if(r[0].onProcessRotation){r[0].onProcessRotation.call(this,i,o)}else{let t=He.set(0,0,0,1);if(r[0].absolute){s.quaternion.set(0,0,0,1)}else{let e;if(n.motion_tracking_upper_body_only){if(o.indexOf("上半身")!=-1){e=n.motion_tracking?.motion_default_weight?.upper_body}else if(o.indexOf("肩")!=-1){e=n.motion_tracking?.motion_default_weight?.shoulder}}if(e==null)e=1;if(e<1)s.quaternion.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-e)}if(r[0].parent_based){let e=r[0].rot_parent;if(!e){e=MMD_SA.get_bone_rotation_parent(i,o,i).conjugate()}r[0]._rot_parent=e;t.copy(e)}t.multiply(r[0].no_blending?r[0].rot:MMD_SA.TEMP_q.copy(r[1].rot).slerp(r[0].rot,d));const m=r[0].ratio_euler;if(m){const p=MMD_SA.TEMP_v3.setEulerFromQuaternion(t,m.order);const h=r[0].ratio<1?r[0].ratio:1;p.x*=m.x*h;p.y*=m.y*h;p.z*=m.z*h;t.setFromEuler(p,m.order)}else if(r[0].ratio<1){t.slerp(Oe.set(0,0,0,1),1-r[0].ratio)}const u=MMD_SA_options.model_para_obj_all[i._model_index].skin_default[o];if(u&&u.rot_scale){if(typeof u.rot_scale=="number")u.rot_scale={x:u.rot_scale,y:u.rot_scale,z:u.rot_scale};t.setFromEuler(MMD_SA.TEMP_v3.setEulerFromQuaternion(t,"YXZ").multiply(u.rot_scale),"YXZ")}s.quaternion.multiply(t);_=Ze.active&&!r[0].motion_recorder_disabled&&o.indexOf("ＩＫ")==-1}}if(r[0].pos){if(r[0].onProcessPosition){r[0].onProcessPosition.call(this,i,o)}else{if(r[0].absolute)s.position.set(0,0,0);const f=MMD_SA.TEMP_v3.copy(r[1].pos).lerp(r[0].pos,d);s.position.add(f);l=Ze.active&&!r[0].motion_recorder_disabled&&o.indexOf("ＩＫ")==-1}}r[0].onFinish&&r[0].onFinish.call(this,i,o);if(_)Ze.set_boneKey(o,null,s.quaternion,true);if(l)Ze.set_boneKey(o,ze.copy(s.position).sub(Ce.fromArray(s.pmxBone.origin)),null,true);const c=this.get_blend_default_motion("skin",o,true);if(c){if(r[0].rot&&this._skin[o]?.rot){const M=MMD_SA.TEMP_q.copy(this._skin[o].rot);s.quaternion.slerp(this._skin[o].onProcessRotation&&this._skin[o].onProcessRotation.call(this,i,o,M)||M,c)}if(r[0].pos&&this._skin[o]?.pos){s.position.lerp(this._skin[o].pos,c)}if(Ze.active&&!r[0].motion_recorder_disabled){if(o.indexOf("ＩＫ")!=-1)Ze.set_boneKey(o,r[0].pos&&s.position,r[0].rot&&s.quaternion,false)}}t&&e._update_IK_and_AddTrans(false,o)}var ne=0;function o(e){function a(){if(D)return;D=Y;for(const e of["センター","上半身","上半身2","首"]){const t=this.skin[e];if(!t){D[e].set(0,0,0,1);continue}if(e=="首"){D[e].copy(t[0]._rot_neck||t[1]._rot_neck||MMD_SA._q1.set(0,0,0,1));D["頭"].copy(t[0]._rot_head||t[1]._rot_head||MMD_SA._q1.set(0,0,0,1))}else{const i=MMD_SA._q1.set(0,0,0,1);const o=Math.max(Math.min((t[0].t_delta+RAF_timestamp_delta)/t[0].t_delta_frame,1),0);i.multiply(t[0].no_blending?t[0].rot:MMD_SA.TEMP_q.copy(t[1].rot).slerp(t[0].rot,o));if(t[0].ratio<1)i.slerp(MMD_SA._q2.set(0,0,0,1),1-t[0].ratio);D[e].copy(i)}}s=MMD_SA._q1.copy(D["センター"]).multiply(D["上半身"]).multiply(D["上半身2"]).conjugate()}function z(e){const t=["センター","上半身","上半身2","首","頭"];let o;const n=k&&k.parent;const a=ze.set(0,0,0);if(n){const f=n.name||e+"足";const M=f.charAt(0);const g=1-this.get_blend_default_motion("skin",f.indexOf("足")!=-1?M+"足ＩＫ":f,true);let t,i;switch(f){case"頭":o=g&&this.skin["首"];if(o){for(const f of["首","頭"])S[f].quaternion.copy(D[f]);t=MMD_SA.get_bone_position(w,"頭","首").add(Ce.set(0,.75,.75).applyQuaternion(MMD_SA.TEMP_q.copy(S["首"].quaternion).multiply(S["頭"].quaternion)));S["首"].quaternion.copy(this._body_motion_rot[0]["首"]);S["頭"].quaternion.copy(this._body_motion_rot[0]["頭"]);i=MMD_SA.get_bone_position(w,"頭","首").add(Ce.set(0,.75,.75).applyQuaternion(MMD_SA.TEMP_q.copy(S["首"].quaternion).multiply(S["頭"].quaternion)))}break;case"左足":case"右足":o=g;if(o){if(!$[M].updated){Z[M].enabled=true;o=false}}else{Z[M].enabled=false;$[M].updated=0}if(o){const y=Ce.fromArray(S[e+"ひざ"].pmxBone.origin).sub(Be.fromArray(S[f].pmxBone.origin));t=Be.copy(y).applyQuaternion(He.copy(J[M].parent).multiply(J[M].links[1]));i=y.applyQuaternion(He.copy(J[M].parent).multiply($[M].links[1]))}break}if(o){o=f;a.copy(t).sub(i);let e=n.weight||.5;if(typeof e=="object"){a.x*=a.x<0?e.x.left:e.x.right;a.y*=a.y<0?e.y.down:e.y.up;a.z*=a.z<0?e.z.backward:e.z.forward}else{a.multiplyScalar(e)}a.multiplyScalar(g)}}let i,s,r;for(const f of t)S[f].quaternion.copy(this._body_motion_rot[0][f]);const _=A.motion_tracking?.arm_tracking?.elbow_lock?.[e=="左"?"left":"right"];if(_){_._elbow_y=_.y_absolute!=null?_.y_absolute:MMD_SA.get_bone_position(w,e+"ひじ",w).y+(_.y||0)}if(!o||o!="頭"){i=MMD_SA.get_bone_position(w,e+"腕",w);r=MMD_SA.get_bone_rotation_parent(w,e+"腕ＩＫ",w);s=!A.has_arm_IK?MMD_SA.get_bone_position(w,e+"手首",w):(new THREE.Vector3).copy(S[e+"腕ＩＫ"].position).sub(MMD_SA_options.model_para_obj.arm_IK_offset[e]).applyQuaternion(r).add(i);r.conjugate()}for(const f of t)S[f].quaternion.copy(this._body_motion_rot[1][f]);if(!i){i=MMD_SA.get_bone_position(w,e+"腕",w);r=MMD_SA.get_bone_rotation_parent(w,e+"腕ＩＫ",w);s=!A.has_arm_IK?MMD_SA.get_bone_position(w,e+"手首",w):(new THREE.Vector3).copy(S[e+"腕ＩＫ"].position).sub(MMD_SA_options.model_para_obj.arm_IK_offset[e]).applyQuaternion(r).add(i);r.conjugate()}for(const f of["センター","上半身","上半身2"]){let e;if(f.indexOf("上半身")!=-1)e=A.motion_tracking?.motion_default_weight?.upper_body;if(e==null)e=1;if(this.skin[f]){if(e<1)S[f].quaternion.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-e);S[f].quaternion.multiply(D[f])}}let l=k&&k.default_position_weight;if(typeof l!="number")l=.5;const d=MMD_SA.get_bone_rotation_parent(w,e+"腕ＩＫ",w).conjugate();let c;let m=A.motion_tracking?.arm_tracking?.IK_constraint;if(m)m=m[e=="左"?"left":"right"]||m;if(m&&this.skin[e+"腕ＩＫ"]&&this.get_blend_default_motion("skin",e+"腕ＩＫ")<1){const b=ee[e];b.enabled=true;b.target.copy(s);b.target_radius=0;if(m.target_offset){const v=ze.fromArray(m.target_offset);b.target.add(v);b.target_radius=v.length()}if(m.target_radius)b.target_radius+=m.target_radius;c=MMD_SA.get_bone_position(w,e+"腕",w);b.arm_pos.copy(c)}c=l==0?i:(c||MMD_SA.get_bone_position(w,e+"腕",w)).lerp(i,1-l);const u=c.sub(s);if(l<1)d.slerp(r,1-l);if(o&&o.indexOf("足")!=-1){a.applyQuaternion(d)}const p=Pe.x_flipped?-1:1;u.x*=p;u.y*=-1;u.z*=-1;if(o&&o=="頭"){u.applyQuaternion(d)}else{u.applyQuaternion(d)}if(!this._skin[e+"腕ＩＫ"])this._skin[e+"腕ＩＫ"]={pos:new THREE.Vector3,rot:new THREE.Quaternion};if(!this._skin[e+"腕ＩＫ"].rot_parent_inv)this._skin[e+"腕ＩＫ"].rot_parent_inv=new THREE.Quaternion;this._skin[e+"腕ＩＫ"].rot_parent_inv.copy(d).conjugate();u.add(MMD_SA_options.model_para_obj.arm_IK_offset[e]);u.add(a);for(const f of t)S[f].quaternion.copy(this._body_motion_rot[1][f]);const h=this.skin[e+"手首"];if(h){if(O){h[0].after_IK=true;if(this._skin[e+"手首"])this._skin[e+"手首"]._rot_absolute=MMD_SA.get_bone_rotation(w,e+"手首",false,w)}if(this._skin[e+"手首"])this._skin[e+"手首"].onProcessRotation=C;if(this._skin[e+"手捩"])this._skin[e+"手捩"].onProcessRotation=B}return u}function C(e,t,i){const o=t.charAt(0);const n=A.motion_tracking&&A.motion_tracking.arm_default_stickiness&&(A.motion_tracking.arm_default_stickiness[o]||A.motion_tracking.arm_default_stickiness).default_rotation_weight;if(!n)return i;const a=MMD_SA.get_bone_rotation_parent(e,t,e).conjugate();const s=a.multiply(this._skin[t]._rot_absolute);return s.slerp(i,1-n)}function B(e,t,i){return i.set(0,0,0,1)}function t(){if(Te.data_detected){ae();System._browser.on_animation_update.remove(t,0)}}const i=e.detail.model;const H=MMD_SA.THREEX.get_model(i._model_index).is_T_pose;const w=i.mesh;const S=w.bones_by_name;const A=MMD_SA.motion[i.skin._motion_index].para_SA;for(const r of["左","右"]){const o=A.motion_tracking?.hand_tracking?.rotation_reference?.[r=="左"?"left":"right"];if(!o)continue;hand_f=Ye.skin[r+"手首"]?.[0];if(!hand_f||!hand_f._rot_pose_ratio)continue;let e;if(o.type=="object3D"){const _=MMD_SA.THREEX._XR_Animator_scene_.object3D_list.find(e=>e.id==o.name);if(!_)return;const l=MMD_SA.THREEX._object3d_list_.find(e=>e.uuid==_._object3d_uuid);if(l._rot_aligned_&&l.parent_bone.name==r+"手首"){e=l._rot_aligned_}else{e=l._mesh.quaternion.clone()}if(o.offset){if(o.offset=="parent_bone"){const d=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-l.parent_bone.rotation.x,-l.parent_bone.rotation.y,l.parent_bone.rotation.z).multiplyScalar(Math.PI/180),"YXZ").toAxisAngle();e.multiply(MMD_SA.TEMP_q.setFromAxisAngle(d[0].applyQuaternion(He.copy(Qe[r=="左"?1:-1]).conjugate()),d[1]))}else{if(o.offset.w==null){const c=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(o.offset).multiplyScalar(Math.PI/180));o.offset.x=c.x;o.offset.y=c.y;o.offset.z=c.z;o.offset.w=c.w}e.multiply(MMD_SA.TEMP_q.copy(o.offset))}}}else{if(o.rotation){if(o.rotation.w==null){const c=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(o.rotation).multiplyScalar(Math.PI/180));o.rotation.x=c.x;o.rotation.y=c.y;o.rotation.z=c.z;o.rotation.w=c.w}e=MMD_SA.TEMP_q.copy(o.rotation)}}if(!hand_f._rot_pose)hand_f._rot_pose=new THREE.Quaternion;if(e){hand_f._rot_pose.copy(e)}else{hand_f._rot_pose.set(0,0,0,1)}}if(!this._reset_disabled&&this._motion_path&&(this._motion_path!=A._path||this._motion_tracking_upper_body_only!=!!A.motion_tracking_upper_body_only)){this._motion_path=A._path;this._motion_tracking_upper_body_only=!!A.motion_tracking_upper_body_only;this.reset();se();Te.data_detected=0;Te.initial_data_detected=false;System._browser.on_animation_update.remove(t,0);System._browser.on_animation_update.add(t,0,0,-1);return}this._motion_path=A._path;this._motion_tracking_upper_body_only=!!A.motion_tracking_upper_body_only;if(Ze.enabled&&ne!=Te.data_detected){ne=Te.data_detected;Ze.timestamp_for_recording=RAF_timestamp;if(Ze.active)window.dispatchEvent(new CustomEvent("SA_motion_recorder_on_active",e))}for(const r of["左","右"]){this.arm_IK_constraint[r].enabled=false}et.copy(this.get_upper_body_rotation()).multiply(this._rot_body_camera_offset);this.upper_body_rotation_limiter(et);let D,s,k,O;if((Te.enabled||Ie.enabled)&&A.motion_tracking_upper_body_only){const m=A.motion_tracking&&A.motion_tracking.arm_as_leg;const u={"左":m&&m.enabled&&(!m.linked_side||m.linked_side=="left"),"右":m&&m.enabled&&(!m.linked_side||m.linked_side=="right")};for(const f in this._skin){this._skin[f].pos.copy(S[f].position);this._skin[f].rot.copy(S[f].quaternion)}const p=Te.hip_adjustment_weight_percent/100;let e=p&&(Te.data_detected||!Te.enabled&&Ie.data_detected);let o,n;if(e){a.call(this);const M=He.copy(s);const h=A.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(h.upper_rotation_offset){const y=h.upper_rotation_offset*Math.PI/180;M.premultiply(MMD_SA.TEMP_q.set(0,Math.sin(y/2),0,Math.cos(y/2)))}M.conjugate();const g=A.motion_tracking?.hip_adjustment?.rotation_weight;o=(new THREE.Quaternion).copy(M).slerp(Oe.set(0,0,0,1),1-(typeof g=="number"?g:.5)*p);let t=Te.hip_adjustment_smoothing_percent/100;if(t)t=.1+(1-t)*(1-t)*.9;if(t){te.filters[0].filter.minCutOff=t;o.fromArray(te.filter(o.toArray()))}this.remove("skin","下半身");this.add("skin","下半身",{no_blending:true,rot:o});if(this.skin["センター"]){let e=A.motion_tracking?.hip_adjustment?.displacement_weight;if(e==null)e=.25;const b=ze;const v=Ce;if(typeof e=="number"){if(e){e*=p;b.set(0,MMD_SA_options.model_para_obj.left_leg_length/3*e,0);v.set(-1,1,-1)}}else{b.copy(e.axis||MMD_SA.TEMP_v3.set(0,e.weight,0)).multiplyScalar(MMD_SA_options.model_para_obj.left_leg_length/3*p);v.copy(e.scale)}v.x*=Te.hip_adjustment_scale_x_percent/100;v.y*=Te.hip_adjustment_scale_y_percent/100;v.z*=Te.hip_adjustment_scale_z_percent/100;const E=Te.hip_adjustment_adjust_y_axis_percent/100;if(E&&!e.axis){const x=Math.PI/4*E;const U=b.y;b.y=U*Math.cos(x);b.z=U*Math.sin(x)}if(e){axis_default=Be.copy(b);M.multiply(MMD_SA.TEMP_q.set(0,0,0,1).slerp(D["首"],Te.hip_adjustment_head_weight_percent/100));b.applyQuaternion(M);b.sub(axis_default).multiply(v);if(t){ie.filters[0].filter.minCutOff=t;b.fromArray(ie.filter(b.toArray()))}this.skin["センター"][0].pos=(this.skin["センター"][0].pos||new THREE.Vector3).copy(b);this.skin["センター"][0]._hip_adjustment_offset=(this.skin["センター"][0]._hip_adjustment_offset||new THREE.Vector3).copy(b);this.skin["センター"][1].pos=this.skin["センター"][0].pos;n=this.skin["センター"][0].pos}}}for(const r of["左","右"]){const P=r=="左"?"left":"right";k=A.motion_tracking&&A.motion_tracking.arm_default_stickiness&&(A.motion_tracking.arm_default_stickiness[P]||A.motion_tracking.arm_default_stickiness);O=k&&k.default_rotation_weight;let i=A.motion_tracking?.hip_adjustment?.[P]?A.motion_tracking.hip_adjustment[P].feet_fixed_weight:A.motion_tracking?.hip_adjustment?.feet_fixed_weight;if(typeof i!="number")i=1;if(i<1||(e||u[r])&&!A.has_leg_IK){const f=r+"足ＩＫ";let e,t;if(o){e=He.copy(S["下半身"].quaternion);S["下半身"].quaternion.multiply(o)}if(n){t=ze.copy(S["センター"].position);S["センター"].position.add(n)}const K=A.has_leg_IK?null:MMD_SA.get_bone_position(w,r+"足","全ての親");const I=i<1?MMD_SA.get_bone_position(w,r+"足首","全ての親"):Ce;if(e)S["下半身"].quaternion.copy(e);if(n)S["センター"].position.copy(t);const R=A.has_leg_IK||i>0?MMD_SA.get_bone_position(w,r+"足首","全ての親"):I;const G=Pe.x_flipped?-1:1;if(A.has_leg_IK){const T=ze.copy(R).sub(I.lerp(R,i));T.x*=G;T.y*=-1;T.z*=-1;if(!this._skin[f])this._skin[f]={pos:new THREE.Vector3,rot:new THREE.Quaternion};this._skin[f].pos.add(T);S[f].position.add(T)}else{const X=ze.fromArray(S[r+"足"].pmxBone.origin);const W=X.sub(K).negate();const T=K.sub(I.lerp(R,i));T.x*=G;T.y*=-1;T.z*=-1;T.add(MMD_SA_options.model_para_obj.leg_IK_offset[r]);T.add(W);if(!this._skin[f])this._skin[f]={pos:new THREE.Vector3,rot:new THREE.Quaternion};this._skin[f].pos.copy(T);if(!u[r]){Te.enable_IK(f,true);if(!this.skin[f])this.add("skin",f,{absolute:true,is_dummy:true,pos:true,priority:999})}S[f].position.copy(T);if(Te.data_detected)S[r+"ひざ"].quaternion.set(0,0,0,1)}S[f].position.y+=this._skin[f]._offset_y_||0}if(u[r]){a.call(this);const T=z.call(this,r);S[r+"腕ＩＫ"].position.copy(T);Te.enable_IK(r+"腕ＩＫ",true)}else{const f=r+"腕ＩＫ";let e;const Q=this.skin[r+"手首"];if(Q){a.call(this);if(!Te.IK_disabled_check(f)){e=z.call(this,r)}else{if(this._skin[r+"腕"])this._skin[r+"腕"].rot.premultiply(s);if(this._skin[r+"手首"])this._skin[r+"手首"].rot.premultiply(MMD_SA.TEMP_q.copy(s).conjugate())}}if(e)this._skin[f].pos.copy(e)}if(Z[r].enabled){const V=S[r+"足ＩＫ"];const j=Z[r];j.target.copy(V.position);const L=V.pmxBone.IK;j.effector.copy(w.bones[L.effector].quaternion);for(let e=0;e<L.links.length;e++)j.links[e].copy(w.bones[L.links[e].bone].quaternion);window.addEventListener("SA_IK_"+(r+"足ＩＫ")+"_onupdate",e=>{e.detail.result.links=j;e.detail.result.links_result=$[r]},{once:true});window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const t=J[r];t.parent.copy(MMD_SA.get_bone_rotation_parent(w,r+"足","全ての親"));t.effector.copy(w.bones[L.effector].quaternion);for(let e=0;e<L.links.length;e++)t.links[e].copy(w.bones[L.links[e].bone].quaternion)},{once:true})}}for(let e=0;e<2;e++){const r=e==0?"左":"右";const F=this.skin[r+"肩"];if(F&&this._skin[r+"肩"]){let e=Math.max(Math.min((F[0].t_delta+RAF_timestamp_delta)/F[0].t_delta_frame,1),0);const N=(F[0]._rot_total||0)*e+(F[1]._rot_total||0)*(1-e);this._skin[r+"肩"].rot.premultiply(MMD_SA.TEMP_q.set(0,0,Math.sin(N/2),Math.cos(N/2)))}}const h=A.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(h.upper_rotation_offset){window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const t=e.detail.model;const i=t.mesh.bones_by_name;let o=h.upper_rotation_offset*Math.PI/180;const n=MMD_SA.TEMP_q.set(0,Math.sin(o/2*-.5),0,Math.cos(o/2*-.5));i["上半身"].quaternion.premultiply(n);i["上半身2"].quaternion.premultiply(n);n.set(0,Math.sin(o/2),0,Math.cos(o/2));i["全ての親"].quaternion.premultiply(n);if(Ze.active){Ze.set_boneKey("上半身",null,i["上半身"].quaternion,false);Ze.set_boneKey("上半身2",null,i["上半身2"].quaternion,false);Ze.set_boneKey("全ての親",null,i["全ての親"].quaternion,false)}},{once:true})}if(Ze.active){window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const t=e.detail.model;const a=t.mesh.bones_by_name;for(const n of["左","右"]){Ze.set_boneKey(n+"足",null,a[n+"足"].quaternion,false);Ze.set_boneKey(n+"ひざ",null,a[n+"ひざ"].quaternion,false);Ze.set_boneKey(n+"足首",null,a[n+"足首"].quaternion,false);if(a[n+"足先EX"])Ze.set_boneKey(n+"足先EX",null,a[n+"足先EX"].quaternion,false);for(const e of[n+"肩",n+"腕",n+"ひじ",n+"手首"]){if(a[e])Ze.set_boneKey(e,null,a[e].quaternion,false)}Ke.forEach((i,e)=>{let o=e==0?0:1;for(let t=o;t<o+3;t++){const e=n+i+"指"+Ge[t];if(a[e]&&!this.skin[e])Ze.set_boneKey(e,null,a[e].quaternion,false)}})}},{once:true})}}if(Te.data_detected)this.reset_to_default_motion_once=false;window.dispatchEvent(new CustomEvent("SA_camera_poseNet_process_bones_onstart",e));var n=this.skin;var q=Object.keys(n).filter(e=>!n[e][0].after_IK).sort((e,t)=>{let i=n[e][0].priority||0;let o=n[t][0].priority||0;return i-o});q.forEach(e=>{let t=S[e];if(!t&&!/_DUMMY_/.test(e))return;var i=n[e][0].info[1];if((!i||/pose/.test(i))&&!A.motion_tracking_enabled)return;oe.call(this,w,e)})}function n(e){var t=e.detail.model;var o=t.mesh;var n=MMD_SA.motion[t.skin._motion_index].para_SA;if(n.motion_tracking_upper_body_only){for(const s of["左","右"]){const r=n.motion_tracking?.arm_tracking?.elbow_lock?.[s=="左"?"left":"right"];if(r){const _=r._elbow_y!=null?r._elbow_y:null;if(_!=null)X(r,o,s)}}}var a=this.skin;var i=Object.keys(a).filter(e=>a[e][0].after_IK).sort((e,t)=>{let i=a[e][0].priority||0;let o=a[t][0].priority||0;return i-o});i.forEach(e=>{let t=o.bones_by_name[e];if(!t&&!/_DUMMY_/.test(e))return;var i=a[e][0].info[1];if((!i||/pose/.test(i))&&!n.motion_tracking_enabled)return;oe.call(this,o,e)});window.dispatchEvent(new CustomEvent("SA_camera_poseNet_process_bones_onended",e))}function a(e){if(Te.enabled&&!Te.data_detected_stable)return;var _=e.detail.model;var l=_.mesh;var d=_.morph.targets;_.pmx.morphs.forEach(function(e){if(e.panel!=3)return;var t=e.name;if(!_.pmx.morphs_weight_by_name[t])return;var i=_.morph.target_index_by_name[t];if(i==null)return;var o=d[i];var n=o.keys[0];if(n.morph_type==1){l.morphTargetInfluences[i]=0}else{let e={name:t,weight:0,morph_type:n.morph_type,morph_index:n.morph_index};_.morph.onupdate(e,e,0,i)}});var c=MMD_SA_options.model_para_obj.facemesh_morph;var m=this.morph;var u={};var n=0;Object.keys(m).forEach(function(e){let t=m[e];if(t.disabled)return;t[0].t_delta+=RAF_timestamp_delta;let i=Math.max(Math.min(t[0].t_delta/t[0].t_delta_frame,1),0);let o=t[0].weight*i+t[1].weight*(1-i);u[e]=o;if(o)n++});Object.keys(u).forEach(function(t){let e=m[t];let i=u[t];if(i<0){Ze.morph_active&&Ze.set_morphKey(t,0,true);switch(t){case"にやり":t="ω";break;case"口角上げ":t="口角下げ";break;case"上":t="下";break}i=-i}if(Ze.morph_active){let e=t;if(t=="まばたきL")e="ウィンク";else if(t=="まばたきR")e="ウィンク右";Ze.set_morphKey(e,i,true)}let o=c[t];let n=o&&o.name||t;let a=_.morph.target_index_by_name[n];if(a==null)return;i*=o&&o.weight||1;let s=d[a];let r=s.keys[0];if(r.morph_type==1){l.morphTargetInfluences[a]=i}else{let e={name:n,weight:i,morph_type:r.morph_type,morph_index:r.morph_index};_.morph.onupdate(e,e,0,a)}})}function m(e,t,i){i.name=t;i.info=e.split("|");var o=i.info[0];var n=this[o][t];if(i.is_dummy){if(n&&n[0].is_dummy)return;i.no_blending=true;i.onProcessPosition=i.onProcessRotation=s;if(i.pos)i.pos=r;if(i.rot)i.rot=_}const a=t.indexOf("指")!=-1||t.indexOf("手首")!=-1;i.timestamp=RAF_timestamp;i.t_delta=0;i.t_delta_frame=je.enabled&&a&&this.t_delta_hands||this.t_delta||0;i.t_delta_frame=Math.max(Math.min(i.t_delta_frame,200),16.6667);if(n){if(RAF_timestamp==n[0].timestamp){n[0]=Object.assign(n[0],i)}else{if(!i.no_blending&&!Pe.video.paused){let e=Te.use_3D_pose||i.info[1]=="facemesh"?.5+Math.max(Math.min((Math.max(i.t_delta_frame,RAF_timestamp-n[0].timestamp)-50)/150,1),0)*.5:1;if(i.pos&&n[0].pos){i.pos.lerp(n[0].pos,1-e)}if(i.rot&&n[0].rot){i.rot.slerp(n[0].rot,1-e)}if(i.weight!=null&&n[0].weight!=null){i.weight=i.weight*e+n[0].weight*(1-e)}}this[o][t]=[i,n[0]]}i._blend_default_motion=n[1]._blend_default_motion;i._idle_blend_default_motion=n[1]._idle_blend_default_motion}else{this[o][t]=[i,i]}if(Ze.speed&&Pe.is_local_video&&Ze.speed<1)i.no_blending=true}function u(e,t){delete this[e][t]}function p(){this.skin={};this.morph={};this._skin={};this._morph={};this.reset_to_default_motion_once=true;this._motion_path=""}function ae(){window.addEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_before_IK",this.process_bones);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}function se(){window.removeEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_before_IK",this.process_bones);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}var h=function(e){this.model_num=e;this.reset();this._body_motion_rot=[{},{}];this._rot_body_motion=new THREE.Quaternion;this._rot_body_camera=new THREE.Quaternion;this._rot_body_camera_offset=new THREE.Quaternion;this._rot_head_camera=new THREE.Quaternion;this._rot_head_camera_offset=new THREE.Quaternion;this._rot_body_offset=new THREE.Quaternion;this._rot_camera=new THREE.Quaternion;this._rot_camera_angle=0;this.process_bones=o.bind(this);this.process_bones_after_IK=n.bind(this);this.process_morphs=a.bind(this)};h.prototype.set_upper_body_rotation=function(e,t){if(!Pe.ML_enabled||this.model_num!=e)return;const i=THREE.MMD.getModels()[this.model_num].mesh.bones_by_name;for(const o of["センター","上半身","上半身2","首","頭"]){if(!i[o])continue;let e=this._body_motion_rot[t][o];if(!e)e=this._body_motion_rot[t][o]=new THREE.Quaternion;e.copy(i[o].quaternion)}};h.prototype.get_upper_body_rotation=function(){const e=THREE.MMD.getModels()[this.model_num].mesh.bones_by_name;this._rot_camera.setFromEuler(MMD_SA.TEMP_v3.set(MMD_SA._rx_last,MMD_SA._ry_last,0));this._rot_camera_angle=this._rot_camera.toAxisAngle()[1];const t=He.set(0,0,0,1);const i=Oe.set(0,0,0,1);for(const n of["センター","上半身","上半身2"]){t.multiply(this._body_motion_rot[0][n]||e[n].quaternion);i.multiply(this._body_motion_rot[1][n]||e[n].quaternion)}this._rot_body_camera.copy(t).conjugate().multiply(i);this._rot_body_camera_offset.copy(this._rot_body_camera).conjugate().multiply(this._rot_camera);this._rot_body_motion.copy(t);const o=S.copy(t).conjugate();return o};h.prototype.upper_body_rotation_limiter=function(t,i=Math.PI/3){var o=t.toAxisAngle();var n=o[1];this._rot_body_offset.set(0,0,0,1);if(Math.abs(n)>i){let e;if(Math.abs(n)<i*2){e=Math.sign(n)*i}else{e=Math.sign(n)*i*(1-(n-i*2)/(Math.PI-i*2))}t.setFromAxisAngle(o[0],e);this._rot_body_offset.setFromAxisAngle(o[0],e-n)}return this._rot_body_offset};h.prototype.offset_upper_body_camera_rotation=function(e,t=1){return e.premultiply(this._q2.copy(this._rot_body_offset).multiply(t==1?this._rot_body_camera:this._q1.set(0,0,0,1).slerp(this._rot_body_camera,t))).multiply(t==1?this._rot_body_camera_offset:this._q1.set(0,0,0,1).slerp(this._rot_body_camera_offset,t))};Object.defineProperty(h.prototype,"camera_weight",{get:function(){return Math.max((Math.PI/2-Math.abs(this._rot_camera_angle))/(Math.PI/2),0)}});Object.defineProperty(h.prototype,"arm_IK_constraint",{get:function(){return ee}});h.prototype.add=m;h.prototype.remove=u;h.prototype.reset=p;h.prototype.add_events=ae;h.prototype.remove_events=se;h.prototype.get_blend_default_motion=e;h.prototype.set_blend_default_motion=t;return h}();let Ye;window.addEventListener("jThree_ready",()=>{Q.prototype._q1=new THREE.Quaternion;Q.prototype._q2=new THREE.Quaternion;Ye=new Q(0)});var Ze=function(){function _(e,t,i,o){this.name=e;this.pos=t&&t.toArray()||[0,0,0];this.rot=i&&i.toArray()||[0,0,0,1];this.time=o;d[e].index=l.boneKeys.length}function s(e,t,i){this.name=e;this.weight=t;this.time=i;r[e].index=l.morphKeys.length}var l;var d,r;var c=0;var o=0;var m=0;var u=0;var n;var a=0;var i=0;const p=2;return{timestamp_for_recording:0,get enabled(){return i&&!Pe.video.paused},get morph_active(){return Te.enabled?this.enabled:this.active},get active(){if(!this.enabled)return false;if(this.timestamp_for_recording&&this.timestamp_for_recording!=RAF_timestamp)return false;if(n!=x){let e=1;if(n){e=this.get_frame(x)-this.get_frame(n);if(e<0||e>30)e=1;if(e>1){const t=e-1;o+=t;for(const i in d){d[i].frame_length+=t}for(const i in r){r[i].frame_length+=t}}}c+=e;n=x;a=RAF_timestamp}if(a==RAF_timestamp){return true}return false},get_frame:function(e){var t=e.split(":");return parseInt(t[0])*30+(parseInt(t[1])-1)},get frame_count(){return c},get stats(){return[o,l.boneKeys.length,l.morphKeys.length,m,u]},get time(){return Math.floor(c/30)+":"+(c%30+1)},get speed(){return i},set speed(e){i=e;if(e)this.start(e);else this.stop()},get vmd(){return i?null:l},set vmd(e){l=null},set_boneKey:function(e,t,i,o){let n=d[e];if(n==null){n=d[e]={frame_length:1};if(c>0)l.boneKeys.push(new _(e,null,null,0))}if(o&&Ye.skin[e]&&n.timestamp==Ye.skin[e][0].timestamp){let e;if(n.frame_count==c){const a=l.boneKeys[n.index];e=(!t||a.pos)&&(!i||a.rot)}else e=true;if(e){if(n.frame_count!=c){n.frame_length++;m++}return}}if(!t&&i&&n.is_rot_identity&&i.w==1){m++;return}n.is_rot_identity=i?i.w==1:n.is_rot_identity;if(n.frame_count==c){const a=l.boneKeys[n.index];if(t)a.pos=t.toArray();if(i)a.rot=i.toArray()}else{if(n.index!=null&&e.indexOf("手")==-1&&e.indexOf("指")==-1){const a=l.boneKeys[n.index];const s=Math.round(c-a.time*30);if(s>n.frame_length||s>10){const r=new _(e,null,null,(c-1)/30);r.pos=a.pos;r.rot=a.rot;l.boneKeys.push(r);m--}}n.timestamp=Ye.skin[e]&&Ye.skin[e][0].timestamp||0;l.boneKeys.push(new _(e,t,i,c/30))}n.frame_length=1;n.frame_count=c;return true},set_morphKey:(()=>{function o(e,t,i){let o=r[e];if(o==null){o=r[e]={frame_length:1};if(c>0)l.morphKeys.push(new s(e,0,0))}if(i&&Ye.morph[e]&&o.timestamp==Ye.morph[e][0].timestamp){if(o.frame_count!=c){o.frame_length++;u++}return}t=Math.round(t*20)/20;if(t==o.weight){u++;return}o.weight=t;if(o.frame_count==c){const n=l.morphKeys[o.index];n.weight=t}else{if(o.index!=null){const n=l.morphKeys[o.index];const a=Math.round(c-n.time*30);if(a<p){o.frame_length++;return}if(a>o.frame_length||a>10){l.morphKeys.push(new s(e,n.weight,(c-p)/30));u--}}o.timestamp=Ye.morph[e]&&Ye.morph[e][0].timestamp||0;l.morphKeys.push(new s(e,t,c/30))}o.frame_length=1;o.frame_count=c;return true}return function(e,t,i){if(Te.enabled){window.addEventListener("SA_motion_recorder_on_active",()=>{o.call(this,e,t,i)},{once:true})}}})(),start:function(e){i=e;if(MMD_SA.THREEX.get_model(0).use_faceBlendshapes){MMD_SA.THREEX.get_model(0)._disable_faceBlendshapes=true;for(const t of Ie.faceBlendshapes_list){Ye.remove("morph",t)}}n="";a=0;if(Pe.is_local_video){Pe.video.playbackRate=e;if(e<1)Pe.video.muted=true;Pe.video.loop=false;Pe.video.pause();MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording"),5*1e3);C_media_control.style.visibility="inherit"}c=-1;o=0;m=0;u=0;d={};r={};l={boneKeys:[],morphKeys:[]}},stop:function(){i=0;MMD_SA.THREEX.get_model(0)._disable_faceBlendshapes=false;if(Pe.is_local_video){Pe.video.playbackRate=1;Pe.video.muted=false;Pe.video.loop=true;Pe.video.pause();MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording.recording_stopped"),5*1e3)}else if(Pe.is_local_photo){l.boneKeys=l.boneKeys.filter(e=>e.time==0);l.morphKeys=l.morphKeys.filter(e=>e.time==0);l.boneKeys=l.boneKeys.concat(l.boneKeys.map(e=>{const t={name:e.name,pos:e.pos.slice(),rot:e.rot.slice(),time:60};return t}));l.morphKeys=l.morphKeys.concat(l.morphKeys.map(e=>{const t={name:e.name,weight:e.weight,time:60};return t}))}}}}();const f=(()=>{function r(){m=m.slice(Math.max(m.length-8,0),m.length);MMD_SA_options.Dungeon.run_event([[{message:{content:m.join("\n")+"\n("+System._browser.translation.get("XR_Animator.UI.streamer_mode.press_x_to_abort")+")",para:h,branch_list:[{key:"X",is_closing_event:true,event_id:{func:()=>{p=true;if(u)u()},ended:true}}]}}]])}function _(){if(--i==0){m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_model_loaded"));if(u)u()}}function l(e){if(!Ie.calibrated){i++;window.addEventListener("SA_camera_facemesh_calibrating",d);m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrating")+"...");r()}_(e)}function d(e){const t=e.detail.percent;if(t>=100){window.removeEventListener("SA_camera_facemesh_calibrating",d);MMD_SA.SpeechBubble.list[1].message(0,"("+System._browser.translation.get("XR_Animator.UI.streamer_mode.calibrating_face_data")+" - 100%)",0,h);m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrated"));_()}else{MMD_SA.SpeechBubble.list[1].message(0,"("+System._browser.translation.get("XR_Animator.UI.streamer_mode.calibrating_face_data")+" - "+t+"%)\n"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrating_message"),0,h)}}let c;let m=[];let i;let u;let p;const h={font_scale:1,font:'"Segoe UI",Roboto,Ubuntu,"SF Pro"'};const e={get running(){return c},init_mocap:function(e){function t(){if(c){if(MMD_SA_options.user_camera.streamer_mode.motion_id!=null){const e=typeof MMD_SA_options.user_camera.streamer_mode.motion_id=="number"?MMD_SA_options.user_camera.streamer_mode.motion_id+(System._browser.camera.facemesh.enabled&&!System._browser.camera.poseNet.enabled?1:0):MMD_SA_options._XRA_pose_list?.[2].findIndex(e=>e.name==MMD_SA_options.user_camera.streamer_mode.motion_id);if(typeof e=="number"&&e>=0)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(e,true);return new Promise(t=>{window.addEventListener("SA_MMD_model0_onmotionchange",e=>{m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.motion_changed")+" ("+e.detail.motion_new.filename+")");t()},{once:true})})}}if(MMD_SA.WebXR.user_camera.poseNet.enabled){if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(0,true)}}switch(e){case"Face":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=false;MMD_SA.WebXR.user_camera.handpose.enabled=false;DEBUG_show("Facemesh AI:ON",2);i=1;break;case"Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=false;MMD_SA.WebXR.user_camera.facemesh.enabled=false;DEBUG_show("Pose AI:ON",3);i=1;break;case"Body+Hands":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;MMD_SA.WebXR.user_camera.facemesh.enabled=false;DEBUG_show("Pose/Hands AI:ON",3);i=1;break;case"Face+Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=false;DEBUG_show("Facemesh/Pose AI:ON",3);i=2;break;case"Full Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;DEBUG_show("Facemesh/Pose/Hands AI:ON",4);i=2;break;case"Full Body Holistic":MMD_SA.WebXR.user_camera.poseNet.use_holistic=true;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;DEBUG_show("Facemesh/Pose/Hands AI:ON",4);i=2;break;default:return}MMD_SA_options.user_camera.streamer_mode.mocap_type=e;return t()},start:async function(){function e(){m.length=0;u=null;p=false;c=false}function t(){e();MMD_SA_options.Dungeon.event_mode=false}if(MMD_SA.WebXR.user_camera.bodyPix.enabled){DEBUG_show("(You can't enable motion capture and Selfie Segmentation AI at the same time.)",5);return}if(c){DEBUG_show("(Streamer mode running)");return}e();c=true;MMD_SA_options.Dungeon.event_mode=true;const i=Pe.stream&&MMD_SA_options.user_camera.streamer_mode.camera_preference.label;MMD_SA.WebXR.user_camera.video_flipped=!!MMD_SA_options.user_camera.streamer_mode.camera_preference.video_flipped;const o=await Pe.start();if(!o){MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.streamer_mode.webcam_not_accessible"),5*1e3);t();return}if(i!=MMD_SA_options.user_camera.streamer_mode.camera_preference.label)m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.webcam_on")+" ("+MMD_SA_options.user_camera.streamer_mode.camera_preference.label+")");let n;if(webkit_electron_mode&&MMD_SA.THREEX.enabled){n=!!MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled;if(n){if(!MMD_SA.OSC.VMC.sender_enabled){MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled=MMD_SA.OSC.VMC.sender_enabled=true;m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.VMC_protocol_on"));MMD_SA.OSC.VMC.send_camera_data=!!MMD_SA_options.user_camera.streamer_mode.VMC_send_camera_data;if(MMD_SA.OSC.VMC.send_camera_data)m.push("✅- "+System._browser.translation.get("XR_Animator.UI.streamer_mode.VMC_protocol_on.send_camera_data"));System._browser.update_tray()}}}if(!Pe.ML_enabled){const a=MMD_SA_options.user_camera.streamer_mode.mocap_type||(is_mobile?System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.face","en"):System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.full_body","en"));const s=MMD_SA_options.user_camera.streamer_mode.mocap_type||(is_mobile?System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.face"):System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.full_body"));m.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing")+" ("+s+")...");r();await new Promise(e=>{u=e;if(/Face|Full Body/.test(a))window.addEventListener("SA_camera_facemesh_update",l,{once:true});if(/Body/.test(a))window.addEventListener("SA_camera_poseNet_update",_,{once:true});const t=f.init_mocap(a);if(t)t.then(r)})}if(p){window.removeEventListener("SA_camera_poseNet_update",_);window.removeEventListener("SA_camera_facemesh_update",l);window.removeEventListener("SA_camera_facemesh_calibrating",d);MMD_SA.SpeechBubble.list.forEach(e=>{e.hide()});t();return}u=null;MMD_SA.SpeechBubble.hide();if(n){if(m.length){await new Promise(e=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.UI.streamer_mode.finish_VMC"),para:h,index:1,branch_list:[{key:1,event_id:{func:()=>{MMD_SA.hide_3D_avatar=true;System._browser.update_tray();e()},ended:true}},{key:"X",is_closing_event:true,event_id:{func:()=>{e()},ended:true}}]}}]])})}}else{if(m.length){await new Promise(e=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.UI.streamer_mode.finish"),para:h,index:1,branch_list:[{key:1,event_id:{func:()=>{System._browser.overlay_mode=1;e()},ended:true}},{key:"X",is_closing_event:true,event_id:{func:()=>{e()},ended:true}}]}}]])})}}if(!m.length)MMD_SA.SpeechBubble.message(0,"XR Animator is ready!",3e3);if(Pe.initialized&&Pe.visible)Pe.hide();t()}};return e})();var mt=[{},{}];var V=t.get("camera_hidden");var N;Pe={initialized:false,get ML_enabled(){return h},get ML_busy(){return Ie.busy||Te.busy},get ML_fps(){return 1e3/(Te.enabled&&Te._t||Ie.enabled&&Ie._t||1e3)},get ML_warmed_up(){var e=mt[Te.use_holistic?1:0];var t=!Ie.enabled||e.facemesh;var i=!Te.enabled||e.poseNet;var o=!je.enabled||e.handpose;return t&&i&&o},get target_devicePixelRatio(){return u||window.devicePixelRatio},set target_devicePixelRatio(e){u=e==window.devicePixelRatio?0:e},get double_flip_mode(){return i&&!Pe.mirror_3D},set double_flip_mode(e){i=e},get video_flipped(){return!h?_:!!_^!!Pe.double_flip_mode},set video_flipped(e){_=e;this.reset_video_canvas()},get display_flipped(){return Pe.mirror_3D?false:_!=Pe.video_flipped},get mirror_3D(){return!h||!MMD_SA_options.user_camera.mirror_3D?false:MMD_SA_options.user_camera.mirror_3D==1?Pe.visible:true},get x_flipped(){return Pe.double_flip_mode||Pe.mirror_3D},get hidden_enforced(){return V||(MMD_SA_options.user_camera.display.video.hidden==null?!!this.stream:MMD_SA_options.user_camera.display.video.hidden)||System._browser.overlay_mode>0||this.stream&&MMD_SA_options.user_camera.display.video.hidden_on_webcam},get display_floating(){return MMD_SA_options.user_camera.display.floating||N},set display_floating(e){N=e;if(this.video_host)this.video_host.style.zIndex=this.display_floating?2:0},get video_timestamp(){return Pe.video.currentTime==null?performance.now()/2:Pe.video.currentTime*1e3},get video_frame_id(){const e=this.video_timestamp/1e3;const t=Math.floor(e);return t+":"+Math.floor((e-t)*30+1)},get is_local_media(){return this.local_src&&!this.stream},get is_local_video(){return this.is_local_media&&this.video.currentTime!=null},get is_local_photo(){return this.is_local_media&&this.video.currentTime==null},DEBUG_show:(()=>{let o="";let n="";let a=0;let s=[];window.addEventListener("MMDStarted",()=>{System._browser.on_animation_update.add(()=>{s=s.filter(e=>RAF_timestamp<e.timestamp+e.duration);n=s.length?s.map(e=>e.msg).join("\n")+"\n":"";Fe=n+o},0,0,-1)});return function(e,t,i){if(!Pe.ML_enabled||!Te.data_detected&&!Ie.data_detected){DEBUG_show(e,t,i);return}if(t){s.push({msg:e,duration:t*1e3,timestamp:RAF_timestamp});return}if(a!=RAF_timestamp){a=RAF_timestamp;o=""}o=(o?o+"\n":o)+e;Fe=n+o}})(),motion_recorder:Ze,tilt_adjustment:{enabled:false,angle:0,pose_weight:.5},camera_list:null,deviceId:null,start:async function(i){async function n(){try{stream=await navigator.mediaDevices.getUserMedia(a);return stream}catch(e){console.error(e)}}var e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;MMD_SA.reset_camera();this._camera_reset=MMD_SA._trackball_camera.object.clone();if(this.initialized&&!f.running){if(this.visible){this.hide();DEBUG_show("User camera:HIDDEN",2);return}}var a={video:this.set_constraints()};try{if(i){this.init_stream(i)}else{if(is_mobile){a.video.facingMode="user"}if(MMD_SA_options.Dungeon){MMD_SA_options.Dungeon.run_event([[{message:{get content(){return System._browser.translation.get("XR_Animator.UI.webcam_media.finding_camera")}}},{goto_branch:0}]])}let t;if(is_mobile){if(!this.stream)t=await n();if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2);if(!this.stream&&!t){DEBUG_show("(Camera not accessible)",3);return}}else{let o=this.camera_list;if(!o){try{o=await navigator.mediaDevices.enumerateDevices();o=o.filter(e=>e.kind=="videoinput");const r=MMD_SA_options.user_camera.streamer_mode.camera_preference&&{label:{test:e=>e.indexOf(MMD_SA_options.user_camera.streamer_mode.camera_preference.label)!=-1}}||MMD_SA_options.user_camera.preference;o.sort((e,t)=>r?.label?.test(e.label)&&-1||r?.label?.test(t.label)&&1||/warudo/i.test(e.label)&&1||/warudo/i.test(t.label)&&-1||0);this.camera_list=o=o.slice(0,7);if(f.running&&!o.length)throw new Error("(No camera detected)")}catch(s){console.error(s);if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2);DEBUG_show("(No camera detected)",3);return}}let e;if(MMD_SA_options.Dungeon){await new Promise(t=>{MMD_SA_options.Dungeon.run_event([[{message:{get content(){return(o.length?System._browser.translation.get("XR_Animator.UI.webcam_media.choose_an_input")+o.map((e,t)=>"\n"+(t+1)+". "+e.label.substring(0,25)).join(""):System._browser.translation.get("XR_Animator.UI.webcam_media.no_camera"))+"\n"+(o.length+1)+". "+System._browser.translation.get("XR_Animator.UI.webcam_media.local_media_file")+"\n"+(o.length+2)+". "+System._browser.translation.get("Misc.cancel")},para:{row_max:11,no_word_break:true},bubble_index:3,branch_list:o.map((e,t)=>{return{key:t+1,branch_index:t+1}}).concat([{key:Math.min(o.length+1,8),branch_index:Math.min(o.length+1,8)},{key:Math.min(o.length+2,9),is_closing_event:true,branch_index:Math.min(o.length+2,9)}])}}]].concat(o.map(e=>[{func:()=>{const i=e.label;MMD_SA_options.user_camera.streamer_mode.camera_preference=Object.assign(MMD_SA_options.user_camera.streamer_mode.camera_preference||{},{label:i,video_flipped:!!_});o.sort((e,t)=>e.label==i&&-1||t.label==i&&1||0);a.video.deviceId=e.deviceId;t()},ended:true}]).concat([[{func:()=>{if(Pe.local_src){i=Pe.local_src;t();return true}else{DEBUG_show("(No local media file found)",3);MMD_SA_options.Dungeon.run_event(null,0,0)}}}],[{func:()=>{e=true;t()},ended:true}]])));if(f.running&&MMD_SA_options.user_camera.streamer_mode.camera_preference?.label){MMD_SA_options.Dungeon.run_event(null,1,0)}})}if(e){DEBUG_show("(Canceled)",2);return}if(!i&&a.video.deviceId!=this.deviceId){t=await n();if(!t){DEBUG_show("(Camera not accessible)",3);return}}}if(i){Pe.init_stream(i)}else if(t){Pe.init_stream(t);this.deviceId=a.video.deviceId}if(e&&e.dom_overlay)e.dom_overlay.use_dummy_webgl=true;DEBUG_show("(User camera:ON)",2)}if(!this.visible){this.show();DEBUG_show("User camera:VISIBLE",2)}return f.running}catch(s){if(MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode)MMD_SA_options.Dungeon.run_event({ended:true});Pe.init_stream();console.error(s);DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}},init_stream:function(e){if(!this.initialized){this.video=this._video=document.createElement("video");this.video.autoplay=true;let e;this.video_host=document.createElement("div");e=this.video_host.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=this.display_floating?2:0;e.visibility=System._browser.overlay_mode?"hidden":"inherit";e.display=System._browser.overlay_mode?"none":"block";SL_Host.appendChild(this.video_host);this.video_canvas=document.createElement("canvas");e=this.video_canvas.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas);this.video_canvas_bodyPix=document.createElement("canvas");e=this.video_canvas_bodyPix.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_bodyPix);this.video_canvas_face_detection=document.createElement("canvas");e=this.video_canvas_face_detection.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_face_detection);this.video_canvas_facemesh=document.createElement("canvas");e=this.video_canvas_facemesh.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_facemesh);is_mobile&&window.addEventListener("resize",function(){Pe.video_track?.applyConstraints(Pe.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)})["catch"](function(e){DEBUG_show("ERROR:camera size failed to update")})});navigator.mediaDevices.addEventListener("devicechange",()=>{console.log("mediaDevices: new device detected");this.camera_list=null})}this.initialized=true;this.show();if(this.stream){this.stream.getTracks().forEach(e=>{e.stop()});this.video.srcObject=this.stream=this.video_track=this.deviceId=null;console.log("(Previous stream stopped)")}if(!e||typeof e=="string"){p(e)}else{this.stream=e;this.video_id=e.id;this.video_track=e.getVideoTracks()[0];this.video=this._video;this.video.srcObject=e;console.log("(New stream started)");setTimeout(function(){let e=Pe.video_track.getCapabilities?.();if(!e)return;System._browser.console.log(Object.entries(e).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"));let t=Pe.video_track.getSettings();const i=Object.entries(t).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n");console.log("MediaTrackCapabilities",i);if(is_mobile)System._browser.console.log()},2e3)}if(Ie.enabled)Ie.reset_calibration()},get use_armIK(){return Te.enabled||je.enabled||Ie.enabled},bodyPix:function(){var o;var i=false;c={get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;const t=MMD_SA.THREEX.SL;if(i){MMD_SA._renderer.devicePixelRatio=1;MMD_SA._renderer.__resize(EV_width,EV_height);t.style.visibility="hidden"}else{MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);t.style.visibility="inherit";Pe.video_canvas_bodyPix.style.visibility="hidden"}},busy:0,mask:null,allPoses:null,use_bodySegmentation:true,load:async function(e){this.enabled=true;if(o)return;if(!this.mask){this.mask=document.createElement("canvas");d.load_face_cover()}if(this.use_bodySegmentation){const t=bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation;const i={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};o=await bodySegmentation.createSegmenter(t,i)}else{o=await bodyPix.load(e||(1||is_mobile)?{architecture:"MobileNetV1",outputStride:16,multiplier:.5,quantBytes:2}:{architecture:"ResNet50",outputStride:32,quantBytes:2})}console.log("bodyPix loaded")},segmentPerson:async function(e,t){await this.load();if(this.use_bodySegmentation){return await o.segmentPeople(e)}else{return await o.segmentPerson(e,t||{flipHorizontal:false,internalResolution:"medium",segmentationThreshold:.7})}},toMask:async function(e,t,i){const o=await this.segmentPerson(e,t);i=i||{foregroundColor:{r:0,g:0,b:0,a:255},backgroundColor:{r:0,g:0,b:0,a:0}};if(this.use_bodySegmentation){return await bodySegmentation.toBinaryMask(o,i.foregroundColor,i.backgroundColor)}else{this.allPoses=o.allPoses;return bodyPix.toMask(o,i.foregroundColor,i.backgroundColor)}},update_frame:async function(e=Pe.video_canvas,t,i,o){const n=MMD_SA.THREEX.SL;if(System._browser.snapshot.check_bodyPix()){Pe.video_canvas.style.visibility="inherit";Pe.video_canvas_bodyPix.style.visibility="hidden";n.style.visibility="inherit";return}if(this.busy)return;this.busy=RAF_timestamp;const a=await this.toMask(e,t,i);this.busy=0;if(!this.enabled)return;if(this.mask.width!=a.width||this.mask.height!=a.height){this.mask.width=a.width;this.mask.height=a.height}this.mask.getContext("2d").putImageData(a,0,0);const s=n.width;const r=n.height;if(Pe.video_canvas_bodyPix.width!=s||Pe.video_canvas_bodyPix.height!=r){Pe.video_canvas_bodyPix.width=s;Pe.video_canvas_bodyPix.height=r}const _=s/r/(e.width/e.height);const l=Math.round(s*Math.min(1/_,1));const d=Math.round(r*Math.min(_,1));const c=(s-l)/2;const m=(r-d)/2;const u=Pe.video_canvas_bodyPix.getContext("2d");u.globalCompositeOperation="copy";u.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)";u.drawImage(this.mask,0,0,a.width,a.height,c,m,l,d);u.globalCompositeOperation="source-out";u.filter="none";u.save();if(Pe.mirror_3D){u.translate(s,0);u.scale(-1,1)}u.drawImage(n,0,0);u.restore();u.globalCompositeOperation="destination-over";u.drawImage(e,0,0,e.width,e.height,c,m,l,d);Pe.video_canvas_bodyPix.style.visibility="inherit";n.style.visibility="hidden";this.update_frame_for_face_detection();System._browser.snapshot.check_bodyPix()},update_frame_for_face_detection:function(){let e=d.face_cover;if(!d.enabled||!e.complete)return;Pe.video_canvas_face_detection.style.visibility="hidden";let t=e.width;let s=e.height;let r=[];this.allPoses.forEach(function(e){let t=e.keypoints;let i=t.find(e=>e.part=="nose");if(!i)return;let o=t.find(e=>e.part=="leftEye");let n=t.find(e=>e.part=="rightEye");let a;if(o&&n){let e=o.position.x-n.position.x;let t=o.position.y-n.position.y;a=Math.sqrt(e*e+t*t)*4}else{a=s}r.push([i.position.y,i.position.x,Math.max(a,s/2),100])});this.allPoses=undefined;d.update_frame_local(Pe.video_canvas_bodyPix,r)}};return c}(),face_detection:function(){var t=false;function i(){d.initialized=true;if(!self.OffscreenCanvas)d.load_face_cover();r=new Worker("js/pico.worker.js");r.onmessage=function(e){var t=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof t==="string"){DEBUG_show(t,2);d.worker_initialized=true}else{Pe._needs_RAF=true;if(t._t)DEBUG_show(t._t);d.dets=t.dets;d.busy=0;Pe.video_canvas_face_detection.style.left=Pe.video_canvas.style.left;Pe.video_canvas_face_detection.style.top=Pe.video_canvas.style.top;if(!self.OffscreenCanvas){System._browser.on_animation_update.add(function(){d.update_frame_local(null,d.dets)},0,0)}}d.update_frame()}}d={initialized:false,worker_initialized:false,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){this.dets=null;if(!this.initialized)i()}else{if(Pe.initialized)Pe.video_canvas_face_detection.style.visibility="hidden"}},load_face_cover:function(){if(!this.face_cover){this.face_cover=new Image;this.face_cover.src="images/laughing_man_134x120.png"}},dets:null,camera_video_timestamp:0,update_frame:function(e){function t(){var e=d.enabled&&d.worker_initialized&&E&&!d.busy&&P&&d.camera_video_timestamp!=E;if(!e)return;d.busy=RAF_timestamp;d.camera_video_timestamp=E;d.camera_video_frame_id=x;Pe.video_canvas_face_detection.style.visibility="inherit";let t,i,o;t=Pe.video_canvas;i=t.width;o=t.height;let n=t.getContext("2d").getImageData(0,0,i,o).data.buffer;let a=Pe.video_canvas_face_detection.style;if(a.width!=t.style.width||a.height!=t.style.height){a.width=t.style.width;a.height=t.style.height}let s={rgba:n,w:i,h:o};if(!Pe.video_canvas_face_detection._offscreen&&self.OffscreenCanvas){s.canvas=Pe.video_canvas_face_detection.transferControlToOffscreen();Pe.video_canvas_face_detection._offscreen=true;console.log("(Face detection: use offscreen canvas)")}r.postMessage(s,s.canvas?[s.canvas,s.rgba]:[s.rgba]);s.rgba=n=undefined;s=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}},update_frame_local:function(e,i){let t=Pe.video_canvas.width;let o=Pe.video_canvas.height;let n;if(!e){e=Pe.video_canvas_face_detection;if(e.width!=t||e.height!=o){e.width=t;e.height=o}n=e.getContext("2d");n.clearRect(0,0,t,o)}else{n=e.getContext("2d")}n.globalCompositeOperation="source-over";let a=this.face_cover;let s=a.width;let r=a.height;let _,l,d,c;if(i.length){let t=1;i.forEach(function(e){_=e[2]*t;l=_*s/r;d=e[1]*t-l/2;c=e[0]*t-_/2;n.drawImage(a,0,0,s,r,d,c,l,_)})}else{_=Math.min(t,o);l=_*s/r;d=(t-l)/2;c=(o-_)/2;n.drawImage(a,0,0,s,r,d,c,l,_)}}};return d}(),streamer_mode:f,facemesh:function(){var i=false;var pe=0;var he=0;var fe=true;var Me=0;var ge=[];var ye;var be;var g;var ve=[];var we;var b=false;var Se;var o=-1;var t;function n(e){if(!e&&t&&t==Pe.video_id)return;t=Pe.video_id;pe=0;he=0;fe=true;Me=0;ge=[];ye={};be={L:[],R:[]};g=0;ve=[];var o={L:[159,145],R:[386,374]};["L","R"].forEach(function(t){for(var i=0;i<1;i++){let e=be[t][i]={};e.index=i;e._eye_open_average=0;e.eye_open_average=0;e.eye_open_lower=999;e.eye_open_data=[];e.height_ref_pts=o[t]}ye[t]={_height_average:0,height_average:0,height_data:[],height_ref_pts:t=="R"?[334,330]:[105,101]}});Se={sad:0,angry:0,surprise:0,blush:0,tongue_out:0}}var a;var Ae=[];var De,ke,v;De=!is_mobile;v=!is_chrome||is_mobile;var e;function s(){if(Ie.initialized)return;Ie.initialized=true;for(var e=0;e<4;e++)Ae[e]=new THREE.Vector3;var o=[];if(System._browser.use_WASM_SIMD){o.push("simd=1")}if(C){De=true}if(v){De=true;o.push("use_mediapipe_facemesh=1")}if(De){De=true;if(Ie.blink_detection==null)Ie.blink_detection=true;o.push("use_face_landmarks=1")}if(ke){o.push("use_human_facemesh=1")}var t;if(MMD_SA_options.user_camera.ML_models.facemesh.worker_disabled){t=new Promise((e,t)=>{Re={postMessage:function(e,t){FacemeshAT.onmessage({data:e})}};let i=document.createElement("script");i.onload=async function(){await FacemeshAT.init(Re,o);e()};i.src="js/facemesh_lib.js";document.head.appendChild(i)})}else{Re=new Worker("js/facemesh_worker.js"+(o.length?"?"+o.join("&"):""))}Re.onmessage=A;return t}function w(e,t,i){const o=new Path2D;o.moveTo(t[0][0]/2,t[0][1]/2);for(let e=1;e<3;e++){const n=t[e];o.lineTo(n[0]/2,n[1]/2)}if(i){o.closePath()}e.stroke(o)}const S=["_neutral","BrowInnerUp","BrowDownLeft","BrowDownRight","BrowOuterUpLeft","BrowOuterUpRight","EyeLookUpLeft","EyeLookUpRight","EyeLookDownLeft","EyeLookDownRight","EyeLookInLeft","EyeLookInRight","EyeLookOutLeft","EyeLookOutRight","EyeBlinkLeft","EyeBlinkRight","EyeSquintRight","EyeSquintLeft","EyeWideLeft","EyeWideRight","CheekPuff","CheekSquintLeft","CheekSquintRight","NoseSneerLeft","NoseSneerRight","JawOpen","JawForward","JawLeft","JawRight","MouthFunnel","MouthPucker","MouthLeft","MouthRight","MouthRollUpper","MouthRollLower","MouthShrugUpper","MouthShrugLower","MouthClose","MouthSmileLeft","MouthSmileRight","MouthFrownLeft","MouthFrownRight","MouthDimpleLeft","MouthDimpleRight","MouthUpperUpLeft","MouthUpperUpRight","MouthLowerDownLeft","MouthLowerDownRight","MouthPressLeft","MouthPressRight","MouthStretchLeft","MouthStretchRight","TongueOut"];let Ee;const r=["あ","い","う","え","お","にやり","ω","口角上げ","口角下げ","ぺろっ","上","下","にこり","困る","怒り","照れ","まばたき","笑い","びっくり","まばたきL","まばたきR"];var A=function(){function re(e){if(!e||Ee)return;Ee={};e.categories.forEach((e,t)=>{const i=e.categoryName;Ee[i.charAt(0)+i.substring(1)]=t})}var _e;var le=0,de=0,ce=0,me=0;const ue={};window.addEventListener("jThree_ready",()=>{for(const e of r.concat(["両目"])){ue[e]=new System._browser.data_filter([{type:"one_euro",id:e,para:e=="両目"?[30,1,5,1,4]:[30,1,1,1,1]}])}});return function(e){var S=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof S==="string"){if(S=="OK"){Ie.worker_initialized=true}else{DEBUG_show(S,2);System._browser.console.log(S)}}else if(S.posenet){xe({data:S})}else if(Ie.enabled){window.dispatchEvent(new CustomEvent("SA_camera_facemesh_update"));Pe._needs_RAF=true;const t=mt[Te.use_holistic?1:0];if(!t.facemesh){t.facemesh=true;DEBUG_show("Facemesh ML ready",2)}let w="";if(S.faces.length){Ie.data_detected++}else{Ie.data_detected=0}if(S.faces.length&&S.faces[0].bb_center){D=S.faces[0].bb_center}else if(!Te.enabled){D=[.5,.5]}if(S.faces.length&&Ie.data_detected_stable){let D=S.faces[0];re(D.faceBlendshapes);let d=Pe.x_flipped?1:-1;const A={facemesh_data:D};let k,E,l;if(D.rotation){const H=D.rotation.matrix;qe.set(H[0],H[1],H[2],0,H[3],H[4],H[5],0,H[6],H[7],H[8],0,0,0,0,1)}else{let e=MMD_SA._v3a_.fromArray(D.mesh[152]).sub(MMD_SA._v3b.fromArray(D.mesh[10])).normalize();let t=MMD_SA._v3b_.fromArray(D.mesh[454]).sub(MMD_SA._v3b.fromArray(D.mesh[234])).normalize();let i=MMD_SA.TEMP_v3.crossVectors(t,e).normalize();t.crossVectors(e,i);qe.set(t.x,t.y,t.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,0,0,0,0,1)}let e=MMD_SA.TEMP_v3.setEulerFromRotationMatrix(qe,"YZX");k=-e.x;E=-e.y;l=-e.z;let t=D.scaledMesh[454][0]-D.scaledMesh[234][0];let i=D.scaledMesh[454][1]-D.scaledMesh[234][1];let o;if(S.recalculate_z_rotation_from_scaledMesh){t/=Math.cos(E);i/=Math.cos(k);o=Math.sqrt(t*t+i*i)}else{t/=Math.cos(l);o=Math.abs(t/Math.cos(E))}Ie.face_width=o;let n;if(S.recalculate_z_rotation_from_scaledMesh){n=Math.asin(i/o)}else{n=l}let a=new THREE.Quaternion;let s=MMD_SA._v3a.set(k,E*d,n*d);a.setFromEuler(s,"YZX");Ie.calculate_neck_data({is_face:true,timestamp:Ie.camera_video_frame_id,f_axis:ze.set(D.scaledMesh[454][0],D.scaledMesh[454][1],0).add(MMD_SA.TEMP_v3.set(D.scaledMesh[234][0],D.scaledMesh[234][1],0)).multiplyScalar(.5).setZ(0).toArray(),face_width:Ie.face_width,face_rot:a.toArray()});const L=MMD_SA.MMD.motionManager.para_SA;let r=0;let _=L.motion_tracking?.camera?.tilt_adjustment||Pe.tilt_adjustment;if(_.enabled){r=_.angle*Math.PI/180;const O=MMD_SA._q2.set(Math.sin(r/2),0,0,Math.cos(r/2));a.premultiply(O)}let c=Pe.video_timestamp;let m=0;if(me){m=Math.max(Math.min(c-me,1e3),10);ce+=m;if(++de>=20){le=1e3/(ce/de);de=ce=0}}me=c;Ie._t=S._t;Ye.t_delta=le&&1e3/le||m||S.fps&&1e3/S.fps||S._t;_e="";if(Ie.head_pose_enabled){if(System._browser.motion_control.enabled)A.head_rot=MMD_SA._v3a.clone();Ye.add("skin|facemesh","首",{after_IK:true,rot:a,_rot_ratio:Ie.face_width/Math.min(Pe.video_canvas.width,Pe.video_canvas.height),onProcessRotation:dt})}pe+=Math.min(S._t,75);if(fe){he=~~(Math.min(pe/5e3,ge.length/60,we?be.L[0].eye_open_data.length/60:1,Te.enabled?ve.length/60:1,1)*100);fe=he<100;window.dispatchEvent(new CustomEvent("SA_camera_facemesh_calibrating",{detail:{percent:he}}))}let u=D.faceInViewConfidence>(ke?.75:.9)&&(Pe.video==Pe._image||!Pe.video.paused&&Math.abs(E)<Math.PI/4&&Math.abs(k+r)<Math.PI/6);let p=MMD_SA._v3a.fromArray(D.mesh[13]).distanceTo(MMD_SA._v3b.fromArray(D.mesh[14]));let h=D.faceBlendshapes?Math.max(D.faceBlendshapes.categories[Ee["mouthPucker"]].score,.01):MMD_SA._v3a.fromArray(D.mesh[61]).distanceTo(MMD_SA._v3b.fromArray(D.mesh[291]));let f=Me;if(!f){if(u&&p<2*(1+Math.abs(r)/(Math.PI/4)*4))ge.push(h);if(!ge.length){f=0}else{let e=parseInt(ge.length*.3);f=ge.sort((e,t)=>e-t).slice(e,ge.length-e).reduce((e,t)=>e+t)/(ge.length-e*2);if(!fe){Me=f}}}let M=0;let x=0;let g=0;let y=0;["L","R"].forEach(function(e){let t=ye[e];t.height=D.faceBlendshapes?Math.max(D.faceBlendshapes.categories[Ee["eyeSquint"+(e=="L"?"Left":"Right")]].score,.01):MMD_SA._v3a.fromArray(D.mesh[t.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(D.mesh[t.height_ref_pts[1]]));t._height_average=t.height_average;if(!t._height_average){if(u)t.height_data.push(t.height);if(!t.height_data.length){t._height_average=t.height}else{let e=parseInt(ge.length*.3);t._height_average=t.height_data.sort((e,t)=>e-t).slice(e,t.height_data.length-e).reduce((e,t)=>e+t)/(t.height_data.length-e*2);if(!fe){t.height_average=t._height_average}}}g+=t.height/t._height_average});g/=2;g=(g-1)/.25*(g>1?2:1);if(f){if(h>f*1.05){x=Math.sqrt(Math.min((h-f*1.05)/(f*.25),1))}else if(h<f*.98){x=-Math.sqrt(Math.min((f*.98-h)/(f*.2),1))}if(p>2){M=Math.pow(Math.min((p-2)/(f*1/3),1),.5);if(x>.25)y=(x-.25)/.75*.3}}let P=0;let I=0;let R=0;let b=0;let T=0;let j=0;const F=Ie.face_width/Math.min(Pe.video_canvas.width,Pe.video_canvas.height);const z=MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||F>.2?1:Math.max(1-(.2-F)*8,0);let v={L:[0],R:[0]};if(De){["L","R"].forEach(function(t){let i=0;v[t][i]=0;let o=be[t][i];let n=D.faceBlendshapes?Math.max(1-D.faceBlendshapes.categories[Ee["eyeBlink"+(t=="L"?"Left":"Right")]].score*.9,.2):MMD_SA._v3a.fromArray(D.mesh[o.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(D.mesh[o.height_ref_pts[1]]));let a=o.eye_open_average;if(!a){if(u){o.eye_open_data.push(n);let e=parseInt(o.eye_open_data.length*.3);a=o.eye_open_data.sort((e,t)=>e-t).slice(e,o.eye_open_data.length-e).reduce((e,t)=>e+t)/(o.eye_open_data.length-e*2);if(!fe){o.eye_open_average=a}}else{a=o._eye_open_average}}if(u){if(o.eye_open_lower>n)o.eye_open_lower=n}o._eye_open_average=a;if(a){if(n>a){v[t][i]=Math.min(n/a,1.25)}else{let e=Math.min(o.eye_open_lower,a/2);v[t][i]=Math.max((n-e)/(a-e),0)}}})}const C=MMD_SA.THREEX.get_model(0).use_faceBlendshapes;if(D.faceBlendshapes){const q=D.faceBlendshapes.categories;const r=[q[Ee["eyeBlinkLeft"]].score,q[Ee["eyeBlinkRight"]].score];r.forEach((e,t)=>{const i=t==0?"L":"R";const o=be[i][0];const n=1-(1-Math.max(o._eye_open_average||0,.5))*.8;const a=Math.min(o.eye_open_lower,.3);const s=n-a;e=Math.min(Math.max(e-(1-n),0)/s,1);r[t]=e<.5?Math.pow(e*2,1.5)/2:Math.pow((e-.5)*2,.667)/2+.5});const U=!Ie.blink_sync;const K=(U?Math.min(Math.abs(r[0]-r[1])/.4,1):0)*z;let e=U?Math.min(...r):(r[0]+r[1])/2;q[Ee["eyeBlinkLeft"]].score=r[0]*K+e*(1-K);q[Ee["eyeBlinkRight"]].score=r[1]*K+e*(1-K);for(const X of["eyeSquintLeft","eyeSquintRight"]){const W=X=="eyeSquintLeft"?"L":"R";const Q=Math.min(Math.max((ye[W]._height_average||0)*.8,.2),.5);q[Ee[X]].score=Math.max(q[Ee[X]].score-Q,0)/(1-Q)}const G=Math.min(Math.max((f||0)*.8,.2),.6);q[Ee["mouthPucker"]].score=Math.pow(Math.max(q[Ee["mouthPucker"]].score-G,0)/(1-G),2);if(C){q.forEach(e=>{const t=e.categoryName;let i=t.charAt(0).toUpperCase()+t.substring(1);i=i.indexOf("Left")!=-1?i.replace("Left","Right"):i.replace("Right","Left");Ye.add("morph|facemesh",i,{weight:e.score})})}}if(Array.isArray(D.emotion)){D.emotion.forEach(e=>{switch(e.emotion){case"happy":P+=e.score;break;case"sad":I+=e.score;break;case"angry":case"disgust":R+=e.score;break;case"fear":b+=e.score;break;case"surprise":T+=e.score;break}})}const B=MMD_SA.THREEX.get_model(0);if(D.faceBlendshapes){const V=B.type=="VRM";const q=D.faceBlendshapes.categories;let e=q[Ee["jawOpen"]].score;let t=(q[Ee["mouthSmileLeft"]].score+q[Ee["mouthSmileRight"]].score)/2;let i=(q[Ee["mouthUpperUpLeft"]].score+q[Ee["mouthUpperUpRight"]].score)/2;let o=(q[Ee["mouthLowerDownLeft"]].score+q[Ee["mouthLowerDownRight"]].score)/2;let n=q[Ee["mouthPucker"]].score;let a=q[Ee["mouthFunnel"]].score;let s=q[Ee["mouthShrugLower"]].score;s*=s;const N=.3*(k>0?1-Math.min(k/(Math.PI/12),1):1);I=Math.min(Math.max(s-N,0)/.7,1);if(k<0){const ee=Math.min(Math.abs(k)/(Math.PI/4),1);I=Math.pow(Math.max(I-ee*.5,0)/(1-ee*.5),ee*3)}let r=q[Ee["browInnerUp"]].score;r*=r;let _=(q[Ee["browOuterUpLeft"]].score+q[Ee["browOuterUpRight"]].score)/2;let l=(q[Ee["browDownLeft"]].score+q[Ee["browDownRight"]].score)/2;let d=0,c=0,m=0,u=0,p=0;const Y=.3;if(e<.2){if(n>.1){m=n;if(a>.1)p=(a-.1)/2}else{c=Math.min(i+o/2,1);u=Math.min(t+i/2,1);const ee=Math.min(t/(i+o||.1),1);c*=1-ee;u*=ee}const te=1-Math.min(Math.max(c,m,u,p),.2)/.2;d=Math.pow(e/.2,1-e/.2*.35-te*.3)*Y;if(C){e=d;Ye.morph["JawOpen"][0].weight=e}}else{e=Y+(e-.2)/.8*(1-Y);if(C)Ye.morph["JawOpen"][0].weight=e;p=Math.min(e+a/2,1);d=Math.min(e+(t+i)/3,1);if(n>.1){const ee=Math.min((n-.1)*5,1);p*=ee;d*=1-ee}else{p=0}}if(a>.1){x=-(a-.1)*.75}else{x=Math.min(Math.max(t-.2,0)*1+Math.max(i-.5,0)*1.5,1);if(x>.5)u*=1-(x-.5)*2*.25}P=Math.min(Math.max(x,0)-I,1);if(P<0){I=-P;P=0}else{I=0}const Z=.2+n/2;R=Math.max(q[Ee["mouthLeft"]].score-Z,q[Ee["mouthRight"]].score-Z,0);t=Math.min(P*.8,V?.7-Math.max(P*.4-.3,0):.6);P*=.4;I*=.5;R=Math.max(R-P,0);let h=Math.max(Math.max((q[Ee["mouthPressLeft"]].score+q[Ee["mouthPressRight"]].score)/2,(q[Ee["mouthRollLower"]].score+q[Ee["mouthRollUpper"]].score)/2)-.2,0);if(l>.1){_=-(l-.1)/.9}else if(r>.1&&_>.1){_=((r-.1)/.9+(_-.1)/.9)/2}let f=(q[Ee["eyeBlinkRight"]].score+q[Ee["eyeBlinkLeft"]].score)/2;T=Math.max(_-f-.1,0);T=T*T/2;if(V)T=Math.min(T*Math.max(e*3,1),1);let M=1;const $=Ie.use_tongue_out&&B.blendshape_map_by_MMD_name?.["ぺろっ"];const g=Ie.use_tongue_out&&(B.use_tongue_out||$);let y=Math.min(q[Ee["mouthLowerDownLeft"]].score,q[Ee["mouthLowerDownRight"]].score);if(g&&y>.2){let e=Math.max(q[Ee["mouthUpperUpLeft"]].score,q[Ee["mouthUpperUpRight"]].score);j=Math.max(y-e*1.2,0);if(Math.abs(E)>Math.PI/18){M=Math.max(1-(Math.abs(E)-Math.PI/18)/(Math.PI/4),1/3);j*=M}if(j<.1){j=0}else{j=Math.min(j*(1+(q[Ee["mouthDimpleLeft"]].score+q[Ee["mouthDimpleRight"]].score)/2),1)}}let b=Ie.emotion_weight_percent/100;if(C)b*=b;for(const ie in Se){let e=Se[ie];let t=Ie.emotion_weight_by_name(ie,b);let i=-1,o=1;let n=V?1:t*.8;let a=t*.75;let s=0;let r;switch(ie){case"sad":s=I;r=.25;break;case"angry":s=R;r=.25;break;case"surprise":s=T;if(V){r=.25}break;case"blush":s=h;r=.2;o=.5;n=1;break;case"tongue_out":s=j;r=.2;a=.6;n=1;break}if(r){let e=Math.min(s/r,1);e*=e;n=Math.min(s+Math.max(n-s,0)*e*(e<1?a:1),n);i=s*e*o}Se[ie]=THREE.Math.clamp(Math.max(e,s)+i*Ie._t/1e3*4,0,n)}({sad:I,angry:R,surprise:T,blush:h,tongue_out:j}=Se);if(j){if($){j=j<.5?Math.pow(j*2,2)/2:Math.pow((j-.5)*2,.5)/2+.5}else{if(j<.5){j=0}else{j=Math.sqrt(j);d*=1-j+j/2}}}if(C&&!$)Ye.add("morph|facemesh","TongueOut",{weight:j});if(!V){b=Math.min(b/.75,1);if(h)I+=h*.25*b}const J=Ie.emotion_weight_by_name("smile",Math.sqrt(b));t*=J;P*=J;I=Math.min(I,Ie.emotion_weight_by_name("sad",b));R=Math.min(R,Ie.emotion_weight_by_name("angry",b));h=Math.min(h,Math.min(Ie.emotion_weight_by_name("blush",b)/.75,1));T=Math.min(T,Ie.emotion_weight_by_name("surprise",b));if(V)T*=T;Ye.add("morph|facemesh","あ",{weight:d});Ye.add("morph|facemesh","い",{weight:c});Ye.add("morph|facemesh","う",{weight:m});Ye.add("morph|facemesh","え",{weight:u});Ye.add("morph|facemesh","お",{weight:p});Ye.add("morph|facemesh","にやり",{weight:x});Ye.add("morph|facemesh","口角上げ",{weight:i-s});Ye.add("morph|facemesh","上",{weight:_});Ye.add("morph|facemesh","にこり",{weight:t});Ye.add("morph|facemesh","困る",{weight:I});Ye.add("morph|facemesh","怒り",{weight:R});Ye.add("morph|facemesh","笑い",{weight:P});Ye.add("morph|facemesh","びっくり",{weight:T});Ye.add("morph|facemesh","照れ",{weight:h});Ye.add("morph|facemesh","ぺろっ",{weight:j});const U=!Ie.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["まばたきL"]!=null;if(U){Ye.add("morph|facemesh","まばたきL",{weight:Math.max(q[Ee["eyeBlinkRight"]].score-P,0)});Ye.add("morph|facemesh","まばたきR",{weight:Math.max(q[Ee["eyeBlinkLeft"]].score-P,0)});Ye.add("morph|facemesh","まばたき",{weight:0})}else{Ye.add("morph|facemesh","まばたきL",{weight:0});Ye.add("morph|facemesh","まばたきR",{weight:0});Ye.add("morph|facemesh","まばたき",{weight:Math.max(f-P,0)})}let v,w,S,A;if(Ie.auto_look_at_camera){const oe=THREE.MMD.getModels()[0].mesh;const ne=MMD_SA.TEMP_v3.copy(MMD_SA._trackball_camera.object.position).sub(MMD_SA._head_pos).normalize().applyQuaternion(MMD_SA.get_bone_rotation(oe,"頭").conjugate());const ae=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(MMD_SA._v3a.set(0,0,1),ne));v=-Math.sign(ae.x)*Math.min(Math.abs(ae.x/(Math.PI/4)),1);w=-Math.sign(ae.y)*Math.min(Math.abs(ae.y/(Math.PI/4)),1);A=1}else{v=(q[Ee["eyeLookUpLeft"]].score+q[Ee["eyeLookUpRight"]].score)/2-(q[Ee["eyeLookDownLeft"]].score+q[Ee["eyeLookDownRight"]].score)/2;w=(q[Ee["eyeLookInRight"]].score+q[Ee["eyeLookOutLeft"]].score)/2-(q[Ee["eyeLookInLeft"]].score+q[Ee["eyeLookOutRight"]].score)/2;A=Ie.eye_bone_rotation_percent/100}S={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-v*15/180*Math.PI,-w*20/180*Math.PI,0).multiplyScalar(A),"YZX")};Ye.add("skin|facemesh","両目",S)}else{let e=P-(I+R+b+T*.5);if(e<0){y*=Math.max(1+e*2,0)}else{y=Math.min(e*.2+y*(1+e*.5),.4)}Ye.add("morph|facemesh","にこり",{weight:ue["にこり"].filter(Math.min(y+P*.75,.75))});Ye.add("morph|facemesh","困る",{weight:ue["困る"].filter(Math.min((I+b)/2*.75+(g<0?Math.max(-g*1-Math.max(x,0)*.5,0):0),.75))});Ye.add("morph|facemesh","怒り",{weight:ue["怒り"].filter(Math.min(R*.75,.75))});g+=T*.2;Ye.add("morph|facemesh","笑い",{weight:ue["笑い"].filter(y)});Ye.add("morph|facemesh","びっくり",{weight:ue["びっくり"].filter(T*.75)});Ye.add("morph|facemesh","にやり",{weight:ue["にやり"].filter(x)});let i=MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(k,E,l),"YZX").conjugate();let o=[];[13,14,61,291].forEach(function(e,t){o[e]=Ae[t].fromArray(D.mesh[e]).applyQuaternion(i).setZ(0)});let t=MMD_SA._v3a.copy(o[61]).add(o[291]).multiplyScalar(.5);let n=o[61].distanceTo(o[291])*.5;let a=Math.atan2(o[13].y-t.y,n);let s=Math.atan2(o[14].y-t.y,n);let r=Math.max(-(a+s)*180/Math.PI+20*M,0);if(r)r=Math.min(r/20,.75);r=Math.min(r+I*.25,1);r*=.5;M=M*(1-r);Ye.add("morph|facemesh","あ",{weight:ue["あ"].filter(M)});Ye.add("morph|facemesh","お",{weight:ue["お"].filter(r)});let _={L:[],R:[]};if(!Ie.eye_tracking){}else if(De){let i=[0,0];let o=[0,0];D.eyes.forEach(function(e,t){if(e){i[t]=Math.max(Math.min((e[3]*2+k/(Math.PI/2))*(1-Math.abs(k)/Math.PI),1),-1);o[t]=Math.max(Math.min((e[2]*2-E/(Math.PI/2))*(1-Math.abs(E)/Math.PI),1),-1)}});let e=(v.L[0]+v.R[0])/2;if(e>1)g+=(e-1)*2;else g-=(1-e)*.5;g=Math.min(g,1);let t=v.L[0]+v.R[0];if(t)t=v.L[0]/t;else t=.5;let n=i[0]*t+i[1]*(1-t);let a=o[0]*t+o[1]*(1-t);let s={absolute:true,rot:(new THREE.Quaternion).fromArray(ue["両目"].filter(MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(-(n-.3)*15/180*Math.PI,a*d*20/180*Math.PI,0),"YZX").toArray()))};Ye.add("skin|facemesh","両目",s);let r=!Ie.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["まばたきL"]!=null;let _=(r?Math.min(Math.max(Math.abs(v.L[0]-v.R[0])-(.25+(1-Math.min(Math.max((Math.PI/6-Math.abs(E))/(Math.PI/12),0),1))*1),0)/.25,1):0)*z;let l=r?Math.min(v.L[0],v.R[0]):(v.L[0]+v.R[0])/2;v.L[0]=v.L[0]*_+l*(1-_);v.R[0]=v.R[0]*_+l*(1-_);if(r){let e="まばたき"+(d==1?"L":"R");Ye.add("morph|facemesh",e,{weight:ue[e].filter(Math.max(Math.min(1-v.L[0]*.8-y,1),0))});e="まばたき"+(d==1?"R":"L");Ye.add("morph|facemesh",e,{weight:ue[e].filter(Math.max(Math.min(1-v.R[0]*.8-y,1),0))});Ye.add("morph|facemesh","まばたき",{weight:0})}else{Ye.add("morph|facemesh","まばたきL",{weight:0});Ye.add("morph|facemesh","まばたきR",{weight:0});Ye.add("morph|facemesh","まばたき",{weight:ue["まばたき"].filter(Math.max(Math.min(1-v.L[0]*.8-y,1),0))})}}else{let e=D.eyes[0];let t=0;let i=0;if(e){t=Math.max(Math.min((e[3]*2+k/(Math.PI/2))*(1-Math.abs(k)/Math.PI),1),-1);i=Math.max(Math.min((e[2]*2-E/(Math.PI/2))*(1-Math.abs(E)/Math.PI),1),-1)}let o=g*.25;if(o<0)o=Math.min(o+y,0);let n=Math.max(Math.min(.1-t*(t<0?2:1)*.2-o,.5),0);Ye.add("morph|facemesh","まばたき",{weight:n});let a=1.25+Math.pow((v.L[0]+v.R[0])/2,2)*1.75;t=Math.sign(t)*Math.pow(Math.abs(t),a);i=Math.sign(i)*Math.pow(Math.abs(i),a);let s={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-t*15/180*Math.PI,i*d*20/180*Math.PI,0),"YZX")};Ye.add("skin|facemesh","両目",s)}if(Ie.eye_tracking)Ye.add("morph|facemesh","上",{weight:ue["上"].filter(Math.max(Math.min(g,1),-1))})}if(!Te.enabled){if(!Ye.skin["センター"])Ye.add("skin","センター",{rot:new THREE.Quaternion});const L=MMD_SA.MMD.motionManager.para_SA;if(L.motion_tracking_upper_body_only){for(const W of["左","右"]){const se=true;if(L.has_leg_IK){Ye.set_blend_default_motion("skin",W+"足ＩＫ",true);Ye.remove("skin",W+"足首")}else{Ye.set_blend_default_motion("skin",W+"足",true);Ye.set_blend_default_motion("skin",W+"ひざ",true);Ye.set_blend_default_motion("skin",W+"足首",true)}Te.enable_IK(W+"足ＩＫ",L.has_leg_IK);Te.enable_IK(W+"つま先ＩＫ",L.has_leg_IK);Ye.set_blend_default_motion("skin",W+"肩",se);Ye.set_blend_default_motion("skin",W+"腕",se);Ye.set_blend_default_motion("skin",W+"ひじ",se);Ye.set_blend_default_motion("skin",W+"手捩",se);Ye.set_blend_default_motion("skin",W+"手首",se);Ye.set_blend_default_motion("skin",W+"腕ＩＫ",se);Te.enable_IK(W+"腕ＩＫ",true)}}else{for(const W of["左","右"]){Te.enable_IK(W+"腕ＩＫ",L.has_arm_IK)}Ye.remove("skin","センター")}}w=w||D.eyes.length&&[(!Te.enabled?Pe.video_canvas.width+"x"+Pe.video_canvas.height+"("+Ie.camera_video_frame_id+")\n":"")+(fe?"Calibrating("+he+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(D.faceInViewConfidence*100)+"%",D.emotion?JSON.stringify(D.emotion):"Neutral"].join("\n");if(_e)w+="\n"+_e;w+=(Le||!Te.enabled?Fe?"\n"+Fe+"\n":"":"")+(Le||"");System._browser.motion_control.process(A)}else{w="(no facemesh data)\n"+Le}if(!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden){System._browser.on_animation_update.add(()=>{DEBUG_show(w&&w+(!Te.enabled||!Te.use_holistic?"\nF-FPS:"+Math.round(le)+"/"+Math.round(S.fps||0):"")+"\n"+"FPS:"+EV_sync_update.fps_last||"")},0,0)}Ie.busy=0}Ie.update_frame()}}();var k=document.createElement("canvas");var _=true;var l;var d,c,m,u,p,h;var f;var D=[];var M=0;var y=0;Ie={initialized:false,worker_initialized:false,faceBlendshapes_list:S,MMD_morph_list:r,get data_detected(){return M},set data_detected(e){if(e){if(!M){y=RAF_timestamp}}else{y=0}M=e},get data_detected_stable(){return i&&y&&RAF_timestamp-y>250},get head_pose_enabled(){return this.data_detected_stable||!Te.enabled},get blink_detection(){return we},set blink_detection(e){we=e;if(i){if(we){n()}else{MMD_SA_options.auto_blink=a!=null?a:MMD_SA_options.auto_blink}}},get auto_blink(){return b},set auto_blink(e){b=e},get eye_bone_rotation_percent(){return f==null?100:f},set eye_bone_rotation_percent(e){f=e},get eye_tracking(){return _},set eye_tracking(e){_=e;if(_){this.blink_detection=!!De}else{this.blink_detection=false}if(i){if(!_){Ye.remove("skin","両目");Ye.remove("morph","まばたきL");Ye.remove("morph","まばたきR");Ye.remove("morph","まばたき");Ye.remove("morph","上");Ye.remove("morph","下")}}},get use_faceLandmarksDetection(){return De},set use_faceLandmarksDetection(e){if(!this.initialized)De=e},get use_mediapipe(){return v||Te.enabled&&Te.use_holistic},set use_mediapipe(e){return v=e},get use_faceBlendshapes(){return!Te.enabled||!Te.use_holistic},get calibrated(){return!fe&&he>=100},get use_tongue_out(){return l==null?1:l},set use_tongue_out(e){l=e},get emotion_weight_percent(){return d==null?75:d},set emotion_weight_percent(e){d=e},get emotion_joy_fun_percent(){return c==null?100:c},set emotion_joy_fun_percent(e){c=e},get emotion_angry_percent(){return m==null?100:m},set emotion_angry_percent(e){m=e},get emotion_sorrow_percent(){return u==null?100:u},set emotion_sorrow_percent(e){u=e},get emotion_surprised_percent(){return p==null?100:p},set emotion_surprised_percent(e){p=e},get emotion_others_percent(){return h==null?100:h},set emotion_others_percent(e){h=e},emotion_weight_by_name:function(e,t=1){switch(e){case"smile":return t*this.emotion_joy_fun_percent/100;case"angry":return t*this.emotion_angry_percent/100;case"sad":return t*this.emotion_sorrow_percent/100;case"surprise":return t*this.emotion_surprised_percent/100;case"blush":return t*this.emotion_others_percent/100;default:return t}},export_calibration:function(){const e={facemesh_calibration_type:Te.use_holistic?"holistic":"facemesh",lips_width_average:Me,eyebrow_data:{L:{height_average:ye.L.height_average},R:{height_average:ye.R.height_average}},eye_data:{L:{eye_open_average:be.L[0].eye_open_average},R:{eye_open_average:be.R[0].eye_open_average}},neck_length_average:g};System._browser.save_file("facemesh_calibration.json",JSON.stringify(e,null,"\t"),"application/json")},import_calibration:function(e){this.reset_calibration();Me=e.lips_width_average;for(const t of["L","R"]){Object.assign(ye[t],e.eyebrow_data[t]);Object.assign(be[t][0],e.eye_data[t])}g=e.neck_length_average||1.25;he=100;fe=false},face_width:0,_neck:{},calculate_neck_data:(()=>{let u,p,h;let f;let M;window.addEventListener("jThree_ready",()=>{u=new THREE.Vector3;p=new THREE.Vector3;h=new THREE.Vector3;f=new THREE.Quaternion;M=new System._browser.data_filter([{type:"one_euro",id:"neck_length",para:[30,1,1,1,1]}])});return function(t){if(!Te.enabled||!Ie.enabled||!this._neck.data)return false;let e=this._neck.data.find(e=>e.timestamp===t.timestamp);if(!e){this._neck.data.unshift(t);return false}Object.assign(e,t);if(!(e.is_pose&&e.is_face))return false;const i=u.fromArray(e.f_axis);const o=p.fromArray(e.shoulder_center).setZ(0);const n=h.set(0,0,e.face_width/3).applyQuaternion(f.fromArray(e.face_rot).conjugate()).setZ(0).y;const a=MMD_SA.MMD.motionManager.para_SA;let s=a.motion_tracking?.camera?.tilt_adjustment||Pe.tilt_adjustment;let r=s.enabled?s.angle*Math.PI/180:0;const _=a.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(_.upper_rotation_offset){const m=_.upper_rotation_offset*Math.PI/180;r*=Math.cos(m)}const l=e.spine_rot_absolute[0]+r;this._neck._spine_rot_absolute=e.spine_rot_absolute.slice();this._neck._spine_rot_absolute[0]+=r;let d=M.filter(i.distanceTo(o)+n)/e.face_width/Math.max(Math.abs(Math.cos(l)));if(fe){window.addEventListener("SA_camera_facemesh_calibrating",()=>{ve.push(d);let e=parseInt(ve.length*.3);g=ve.sort((e,t)=>e-t).slice(e,ve.length-e).reduce((e,t)=>e+t)/(ve.length-e*2)},{once:true})}this._neck.data.length=0;if(!g)return false;let c=d/g;Ne[2]=!Te.shoulder_tracking||c>.95?0:(1-Math.max((c/.95-.8)/(1-.8),0))*Math.PI/8;if(t.is_pose)return true;return true}})(),get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;q();this.busy=0;this.data_detected=0;D[0]=D[1]=.5;this._neck={data:[]};if(i){if(!this.initialized)s();a=MMD_SA_options.auto_blink;const t=Te.use_holistic?1:0;n(o!=t);o=t}else{MMD_SA_options.auto_blink=a}R()},get bb_center(){return D},set bb_center(e){D=e},reset_calibration:n,get frames(){return Ye},init:s,worker_onmessage:A,camera_video_timestamp:0,update_frame:function(e){async function t(){var e=Ie.enabled&&Ie.worker_initialized&&E&&!Ie.busy&&!(Te.enabled&&Te.use_holistic)&&P&&Ie.camera_video_timestamp!=E;if(!e)return;Ie.busy=RAF_timestamp;Ie.camera_video_timestamp=E;Ie.camera_video_frame_id=x;if(we){MMD_SA_options.auto_blink=b||false}let n;let a,s;let r,_;let l,d;let t;n=Pe.video_canvas;let i=n.width,o=n.height;l=d=0;a=r=i;s=_=o;let c=1;let m=MMD_SA_options.user_camera.pixel_limit.facemesh;if(m){if(a*s>m[0]*m[1]){c=Math.sqrt(a*s/(m[0]*m[1]));a=r=Math.round(a/c);s=_=Math.round(s/c);n=k;t=true}}let u,p,h;if(MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio){u=MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio;h=Math.round(Math.min(a,s)*u);r=h;_=h;let e=1;const y=5*(v?2:1);if(Ie.data_detected<y&&u<1&&!Te.enabled){e=u+(1-u)*(1-Math.min(Ie.data_detected/y,1));h=Math.round(Math.min(a,s)*e);p=u/e;u=e;n=k;t=true}l=Math.max(Math.min(a*D[0]-h/2,a-h),0)*(p||1);d=Math.max(Math.min(s*D[1]-h/2,s-h),0)*(p||1)}let f=n.getContext("2d");if(t){f.globalCompositeOperation="copy";let e=l,t=d,i=r,o=_;if(p){i=o=h;if(n.width!=r||n.height!=_){n.width=r;n.height=_;console.log("Facemesh canvas("+a+"x"+s+"=>"+r+"x"+_+"):"+[e,t,h,h].join(",")+"=>"+[l,d,r,_].join(","))}}else{if(n.width!=r||n.height!=_){n.width=r;n.height=_;console.log("Facemesh canvas("+a+"x"+s+")")}}f.drawImage(Pe.video_canvas,Math.round(e*c),Math.round(t*c),Math.round(i*c),Math.round(o*c),0,0,r,_)}let M=I&&v?await createImageBitmap(n,t?0:l,t?0:d,r,_):f.getImageData(t?0:l,t?0:d,r,_).data.buffer;Ie._timestamp=Pe.video_timestamp;let g={rgba:M,w:a*(p||1),h:s*(p||1),options:{use_facemesh:true,draw_canvas:true,flip_canvas:Pe.display_flipped,bb:{x:Math.round(l),y:Math.round(d),w:r,h:_,ratio:u||0,scale:p||1,timestamp:Ie._timestamp}}};if(self.FacemeshAT){g.canvas=Pe.video_canvas_facemesh}else if(!Pe.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){g.canvas=Pe.video_canvas_facemesh.transferControlToOffscreen();Pe.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}Re.postMessage(g,g.canvas?[g.canvas,g.rgba]:[g.rgba]);g.rgba=M=undefined;g=undefined}if(e||self.FacemeshAT){setTimeout(()=>{t()},0)}else{t()}}};return Ie}(),poseNet:function(){var i=false;var t=true;var n=true;var a={};var o=null;var s=0;var r=0;var _=0;var l=null;var d=null;var c=0;var m;var u,p,h,f;var M,g,y;Te={get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;$e=0;Xe=false;this.data_detected=0;this.initial_data_detected=false;_=0;THREE.MMD.getModels()[0].mesh.visible=true;j.set(0,0,0);if(i){if(!this.initialized)G();if(U){worker_id=Te.use_holistic?"legacy_holistic":"tasks_vision";if(!b[worker_id]){mt=[{},{}];v.terminate();for(const t in b)delete b[t];v=new Worker(U);v.onmessage=xe;w=worker_id;b[w]=new K(w,v)}console.log("Web worker ID:"+w);v=b[w].worker;D=b[w].initialized}MMD_SA_options.user_camera.ML_models.pose.events.enabled&&MMD_SA_options.user_camera.ML_models.pose.events.enabled()}else{THREE.MMD.getModels()[0].resetPhysics();MMD_SA_options.user_camera.ML_models.pose.events.disabled&&MMD_SA_options.user_camera.ML_models.pose.events.disabled()}R();if(Te.use_holistic){setTimeout(()=>{if(i)Ie.enabled=je.enabled=true;else je.enabled=false;DEBUG_show("(Holistic Mode:"+(i?"ON":"OFF")+")",2)},0)}},get data_detected(){return s},set data_detected(e){if(1){if(e){if(!s){r=RAF_timestamp}if(this.data_detected_stable){_=0}}else{r=0;if(!_){_=RAF_timestamp}if(RAF_timestamp-_>250){Ye.reset()}}}s=e},get data_detected_stable(){return i&&(!_||RAF_timestamp-_<250||r&&RAF_timestamp-r>500)},get use_3D_pose(){return i&&t&&nt},set use_3D_pose(e){t=e},get use_holistic(){return o==null?C:o},set use_holistic(e){o=e},get _use_holistic_(){return C},set _use_holistic_(e){C=e},get skip_hand_countdown_max(){return 0},set IK_disabled(e){n=e},get auto_grounding(){return l!=null?l:MMD_SA_options.user_camera.ML_models.pose.auto_grounding||MMD_SA.WebXR.session},set auto_grounding(e){l=e},get ground_plane_visible(){return d!=null?d:!i||!!MMD_SA_options.user_camera.ML_models.pose.auto_grounding||MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only},set ground_plane_visible(e){d=e},get spine_length_ref(){if(c)return c;const e=MMD_SA_options.model_para_obj.left_leg_length/MMD_SA_options.model_para_obj.spine_length;return Te.leg_scale_adjustment?Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length*(e/1.83))*(21-Te.leg_scale_adjustment)/20:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)},set spine_length_ref(e){c=e},get shoulder_tracking(){return m==null?1:m},set shoulder_tracking(e){m=e},get hip_adjustment_weight_percent(){return u==null?100:u},set hip_adjustment_weight_percent(e){u=e},get hip_adjustment_head_weight_percent(){return p==null?100:p},set hip_adjustment_head_weight_percent(e){p=e},get hip_adjustment_adjust_y_axis_percent(){return h==null?66:h},set hip_adjustment_adjust_y_axis_percent(e){h=e},get hip_adjustment_scale_x_percent(){return M==null?100:M},set hip_adjustment_scale_x_percent(e){M=e},get hip_adjustment_scale_y_percent(){return g==null?100:g},set hip_adjustment_scale_y_percent(e){g=e},get hip_adjustment_scale_z_percent(){return y==null?100:y},set hip_adjustment_scale_z_percent(e){y=e},get hip_adjustment_smoothing_percent(){return f==null?0:f},set hip_adjustment_smoothing_percent(e){f=e},leg_scale_adjustment:0,IK_disabled_check:function(){var o=new RegExp("("+toRegExp(["腕ＩＫ","足ＩＫ","つま先ＩＫ"],"|")+")$");var e=new RegExp("("+toRegExp(["腕ＩＫ"],"|")+")$");return function(e){const t=MMD_SA.MMD.motionManager.para_SA;if(!n||!this.data_detected&&(this.enabled||!Ie.enabled||!Ie.data_detected)||!t.motion_tracking_enabled)return null;let i=!e||o.test(e);if(i&&e){if(a[e])i=false}return i}}(),enable_IK:function(e,t){a[e]=t},get frames(){return Ye},camera_video_timestamp:0,get busy(){return $e},get initialized(){return A},get worker_initialized(){return D},set worker_initialized(e){D=e;if(!self.PoseAT)b[w].initialized=e}};return Te}(),handpose:function(){var t=false;var i={};var o={};var n,a;var s;je={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){i={};o={};if(!this.initialized)G()}},get hand_visible_timestamp(){return i},get hand_visible_session(){return o},get frames(){return Ye},get busy(){return $e},get initialized(){return A},get worker_initialized(){return D},set worker_initialized(e){D=b[w].initialized=e},get stabilize_arm(){return n==null?2:n},set stabilize_arm(e){n=e},get stabilize_arm_time(){return a==null?0:a},set stabilize_arm_time(e){a=e},get stabilize_hand_percent(){return s==null?20:s},set stabilize_hand_percent(e){s=e},_hand_last:{"左":{},"右":{}}};return je}(),reset_video_canvas:function(){if(this.video_canvas){this.video_canvas.width=this.video_canvas.height=E=0;x=""}},show:function(){if(!this.initialized||this.visible)return;this.visible=true;if(Pe.target_devicePixelRatio!=window.devicePixelRatio){Pe.target_devicePixelRatio=0;Pe.video_track.applyConstraints(Pe.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)})["catch"](function(e){DEBUG_show("ERROR:camera size failed to update")})}s();if(this.hidden_enforced)this.hide()},hide:function(){if(!this.initialized||!this.visible)return;this.visible=false;this.video_canvas.style.visibility="hidden";d.enabled=false;c.enabled=false;l()},set_constraints:function(e){var t={};const i=window.devicePixelRatio/this.target_devicePixelRatio;let o,n;const a=is_mobile?Math.min(270/Math.min(window.innerWidth,window.innerHeight),i):i;o=Math.round(window.innerWidth*a);n=Math.round(window.innerHeight*a);var s=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(!u){if(MMD_SA_options.user_camera.pixel_limit.fixed){o=s[0];n=s[1]}else if(o*n>s[0]*s[1]){const r=Math.sqrt(o*n/(s[0]*s[1]));o=Math.round(o/r);n=Math.round(n/r)}}Pe.target_width=o;Pe.target_height=n;if(!MMD_SA_options.user_camera.pixel_limit.disabled){if(!is_mobile||!screen.orientation||/landscape/.test(screen.orientation.type)){t.width=o;t.height=n}else{t.width=n;t.height=o}}if(MMD_SA_options.user_camera.fps)t.frameRate=MMD_SA_options.user_camera;if(e)t=Object.assign(t,e);console.log("Camera constraints",t);return t}};return Pe}(),data_filter:function(){class e{constructor(){}filter(e){return e}}class t{constructor(e){this.filters=e;e.forEach(e=>{switch(e.type){case"one_euro":if(e.transition_time){e.para[1]=1/(1/(1/e.transition_time/60)-1)*60/(2*Math.PI);console.log("transition_time => minCutoff",e.para[1])}e.filter=new OneEuroFilter(...e.para||[]);break}if(e.id)e.filter.id=e.id})}filter(t,i=System._browser.camera.initialized&&System._browser.camera.ML_enabled?System._browser.camera.video_timestamp:RAF_timestamp){if(t!=null){this.filters.forEach(e=>{if(!e.condition||e.condition()){this.data=e.filter.filter(t,i);this.timestamp=RAF_timestamp}})}return this.data}}return t}(),motion_control:function(){var s,u,m,i,_,p;var c;var h;var f=function(){var r={};var a={};return{pressed:r,map:a,temp:{},set_options:function(e){if(!l)return;if(!e.timeout_list){const t=["W","A","S","D"];for(const i of["L","R"]){for(const o in e[i]){const n=e[i][o];if(n.press)t.push(...n.press)}}e.timeout_list=t.map(e=>p[e])}if(!e.clear_list)e.clear_list={};for(const i of["L","R"]){if(!e.clear_list[i]){const t=i=="L"?["W","A","S","D"]:[];for(const o in e[i]){const n=e[i][o];if(n.press)t.push(...n.press)}e.clear_list[i]=t.map(e=>[p[e]])}}this.temp={};Object.assign(a,e);console.log(a)},action:function(e,t,i){var o=a[t][i]||{};return{press:o.press&&(!o.press_check||o.press_check(e))&&o.press||[],release:o.release||[],click:o.click&&(!o.click_check||o.click_check(e))&&o.click||[]}},activate:async function(e,t,i,o=[]){const n=this.action(e,t,i);if(n.click.length)await f.click(...n.click.map(e=>[p[e]]));if(n.press.length){const a=n.press.map(e=>p[e]);o=[...o.filter(e=>a.indexOf(e[0])==-1),...n.release.map(e=>[p[e]])];if(o.length)await f.releaseKey(...o);await f.pressKey(...a.map(e=>[e]))}},clear_list:function(e){return a.clear_list[e]},pressKey:async function(...e){let t=Array.isArray(e[0])&&e||[e];var i=[];for(const o of t){const n=o.filter(e=>!r[e]);if(n.length){for(const s of n)r[s]=-1;await _.pressKey(...n);const a=n.filter(e=>r[e]==-2);if(a.length){await _.releaseKey(...a);for(const s of a)r[s]=0;console.log("key released enforced",a.length)}}for(const s of o){if(r[s])r[s]=RAF_timestamp}}},releaseKey:async function(...e){const t=!e.length?Object.keys(r).map(e=>[parseInt(e)]):Array.isArray(e[0])&&e||[e];const i=[];for(const o of t){const n=o.filter(e=>r[e]>0);if(n.length){i.push(_.releaseKey(...n).then(()=>{for(const e of n)r[e]=0}))}const a=o.filter(e=>r[e]<0);a.forEach(e=>{r[e]=-2})}if(i.length){await Promise.all(i)}},releaseIdleKey:async function(...e){const t=!e.length?Object.keys(r).map(e=>[parseInt(e)]):Array.isArray(e[0])&&e||[e];const i=t.map(e=>e.filter(e=>r[e]&&(a.timeout_list.indexOf(e)==-1||RAF_timestamp-(r[e]>0?r[e]:RAF_timestamp)>500))).filter(e=>e.length);if(i.length){await f.releaseKey(...i)}},click:async function(...e){const t=Array.isArray(e[0])&&e||[e];await this.pressKey(...t);await this.releaseKey(...t)}}}();var M={custom:{},list:[],estimate:function(e,t,i=9){const o=e.estimate(t.keypoints,i);if(o.gestures.length){o.gestures.forEach(e=>{e._d=t._d;e.hand_facing=this.list[0].hand_facing[t._d];e.hand_rot_YXZ=this.list[0].hand_rot_YXZ[t._d];e.thumb_out=this.list[0].thumb_out[t._d];e.poseData=o.poseData});this.list[0].gestures=this.list[0].gestures.concat(o.gestures)}return o},search:function(i,n={}){function a(e){return e.gestures.find(t=>i.split("|").some(e=>t.name==e&&(!n.hand||n.hand._d==t._d)&&(!n.hand_facing||n.hand_facing===t.hand_facing)&&(n.thumb_out==null||n.thumb_out===t.thumb_out)&&(!n.condition||t._condition_passed||n.condition(t)&&(t._condition_passed=true))))}var e=n.time_limit||0;var t;for(let i=0,o=this.list.length;i<o;i++){const s=this.list[i];if(s.timestamp<RAF_timestamp-e)break;const r=a(s);if(!r)continue;if(n.duration&&i<o-1){let e=s.timestamp-this.list[i+1].timestamp;let t;for(t=i+1;t<o;t++){const _=this.list[t];if(a(_)){e=t==o-1?9999:s.timestamp-this.list[t+1].timestamp;if(e>=n.duration)break}else break}if(e<n.duration){i=t;continue}}t=r;t.search_para=Object.assign({},n);break}return t}};var g,y,b,v;var e,t,o,n;var a=false;var l,d;var r=false;var w;var S=true;async function A(){async function e(){if(l)return;l=true;g=new THREE.Vector3;y=new THREE.Vector3;b=new THREE.Vector3;v=new THREE.Vector3;d=true;await System._browser.load_script("js/fingerpose.js");const t=new fp.GestureDescription("index_up");t.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);t.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){t.addCurl(e,fp.FingerCurl.FullCurl,1);t.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_up=t;const i=new fp.GestureDescription("index_thumb");i.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);i.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);i.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){i.addCurl(e,fp.FingerCurl.FullCurl,1);i.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_thumb=i;const o=new fp.GestureDescription("index_middle");o.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);o.addCurl(fp.Finger.Middle,fp.FingerCurl.NoCurl,1);o.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);o.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpLeft,1);o.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpRight,1);for(let e of[fp.Finger.Ring,fp.Finger.Pinky]){o.addCurl(e,fp.FingerCurl.FullCurl,1);o.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_middle=o;const n=new fp.GestureDescription("index_pinky");n.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);n.addCurl(fp.Finger.Pinky,fp.FingerCurl.NoCurl,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring]){n.addCurl(e,fp.FingerCurl.FullCurl,1);n.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_pinky=n;for(const a of["thumb","thumb_index","thumb_palm"]){const s=new fp.GestureDescription(a);for(const r of[fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){const _=a=="thumb_palm"||(r==fp.Finger.Index?a=="thumb_index":false);if(_){s.addCurl(r,fp.FingerCurl.NoCurl,1);if(a=="thumb_palm")s.addCurl(r,fp.FingerCurl.HalfCurl,.7)}else{s.addCurl(r,fp.FingerCurl.FullCurl,1);s.addCurl(r,fp.FingerCurl.HalfCurl,.9)}}M.custom[a]=s}const e=new fp.GestureDescription("palm_open");for(const r of[fp.Finger.Thumb,fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){e.addCurl(r,fp.FingerCurl.NoCurl,1)}e.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpLeft,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpRight,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalLeft,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalRight,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpLeft,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpRight,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalLeft,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalRight,1);M.custom.palm_open=e;c=new fp.GestureEstimator([M.custom.index_up]);System._browser.on_animation_update.add(()=>{const t=M.list;for(let e=t.length-1;e>=0;e--){if(t[e].timestamp>RAF_timestamp-3e3){if(e<t.length-1)t.length=e+1;break}}},0,1,-1);DEBUG_show("Motion control initialized",3)}async function t(){if(w)return;w=true;return;({getActiveWindow:s,Point:u,centerOf:m,mouse:i,keyboard:_,Key:p}=require("node_modules.asar/nut.js/node_modules/@nut-tree/nut-js"));i.config.autoDelayMs=0;_.config.autoDelayMs=0;r=true}await e();await t();d=false}function D(e,t){var i=t.annotations.thumb;var o=[t.annotations.index[0][1],t.annotations.middle[0][1],t.annotations.ring[0][1],t.annotations.pinky[0][1]];var n=i[1][1]>Math.max(...o);var a,s;if(n){s=e.hand_rot_YXZ[1];if(s<=20)a="Horizontal Left";else if(s>20&&s<=50)a="Diagonal Down Left";else if(s>130&&s<=160)a="Diagonal Down Right";else if(s>160)a="Horizontal Right";else a="Vertical Down";if(!e.thumb_out&&/Horizontal/.test(a)){a="";s=0}}else{if(!e.thumb_out){a="";s=0}else{const r=-(i[3][1]-i[1][1]);const _=i[3][0]-i[1][0];s=Math.atan2(r,_)*180/Math.PI-90;if(s<-180)s+=360;s=-s;if(s>20&&s<=60)a="Diagonal Up Right";else if(s>60&&s<=120)a="Horizontal Right";else if(s<-20&&s>=-60)a="Diagonal Up Left";else if(s<-60&&s>=-120)a="Horizontal Left";else a="Vertical Up"}}return[a+"\n"+(i[1][1]>Math.max(...o))+"\n"+e.hand_rot_YXZ.join("\n"),s]}var k=function(){var i,o,n,e,a;return function(){if(e!=RAF_timestamp){e=RAF_timestamp;i=null;a=[];s().then(async e=>{[o,n]=await Promise.all([e.title,e.region]);i=e;const t={w:i,title:o,region:n};a.forEach(e=>{e(t)})})}return new Promise((e,t)=>{if(i){e({w:i,title:o,region:n})}else{a.push(e)}})}}();var E=["０","１","２","３"];var x=[];var P=[];const I={get enabled(){return a},set enabled(e){if(a==!!e)return;a=!!e;if(a){A()}else{this.setMousePosition(null)}DEBUG_show("Motion control:"+(a?"ON":"OFF"),3)},get enabled_nut(){return r},get ready(){return a&&!d},get handedness(){return h},get off_hand(){return h=="左"?"右":"左"},get window_active(){return window_active},get _debug_msg(){return x},get debug_msg(){return a&&x.length?x.join("\n")+"\n":""},get Key(){return p},get key_pressed(){return f.pressed},gestures:M,get plugins(){return P},add_plugin:function(e){if(P.indexOf(e)==-1)P.push(e)},process:async function(t){if(!this.ready)return;if(t.posenet_data){if(!M.list.length||M.list[0].timestamp!=RAF_timestamp){M.list.unshift({timestamp:RAF_timestamp,gestures:[]})}x=["Motion control"+(S?"(PAUSED)":"")+":"];const e=t.posenet_data.handpose;if(e&&e.length){const _={};const l={};const d={};e.forEach(e=>{if(!e._used)return;const t=System._browser.camera.poseNet.frames.skin[e._d+"手首"];if(!t)return;const i=MMD_SA.TEMP_v3.setEulerFromQuaternion(t[0].rot,"YXZ");l[e._d]=i.toArray().map(e=>e*180/Math.PI);_[e._d]=Math.abs(i.y)<Math.PI/4?"front":Math.abs(Math.abs(i.y)-Math.PI)<Math.PI/4?"back":"sideway";const o=e.annotations;const n=g.fromArray(o.index[0]);const a=y.fromArray(o.middle[0]).sub(n);const s=MMD_SA._v3a.fromArray(o.thumb[3]);const r=(s.x*a.x+s.y*a.y+s.z*a.z-(n.x*a.x+n.y*a.y+n.z*a.z))/a.lengthSq();d[e._d]=-r>1.3*Math.abs(Math.abs(l[e._d][1])-90)/90+.2});M.list[0].hand_rot_YXZ=l;M.list[0].hand_facing=_;M.list[0].thumb_out=d;e.forEach(e=>{if(!r)return;if(!e._used)return;if(S){M.estimate(c,e);const t=M.search("index_up",{duration:1e3,hand_facing:"front",thumb_out:false});if(t){S=false;h=t._d;DEBUG_show("Motion control:READY",2)}}else if(e._d==h){M.estimate(c,e);const t=M.search("index_up",{duration:1e3,hand_facing:"back",thumb_out:false});if(t){S=true;DEBUG_show("Motion control:PAUSED",2)}}})}}else if(t.facemesh_data){}P.forEach(e=>{e.process(t)});if(!r)return;if(S)return;this.virtual_mouse.process(t);this.game01.process(t)},setMousePosition:function(){var t;return async function(e){if(e===null){t=null;return}if(!a)return;if(!r)return;if(e){t=e}else if(!e){return}await i.setPosition(t)}}(),game01:function(){var t,e;var i={id:"PSO2NGS",L:{thumb:{release:["Space","X"]},thumb_index:{press:["X"],release:["Space"]},thumb_palm:{press:["Space"],release:["X"]}},R:function(){function e(e){const t=f.temp.index_middle||0;const i=e.thumb_out?1:0;f.temp.index_middle=i;return t!=i}return{index_thumb:{press:["Tab"],press_check:function(){if(!f.temp.index_thumb)f.temp.index_thumb={};f.temp.index_thumb.clicked=true;return true}},index_up:{press:["Q"],press_check:function(){var e=f.temp.index_thumb&&f.temp.index_thumb.clicked;if(e)f.temp.index_thumb.clicked=false;return e}},index_middle1:{press:["Period"],click:["Semicolon"],click_check:e},index_middle2:{press:["Slash"],click:["Semicolon"],click_check:e},index_middle3:{press:["Quote"],click:["Semicolon"],click_check:e},thumb_palm:{press:["Backslash"]}}}()};var d;var o,n;function c(){if(e)return;d=new fp.GestureEstimator([M.custom.index_up,M.custom.index_thumb,M.custom.index_middle,M.custom.index_pinky,M.custom.palm_open,M.custom.thumb,M.custom.thumb_index,M.custom.thumb_palm]);f.set_options(i);e=true}return{get enabled(){return t},set enabled(e){t=e;if(t){f.set_options(i)}else{}},process:async function(i){if(!this.enabled){await f.releaseKey();return}c();const a=await k();const e=await a.title;if(i.facemesh_data&&i.head_rot){let e=i.head_rot.x*180/Math.PI;let t=i.head_rot.y*180/Math.PI;let o=Math.round(Math.sign(e)*Math.pow(Math.min(Math.max((Math.abs(e)-8)/15,0),1),2)*40);let n=Math.round(Math.sign(t)*Math.pow(Math.min(Math.max((Math.abs(t)-10)/20,0),1),2)*40);x.push(e,t,n,o);Promise.resolve(a.region).then(async e=>{const t=await m(e);const i=e.width-1280<64?[1280,720]:[1920,1080];t.y+=Math.round((e.height-i[1]-(e.width-i[0]))/2);t.x+=n;t.y+=o;t.y+=1;t.x+=1;await I.setMousePosition(t)})}let t;if(i.posenet_data){t=i.posenet_data.handpose;let e="";if(!t||!t.length){t=null;if(M.search("palm_open",{time_limit:500,hand_facing:"front",condition:()=>{}})){e+="/CANCEL";await f.releaseKey()}else{await f.releaseIdleKey()}}x.push((t?"":"(no hand data)")+e+"/key active:"+Object.keys(f.pressed).filter(e=>f.pressed[e]).join(","))}if(!t)return;for(const n of t){if(!n._used)continue;const s=n._d==h?"R":"L";x.push(s+":");M.estimate(d,n);let i;i=M.search("palm_open",{hand:n,hand_facing:"front",condition:function(e){const t=this.hand;const i=g.fromArray(t.annotations.index[0]).sub(y.fromArray(t.annotations.index[3]));const o=b.fromArray(t.annotations.pinky[0]).sub(v.fromArray(t.annotations.pinky[3]));return i.angleTo(o)*180/Math.PI>30}});if(i){x.push("CANCEL");await f.releaseKey(...f.clear_list(s));continue}if(n._d==h){i=M.search("index_thumb",{hand:n,hand_facing:"back",thumb_out:true});if(i){await f.activate(i,s,i.name,f.clear_list(s));x.push("index_thumb");continue}i=M.search("index_up",{hand:n,hand_facing:"front",thumb_out:true});if(i){await f.activate(i,s,i.name,f.clear_list(s));x.push("index_up");continue}i=M.search("index_middle",{hand:n});if(i){let e=i.name;switch(i.poseData[1][2]){case"Vertical Up":e+=2;break;case"Diagonal Up Left":e+=h=="右"?1:3;break;case"Diagonal Up Right":e+=h=="右"?3:1;break}await f.activate(i,s,e,f.clear_list(s));x.push(e);continue}i=M.search("thumb_palm",{hand:n,condition:function(e){if(!/(Horizontal|Diagonal Up)/.test(e.poseData[2][2]))return false;const t=this.hand;const i=g.fromArray(t.annotations.index[0]).sub(y.fromArray(t.annotations.index[3]));const o=b.fromArray(t.annotations.pinky[0]).sub(v.fromArray(t.annotations.pinky[3]));return i.angleTo(o)*180/Math.PI<20}});if(i){await f.activate(i,s,i.name,f.clear_list(s));x.push("thumb_palm");continue}i=M.search("thumb",{hand:n});if(i){x.push("CANCEL");await f.releaseKey(...f.clear_list(s));continue}i=M.search("index_pinky",{hand:n});if(i){x.push("index_pinky");continue}}else{i=M.search("thumb_palm|thumb_index|thumb",{hand:n,condition:function(e){if(e.name!="thumb_palm")return true;const t=this.hand;const i=g.fromArray(t.annotations.index[0]).sub(y.fromArray(t.annotations.index[3]));const o=b.fromArray(t.annotations.pinky[0]).sub(v.fromArray(t.annotations.pinky[3]));return i.angleTo(o)*180/Math.PI<20}});if(i){const r=D(i,n);const _=r[0];let e=[];let t=[];switch(_){case"Vertical Up":e.push("W");t.push("A","S","D");break;case"Diagonal Up Right":e.push("W","A");t.push("S","D");break;case"Horizontal Right":e.push("A");t.push("W","S","D");break;case"Diagonal Up Left":e.push("W","D");t.push("A","S");break;case"Horizontal Left":e.push("D");t.push("W","A","S");break;case"Diagonal Down Right":e.push("S","A");t.push("W","D");break;case"Diagonal Down Left":e.push("S","D");t.push("W","A");break;case"Vertical Down":e.push("S");t.push("W","A","D");break;default:t.push("W","A","S","D")}var o=f.action(i,s,i.name);if(o.press.length)e.push(...o.press);if(o.release.length)t.push(...o.release);if(e.length)await f.pressKey(...e.map(e=>[p[e]]));if(t.length)await f.releaseKey(...t.map(e=>[p[e]]));x.push([i.name,_].join("/")+"/"+RAF_timestamp);continue}}if(!i)await f.releaseIdleKey(...f.clear_list(s))}for(const l of[[0,t.findIndex(e=>e._used&&e._d==h)],[1,t.findIndex(e=>e._used&&e._d!=h)]]){if(l[1]!=-1)continue;const s=l[0]==0?"R":"L";if(M.search("palm_open",{time_limit:500,hand:{_d:l[0]==0?h:I.off_hand},hand_facing:"front",condition:()=>{}})){await f.releaseKey(...f.clear_list(s))}else{await f.releaseIdleKey(...f.clear_list(s))}}}}}(),virtual_mouse:function(){var e;var t;function m(){if(e)return;t=new fp.GestureEstimator([fp.Gestures.VictoryGesture,fp.Gestures.ThumbsUpGesture,M.custom.index_up]);e=true}return{enabled:false,process:async function(e){if(!this.enabled)return;if(!e.posenet_data)return;m();const t=e.posenet_data.handpose;if(!t||!t.length)return;const i=t[0]._d==h?0:1;const o=h=="右"?0:1;if(!t[i]||!t[i]._used)return;const n=screen.width/2;const a=screen.height/2;const s=System._browser.camera.video_canvas;const r=s.width/s.height/(n/a);const _=.5;const l=t[i].annotations.index[0];const d={x:-(-s.width/2+l[0])/(s.width/2*_),y:(-s.height/2+l[1])/(s.height/2*_)};d.x=Math.round(n+THREE.Math.clamp(d.x*r,-1,1)*n);d.y=Math.round(a+THREE.Math.clamp(d.y/r,-1,1)*a);const c=new u(d.x,d.y);await I.setMousePosition(c)}}}()};return I}(),snapshot:function(){var i=false;var o=false;var n;var a;function s(){const e=MMD_SA.THREEX.SL;const t=System._browser.camera;var i=Math.ceil(3-(Date.now()-n)/1e3);if(i<=0){if(!t.visible){l(e);return}DEBUG_show("Capturing...");if(!t.stream){if(!t.bodyPix.enabled){r();return}o=true}else{t.target_devicePixelRatio=1;t.video_track.applyConstraints(t.set_constraints()).then(function(){System._browser.console.log("(Ready to capture)");System._browser.on_animation_update.add(function(){MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);if(!t.bodyPix.enabled){System._browser.on_animation_update.add(function(){r()},0,1);return}o=true},0,0)})["catch"](function(e){DEBUG_show("ERROR:camera size failed to update");_()})}System._browser.on_animation_update.remove(s,0)}else if(a!=i){a=i;DEBUG_show(a)}}function r(){const e=MMD_SA.THREEX.SL;const t=System._browser.camera;let i=t.video_canvas_bodyPix;i.width=e.width;i.height=e.height;let o=i.getContext("2d");o.globalCompositeOperation="source-over";const n=t.video_canvas.width;const a=t.video_canvas.height;const s=Math.min(e.width/n,e.height/a);const r=Math.round(n*s);const _=Math.round(a*s);o.drawImage(t.video_canvas,0,0,n,a,(e.width-r)/2,(e.height-_)/2,r,_);if(t.face_detection.enabled)o.drawImage(t.video_canvas_face_detection,0,0);o.save();o.translate(i.width,0);o.scale(-1,1);o.drawImage(e,0,0);o.restore();l(i)}function l(e){i=true;o=false;System._browser.on_animation_update.remove(s,0);e.toBlob(function(e){if(webkit_electron_mode){System._browser.save_file("snapshot_"+Date.now()+".png",e)}else{const t=URL.createObjectURL(e);window.open(t)}_()})}function _(){const e=System._browser.camera;Ldebug.style.posLeft=Ldebug.style.posTop=0;Ldebug.style.transform=Ldebug.style.transformOrigin="";DEBUG_show();o=false;e.target_devicePixelRatio=0;i=false}const e={init:function(){if(i){return true}const e=MMD_SA.THREEX.SL;const t=System._browser.camera;if(MMD_SA.WebXR.session){let e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(!e.dom_overlay||!e.dom_overlay.use_dummy_webgl){DEBUG_show("(No snapshot in AR WebGL)",3);return true}}if(!t.visible){l(e)}else{i=true;n=Date.now();Ldebug.style.posLeft=Ldebug.style.posTop=50;Ldebug.style.transformOrigin="0 0";Ldebug.style.transform="scale(5,5)";a=3;DEBUG_show();DEBUG_show(a);System._browser.on_animation_update.add(s,0,0,-1)}},check_bodyPix:function(){if(!i)return false;const e=System._browser.camera;if(o){l(e.video_canvas_bodyPix)}return true}};return e}(),video_capture:(()=>{const l=document.createElement("canvas");function r(){const e=u.get_specs();l.width=e.width;l.height=e.height;u._fps=e.fps;u.mime_type=e.mime_type;System._browser.on_animation_update.add(t,0,1,-1)}function t(){const e=MMD_SA.THREEX.SL;const t=l.getContext("2d");if(MMD_SA.music_mode){const i=SL_MC_video_obj.vo.media_linked&&SL_MC_video_obj.vo.media_linked.find(e=>e.id=="motion_bg_video");if(i&&i.style.visibility!="hidden"){const o=Math.min(i.videoWidth/i.videoHeight,l.width/l.height);const n=Math.round(Math.min(i.videoWidth,i.videoHeight)*o);const a=Math.min(n,i.videoWidth);const s=Math.min(n,i.videoHeight);const r=(i.videoWidth-a)/2;const _=(i.videoHeight-s)/2;t.drawImage(i,r,_,a,s,0,0,l.width,l.height)}}else{t.fillStyle=document.body.style.backgroundColor||"white";t.fillRect(0,0,l.width,l.height)}if(l.width==e.width&&l.height==e.height){t.drawImage(e,0,0)}else{t.drawImage(e,0,0,l.width,l.height)}}let _;function d(){if(!u.media_recorder||u.started)return;u.started=true;u.media_recorder.start();if(_&&u.stream.getAudioTracks().length&&(MMD_SA.music_mode?SL_MC_video_obj.vo.audio_obj.paused:MMD_SA.motion_player_control.enabled&&MMD_SA.motion_player_control.paused)){SL_MC_Play()}}function c(){System._browser.video_capture.stop()}var m=[];const u={enabled:false,started:false,fps:undefined,target_width:undefined,target_height:undefined,FFmpeg:(()=>{var e;var t;var n;var a;const i={enabled:webkit_electron_mode,load:async function(){if(e)return;e=true;return new Promise(o=>{n=new Worker("js/ffmpeg_worker.js");n.onmessage=e=>{const t=e.data;if(typeof t==="string"){if(t=="OK"){o()}}else{const i=new Blob([t.buffer],{type:t.output_type});return a(i)}}})},encode:async function(...e){await this.load();const t={inputs:[]};for(const i of e){if(i.blob)i.blob=await i.blob.arrayBuffer();t.inputs.push(i)}n.postMessage(t,t.inputs.filter(e=>e.blob).map(e=>e.blob));return new Promise(e=>{a=e})}};return i})(),get_specs:function(){const e=MMD_SA.THREEX.SL;const t=e.width*e.height;let i=this.target_width,o=this.target_height,n=this.fps;if(!i){if(is_mobile){i=1280;o=720;if(e.width<e.height){const r=i;i=o;o=r}}else{if(System._browser.camera.ML_enabled||System._browser.camera.bodyPix.enabled){i=1280;o=720}else{i=1920;o=1080}}}if(!n){if(is_mobile){n=30}else{if(System._browser.camera.ML_enabled||System._browser.camera.bodyPix.enabled){n=30}else if(Math.min(i*o,t)<=1280*720){n=-1}else{n=30}}}if(t>i*o){const _=Math.min(i/e.width,o/e.height);i=Math.min(Math.round(e.width*_/4)*4,i);o=Math.min(Math.round(e.height*_/4)*4,o)}else{i=e.width;o=e.height}const a=["video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"];let s;for(const l of a){if(MediaRecorder.isTypeSupported(l)){s=l;break}}return{width:i,height:o,fps:n,mime_type:s}},start:function(){if(this.busy){DEBUG_show("(Media recorder still in use)",3);return}if(this.enabled)return;this.enabled=true;r();const e=this._fps==-1?undefined:this._fps;const t=l.captureStream(e);this.stream=new MediaStream;this.stream.addTrack(t.getTracks()[0]);this.audio_src=MMD_SA.music_mode&&SL_MC_video_obj.vo.audio_obj.src;if(this.audio_src&&(!this.FFmpeg.enabled||this.target_mime_type||!SL_MC_video_obj.vo.motion_by_song_name_mode||SL_MC_video_obj.vo.audio_obj.currentTime)){const n=SL_MC_video_obj.vo.audio_obj.captureStream();this.stream.addTrack(n.getTracks()[0])}this.file_ext="."+(this.mime_type.indexOf("x-matroska")!=-1?"mkv":this.mime_type.replace(/^.+[\/]/,"").replace(/\;.+$/,""));this.media_recorder=new MediaRecorder(this.stream,{videoBitsPerSecond:l.width*l.height*4,mimeType:this.mime_type});m.length=0;this.media_recorder.addEventListener("dataavailable",async e=>{m.push(e.data);if(!this.enabled){let e=new Blob(m,{type:this.mime_type});this.stream.getTracks().forEach(e=>{e.stop()});let t=this.file_ext;this.busy=true;if(this.FFmpeg.enabled&&/h264/.test(this.mime_type)&&!this.target_mime_type){try{DEBUG_show("Encoding MP4...");const o=[{name:"video",blob:e}];if(this.audio_src){const n={name:"audio"};if(!this.stream.getAudioTracks().length)n.blob=await fetch(this.audio_src).then(e=>e.blob());o.push(n)}e=await this.FFmpeg.encode(...o);t=".mp4"}catch(i){console.error(i);this.FFmpeg.enabled=false}}this.busy=false;m.length=0;DEBUG_show("🔴Video Capture:OFF",5);System._browser.save_file("video_"+Date.now()+t,e)}});const i=new Promise(e=>{_=e;this.media_recorder.addEventListener("start",()=>{DEBUG_show();DEBUG_show("🔴Video Capture:ON ("+(l.width+"x"+l.height+(u._fps>-1?"/"+u._fps+"fps":""))+"/"+u.mime_type+")",10);if(MMD_SA.music_mode?SL_MC_video_obj.vo.audio_obj.paused:MMD_SA.motion_player_control.enabled&&MMD_SA.motion_player_control.paused){SL_MC_Play()}_();_=null},{once:true})});DEBUG_show();const o=MMD_SA.THREEX.get_model(0).animation.time;if(o||(MMD_SA.music_mode?!SL_MC_video_obj.vo.motion_by_song_name_mode||!SL_MC_video_obj.vo.audio_obj.paused:!MMD_SA.motion_player_control.enabled||!MMD_SA.motion_player_control.paused)){d()}else{if(u.audio_src){window.addEventListener("SA_audio_onended",e=>{System._browser.video_capture.stop()},{once:true})}else if(MMD_SA.motion_player_control.enabled){const s=MMD_SA.THREEX.get_model(0).animation;if(s.enabled){s.mixer.addEventListener("loop",c,{once:true});s.mixer.addEventListener("finished",c,{once:true})}else{window.addEventListener("SA_MMD_model0_onmotionended",c,{once:true})}}const a=MMD_SA_options.reset_rigid_body_physics_step;MMD_SA_options.reset_rigid_body_physics_step=0;new Promise(e=>{DEBUG_show("(Resetting physics)",3);let t=60*3;System._browser.on_animation_update.add(()=>{MMD_SA.seek_motion(o,true);if(MMD_SA.THREEX.get_model(0).animation.enabled)THREE.MMD.getModels()[0].seekMotion(0);if(--t==0)e()},0,0,t)}).then(()=>{MMD_SA.seek_motion(o);if(MMD_SA.motion_player_control.enabled){MMD_SA.motion_player_control.pause()}else{jThree.MMD.pause()}MMD_SA_options.reset_rigid_body_physics_step=a;d()})}DEBUG_show("🔴Video Capture",3);return i},stop:function(){if(!this.media_recorder)return;if(!this.enabled)return;this.enabled=false;System._browser.on_animation_update.remove(t,1);const e=MMD_SA.THREEX.get_model(0).animation;if(e.enabled){e.mixer.removeEventListener("loop",c);e.mixer.removeEventListener("finished",c)}else{window.removeEventListener("SA_MMD_model0_onmotionended",c)}this.media_recorder.stop();this.media_recorder=undefined;this.started=false},pause:function(){if(this.started&&this.media_recorder.state!="paused")this.media_recorder.pause()},resume:function(){if(this.started&&this.media_recorder.state=="paused")this.media_recorder.resume()}};return u})(),hotkeys:(()=>{class s{constructor(e,t){this.id=e.id;this.index=t;this.config=s.config_by_id[this.id]=e;this.event={};this.accelerator=e.accelerator[t];const i=this.accelerator.split("+");i.forEach(e=>{if(/^(Cmd|Command|Ctrl|Control)$/.test(e)){this.event.ctrlKey=true}else if(e=="Shift"){this.event.shiftKey=true}else if(e=="Alt"){this.event.altKey=true}else if(/^[0-9]$/.test(e)){this.event.code="Digit"+e}else if(/^num([0-9])$/.test(e)){this.event.code="Numpad"+RegExp.$1}else if(/^[A-Z]$/.test(e)){this.event.code="Key"+e}})}static config_by_id={};static get_config(e){return s.config_by_id[e]}static accelerators={};static register(e,t,i){if(!s.unregister(e))return false;const o=s.get_config(e);if(i)Object.assign(o,i);o.accelerator=t;t.forEach((e,t)=>{s.accelerators[e]=new s(o,t)});return s.enable_global(e)}static unregister(e){const t=s.get_config(e);if(!t)return false;t.accelerator.forEach(e=>{if(s.accelerators[e].is_global){try{webkit_electron_remote.globalShortcut.unregister(e)}catch(t){}}delete s.accelerators[e]});return true}static enable_global(e,o){if(!webkit_electron_mode)return true;const t=s.get_config(e);if(!t)return;let n=o==null?!!s.accelerators[t.accelerator[0]].config.global_disabled:!o;o=n?false:s.is_global;let a=true;t.accelerator.forEach(e=>{const t=s.accelerators[e];t.config.global_disabled=n;try{if(o){if(!t.is_global&&!t.config.global_disabled)webkit_electron_remote.globalShortcut.register(e,()=>{SA_topmost_window.SA_OnKeyDown(t.event)})}else{if(t.is_global)webkit_electron_remote.globalShortcut.unregister(e)}t.is_global=webkit_electron_remote.globalShortcut.isRegistered(t.accelerator);if(a&&o&&!t.config.global_disabled)a=t.is_global}catch(i){}});return a}static remove(e){if(s.unregister(e))delete s.config_by_id[e]}static add(i){s.remove(i.id);i.accelerator.forEach((e,t)=>{s.accelerators[e]=new s(i,t)});s.enable_global(i.id)}static _is_global=null;static get is_global(){return this._is_global==null?true:this._is_global}static set is_global(e){this._is_global=e}static register_global(i){if(browser_native_mode){DEBUG_show("(Global hotkey is for app mode only.)",5);return}s.is_global=i==null?s.is_global:i;DEBUG_show("Global hotkey:"+(i?"ON":"OFF"),3);Object.values(s.accelerators).forEach(e=>{try{if(i){if(!e.is_global&&!e.config.global_disabled)webkit_electron_remote.globalShortcut.register(e.accelerator,()=>{SA_topmost_window.SA_OnKeyDown(e.event)})}else{if(e.is_global)webkit_electron_remote.globalShortcut.unregister(e.accelerator)}e.is_global=webkit_electron_remote.globalShortcut.isRegistered(e.accelerator)}catch(t){}})}}window.addEventListener("SA_keydown",o=>{const n=o.detail.e;Object.values(s.config_by_id).some(e=>{const t=e.accelerator.some(e=>{const t=s.accelerators[e].event;if(t.code&&t.code!=n.code)return false;if(t.ctrlKey&&!n.ctrlKey)return false;if(t.shiftKey&&!n.shiftKey)return false;if(t.altKey&&!n.altKey)return false;return true});if(t){const i=e.process(o);if(i!==false)o.detail.result.return_value=true;return true}})});return s})(),load_script:function(){var n={};var a=function(e,t){this.url=e;this.name=e.replace(/^.+[\/\\]/,"");this.loaded=false;this.resolve_list=[];this.reject_list=[];if(t){const i=this;import(e).then(e=>{i.module=e;i.check_loaded()})}else{const o=document.createElement("script");o.onload=this.check_loaded.bind(this);o.src=e;document.head.appendChild(o)}};a.prototype.check_loaded=function(){this.loaded=true;console.log(this.name+" loaded");this.resolve_list.forEach(e=>{e(this.module)})};a.prototype.make_promise=function(e,t){this.resolve_list.push(e);if(t)this.reject_list.push(t)};return function(e,t){var i=e.replace(/^.+[\/\\]/,"");var o=n[i]=n[i];if(o){if(o.loaded)return Promise.resolve(o.module)}else{o=n[i]=new a(e,t)}return new Promise((e,t)=>{o.make_promise(e,t)})}}(),save_file:function(){var a;return function(e,t,i){const o=!i?t:new Blob([t],{type:i});const n=URL.createObjectURL(o);if(!a){a=document.createElement("a");a.style.display="none";document.body.appendChild(a)}else{URL.revokeObjectURL(a.href)}a.href=n;a.download=e||"";a.click()}}(),update_obj_url:async function(t,i){if(/^(.+\.zip)\#[\/\\](.+)$/i.test(t)){const e=SA_topmost_window.DragDrop._obj_url[t];if(!e||t==e){const o=XMLHttpRequestZIP.zip_by_url(RegExp.$1);let e=await o.file(RegExp.$2.replace(/\\/g,"/"))["async"]("blob");if(i)e=new Blob([e],{type:i});console.log("Object URL (inside zip) updated",t);SA_topmost_window.DragDrop._obj_url[t]=SA_topmost_window.URL.createObjectURL(e)}}},skip_background_rendering:true,skip_rendering:false,rendering_check:function(){if(this.skip_rendering&&!this.hidden)return false;if(!returnBoolean("DisableBackgroundThrottling"))return true;const e=this.skip_background_rendering&&this.hidden;let t=document.getElementById("canvas_DisableBackgroundThrottling");if(e){if(!t){t=document.createElement("canvas");t.id="canvas_DisableBackgroundThrottling";t.width=t.height=1;t.style.position="absolute";t.style.posLeft=t.style.posTop="0px";t.style.zIndex=9999;document.getElementById("Lbody_host").appendChild(t)}t.getContext("2d").clearRect(0,0,t.width,t.height)}if(t)t.style.visibility=e?"inherit":"hidden";return!e},console:{content_list:[],log:function(){for(var e=0;e<arguments.length;e++){this.content_list.push(arguments[e])}},reset:function(){this.content_list=[]},get output_text(){return this.content_list.join("\n")||"(EMPTY)"}},get use_screen_data(){if(this._use_screen_data)return true;if(!webkit_electron_mode)return false;let e,t;if(!SA_topmost_window.returnBoolean("AutoItStayOnDesktop")){e=System.Gadget.Settings.readString("OpacityOnHover");t=SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial")}let i=e||t;let o=i||self.MMD_SA&&MMD_SA.MMD_started&&MMD_SA_options.look_at_mouse;return o},set use_screen_data(e){this._use_screen_data=e},translation:(()=>{var t,n,i;const o=navigator.language+"-default";var a;var e={ja:'"Meiryo UI"'};const s={get language(){return n},set language(e){t=e||o;n=t.split("-")[0].toLowerCase();if(t==o){i="System default"}else{switch(n){case"en":i="English";break;case"ja":i="Japanese";break;default:i="System default"}}},get language_full(){return t},get language_info(){return i},get language_default(){return o},get dictionary(){return a},set dictionary(e){a=Object.assign(a||{},e)},get font(){return e[n]},get:function(e,t=n){if(!a)return"(Now loading...)";let i=a;e.split(".").every(e=>{i=i[e];return i});const o=i&&(i._translation_?.[t]||i._translation_?._default_);return o!=null?o:"("+e+")"}};s.language=null;return s})(),DEBUG_show:function(){const t=self.DEBUG_show;self.DEBUG_show=function(...e){if(System._browser.overlay_mode>0){if(!e.length)t()}else{t(...e)}};return t}()},_hash_sha256:{_hash_cache:{},hash:function(e){if(webkit_electron_mode){var t=webkit_electron_remote.getGlobal("HASH_SHA256");if(t)return t.hash(e)}var i=this._hash_cache[e];if(i)return i;var o=require("crypto").createHash("sha256");o.update(e);i=this._hash_cache[e]=o.digest("hex");return i}},_media_objs_paused_:[],_gadget_resume:function(e){if(e&&!SA_topmost_window.EV_sync_update.RAF_auto_paused)return false;if(!SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=false;SA_topmost_window.EV_sync_update.RAF_auto_paused=false;SA_topmost_window.System._media_objs_paused_.forEach(function(e){if(e.SL_MC_Play)e.SL_MC_Play();else if(e.paused)e.play()});SA_topmost_window.System._media_objs_paused_=[];System._browser.update_tray();return true},_gadget_pause:function(e){if(SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=true;SA_topmost_window.EV_sync_update.RAF_auto_paused=e;var s=SA_topmost_window.System._media_objs_paused_;var t=[top];for(var i=0;i<SA_child_animation_max;i++){if(SA_topmost_window.SA_child_animation[i])t.push(SA_topmost_window.document.getElementById("Ichild_animation"+i).contentWindow)}var r=0;var _=0;var l=0;t.forEach(function(e){for(var t in e.seq_items){var i=e.seq_items[t];if(!i._gadget_pause_disabled&&!i.paused&&i.count){r++;i.pause();s.push(i)}}var o=[];var n;n=document.getElementById("VdesktopBG");if(n)o.push(n);n=e.CANVAS_Video_Overlay&&e.CANVAS_Video_Overlay._video;if(n)o.push(n);o.forEach(function(e){if(e&&!e.paused&&!e.ended){_++;e.pause();s.push(e)}});if(e.SL&&e.SL._mouse_event_main&&e.SL._mouse_event_main()){var a;if(e.SL_MC_simple_mode)a=e.SL_MC_video_obj.paused;else if(e.MMD_SA)a=e.SL_MC_video_obj.vo.audio_obj.paused;else if(e.use_WMP&&e.WMP.in_use)a=e.WMP.player.playState!=3;else a=e.SL_MC_video_obj&&e.SL_MC_video_obj.paused;if(!a){l++;e.SL_MC_Play();s.push(e)}}});console.log("Gadget PAUSED (Seq/Video/MC):"+[r,_,l].join("/"));System._browser.update_tray();return true},_returnRelativePath:function(e){if(!WallpaperEngine_CEF_mode)return e;if(System.Gadget.path&&e.indexOf(System.Gadget.path)==0)e=e.substr(System.Gadget.path.length);e=/\:/.test(e)?toFileProtocol(e):e.replace(/\\/g,"/").replace(/^\//,"");return e}};System._init();return System}();
