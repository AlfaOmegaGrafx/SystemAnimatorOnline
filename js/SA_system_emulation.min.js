// (2022-04-26)
var System=function(){var System={t:function(){try{if(!Shell_OBJ)Shell_OBJ=new ActiveXObject("Shell.Application");if(!FSO_OBJ)FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject");if(!oShell)oShell=new ActiveXObject("WScript.Shell")}catch(e){alert(e.message)}this.i=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html";this.o.t();this._.t();if(!is_SA_child_animation){SA_top_window.l=function(){var n=-1;var a;return function(e,t,i){if(i||n!=RAF_timestamp){n=RAF_timestamp;a=webkit_electron_mode?webkit_electron_screen.u({x:~~e,y:~~t}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}}return a}}()}else{SA_top_window.l=function(e,t,i){return SA_topmost_window.l(e,t,i)}}if(webkit_electron_mode){if(!is_SA_child_animation){SA_top_window.h=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_window.M()}return i}}();SA_top_window.m=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_electron_screen.p()}return i}}()}else{SA_top_window.h=function(e){return SA_topmost_window.h(e)};SA_top_window.m=function(e){return SA_topmost_window.m(e)}}}SA_top_window.S=function(){var i;return function(e,t){webkit_window.v(e,t);i=true;if(absolute_screen_mode&&!System.D.A){System.D.A=setInterval(function(){var t=SA_top_window.g;var i=SA_top_window.k;var n=0;return function(){var e=SA_top_window.h(true);if(t!=e[0]||i!=e[1]){DEBUG_show("(window position adjusted)",3);webkit_window.setPosition(t,i);System.D.R(t,i);n=999}if(++n>10){clearInterval(System.D.A);System.D.A=null}}}(),100)}}}();SA_top_window.P=function(e,t,i){if(absolute_screen_mode&&!i){webkit_window.setPosition(~~e,~~t)}else{this.moveTo(e,t)}};SA_top_window.T=function(t,i){if(absolute_screen_mode){let e=SA_top_window.h(true);t+=~~e[0];i+=~~e[1];webkit_window.setPosition(t,i)}else{this.moveBy(t,i)}};Object.defineProperty(SA_top_window,"g",{get:function(){return absolute_screen_mode?SA_top_window.h()[0]:this.screenLeft}});Object.defineProperty(SA_top_window,"k",{get:function(){return absolute_screen_mode?SA_top_window.h()[1]:this.screenTop}})},o:{t:function(){this.B.read=this.B.L;this.B.write=this.B.O;Object.defineProperty(this,"I",{get:function(){return this.F},set:function(e){this.F=e;this.C.onbeforeunload=function(){e({j:!!this.returnValue,U:{commit:true}});System.o.C.G=null;System.o.C.onbeforeunload=null;System.o.C=null}}});var e=new ActiveXObject("Microsoft.XMLDOM");e.async=false;e.H=false;e.W=false;e.load("gadget.xml");this.version=e.selectSingleNode("//version").text},path:xul_mode?XPCOM_object.X:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",Y:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",K:is_SA_child_animation,visible:true,B:{Z:false,V:{},N:{},J:function($0,$1,$2){return eval($1)},L:function(e,t){var i=this.V[e];i=i?t?decodeURIComponent(i):decodeURIComponent(i).replace(/\$([^\$]+)\$/g,this.J):Settings_default.$[e]||"";return i},O:function(e,t){var i=this.V[e]||"";var n=encodeURIComponent(t);this.V[e]=n;if(WallpaperEngine_CEF_mode){var a=JSON.parse(localStorage.q);if(!SA_HTA_folder||!a[SA_HTA_folder]){console.error(SA_HTA_folder)}else{if(a[SA_HTA_folder][e]!=n){a[SA_HTA_folder][e]=n;localStorage.q=JSON.stringify(a)}}}if(i!=n)this.N[e]=this.Z=true},ee:function(e,t){if(!e&&!this.Z)return;this.Z=false;SystemEXT.te=t;try{this.ie()}catch(e){}SystemEXT.te=false},ie:function(){var e=[];var t=this.V;t.ne=t.ae="";for(var i in t){var n=System.o.B.L(i);if(!n)continue;if(i=="_screenLeft"){n=SA_top_window.g}else if(i=="_screenTop"){n=SA_top_window.k}e.push('"'+i+'":"'+encodeURIComponent(n)+'"')}SystemEXT.oe(e)}}},re:{se:null,_e:function(e){return oShell.le("%"+e+"%")}},_:{t:function(){this.fe=function(){if(webkit_mode)return;if(this.ue)return;try{this.ue=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV");this.ue.init()}catch(e){}};Object.defineProperty(this,"he",{get:function(){if(webkit_mode)return SA_require("os").ce()/(1024*1024);this.fe();var e=this.ue.update();return e.length?parseInt(e[e.length-1].Me):0}});Object.defineProperty(this,"de",{get:function(){if(webkit_mode)return SA_require("os").me()/(1024*1024);if(!this.pe){try{var e=new WMI_Refresher("Win32_OperatingSystem");e.init();this.pe=parseInt(e.update()[0].Se)/1024}catch(e){}}return this.pe}});this.de=0;var e={ve:null,Ae:null,we:null,t:function(){if(webkit_mode){if(this.we)return;this.Ae=[{count:-1,De:SA_require("os").De()}];this.we=function(){var e=this.Ae;if(e[0].count!=PC_count_absolute){if(e.unshift({count:PC_count_absolute,De:SA_require("os").De()})==3)e.pop()}return e};return}if(this.ve)return;try{this.ve=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV");this.ve.init()}catch(e){}},item:function(e){if(webkit_mode){var t=this.we();var i=[];for(var n=0;n<2;n++){var a=t[n].De[e].ge;var o=0;for(var r in a)o+=a[r];i[n]={total:o,be:a.be}}var s=i[0].be-i[1].be;var o=i[0].total-i[1].total;return{ye:o?(1-s/o)*100:0}}return{ye:parseFloat(this.ve.update()[e].ke)}}};Object.defineProperty(e,"count",{get:function(){if(webkit_mode){return this.we()[0].De.length}return this.ve.update().length-1}});this.Ee=e;Object.defineProperty(this,"Re",{get:function(){this.Ee.t();return this.Ee}});var t={ve:null,t:function(){if(this.Pe)return;this.Pe={level:1,charging:false};if("getBattery"in navigator){var t=this;navigator.getBattery().then(function(e){DEBUG_show("Use Battery Status API",2);t.Pe=e})}}};Object.defineProperty(t,"Te",{get:function(){return this.Pe.level*100}});Object.defineProperty(t,"Be",{get:function(){return this.Pe.level==1||this.Pe.charging}});Object.defineProperty(t,"Le",{get:function(){return this.Pe.charging}});this.Oe=t;Object.defineProperty(this,"Ie",{get:function(){this.Oe.t();return this.Oe}})}},Fe:{Ce:function(e,t){return{path:""}},xe:function(e){e=toLocalPath(e);var t=e.replace(/[\/\\][^\/\\]+$/,"");var i=e.replace(/^.+[\/\\]/,"");var n=Shell_OBJ.je(t);if(n)n=n.Ue(i);return n?new this.Ge(n):null},He:function(e,t){Shell_OBJ.We(e,t)},ze:function(e,t){var i=Shell_OBJ.Xe(0,e,t);return i?new this.Ge(i.Ye):null},Ge:function(e){if(!this.Ke){this.constructor.prototype.Ke=true;this.constructor.prototype.metadata=function(e){var t=this.Ve.Ze("Dimensions");if(!t){var i=this.Ve.Ne.replace(/[\/\\][^\/\\]+$/,"");var n=Shell_OBJ.je(i);t=n.Je(this.Ve,26)}return t};Object.defineProperty(this.constructor.prototype,"$e",{get:function(){return this.Ve.qe}});Object.defineProperty(this.constructor.prototype,"Qe",{get:function(){return(ie9_native?!this.Ve.qe:true)&&this.Ve.et}});Object.defineProperty(this.constructor.prototype,"tt",{get:function(){return this.Ve.it}});Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Fe.Ge(this.Ve.nt)}});Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.Ve.Ne}});Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.Ve.at}});Object.defineProperty(this.constructor.prototype,"ot",{get:function(){return new System.Fe.rt(this.Ve.st)}})}this.Ve=e},rt:function(e){if(!this.Ke){this.constructor.prototype.Ke=true;Object.defineProperty(this.constructor.prototype,"_t",{get:function(){return new System.Fe.lt(this.Ve._t())}})}this.Ve=e},lt:function(e){if(!this.Ke){this.constructor.prototype.Ke=true;this.constructor.prototype.item=function(e){return new System.Fe.Ge(this.Ve.ft(e))};Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.Ve.ut}})}this.Ve=e}},Debug:{ht:function(e){}},D:{init:function(){document.ondragstart=document.onselectstart=function(e){return false};document.onmousedown=function(e){System.D.onmousedown(e)};document.onmouseup=function(e){System.D.onmouseup(e)};document.onmousemove=function(e){System.D.onmousemove(e)};document.onkeydown=function(e){System.D.onkeydown(e)};if(!WallpaperEngine_CEF_mode||!is_SA_child_animation||browser_native_mode){document.addEventListener("mouseover",function(e){System.D.onmouseover(e)},false);document.addEventListener("mouseout",function(e){System.D.ct(e)},false)}Object.defineProperty(document,"onmouseover",{set:function(e){System.D.Mt=e}});Object.defineProperty(document,"onmouseout",{set:function(e){System.D.dt=e}});var l=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.St=Object.getOwnPropertyDescriptor(l,"pixelWidth");this.vt=Object.getOwnPropertyDescriptor(l,"pixelHeight");var f=function(){if(System.D.At)clearTimeout(System.D.At);if(System.D.A){let i=SA_top_window.h();System.D.At=setInterval(function(){var t=0;return function(){let e=SA_top_window.h(true);if(++t>10||i[0]!=e[0]||i[1]!=e[1]){clearInterval(System.D.At);System.D.At=setTimeout("System._browser.resize()",0)}}}(),10)}else System.D.At=setTimeout("System._browser.resize()",0)};Object.defineProperty(l,"wt",{get:function(){return f}});if(ie9_native){Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System.D.St.get.call(this)},set:function(e){this.wt();System.D.St.set.call(this,e)}});Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System.D.vt.get.call(this)},set:function(e){this.wt();System.D.vt.set.call(this,e)}})}Object.defineProperty(this,"Dt",function(){var t=0;var e="";var i="";if(0){setTimeout(()=>{System.D.Dt=2},500)}return{get:function(){return t},set:function(e){if(e==t)return;switch(e){case 2:bg_state_default=LdesktopBG_host.style.display;LdesktopBG_host.style.display="none";i=document.body.style.backgroundColor;document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden";if(this.bt.gt){this.bt.gt.style.visibility="hidden";this.bt.gt.style.display="none"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="hidden";document.getElementById("Ldungeon_inventory").style.visibility="hidden";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}break;default:if(t==2){LdesktopBG.style.backgroundColor=bg_state_default;document.body.style.backgroundColor=i}Lmenu_host.style.visibility="inherit";if(this.bt.gt){this.bt.gt.style.visibility="inherit";this.bt.gt.style.display="block"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="inherit";document.getElementById("Ldungeon_inventory").style.visibility="inherit";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}}if(document.getElementById("Ldungeon_UI"))Ldungeon_inventory.style.posLeft=Ldungeon_inventory_backpack.style.posLeft=(B_content_width-MMD_SA_options.Et.kt.yt*64)*(e?1:.5);t=e}}}());var u=is_SA_child_animation&&parent.Rt&&parent.Rt.Pt;if(u){this.onkeydown({keyCode:97+SA_child_animation_id})}var e=System.o.B.L("SA_docked");if(e)System.o.K=!!parseInt(e);else{if(u)System.o.K=false}var e=document.createElement("div");e.id="Ldrag_dummy";var i=e.style;i.position="absolute";i.posLeft=i.posTop=0;i.zIndex=999;i.border="1px solid rgba(128,128,128,0.5)";i.visibility="hidden";document.body.appendChild(e);this.body=document.getElementById("Lbody_host")||document.body;if(w3c_mode)this.body.style.transition="opacity 0.5s";this.Tt=1;var t=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(t){if(!self.Bt){var h=System.o.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.Lt(h)){try{var c=FSO_OBJ.Ot(h,1);self.Bt=c.It();c.Ft()}catch(e){}}}if(!self.Ct){var d=System.o.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.Lt(d)){try{var c=FSO_OBJ.Ot(d,1);self.Ct=c.It();c.Ft()}catch(e){}}}}if(t)t=System.o.B.L("WallpaperAsBG")||self.Bt;var m;if(self.xt&&CANVAS_Video_Overlay.jt||self.Ut){m=t=true}var M;var n,a;this.Tt=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.o.B.L("Opacity")||1);if(is_SA_child_animation&&!self.Bt&&!m){t=t&&parent.Gt&&parent.Ht&&!parent.G.o.B.L("CSSTransform3D")&&!System.o.B.L("DisableWallpaperMask");if(t&&self.Wt&&EQP_video_options.zt){t=false;this.Xt=document.createElement("canvas");this.Yt=document.createElement("canvas");this.Kt()}this.Zt=!t;if(t)M=parent.Gt}else{var p;if(!is_SA_child_animation){n=System.o.B.L("_screenLeft");a=System.o.B.L("_screenTop")}n=n?parseInt(n):null;a=a?parseInt(a):null;if(t){if(w3c_mode&&self.Bt&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)){var o=document.createElement("video");o.id="VdesktopBG";var r=o.style;r.position="absolute";r.posTop=r.posLeft=0;r.width=parent.screen.width+"px";r.height=parent.screen.height+"px";r.objectFit="cover";LdesktopBG.appendChild(o);o.autoplay=o.loop=true;o.src=toFileProtocol(SA_wallpaper_src)}this.Zt=WallpaperEngine_CEF_mode||!!System.o.B.L("DisableWallpaperMask");var S,s,v;var i=LdesktopBG.style;try{i.pixelWidth=parent.screen.width;i.pixelHeight=parent.screen.height;var A=oShell.Vt("HKCU\\Control Panel\\Colors\\Background");i.backgroundColor=/^\#/.test(A)?A:"rgb("+A.replace(/\W+/g,",")+")";S="HKCU\\Control Panel\\Desktop\\";if(WallpaperEngine_CEF_mode)s=oShell.Vt(S+"Wallpaper")||self.Bt&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;else s=self.Bt&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.Vt(S+"Wallpaper");if(s){if(!this.Zt){M=self.Ct||s.replace(/\.\w{3,4}$/,"_mask.png");if(!ValidatePath(M))M=null}v=oShell.Vt(S+"WallpaperStyle");this.Nt(s,v)}this.R(n||0,a||0);if(!is_SA_child_animation||self.Bt)LdesktopBG_host.style.display="block"}catch(e){console.error(e);LdesktopBG_host.style.display="none"}if(M){if(!this.Jt)this.Jt="(blank)"}else{p=true}}else{p=true}if(p&&this.Tt<1&&(w3c_mode||HTA_use_GPU_acceleration)){this.body.style.opacity=this.Tt;DEBUG_show("Opacity:"+this.Tt*100+"%",2)}}if(m&&!M)this.Jt="(blank)";if(t&&(M||this.Jt)){var _=document.createElement("canvas");_.id="C_wallpaper_mask";_.$t=m;_.onmousedown=function(){return false};if(!is_SA_child_animation||m){try{var w=_.width=parent.screen.width;var D=_.height=parent.screen.height;var g=_.getContext("2d");var b;if(!this.qt){this.qt=function(e,u){g.fillStyle=i.backgroundColor;g.fillRect(0,0,w,D);if(!e){if(self.xt&&CANVAS_Video_Overlay.Qt)CANVAS_Video_Overlay.Qt.ei=null;if(self.Ut){EQP_ps.forEach(function(e){if(e.ti)e.ni.ii.ei=null})}return}var t;if(u=="0"){t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var n=parent.screen.height;var a,o,r,s,_,l,f,u;if(i>e){a=0;_=(i-e)/2;r=f=e}else{a=(e-i)/2;_=0;r=f=i}if(n>t){o=0;l=(n-t)/2;s=u=t}else{o=(t-n)/2;l=0;s=u=n}var h=C_wallpaper_mask.getContext("2d");h.drawImage(this,a,o,r,s,_,l,f,u);System.D.ai(!M);if(!M)return;var c=new Image;c.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,a,o,r,s,_,l,f,u);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};c.src=toFileProtocol(M)}}else{t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var n=parent.screen.height;var a,o,r,s,_;var l=C_wallpaper_mask.getContext("2d");if(u=="6"){a=Math.max(e/i,t/n);s=Math.round((i-e/a)/2);_=Math.round((n-t/a)/2);o=Math.round(e/a);r=Math.round(t/a);l.drawImage(this,0,0,e,t,s,_,o,r)}else{a=Math.min(e/i,t/n);s=Math.round((e/a-i)/2*a);_=Math.round((t/a-n)/2*a);o=Math.round(i*a);r=Math.round(n*a);l.drawImage(this,s,_,o,r,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)}System.D.ai(!M);if(!M)return;var f=new Image;f.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,s,_,o,r);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};f.src=toFileProtocol(M)}}if(b)b.onload=null;b=new Image;b.onload=t;b.src=toFileProtocol(e)}}this.qt(s,v);if(!s){setTimeout("System._browser.BGMask_Create(true)",0)}}catch(e){}}var y=_.style;y.position="absolute";y.posLeft=-(n||0);y.posTop=-(a||0);y.zIndex=60;y.visibility="hidden";document.body.appendChild(_);this.oi.push(_);if(is_SA_child_animation){this.Xt=document.createElement("canvas");this.Yt=document.createElement("canvas");if(this.Jt)System.D.ai(!M);this.Kt()}}this.ri=n;this.si=a},Nt:function(e,t){var i=LdesktopBG.style;var n;if(e!=null){e=decodeURIComponent(e);if(this._i!=e){n=true;this._i=e;i.backgroundImage=e?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(e)?e:System.o.path+"/"+e)+")":"";if(this.li)i.opacity=this.li;if(this.fi)LdesktopBG_host.style.backgroundColor=this.fi}}else e=this._i;var a="HKCU\\Control Panel\\Desktop\\";if(t==null){t=oShell.Vt(a+"WallpaperStyle")}if(this.ui!=t){n=true;this.ui=t}if(t=="0"){i.backgroundSize="";i.backgroundPosition="center center";if(oShell.Vt(a+"TileWallpaper")=="0"){i.backgroundRepeat="no-repeat"}else{i.backgroundRepeat=""}}else if(t=="2"){i.backgroundSize="100% 100%";i.backgroundPosition="";i.backgroundRepeat=""}else if(t=="6"){i.backgroundSize="contain";i.backgroundPosition="center center";i.backgroundRepeat="no-repeat"}else{i.backgroundSize="cover";i.backgroundPosition="center center";i.backgroundRepeat="no-repeat";if(browser_native_mode){i.width="100%";i.height="100%"}else{i.pixelWidth=parent.screen.width;i.pixelHeight=parent.screen.height}if(windows_mode&&e){var o=loadImageDim(/^(\/|[\w\-]+\:)/.test(e)?e:System.o.path+toLocalPath("\\")+e);if(o.w){var r=parent.screen.width/parent.screen.height;var s=(parent.screen.width*2-parent.screen.availWidth)/(parent.screen.height*2-parent.screen.availHeight);var _=o.w/o.hi;if(_<r){i.pixelHeight=_<s?parent.screen.height*2-parent.screen.availHeight:Math.round(parent.screen.width/_)}else if(_>r){i.pixelWidth=_>s?parent.screen.width*2-parent.screen.availWidth:Math.round(parent.screen.height*_)}}}}if(this.qt&&n){this.qt(e,t);DEBUG_show("(Wallpaper canvas updated)",2)}},Kt:function(e){if(!this.Xt)return;if(!e)e=parent.ci;if(!e||!e.width)return;var f=document.body.style;var t=f.pixelWidth;var i=f.pixelHeight;if(!t)return;var u=0;var h=0;var c=e.width;var M=e.height;var d=this.Xt;if(d.width!=c){d.width=c;d.height=M;var m=parent.Mi;d.getContext("2d").drawImage(m,0,0,m.width,m.height,0,0,c,M)}var n=this.di;if(n&&n.width!=t){n.width=t;n.height=i;var p=this.mi;n.getContext("2d").drawImage(p,0,0,p.width,p.height,0,0,t,i)}var t,i;t=self.pi?B_content_width:document.body.style.pixelWidth;i=self.Si?B_content_height:document.body.style.pixelHeight;var S=parent.vi[SA_child_animation_id];var v=S.x;var A=S.y;if(is_SA_child_animation&&parent.Ai){v-=parent.Ai;A-=parent.Ai}var a=v-u;var o=a;if(a<0)a=0;if(o<0)o=-o;else o=0;var r=A-h;var s=r;if(r<0)r=0;if(s<0)s=-s;else s=0;var _=c+u-v;if(_>t)_=t;var w=M+h-A;if(w>i)w=i;var l=this.Yt;if(l.width!=t||l.wi!=a||l.Di!=r){l.width=t;l.height=i;var D=l.getContext("2d");D.drawImage(d,a,r,_,w,o,s,_,w);if(n)D.drawImage(n,0,0);l.wi=a;l.Di=r}var g=document.getElementById("C_wallpaper_mask");if(!g)return;g.width=t;g.height=i;var D=g.getContext("2d");D.globalCompositeOperation="copy";D.drawImage(e,a,r,_,w,o,s,_,w);D.globalCompositeOperation="destination-in";D.drawImage(l,0,0)},gi:function(f,u){if(!f)return null;if(!/^\((.+)\)$/.test(f)){return null}var e=RegExp.$1.split("|");var h=e[0];var t;if(h=="circle"){var i=parseInt(e[1]);var n=parseInt(e[2]);t=document.createElement("canvas");t.width=i;t.height=n;var c=i<n?i:n;var a=t.getContext("2d");a.beginPath();a.arc(i/2,n/2,c/2,0,Math.PI*2);a.fill()}else if(h=="feather"){var i=parseInt(e[1]);var n=parseInt(e[2]);var o=parseInt(e[3]);if(!o)o=parseInt(Math.sqrt(i*i+n*n)/25);t=document.createElement("canvas");t.width=i;t.height=n;var a=t.getContext("2d");var r;if(u)r=a.createImageData(i,n);else{a.fillRect(0,0,i,n);r=a.getImageData(0,0,i,n)}var M=r.data;for(var d=3,m=M.length;d<m;d+=4){var p=(d-3)/4;var S=p%i;var v=parseInt(p/i);var A=1.2;var s=1;if(S<o)s=(S+1)/(o+1);else if(S>=i-o)s=(i-S)/(o+1);s=1-(1-s)*A;if(s<0)s=0;var _=1;if(v<o)_=(v+1)/(o+1);else if(v>=n-o)_=(n-v)/(o+1);_=1-(1-_)*A;if(_<0)_=0;var l=s<_?s:_;if(l==1)continue;if(s<1&&_<1){var w=1-s;var D=1-_;var g=w>D?D/w:w/D;var b=Math.sqrt(1+g*g);l=1-(1-l)*b;if(l<0)l=0}M[d]=u?Math.round(255*(1-l)):Math.round(255*l)}a.putImageData(r,0,0)}return t},ai:function(e){var t=this.Jt;if(!t)return;if(e){this.bi=C_wallpaper_mask;C_wallpaper_mask.style.display="none"}else{var i=this.bi=document.createElement("canvas");if(!is_SA_child_animation){i.width=parent.screen.width;i.height=parent.screen.height;i.getContext("2d").drawImage(C_wallpaper_mask,0,0)}}if(self.xt&&CANVAS_Video_Overlay.Qt)CANVAS_Video_Overlay.Qt.ei=null;if(self.Ut){EQP_ps.forEach(function(e){if(e.ti&&e.ni)e.ni.ii.ei=null})}if(/^\((.+)\)$/.test(t)){this.mi=this.gi(t,is_SA_child_animation);this.yi();return}var n=this.mi=new Image;n.onload=this.yi;n.src=toFileProtocol(t)},yi:function(){var e=document.getElementById("C_BG_mask");if(!e){e=document.createElement("canvas");e.id="C_BG_mask";var t=e.style;t.position="absolute";t.posTop=t.posLeft=0;t.zIndex=60+1;document.body.appendChild(e)}if(System.D.oi.indexOf(e)==-1)System.D.oi.push(e);if(is_SA_child_animation){System.D.di=document.createElement("canvas")}else{System.D.ki()}},ki:function(e){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask.$t)){this.Kt();return}if(!document.getElementById("C_BG_mask"))return;var t,f,i,n;t=i=self.pi?B_content_width:document.body.style.pixelWidth;f=n=self.Si?B_content_height:document.body.style.pixelHeight;if(i>parent.screen.width)i=parent.screen.width;if(n>parent.screen.height)n=parent.screen.height;var a,o,r,s;var _=C_wallpaper_mask.style;if(_.posLeft>0){a=0;r=_.posLeft}else{a=-_.posLeft;r=0}if(_.posTop>0){o=0;s=_.posTop}else{o=-_.posTop;s=0}if(e){var u=a+","+o+","+i+","+n+","+r+","+s+","+i+","+n;if(e.ei==u)return;e.ei=u;e.width=t;e.height=f;var l=e.getContext("2d");l.globalCompositeOperation="copy";l.drawImage(this.bi,a,o,i,n,r,s,i,n);return}if(!this.mi&&this.Tt==1){document.getElementById("C_BG_mask").style.display="none";return}C_BG_mask.width=t;C_BG_mask.height=f;var l=C_BG_mask.getContext("2d");l.globalCompositeOperation="copy";l.globalAlpha=this.mi?1:1-this.Tt;l.drawImage(this.bi,a,o,i,n,r,s,i,n);if(this.mi){l.globalCompositeOperation="destination-out";l.globalAlpha=this.Tt;l.drawImage(this.mi,0,0,i,n)}else C_BG_mask.style.display="block"},At:null,Ei:0,resize:function(){var e=false;function i(){if(!e){e=true;setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0)}}return function(){this.At=null;if(use_SA_browser_mode){let t=document.body.style;if(is_SA_child_animation){let e=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;e.width=t.pixelWidth+"px";e.height=t.pixelHeight+"px";i()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.G.D.Ri){this.At=setTimeout("System._browser.resize()",50);return}if(webkit_electron_mode)System.D.Ei=performance.now();SA_top_window.S(t.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),t.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}i()}}}}(),Pi:-1,Ti:-1,Bi:null,Li:false,Oi:null,oi:[],Mt:null,onmouseover:function(e){if(webkit_electron_mode&&(SA_topmost_window.Ii("IgnoreMouseEvents")||SA_topmost_window.Ii("AutoItStayOnDesktop"))&&!SA_topmost_window.Fi)return;if(this.Mt&&this.Mt(e))return;if(this.Oi){clearTimeout(this.Oi);this.Oi=null}var t=this.oi;for(var i=0;i<t.length;i++)t[i].style.visibility="hidden"},dt:null,ct:function(e){if(this.dt&&this.dt(e))return;if(this.Oi){clearTimeout(this.Oi);this.Oi=null}var t=e.clientX;var i=e.clientY;var n=document.body.style;var a=t>0&&t<n.pixelWidth&&(i>0&&i<n.pixelHeight);if(w3c_mode)e.stopPropagation();this.Oi=setTimeout("System._browser.onmouseout("+a+")",200)},onmouseout:function(e){this.Oi=null;if(this.Bi){clearTimeout(this.Bi);this.Bi=null}if(this.Li){this.Li=false;e=false;this.Ci(false);System.o.B.ee(true,true)}else if(is_SA_child_animation&&parent.G.D.Li){parent.G.D.Li=false;this.Ci(false)}if(e)return;var t=this.oi;for(var i=0;i<t.length;i++)t[i].style.visibility="inherit";this.ki()},onmousedown:function(e){if(this.Bi){clearTimeout(this.Bi);this.Bi=null}var t=this.oi;var i=true;for(var n=0;n<t.length;n++){var a=t[n].style;if(a.visibility!="hidden"){a.visibility="hidden";i=false}}var o;if(!i&&!is_SA_child_animation&&SA_child_animation_max){for(var n=0;n<SA_child_animation_max;n++){if(SA_child_animation[n]){o=true;break}}}i=!o;if(i){var r,s;if(WallpaperEngine_mode){r=e.x;s=e.y}else{if(absolute_screen_mode){r=SA_top_window.m().x;s=SA_top_window.m().y}else{r=e.screenX;s=e.screenY}}if(!is_SA_child_animation||!parent.Ii("ChildDragDisabled")||true)this.Bi=setTimeout("System._browser.onmousedown_dragStart("+r+","+s+")",200)}else DEBUG_show("(focused)",1)},Ci:function(e,t){if(is_SA_child_animation){if(!xul_mode||!this.Li)parent.G.D.Ci(e)}if(!e){Ldrag_dummy.style.visibility="hidden";return}var i=document.body.style.pixelWidth;var n=document.body.style.pixelHeight;if(i&&n){var a=Ldrag_dummy.style;a.pixelWidth=i-2;a.pixelHeight=n-2;a.visibility="inherit"}if(t)DEBUG_show("(selected)",1)},xi:function(i){System.o.B.Z=true;var e=[];for(var t=0;t<SA_child_animation_max;t++){if(SA_child_animation[t])e[t]={index:t,z:SA_child_animation[t].z}}e.sort(function(e,t){return e.index==i?1:t.index==i?-1:e.z-t.z}).forEach(function(e,t){SA_child_animation[e.index].z=document.getElementById("Ichild_animation"+e.index).style.zIndex=t})},ji:null,Ui:false,Gi:false,Hi:function(e,t){this.Bi=null;if(WallpaperEngine_mode)return;if(is_SA_child_animation&&is_SA_child_animation_host){parent.G.D.Li=true;parent.G.D.Pi=e;parent.G.D.Ti=t;DEBUG_show("drag start",1);this.Ci(true);return}if(!this.Ui&&(!is_SA_child_animation||!parent.G.D.Gi)){this.Li=true;this.Pi=e;this.Ti=t;DEBUG_show("drag start",1)}this.Ci(true);if(is_SA_child_animation){parent.G.D.xi(SA_child_animation_id)}},Wi:0,zi:1,Xi:null,Yi:null,onmouseup:function(e){if(this.Yi&&this.Yi(e))return;this.onmouseout(true);if(this.Ui||is_SA_child_animation&&parent.G.D.Gi)this.Ci(false);if(e.clientX>20||e.clientY<document.body.style.pixelHeight-20)return;if(this.Xi){clearTimeout(this.Xi);this.Xi=null}if(++this.Wi<this.zi){this.Xi=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250);return}this.Wi=0;if(!WallpaperEngine_mode&&(!self.Ki||!Lquick_menu.Zi))this.Vi()},Vi:function(e){if(browser_native_mode){if(confirm("This will reload System Animator.")){SA_topmost_window.location.reload()}return}if(!e||xul_mode){System.D.Ci(true,true);var t=is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.Ni){if(confirm("Close "+SystemEXT.$i.Ji+" (XUL host)?")){SA_top_window.opener.close();return}t+=" (this animation only)"}System.D.Ci(false)}if(is_SA_child_animation){if(is_SA_child_animation_host){parent.G.D.Vi(e)}else{parent.G.o.B.Z=true;parent.vi[SA_child_animation_id]=null;var i=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);i.style.pixelWidth=i.style.pixelHeight=0;i.style.visibility="hidden";i.contentWindow.location.replace("z_blank.html")}}else{if(WallpaperEngine_CEF_mode&&!W8_or_above){SA_top_window.location.reload()}else SA_top_window.close()}},qi:function(){if(!System.o.Qi)return false;if(use_inline_dialog){if(document.getElementById("Idialog").style.visibility=="hidden"){document.getElementById("Idialog").contentWindow.location.replace("settings.html")}return true}System.D.Ci(true,true);var e=showModalDialog(System.o.Qi,self);e=xul_mode?self.returnValue:e;System.D.Ci(false);this.en(e);return true},en:function(e){if(System.o.en)System.o.en({j:!!e,U:{commit:true}})},onkeydown:function(e){var f=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host;var t=e.keyCode;if(t==67){this.Vi();return true}else if(t==69){return this.qi()}else if(t==79){var i;if(is_SA_child_animation){var n=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;i=this.Tt;if("tn"in e){i=e.tn}else{i-=.25;if(i<.25)i=1}parent.G.o.B.Z=true;parent.vi[SA_child_animation_id].opacity=i;n.opacity=i}else if(this.Jt){i=this.Tt;if("tn"in e){i=e.tn}else{i-=.25;if(i<.25)i=1}System.o.B.O("Opacity",i);this.Tt=i;this.ki()}else if(w3c_mode||HTA_use_GPU_acceleration){var n=this.body.style;i=this.Tt;if("tn"in e){i=e.tn}else{i-=.25;if(i<.25)i=1}System.o.B.O("Opacity",i);n.opacity=i}else return false;this.Tt=i;DEBUG_show("Opacity:"+i*100+"%",2);this.nn();return true}else if(t==83){var u=System.o.K?System.o.an:System.o.on;if(!u)return false;setTimeout(System.D.rn,0);return true}else if(f&&(t>=49&&t<49+SA_child_animation_max)){var a=t-49;var o=is_SA_child_animation?parent:self;var r=o.document.getElementById("Ichild_animation"+a);if(!r||!r.contentWindow.sn){DEBUG_show("(child animation "+(a+1)+" not found)",2);return true}var s=r.contentWindow;var _=s.parent;var l=_.G.D;if(s.G.o.B.L("CSSTransform3D")||_.G.o.B.L("CSSTransform3D")){if(l.ji==a){l.ji=null;s._n("(deselected)",2);_._n("(child"+(a+1)+" deselected)",2);return true}l.ji=a}s._n("(selected)",2);_._n("(child"+(a+1)+" selected)",2);l.xi(a);s.focus();return true}else if(f&&t==96){var o=is_SA_child_animation?parent:self;var n=o.ln.style;n.visibility=n.visibility=="hidden"?"visible":"hidden";if(webkit_mode)n.display=n.visibility=="hidden"?"none":"block";o.G.D.ji=null;return true}else if(f&&(t>=97&&t<97+SA_child_animation_max)){var a=t-97;var o=is_SA_child_animation?parent:self;var r=o.document.getElementById("Ichild_animation"+a);if(!r||!r.contentWindow.sn){DEBUG_show("(child animation "+(a+1)+" not found)",2);return true}var n=r.style;n.visibility=n.visibility=="hidden"?"visible":"hidden";if(webkit_mode)n.display=n.visibility=="hidden"?"none":"block";o.G.D.ji=null;var h=false;for(var c=0;c<SA_child_animation_max;c++){var r=o.document.getElementById("Ichild_animation"+c);if(r&&r.contentWindow.sn&&r.style.visibility!="hidden"){h=true;break}}o.document.getElementById("Lchild_animation_parent").style.visibility=h?"visible":"hidden";return true}else if(t>=96&&t<96+10){if(self.fn&&MMD_SA_options.un&&MMD_SA.hn&&MMD_SA.cn){if(this.bt.Mn){}else if(t==96){if(MMD_SA_options.dn){if(!MMD_SA_options.mn&&MMD_SA_options.pn){MMD_SA_options.mn=MMD_SA_options.pn.slice();MMD_SA.Sn=true}else{MMD_SA_options.un=MMD_SA_options.dn.slice(0);MMD_SA_options.mn=null;MMD_SA.Sn=true;DEBUG_show("(MMD motions shuffled)",2)}}}else{var a=t-97;if(MMD_SA_options.vn){if(MMD_SA_options.vn.An){DEBUG_show("(music/motion loading)",2);return true}let e=Object.keys(MMD_SA_options.vn).find(e=>{return MMD_SA_options.vn[e].key==a+1});if(e){let t=MMD_SA_options.vn[e].wn;if(/\.zip\#/i.test(t)){MMD_SA_options.vn.An=true;t=t.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let e=new self.Dn;e.onload=function(){MMD_SA_options.vn.An=false;let e=this.response;e.name=t.replace(/^.+[\/\\]/,"");e.Qe=true;SA_DragDropEMU(e)};e.open("GET",t,true);e.responseType="blob";e.send()}else SA_DragDropEMU(t);return true}}if(a>=MMD_SA.gn){DEBUG_show("(MMD motion not found)",2);return true}if(!MMD_SA_options.dn)MMD_SA_options.dn=MMD_SA_options.un.slice(0);MMD_SA_options.un=[a];MMD_SA_options.mn=null;MMD_SA.Sn=true;DEBUG_show("(MMD motion changed)",2)}return true}}return false},rn:function(){DEBUG_show("Dock state changed",2);var e=!System.o.K;System.o.K=e;System.o.B.O("SA_docked",!!e==!!is_SA_child_animation?"":e?"1":"0");var t=!e?System.o.an:System.o.on;if(!t)return;t()},bn:null,onmousemove:function(e){var t,i;if(WallpaperEngine_mode||browser_native_mode){t=this.yn=e.x;i=this.kn=e.y}if(this.bn&&this.bn(e))return;if(!this.Li){if(is_SA_child_animation&&parent.G.D.Li){parent.G.D.onmousemove(e)}return}if(!WallpaperEngine_mode){if(absolute_screen_mode){t=SA_top_window.m().x;i=SA_top_window.m().y}else{t=e.screenX;i=e.screenY}}if(is_SA_child_animation||this.ji!=null){var n,a,o;if(is_SA_child_animation){o=SA_child_animation_id;n=self;a=parent}else{o=this.ji;n=document.getElementById("Ichild_animation"+o).contentWindow;a=self}a.G.o.B.Z=true;var r=a.vi[o];var s=a.document.getElementById("Ichild_animation"+o).style;var f=n.document.body.style;var u=a.document.body.style;var _=r.x+t-this.Pi;var l=r.y+i-this.Ti;s.posLeft=r.x=_;s.posTop=r.y=l;n.document.getElementById("Ldebug").innerText=a.document.getElementById("Ldebug").innerText="(moving)";n.En=a.En=0;n._n("("+_+","+l+")",2)}else{System.o.B.Z=true;this.moveBy(t-this.Pi,i-this.Ti,e)}this.R();this.Pi=t;this.Ti=i},R:function(e,t){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask.$t))return;if(is_SA_child_animation||document.getElementById("LdesktopBG")&&LdesktopBG.style.display!="none"){if(WallpaperEngine_mode){e=0;t=0}else{if(absolute_screen_mode){if(e==null)e=SA_top_window.g;if(t==null)t=SA_top_window.k;var i=SA_top_window.l(e,t);e=-(e-i.x);t=-(t-i.y)}else{if(e==null)e=SA_top_window.screenLeft;if(t==null)t=SA_top_window.screenTop;e=-(e%parent.screen.width);t=-(t%parent.screen.height)}}if(is_SA_child_animation){var n=parent.vi[SA_child_animation_id];e-=n.x;t-=n.y}else{var a=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;a.posLeft=e;a.posTop=t}if(document.getElementById("C_wallpaper_mask")){var o=C_wallpaper_mask.style;o.posLeft=e;o.posTop=t}}},moveBy:function(e,t,i){SA_top_window.T(e,t)},nn:function(e){try{if(!webkit_electron_mode||IPC.Rn!=self)return;if(this.Pn==RAF_timestamp){return}this.Pn=RAF_timestamp;if(!e){e={Tn:IPC.Tn,Bn:SA_topmost_window.Ii("IgnoreMouseEvents"),Ln:SA_topmost_window.Ii("IgnoreMouseEventsPartial"),On:SA_topmost_window.Ii("AutoItAlwaysOnTop"),In:SA_topmost_window.Ii("AutoItStayOnDesktop"),Fn:SA_topmost_window.Ii("AutoItAutoPause"),opacity:is_SA_child_animation?parent.vi[SA_child_animation_id].opacity:parseFloat(System.o.B.L("Opacity")||1),Cn:parseFloat(System.o.B.L("OpacityOnHover")||1),size:Settings.xn?-1:Settings.jn,Un:Settings.Gn,Hn:self.ci&&SL.Wn&&SL.Wn(),zn:null,Xn:{enabled:!!self.Yn}};var t=[true];for(var i=0;i<SA_child_animation_max;i++)t.push(!!SA_topmost_window.vi[i]);e.Rn=t;e.Kn=returnBoolean("ChildDragDisabled");var n=this.Zn;if(n){e.Vn=n.Nn;n.nn&&n.nn(e)}else{e.Vn={}}if(self.fn&&MMD_SA.Jn){var a=MMD_SA_options.$n;var o=e.zn={qn:!!MMD_SA.qn,Qn:!!MMD_SA_options.ea,ta:!!MMD_SA_options.ia,na:!!returnBoolean("MMDTrackballCamera"),aa:!!returnBoolean("MMDRandomCamera"),oa:!!MMD_SA_options.ra,sa:!!returnBoolean("MMDOverrideDefaultForExternalModel"),_a:{},$n:{la:{},fa:{},ua:{},ha:{},ca:{}}};o.Ma=MMD_SA.Ma||[];if(MMD_SA.da){o.da=MMD_SA.da;MMD_SA.da=null}var r=jThree("#MMD_DirLight").ma(0);var s=r.color;o._a.color=[Math.min(255,parseInt(s.r*256)),Math.min(255,parseInt(s.pa*256)),Math.min(255,parseInt(s.b*256))];o._a.position=r.position.clone().sub(MMD_SA_options.va&&{x:0,y:0,z:0}||THREE.zn.wa()[0].Aa.position).Sa(1/MMD_SA_options.Da).toArray();o.ga=MMD_SA_options.ga;Object.assign(o.$n.la,a.la);Object.assign(o.$n.fa,a.fa);Object.assign(o.$n.ua,a.ua);Object.assign(o.$n.ha,a.ha);var _=MMD_SA_options.$n.ca;var l=o.$n.ca;l.enabled=returnBoolean("Use3DPPE")||!!(MMD_SA_options.ba?MMD_SA_options.ya:_.enabled);l.ka=!!_.ka;l.Ea=!!_.Ea;l.Ra=!!_.Ra;l.Pa=parseFloat(System.o.B.L("Use3DBloomPostProcessBlurSize")||.5);l.Ta=parseFloat(System.o.B.L("Use3DBloomPostProcessThreshold")||.5);l.Ba=parseFloat(System.o.B.L("Use3DBloomPostProcessIntensity")||.5);o.La=!!MMD_SA_options.La[MMD_SA_options.Ia.Oa]}if(!document.getElementById("Lchild_animation_parent"))e.Fa=null;else e.Fa=returnBoolean("CSSTransformToChildAnimation")}webkit_electron_remote.Ca("update_tray")(e)}catch(e){console.error(e)}},xa:function(t,i,n){if(!n)n="blob";var a=!(self.fn&&MMD_SA.ja);if(a)MMD_SA_options.Ua=(MMD_SA_options.Ua||0)+1;var e;if(/\.zip\#/i.test(t)||n!="blob"||typeof i=="function"){e=function(){var e=new XMLHttpRequestZIP;e.onload=function(){if(a){MMD_SA.ja.Ga()}if(typeof i=="function"){i(e)}else{i.src=URL.createObjectURL(this.response)}e=undefined};e.open("GET",toFileProtocol(t),true);e.responseType=n;e.send()}}else{e=function(){if(a){var e=function(){MMD_SA.ja.Ga();i.removeEventListener("load",e)};i.addEventListener("load",e)}i.src=toFileProtocol(t)}}if(!self.Dn){window.addEventListener("jThree_ready",function(){e()})}else{e()}},Ha:function(){var a=[[],[]];var o=0;return{add:function(e,t,i,n){a[i].push({Wa:e,za:t+i,loop:n,index:o++})},remove:function(t,e){a[e].forEach(e=>{if(e.Wa==t)e.Xa=true})},Ya:function(e){var t=[];var i=a[e];if(!i.length)return;var n=[];i.forEach(function(e){if(e.Xa)return;if(--e.za>=0){n.push(e)}else{e.Wa();if(e.loop&&--e.loop!=0)n.push(e)}});a[e]=n}}}(),get Ka(){return window.devicePixelRatio>=2?.5:1},Za:function(e){if(e==null)e=Lnumpad_row0.style.display=="none";Lnumpad_row0.style.display=e?"inline":"none";Lnumpad_rows.style.display=e?"block":"none";if(e&&self.Va)ChatboxAT.Na(0,true)},Ja:function(){var _={};return function(e,t){e.preventDefault();e.stopPropagation();var i=MMD_SA_options.Et&&MMD_SA_options.Et.qa.$a;var n=e.target.textContent;var a=_[n]=_[n]||{};var o,r;switch(n){case"S":o=16;a.pressed=!a.pressed;t=a.pressed?"keydown":"keyup";break;case"+":o=107;if(i){if(t=="keyup")return;a.pressed=!a.pressed;t=a.pressed?"keydown":"keyup"}break;case"-":o=109;break;case"*":o=106;break;case"/":o=111;break;case"⏎":o=13;break;case"J":o=32;break;case"↑":o=38;break;case"↓":o=40;break;case"←":o=37;break;case"→":o=39;break;default:o=parseInt(n)+96}if(a.Qa)clearTimeout(a.Qa);if(a.eo)clearTimeout(a.eo);a.Qa=a.eo=null;let s=new KeyboardEvent(t,{bubbles:true,cancelable:true,key:n,keyCode:o,shiftKey:_["io"]&&_["io"].pressed});document.dispatchEvent(s);if(t=="keydown"){if(/[\+S]/.test(n)&&(n!="+"||i)){e.target.style.opacity="0.75"}else{a.Qa=setTimeout(function(){a.eo=setInterval(function(){document.dispatchEvent(s)},100)},400)}}else{e.target.style.opacity=""}}}(),no:function(){var n;var a=0;var o={ao:{oo:{},connection:{ro:function(e,t){console.log("P2P_network: Remote Peer"+"("+t.oo+"/"+t.label+"/host) responding handshake request from Peer-"+e.index+"("+e.id+")");t.send({so:{request:true}})},_o:function(e,t,i){if(i.request){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.oo+"/"+t.label+"/client)'s handshake request accepted from Peer-"+e.index+"("+e.id+")");t.send({so:{lo:true}})}else if(i.lo){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.oo+"/"+t.label+"/host) accepted handshake request from Peer-"+e.index+"("+e.id+")");if(e.Nn.ao.connection.fo&&e.Nn.ao.connection.fo[t.label]){e.Nn.ao.connection.fo[t.label]({oo:e,connection:t,so:i});delete e.Nn.ao.connection.fo[t.label]}}else{console.log("P2P_network: Remote Peer"+"("+t.oo+"/"+t.label+"/host) rejected handshake request from Peer-"+e.index+"("+e.id+")");if(e.Nn.ao.connection.uo&&e.Nn.ao.connection.uo[t.label]){e.Nn.ao.connection.uo[t.label]({oo:e,connection:t,so:i});delete e.Nn.ao.connection.uo[t.label]}}},data:function(e,t,i){}},ho:function(e){if(!e.command)t.Mo.Va.co([e.name+": "+e.do]);return null}}};function r(t,i){this.mo=i;this.status="connecting";t.connections[i.label]=this;var n=this;i.po("data",function(e){if(e.so){t.Nn.ao.connection._o(t,n,e.so)}else{t.Nn.ao.connection.data(t,n,e)}});i.po("close",function(e){console.log("P2P_network: DataConnection"+"("+i.oo+"/"+i.label+"/host) closed");n.close(t)})}r.prototype.send=function(e){this.mo.send(e)};r.prototype.close=function(e){if(!e.connections[this.label])return;if(e.Nn.ao.connection.close&&e.Nn.ao.connection.close(e,this))return;delete e.connections[this.label];var t=this;setTimeout(function(){t.mo.close();t.mo=null},1e3)};Object.defineProperty(r.prototype,"oo",{get:function(){return this.mo.oo}});Object.defineProperty(r.prototype,"label",{get:function(){return this.mo.label}});function s(){}Object.defineProperty(s.prototype,"length",{get:function(){return Object.keys(this).length}});function e(t=Object.clone(o)){this.Nn=t;this.id=null;var e=this.So=new Peer;this.index=a;this.connections=new s;this.status="connecting";var i=this;e.po("open",function(e){a++;if(!n)n=i;i.id=e;i.status="connected";console.log("P2P_network: Peer-"+i.index+"("+e+") connected");i.Nn.ao.oo.open&&i.Nn.ao.oo.open(i)});e.po("error",function(e){console.log("P2P_network: Peer-"+i.index+" error",e);if(i.Nn.ao.oo.vo){i.Nn.ao.oo.vo(e);delete i.Nn.ao.oo.vo}else i.Nn.ao.oo.error&&i.Nn.ao.oo.error(i,e)});e.po("connection",function(e){if(t.ao.oo.connection&&t.ao.oo.connection(i,e))return;console.log("P2P_network: Remote Peer"+"("+e.oo+"/"+e.label+"/client) connecting to Peer-"+i.index+"("+i.id+")");e.po("open",function(){console.log("P2P_network: Remote Peer"+"("+e.oo+"/"+e.label+"/client) connected to Peer-"+i.index+"("+i.id+")");new r(i,e)})})}e.prototype.connect=function(a,e){var o=this;return new Promise(function(i,n){var e=function(){var e={Ao:"json"};var t=o.So.connect(a,e);t.po("open",function(){console.log("P2P_network: Remote Peer"+"("+t.oo+"/"+t.label+"/host) connecting to Peer-"+o.index+"("+o.id+")");var e=new r(o,t);o.Nn.ao.connection.ro(o,e);o.Nn.ao.connection.fo=o.Nn.ao.connection.fo||{};o.Nn.ao.connection.uo=o.Nn.ao.connection.uo||{};o.Nn.ao.connection.fo[t.label]=i;o.Nn.ao.connection.uo[t.label]=n;delete o.Nn.ao.oo.vo});t.po("error",function(e){console.log("P2P_network: Remote connection failed",e);n(e)});o.Nn.ao.oo.vo=n};switch(o.status){case"connected":e();break;default:setTimeout(function(){n(o)},0)}})};var t={oo:e,get wo(){return n},status:"off",get Mo(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},Do:function(e,f){var t=this.wo;if(!t)return e;var i=this.Mo.document.getElementById("Flogin").id.value;var n=this.Mo.document.getElementById("Flogin").bo.value;var a=this.Mo.Rt;var o=(i||a&&a.Ia.qa&&a.Ia.qa.name||"Anonymous").substring(0,16);var u=t&&t.connections.length;var r;if(!/^\//.test(e)){r=t.Nn.ao.ho({name:o,do:e,id:i,bo:n})}else{var s,_,h;var l=this.Mo.Va.yo(e);s=l.command;_=l.ko;h=l.Eo;r=t.Nn.ao.ho({name:o,do:e,command:s,ko:_,Eo:h,id:i,bo:n})}if(!f)this.Mo.document.getElementById("Fchat").do.value="";if(r!=null)return r;return e}};return t}(),bt:function(){var ee;var f,s;var u;var te,b;var O,r;var h;var l;var e=new URLSearchParams(self.location.search.substring(1));var ae="";var t=true;var i;var n=1e3/30;var c=n;var g=0;function a(){c+=RAF_timestamp_delta;if(u.Ro||RAF_animation_frame_unlimited&&!MMD_SA.Po.session&&c<n){return}c-=n;var r=ee.To;if(!r.videoWidth||r.readyState<2){return}g=RAF_timestamp;var a=ee.Bo;var s=a.getContext("2d");var _,l;if(ee.Lo&&!ee.stream){_=r.videoWidth;l=r.videoHeight;let t=MMD_SA_options.Fo.Io.Oo;if(t&&_*l>t[0]*t[1]){let e=_/l>t[0]/t[1]?_/t[0]:l/t[1];_=Math.round(_/e);l=Math.round(l/e)}}else{_=ee.Co;l=ee.xo}var o=MMD_SA_options.Fo.display.jo?{scale:1,top:0}:MMD_SA_options.Fo.display.To;if(!o.scale){if(a.style.pixelWidth!=window.innerWidth||a.style.pixelHeight!=window.innerHeight){a.style.width=window.innerWidth+"px";a.style.height=window.innerHeight+"px"}}else{let e=o.scale*(ee.Uo?MMD_SA_options.Fo.display.Go||MMD_SA_options.Fo.display.Ho&&1||.5:1);let i=~~(window.innerWidth*e);let n=~~(window.innerHeight*e);if(a.style.pixelWidth!=i||a.style.pixelHeight!=n){a.style.width=i+"px";a.style.height=n+"px";let e=(window.innerWidth-i)/2;let t=(window.innerHeight-n)/2;a.style.left=e*(1+(o.left!=null?o.left:-1))+"px";a.style.top=t*(1+(o.top!=null?o.top:0))+"px"}a.style.objectFit=ee.Lo&&!ee.stream?"contain":"cover"}if(a.width!=_||a.height!=l){a.width=_;a.height=l;s.globalCompositeOperation="copy";if(ee.Wo){s.translate(_,0);s.scale(-1,1)}}if(_==r.videoWidth&&l==r.videoHeight){s.drawImage(r,0,0)}else{let e=_/l;let t=r.videoWidth/r.videoHeight;let i,n,a,o;if(e<=t){a=r.videoHeight*e;i=(r.videoWidth-a)/2;o=r.videoHeight;n=0}else{a=r.videoWidth;i=0;o=r.videoWidth/e;n=(r.videoHeight-o)/2}s.drawImage(r,i,n,a,o,0,0,_,l)}a.style.visibility=!ee.visible||u.enabled||f.zo&&f.Xo&&!f.Yo||ee.Ko?"hidden":"inherit"}function o(){if(u.enabled){u.Zo()}else{if(te.enabled){te.Zo(true)}else if(f.enabled){f.Zo(true)}if(O.enabled||h.enabled){me(true)}}const i=ee.Vo.style;const e=ee.Bo.style;const t=MMD_SA_options.Fo.display.Jo.No?1:MMD_SA_options.Fo.display.Jo.scale||(is_mobile?.25:1);const n=~~(e.pixelWidth*t);const a=~~(e.pixelHeight*t);if(i.pixelWidth!=n||i.pixelHeight!=a){i.pixelWidth=n;i.pixelHeight=a;if(MMD_SA_options.Fo.display.Jo.No){i.posLeft=e.posLeft;i.posTop=e.posTop}else{let e=(window.innerWidth-n)/2;let t=(window.innerHeight-a)/2;i.left=e*(1+(MMD_SA_options.Fo.display.Jo.left!=null?MMD_SA_options.Fo.display.Jo.left:1))+"px";i.top=t*(1+(MMD_SA_options.Fo.display.Jo.top!=null?MMD_SA_options.Fo.display.Jo.top:-1))+"px"}}i.objectFit=e.objectFit;i.visibility=ee.Mn&&!MMD_SA_options.Fo.display.Jo.hidden&&!MMD_SA_options.Fo.display.jo?"inherit":"hidden"}var y;function _(){if(ee.zo){SL.style.transform=SL_2D_front.style.transform=ee.$o?"scaleX(-1)":"none";ee.Bo.style.transform=ee.qo?"scaleX(-1)":"none";ee.Qo()}if(!y&&ee.zo){y=true;c=n;System.D.Ha.add(a,0,0,-1);System.D.Ha.add(o,2,1,-1)}}function M(){SL.style.transform=SL_2D_front.style.transform=ee.$o?"scaleX(-1)":"none";ee.Bo.style.transform="none";ee.Qo();if(ee.visible)return;if(y&&!ee.Mn){y=false;c=n;System.D.Ha.remove(a,0);System.D.Ha.remove(o,1);ee.Vo.style.visibility="hidden"}}var d=100;function m(e){if(!ee.visible)return;var t=e.detail.keyCode;if(t==107)d+=10;else if(t==109)d-=10;else return;d=Math.max(Math.min(d,180),20);var i=ee.Bo.getContext("2d");if(d==1){i.filter="none";DEBUG_show("Brightness:100%",2)}else{i.filter="brightness("+d+"%) contrast("+(100+(d-100)*.25)+"%)";DEBUG_show("Brightness:"+d+"%",2)}e.detail.result.er=true}var v=0;function A(e){if(!e)e=ee.Lo||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.o.path+"/js/headtrackr.mp4");if(/\.(png|jpg|jpeg|bmp)$/i.test(e)){if(!ee.tr){ee.tr=new Image;Object.defineProperty(ee.tr,"videoWidth",{get:function(){return this.width}});Object.defineProperty(ee.tr,"videoHeight",{get:function(){return this.height}});Object.defineProperty(ee.tr,"readyState",{get:function(){return this.complete?4:0}})}if(ee.To&&ee.To.pause)ee.To.pause();ee.To=ee.tr;ee.tr.src=toFileProtocol(e)}else{ee.To=ee.ir;ee.To.loop=true;if(!ee.To.nr){ee.To.nr=true;ee.To.addEventListener("canplaythrough",function(e){ee.ar=true;SL_MC_simple_mode=true;SL_MC_video_obj=ee.To;SL_MC_Place(1,0,-64)});ee.To.addEventListener("timeupdate",function(e){SL_MC_Timeupdate(this)},true)}ee.To.src=toFileProtocol(e)}ee.Lo=e}var w=false;function k(){var e=te.enabled||O.enabled;if(w==!!e)return;w=!!e;if(e){_();ne.reset();ne.rr();DEBUG_show("(Camera ML Mode:ON)",2)}else{if(ee.zo){ee.sr.style.visibility="hidden";ee.Vo.style.visibility="hidden";M()}ne._r();DEBUG_show("(Camera ML Mode:OFF)",2)}}var D,E,F;var I,C;var p,x;var ie,S;var R,P;var T;window.addEventListener("jThree_ready",function(){I=new THREE.lr;C=new THREE.lr;T=new THREE.lr;p=new THREE.ur;x=new THREE.ur;ie=new THREE.hr;S=new THREE.ur;R=new THREE.cr;P=new THREE.cr});var j=["親","人","中","薬","小"];var U=["thumb","index","middle","ring","pinky"];var G=["０","１","２","３"];var B;var L;var H;var W=true;var X=true;var Y;var oe=true;var K,Z,V;var N=false;var J=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"];var $=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28];var q=[];J.forEach(e=>{q.push({part:e,Mr:0})});var Q,re,se;async function _e(){D=true;if(MMD_SA_options.Ia.dr==null){let h=THREE.zn.wa()[0];let c=h.Aa.mr;let e=c["Sr"].pr.origin;let t=c["vr"].pr.origin;MMD_SA_options.Ia.dr=Math.PI/2+Math.atan2(t[1]-e[1],t[0]-e[0]);let i=c["Ar"].pr.origin;MMD_SA_options.Ia.wr=[e[0]-i[0],e[1]-i[1]];MMD_SA_options.Ia.Dr=Math.sqrt(MMD_SA_options.Ia.wr[0]*MMD_SA_options.Ia.wr[0]+MMD_SA_options.Ia.wr[1]*MMD_SA_options.Ia.wr[1]);let n=c["gr"].pr.origin;MMD_SA_options.Ia.br=Math.abs(e[0]-n[0]);MMD_SA_options.Ia.yr={kr:(new THREE.lr).Er(i).sub(MMD_SA.Rr.Er(e)).normalize()};MMD_SA_options.Ia.yr["Pr"]=MMD_SA_options.Ia.yr["kr"].clone().Tr(-MMD_SA_options.Ia.yr["kr"].x);MMD_SA_options.Ia.Br=(new THREE.lr).Er(c["Lr"].pr.origin).Tr(0);MMD_SA_options.Ia.Or=c["Ir"].pr.origin[1]-MMD_SA_options.Ia.Br.y;MMD_SA_options.Ia.Fr=c["Cr"].pr.origin[1];MMD_SA_options.Ia.jr=MMD_SA.Gr.Er(c["Lr"].pr.origin).Ur(MMD_SA.Hr.Er(c["Wr"].pr.origin));let a=["左","右"];Q={1:{},"-1":{}};a.forEach(l=>{["腕","ひじ"].forEach((e,t)=>{let i=l=="左"?1:-1;let n=l+e;let a,o;let r=c[n].pr.end;a=typeof r=="number"?MMD_SA.Gr.Er(h.Aa.zr[r].pr.origin).sub(C.Er(c[n].pr.origin)).normalize():MMD_SA.Gr.Er(r).normalize();o=MMD_SA.Hr.set(0,0,-1).Xr(p.Yr(I.set(Math.sign(a.x),0,0),a));a.z*=-1;o.z*=-1;a.x*=i;o.x*=i;a.y*=i;o.y*=i;let s=MMD_SA.Rr.Kr(a,o).normalize();o=MMD_SA.Hr.Kr(s,a);let _=MMD_SA.Zr.set(a.x,a.y,a.z,0,s.x,s.y,s.z,0,o.x,o.y,o.z,0,0,0,0,1);Q[i][e]=(new THREE.ur).Vr(_)})});re={1:(new THREE.ur).Nr(MMD_SA.Gr.set(0,-Math.PI/2*1,(-MMD_SA_options.Ia.dr+Math.PI)*1,"YZX")),"-1":(new THREE.ur).Nr(MMD_SA.Gr.set(0,-Math.PI/2*-1,(-MMD_SA_options.Ia.dr+Math.PI)*-1,"YZX"))};se={1:{},"-1":{}};MMD_SA_options.Ia.Jr={};a.forEach(u=>{let e=c[u+"手首"].pr.origin;j.forEach((e,t)=>{let l=u+e+"指";let i=t==0&&c[l+G[0]]?0:1;if(!c[l+G[i+0]])return;let f=MMD_SA_options.Ia.Jr[u+t]={$r:i};for(let s=f.$r+(t==0?0:-1),_=s;_<3;_++){let e=u=="左"?1:-1;let t=l+G[f.$r+(_-s)];let i,n;let a=c[t].pr.end;i=typeof a=="number"?MMD_SA.Gr.Er(h.Aa.zr[a].pr.origin).sub(C.Er(c[t].pr.origin)).normalize():MMD_SA.Gr.Er(a).normalize();n=MMD_SA.Hr.set(0,0,-1).Xr(p.Yr(I.set(Math.sign(i.x),0,0),i));i.z*=-e;n.z*=-e;i.x*=-1;n.x*=-1;let o=MMD_SA.Rr.Kr(i,n).normalize();n=MMD_SA.Hr.Kr(o,i);let r=MMD_SA.Zr.set(i.x,i.y,i.z,0,o.x,o.y,o.z,0,n.x,n.y,n.z,0,0,0,0,1);se[e][t]=(new THREE.ur).Vr(r)}})})}var t=[];if(is_mobile){t.push("use_mobilenet=1")}if(oe){t.push("use_holistic=1");B=L=false;X=Y=true}if(B){t.push("use_human=1");K=true;B=true;L=false;H=false;Z=true;V=true}else if(L){t.push("use_mixed_human=1");B=true;L=true;H=true;V=true}else{B=false;L=false;H=true}if(X){t.push("use_blazepose=1");Y=true}if(Y){t.push("use_mediapipe=1");if(B){Z=true;V=false}W=true}if(W){t.push("use_movenet=1")}if(MMD_SA_options.Fo.Qr.qr&&te.zo&&!te.Xo){await new Promise(function(e,t){var i=setInterval(()=>{if(te.Xo){clearInterval(i);e()}},100)})}else{await te.init()}if(MMD_SA_options.Fo.Qr.qr){r={postMessage:function(e,t){PoseAT.onmessage({data:e})}};let e=document.createElement("script");e.onload=function(){PoseAT.init(r,t)};e.src="js/pose_lib.js";document.head.appendChild(e)}else{r=new Worker("js/pose_worker.js"+(t.length?"?"+t.join("&"):""))}r.onmessage=de}function le(e,t){var i=e.mr[t];var n=this.es[t];var a=Math.max(Math.min(n[0].ts/n[0].ns,1),0);var f=MMD_SA.os.set(0,0,0,1);var o=n[0].rs?MMD_SA._s.ss(n[0].ls):MMD_SA._s.ss(n[1].ls).fs(n[0].ls,a);if(!i){n[0].us.ss(o);return}var r=n[0].hs;if(!r){r=MMD_SA.Ms(e,t,e).cs()}n[0].ds=r;if(n[0].info[1]=="facemesh"&&this.es[t+"_DUMMY_"]){let e=Math.min(Math.max(.25-n[0].ps,0)*5,1);o.fs(this.es[t+"_DUMMY_"][0].us,e*e*.667);n[0].Ss=o.clone()}var s=o.vs()[1]%(Math.PI*2);if(s>Math.PI)s=Math.PI*2-s;else if(s<0&&s<-Math.PI)s+=Math.PI*2;s=Math.abs(s);a=O.As?.5:.3+Math.max(s-Math.PI/2,0)/(Math.PI/2)*.2;var _=p.ws(r,o);var l=I.Ds(_,"YZX");var u=[l.x<0?a+(.5-a)*.5:a,a,a];_.Nr(C.Er(l.toArray().map((e,t)=>Math.sign(e)*Math.min(Math.abs(e),Math.PI/2)*u[t])),"YZX");i.quaternion.ss(_);e.mr["gs"].quaternion.ss(_);if(a<.5){i=e.mr["bs"];i.quaternion.multiply(p.Nr(I.Ds(o,"YZX").multiply(C.Er(u.map(e=>1-e*2))),"YZX"))}}function fe(e,t){if(ee.ks.ys(t))return;var i=t.charAt(0);e.mr[i+"ひざ"].quaternion.set(0,0,0,1)}function ue(e,t){if(O.ys(t))return;var i=e.mr[t];var n=this.es[t];var a=Math.max(Math.min(n[0].ts/n[0].ns,1),0);var o=t.charAt(0);e.mr[o+"腕+"].quaternion.ss(e.mr[o+"腕"].quaternion);e.mr[o+"腕"].quaternion.set(0,0,0,1);e.mr[o+"ひじ"].quaternion.set(0,0,0,1);var r=I.ss(n[1].Rs).Es(n[0].Rs,a);if(!n[0].Ps)r.Xr(MMD_SA.Ms(e,t,e).cs());r.x+=MMD_SA_options.Ia.wr[0]*(o=="左"?1:-1);r.y+=MMD_SA_options.Ia.wr[1];i.position.add(r)}function he(a,e){var t=a.mr[e];var i=this.es[e];var f=Math.max(Math.min(i[0].ts/i[0].ns,1),0);let n=(new THREE.lr).ss(i[0].Bs).Ts(ee.Ls).sub(ee.Ls.position).normalize();if(ce)Me.estimate();let o=ee.Ls.position.z-THREE.zn.wa()[0].Aa.position.z;let r=o;if(ce&&Me.z)r=Me.Os||Me.z;n.Sa(r/n.z).Is();n.z=MMD_SA_options.Fo.Qr.pose.Fs===false?0:o+n.z;if(i[0].Cs)n.add(i[0].Cs);if(MMD_SA_options.Fo.Qr.pose.xs)n.add(MMD_SA_options.Fo.Qr.pose.xs);i[0].Rs.ss(n);var s=(new THREE.lr).ss(i[1].Rs).Es(i[0].Rs,f);var u=MMD_SA.js(a,"左足","全ての親");var h=MMD_SA.js(a,"右足","全ての親");var _=MMD_SA.Rr.ss(u).add(h).Sa(.5).sub(MMD_SA_options.Ia.Br).Is();if(O.Us){let e=MMD_SA.js(a,"左足首","全ての親");let t=MMD_SA.js(a,"右足首","全ての親");let i=e.y<t.y?e:t;let n=MMD_SA_options.Ia.Fr+.2-i.y;n-=s.y;_.y=n}s.add(_);s.x*=ee.Gs?-1:1;if(i[0].absolute)t.position.set(0,0,0);t.position.add(s);var l=T.Ur(s)-5;if(l>0){THREE.zn.wa()[a.Ws].Hs(15+l*2)}T.ss(s)}var ce=1*10;var Me=function(){var d=[];var t=[];function e(e){var s=e.zs[5];var _=e.zs[6];var l=e.zs[11];var f=e.zs[12];if(s.Mr<=0||_.Mr<=0)return;var u=e.Xs[5];var h=e.Xs[6];if(l.Mr<=0||f.Mr<=0){let e=MMD_SA.Hr.ss(u).sub(h);let t=e.length();let i=MMD_SA.Rr.set(1,0,0);let n=MMD_SA.Hr.Ds(MMD_SA.os.Yr(i,e.normalize()),"ZYX").y;let a=P.ss(s.position).add(_.position).Sa(.5);let o=a.clone();let r=R.ss(s.position).Ur(_.position);a.y=a.y+r*1.5/Math.abs(Math.cos(n));if(a.y>ee.Bo.height){o.y=Math.max(o.y-(a.y-ee.Bo.height),0);a.y=ee.Bo.height}d=[{Ys:[{position:o},{position:a.clone()}],Ks:{length:Math.max(4.97462,MMD_SA_options.Ia.Or)*(t*3),Zs:0}}]}else{let e=MMD_SA.Gr.Vs(u,h).Sa(.5);let t=e.length();let i=MMD_SA.Rr.set(0,1,0);i.y*=-1;let n=MMD_SA.Hr.Ds(MMD_SA.os.Yr(i,e.normalize()),"ZXY").x;let a=R.ss(l.position).add(f.position).Sa(.5);let o=P.ss(s.position).add(_.position).Sa(.5);let r=a.Ur(o);o.ss(a);o.y=o.y-r/Math.abs(Math.cos(n));d=[{Ys:[{position:o.clone()},{position:a.clone()}],Ks:{length:Math.max(4.97462,MMD_SA_options.Ia.Or)*(t*2),Zs:0}}]}}function i(){if(!d.length)return;var f=System.D.bt;var u=f.Bo.width;var h=f.Bo.height;var c=I;var M=[];d.forEach(e=>{c.set(e.Ys[0].position.x/u*2-1,-(e.Ys[0].position.y/h)*2+1,.5);var t=MMD_SA.Gr.ss(c.Ts(f.Ls).sub(f.Ls.position).normalize());c.set(e.Ys[1].position.x/u*2-1,-(e.Ys[1].position.y/h)*2+1,.5);var i=MMD_SA.Hr.ss(c.Ts(f.Ls).sub(f.Ls.position).normalize());var n,a;n=e.Ks.length;a=e.Ks.Zs;let o=Math.sqrt(Math.pow(t.x-i.x*t.z/i.z,2)+Math.pow(t.y-i.y*t.z/i.z,2)+0);let r=t.x-i.x*t.z/i.z+(t.y-i.y*t.z/i.z)+0;let s=r/o;let _=1;let l=(Math.sqrt(n*n+1)-1)/(o/s);t.Sa(l);M.push({z:-t.z*1.5,id:e.id})});M.sort((e,t)=>t.z-e.z);var e=M[0].z;this.z=e;t=t.filter(e=>RAF_timestamp-e.timestamp<200);t.push({timestamp:RAF_timestamp,z:e});z=t.reduce((e,t)=>e+t.z,0)/t.length;this.Os=z;d=[]}return{Ns:e,estimate:i}}();var de=function(){function m(e,t){var f=THREE.zn.wa()[e.Ws];var i=e.mr[t];var n=t.charAt(0);var u,a,o,h;var r=e.mr[n+"手捩"];var s;var _=this.es[t];var c=Math.max(Math.min(_[0].ts/_[0].ns,1),0);a=p.set(0,0,0,1);if(r){if(r.quaternion.x||r.quaternion.y||r.quaternion.z){r.quaternion.cs();f.Js(false,n+"手捩")}r.quaternion.set(0,0,0,1)}var l=_[0].hs;if(!l){l=MMD_SA.Ms(e,t,e);l.cs()}_[0].ds=l;a.multiply(_[0].rs?_[0].ls:MMD_SA.os.ss(_[1].ls).fs(_[0].ls,c));i.quaternion.ss(l).multiply(a).multiply(re[n=="左"?1:-1]);if(r){o=r.pr.$s;o=o&&MMD_SA.Gr.Er(o)||MMD_SA_options.Ia.yr[n];let e=I.Ds(i.quaternion,"YZX").y;h=-e*.5;s=x.qs(o,h);this.es[n+"手捩"][0].ls.ss(s);i.quaternion.ws(s.cs(),i.quaternion)}}function P(t,i){if(L=="y"){t.ws(t,MMD_SA.os.Nr(MMD_SA.Rr.set(0,0,MMD_SA_options.Ia.dr*(i==0?1:-1))))}else{t.ws(MMD_SA.os.Nr(MMD_SA.Rr.set(0,0,-(Math.PI/2-MMD_SA_options.Ia.dr)*(i==0?1:-1))),t);let e=t.vs();t.qs(e[0].Xr(Q[i==0?1:-1]["Qs"]),e[1])}}function T(e,t){var i=e.vs();if(L=="y"){e.qs(i[0].e_(MMD_SA.Rr.set(0,0,-MMD_SA_options.Ia.dr*(t==0?1:-1))),i[1])}else{e.qs(i[0].Xr(Q[t==0?1:-1]["t_"]),i[1])}}var o;window.addEventListener("jThree_ready",()=>{o=new THREE.ur});var B=function(){var a=0;return function(e,t){if(!MMD_SA.zn.a_.n_.i_)return;var i=e.mr;var n=i[t].quaternion;if(a!=RAF_timestamp){a=RAF_timestamp;o.ss(i["o_"].quaternion).multiply(i["r_"].quaternion).multiply(i["bs"].quaternion).cs()}n.ws(o,n)}}();var r=0,_=0,l=0,f=0;var L="x";return function(e){var a=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof a==="string"){if(a=="OK"){E=true}else{DEBUG_show(a,2);System.D.console.log(a)}}else{ee.s_=true;ae="";let e=performance.now();let t=0;if(f){t=e-f;l+=t;if(++_>=20){r=1e3/(l/_);_=l=0}}f=e;O.__=a.__;ne.ts=r&&1e3/r||t||a.l_&&1e3/a.l_||a.__;let y=[];let k=[];let E=ee.Gs?1:-1;let i=THREE.zn.wa()[0];let n=i.Aa.mr;let R;if(O.enabled){if(a.f_&&a.f_.Mr>.3){O.u_++;if(O.h_){if(N){N=false;i.Aa.visible=true}R=a.f_;let b=O.As;if(X){let n=[];let a=[];$.forEach((e,t)=>{let i=R.zs[e];i.part=J[t];n.push(i);i=R.Xs[e];i.part=J[t];a.push(i)});R.zs=n;R.c_=R.Xs;R.Xs=a}const s=W?.3:!Z?.5:.1;R.zs.forEach(e=>{e.Mr-=s});if(b){R.c_.forEach(e=>{e.Mr-=s})}if(Z){let i={};R.zs.forEach(e=>{i[e.part]=e});let n=[];for(let t=0;t<=16;t++){let e=R.zs[t];if(!e)n.push(q[t]);else if(e.part!=J[t])n.push(i[J[t]]||q[t]);else n.push(e)}R.zs=n}if(!te.M_){te.d_[0]=R.zs[0].position.x/ee.Bo.width;te.d_[1]=R.zs[0].position.y/ee.Bo.height}if(b){let e=R.c_[0];let t=R.c_[3];let i=R.c_[6];let n=MMD_SA.m_.ss(e).sub(MMD_SA.Hr.ss(t).add(i).Sa(.5)).normalize();let a=MMD_SA.p_.ss(t).sub(MMD_SA.Hr.ss(i)).normalize();let o=MMD_SA.Rr.Kr(a,n).normalize();a.Kr(n,o);ie.set(a.x,a.y,a.z,0,n.x,n.y,n.z,0,o.x,o.y,o.z,0,0,0,0,1);S.Vr(ie);let r=S.cs();r=r.clone().multiply(MMD_SA.os.Nr(MMD_SA.Rr.set(Math.PI/8,0,0)));if(!te.M_){ne.add("skin","首",{S_:true,ls:r,v_:le});ne.es["Ir"][1].Ss&&ne.es["Ir"][1].ls.ss(ne.es["Ir"][1].Ss)}ne.add("skin","首_DUMMY_",{ls:r,us:r.clone(),v_:le})}let o=R.zs[5];let r=R.zs[6];let M=new THREE.ur;let d=MMD_SA.zn.a_.n_.i_;if(d)ae+="\n(upper body only)\n";if(b&&ce)Me.Ns(R);if(o.Mr>0&&r.Mr>0){let l,f;let u,h;let A;if(b){l=R.Xs[5];f=R.Xs[6];let n=R.Xs[11];let a=R.Xs[12];if(d||n.Mr<=0||a.Mr<=0){d=true}else{if(R.zs[11].position.y>ee.Bo.height||R.zs[12].position.y>ee.Bo.height){d=true}let e=MMD_SA.Hr.ss(n).sub(a).normalize();let t=MMD_SA.Rr.set(1,0,0);let i=C.A_(t,e);if(d)i.z=0;M.Nr(i,"YZX")}let e=MMD_SA.Gr.Vs(l,f).Sa(.5).normalize();e.Xr(MMD_SA.os.ss(M).cs());let t=MMD_SA.Rr.set(0,1,0);t.y*=-1;u=(new THREE.ur).A_(t,e);if(d){u.ws(M,u);M.set(0,0,0,1)}let i=MMD_SA.Hr.ss(l).sub(f).normalize();i.Xr(MMD_SA.os.ws(M,u).cs());x_axis=MMD_SA.Rr.set(1,0,0);let o=C.A_(x_axis,i);h=(new THREE.ur).Nr(o,"YZX");let r=0;let s=o.y;let _=(r+s)%(Math.PI*2);if(_>Math.PI)_=Math.PI*2-_;else if(_<0&&_<-Math.PI)_+=Math.PI*2;u.multiply(p.Nr(I.set(0,_/2-r,0),"YZX"));h.multiply(p.Nr(I.set(0,_/2-s,0),"YZX"));ne.add("skin","センター",{ls:M.clone(),priority:9});ne.add("skin","上半身",{ls:u.clone()});ne.add("skin","上半身2",{ls:h.clone()});A=p.ss(M).multiply(u).multiply(h).cs()}let w=Math.sqrt(Math.pow(o.position.x-r.position.x,2)+Math.pow(o.position.y-r.position.y,2));let D=0;if(!b){D=Math.asin((o.position.y-r.position.y)/w);D=Math.max(Math.min(D/(Math.PI/4),1),-1)*Math.PI/4*E}let e=E==1?[1,0]:[0,1];let t=[R.zs[9],R.zs[10]];let g=-1;if(!b&&t[0].Mr>0&&t[1].Mr>0&&Math.sqrt(Math.pow(t[0].position.x-t[1].position.x,2)+Math.pow(t[0].position.y-t[1].position.y,2))<(ee.Bo.width+ee.Bo.height)/2/25){g=t[1].Mr>t[0].Mr?0:1;if(t[g].Mr>.3)g=-1}w=te.w_*2||w;e.forEach(function(a,t){let o,r,n;let h;let s=t==0?"左":"右";let _=R.zs[5+a];let l=R.zs[7+a];let i=R.zs[9+a];ne.add("skin",s+"肩",{absolute:true,ls:(new THREE.ur).Nr(MMD_SA.Rr.set(0,0,D),"YZX")});let c,M,d;if(b){c=R.Xs[5+a];M=R.Xs[7+a];d=R.Xs[9+a]}let m=E*(a==0?-1:1);let f=!MMD_SA_options.Fo.Qr.pose.D_;let p=false;let e,S,u;const v=L=="y"?"XZY":"YZX";if(b&&l.Mr>0){e=MMD_SA.Hr.ss(c).sub(M).normalize().Xr(A);S=L=="y"?MMD_SA.Rr.set(0,-1,0):MMD_SA.Rr.set(m,0,0);u=(new THREE.ur).Yr(S,e)}if(i.Mr>0&&a!=g){k.push({Rs:i.position,dir:a,d:s});if(b){if(!f||l.Mr<=0){f=false;let e=MMD_SA.Gr.ss(c).sub(d);let t=l.Mr>0?MMD_SA.Rr.ss(c).Ur(M)+MMD_SA.Rr.ss(M).Ur(d):.5;let i=Math.min(e.length()/t,1);e.normalize().Sa(i*MMD_SA_options.Ia.Dr);o=e.x;r=e.y;n=h=e.z;if(u){P(u,a);ne.add("skin",s+"腕",{absolute:true,ls:u.fs(MMD_SA.os.set(0,0,0,1),.5)})}}else{let e=I.ss(M).sub(d).normalize().Xr(A);let t=MMD_SA.Gr.ss(e).Xr(MMD_SA.os.ss(u).cs());let i=0;S=L=="y"?MMD_SA.Rr.set(0,-1,0):MMD_SA.Rr.set(m,0,0);let n=(new THREE.ur).Yr(S,t);T(n,a);P(u,a);ne.add("skin",s+"腕",{absolute:true,ls:u,priority:-1,g_:B});ne.add("skin",s+"ひじ",{absolute:true,ls:n,b_:i})}}else{p=true;let e=_.position.x-i.position.x;let t=_.position.y-i.position.y;o=e/w*MMD_SA_options.Ia.br*E;r=t/w*MMD_SA_options.Ia.br;if(l.Mr>0){let e=Math.min(Math.sqrt(Math.pow(i.position.x-l.position.x,2)+Math.pow(i.position.y-l.position.y,2))/w,1);let t=Math.min(Math.sqrt(Math.pow(_.position.x-l.position.x,2)+Math.pow(_.position.y-l.position.y,2))/w,1);h=(.25+(Math.sin(Math.acos(e))+Math.sin(Math.acos(t)))/2*.75)*MMD_SA_options.Ia.Dr}}}else{if(l.Mr>0){if(b){if(!f){f=false;e=MMD_SA.Gr.ss(c).sub(M).normalize();e.Sa(MMD_SA_options.Ia.Dr);o=e.x*E;r=e.y;n=h=e.z}else{f=true;P(u,a);ne.add("skin",s+"腕",{absolute:true,ls:u,priority:-1,g_:B})}}else{f=false;p=true;let e=_.position.x-l.position.x;let t=_.position.y-l.position.y;let i=Math.sqrt(e*e+t*t);let n=Math.asin(e/i);o=Math.sin(n)*MMD_SA_options.Ia.Dr*E;r=Math.cos(n)*MMD_SA_options.Ia.Dr*Math.sign(t)}}else{if(b)return;f=false;p=true;o=MMD_SA_options.Ia.wr[1]*(s=="左"?1:-1)*.2;r=-Math.sqrt(MMD_SA_options.Ia.Dr*MMD_SA_options.Ia.Dr-o*o)}}y.push({Rs:{x:o,y:r,z:n,y_:h},dir:a,d:s,k_:f,E_:p})})}else{d=true}if(b&&!d){let e=E==1?[1,0]:[0,1];let c=[];let t=[];let i=0;e.forEach(function(_,e){let l=e==0?"左":"右";let n=R.Xs[11+_];let s=R.Xs[13+_];let f=R.Xs[15+_];let u,h;let t;if(s.Mr>0){t=MMD_SA.Hr.ss(n).sub(s).normalize().Xr(MMD_SA.os.ss(M).cs());let e=MMD_SA.Rr.set(0,1,0);e.y*=-1;h=C.A_(e,t);u=(new THREE.ur).Nr(h,"XZY");i+=h.x}let a=!MMD_SA_options.Fo.Qr.pose.R_;if(f.Mr>0){let t=MMD_SA.Gr.ss(n).sub(f);let i=s.Mr>0?MMD_SA.Rr.ss(n).Ur(s)+MMD_SA.Rr.ss(s).Ur(f):.7;let e=i+t.y;let r=[f.y,e];if(!a||s.Mr<=0){let e=Math.min(t.length()/i,1);t.normalize().Sa(e*MMD_SA_options.Ia.jr);O.P_(l+"足ＩＫ",true);c.push({Rs:t.clone(),ls:[u],dir:_,d:l,T_:r})}else{let e=I.ss(s).sub(f).normalize().Xr(MMD_SA.os.ss(M).cs());let t=MMD_SA.Gr.ss(e).Xr(MMD_SA.os.ss(u).cs());t.z=Math.max(-t.z,0);t.x*=-1;let i=t.normalize().B_();let n=Math.sqrt(Math.min((Math.PI-i[2])/(Math.PI/2),1));h.y=i[1]*n;u.Nr(h,"XZY");t=MMD_SA.Gr.ss(e).Xr(MMD_SA.os.ss(u).cs());let a=MMD_SA.Rr.set(0,1,0);a.y*=-1;let o=(new THREE.ur).A_(a,t);O.P_(l+"足ＩＫ",false);c.push({ls:[u,o],dir:_,d:l,T_:r})}if(a){let r=R.c_[29+_];let s=R.c_[31+_];if(r.Mr>0&&s.Mr>0){let e=MMD_SA.m_.ss(r).sub(f).normalize();let t=MMD_SA.p_.ss(r).sub(s).normalize();let i=I.Kr(e,t).normalize();e.Kr(t,i);ie.set(i.x,i.y,i.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,0,0,0,0,1);S.Vr(ie);let n=S.cs();n=n.clone().multiply(MMD_SA.os.Nr(MMD_SA.Rr.set(-Math.PI/8,0,0)));let a=Math.abs(MMD_SA.Rr.Ds(M,"YZX").y)%Math.PI;let o=a>Math.PI/2?1-(a-Math.PI/2)/(Math.PI/2):1;ne.add("skin",l+"足首",{S_:true,L_:true,O_:true,ls:n,ratio:o})}}else{}}else if(s.Mr>0){}});i*=.5*.5;let n=(new THREE.ur).Nr(MMD_SA.Rr.set(i,0,0));ne.add("skin","下半身",{absolute:true,ls:n.clone()});if(!d){let e=ee.Bo.width;let t=ee.Bo.height;let i=new THREE.lr;let n=R.zs[11].position;let a=R.zs[12].position;let o=e/t;let r=SL.width/SL.height;i.set(((n.x+a.x)/2/e*2-1)*(o<r?o/r:1),(-((n.y+a.y)/2/t)*2+1)*(r<o?r/o:1),.5);ne.add("skin","全ての親",{Rs:new THREE.lr,S_:true,priority:999,Bs:i,I_:he})}n.cs();c.forEach(e=>{var t=e.d;if(e.Rs){e.Rs.y+=MMD_SA_options.Ia.jr;if(e.ls[0]){ne.add("skin",t+"足",{absolute:true,ls:e.ls[0]})}ne.add("skin",t+"足ＩＫ",{absolute:true,Rs:e.Rs,priority:999,g_:fe})}else{if(i)e.ls[0].ws(n,e.ls[0]);ne.add("skin",t+"足",{absolute:true,ls:e.ls[0]});ne.add("skin",t+"ひざ",{absolute:true,ls:e.ls[1]})}})}else{if(MMD_SA.zn.a_.n_.i_){ne.add("skin","全ての親",{F_:true,Rs:true,S_:true,priority:999})}else if(b&&o.Mr>0&&r.Mr>0){let e=ee.Bo.width;let t=ee.Bo.height;let i=new THREE.lr;let n=e/t;let a=SL.width/SL.height;i.set(((o.position.x+r.position.x)/2/e*2-1)*(n<a?n/a:1),(-((o.position.y+r.position.y)/2/t)*2+1)*(a<n?a/n:1),.5);ne.add("skin","全ての親",{Rs:new THREE.lr,S_:true,priority:999,Bs:i,Cs:{x:0,y:-Math.max(4.97462,MMD_SA_options.Ia.Or),z:0},I_:he})}ne.add("skin","下半身",{F_:true,ls:true});["左","右"].forEach(e=>{ne.add("skin",e+"足ＩＫ",{F_:true,Rs:true,priority:999});ne.add("skin",e+"足",{F_:true,ls:true});ne.add("skin",e+"ひざ",{F_:true,ls:true});ne.add("skin",e+"足首",{F_:true,S_:true,ls:true})})}}}else{O.u_=0}}if(O.enabled&&!O.h_&&!N){N=true;if(!MMD_SA.zn.a_.n_.i_)i.Aa.visible=false}let g;let d=[];if(h.enabled&&a.C_&&a.C_.length&&k.length){let i;if(Y){i=E?{x_:{dir:1,list:[]},j_:{dir:0,list:[]}}:{x_:{dir:0,list:[]},j_:{dir:1,list:[]}};a.C_.forEach(e=>{if(e.label)i[e.label].list.push(e)})}const o=Y?1:2;a.C_.forEach(t=>{t.U_={};g=t.G_;let i=MMD_SA.Rr.Er(g.H_[0]);k.forEach(e=>{t.U_[e.dir]=Math.sqrt(Math.pow(e.Rs.x-i.x,2)+Math.pow(e.Rs.y-i.y,2))})});k.forEach((h,e)=>{var c=h.dir;var t=i?i[i.x_.dir==c?"x_":"j_"].list:a.C_;if(!t.length)t=a.C_;let M=e==0?a.C_.length==1&&k.length>1?t[0].U_[c]<t[0].U_[c==0?1:0]&&t[0]:t.sort((e,t)=>e.U_[c]-t.U_[c])[0]:t.find(e=>!e.W_);if(M&&M.U_[c]<Math.max(ee.Bo.width,ee.Bo.height)/6){M.W_=true;g=M.G_;let e=y.find(e=>e.dir==c);let w=h.d;d.push(w+"手");let t=c==1?[g.index[0],g.z_[0]]:[g.z_[0],g.index[0]];let _,l,f;let i=MMD_SA.m_.Er(g.H_[0]).sub(MMD_SA.Hr.Er(g.X_[0])).normalize();i.x=i.x*E;let n=MMD_SA.p_.Er(t[0]).sub(MMD_SA.Hr.Er(t[1])).normalize();n.z=n.z*E;n.y=n.y*E;let a=MMD_SA.Rr.Kr(n,i).normalize();n.Kr(i,a);ie.set(n.x,n.y,n.z,0,i.x,i.y,i.z,0,a.x,a.y,a.z,0,0,0,0,1);S.Vr(ie);let o=new THREE.ur;o.ss(S).cs();ne.add("skin",w+"手首",{S_:true,ls:o,v_:m});ne.add("skin",w+"手捩",{S_:true,absolute:true,priority:1,rs:true,ls:new THREE.ur});let u=new THREE.ur;let r=MMD_SA_options.Ia.Jr;let s=p.ss(S);s.y*=-1;s.w*=-1;let D=w=="左"?1:-1;j.forEach((M,d)=>{let m=r[(E==1?w:w=="左"?"右":"左")+d];let p=m.$r+(d==0?0:-1);let S=g[U[d]];let v=x.ss(s);const A="XZY";for(let c=p;c<3;c++){let e=w+M+"指"+G[m.$r+(c-p)];let t=MMD_SA.Gr.Er(S[c+0]);let i=MMD_SA.Hr.Er(S[c+1]);let n=MMD_SA.Rr.Er(c==p?g.H_[0]:S[c-1]);t.y=-t.y;i.y=-i.y;n.y=-n.y;let a=MMD_SA.m_.ss(t).sub(n);let o=MMD_SA.p_.ss(i).sub(t);a.normalize();o.normalize();let r,s;let _;a.Xr(v);o.Xr(v);if(c==p){let e=MMD_SA.os.set(0,0,0,1);e.A_(MMD_SA.Rr.set(0,1,0),a).cs();o.Xr(e);v.ws(e,v)}let l=MMD_SA.Y_.set(0,0,0,1);let f=MMD_SA._s.set(0,0,0,1);a.set(0,1,0);_=C.A_(a,o);l.Nr(_,A);f.ss(l);v.ws(l.cs(),v);if(Math.abs(_.z)>Math.PI/(d==0?1.5:2.5)||_.x>Math.PI/(d==0?2:3)){_.set(-Math.abs(a.K_(o)),0,0)}if(d==0&&c>p){_.x=0}if(_.x>0){_.x*=d==0||c>p?0:.75}else{_.x=Math.max(_.x,-Math.PI/(d==0?1.5:2))}if(d==0||c==p){_.z*=.9;_.z+=(d-2)/2*Math.PI/8*(D==1?1:-1)*(d>0?1:.5)}else{_.z=0}_.y=0;l.Nr(_,A);let u=e;let h=l.vs();s=h[0];r=h[1];s.e_(I.set(0,-Math.PI/2,0)).Xr(MMD_SA.os.ss(se[D][u]).cs());l.qs(s,r);ne.add("skin",e,{absolute:true,ls:l.clone()})}})}})}else if(!h.enabled&&R&&O.As){let e=E==1?[1,0]:[0,1];e.forEach(function(e,f){let t=f==0?"左":"右";let i=R.c_[15+e];let n=R.c_[17+e];let a=R.c_[19+e];if(i.Mr<=0||n.Mr<=0||a.Mr<=0)return;let o=e==1?[a,n]:[n,a];let r=MMD_SA.m_.ss(i).sub(MMD_SA.Hr.ss(n).add(a).Sa(.5)).normalize();r.x=r.x*E;let s=MMD_SA.p_.ss(o[0]).sub(o[1]).normalize();s.z=s.z*E;s.y=s.y*E;let _=MMD_SA.Rr.Kr(s,r).normalize();s.Kr(r,_);ie.set(s.x,s.y,s.z,0,r.x,r.y,r.z,0,_.x,_.y,_.z,0,0,0,0,1);S.Vr(ie);let l=new THREE.ur;l.ss(S).cs();ne.add("skin",t+"手首",{S_:true,ls:l,v_:m});ne.add("skin",t+"手捩",{S_:true,absolute:true,priority:1,rs:true,ls:new THREE.ur})})}y.forEach(function(e){var t=e.d;O.P_(t+"腕ＩＫ",!e.k_);if(!e.k_){if(e.Rs.z==null)e.Rs.z=e.Rs.y_||(O.As?0:MMD_SA_options.Ia.Dr*.2);ne.add("skin",t+"腕ＩＫ",{Z_:10,priority:999,Rs:(new THREE.lr).ss(e.Rs),Ps:e.E_,I_:ue})}var i=ne.es[t+"手首"];if(i){i[0].hs=i[0].ds}});ae+=(ae?"/":"\n")+"P-FPS:"+Math.round(r)+"/"+Math.round(a.l_||0);if(!O.V_&&!te.enabled&&ae&&!System.D.Dt&&!MMD_SA_options.Fo.Qr.N_){DEBUG_show(ae+"\n"+"FPS:"+EV_sync_update.J_)}if(a.q_){te.Q_({data:a.q_})}else if(O.V_){te.u_=0}if(R&&te.Xo){let e={f_:R,w:ee.Bo.width,hi:ee.Bo.height,el:ee.qo};if(a.C_&&a.C_.length)e.C_=a.C_;if(a.q_)e.q_=a.q_.tl;if(O.V_||!te.enabled){e.il=true;if(self.nl){e.canvas=ee.Vo}else if(!ee.Vo.al&&self.OffscreenCanvas){e.canvas=ee.Vo.transferControlToOffscreen();ee.Vo.al=true;console.log("(Facemesh: use offscreen canvas)")}}b.postMessage(e,e.canvas?[e.canvas]:undefined)}F=0}me()}}();function me(e){function t(){var e=O.enabled&&O.Xo&&g&&!O.Ro&&y&&O.ol!=g;if(!e)return;F=RAF_timestamp;O.ol=g;if(O.V_){MMD_SA_options.rl=false}let t,i,n;t=ee.Bo;i=t.width;n=t.height;let a=t.getContext("2d").getImageData(0,0,i,n).data.buffer;let o={sl:a,w:i,hi:n,options:{V_:O.V_,_l:true,ll:h.enabled,fl:O.fl}};r.postMessage(o,[o.sl]);o.sl=a=undefined;o=undefined}if(e||self.ul){setTimeout(()=>{t()},0)}else{t()}}var pe=function(){var o,r;window.addEventListener("jThree_ready",e=>{o=new THREE.lr;r=new THREE.ur});function s(i,n){var e,t;var a=i.mr[n];var o=this.es[n];if(O.enabled&&!O.h_)return;if(o[0].info[1]=="facemesh"){if(!te.u_)return}o[0].ts+=RAF_timestamp_delta;let r=Math.max(Math.min(o[0].ts/o[0].ns,1),0);if(o[0].ls){if(o[0].S_){t=!a.Js||a.Js.length;if(t){e=THREE.zn.wa()[i.Ws];if(a.quaternion.x||a.quaternion.y||a.quaternion.z){a.quaternion.cs();e.Js(false,n);a.quaternion.cs()}}}if(o[0].v_){o[0].v_.call(this,i,n)}else{let t=p.set(0,0,0,1);if(o[0].absolute){a.quaternion.set(0,0,0,1)}if(o[0].O_){let e=o[0].hs;if(!e){e=MMD_SA.Ms(i,n,i).cs()}o[0].ds=e;t.ss(e)}t.multiply(o[0].rs?o[0].ls:MMD_SA.os.ss(o[1].ls).fs(o[0].ls,r));if(o[0].ratio<1)t.fs(x.set(0,0,0,1),1-o[0].ratio);const s=MMD_SA_options.cl[i.Ws].hl[n];if(s&&s.Ml){if(typeof s.Ml=="number")s.Ml={x:s.Ml,y:s.Ml,z:s.Ml};t.Nr(MMD_SA.Rr.Ds(t,"YXZ").multiply(s.Ml),"YXZ")}a.quaternion.multiply(t)}}if(o[0].Rs){if(o[0].I_){o[0].I_.call(this,i,n)}else{if(o[0].absolute)a.position.set(0,0,0);a.position.add(MMD_SA.Rr.ss(o[1].Rs).Es(o[0].Rs,r))}if(o[0].Z_){if(!o[1].dl){o[1].dl=new THREE.lr}else{let e=MMD_SA.Rr.ml(a.position,o[1].dl);let t=e.length()/(Math.max(RAF_timestamp_delta,RAF_timestamp-o[1].timestamp)/1e3);if(t>o[0].Z_)a.position.ss(o[1].dl).add(e.Sa(o[0].Z_/t))}o[1].dl.ss(a.position);o[0].dl=o[1].dl}}o[0].g_&&o[0].g_.call(this,i,n);t&&e.Js(false,n)}function t(e){var t=e.detail.pl;var n=t.Aa;var a=MMD_SA.motion[t.es.Sl].n_;var o=this.es;var i=Object.keys(o).filter(e=>!o[e][0].S_).sort((e,t)=>{let i=o[e][0].priority||0;let n=o[t][0].priority||0;return i-n});i.forEach(e=>{let t=n.mr[e];if(!t&&!/_DUMMY_/.test(e))return;var i=o[e][0].info[1];if((!i||/pose/.test(i))&&!a.vl)return;s.call(this,n,e)})}function i(e){var t=e.detail.pl;var n=t.Aa;var a=MMD_SA.motion[t.es.Sl].n_;var o=this.es;var i=Object.keys(o).filter(e=>o[e][0].S_).sort((e,t)=>{let i=o[e][0].priority||0;let n=o[t][0].priority||0;return i-n});i.forEach(e=>{let t=n.mr[e];if(!t&&!/_DUMMY_/.test(e))return;var i=o[e][0].info[1];if((!i||/pose/.test(i))&&!a.vl)return;s.call(this,n,e)})}function n(e){if(O.enabled&&!O.h_)return;var _=e.detail.pl;var l=_.Aa;var f=_.wl.Al;_.gl.Dl.forEach(function(e){if(e.bl!=3)return;var t=e.name;if(!_.gl.yl[t])return;var i=_.wl.kl[t];if(i==null)return;var n=f[i];var a=n.keys[0];if(a.El==1){l.Rl[i]=0}else{let e={name:t,weight:0,El:a.El,Pl:a.Pl};_.wl.onupdate(e,e,0,i)}});var u=MMD_SA_options.Ia.Tl;var h=this.wl;var c={};var a=0;Object.keys(h).forEach(function(e){let t=h[e];if(t.disabled)return;t[0].ts+=RAF_timestamp_delta;let i=Math.max(Math.min(t[0].ts/t[0].ns,1),0);let n=t[0].weight*i+t[1].weight*(1-i);c[e]=n;if(n)a++});Object.keys(c).forEach(function(e){let t=h[e];let i=c[e];if(i<0){switch(e){case"にやり":e="ω";break;case"上":e="下";break}i=-i}let n=u[e];let a=n&&n.name||e;let o=_.wl.kl[a];if(o==null)return;i*=n&&n.weight||1;let r=f[o];let s=r.keys[0];if(s.El==1){l.Rl[o]=i}else{let e={name:a,weight:i,El:s.El,Pl:s.Pl};_.wl.onupdate(e,e,0,o)}})}function e(e,t,i){i.info=e.split("|");var n=i.info[0];var a=this[n][t];if(i.F_){if(a&&a[0].F_)return;i.rs=true;if(i.Rs)i.Rs=o;if(i.ls)i.ls=r}i.timestamp=RAF_timestamp;i.ts=0;i.ns=this.ts*(t.indexOf("指")!=-1||t.indexOf("手首")!=-1?O.fl+1:1);i.ns=Math.max(Math.min(i.ns,200),1e3/60);if(a){if(RAF_timestamp==a[0].timestamp){a[0]=Object.assign(a[0],i)}else{if(!i.rs){let e=O.As||i.info[1]=="facemesh"?.5+Math.max(Math.min((Math.max(i.ns,RAF_timestamp-a[0].timestamp)-50)/150,1),0)*.5:1;if(i.Rs){i.Rs.Es(a[0].Rs,1-e)}if(i.ls){i.ls.fs(a[0].ls,1-e)}if(i.weight!=null){i.weight=i.weight*e+a[0].weight*(1-e)}}this[n][t]=[i,a[0]]}}else{this[n][t]=[i,i]}}function a(e,t){delete this[e][t]}function _(){this.es={};this.wl={}}function f(){window.addEventListener("SA_MMD_model"+this.Bl+"_process_morphs",this.Ll);window.addEventListener("SA_MMD_model"+this.Bl+"_process_bones",this.Ol);window.addEventListener("SA_MMD_model"+this.Bl+"_process_bones_after_IK",this.Il)}function u(){window.removeEventListener("SA_MMD_model"+this.Bl+"_process_morphs",this.Ll);window.removeEventListener("SA_MMD_model"+this.Bl+"_process_bones",this.Ol);window.removeEventListener("SA_MMD_model"+this.Bl+"_process_bones_after_IK",this.Il)}var l=function(e){this.Bl=e;this.es={};this.wl={};this.Ol=t.bind(this);this.Il=i.bind(this);this.Ll=n.bind(this)};l.prototype.add=e;l.prototype.remove=a;l.prototype.reset=_;l.prototype.rr=f;l.prototype._r=u;return l}();var ne=new pe(0);var Se=e.get("camera_hidden");var ve;ee={zo:false,get Mn(){return w},get Fl(){return te.Ro||O.Ro},get Cl(){return 1e3/(Math.max(te.enabled&&te.xl&&(!O.enabled||!O.V_)&&te.__||0,O.enabled&&O.__||0)||1e3)},get jl(){return v||window.devicePixelRatio},set jl(e){v=e==window.devicePixelRatio?0:e},get Ul(){return t&&!ee.$o},set Ul(e){t=e},get Wo(){return!w?i:!!i^!!ee.Ul},set Wo(e){i=e;this.Qo()},get qo(){return ee.$o?false:i!=ee.Wo},get $o(){return!w||!MMD_SA_options.Fo.$o?false:MMD_SA_options.Fo.$o==1?ee.visible:true},get Gs(){return ee.Ul||ee.$o},get Ko(){return Se||MMD_SA_options.Fo.display.To.hidden||System.D.Dt>0||this.stream&&MMD_SA_options.Fo.display.To.Gl},get Uo(){return MMD_SA_options.Fo.display.Ho||ve},set Uo(e){ve=e;if(this.gt)this.gt.style.zIndex=this.Uo?2:0},Hl:false,Wl:null,deviceId:null,start:async function(i){var e=MMD_SA_options.Po&&MMD_SA_options.Po.zl;MMD_SA.Xl();this.Ls=MMD_SA.Yl.object.clone();if(this.zo){if(this.visible){this.hide();DEBUG_show("User camera:HIDDEN",2);return}}var n={To:this.Kl()};try{if(i){this.Zl(i)}else{if(is_mobile){n.To.Vl="user"}if(MMD_SA_options.Et){MMD_SA_options.Et.Nl([[{message:{content:"(finding camera...)"}},{Jl:0}]])}let t;if(!this.Hl||is_mobile&&!this.stream){try{t=await navigator.mediaDevices.getUserMedia(n);this.Hl=true;this.Wl=null}catch(e){if(is_mobile||!MMD_SA_options.Et)throw"(ERROR: Camera unavailable, using fallback video instead)";this.Wl=[]}}if(!is_mobile){let e=this.Wl;if(!e){e=await navigator.mediaDevices.enumerateDevices();e=e.filter(e=>e.kind=="videoinput");if(MMD_SA_options.Fo.$l)e.sort((e,t)=>MMD_SA_options.Fo.$l.label.test(e.label)&&-1||MMD_SA_options.Fo.$l.label.test(e.label)&&1||0);this.Wl=e}if(MMD_SA_options.Et){await new Promise(t=>{MMD_SA_options.Et.Nl([[{message:{content:(e.length?"Choose a camera."+e.map((e,t)=>"\n"+(t+1)+". "+e.label).join(""):"No camera is available on this device. Drop a local media file as input instead.")+"\n"+(e.length+1)+". Local media file",ql:3,Ql:e.map((e,t)=>{return{key:t+1,ef:t+1}}).concat([{key:e.length+1,ef:e.length+1}])}}]].concat(e.map(e=>[{Wa:()=>{n.To.deviceId=e.deviceId;t()},ended:true}]).concat([[{Wa:()=>{if(ee.Lo){i=ee.Lo;t();MMD_SA_options.Et.Nl()}else{DEBUG_show("(No local media file found)",3);MMD_SA_options.Et.Nl(null,0,0)}}}]])))})}if(!i&&n.To.deviceId!=this.deviceId)t=await navigator.mediaDevices.getUserMedia(n)}else{if(MMD_SA_options.Et)MMD_SA_options.Et.Nl(null,0,2)}if(i){ee.Zl(i)}else if(t){ee.Zl(t);this.deviceId=n.To.deviceId}if(e&&e.tf)e.tf.if=true;DEBUG_show("(User camera:ON)",2)}if(!this.visible){this.show();DEBUG_show("User camera:VISIBLE",2)}}catch(e){if(MMD_SA_options.Et&&MMD_SA_options.Et.nf)MMD_SA_options.Et.Nl({ended:true});ee.Zl();console.error(e);DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}},Zl:function(e){if(!this.zo){this.To=this.ir=document.createElement("video");this.To.autoplay=true;let e;this.gt=document.createElement("div");e=this.gt.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=this.Uo?2:0;e.visibility=System.D.Dt?"hidden":"inherit";e.display=System.D.Dt?"none":"block";SL_Host.appendChild(this.gt);this.Bo=document.createElement("canvas");e=this.Bo.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.gt.appendChild(this.Bo);this.af=document.createElement("canvas");e=this.af.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.gt.appendChild(this.af);this.sr=document.createElement("canvas");e=this.sr.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.gt.appendChild(this.sr);this.Vo=document.createElement("canvas");e=this.Vo.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.gt.appendChild(this.Vo)}this.zo=true;this.show();if(this.stream){this.stream.getTracks().forEach(e=>{e.stop()});this.To.srcObject=this.stream=this.rf=this.deviceId=null;console.log("(Previous stream stopped)")}if(te.enabled)te.sf();if(!e||typeof e=="string"){A(e);return}this.stream=e;this.rf=e.getVideoTracks()[0];this.To.srcObject=e;console.log("(New stream started)");setTimeout(function(){let e=ee.rf.getCapabilities();System.D.console.log(Object.entries(e).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"));let t=ee.rf.getSettings();System.D.console.log(Object.entries(t).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"))},2e3);window.addEventListener("resize",function(){ee.rf&&ee.rf.applyConstraints(ee.Kl()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update")})})},get D_(){return O.enabled||h.enabled},_f:function(){var i;var t=false;u={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){MMD_SA.lf.devicePixelRatio=1;MMD_SA.lf.ff(EV_width,EV_height);SL.style.visibility="hidden"}else{MMD_SA.lf.devicePixelRatio=window.devicePixelRatio;MMD_SA.lf.ff(EV_width,EV_height);SL.style.visibility="visible";ee.af.style.visibility="hidden"}},Ro:0,mask:null,uf:null,load:async function(e){this.enabled=true;if(i)return;if(!this.mask){this.mask=document.createElement("canvas");f.hf()}i=await bodyPix.load(e||(1||is_mobile)?{cf:"MobileNetV1",Mf:16,df:.5,mf:2}:{cf:"ResNet50",Mf:32,mf:2});console.log("bodyPix loaded")},pf:async function(e,t){await this.load();return await i.pf(e,t||{Sf:false,vf:"medium",Af:.7})},wf:async function(e,t,i){const n=await this.pf(e,t);this.uf=n.uf;i=i||{Df:{r:0,pa:0,b:0,a:255},backgroundColor:{r:0,pa:0,b:0,a:0}};return bodyPix.wf(n,i.Df,i.backgroundColor)},Zo:async function(e=ee.Bo,t,i,n){if(l.gf()){ee.Bo.style.visibility="inherit";ee.af.style.visibility="hidden";SL.style.visibility="visible";return}if(this.Ro)return;this.Ro=RAF_timestamp;const a=await this.wf(e,t,i);this.Ro=0;if(!this.enabled)return;if(this.mask.width!=a.width||this.mask.height!=a.height){this.mask.width=a.width;this.mask.height=a.height}this.mask.getContext("2d").putImageData(a,0,0);if(ee.af.width!=e.width||ee.af.height!=e.height){ee.af.width=e.width;ee.af.height=e.height;ee.af.style.pixelWidth=window.innerWidth;ee.af.style.pixelHeight=window.innerHeight}let o=ee.af.getContext("2d");o.globalCompositeOperation="copy";o.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)";o.drawImage(this.mask,0,0,e.width,e.height);o.globalCompositeOperation="source-out";o.filter="none";o.save();o.translate(e.width,0);o.scale(-1,1);o.drawImage(SL,0,0,e.width,e.height);o.restore();o.globalCompositeOperation="destination-over";o.drawImage(e,0,0);ee.af.style.visibility="inherit";SL.style.visibility="hidden";this.bf();l.gf()},bf:function(){let e=f.yf;if(!f.enabled||!e.complete)return;ee.sr.style.visibility="hidden";let t=e.width;let r=e.height;let s=[];this.uf.forEach(function(e){let t=e.zs;let i=t.find(e=>e.part=="nose");if(!i)return;let n=t.find(e=>e.part=="leftEye");let a=t.find(e=>e.part=="rightEye");let o;if(n&&a){let e=n.position.x-a.position.x;let t=n.position.y-a.position.y;o=Math.sqrt(e*e+t*t)*4}else{o=r}s.push([i.position.y,i.position.x,Math.max(o,r/2),100])});this.uf=undefined;f.kf(ee.af,s)}};return u}(),Ef:function(){var t=false;function i(){f.zo=true;if(!self.OffscreenCanvas)f.hf();s=new Worker("js/pico.worker.js");s.onmessage=function(e){var t=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof t==="string"){DEBUG_show(t,2);f.Xo=true}else{ee.s_=true;if(t.__)DEBUG_show(t.__);f.Yo=t.Yo;f.Ro=0;ee.sr.style.left=ee.Bo.style.left;ee.sr.style.top=ee.Bo.style.top;if(!self.OffscreenCanvas){System.D.Ha.add(function(){f.kf(null,f.Yo)},0,0)}}f.Zo()}}f={zo:false,Xo:false,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){this.Yo=null;if(!this.zo)i()}else{if(ee.zo)ee.sr.style.visibility="hidden"}},hf:function(){if(!this.yf){this.yf=new Image;this.yf.src="images/laughing_man_134x120.png"}},Yo:null,ol:0,Zo:function(e){function t(){var e=f.enabled&&f.Xo&&g&&!f.Ro&&y&&f.ol!=g;if(!e)return;f.Ro=RAF_timestamp;f.ol=g;ee.sr.style.visibility="inherit";let t,i,n;t=ee.Bo;i=t.width;n=t.height;let a=t.getContext("2d").getImageData(0,0,i,n).data.buffer;let o=ee.sr.style;if(o.width!=t.style.width||o.height!=t.style.height){o.width=t.style.width;o.height=t.style.height}let r={sl:a,w:i,hi:n};if(!ee.sr.al&&self.OffscreenCanvas){r.canvas=ee.sr.transferControlToOffscreen();ee.sr.al=true;console.log("(Face detection: use offscreen canvas)")}s.postMessage(r,r.canvas?[r.canvas,r.sl]:[r.sl]);r.sl=a=undefined;r=undefined}if(e||self.ul){setTimeout(()=>{t()},0)}else{t()}},kf:function(e,f){let t=ee.Bo.width;let i=ee.Bo.height;let n;if(!e){e=ee.sr;if(e.width!=t||e.height!=i){e.width=t;e.height=i}n=e.getContext("2d");n.clearRect(0,0,t,i)}else{n=e.getContext("2d")}n.globalCompositeOperation="source-over";let a=this.yf;let o=a.width;let r=a.height;let s,_,l,u;if(f.length){let t=1;f.forEach(function(e){s=e[2]*t;_=s*o/r;l=e[1]*t-_/2;u=e[0]*t-s/2;n.drawImage(a,0,0,o,r,l,u,_,s)})}else{s=Math.min(t,i);_=s*o/r;l=(t-_)/2;u=(i-s)/2;n.drawImage(a,0,0,o,r,l,u,_,s)}}};return f}(),q_:function(){var t=false;var X=0;var Y=true;var J=0;var K=[];var $;var Z;var V=false;function n(){X=0;Y=true;J=0;K=[];$={};Z={Rf:[],Pf:[]};var n={Rf:[159,145],Pf:[386,374]};["L","R"].forEach(function(t){for(var i=0;i<4;i++){let e=Z[t][i]={};e.index=i;e.Tf=0;e.Bf=0;e.Lf=999;e.Of=[];e.If=n[t]}$[t]={Ff:0,Cf:0,xf:[],If:t=="R"?[334,330]:[105,101]}})}var a;var q=[];var N,Q,A;N=!is_mobile;A=!is_chrome||is_mobile;var e;function o(){if(te.zo)return;te.zo=true;for(var e=0;e<4;e++)q[e]=new THREE.lr;var n=[];if(System.D.jf){n.push("simd=1")}if(oe){N=true}if(A){N=true;n.push("use_mediapipe_facemesh=1")}if(N){N=true;te.Uf=true;n.push("use_face_landmarks=1")}if(Q){n.push("use_human_facemesh=1")}var t;if(MMD_SA_options.Fo.Qr.qr){t=new Promise((e,t)=>{b={postMessage:function(e,t){FacemeshAT.onmessage({data:e})}};let i=document.createElement("script");i.onload=async function(){await FacemeshAT.init(b,n);e()};i.src="js/facemesh_lib.js";document.head.appendChild(i)})}else{b=new Worker("js/facemesh_worker.js"+(n.length?"?"+n.join("&"):""))}b.onmessage=s;return t}function r(e,t,i){const n=new Path2D;n.moveTo(t[0][0]/2,t[0][1]/2);for(let e=1;e<3;e++){const a=t[e];n.lineTo(a[0]/2,a[1]/2)}if(i){n.closePath()}e.stroke(n)}var s=function(){var G=0,H=0,W=0,z=0;return function(e){var j=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof j==="string"){if(j=="OK"){te.Xo=true}else{DEBUG_show(j,2);System.D.console.log(j)}}else if(j.f_){de({data:j})}else{ee.s_=true;let x="";if(j.tl.length){te.u_++}else{te.u_=0}if(j.tl.length&&j.tl[0].d_){w=j.tl[0].d_}else if(!O.enabled){w=[.5,.5]}if(j.tl.length&&te.h_){let f=j.tl[0];let u=ee.Gs?1:-1;let h,c,n;if(f.rotation){const U=f.rotation.matrix;ie.set(U[0],U[1],U[2],0,U[3],U[4],U[5],0,U[6],U[7],U[8],0,0,0,0,1)}else{let e=MMD_SA.m_.Er(f.Aa[152]).sub(MMD_SA.Hr.Er(f.Aa[10])).normalize();let t=MMD_SA.p_.Er(f.Aa[454]).sub(MMD_SA.Hr.Er(f.Aa[234])).normalize();let i=MMD_SA.Rr.Kr(t,e).normalize();t.Kr(e,i);ie.set(t.x,t.y,t.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,0,0,0,0,1)}let a=MMD_SA.Rr.Gf(ie,"YZX");h=-a.x;c=-a.y;n=-a.z;let o=f.Hf[454][0]-f.Hf[234][0];let r=f.Hf[454][1]-f.Hf[234][1];let s;if(j.Wf){o/=Math.cos(c);r/=Math.cos(h);s=Math.sqrt(o*o+r*r)}else{o/=Math.cos(n);s=Math.abs(o/Math.cos(c))}te.w_=s;let _;if(j.Wf){_=Math.asin(r/s)}else{_=n}let l=new THREE.ur;l.Nr(MMD_SA.Gr.set(h,c*u,_*u),"YZX");let p=performance.now();let S=0;if(z){S=p-z;W+=S;if(++H>=20){G=1e3/(W/H);H=W=0}}z=p;te.__=j.__;ne.ts=G&&1e3/G||S||j.l_&&1e3/j.l_||j.__;if(te.M_){ne.add("skin|facemesh","首",{S_:true,ls:l,ps:te.w_/Math.min(ee.Bo.width,ee.Bo.height),v_:le})}if(!X)X=Date.now();let v=0;if(Y){v=~~(Math.min((Date.now()-X)/5e3,K.length/30,V?Z.Rf[0].Of.length/30:1,1)*100);Y=v<100}let A=f.zf>(Q?.75:.9)&&(ee.To==ee.tr||!ee.To.paused&&Math.abs(c)<Math.PI/4);let w=MMD_SA.Gr.Er(f.Aa[13]).Ur(MMD_SA.Hr.Er(f.Aa[14]));let D=MMD_SA.Gr.Er(f.Aa[61]).Ur(MMD_SA.Hr.Er(f.Aa[291]));let t=J;if(!t){if(A&&w<2)K.push(D);if(!K.length){t=0}else{let e=parseInt(K.length*.3);t=K.sort((e,t)=>e-t).slice(e,K.length-e).reduce((e,t)=>e+t)/(K.length-e*2);if(!Y){J=t}}}let g=0;let b=0;let M=0;let d=0;["L","R"].forEach(function(e){let t=$[e];t.height=MMD_SA.Gr.Er(f.Aa[t.If[0]]).Ur(MMD_SA.Hr.Er(f.Aa[t.If[1]]));t.Ff=t.Cf;if(!t.Ff){if(A)t.xf.push(t.height);if(!t.xf.length){t.Ff=t.height}else{let e=parseInt(K.length*.3);t.Ff=t.xf.sort((e,t)=>e-t).slice(e,t.xf.length-e).reduce((e,t)=>e+t)/(t.xf.length-e*2);if(!Y){t.Cf=t.Ff}}}M+=t.height/t.Ff});M/=2;M=(M-1)/.25*(M>1?2:1);if(t){if(D>t*1.05){b=Math.sqrt(Math.min((D-t*1.05)/(t*.25),1))}else if(D<t*.98){b=-Math.sqrt(Math.min((t*.98-D)/(t*.2),1))}if(w>2){g=Math.pow(Math.min((w-2)/(t*1/3),1),.5);if(b>.25)d=(b-.25)/.75*.3}}let y=0;let k=0;let E=0;let R=0;let P=0;if(Array.isArray(f.Xf)){f.Xf.forEach(e=>{switch(e.Xf){case"happy":y+=e.Mr;break;case"sad":k+=e.Mr;break;case"angry":case"disgust":E+=e.Mr;break;case"fear":R+=e.Mr;break;case"surprise":P+=e.Mr;break}})}let T=y-(k+E+R+P*.5);if(T<0){d*=Math.max(1+T*2,0)}else{d=Math.min(T*.2+d*(1+T*.5),.4)}ne.add("morph|facemesh","にこり",{weight:Math.min(d+y*.75,.75)});ne.add("morph|facemesh","困る",{weight:(k+R)/2*.75});ne.add("morph|facemesh","怒り",{weight:E*.75});M+=P*.2;ne.add("morph|facemesh","笑い",{weight:d});ne.add("morph|facemesh","びっくり",{weight:P*.75});ne.add("morph|facemesh","にやり",{weight:b});let B=MMD_SA.os.Nr(MMD_SA.Gr.set(h,c,n),"YZX").cs();let i=[];[13,14,61,291].forEach(function(e,t){i[e]=q[t].Er(f.Aa[e]).Xr(B).Yf(0)});let L=MMD_SA.Gr.ss(i[61]).add(i[291]).Sa(.5);let O=i[61].Ur(i[291])*.5;let I=Math.atan2(i[13].y-L.y,O);let F=Math.atan2(i[14].y-L.y,O);let e=Math.max(-(I+F)*180/Math.PI+20*g,0);if(e)e=Math.min(e/20,.75);e=Math.min(e+k*.25,1);e*=.5;g=g*(1-e);ne.add("morph|facemesh","あ",{weight:g});ne.add("morph|facemesh","お",{weight:e});let m={Rf:[0],Pf:[0]};let C={Rf:[],Pf:[]};if(N){let i=[0,0];let n=[0,0];f.Kf.forEach(function(e,t){if(e){i[t]=Math.max(Math.min((e[3]*2+h/(Math.PI/2))*(1-Math.abs(h)/Math.PI),1),-1);n[t]=Math.max(Math.min((e[2]*2-c/(Math.PI/2))*(1-Math.abs(c)/Math.PI),1),-1)}});["L","R"].forEach(function(t){let i=0;m[t][i]=0;let n=Z[t][i];let a=MMD_SA.Gr.Er(f.Aa[n.If[0]]).Ur(MMD_SA.Hr.Er(f.Aa[n.If[1]]));let o=n.Bf;if(!o){if(A){n.Of.push(a);let e=parseInt(n.Of.length*.3);o=n.Of.sort((e,t)=>e-t).slice(e,n.Of.length-e).reduce((e,t)=>e+t)/(n.Of.length-e*2);if(!Y){n.Bf=o}}else{o=n.Tf}}if(A){if(n.Lf>a)n.Lf=a}n.Tf=o;if(o){if(a>o){m[t][i]=Math.min(a/o,1.25)}else{let e=Math.min(n.Lf,o/2);m[t][i]=Math.max((a-e)/(o-e),0)}}});let e=(m.Rf[0]+m.Pf[0])/2;if(e>1)M+=(e-1)*2;else M-=(1-e)*.5;M=Math.min(M,1);let t=m.Rf[0]+m.Pf[0];if(t)t=m.Rf[0]/t;else t=.5;let a=i[0]*t+i[1]*(1-t);let o=n[0]*t+n[1]*(1-t);let r={absolute:true,ls:(new THREE.ur).Nr(MMD_SA.Gr.set(-(a-.3)*15/180*Math.PI,o*u*20/180*Math.PI,0),"YZX")};ne.add("skin|facemesh","両目",r);let s=THREE.zn.wa()[0].gl.Vf["Zf"]!=null;let _=s?Math.min(Math.max(Math.abs(m.Rf[0]-m.Pf[0])-(.25+(1-Math.min(Math.max((Math.PI/6-Math.abs(c))/(Math.PI/12),0),1))*1),0)/.25,1):0;let l=Math.min(m.Rf[0],m.Pf[0]);m.Rf[0]=m.Rf[0]*_+l*(1-_);m.Pf[0]=m.Pf[0]*_+l*(1-_);if(s){ne.add("morph|facemesh","まばたき"+(u==1?"L":"R"),{weight:Math.max(Math.min(1-m.Rf[0]*.8-d,1),0)});ne.add("morph|facemesh","まばたき"+(u==1?"R":"L"),{weight:Math.max(Math.min(1-m.Pf[0]*.8-d,1),0)});ne.add("morph|facemesh","まばたき",{weight:0})}else{ne.add("morph|facemesh","まばたき",{weight:Math.max(Math.min(1-m.Rf[0]*.8-d,1),0)})}}else{let e=f.Kf[0];let t=0;let i=0;if(e){t=Math.max(Math.min((e[3]*2+h/(Math.PI/2))*(1-Math.abs(h)/Math.PI),1),-1);i=Math.max(Math.min((e[2]*2-c/(Math.PI/2))*(1-Math.abs(c)/Math.PI),1),-1)}let n=M*.25;if(n<0)n=Math.min(n+d,0);let a=Math.max(Math.min(.1-t*(t<0?2:1)*.2-n,.5),0);ne.add("morph|facemesh","まばたき",{weight:a});let o=1.25+Math.pow((m.Rf[0]+m.Pf[0])/2,2)*1.75;t=Math.sign(t)*Math.pow(Math.abs(t),o);i=Math.sign(i)*Math.pow(Math.abs(i),o);let r={absolute:true,ls:(new THREE.ur).Nr(MMD_SA.Gr.set(-t*15/180*Math.PI,i*u*20/180*Math.PI,0),"YZX")};ne.add("skin|facemesh","両目",r)}ne.add("morph|facemesh","上",{weight:Math.max(Math.min(M,1),-1)});x=x||f.Kf.length&&[(Y?"Calibrating("+v+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(f.zf*100)+"%",f.Xf?JSON.stringify(f.Xf):"Neutral"].join("\n");if(ae)x+=ae}else{x="(no facemesh data)\n"+ae}if(!System.D.Dt&&!MMD_SA_options.Fo.Qr.N_)DEBUG_show((x&&x+"\n"+"FPS:"+EV_sync_update.J_+"\n"||"")+"F-FPS:"+Math.round(G)+"/"+Math.round(j.l_||0));te.Ro=0}te.Zo()}}();var D=document.createElement("canvas");var w=[];var _=0;var i=0;te={zo:false,Xo:false,get u_(){return _},set u_(e){if(e){if(!_){i=RAF_timestamp}}else{i=0}_=e},get h_(){return t&&i&&RAF_timestamp-i>250},get M_(){return this.h_||!O.enabled},get Uf(){return V},set Uf(e){V=e;if(t){if(V){n()}else{MMD_SA_options.rl=a}}},get Nf(){return N},set Nf(e){if(!this.zo)N=e},get xl(){return A},set xl(e){return A=e},w_:0,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;this.u_=0;w[0]=w[1]=.5;if(t){if(!this.zo)o();a=MMD_SA_options.rl;n()}else{MMD_SA_options.rl=a}k()},get d_(){return w},set d_(e){w=e},sf:n,frames:ne,init:o,Q_:s,ol:0,Zo:function(e){function t(){var n=te.enabled&&te.Xo&&g&&!te.Ro&&!(O.enabled&&O.V_)&&y&&te.ol!=g;if(!n)return;te.Ro=RAF_timestamp;te.ol=g;if(V){MMD_SA_options.rl=false}let a;let o,r;let s,_;let u,h;let c;a=ee.Bo;let M=a.width,d=a.height;u=h=0;o=s=M;r=_=d;let l=1;let e=MMD_SA_options.Fo.Io.q_;if(e){if(o*r>e[0]*e[1]){l=o/r>e[0]/e[1]?o/e[0]:r/e[1];o=s=Math.round(o/l);r=_=Math.round(r/l);a=D;c=true}}let t,m,f;if(MMD_SA_options.Fo.Io.Jf){t=MMD_SA_options.Fo.Io.Jf;f=Math.round(Math.min(o,r)*t);s=f;_=f;let e=1;const v=5*(A?2:1);if(te.u_<v&&t<1&&!O.enabled){e=t+(1-t)*(1-Math.min(te.u_/v,1));f=Math.round(Math.min(o,r)*e);m=t/e;t=e;a=D;c=true}u=Math.max(Math.min(o*w[0]-f/2,o-f),0)*(m||1);h=Math.max(Math.min(r*w[1]-f/2,r-f),0)*(m||1)}let p=a.getContext("2d");if(c){p.globalCompositeOperation="copy";let e=u,t=h,i=s,n=_;if(m){i=n=f;if(a.width!=s||a.height!=_){a.width=s;a.height=_;console.log("Facemesh canvas("+o+"x"+r+"=>"+s+"x"+_+"):"+[e,t,f,f].join(",")+"=>"+[u,h,s,_].join(","))}}else{if(a.width!=s||a.height!=_){a.width=s;a.height=_;console.log("Facemesh canvas("+o+"x"+r+")")}}p.drawImage(ee.Bo,Math.round(e*l),Math.round(t*l),Math.round(i*l),Math.round(n*l),0,0,s,_)}let S=c?p.getImageData(0,0,s,_).data.buffer:p.getImageData(u,h,s,_).data.buffer;let i={sl:S,w:o*(m||1),hi:r*(m||1),options:{$f:true,il:true,el:ee.qo,qf:{x:Math.round(u),y:Math.round(h),w:s,hi:_,ratio:t||0,scale:m||1}}};if(self.nl){i.canvas=ee.Vo}else if(!ee.Vo.al&&self.OffscreenCanvas){i.canvas=ee.Vo.transferControlToOffscreen();ee.Vo.al=true;console.log("(Facemesh: use offscreen canvas)")}b.postMessage(i,i.canvas?[i.canvas,i.sl]:[i.sl]);i.sl=S=undefined;i=undefined}if(e||self.nl){setTimeout(()=>{t()},0)}else{t()}}};return te}(),ks:function(){var t=false;var i=true;var a=true;var o={};var n=null;var r=0;var s=0;var _=0;var l=null;var f=null;O={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;N=false;this.u_=0;_=0;THREE.zn.wa()[0].Aa.visible=true;T.set(0,0,0);if(t){if(!this.zo)_e();MMD_SA_options.Fo.Qr.pose.ao.enabled&&MMD_SA_options.Fo.Qr.pose.ao.enabled()}else{THREE.zn.wa()[0].Hs();MMD_SA_options.Fo.Qr.pose.ao.disabled&&MMD_SA_options.Fo.Qr.pose.ao.disabled()}k();if(O.V_){setTimeout(()=>{if(t)te.enabled=h.enabled=true;else h.enabled=false;DEBUG_show("(Holistic Mode:"+(t?"ON":"OFF")+")",2)},0)}},get u_(){return r},set u_(e){if(1){if(e){if(!r){s=RAF_timestamp}if(this.h_){_=0}}else{s=0;if(!_){_=RAF_timestamp}if(RAF_timestamp-_>250){ne.reset()}}}r=e},get h_(){return t&&(!_||RAF_timestamp-_<250||s&&RAF_timestamp-s>500)},get As(){return t&&i&&X},set As(e){i=e},get V_(){return n==null?oe:n},set V_(e){n=e},get Qf(){return oe},set Qf(e){oe=e},get fl(){return this.V_||K?0:1},set k_(e){a=e},get Us(){return l!=null?l:MMD_SA_options.Fo.Qr.pose.Us},set Us(e){l=e},get eu(){return f!=null?f:!t||!!MMD_SA_options.Fo.Qr.pose.Us},set eu(e){f=e},ys:function(){var i=new RegExp("("+toRegExp(["腕ＩＫ","足ＩＫ","つま先ＩＫ"],"|")+")$");var n=new RegExp("("+toRegExp(["腕ＩＫ"],"|")+")$");return function(e){var t=a&&this.As&&this.u_&&MMD_SA.zn.a_.n_.vl&&(!e||n.test(e)||!MMD_SA.zn.a_.n_.i_&&i.test(e));if(t&&e){if(o[e])t=false}return t}}(),P_:function(e,t){o[e]=t},frames:ne,ol:0,get Ro(){return F},get zo(){return D},get Xo(){return E}};return O}(),C_:function(){var t=false;h={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){if(!this.zo)_e()}},frames:ne,get Ro(){return F},get zo(){return D},get Xo(){return E}};return h}(),tu:function(){var t=false;var i=false;var n;var a;function o(){var e=Math.ceil(3-(Date.now()-n)/1e3);if(e<=0){if(!ee.visible){s(SL);return}DEBUG_show("Capturing...");if(!ee.stream){if(!u.enabled){r();return}i=true}else{ee.jl=1;ee.rf.applyConstraints(ee.Kl()).then(function(){System.D.console.log("(Ready to capture)");System.D.Ha.add(function(){MMD_SA.lf.devicePixelRatio=window.devicePixelRatio;MMD_SA.lf.ff(EV_width,EV_height);if(!u.enabled){System.D.Ha.add(function(){r()},0,1);return}i=true},0,0)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update");_()})}System.D.Ha.remove(o,0)}else if(a!=e){a=e;DEBUG_show(a)}}function r(){let e=ee.af;e.width=SL.width;e.height=SL.height;let t=e.getContext("2d");t.globalCompositeOperation="source-over";t.drawImage(ee.Bo,0,0);if(f.enabled)t.drawImage(ee.sr,0,0);t.save();t.translate(e.width,0);t.scale(-1,1);t.drawImage(SL,0,0);t.restore();s(e)}function s(e){t=true;i=false;System.D.Ha.remove(o,0);e.toBlob(function(e){var t=URL.createObjectURL(e);window.open(t);_()})}function _(){Ldebug.style.posLeft=Ldebug.style.posTop=0;Ldebug.style.transform=Ldebug.style.transformOrigin="";DEBUG_show();i=false;ee.jl=0;t=false}l={init:function(){if(t){return true}if(MMD_SA.Po.session){let e=MMD_SA_options.Po&&MMD_SA_options.Po.zl;if(!e.tf||!e.tf.if){DEBUG_show("(No snapshot in AR WebGL)",3);return true}}if(!ee.visible){s(SL)}else{t=true;n=Date.now();Ldebug.style.posLeft=Ldebug.style.posTop=50;Ldebug.style.transformOrigin="0 0";Ldebug.style.transform="scale(5,5)";a=3;DEBUG_show();DEBUG_show(a);System.D.Ha.add(o,0,0,-1)}},gf:function(){if(!t)return;if(i){s(ee.af)}return true}};return l}(),Qo:function(){if(this.Bo)this.Bo.width=this.Bo.height=g=0},show:function(){if(!this.zo||this.visible)return;this.visible=true;if(ee.jl!=window.devicePixelRatio){ee.jl=0;ee.rf.applyConstraints(ee.Kl()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update")})}_();if(this.Ko)this.hide()},hide:function(){if(!this.zo||!this.visible)return;this.visible=false;this.Bo.style.visibility="hidden";f.enabled=false;u.enabled=false;M()},Kl:function(e){var t={};var i=window.devicePixelRatio/this.jl;var n=Math.round(window.innerWidth*i);var a=Math.round(window.innerHeight*i);var o=MMD_SA_options.Fo.Io.Oo;if(!v&&o){if(MMD_SA_options.Fo.Io.fixed){n=o[0];a=o[1]}else if(n*a>o[0]*o[1]){let e=window.innerWidth/window.innerHeight>o[0]/o[1]?window.innerWidth/o[0]:window.innerHeight/o[1];n=Math.round(window.innerWidth/e);a=Math.round(window.innerHeight/e)}}ee.Co=n;ee.xo=a;if(!is_mobile||!screen.orientation||/landscape/.test(screen.orientation.type)){t.width=n;t.height=a}else{t.width=a;t.height=n}if(e)t=Object.assign(t,e);console.log("Camera constraints",t);return t}};return ee}(),console:{iu:[],log:function(){for(var e=0;e<arguments.length;e++){this.iu.push(arguments[e])}},reset:function(){this.iu=[]},get nu(){return this.iu.join("\n")||"(EMPTY)"}}},au:{ou:{},hash:function(e){if(webkit_electron_mode){var t=webkit_electron_remote.Ca("HASH_SHA256");if(t)return t.hash(e)}var i=this.ou[e];if(i)return i;var n=require("crypto").ru("sha256");n.update(e);i=this.ou[e]=n.digest("hex");return i}},su:[],_u:function(e){if(e&&!SA_topmost_window.fu.lu)return false;if(!SA_topmost_window.fu.uu)return false;SA_topmost_window.fu.uu=false;SA_topmost_window.fu.lu=false;SA_topmost_window.G.su.forEach(function(e){if(e.hu)e.hu();else if(e.paused)e.play()});SA_topmost_window.G.su=[];System.D.nn();return true},cu:function(e){if(SA_topmost_window.fu.uu)return false;SA_topmost_window.fu.uu=true;SA_topmost_window.fu.lu=e;var r=SA_topmost_window.G.su;var t=[top];for(var i=0;i<SA_child_animation_max;i++){if(SA_topmost_window.vi[i])t.push(SA_topmost_window.document.getElementById("Ichild_animation"+i).contentWindow)}var s=0;var _=0;var l=0;t.forEach(function(e){for(var t in e.Mu){var i=e.Mu[t];if(!i.du&&!i.paused&&i.count){s++;i.pause();r.push(i)}}var n=[];var a;a=document.getElementById("VdesktopBG");if(a)n.push(a);a=e.xt&&e.xt.ir;if(a)n.push(a);n.forEach(function(e){if(e&&!e.paused&&!e.ended){_++;e.pause();r.push(e)}});if(e.ci&&e.ci.Wn&&e.ci.Wn()){var o;if(e.mu)o=e.pu.paused;else if(e.fn)o=e.pu.vu.Su.paused;else if(e.Au&&e.Du.wu)o=e.Du.gu.playState!=3;else o=e.pu&&e.pu.paused;if(!o){l++;e.hu();r.push(e)}}});console.log("Gadget PAUSED (Seq/Video/MC):"+[s,_,l].join("/"));System.D.nn();return true},bu:function(e){if(!WallpaperEngine_CEF_mode)return e;if(System.o.path&&e.indexOf(System.o.path)==0)e=e.substr(System.o.path.length);e=/\:/.test(e)?toFileProtocol(e):e.replace(/\\/g,"/").replace(/^\//,"");return e}};System.t();return System}();
