// 2023-07-28
var BVHLoader=function(){var e;var M,t,x;var E,m,h;var o,i;var _={};var o;function d(){if(e)return;e=true;M=new THREE.Vector3;t=new THREE.Vector3;x=new THREE.Vector3;E=new THREE.Quaternion;m=new THREE.Quaternion;h=new THREE.Quaternion;i=new Uint8Array([20,20,20,20,20,20,20,20,107,107,107,107,107,107,107,107]);l.prototype=Object.create(o.prototype);l.prototype.cameraKeys=[];l.prototype.lightKeys=[];l.prototype.morphKeys=[]}function g(e,t,o,r){this.name=e;this.time=t;this.pos=o;this.rot=r;this.interp=i}function l(e,t){this.boneKeys=e;this.timeMax=t}function r(e){const r=e;e=toFileProtocol(e);return promise=new Promise(t=>{var o=new XMLHttpRequestZIP;o.onload=function(){if(1||o.status===200){let e=s(o.response);e[0].url=r;t(e)}else{console.error(r,o.statusText)}o=null};o.open("GET",e,true);o.responseType="text";o.send()})}function s(e){function t(t){if(p(t)!=="HIERARCHY"){console.error("THREE.BVHLoader: HIERARCHY expected.")}const e=[];const o=_(t,p(t),e);if(p(t)!=="MOTION"){console.error("THREE.BVHLoader: MOTION expected.")}let r=p(t).split(/[\s]+/);const i=parseInt(r[1]);if(isNaN(i)){console.error("THREE.BVHLoader: Failed to read number of frames.")}r=p(t).split(/[\s]+/);const s=parseFloat(r[2]);if(isNaN(s)){console.error("THREE.BVHLoader: Failed to read frame time.")}for(let e=0;e<i;e++){r=p(t).split(/[\s]+/);l(r,e*s,o)}return e}function l(t,o,r){if(r.type==="ENDSITE")return;const i={time:o,position:new THREE.Vector3,rotation:new THREE.Quaternion};r.frames.push(i);const s=new THREE.Quaternion;const a=new THREE.Vector3(1,0,0);const n=new THREE.Vector3(0,1,0);const _=new THREE.Vector3(0,0,1);for(let e=0;e<r.channels.length;e++){switch(r.channels[e]){case"Xposition":i.position.x=parseFloat(t.shift().trim());break;case"Yposition":i.position.y=parseFloat(t.shift().trim());break;case"Zposition":i.position.z=parseFloat(t.shift().trim());break;case"Xrotation":s.setFromAxisAngle(a,parseFloat(t.shift().trim())*Math.PI/180);i.rotation.multiply(s);break;case"Yrotation":s.setFromAxisAngle(n,parseFloat(t.shift().trim())*Math.PI/180);i.rotation.multiply(s);break;case"Zrotation":s.setFromAxisAngle(_,parseFloat(t.shift().trim())*Math.PI/180);i.rotation.multiply(s);break;default:console.warn("THREE.BVHLoader: Invalid channel type.")}}for(let e=0;e<r.children.length;e++){l(t,o,r.children[e])}}function _(e,t,o){const r={name:"",type:"",frames:[]};o.push(r);let i=t.split(/[\s]+/);if(i[0].toUpperCase()==="END"&&i[1].toUpperCase()==="SITE"){r.type="ENDSITE";r.name="ENDSITE"}else{r.name=i[1];r.type=i[0].toUpperCase()}if(p(e)!=="{"){console.error("THREE.BVHLoader: Expected opening { after type & name")}i=p(e).split(/[\s]+/);if(i[0]!=="OFFSET"){console.error("THREE.BVHLoader: Expected OFFSET but got: "+i[0])}if(i.length!==4){console.error("THREE.BVHLoader: Invalid number of values for OFFSET.")}const s=new THREE.Vector3(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));if(isNaN(s.x)||isNaN(s.y)||isNaN(s.z)){console.error("THREE.BVHLoader: Invalid values of OFFSET.")}r.offset=s;if(r.type!=="ENDSITE"){i=p(e).split(/[\s]+/);if(i[0]!=="CHANNELS"){console.error("THREE.BVHLoader: Expected CHANNELS definition.")}const a=parseInt(i[1]);r.channels=i.splice(2,a);r.children=[]}while(true){const n=p(e);if(n==="}"){return r}else{r.children.push(_(e,n,o))}}}function p(e){let t;while((t=e.shift().trim()).length===0){}return t}function i(e){var t;if(/left/i.test(e))t="左";else if(/right/i.test(e))t="右";else if(/^(l|r)/.test(e))t=RegExp.$1=="r"?"右":"左";else if(/_(L|R)$/.test(e))t=RegExp.$1=="R"?"右":"左";return t}function s(e){var t="指";var o=parseInt(e.charAt(e.length-1))+(e.indexOf("")==-1?0:-1);t+=y[o];return t}const o=e.split(/[\r\n]+/g);const a=t(o);d();const u={};a[0].bones_MMD=u;a.forEach((t,e)=>{t.children&&t.children.forEach(e=>{e.parent=t});t._rot_accumulated=new THREE.Quaternion;t.group="";var o=t.name;if(/^hip/i.test(o)){t.name_MMD="センター";t.root=true;u["_root_"]=t}else if(/lowerback/i.test(o)){}else if(/abdomen/i.test(o)||/spine/i.test(o)&&!/spine/i.test(a[e-1].name)||/chest$/i.test(o)&&/chest2/i.test(a[e+1].name)){t.name_MMD="上半身";t.group="upper_body";t.use_axis=true}else if(/spine\d/i.test(o)||/chest3/i.test(o)||/chest2/i.test(o)&&!/chest3/i.test(a[e+1].name)||/chest$/i.test(o)&&!/chest/i.test(a[e-1].name)){t.name_MMD="上半身2";t.group="upper_body";t.use_axis=true}else if(/lowerneck/i.test(o)){}else if(/neck$/i.test(o)){t.name_MMD="首";t.group="upper_body";t.use_axis=true}else if(/head/i.test(o)){t.name_MMD="頭";t.group="upper_body";t.use_axis=true;t.parent_offset_as_axis=true}else if(/shoulder|collar/i.test(o)&&!u[i(o)+"肩"]){t.name_MMD=i(o)+"肩";if(t.offset.length()>.001){t.group="upper_body|arm";const r="_root_arm_"+i(o)+"_";u[r]=t;t.use_axis=true}}else if(/arm/i.test(o)&&(/up/i.test(o)||/forearm/i.test(a[e+1].name))||/shldr|shoulder/i.test(o)){t.name_MMD=i(o)+"腕";t.group="upper_body|arm";const r="_root_arm_"+i(o)+"_";if(!u[r]){u[r]=t}t.use_axis=true}else if(/arm/i.test(o)&&/low/i.test(o)||/forearm|elbow/i.test(o)){t.name_MMD=i(o)+"ひじ";t.group="upper_body|arm";t.use_axis=true}else if(/hand|wrist/i.test(o)&&!u[i(o)+"手首"]){t.name_MMD=i(o)+"手首";t.group="upper_body|arm";t.use_axis=true;t.parent_offset_as_axis=true}else if(/buttock/i.test(o)){const r="_root_leg_"+i(o)+"_";u[r]=t}else if(/hipjoint/i.test(o)){}else if(/leg/i.test(o)&&/up/i.test(o)||/thigh|.+hip/i.test(o)){t.name_MMD=i(o)+"足";t.group="lower_body|leg";const r="_root_leg_"+i(o)+"_";if(!u[r]){u[r]=t}t.use_axis=true}else if(/leg/i.test(o)&&(/low/i.test(o)||/up/i.test(a[e-1].name))||/shin|knee/i.test(o)){t.name_MMD=i(o)+"ひざ";t.group="lower_body|leg";t.use_axis=true}else if(/foot|ankle/i.test(o)){t.name_MMD=i(o)+"足首";t.group="lower_body|leg";t.use_axis=true;Object.defineProperty(t,"ignore_axis_rot",function(){var e=null;return{get:function(){if(e==null){e=Math.abs(t.axis_rot_offset_inv.toAxisAngle()[1])>Math.PI/8}return e}}}())}else if(/thumb\d/i.test(o)){t.name_MMD=i(o)+"親"+s(o);t.group="upper_body|finger";t.use_axis=true}else if(/index\d/i.test(o)){t.name_MMD=i(o)+"人"+s(o);t.group="upper_body|finger";t.use_axis=true}else if(/(mid|middle)\d/i.test(o)){t.name_MMD=i(o)+"中"+s(o);t.group="upper_body|finger";t.use_axis=true}else if(/ring\d/i.test(o)){t.name_MMD=i(o)+"薬"+s(o);t.group="upper_body|finger";t.use_axis=true}else if(/pinky\d/i.test(o)){t.name_MMD=i(o)+"小"+s(o);t.group="upper_body|finger";t.use_axis=true}if(t.name_MMD)u[t.name_MMD]=t});a.forEach((e,t)=>{if(e.name_MMD){if(!e.root&&!e.group){delete e.name_MMD;delete u[e.name_MMD]}else return}let o=e;while(!o.name_MMD){if(e.root||!o.children||!o.children.length){o=null;break}o=o.children[0]}if(o&&o.name_MMD){e.group=o.group}});a[0].leg_length=(u["左ひざ"].offset.length()+u["左足首"].offset.length())/10;if(u["上半身"]&&u["_root_arm_左_"]&&u["_root_arm_右_"]){const r=MMD_SA._v3a.copy(u["上半身"].offset).normalize();const n=MMD_SA._v3b.copy(u["_root_arm_左_"].offset).sub(u["_root_arm_右_"].offset).normalize();const f=MMD_SA.TEMP_v3.crossVectors(n,r).normalize();const c=MMD_SA.TEMP_m4.set(n.x,n.y,n.z,0,r.x,r.y,r.z,0,f.x,f.y,f.z,0,0,0,0,1);u["上半身"].root_axis_rot=(new THREE.Quaternion).setFromBasis(c);u["上半身"].is_Tpose=Math.abs(u["上半身"].root_axis_rot.toAxisAngle()[1])<Math.PI/4}if(u["上半身"]&&u["_root_leg_左_"]&&u["_root_leg_右_"]){const r=MMD_SA._v3a.copy(u["上半身"].offset).normalize();const n=MMD_SA._v3b.copy(u["_root_leg_左_"].offset).sub(u["_root_leg_右_"].offset).normalize();const f=MMD_SA.TEMP_v3.crossVectors(n,r).normalize();const c=MMD_SA.TEMP_m4.set(n.x,n.y,n.z,0,r.x,r.y,r.z,0,f.x,f.y,f.z,0,0,0,0,1);u["下半身"]={root_axis_rot:(new THREE.Quaternion).setFromBasis(c)};u["下半身"].is_Tpose=Math.abs(u["下半身"].root_axis_rot.toAxisAngle()[1])<Math.PI/4}a.forEach((t,e)=>{if(!t.use_axis)return;if(t.parent_offset_as_axis){t.axis=t.offset.clone();let e=t.parent;while(e&&!e.name_MMD){t.axis.add(e.offset);e=e.parent}}else{t.axis=t.children[0].offset.clone();let e=t.children[0];while(e&&!e.name_MMD&&e.type!="ENDSITE"){t.axis.add(e.offset);e=e.children[0]}}t.axis.normalize();var o=t.name_MMD;var r=m.set(0,0,0,1);if(t.group.indexOf("upper_body")!=-1){if(u["上半身"]&&u["上半身"].root_axis_rot)r.copy(u["上半身"].root_axis_rot)}else if(t.group.indexOf("lower_body")!=-1){if(u["下半身"]&&u["下半身"].root_axis_rot)r.copy(u["下半身"].root_axis_rot)}t.axis.applyQuaternion(r);let i=o.charAt(0)=="左"?1:o.charAt(0)=="右"?-1:0;let s;var a,n,_;if(/arm|finger/.test(t.group)){s=u["上半身"].is_Tpose;a=MMD_SA._v3a.copy(t.axis);if(i==-1)a.x*=-1;_=MMD_SA._v3b.set(0,0,s?1:i).applyQuaternion(E.setFromUnitVectors(M.set(1,0,0),a));n=MMD_SA.TEMP_v3.crossVectors(a,_).normalize().negate()}else if(t.group.indexOf("leg")!=-1){s=u["下半身"].is_Tpose;t.axis.negate();t.axis.z*=-1;n=MMD_SA._v3a.copy(t.axis);a=MMD_SA._v3b.set(s?1:i,0,0).applyQuaternion(E.setFromUnitVectors(M.set(0,1,0),n));i=-1;_=MMD_SA.TEMP_v3.crossVectors(a,n).normalize()}else{n=MMD_SA._v3a.copy(t.axis);a=MMD_SA._v3b.set(1,0,0).applyQuaternion(E.setFromUnitVectors(M.set(0,1,0),n));_=MMD_SA.TEMP_v3.crossVectors(a,n).normalize();a.crossVectors(n,_)}let l=MMD_SA.TEMP_m4.set(a.x,a.y,a.z,0,n.x,n.y,n.z,0,_.x,_.y,_.z,0,0,0,0,1);t.axis_rot=(new THREE.Quaternion).setFromBasis(l);if(/arm|finger/.test(t.group)&&i==-1){t.axis_rot.z*=-1;t.axis_rot.y*=-1}t.axis_rot_inv=t.axis_rot.clone().conjugate()});a.forEach((e,t)=>{if(!e.use_axis)return;e.axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(e.parent&&e.parent.axis_rot||h,MMD_SA.TEMP_q.copy(e.axis_rot).conjugate())});return a}const y=["０","１","２","３"];function a(p,s){function e(){var r=_[s.pmx.url]=_[s.pmx.url]||{axis_rot:{},axis_rot_offset_inv:{},_axis_rot_inv:{},_axis_rot_offset_inv:{}};var i=s.mesh.bones_by_name;["左","右"].forEach(o=>{["肩","腕","ひじ","手首","足首"].concat(["親","人","中","薬","小"].map(t=>y.map(e=>t+"指"+e)).flat()).forEach(e=>{let t=o+e;if(r.axis_rot[t]||!u[t]||!i[t])return;r.axis_rot[t]=MMD_SA.get_bone_axis_rotation(s.mesh,t)})});for(var e in r.axis_rot){if(!r.axis_rot_offset_inv[e]){r._axis_rot_inv[e]=(new THREE.Quaternion).copy(r.axis_rot[e]).conjugate();r._axis_rot_offset_inv[e]=(new THREE.Quaternion).multiplyQuaternions(r.axis_rot[u[e].parent.name_MMD]||h,r._axis_rot_inv[e])}if(e.indexOf("腕")!=-1&&!u[e.charAt(0)+"肩"]){r.axis_rot_offset_inv[e]=r._axis_rot_inv[e];console.log("-"+e)}else{r.axis_rot_offset_inv[e]=r._axis_rot_offset_inv[e]}}r.leg_length=r.leg_length||MMD_SA._v3a.fromArray(i["左足"].pmxBone.origin).distanceTo(MMD_SA._v3b.fromArray(i["左足首"].pmxBone.origin));return r}if(!s)s=THREE.MMD.getModels()[0];var u=p[0].bones_MMD;var t=p[0].url;var o=t.replace(/^.+[\/\\]/,"").replace(/\.(vmd|bvh)$/i,"");var r=MMD_SA_options.motion_para[o]=MMD_SA_options.motion_para[o]||{};var i=Math.round(1/p[0].frames[1].time);if(i>60)i*=.5;r.playbackRate_by_model_index=[i/30];var f=e();console.log("model para",f);var c=[];var m;var a=p[0].frames.length;for(let l=0;l<a;l++){let _;p.forEach(e=>e._rot_accumulated.set(0,0,0,1));p.forEach((t,e)=>{var o=t.frames[l];var r,i;var s;var a=t.name_MMD;if(!a){if(!t.group)return;if(!o.time)console.log(t.name)}if(t.root){r=M.copy(o.position).sub(t.offset).multiplyScalar(.1);if(!m){m=x.copy(r);r.z=0}else r.sub(m);r.multiplyScalar(f.leg_length/p[0].leg_length);r=r.toArray();_=o.rotation;if(u["下半身"]){s="下半身";i=E.copy(u[s].root_axis_rot).conjugate().multiply(_)}}else{if(a=="上半身"){i=E.copy(t.root_axis_rot).conjugate().multiply(_).multiply(o.rotation);s="上半身"}else if(t.group.indexOf("upper_body")!=-1){i=E.copy(o.rotation);s="上半身"}else if(t.group.indexOf("lower_body")!=-1){i=E.copy(o.rotation);s="下半身"}else return}if(i&&t.parent)i.multiplyQuaternions(t.parent._rot_accumulated,i);if(s&&u[s]&&u[s].root_axis_rot){const n=i.toAxisAngle();i=i.setFromAxisAngle(n[0].applyQuaternion(u[s].root_axis_rot),n[1])}if(t.use_axis){if(!t.ignore_axis_rot){let e;i.premultiply(t.axis_rot).multiply(t.axis_rot_inv);i.multiplyQuaternions(t.axis_rot_offset_inv,i);if(f.axis_rot[a]){i.premultiply(f.axis_rot[a]).multiply(f._axis_rot_inv[a]);i.multiplyQuaternions(f.axis_rot_offset_inv[a],i)}}if(!o.time)console.log(a,(new THREE.Vector3).setEulerFromQuaternion(i,"ZXY").multiplyScalar(180/Math.PI))}else if(!a){t._rot_accumulated=(new THREE.Quaternion).multiplyQuaternions(t.parent&&t.parent._rot_accumulated||h,i);if(!o.time)console.log(t.name,(new THREE.Vector3).setEulerFromQuaternion(t._rot_accumulated,"ZXY").multiplyScalar(180/Math.PI));return}if(i)i=i.toArray();if(t.root){c.push(new g(a,l/30,r,[0,0,0,1]));c.push(new g("下半身",l/30,[0,0,0],i))}else{c.push(new g(a,l/30,r||[0,0,0],i||[0,0,0,1]))}})}var n=new l(c,a/30+1/60);n.url=p[0].url;MMD_SA.vmd_by_filename[decodeURIComponent(n.url.replace(/^.+[\/\\]/,"").replace(/\.bvh$/i,""))]=n;console.log(p,n);return n}return{load:r,parse:s,toVMD:a,set VMD(e){o=e}}}();
